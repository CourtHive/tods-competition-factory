"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[1601],{1601:(t,e,n)=>{n.d(e,{C9:()=>Pi,M6:()=>gN,QO:()=>rR,SX:()=>iR,_3:()=>Om,aX:()=>yv,hC:()=>aR,y1:()=>eP});const r="timed",i="NOAD",a="SET",o={S:"normal",F:"final"};function s(t,e){if("object"==typeof t)return(t.bestOf||t.exactly)&&t.setFormat?function(t,e){const n=c(t.bestOf)||void 0,r=c(t.exactly)||void 0,i=n||r;if(t.setFormat?.timed&&t.simplified&&1===i)return u(t.setFormat);const o=i&&`${a}${i}`||"",s=d(t.setFormat,e),p=s&&`S:${s}`||"",l=d(t.finalSetFormat,e),m=i&&i>1&&l&&s!==l&&`F:${l}`||"";if(o&&s)return[o,p,m].filter((t=>t)).join("-");return}(t,e):void 0}function c(t){return!isNaN(Number(t))&&Number(t)}function u(t){let e=`T${t.minutes}`;return t.based&&(e+=t.based),t.modifier&&(e+=`@${t.modifier}`),e}function d(t,e){if("object"==typeof t&&Object.keys(t).length){if(t.timed)return u(t);if(t.tiebreakSet)return p(t.tiebreakSet);const n=c(t.setTo);if(n){const r=t.NoAD&&i||"",a=p(t.tiebreakFormat),o=a&&`/${a}`||"",s=c(t.tiebreakAt);if(!1!==a)return`${n}${r}${o}${s&&(s!==n||e)&&`@${s}`||""}`}}}function p(t){if(t){if("object"!=typeof t||t.tiebreakTo){if("object"==typeof t&&c(t.tiebreakTo)){let e=`TB${t.tiebreakTo}${t.NoAD?i:""}`;return t.modifier&&(e+=`@${t.modifier}`),e}return!1}return""}}function l(t,e){return t-e}function m(t){return"number"==typeof t?parseInt(t.toString()):parseInt(t)}function f(t){return!isNaN(t)&&(t&&0==(t&t-1))}function h(t){if(!t.length)return;const e=[...t].sort(l),n=Math.floor(e.length/2);return e.length%2?e[n]:(e[n-1]+e[n])/2}function I(t){return isNaN(t)?0:t%2&&t+1||t}function g(t){return Math.pow(2,Math.round(Math.log(t)/Math.log(2)))}function U(t){return!isNaN(parseFloat(t))}function y(t){if(isNaN(t))return!1;for(;!f(t);)t++;return t}function S(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t+1))+t}function v(t){return Number.isSafeInteger("string"==typeof t?+t:t)}function w(t,e,n,r,i=2){const a=1-Math.random(),o=1-Math.random();let s=Math.sqrt(-2*Math.log(a))*Math.cos(2*Math.PI*o);return s=s/10+.5,s>1||s<0?s=w(t,e,n):(s=Math.pow(s,n),s*=e-t,s+=t),r&&(s=function(t,e){e||(e=1);const n=1/e;return Math.round(t*n)/n}(s,r)),parseFloat(s.toFixed(i))}function T(t){return t.filter(((t,e,n)=>n.lastIndexOf(t)===e))}function P(t){return t.map((t=>[Math.random(),t])).sort(((t,e)=>t[0]-e[0])).map((t=>t[1]))}function D(t){return v(t)?t:1/0}function N(t){return t.reduce(((t,e)=>(t[e]||(t[e]=0),t[e]++,t)),{})}function R(t,e,n){return n.indexOf(t)===e}function b(t){return t.filter(R)}function M(t){return Array.isArray(t)&&t.length?t.splice(Math.floor(Math.random()*t.length),1)[0]:void 0}function A(t){return t[Math.floor(Math.random()*t.length)]}function E(t,e){return Array.from({length:e-t},((e,n)=>n+t))}function C(t,e){return e.reduce(((e,n,r)=>(n===t&&e.push(r),e)),[])}function O(t,e){return Array.isArray(t)&&Array.isArray(e)?t.filter((t=>-1!==e.indexOf(t))).filter(((t,e,n)=>n.indexOf(t)===e)):[]}function F(t,e){return Array.isArray(t)&&Array.isArray(e)?t.filter((t=>!e.includes(t))):[]}function k(t,e){return!(!Array.isArray(t)||!Array.isArray(e))&&t.some((t=>e.includes(t)))}function x(t,e){return t.reduce(((t,n,r)=>{const i=Math.floor(r/e);return t[i]=[].concat(t[i]||[],n),t}),[])}function _(t,e,n){return t.reduce(((t,r,i)=>{const a=!!n&&!!(Math.floor(i/e)%2),o=i%e,s=a?e-1-o:o;return t[s]||(t[s]=[]),t[s].push(r),t}),[])}const L={success:!0},B={SUCCESS:L,ERROR:"error"},V={message:"Chronological error; time violation.",code:"ANACHRONISM"},j={message:"Cannot remove main structure",code:"ERR_CANNOT_REMOVE_MAIN_STRUCTURE"},G={message:"records must be an object with tournamentId keys",code:"ERR_INVALID_TOURNAMENTS"},q={message:"Missing tournamentRecords",code:"ERR_MISSING_TOURNAMENTS"},$={message:"Missing tournamentRecord",code:"ERR_MISSING_TOURNAMENT"},W={message:"Invalid tournamentRecord",code:"ERR_INVALID_TOURNAMENT"},H={message:"Missing tournamentId",code:"ERR_MISSING_TOURNAMENT_ID"},z={message:"Invalid drawDefinition",code:"ERR_INVALID_DRAWDEF"},Y={message:"Missing drawDefinition",code:"ERR_MISSING_DRAWDEF"},K={message:"Existing drawDefinition(s)",code:"ERR_EXISTING_DRAWDEFS"},J={message:"drawDefinition not found",code:"ERR_NOT_FOUND_DRAWDEF"},Q={message:"Invalid structure",code:"ERR_INVALID_STRUCTURE"},X={message:"Incomplete source structure",code:"ERR_INCOMPLETE_STRUCTURE"},Z={message:"Invalid drawPosition for seedAssignment",code:"ERR_INVALID_SEEDING_POSITION"},tt={message:"drawPosition already assigned",code:"ERR_EXISTING_POSITION_ASSIGNMENT"},et={message:"Schedule not cleared",code:"ERR_UNCHANGED_SCHEDULE_NOT_CLEARED"},nt={message:"drawPosition not cleared",code:"ERR_FAILURE_POSITION_NOT_CLEARED"},rt={message:"Unrecognized drawType",code:"ERR_UNRECOGNIZED_DRAW_TYPE"},it={message:"Missing drawPositions",code:"ERR_MISSING_DRAW_POSITIONS"},at={message:"drawPosition is active",code:"ERR_ACTIVE_DRAW_POSITION"},ot={message:"Invlid drawPosition",code:"ERR_INVALID_DRAW_POSITION"},st={message:"Missing drawPosition",code:"ERR_MISSING_DRAW_POSITION"},ct={message:"Invalid drawType",code:"ERR_INVALID_DRAW_TYPE"},ut={message:"Invalid drawSize",code:"ERR_INVALID_DRAW_SIZE"},dt={message:"Cannot set drawSize to be less than existing entries",code:"ERR_INVALID_DRAW_SIZE_MISMATCH"},pt={message:"Missing drawSize",code:"ERR_MISSING_DRAW_SIZE"},lt={message:"Missing drawId",code:"ERR_MISSING_DRAW_ID"},mt={message:"drawId exists",code:"ERR_EXISTING_DRAW_ID"},ft={message:"participantId cannot be assigned to multiple seedNumbers",code:"INVALID_PARTICIPANT_SEEDING"},ht={message:"seedsCount greater than drawSize",code:"ERR_INVALID_SEED_COUNT"},It={message:"Missing seedCountThresholds",code:"ERR_MISSING_SEED_COUNT_THRESHOLD"},gt={message:"Invalid action",code:"ERR_INVALID_ACTION"},Ut={message:"Invalid assignment",code:"ERR_INVALID_ASSIGNMENT"},yt={message:"Missing seedAssignments",code:"ERR_MISSING_SEED_ASSIGNMENTS"},St={message:"Invalid seedNumber",code:"ERR_INVALID_SEED_NUMBER"},vt={message:"Invalid seedPosition",code:"ERR_INVALID_SEED_POSITION"},wt={message:"Missing targetLink",code:"ERR_MISSING_LINK_TARGET"},Tt={message:"Existing round",code:"ERR_EXISTING_ROUND"},Pt={message:"Missing structureId",code:"ERR_MISSING_STRUCTURE_ID"},Dt={message:"structure not found",code:"ERR_NOT_FOUND_STRUCTURE"},Nt={message:"Missing structures",code:"ERR_MISSING_STRUCTURES"},Rt={message:"Missing structure",code:"ERR_MISSING_STRUCTURE"},bt={message:"drawDefinition contains unlinked structures",code:"ERR_MISSING_STRUCTURE_LINKS"},Mt={message:"Invalid eventType",code:"ERR_INVALID_EVENT_TYPE"},At={message:"Missing event / eventId",code:"ERR_MISSING_EVENT_ID"},Et={message:"Event not found",code:"ERR_NOT_FOUND_EVENT"},Ct={message:"Event exists",code:"ERR_EXISTING_EVENT"},Ot={message:"Missing entries",code:"ERR_MISSING_ENTRIES"},Ft={message:"Invalid entries",code:"ERR_INVALID_ENTRIES"},kt={message:"Missing assignments",code:"ERR_MISSING_ASSIGNMENTS"},xt={message:"Missing stage",code:"ERR_MISSING_STAGE"},_t={message:"Invalid stage",code:"ERR_INVALID_STAGE"},Lt={message:"stageSequence limit",code:"ERR_LIMIT_STAGE_SEQUENCE"},Bt={message:"Missing positionAssignments",code:"ERR_MISSING_POSITION_ASSIGNMENTS"},Vt={message:"Cannot Assign BYE status if no assignment: { bye: true }",code:"ERR_UNCHANGED_CANNOT_ASSIGN_BYE"},jt={message:"Unrecognized matchUpStatus",code:"ERR_UNRECOGNIZED_MATCHUP_STATUS"},Gt={message:"Unrecognized matchUpFormat",code:"ERR_UNRECOGNIZED_MATCHUP_FORMAT"},qt={message:"Incompatible matchUpStatus",code:"ERR_INCOMPATIBLE_MATCHUP_STATUS"},$t={message:"Invalid matchUpStatus",code:"ERR_INVALID_MATCHUP_STATUS"},Wt={message:"Invalid tieFormat",code:"ERR_INVALID_TIE_FORMAT"},Ht={message:"Invalid matchUpFormat",code:"ERR_INVALID_MATCHUP_FORMAT"},zt={message:"Missing matchUpFormat",code:"ERR_MISSING_MATCHUP_FORMAT"},Yt={message:"Missing collectionDefinition",code:"ERR_MISSING_COLLECTION_DEFINITION"},Kt={message:"Missing tieFormat",code:"ERR_MISSING_TIE_FORMAT"},Jt={message:"Missing matchUpId",code:"ERR_MISSING_MATCHUP_ID"},Qt={message:"Missing matchUpIds",code:"ERR_MISSING_MATCHUP_IDS"},Xt={message:"matchUp not found",code:"ERR_NOT_FOUND_MATCHUP"},Zt={message:"Missing matchUps",code:"ERR_MISSING_MATCHUPS"},te={message:"Missing matchUp",code:"ERR_MISSING_MATCHUP"},ee={message:"Invalid matchUp",code:"ERR_INVALID_MATCHUP"},ne={message:"Missing policyType",code:"ERR_MISSING_POLICY_TYPE"},re={message:"Missing policyDefinitions",code:"ERR_MISSING_POLICY_DEFINITIONS"},ie={message:"Missing avoidance policy",code:"ERR_MISSING_POLICY_AVOIDANCE"},ae={message:"Missing policy attributes",code:"ERR_MISSING_POLICY_ATTRIBUTES"},oe={message:"Invalid policyDefinitions",code:"ERR_INVALID_POLICY_DEFINITIONS"},se={message:"existing policyType",code:"ERR_EXISTING_POLICY_TYPE"},ce={message:"Policy not attached",code:"ERR_FAILURE_POLICY_NOT_ATTACHED"},ue={message:"Policy not found",code:"ERR_NOT_FOUND_POLICY"},de={message:"Invalid sideNumber",code:"ERR_INVALID_SIDE_NUMBER"},pe={message:"Missing setObject",code:"ERR_MISSING_SET_ATTRIBUTE"},le={message:"Missing courtId",code:"ERR_MISSING_COURT_ID"},me={message:"Missing value",code:"ERR_MISSING_VALUE"},fe={message:"Missing date",code:"ERR_MISSING_DATE"},he={message:"No valid dates",code:"ERR_NO_VALID_DATES"},Ie={message:"Invalid bookings",code:"ERR_INVALID_BOOKINGS"},ge={message:"Invalid dateAvailability",code:"ERR_INVALID_DATE_AVAILABILITY"},Ue={message:"Missing dateAvailability",code:"ERR_MISSING_DATE_AVAILABILITY"},ye={message:"Invalid Date",code:"ERR_INVALID_DATE"},Se={message:"Invalid time",code:"ERR_INVALID_TIME"},ve={message:"Invalid tournament dates",code:"ERR_INVALID_DATES_TOURNAMENT"},we={message:"Invalid game scores",code:"ERR_INVALID_SCORES_GAME"},Te={message:"Invalid score",code:"ERR_INVALID_SCORE"},Pe={message:"Invalid winningSide",code:"ERR_INVALID_WINNING_SIDE"},De={message:"No participants generated",code:"ERR_NO_PARTICIPANTS_GENERATED"},Ne={message:"Cannot modify tieFormat",code:"ERR_UNCHANGED_CANNOT_MODIFY_TIEFORMAT"},Re={message:"Cannot modify participantType",code:"ERR_UNCHANGED_CANNOT_MODIFY_PARTICIPANT_TYPE"},be={message:"Cannot remove participants",code:"ERR_UNCHANGED_CANNOT_REMOVE_PARTICIPANTS"},Me={message:"Cannot change winningSide",code:"ERR_UNCHANGED_CANNOT_CHANGE_WINNING_SIDE"},Ae={message:"Invalid participant",code:"ERR_INVALID_PARTICIPANT"},Ee={message:"Invalid participantId",code:"ERR_INVALID_PARTICIPANT_ID"},Ce={message:"Invalid participantIds",code:"ERR_INVALID_PARTICIPANT_IDS"},Oe={message:"Invalid participantRole",code:"ERR_INVALID_PARTICIPANT_ROLE"},Fe={message:"Invalid participantType",code:"ERR_INVALID_PARTICIPANT_TYPE"},ke={message:"Missing participantRole",code:"ERR_MISSING_PARTICIPANT_ROLE"},xe={message:"Missing participant",code:"ERR_MISSING_PARTICIPANT"},_e={message:"Missing participants",code:"ERR_MISSING_PARTICIPANTS"},Le={message:"Missing participantId",code:"ERR_MISSING_PARTICIPANT_ID"},Be={message:"Participant Not Found",code:"ERR_NOT_FOUND_PARTICIPANT"},Ve={message:"participantId exists",code:"ERR_EXISTING_PARTICIPANT_ID"},je={message:"No participant removed",code:"ERR_UNCHANGED_NO_PARTICIPANT_REMOVED"},Ge={message:"Missing participantIds",code:"ERR_MISSING_PARTICIPANT_IDS"},qe={message:"Missing participantsCount",code:"ERR_MISSING_PARTICIPANT_COUNT"},$e={message:"Participant not checked in",code:"ERR_UNCHANGED_PARTICIPANT_NOT_CHECKED_IN"},We={message:"Participant already checked in",code:"ERR_UNCHANGED_PARTICIPANT_CHECKED_IN"},He={message:"Missing person details",code:"ERR_MISSING_PERSON_DETAILS"},ze={message:"Existing participant drawPosition assignment",code:"ERR_EXISTING_PARTICIPANT_DRAW_POSITION_ASSIGNMENT"},Ye={message:"Existing participant",code:"ERR_EXISTING_PARTICIPANT"},Ke={message:"participantsCount exceeds drawSize",code:"ERR_INVALID_PARTICIPANT_COUNT"},Je={message:"Invalid entry status",code:"ERR_INVALID_ENTRY_STATUS"},Qe={message:"Participant Entry Not Found",code:"ERR_NOT_FOUND_PARTICIPANT_ENTRY"},Xe={message:"Participant not entered in stage",code:"ERR_UNCHANGED_PARTICIPANT_NOT_ENTERED"},Ze={message:"Participant not found in stageSequence",code:"ERR_NOT_FOUND_PARTICIPANT_IN_STAGE"},tn={message:"entryStatus not allowed in stage",code:"ERR_INVALID_ENTRY_STATUS_IN_STAGE"},en={message:"entryStatus not allowed for event",code:"ERR_INVALID_ENTRY_STATUS_IN_EVENT"},nn={message:"No stage space available for entryStatus",code:"ERR_UNCHANGED_NO_AVAILABLE_STAGE_SPACE"},rn={message:"Insufficient drawPositions to accommodate qualifiers",code:"ERR_UNCHANGED_NO_DRAW_POSITIONS_FOR_QUALIFIERS"},an={message:"Insufficient drawPositions to accommodate entries",code:"ERR_INSUFFICIENT_DRAW_POSITIONS"},on={message:"Missing penaltyType",code:"ERR_MISSING_PENALTY_TYPE"},sn={message:"Missing penaltyId",code:"ERR_MISSING_PENALTY_ID"},cn={message:"Penalty not found",code:"ERR_NOT_FOUND_PENALTY"},un={message:"Missing courtsCount/courtNames",code:"ERR_MISSING_COURTS_INFO"},dn={message:"Court not found",code:"ERR_NOT_FOUND_COURT"},pn={message:"Court exists",code:"ERR_EXISTING_COURT"},ln={message:"Venue exists",code:"ERR_EXISTING_VENUE"},mn={message:"Venue not found",code:"ERR_NOT_FOUND_VENUE"},fn={message:"Missing venueId",code:"ERR_MISSING_VENUE_ID"},hn={message:"Invalid endTime",code:"ERR_INVALID_END_TIME"},In={message:"Existing endTime",code:"ERR_EXISTING_END_TIME"},gn={message:"Invalid stopTime",code:"ERR_INVALID_STOP_TIME"},Un={message:"Invalid startTime",code:"ERR_INVALID_START_TIME"},yn={message:"Invalid resumeTime",code:"ERR_INVALID_RESUME_TIME"},Sn={message:"Invalid timeItem",code:"ERR_INVALID_TIME_ITEMS"},vn={message:"Missing async state provider",code:"ERR_MISSING_ASYNC_STATE_PROVIDER"},wn={message:"Missing timeItem",code:"ERR_MISSING_TIME_ITEM"},Tn={message:"Missing timeItems",code:"ERR_MISSING_TIME_ITEMS"},Pn={message:"Missing context",code:"ERR_MISSING_CONTEXT"},Dn={message:"Missing schedule",code:"ERR_MISSING_SCHEDULE"},Nn={message:"Invalid scaleItem",code:"ERR_INVALID_SCALE_ITEM"},Rn={message:"Modifications failed",code:"ERR_FAILURE_MODIFICATIONS"},bn={message:"No modifications applied",code:"ERR_UNCHANGED_NO_MODIFICATIONS_APPLIED"},Mn={message:"Unable to assign court",code:"ERR_UNCHANGED_COURT_NOT_ASSIGNED"},An={message:"No Candidates",code:"ERR_UNCHANGED_NO_CANDIDATES"},En={message:"Invalid configuration",code:"ERR_INVALID_CONFIG"},Cn={message:"Invalid collectionDefinition",code:"ERR_INVALID_COLLECTION_DEFINITION"},On={message:"Invalid object",code:"ERR_INVALID_OBJECT"},Fn={message:"Invalid gender",code:"ERR_INVALID_GENDER"},kn={message:"Invalid category",code:"ERR_INVALID_CATEGORY"},xn={message:"Invalid values",code:"ERR_INVALID_VALUES"},_n={message:"Duplicate value",code:"ERR_DUPLICATE_VALUE"},Ln={message:"Team not found",code:"ERR_NOT_FOUND_TEAM"},Bn={message:"No valid actions",code:"ERR_NO_VALID_ACTIONS"},Vn={message:"No valid attributes",code:"ERR_NO_VALID_ATTRIBUTES"},jn={message:"Value unchanged",code:"ABORT_UNCHANGED"},Gn={message:"Not found",code:"ERR_NOT_FOUND"},qn={message:"Not implemented",code:"ERR_NOT_IMPLEMENTED"},$n={message:"Existing flight",code:"ERR_EXISTING_FLIGHT"},Wn={message:"Existing flight profile",code:"ERR_EXISTING_FLIGHT_PROFILE"},Hn={message:"Existing outcome",code:"ERR_EXISTING_OUTCOME"},zn={message:"Existing matchUpId",code:"ERR_EXISTING_MATCHUP_ID"},Yn={message:"Existing stage",code:"ERR_EXISTING_STAGE"},Kn={message:"Existing structure",code:"ERR_EXISTING_STRUCTURE"},Jn={message:"Method not found",code:"ERR_NOT_FOUND_METHOD"},Qn={message:"Scheduled matchUps",code:"ERR_SCHEDULED_MATCHUPS"},Xn={ANACHRONISM:V,CANNOT_CHANGE_WINNING_SIDE:Me,CANNOT_MODIFY_TIEFORMAT:Ne,CANNOT_MODIFY_PARTICIPANT_TYPE:Re,CANNOT_REMOVE_MAIN_STRUCTURE:j,CANNOT_REMOVE_PARTICIPANTS:be,COURT_EXISTS:pn,COURT_NOT_FOUND:dn,DRAW_DEFINITION_NOT_FOUND:J,DRAW_ID_EXISTS:mt,DRAW_POSITION_ACTIVE:at,DRAW_POSITION_ASSIGNED:tt,DRAW_POSITION_NOT_CLEARED:nt,DRAW_POSITION_NOT_FOUND:{message:"drawPosition not found",code:"ERR_NOT_FOUND_DRAW_POSITION"},DRAW_SIZE_MISMATCH:dt,DUPLICATE_VALUE:_n,ENTRY_STATUS_NOT_ALLOWED_FOR_EVENT:en,ENTRY_STATUS_NOT_ALLOWED_IN_STAGE:tn,EVENT_EXISTS:Ct,EVENT_NOT_FOUND:Et,EXISTING_DRAW_DEFINITIONS:K,EXISTING_END_TIME:In,EXISTING_FLIGHT:$n,EXISTING_MATCHUP_ID:zn,EXISTING_OUTCOME:Hn,EXISTING_PARTICIPANT_DRAW_POSITION_ASSIGNMENT:ze,EXISTING_PARTICIPANT:Ye,EXISTING_POLICY_TYPE:se,EXISTING_PROFILE:Wn,EXISTING_ROUND:Tt,EXISTING_STAGE:Yn,EXISTING_STRUCTURE:Kn,INCOMPATIBLE_MATCHUP_STATUS:qt,INCOMPLETE_SOURCE_STRUCTURE:X,INSUFFICIENT_DRAW_POSITIONS:an,INVALID_ACTION:gt,INVALID_ASSIGNMENT:Ut,INVALID_BOOKINGS:Ie,INVALID_CATEGORY:kn,INVALID_COLLECTION_DEFINITION:Cn,INVALID_CONFIGURATION:En,INVALID_DATE_AVAILABILITY:ge,INVALID_DATE:ye,INVALID_DRAW_DEFINITION:z,INVALID_DRAW_POSITION_FOR_SEEDING:Z,INVALID_DRAW_POSITION:ot,INVALID_DRAW_SIZE:ut,INVALID_END_TIME:hn,INVALID_ENTRIES:Ft,INVALID_EVENT_TYPE:Mt,INVALID_GAME_SCORES:we,INVALID_GENDER:Fn,INVALID_MATCHUP_FORMAT:Ht,INVALID_MATCHUP_STATUS:$t,INVALID_MATCHUP_STATUS_BYE:Vt,INVALID_MATCHUP:ee,INVALID_OBJECT:On,INVALID_PARTICIPANT_ID:Ee,INVALID_PARTICIPANT_IDS:Ce,INVALID_PARTICIPANT_ROLE:Oe,INVALID_PARTICIPANT_SEEDING:ft,INVALID_PARTICIPANT_TYPE:Fe,INVALID_PARTICIPANT:Ae,INVALID_POLICY_DEFINITION:oe,INVALID_RECORDS:G,INVALID_SCALE_ITEM:Nn,INVALID_SEED_NUMBER:St,INVALID_SEED_POSITION:vt,INVALID_SET_NUMBER:{message:"Invalid setNumber",code:"ERR_INVALID_SET_NUMBER"},INVALID_SIDE_NUMBER:de,INVALID_SCORE:Te,INVALID_STAGE:_t,INVALID_START_TIME:Un,INVALID_STRUCTURE:Q,INVALID_STOP_TIME:gn,INVALID_TIE_FORMAT:Wt,INVALID_TIME:Se,INVALID_TIME_ITEM:Sn,INVALID_TOURNAMENT_DATES:ve,INVALID_TOURNAMENT_RECORD:W,INVALID_VALUES:xn,INVALID_WINNING_SIDE:Pe,MATCHUP_NOT_FOUND:Xt,METHOD_NOT_FOUND:Jn,MISSING_ASSIGNMENTS:kt,MISSING_ASYNC_STATE_PROVIDER:vn,MISSING_AVOIDANCE_POLICY:ie,MISSING_COLLECTION_DEFINITION:Yt,MISSING_COURT_ID:le,MISSING_COURTS_INFO:un,MISSING_DATE_AVAILABILITY:Ue,MISSING_DATE:fe,MISSING_DRAW_DEFINITION:Y,MISSING_DRAW_ID:lt,MISSING_DRAW_POSITION:st,MISSING_DRAW_POSITIONS:it,MISSING_DRAW_SIZE:pt,MISSING_ENTRIES:Ot,MISSING_EVENT:At,MISSING_MATCHUP_FORMAT:zt,MISSING_MATCHUP_ID:Jt,MISSING_MATCHUP_IDS:Qt,MISSING_MATCHUP:te,MISSING_MATCHUPS:Zt,MISSING_PARTICIPANT_COUNT:qe,MISSING_PARTICIPANT_ID:Le,MISSING_PARTICIPANT_IDS:Ge,MISSING_PARTICIPANT_ROLE:ke,MISSING_PARTICIPANT:xe,MISSING_PARTICIPANTS:_e,MISSING_PENALTY_ID:sn,MISSING_PENALTY_TYPE:on,MISSING_PERSON_DETAILS:He,MISSING_POLICY_ATTRIBUTES:ae,MISSING_POLICY_DEFINITION:re,MISSING_POLICY_TYPE:ne,MISSING_POSITION_ASSIGNMENTS:Bt,MISSING_ROUND_NUMBER:{message:"Missing roundNumber",code:"ERR_MISSING_ROUND_NUMBER"},MISSING_SCHEDULE:Dn,MISSING_SCORING_POLICY:{message:"Missing scoring policy / matchUpFormats",code:"ERR_MISSING_POLICY_SCORING_MATCHUP_FORMATS"},MISSING_SEED_ASSIGNMENTS:yt,MISSING_SEEDCOUNT_THRESHOLDS:It,MISSING_SEEDING_POLICY:{message:"Missing seeding policy",code:"ERR_MISSING_POLICY_SEEDING"},MISSING_SET_NUMBER:{message:"Missing setNumber",code:"ERR_MISSING_SET_NUMBER"},MISSING_SET_OBJECT:pe,MISSING_SIDE_NUMBER:{message:"Missing sideNumber",code:"ERR_MISSING_SIDE_NUMBER"},MISSING_STAGE:xt,MISSING_STRUCTURE_ID:Pt,MISSING_STRUCTURE:Rt,MISSING_STRUCTURES:Nt,MISSING_TARGET_LINK:wt,MISSING_TIE_FORMAT:Kt,MISSING_TIME_ITEM:wn,MISSING_TIME_ITEMS:Tn,MISSING_TOURNAMENT_ID:H,MISSING_TOURNAMENT_RECORD:$,MISSING_TOURNAMENT_RECORDS:q,MISSING_VALUE:me,MISSING_VENUE_ID:fn,MODIFICATIONS_FAILED:Rn,NO_CANDIDATES:An,NO_DRAW_POSITIONS_AVAILABLE_FOR_QUALIFIERS:rn,NO_MODIFICATIONS_APPLIED:bn,NO_STAGE_SPACE_AVAILABLE_FOR_ENTRY_STATUS:nn,NO_PARTICIPANT_REMOVED:je,NO_VALID_ACTIONS:Bn,NO_VALID_ATTRIBUTES:Vn,NO_VALID_DATES:he,NOT_FOUND:Gn,NOT_IMPLEMENTED:qn,PARTICIPANT_ALREADY_CHECKED_IN:We,PARTICIPANT_COUNT_EXCEEDS_DRAW_SIZE:Ke,PARTICIPANT_ID_EXISTS:Ve,PARTICIPANT_NOT_CHECKED_IN:$e,PARTICIPANT_NOT_FOUND:Be,PARTICIPANT_PAIR_EXISTS:{message:"participant pair exists",code:"ERR_EXISTING_PARTICIPANT_PAIR"},PENALTY_NOT_FOUND:cn,POLICY_NOT_ATTACHED:ce,POLICY_NOT_FOUND:ue,SCHEDULE_NOT_CLEARED:et,SCHEDULED_MATCHUPS:Qn,SEEDSCOUNT_GREATER_THAN_DRAW_SIZE:ht,STAGE_SEQUENCE_LIMIT:Lt,STRUCTURE_NOT_FOUND:Dt,TEAM_NOT_FOUND:Ln,UNABLE_TO_ASSIGN_COURT:Mn,UNLINKED_STRUCTURES:bt,UNRECOGNIZED_DRAW_TYPE:rt,UNRECOGNIZED_MATCHUP_FORMAT:Gt,UNRECOGNIZED_MATCHUP_STATUS:jt,VALUE_UNCHANGED:jn,VENUE_EXISTS:ln},Zn={disableNotifications:!1,tournamentId:void 0,tournamentRecords:{},subscriptions:{},modified:!1,notices:[]};var tr={addNotice:function({topic:t,payload:e,key:n}){if(Zn.modified=!0,"string"!=typeof t||"object"!=typeof e)return;if(Zn.disableNotifications||!Zn.subscriptions[t])return;n&&(Zn.notices=Zn.notices.filter((e=>!(e.topic===t&&e.key===n))));Zn.notices.push({topic:t,payload:e,key:n})},callListener:function({topic:t,notices:e}){const n=Zn.subscriptions[t];n&&"function"==typeof n&&n(e)},cycleMutationStatus:function(){const t=Zn.modified;return Zn.modified=!1,t},deleteNotice:function({topic:t,key:e}){Zn.notices=Zn.notices.filter((n=>(!t||n.topic===t)&&n.key!==e))},deleteNotices:function(){Zn.notices=[]},disableNotifications:function(){Zn.disableNotifications=!0},enableNotifications:function(){Zn.disableNotifications=!1},getNotices:function({topic:t}){const e=Zn.notices.filter((e=>e.topic===t)).map((t=>t.payload));return e.length&&e},getTopics:function(){return{topics:Object.keys(Zn.subscriptions)}},getTournamentId:er,getTournamentRecord:function(t){return Zn.tournamentRecords[t]},getTournamentRecords:function(){return Zn.tournamentRecords},removeTournamentRecord:function(t){if("string"!=typeof t)return{error:xn};if(!Zn.tournamentRecords[t])return{error:Gn};delete Zn.tournamentRecords[t];const e=Object.keys(Zn.tournamentRecords);1===e.length?Zn.tournamentId=e[0]:e.length||(Zn.tournamentId=void 0);return{success:!0}},setSubscriptions:function(t){return"object"!=typeof t.subscriptions?{error:xn}:(Object.keys(t.subscriptions).forEach((e=>{Zn.subscriptions[e]=t.subscriptions[e]})),{...L})},setTournamentId:function(t){return Zn.tournamentRecords[t]?(Zn.tournamentId=t,{success:!0}):{error:$}},setTournamentRecord:function(t){const e=t?.tournamentId;return e?(Zn.tournamentRecords[e]=t,{success:!0}):{error:W}},setTournamentRecords:function(t){Zn.tournamentRecords=t;const e=Object.keys(t);1===e.length?Zn.tournamentId=e[0]:e.length||(Zn.tournamentId=void 0)},handleCaughtError:function({engineName:t,methodName:e,params:n,err:r}){let i;"string"==typeof r?i=r.toUpperCase():r instanceof Error&&(i=r.message);console.log("ERROR",{tournamentId:er(),params:JSON.stringify(n),engine:t,methodName:e,error:i})}};function er(){return Zn.tournamentId}const nr={tournamentFactoryVersion:"0.0.0",timers:{default:{elapsedTime:0}},iterators:{makeDeepCopy:0},deepCopyAttributes:{stringify:[],ignore:[],toJSON:[]},deepCopy:!0};let rr=tr;function ir(t){return t&&"object"==typeof t?"object"==typeof nr.devContext&&(Object.keys(t).every((e=>nr.devContext?.[e]===t[e]))&&nr.devContext):nr.devContext??!1}function ar(t){nr.devContext=t}function or(){rr.enableNotifications()}function sr(t,e){"boolean"==typeof t&&(nr.deepCopy=t),"object"==typeof e&&(Array.isArray(e.ignore)&&(nr.deepCopyAttributes.ignore=e.ignore),Array.isArray(e.toJSON)&&(nr.deepCopyAttributes.toJSON=e.toJSON),Array.isArray(e.stringify)&&(nr.deepCopyAttributes.stringify=e.stringify),e.threshold&&(nr.deepCopyAttributes.threshold=e.threshold))}function cr(){return{enabled:nr.deepCopy,...nr.deepCopyAttributes}}function ur(){return rr.cycleMutationStatus()}function dr(t){return rr.addNotice(t)}function pr(t){return rr.getNotices(t)}function lr({key:t,topic:e}){return rr.deleteNotice({key:t,topic:e})}function mr(){return rr.deleteNotices()}function fr(){return rr.getTopics()}async function hr(t){return rr.callListener(t)}function Ir(){return rr.getTournamentId()}function gr(t){return rr.getTournamentRecord(t)}function Ur(){return rr.getTournamentRecords()}function yr(t){return rr.setTournamentRecord(t)}function Sr(t){return rr.setTournamentRecords(t)}function vr(t){return rr.setTournamentId(t)}function wr(t){return rr.removeTournamentRecord(t)}function Tr(){return rr}function Pr({engineName:t,methodName:e,params:n,err:r}){return("function"==typeof rr.handleCaughtError&&rr.handleCaughtError||tr.handleCaughtError)({engineName:t,methodName:e,params:n,err:r})}const Dr=/^[\d]{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][\d]|3[0-1])$/,Nr=/^((0[\d]|1[\d]|2[0-3]):[0-5][\d](:[0-5][\d])?)([.,][0-9]{3})?$/,Rr=/^([\d]{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][\d]|3[0-1]))([ T](0[\d]|1[\d]|2[0-3]):[0-5][\d](:[0-5][\d])?)?([.,][\d]{3})?Z?$/,br=/^([\d]{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][\d]|3[0-1]))?([ T]?(0[\d]|1[\d]|2[0-3]):[0-5][\d](:[0-5][\d])?)?([.,][\d]{3})?Z?$/;function Mr(t){let{scheduledDate:e}=t;if(!e&&t.scheduledTime&&(e=$r(t.scheduledTime)),!e)return;const n=qr(t.scheduledTime);let r=$r(e);return r&&n&&(r+=`T${n}`),r}function Ar(t){if("object"!=typeof t||Array.isArray(t))return!1;return"[object Date]"===Object.prototype.toString.call(t)}function Er(t){const e="string"==typeof t?t?.split(" "):[];return!(t&&e?.length>1&&!["AM","PM"].includes(e[1].toUpperCase()))&&!(t&&!br.test(zr(t,!0,!0)))}function Cr(t){return Br(t)||Dr.test(t)}const Or=t=>{const e=xr(t)||Br(t)?new Date(t):new Date,n=e.getUTCMonth()+1,r=n<10?`0${n}`:`${n}`;return`${e.getUTCFullYear()}-${ti(r)}-${ti(e.getUTCDate())}`};function Fr(t,e="-",n="YMD"){if(!t)return"";"string"==typeof t&&t.indexOf("T")<0&&(t+="T00:00");const r=new Date(t);let i=""+(r.getMonth()+1),a=""+r.getDate();const o=r.getFullYear();return i.length<2&&(i="0"+i),a.length<2&&(a="0"+a),"DMY"===n?[a,i,o].join(e):"MDY"===n?[i,a,o].join(e):"YDM"===n?[o,a,i].join(e):"DYM"===n?[a,o,i].join(e):"MYD"===n?[i,o,a].join(e):[o,i,a].join(e)}function kr(t){const e=t?new Date(t):new Date,n=e.getTimezoneOffset();return new Date(e.getTime()-60*n*1e3)}function xr(t){if("boolean"==typeof t)return!1;const e=t instanceof Date&&t||!isNaN(t)&&new Date(t)||!1;return e&&!isNaN(e.valueOf())}function _r(t,e){if(!Cr(t)||!Cr(e))return[];const n=$r(t)+"T00:00",r=$r(e)+"T00:00",i=new Date(n),a=new Date(r);const o=[];let s=0;if(xr(a)&&xr(i)&&i<=a){const t=i;let e=t.getTime();for(;e<=a.getTime()&&s<300;)s+=1,o.push(new Date(t)),e=t.setDate(t.getDate()+1)}return o.map((t=>Fr(t)))}const Lr=/^([+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24:?00)([.,]\d+(?!:))?)?(\17[0-5]\d([.,]\d+)?)?([zZ]|([+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/;function Br(t){return"string"==typeof t&&Lr.test(t)}function Vr(t){if("string"!=typeof t)return!1;const e=t.split("Z")[0].split(":"),n=e.every((t=>!isNaN(parseInt(t))));return!(e.length<2||!n||parseInt(e[0])>23||parseInt(e[1])>60)}function jr(t){const e=qr(t);if(!e)return 0;const[n,r]=e.split(":").map((t=>parseInt(t)));return 60*n+r}function Gr(t){return Vr(t)?t.split(":").slice(0,2).map(ti).join(":"):void 0}function qr(t){return Br(t)&&t.indexOf("T")>0?Gr(t.split("T").reverse()[0]):Gr(t)}function $r(t){return Br(t)||Rr.test(t)?t.split("T")[0]:void 0}function Wr(t,e){const n=new Date(t);return n.setDate(n.getDate()+e),$r(n.toISOString())}function Hr(t){t="string"!=typeof t?"00:00":t;const e={},n={};return({0:e.time,1:e.ampm}=t.split(" ")||[]),({0:n.hours,1:n.minutes}=e.time.split(":")||[]),n.ampm=e.ampm,isNaN(n.hours)||isNaN(n.minutes)||n.ampm&&!["AM","PM"].includes(n.ampm.toUpperCase())?{}:n}function zr(t,e,n){const r=$r(t),i=qr(t),a=r?i:t;return t?e&&(r&&n&&t||function(t){const e=Hr(t);return e.ampm&&e.hours&&("pm"===e.ampm.toLowerCase()&&parseInt(e.hours)<12&&(e.hours=(e.hours&&parseInt(e.hours)||0)+12),"am"===e.ampm.toLowerCase()&&"12"===e.hours&&(e.hours="00")),`${e.hours||"12"}:${e.minutes||"00"}`.split(":").map(ti).join(":")}(a))||function(t){const e=Hr(t);if("object"!=typeof e||Object.keys(e).length)return e.ampm?t:(e.hours>12?(e.hours-=12,e.ampm="PM"):"12"===e.hours?e.ampm="PM":"00"===e.hours?(e.hours="12",e.ampm="AM"):e.ampm="AM","0"===e.hours?.[0]&&(e.hours=e.hours.slice(1)),`${e.hours||"12"}:${e.minutes||"00"} ${e.ampm}`)}(a):void 0}function Yr(t,e){const n=Hr(t),r=Hr(e);if(parseInt(n.hours)<parseInt(r.hours))return-1;if(parseInt(n.hours)>parseInt(r.hours))return 1;if(n.hours===r.hours){if(parseInt(n.minutes)<parseInt(r.minutes))return-1;if(parseInt(n.minutes)>parseInt(r.minutes))return 1}return 0}function Kr(t,e=7){const n=$r(t)+"T00:00",r=new Date(n);return Fr(new Date(r.setDate(r.getDate()+e)))}function Jr(t,e=void 0){const[n,r]=(t||"00:00").split(":").map(ti),i=kr(e).setHours(n,r,0,0);return kr(i)}function Qr(t,e,n=!0){const r=new Date(t),i=(new Date(e).getTime()-r.getTime())/1e3/60;return n?Math.abs(Math.round(i)):Math.round(i)}function Xr(t,e){const n=qr(t);if(!n)return"00:00";const r=isNaN(e)?0:e;return qr(Zr(Jr(n),r).toISOString())}function Zr(t,e){const n=new Date(t);return new Date(n.getTime()+6e4*e)}function ti(t){return t.toString()[1]?t:"0"+t}function ei(t,e){const n=new Date(t),r=new Date(e);return n.getFullYear()===r.getFullYear()&&n.getMonth()===r.getMonth()&&n.getDate()===r.getDate()}const ni={addDays:Kr,addWeek:function(t){return Kr(t)},addMinutesToTimeString:Xr,convertTime:zr,getIsoDateString:Mr,getUTCdateString:Or,DateHHMM:function(t){const e=new Date(t);return function(t,e){const n=parseInt(t,10),r=Math.floor(n/3600),i=Math.floor((n-3600*r)/60),a=n-3600*r-60*i;return(!e||e?.displaySeconds?r+":"+i+":"+a:r+":"+i).split(":").map(ti).join(":")}(e.getSeconds()+60*e.getMinutes()+3600*e.getHours(),{displaySeconds:!1})},extractDate:$r,extractTime:qr,formatDate:Fr,getDateByWeek:function(t,e,n,r=!1){const i=new Date(e,0,1+7*(t-1)),a=r?0:1;return i.setDate(i.getDate()+(a-i.getDay())),Fr(i,n)},isISODateString:Br,isDate:xr,isTimeString:Vr,offsetDate:kr,offsetTime:function(t){return kr(t).getTime()},sameDay:ei,timeStringMinutes:jr,timeToDate:Jr,timeUTC:function(t){const e=xr(t)||Br(t)?new Date(t):new Date;return Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())},validTimeValue:Er,validDateString:Dr,timeValidation:br,dateValidation:Rr};function ri(t,e,n,r,i=0){if(Tr().makeDeepCopy)return Tr().makeDeepCopy(t,e,n,r);const a=cr(),{stringify:o,toJSON:s,ignore:c,modulate:u}=a||{};if(!a?.enabled&&!n||"object"!=typeof t||"function"==typeof t||null===t||"number"==typeof a?.threshold&&i>=a.threshold)return t;const d=ir({makeDeepCopy:!0});var p;d&&(p=i,nr.iterators.makeDeepCopy=p,"object"==typeof d&&(i>(d.iterationThreshold||15)||d.firstIteration&&0===i)&&d.log&&(!d.notInternalUse||d.notInternalUse&&!n)&&console.log({devContext:d,iteration:i,internalUse:n},t));const l=Array.isArray(t)?[]:{},m=Object.keys(t).filter((t=>!n||!c||Array.isArray(c)&&!c.includes(t)||"function"==typeof c&&!c(t))),f=(t,e)=>{l[t]="function"==typeof e?.toString?e.toString():JSON.stringify(e)};for(const h of m){const a=t[h],c="function"==typeof u?u(a):void 0;if(void 0!==c)l[h]=c;else if(e&&"extensions"===h&&Array.isArray(a)){const t=ii(a);Object.assign(l,...t)}else r&&"extensions"===h?l[h]=[]:Array.isArray(o)&&o.includes(h)?f(h,a):Array.isArray(s)&&s.includes(h)&&"function"==typeof a?.toJSON?l[h]=a.toJSON():null===a?l[h]=void 0:Ar(a)?l[h]=new Date(a).toISOString():l[h]=ri(a,e,n,r,i+1)}return l}function ii(t){return t?.map((t=>{const{name:e,value:n}=t;return e&&n&&{[`_${e}`]:n}})).filter(Boolean)}function ai({element:t,accessor:e}){if("string"!=typeof e)return{values:[]};const n=ri(t),r=e.split("."),i=[];let a;!function t({targetElement:e,attributes:n=[],significantCharacters:r}){for(const[s,c]of n.entries())if(e?.[c]){const r=n.slice(s+1);if(r.length)if(Array.isArray(e[c])){e[c].forEach((e=>t({targetElement:e,attributes:r})))}else o({targetElement:e=e[c],index:s});else a||(a=e[c]),i.includes(e[c])||i.push(e[c])}function o({targetElement:t,index:e}){if(t&&e===n.length-1&&["string","number"].includes(typeof t)){const e=r?t.slice(0,r):t;a?i.includes(e)||i.push(e):(a=e,i.push(e))}}}({targetElement:n,attributes:r});const o={value:a};return i.length&&(o.values=i),o}function oi(t){return"string"==typeof t}function si(t){return"object"==typeof t}function ci(t,e){return Array.isArray(t)?Object.assign({},...(t??[]).filter(si).map((t=>t[e]&&{[t[e]]:t})).filter(Boolean)):{}}const ui=t=>e=>t&&"object"==typeof e?Array.isArray(t)&&t.map((t=>({[t]:ai({element:e,accessor:t})?.value})))||"object"==typeof t&&Object.keys(t).map((t=>({[t]:ai({element:e,accessor:t})?.value})))||("string"==typeof t&&ai({element:e,accessor:t}))?.value:void 0;function di(t,e,n,r){if("object"!=typeof t||null===t)return t;const i=cr();i?.enabled||(r=!0);const a=["",void 0,null];e&&a.push(!1);const o=Object.keys(t).filter((e=>!a.includes(t[e])&&(!n||!Array.isArray(t[e])||t[e].length)));return Object.assign({},...o.map((e=>Array.isArray(t[e])?{[e]:r?t[e]:t[e].map((t=>di(t)))}:{[e]:r?t[e]:di(t[e])})))}function pi(t){return Array.isArray(t)?t.length+t.map(pi).reduce(((t,e)=>t+e),0):"object"==typeof t&&null!==t?Object.keys(t).length+Object.keys(t).map((e=>pi(t[e]))).reduce(((t,e)=>t+e),0):0}function li(t){if(null===t)return{};const{source:e,template:n}=t||{};if(!n)return e;const r={};return function t(e,n,r){if(!e||!n)return;const i=Object.keys(e),a=Object.keys(n),o=Object.assign({},...a.filter((t=>t.indexOf("||"))).map((t=>t.split("||").map((e=>({[e]:t}))))).flat()),s=a.concat(...Object.keys(o)),c=s.includes("*");for(const u of i)if(s.indexOf(u)>=0||c){const i=n[o[u]||u]||c,a=e[u];if("object"!=typeof i||"function"==typeof a||Array.isArray(i)){const t=e[u];if(Array.isArray(i)&&!i.includes(t))return!1;(n[u]||c&&!1!==n[u])&&(r[u]=t)}else if(Array.isArray(a)){const e=a.map((e=>{const n={};return!1!==t(e,i,n)?n:void 0})).filter(Boolean);r[u]=e}else a&&(r[u]={},t(a,i,r[u]))}return}(e,n,r),r}function mi(t=0){const e=new Date;return e.setHours(e.getHours()+t),e.getTime().toString(36).slice(-6).toUpperCase()}function fi(t,e=".",n=[]){return"object"==typeof t&&Object.keys(t).reduce(((r,i)=>"object"!=typeof t[i]?(r[n.concat(i).join(e)]=t[i],r):Object.assign(r,fi(t[i],e,n.concat(i)))),{})}function hi(){const t=[];for(let a=0;a<256;a++)t[a]=(a<16?"0":"")+a.toString(16);const e=4294967295*Math.random()|0,n=4294967295*Math.random()|0,r=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return t[255&e]+t[e>>8&255]+t[e>>16&255]+t[e>>24&255]+"-"+t[255&n]+t[n>>8&255]+"-"+t[n>>16&15|64]+t[n>>24&255]+"-"+t[63&r|128]+t[r>>8&255]+"-"+t[r>>16&255]+t[r>>24&255]+t[255&i]+t[i>>8&255]+t[i>>16&255]+t[i>>24&255]}function Ii(t){if("string"==typeof t){const e=t.startsWith("T")&&r||t.startsWith(a)&&a||"";if(e===r){const e=Si(t);if(e)return{simplified:!0,setFormat:e,bestOf:1}}if(e===a)return function(t){const e=t.split("-"),n=wi(e[0].slice(3)),r=1===n||n%2!=0?n:void 0,i=1!==n&&n%2==0?n:void 0,a=e&&gi(e[1]),o=e&&gi(e[2]),s=a&&a.timed||o&&o.timed,c=r&&r<6||s&&i,u=!e[2]||o,d=a,p=di({setFormat:a,exactly:i,bestOf:r});o&&(p.finalSetFormat=o);if(c&&d&&u)return p}(t)}}function gi(t){if(":"===t?.[1]){const e=t.split(":"),n=o[e[0]],r=e[1];if(n&&r){if(0===r.indexOf("TB")){const t=yi(r);return!1!==t&&("object"==typeof t?{tiebreakSet:t}:void 0)}if(0===r.indexOf("T"))return Si(r);const e=t.match(/^[FS]:(\d+)([A-Za-z]*)/),n=e&&vi(e[2])||!1,i=!e?.[2]||n,a=e?wi(e[1]):void 0,o=Ui(r),s=!1!==o,c=s&&o||a,u=yi(r.split("/")[1]),d=!1!==u,p={setTo:a};return n&&(p.NoAD=!0),u?(p.tiebreakFormat=u,p.tiebreakAt=c):p.noTiebreak=!0,a&&i&&d&&s&&p||!1}}}function Ui(t,e=!0){const n=t?.indexOf("@")>0&&t.split("@");if(n){return(e?wi(n[1]):n[1])||!1}}function yi(t){if(t){if(t.startsWith("TB")){const e=Ui(t,!1),n=t.match(/^TB(\d+)([A-Za-z]*)/),r=n?.[1],i=n&&vi(n[2]),a=!n?.[2]||i,o=wi(r);if(o&&a){const t={tiebreakTo:o};return e&&"string"==typeof e&&!v(e)&&(t.modifier=e),i&&(t.NoAD=!0),t}return!1}return!1}}function Si(t){const e=t.slice(1),n=e.match(/^(\d+)(@?[A-Za-z]*)/),r=wi(n?.[1]);if(!r)return;const i={timed:!0,minutes:r},a=n?.[2],o=[void 0,"P","G"].includes(a);if(a&&!o){const t=e.match(/^(\d+)(@)([A-Za-z]+)$/)?.[3];return t?(i.modifier=t,i):void 0}return a&&(i.based=n[2]),i}function vi(t){return t&&t.indexOf(i)>=0}function wi(t){return isNaN(Number(t))?0:Number(t)}function Ti(t){if("string"!=typeof t)return!1;const e=Ii(t),n=t.match(/-S:([1-9])+\/TB([0-9]{1,2})@?([1-9]?)*/),r=n?.[1],i=n?.[2],a=n?.[3],o=t.match(/-F:([1-9])+\/TB([0-9]{1,2})@?([1-9]?)*/),c=o?.[1],u=o?.[2],d=o?.[3];return s(e,!!(n&&i&&r===a||o&&u&&c===d))===t}const Pi={isValidMatchUpFormat:Ti,stringify:s,isValid:Ti,parse:Ii};function Di(t){if(!t)return;const{tieFormatId:e,tieFormats:n}=t;return t.tieFormat?t.tieFormat:e&&Array.isArray(n)?n.find((t=>t.tieFormatId===e)):void 0}function Ni({item:t,drawDefinition:e,structure:n,event:r}){if(t){if(t.tieFormat)return t.tieFormat;if(t.tieFormatId){if(e.tieFormat)return e.tieFormat;const n=e.tieFormats?.find((e=>t.tieFormatId===e.tieFormatId));return n||(r.tieFormat?r.tieFormat:r.tieFormats?.find((e=>t.tieFormatId===e.tieFormatId)))}if(n.tieFormat)return n.tieFormat;if(n.tieFormatId){const t=e.tieFormats?.find((t=>n.tieFormatId===t.tieFormatId));if(t)return t}}}function Ri({drawDefinition:t,structure:e,matchUp:n,event:r}){return{tieFormat:Ni({item:n,drawDefinition:t,structure:e,event:r})||Ni({item:e,drawDefinition:t,structure:e,event:r})||Di(t)||Di(r)}}const bi=(t,e)=>t.filter(Boolean).every((t=>typeof t===e)),Mi=t=>t.filter(Boolean).every(U);function Ai(t){const e=t.category;if("object"!=typeof e)return{error:kn};let{ageCategoryCode:n,ageMaxDate:r,ageMinDate:i,ageMax:a,ageMin:o}=e;const s=e.categoryName;let c;if(!bi([n,r,i,s],"string")||!Mi([a,o]))return{error:kn};const u=t.consideredDate??$r((new Date).toLocaleDateString("sv"));if(!Cr(u))return{error:ye};const[d]=u.split("-").slice(0,3).map((t=>parseInt(t))),p=Wr(u,-1),[l,m]=p.split("-").slice(1,3).map((t=>parseInt(t))),f=`${ti(l)}-${ti(m)}`,h=Wr(u,1),[I,g]=h.split("-").slice(1,3).map((t=>parseInt(t))),U=`${ti(I)}-${ti(g)}`;let y=o&&Wr(u,-365*o),S=a&&Wr(u,-365*a);const v=[],w=t=>!v.includes(t)&&v.push(t);n=n??s;const T=/^([UO]?)(\d{1,2})([UO]?)$/,P=/^C(\d{1,2})-(\d{1,2})$/,D=n?.includes("-"),N=D&&n?.match(P),R=n?.match(T),b=(t,e)=>`${t}-${e}`,M=t=>{const r=b(d-t-1,U);e.ageMin&&e.ageMin>t&&w(`Invalid submitted ageMin: ${o}`),e.ageMax&&e.ageMax>t&&w(`Invalid submitted ageMax: ${a}`),e.ageMinDate&&e.ageMinDate!==r&&w(`Invalid submitted ageMinDate: ${i}`),i=r,n&&(e.ageMax&&e.ageMax!==t&&(w(`Invalid submitted ageMax: ${a}`),y=void 0),a=t)},A=t=>{const i=b(d-t,f);e.ageMaxDate&&e.ageMaxDate!==i&&w(`Invalid submitted ageMaxDate: ${r}`),r=i,n&&(e.ageMin&&e.ageMin!==t+1&&(w(`Invalid submitted ageMin: ${o}`),y=void 0),o=t+1)},E=t=>{const[s,c,u]=(t.match(T)||[]).slice(1),p=parseInt(c);"U"===s?(e.ageMaxDate&&e.ageMaxDate!==r&&w(`Invalid submitted ageMaxDate: ${e.ageMaxDate}`),(t=>{const r=b(d-t,U);e.ageMinDate&&e.ageMinDate!==r&&w(`Invalid submitted ageMinDate: ${i}`),i=r,n&&(e.ageMax&&e.ageMax!==t-1&&(w(`Invalid submitted ageMax: ${a}`),S=void 0),a=t-1)})(p)):"O"===s&&A(p),"U"===u?(e.ageMaxDate&&e.ageMaxDate!==r&&w(`Invalid submitted ageMaxDate: ${e.ageMaxDate}`),M(p)):"O"===u&&(t=>{const i=b(d-t-1,f);e.ageMaxDate&&e.ageMaxDate!==i&&w(`Invalid submitted ageMaxDate: ${r}`),r=i,n&&(e.ageMin&&e.ageMin!==t&&(w(`Invalid submitted ageMin: ${o}`),y=void 0),o=t)})(p),r=r??y,i=i??S};if(N){if(r=void 0,i=void 0,a=void 0,o=void 0,e.ageMin){const t=d-e.ageMin;r=b(t,f)}if(e.ageMax){const t=d-e.ageMax-1;i=b(t,U)}const[t,s]=(n?.match(P)??[]).slice(1).map((t=>parseInt(t)));t<=s?(o=t,a=s,c=!0):w(`Invalid combined age range ${n}`)}else D?n?.split("-").forEach(E):R?E(n):(o&&A(o),a&&M(a));a&&e.ageMin&&e.ageMin>a&&(w(`Invalid submitted ageMin: ${e.ageMin}`),o=void 0);const C=di({consideredDate:u,combinedAge:c,ageMaxDate:r,ageMinDate:i,ageMax:a,ageMin:o});return v.length&&(C.errors=v),C}function Ei({childCategory:t,withDetails:e,category:n}){const r=Ai({category:n}),i=Ai({category:t}),a=i.ageMin&&(r.ageMin&&i.ageMin<r.ageMin||r.ageMax&&i.ageMin>r.ageMax),o=i.ageMax&&(r.ageMax&&i.ageMax>r.ageMax||r.ageMin&&i.ageMax<r.ageMin),s=i.ageMinDate&&r.ageMaxDate&&new Date(i.ageMinDate)>new Date(r.ageMaxDate),c=i.ageMaxDate&&r.ageMinDate&&new Date(i.ageMaxDate)<new Date(r.ageMinDate),u=di({valid:!(o||a||s||c),invalidAgeMax:o,invalidAgeMin:a,invalidAgeMinDate:s,invalidAgeMaxDate:c},!0);return e&&Object.assign(u,{categoryDetails:r,childCategoryDetails:i}),u}function Ci(t){return`${t} must be an array`}function Oi({context:t,result:e,stack:n,info:r}){return e&&!Array.isArray(e?.stack)&&(e.stack=[]),e&&Array.isArray(e?.stack)&&"string"==typeof n&&e.stack.push(n),e&&r&&(e.info=r),e&&"object"==typeof t&&Object.keys(t).length&&Object.assign(e,di(t)),!e||e?.error||e?.success||Object.assign(e,{...L}),e??{success:!0}}var Fi=(t=>(t.AdHoc="AD_HOC",t.Compass="COMPASS",t.CurtisConsolation="CURTIS_CONSOLATION",t.DoubleElimination="DOUBLE_ELIMINATION",t.FeedIn="FEED_IN",t.FeedInChampionship="FEED_IN_CHAMPIONSHIP",t.FeedInChampionshipToQf="FEED_IN_CHAMPIONSHIP_TO_QF",t.FeedInChampionshipToR16="FEED_IN_CHAMPIONSHIP_TO_R16",t.FeedInChampionshipToSf="FEED_IN_CHAMPIONSHIP_TO_SF",t.FirstMatchLoserConsolation="FIRST_MATCH_LOSER_CONSOLATION",t.FirstRoundLoserConsolation="FIRST_ROUND_LOSER_CONSOLATION",t.ModifiedFeedInChampionship="MODIFIED_FEED_IN_CHAMPIONSHIP",t.Lucky="LUCKY_DRAW",t.Olympic="OLYMPIC",t.Other="OTHER",t.Playoff="PLAYOFF",t.RoundRobin="ROUND_ROBIN",t.RoundRobinWithPlayoff="ROUND_ROBIN_WITH_PLAYOFF",t.SingleElimination="SINGLE_ELIMINATION",t))(Fi||{}),ki=(t=>(t.Consolation="CONSOLATION",t.Main="MAIN",t.PlayOff="PLAY_OFF",t.Qualifying="QUALIFYING",t.VoluntaryConsolation="VOLUNTARY_CONSOLATION",t))(ki||{}),xi=(t=>(t.Alternate="ALTERNATE",t.Confirmed="CONFIRMED",t.DirectAcceptance="DIRECT_ACCEPTANCE",t.FeedIn="FEED_IN",t.JuniorExempt="JUNIOR_EXEMPT",t.LuckyLoser="LUCKY_LOSER",t.OrganiserAcceptance="ORGANISER_ACCEPTANCE",t.Qualifier="QUALIFIER",t.SpecialExempt="SPECIAL_EXEMPT",t.Registered="Registered",t.Ungrouped="UNGROUPED",t.Unpaired="UNPAIRED",t.Wildcard="WILDCARD",t.Withdrawn="WITHDRAWN",t))(xi||{}),_i=(t=>(t.Loser="LOSER",t.Position="POSITION",t.Winner="WINNER",t))(_i||{}),Li=(t=>(t.BottomUp="BOTTOM_UP",t.Draw="DRAW",t.LossPosition="LOSS_POSITION",t.Random="RANDOM",t.TopDown="TOP_DOWN",t.Waterfall="WATERFALL",t))(Li||{}),Bi=(t=>(t.Doubles="DOUBLES",t.Singles="SINGLES",t.Team="TEAM",t))(Bi||{}),Vi=(t=>(t.Abandoned="ABANDONED",t.AwaitingResult="AWAITING_RESULT",t.Bye="BYE",t.Cancelled="CANCELLED",t.Completed="COMPLETED",t.DeadRubber="DEAD_RUBBER",t.Defaulted="DEFAULTED",t.DoubleDefault="DOUBLE_DEFAULT",t.DoubleWalkover="DOUBLE_WALKOVER",t.InProgress="IN_PROGRESS",t.Incomplete="INCOMPLETE",t.NotPlayed="NOT_PLAYED",t.Retired="RETIRED",t.Suspended="SUSPENDED",t.ToBePlayed="TO_BE_PLAYED",t.Walkover="WALKOVER",t))(Vi||{}),ji=(t=>(t.Any="ANY",t.Female="FEMALE",t.Male="MALE",t.Mixed="MIXED",t))(ji||{}),Gi=(t=>(t.Administration="ADMINISTRATION",t.Captain="CAPTAIN",t.Coach="COACH",t.Competitor="COMPETITOR",t.Media="MEDIA",t.Medical="MEDICAL",t.Official="OFFICIAL",t.Other="OTHER",t.Security="SECURITY",t))(Gi||{}),qi=(t=>(t.Group="GROUP",t.Individual="INDIVIDUAL",t.Pair="PAIR",t.Team="TEAM",t))(qi||{});function $i(t){const e=!(!1===t?.enforceCategory||!t?.category),n=!(!1===t?.enforceGender||!t?.gender),r=t?.checkCollectionIds,i=t?.tieFormat,a="validateTieFormat",o=[];if(!t||!i||"object"!=typeof i)return o.push("tieFormat must be an object"),Oi({result:{error:Wt},context:{tieFormat:i,errors:o},stack:a});if("object"!=typeof i.winCriteria)return o.push("tieFormat.winCriteria must be an object"),Oi({result:{error:Wt},context:{tieFormat:i,errors:o},stack:a});if(!Array.isArray(i.collectionDefinitions))return o.push(Ci("tieFormat.collectionDefinitions")),Oi({result:{error:Wt},context:{tieFormat:i,errors:o},stack:a});let s;const c=i.collectionDefinitions.every((i=>{const{setValue:a,scoreValue:c,collectionValue:u}=i;!a&&!c||u||(s=!0);const{valid:d,errors:p}=Wi({referenceCategory:t.category,referenceGender:t.gender,collectionDefinition:i,checkCollectionIds:r,checkCategory:e,checkGender:n});return!!d||(Array.isArray(p)&&o.push(...p),!1)})),u="number"==typeof i.winCriteria?.valueGoal&&i.winCriteria?.valueGoal>0&&!s||i.winCriteria?.aggregateValue;if(!u&&!i.winCriteria?.aggregateValue)return s?o.push("aggregateValue is required"):o.push("Either non-zero valueGoal, or { aggregateValue: true } must be specified in winCriteria"),Oi({context:{tieFormat:i,errors:o,aggregateValueImperative:s},result:{error:Wt},stack:a});const d=i.collectionDefinitions.map((({collectionId:t})=>t)),p=!r||d.length===T(d).length,l=c&&u&&p;return l?{valid:l,errors:o}:Oi({result:{error:Wt},context:{tieFormat:i,errors:o},stack:a})}function Wi({checkCategory:t=!0,collectionDefinition:e,checkCollectionIds:n,checkGender:r=!0,referenceCategory:i,referenceGender:a,event:o}){a=a??o?.gender;const s="validateCollectionDefinition",c=[];if("object"!=typeof e)return c.push(`collectionDefinition must be an object: ${e}`),Oi({result:{errors:c,error:On},stack:s});const{collectionValueProfiles:u,collectionGroupNumber:d,collectionValue:p,collectionId:l,matchUpCount:m,matchUpFormat:f,matchUpValue:h,matchUpType:I,scoreValue:g,setValue:U,category:y,gender:S}=e;n&&"string"!=typeof l&&c.push(`collectionId is not type string: ${l}`),"number"!=typeof m&&c.push(`matchUpCount is not type number: ${m}`),I&&![Bi.Singles,Bi.Doubles].includes(I)&&c.push(`matchUpType must be SINGLES or DOUBLES: ${I}`);if(1!==[!!u?.length].concat([h,p,g,U].map(v)).filter(Boolean).length&&c.push("Missing value definition for matchUps: matchUpValue, collectionValue, or collectionValueProfiles"),h&&"number"!=typeof h&&c.push(`matchUpValue is not type number: ${h}`),p&&"number"!=typeof p&&c.push(`collectionValue is not type number: ${p}`),u){const t=Hi({collectionValueProfiles:u,matchUpCount:m});t.errors&&c.push(...t.errors)}if(d&&"number"!=typeof d&&c.push(`collectionGroupNumber is not type number: ${p}`),f&&!Pi.isValid(f)&&c.push(`Invalid matchUpFormat: ${f}`),r&&a&&S&&[ji.Male,ji.Female].includes(a)&&a!==S)return c.push(`Invalid gender: ${S}`),Oi({context:{referenceGender:a,gender:S},result:{error:Fn},stack:s});if(t&&i&&y){const t=Ei({category:i,childCategory:y});if(!t.valid)return Oi({result:{error:kn},context:t,stack:s})}return c.length?Oi({result:{errors:c,error:Cn},stack:s}):{valid:!0}}function Hi({collectionValueProfiles:t,matchUpCount:e}){const n=[];if(!Array.isArray(t))return n.push(`collectionValueProfiles is not an array: ${t}`),{errors:n};if(t.length&&t.length!==e)return n.push("collectionValueProfiles do not align with matchUpsCount"),{errors:n};for(const i of t){if("object"!=typeof i)return n.push(`valueProfile is not type object: ${i}`),{errors:n};const{value:t,collectionPosition:r}=i;if("number"!=typeof t||"number"!=typeof r||r>e||r<1)return n.push("Invalid value profile: value and collectionPosition must be numeric. collectionPosition cannot be greater than matchUpCount"),{errors:n}}const r=t.map((t=>t.collectionPosition));return r.length!==T(r).length?(n.push("collectionPositions are not unique"),{errors:n}):{...L}}const zi="ABANDONED",Yi="AWAITING_RESULT",Ki="BYE",Ji="CANCELLED",Qi="COMPLETED",Xi="DEAD_RUBBER",Zi="DEFAULTED",ta="DOUBLE_DEFAULT",ea="DOUBLE_WALKOVER",na="IN_PROGRESS",ra="INCOMPLETE",ia="NOT_PLAYED",aa="RETIRED",oa="SUSPENDED",sa="TO_BE_PLAYED",ca="WALKOVER",ua=[Yi,Qi,Zi,na,ra,aa,oa],da=[Yi,Qi,Zi,ea,ta,na,ra,aa,oa,ca],pa=[zi,Yi,Ki,Ji,Qi,Xi,Zi,ea,ta,na,ra,ia,aa,oa,sa,ca],la=[Ki,ea,ta,Qi,Zi,aa,ca],ma=[zi,Yi,Ji,Xi,na,ra,ia,oa,sa,void 0],fa=[Vi.Cancelled,Vi.Abandoned,Vi.Completed,Vi.DeadRubber,Vi.Defaulted,Vi.DoubleWalkover,Vi.DoubleDefault,Vi.Retired,Vi.Walkover],ha=[zi,Qi,Zi,ea,ta,na,aa,ca],Ia=[na,ra,oa,sa],ga={ABANDONED:zi,AWAITING_RESULT:Yi,BYE:Ki,CANCELLED:Ji,COMPLETED:Qi,DEAD_RUBBER:Xi,DEFAULTED:Zi,DOUBLE_WALKOVER:ea,DOUBLE_DEFAULT:ta,IN_PROGRESS:na,INCOMPLETE:ra,NOT_PLAYED:ia,RETIRED:aa,SUSPENDED:oa,TO_BE_PLAYED:sa,WALKOVER:ca};function Ua({matchUp:t}){return fa.includes(t?.matchUpStatus)||t?.winningSide}function ya(t){if(!si(t))return!1;const{matchUpId:e,drawPositions:n}=t,r="string"==typeof e,i=!n||Array.isArray(n)&&n.length<=2&&n.every((t=>v(t)||null==t));return r&&i}function Sa(t){return!!Array.isArray(t)&&t.every(ya)}const va="SET3-S:6/TB7",wa="SET3-S:6/TB7-F:TB10";function Ta({winningSide:t,matchUpFormat:e=va,matchUpStatus:n,tallyPolicy:r,score:i}){const a=[0,0],{sets:o}=i||{},s=t-1,c=Ii(e),u=Pa(c?.bestOf??1);if(n===Zi&&r?.setsCreditForDefaults||n===ca&&r?.setsCreditForWalkovers)a[s]=u;else for(const d of o||[]){const{winningSide:t}=d;t&&(a[t-1]+=1)}return n===aa&&(+a[1-s]===u&&(a[1-s]-=1),r?.setsCreditForRetirements&&(a[s]=u)),a}function Pa(t){return t&&Math.ceil(t/2)||1}function Da(t){return"P"===t}function Na(t){return!Da(t)}const Ra="SINGLES",ba="SINGLES",Ma="DOUBLES",Aa="DOUBLES",Ea="TEAM",Ca="TEAM",Oa={SINGLES_MATCHUP:Ra,SINGLES:ba,DOUBLES_MATCHUP:Ma,DOUBLES:Aa,TEAM_MATCHUP:Ea,TEAM:Ca};function Fa({participantIds:t,matchUpFormat:e,tallyPolicy:n,perPlayer:r,matchUps:i}){const a={},o=n?.excludeMatchUpStatuses||[],s=i.filter((e=>(e.tieMatchUps||!o.includes(e.matchUpStatus))&&(!t?.length||2===O(t,[_a(e,0),_a(e,1)]).length))),c=s.flatMap((({score:t,tieMatchUps:e})=>e?e.filter((({matchUpStatus:t})=>!o.includes(t))).flatMap((({score:t})=>t?.sets?.length||0)):t?.sets?.length||0)).reduce(((t,e)=>t+e),0);for(const u of s){const{matchUpStatus:t,tieMatchUps:i,tieFormat:o,score:s,winningSide:c,sides:d}=u,p=o&&u._disableAutoCalc&&o.collectionDefinitions.every((({scoreValue:t})=>t)),l=c&&ka(u),m=c&&xa(u);if(l||m)if(La(a,l),La(a,m),i?.length){r=0;for(const t of i){const{matchUpType:e}=t,r=e===Aa,i=e===ba;t.winningSide&&(t.winningSide===c?(l&&(a[l].tieMatchUpsWon+=1,i&&(a[l].tieSinglesWon+=1),r&&(a[l].tieDoublesWon+=1)),m&&(a[m].tieMatchUpsLost+=1,i&&(a[m].tieSinglesLost+=1),r&&(a[m].tieDoublesLost+=1))):t.winningSide!==c&&(m&&(a[m].tieMatchUpsWon+=1,i&&(a[m].tieSinglesWon+=1),r&&(a[m].tieDoublesWon+=1)),l&&(a[l].tieMatchUpsLost+=1,i&&(a[l].tieSinglesLost+=1),r&&(a[l].tieDoublesLost+=1)))),Va({matchUpFormat:t.matchUpFormat,matchUpStatus:t.matchUpStatus,score:t.score,winningParticipantId:l,losingParticipantId:m,participantResults:a,isTieMatchUp:!0,manualGamesOverride:p,tallyPolicy:n,winningSide:c})}ja({winningParticipantId:l,losingParticipantId:m,participantResults:a,matchUpStatus:t})}else Va({matchUpFormat:u.matchUpFormat||e,isTieMatchUp:void 0,winningParticipantId:l,manualGamesOverride:p,losingParticipantId:m,participantResults:a,matchUpStatus:t,tallyPolicy:n,winningSide:c,score:s});else if(fa.includes(t)){const t=_a(u,0),e=_a(u,1);t&&(La(a,t),a[t].matchUpsCancelled+=1),e&&(La(a,e),a[e].matchUpsCancelled+=1)}else if(i?.length){r=0;for(const t of i){if(t.winningSide){const e=d.find((({sideNumber:e})=>e===t.winningSide))?.participantId,n=d.find((({sideNumber:e})=>e===t.winningSide))?.participantId;e&&n&&(La(a,e),La(a,n),a[e].tieMatchUpsWon+=1,a[n].tieMatchUpsLost+=1,t.matchUpType===ba?(a[e].tieSinglesWon+=1,a[n].tieSinglesLost+=1):t.matchUpType===Aa&&(a[e].tieDoublesWon+=1,a[n].tieDoublesLost+=1))}Ba({score:t.score,manualGamesOverride:p,participantResults:a,sides:d})}}else Ba({manualGamesOverride:p,participantResults:a,score:s,sides:d});if(p){const t=d.find((({sideNumber:t})=>1===t))?.participantId,e=d.find((({sideNumber:t})=>2===t))?.participantId;La(a,t),La(a,e);const n=s.sets.reduce(((t,e)=>t+e.side1Score),0),r=s.sets.reduce(((t,e)=>t+e.side2Score),0);a[t].gamesWon+=n,a[e].gamesWon+=r,a[t].gamesLost+=r,a[e].gamesLost+=n}}return function({participantResults:t,matchUpFormat:e,tallyPolicy:n,perPlayer:r,totalSets:i}){const a=e&&Ii(e)||{},o=a.bestOf,s=o&&Math.ceil(o/2)||1,c=a.setFormat?.setTo;Object.keys(t).forEach((e=>{const a=t[e].setsWon,o=t[e].setsLost,u=n?.groupTotalSetsPlayed?i:r*(s||0)||a+o;let d=Math.round(a/u*1e3)/1e3;(d===1/0||isNaN(d))&&(d=u);const p=t[e].tieMatchUpsWon,l=p+t[e].tieMatchUpsLost;let m=Math.round(p/l*1e3)/1e3;(m===1/0||isNaN(m))&&(m=p);const f=t[e].matchUpsWon,h=f+t[e].matchUpsLost;let I=Math.round(f/h*1e3)/1e3;(I===1/0||isNaN(I))&&(I=f);const g=t[e].gamesWon||0,U=t[e].gamesLost||0,y=(r||0)*(s||0)*(c||0),S=Math.max(y,g+U);let v=Math.round(g/S*1e3)/1e3;(v===1/0||isNaN(v))&&(v=0);let w=Math.round(t[e].pointsWon/t[e].pointsLost*1e3)/1e3;(w===1/0||isNaN(w))&&(w=0),t[e].setsWon=a,t[e].setsLost=o,t[e].setsPct=d,t[e].tieMatchUpsWon=p,t[e].tieMatchUpsPct=m,t[e].matchUpsPct=I,t[e].gamesWon=g,t[e].gamesLost=U,t[e].gamesPct=v,t[e].pointsPct=w,t[e].result=`${t[e].matchUpsWon}/${t[e].matchUpsLost}`}))}({participantResults:a,matchUpFormat:e,tallyPolicy:n,perPlayer:r,totalSets:c}),{participantResults:a}}function ka(t){return _a(t,t.winningSide-1)}function xa(t){return _a(t,1-(t.winningSide-1))}function _a(t,e){if(!t?.sides)return console.log("no sides:",{matchUp:t}),"foo";const n=t.sides[e];return n?n.participantId:(console.log("No Side",{matchUp:t,index:e}),"foo")}function La(t,e){e&&!t[e]&&(t[e]={allDefaults:0,defaults:0,defeats:[],gamesLost:0,gamesWon:0,matchUpsCancelled:0,matchUpsLost:0,matchUpsWon:0,pointsLost:0,pointsWon:0,retirements:0,setsLost:0,setsWon:0,tieSinglesWon:0,tieSinglesLost:0,tieDoublesWon:0,tieDoublesLost:0,tieMatchUpsLost:0,tieMatchUpsWon:0,victories:[],walkovers:0})}function Ba({manualGamesOverride:t,participantResults:e,score:n,sides:r}){const{sets:i}=n||{},a=[[],[]],o=[0,0];for(const c of i||[]){const{winningSide:t,side1Score:e,side2Score:n}=c;t&&(o[t-1]+=1),a[0].push(m(e||0)),a[1].push(m(n||0))}const s=[a[0].reduce(((t,e)=>t+e),0),a[1].reduce(((t,e)=>t+e),0)];r.forEach(((n,r)=>{const{participantId:i}=n;i&&(La(e,i),e[i].setsWon+=o[r],e[i].setsLost+=o[1-r],t||(e[i].gamesWon+=s[r],e[i].gamesLost+=s[1-r]))}))}function Va({winningParticipantId:t,losingParticipantId:e,participantResults:n,manualGamesOverride:r,matchUpFormat:i,matchUpStatus:a,isTieMatchUp:o,tallyPolicy:s,winningSide:c,score:u}){const d=c&&c-1,p=1-d;o||ja({winningParticipantId:t,losingParticipantId:e,participantResults:n,matchUpStatus:a});const l=Ta({matchUpStatus:a,matchUpFormat:i,tallyPolicy:s,winningSide:c,score:u}),f=function({matchUpFormat:t=va,winningSide:e,matchUpStatus:n,tallyPolicy:r,score:i}){const{sets:a}=i||{};if(!a)return[0,0];const o=e-1,s=Ii(t),c=Pa(s?.bestOf??1),u=s?.setFormat?.tiebreakAt||0,d=[[],[]];if(n===Zi&&r?.gamesCreditForDefaults||n===ca&&r?.gamesCreditForWalkovers){const t=c*(s?.setFormat?.setTo||0);d[o].push(t)}else a.forEach(((t,e)=>{const n=(t.setNumber||e+1)>c&&s?.finalSetFormat?"finalSetFormat":"setFormat",i=s?.[n]?.based,a=s?.[n].tiebreakSet,{side1Score:o,side2Score:u}=t;Na(i)&&(d[0].push(m(o||0)),d[1].push(m(u||0))),a&&t.winningSide&&!1!==r?.gamesCreditForTiebreakSets&&d[t.winningSide-1].push(1)}));if(n===aa){const i=a.length>c&&s?.finalSetFormat?"finalSetFormat":"setFormat",p=s?.[i];if(Na(p.based)){const i=p?.setTo||0,l=t=>{if(s&&""!==t)return+t==u-1||+t===u?m(u||0)+1:+t<u?i:u},f=Ta({winningSide:e,score:{sets:a},matchUpStatus:n,matchUpFormat:t,tallyPolicy:r});if(d.map((t=>t[o]<=t[1-o])).reduce(((t,e)=>t+(e?1:0)),0)>f[1-o]){const t=d[o].length,e=l(d[1-o][t-1]);e&&(d[o][t-1]=e)}c>d[o].length&&r?.gamesCreditForRetirements&&d[o].push(i)}}return[d[0].reduce(((t,e)=>t+e),0),d[1].reduce(((t,e)=>t+e),0)]}({matchUpStatus:a,matchUpFormat:i,tallyPolicy:s,winningSide:c,score:u}),h=function({matchUpFormat:t,score:e}){const n=Ii(t),r=Pa(n?.bestOf??1),i=[0,0];return e?.sets?.forEach(((t,e)=>{const a=(t.setNumber||e+1)>r&&n?.finalSetFormat?"finalSetFormat":"setFormat",o=n?.[a]?.based;if(Da(o)){const{side1Score:e,side2Score:n}=t;e&&(i[0]+=m(e||0)),n&&(i[1]+=m(n||0))}else t.side1TiebreakScore&&(i[0]+=m(t.side1TiebreakScore||0)),t.side2TiebreakScore&&(i[1]+=m(t.side2TiebreakScore||0))})),i}({score:u,matchUpFormat:i});t&&(n[t].setsWon+=l[d],n[t].setsLost+=l[p],r||(n[t].gamesWon+=f[d],n[t].gamesLost+=f[p]),n[t].pointsWon+=h[d],n[t].pointsLost+=h[p]),e&&(n[e].setsWon+=l[p],n[e].setsLost+=l[d],r||(n[e].gamesWon+=f[p],n[e].gamesLost+=f[d]),n[e].pointsWon+=h[p],n[e].pointsLost+=h[d])}function ja({winningParticipantId:t,losingParticipantId:e,participantResults:n,matchUpStatus:r}){e&&(r===ca&&(n[e].walkovers+=1),r===Zi&&(n[e].defaults+=1),r===aa&&(n[e].retirements+=1),[Zi,aa,ca].includes(r)&&(n[e].allDefaults+=1),n[e].matchUpsLost+=1),t&&(n[t].matchUpsWon+=1),e&&t&&(n[e].defeats.push(t),n[t].victories.push(e))}function Ga({participantResults:t,participantIds:e,attribute:n}){return qa({participantResults:t,participantIds:e}).reduce(((t,e)=>{const{participantId:r,results:i}=e,a=i?.[n];return!isNaN(a)&&r&&(t[a]?t[a].push(r):t[a]=[r]),t}),{})}function qa(t){return(t.participantIds||Object.keys(t.participantResults)).reduce(((e,n,r)=>(e.push({participantId:n,i:r,results:t.participantResults[n]}),e)),[])}const $a=[{attribute:"matchUpsPct",idsFilter:!1},{attribute:"allDefaults",reversed:!0,idsFilter:!1},{attribute:"defaults",reversed:!0,idsFilter:!1},{attribute:"walkovers",reversed:!0,idsFilter:!1},{attribute:"retirements",reversed:!0,idsFilter:!1},{attribute:"setsPct",idsFilter:!1},{attribute:"gamesPct",idsFilter:!1},{attribute:"pointsPct",idsFilter:!1},{attribute:"matchUpsPct",idsFilter:!0},{attribute:"setsPct",idsFilter:!0},{attribute:"gamesPct",idsFilter:!0},{attribute:"pointsPct",idsFilter:!0}],Wa={matchUpsPct:20,tieMatchUpsPct:16,setsPct:12,gamesPct:8,pointsPct:4};function Ha(t){const{requireCompletion:e=!0,participantResults:n,subOrderMap:r,tallyPolicy:i}=t,a=[];if(e&&!function({participantResults:t,participantsCount:e}){const n=qa({participantResults:t}),r=n.filter((t=>e-1===t.results.matchUpsWon+t.results.matchUpsLost+t.results.matchUpsCancelled));return e===r.length}(t))return{};const o=["tieMatchUpsWon","tieSinglesWon","tieDoublesWon","matchUpsWon","pointsWon","gamesWon","setsWon","gamesPct","setsPct","pointsPct","matchUpsPct"].includes(i?.groupOrderKey)?i.groupOrderKey:"matchUpsWon",s=Ga({participantResults:n,attribute:o});a.push({attribute:o,groups:s});const c=Object.keys(s).map((t=>parseFloat(t))).sort(((t,e)=>e-t)).map((t=>s[t])).map((e=>{const n=za({participantIds:e,...t});return a.push(n.report),n.order})).flat(1/0);let u,d=1;c.forEach(((t,e)=>{e&&(t.resolved||u&&!t.resolved)&&(d+=1),u=t.resolved,t.resolved?(t.position=e+1,d=t.position):t.position=d}));const p=N(c.map((({position:t})=>t)));return c.forEach((t=>{const{participantId:e,position:a}=t||{},o=n[e];t.GEMscore=function(t){const e=Array.isArray(i?.GEMscore)?Object.keys(Wa).filter((t=>i.GEMscore.includes(t))):Object.keys(Wa);return e.map((e=>(t[e]||0)*Math.pow(10,Wa[e].toFixed(3)))).reduce(((t,e)=>t+e),0)}(o);const s=p[a];void 0!==t?.position&&(s>1&&(t.ties=s,r&&(t.subOrder=r[e])),t.rankOrder=a,t.groupOrder=a+(t.subOrder||1)-1)})),{groupOrder:c,report:a.flat(1/0).filter(Boolean)}}function za({participantResults:t,disableHeadToHead:e,participantIds:n,matchUpFormat:r,tallyPolicy:i,matchUps:a}){if(1===n?.length){return{order:[{resolved:!0,participantId:n[0]}]}}if(2===n?.length&&(!i?.headToHead||!i.headToHead.disabled&&!e)){const e=function({participantIds:t,participantResults:e}){if(!t)return;if(e[t[0]].victories.includes(t[1]))return t.map((t=>({resolved:!0,participantId:t})));if(e[t[1]].victories.includes(t[0]))return t.reverse().map((t=>({resolved:!0,participantId:t})))}({participantIds:n,participantResults:t});if(e)return{order:[e],headToHeadWinner:e[0].participantId}}const o=[],s=[];let c;const u=(i?.tallyDirectives||$a).filter((t=>{const e=!(U(t.maxParticipants)&&n?.length>t.maxParticipants);return e||o.push(t),e}));return o.length&&s.push({excludedDirectives:o,participantIds:n}),u.every((({attribute:t,reversed:e,idsFilter:o,disableHeadToHead:u})=>(c=function({disableHeadToHead:t,participantIds:e,matchUpFormat:n,tallyPolicy:r,attribute:i,idsFilter:a,matchUps:o,reversed:s}){const{participantResults:c}=Fa({participantIds:a&&e,matchUpFormat:n,tallyPolicy:r,matchUps:o}),u=Ga({participantResults:c,participantIds:e,attribute:i}),d=[{attribute:i,reversed:s,groups:u,idsFilter:a}];let p;return Object.keys(u).length>1&&e.length&&(p=Object.keys(u).map((t=>parseFloat(t))).sort(((t,e)=>s?t-e:e-t)).map((t=>u[t])).map((e=>{const i=za({participantResults:c,disableHeadToHead:t,participantIds:e,matchUpFormat:n,tallyPolicy:r,matchUps:o});return d.push(i.report),i.order})).flat(1/0)),{order:p,report:d}}({disableHeadToHead:u,participantIds:n,matchUpFormat:r,tallyPolicy:i,attribute:t,idsFilter:o,matchUps:a,reversed:e}),s.push(c.report),!c.order))),c.order?{order:c.order,report:s}:{order:n?.map((t=>({participantId:t}))),report:s}}const Ya="voluntaryConsolation",Ka="competitiveBands",Ja="roundRobinTally",Qa="positionActions",Xa="matchUpActions",Za="rankingPoints",to="roundNaming",eo="participant",no="progression",ro="scheduling",io="avoidance",ao="display",oo="scoring",so="seeding",co="feedIn",uo="draws",po={POLICY_TYPE_VOLUNTARY_CONSOLATION:Ya,POLICY_TYPE_COMPETITIVE_BANDS:Ka,POLICY_TYPE_ROUND_ROBIN_TALLY:Ja,POLICY_TYPE_POSITION_ACTIONS:Qa,POLICY_TYPE_MATCHUP_ACTIONS:Xa,POLICY_TYPE_RANKING_POINTS:Za,POLICY_TYPE_ROUND_NAMING:to,POLICY_TYPE_PARTICIPANT:eo,POLICY_TYPE_PROGRESSION:no,POLICY_TYPE_SCHEDULING:ro,POLICY_TYPE_AVOIDANCE:io,POLICY_TYPE_DISPLAY:ao,POLICY_TYPE_FEED_IN:co,POLICY_TYPE_SCORING:oo,POLICY_TYPE_SEEDING:so,POLICY_TYPE_AUDIT:"audit",POLICY_TYPE_DRAWS:uo};function lo({policyDefinitions:t,generateReport:e,matchUpFormat:n,matchUps:r=[],subOrderMap:i,perPlayer:a}){if(!Sa(r))return{error:Zt};if(1!==r.reduce(((t,{structureId:e})=>t.includes(e)?t:t.concat(e)),[]).length)return{error:xn,info:"Maximum one structureId"};const o=r.filter((t=>t&&t.matchUpStatus!==Ki)),s=o.length&&T(o.map((({drawPositions:t})=>t)).flat()).length,c=o.filter((t=>Ua({matchUp:t}))).length===o.length;c||(a=0);const u=r.every((({matchUpType:t,tieMatchUps:e})=>t===Ca&&e.every((t=>Ua({matchUp:t}))))),d=t?.[Ja],p=r.filter((t=>Ua({matchUp:t})||t.matchUpType===Ca)),{participantResults:l}=Fa({matchUps:p,matchUpFormat:n,tallyPolicy:d,perPlayer:a});let m,f;const{groupOrder:h,report:I}=Ha({matchUps:p,participantResults:l,participantsCount:s,matchUpFormat:n,tallyPolicy:d,subOrderMap:i});if(c&&h)m=I,f=h,h.forEach((t=>{const{participantId:e,groupOrder:n,rankOrder:r,subOrder:i,ties:a,GEMscore:o}=t,s=l[e];Object.assign(s,{groupOrder:n,rankOrder:r,GEMscore:o,subOrder:i,ties:a})}));else{const{groupOrder:t,report:e}=Ha({requireCompletion:!1,participantResults:l,participantsCount:s,matchUpFormat:n,tallyPolicy:d,subOrderMap:i,matchUps:r});m=e,f=t,t&&t.forEach((t=>{const{participantId:e,groupOrder:n,GEMscore:r}=t,i=l[e];Object.assign(i,{provisionalOrder:n,GEMscore:r})}))}const g={completedTieMatchUps:u,readableReport:"",participantResults:l,bracketComplete:c,order:[],report:m};if((c||u)&&(g.order=f),e||ir({tally:!0})){const t=function({matchUps:t,order:e,report:n}){const r={};t.forEach((({sides:t})=>{t.forEach((t=>{t.participantId&&t.participant&&(r[t.participantId]=t.participant.participantName)}))}));const i=[];return Array.isArray(n)&&n.forEach(((t,e)=>{if(t.excludedDirectives?.length){const e=t.excludedDirectives.map((({attribute:t})=>t)).join(", "),n=`${e.length} directives were excluded due to participants limit}`;i.push(n);const r=`Excluded: ${e}`;i.push(r)}else{const n=(e,n)=>parseFloat(t.reversed?e:n)-parseFloat(t.reversed?n:e),a=t=>{Object.keys(t.groups).sort(n).forEach((e=>{const n=t.groups[e].map((t=>r[t])).join(", "),a=`${e} ${t.attribute}: ${n}`;i.push(a)}))},o=t.reversed?" in reverse order":"",s=`Step ${e+1}: ${Object.values(t.groups).flat(1/0).length} particiants were grouped${o} by ${t.attribute}`;if(i.push(s),t.idsFilter){const e=`${t.attribute} was calculated considering ONLY TIED PARTICIPANTS`;i.push(e)}a(t)}i.push("----------------------")})),i.push("Final Order:"),e.forEach((t=>{const{participantId:e,resolved:n}=t,a=t.groupOrder||t.provisionalOrder;i.push(`${a}: ${r[e]} => resolved: ${n}`)})),i.join("\r\n")}({matchUps:r,report:m,order:f});ir({tally:!0})&&console.log(t),g.readableReport=t}return g}function mo({collectionDefinition:t,groupValueNumbers:e,groupValueGroups:n,sideTieValues:r,tieMatchUps:i}){const a=i.filter((e=>e.collectionId===t.collectionId)),o=[0,0];let s=[0,0];const c=a.every((t=>fa.includes(t.matchUpStatus))),{collectionValueProfiles:u,collectionGroupNumber:d,collectionValue:p,matchUpValue:l,winCriteria:m,scoreValue:f,setValue:h}=t,I=d&&e.includes(d),g=[0,0];if(a.forEach((t=>{t.winningSide&&(g[t.winningSide-1]+=1)})),v(l)?a.forEach((t=>{t.winningSide&&(o[t.winningSide-1]+=l)})):v(h)?a.forEach((t=>{t.score?.sets?.forEach((t=>{t.winningSide&&(o[t.winningSide-1]+=h)}))})):v(f)?a.forEach((t=>{t.score?.sets?.forEach((e=>{const{side1TiebreakScore:n=0,side2TiebreakScore:r=0,side1Score:i=0,side2Score:a=0}=e;(t.matchUpStatus===Qi||t.winningSide||e.winningSide)&&(i||a?(o[0]+=i,o[1]+=a):(n||r)&&e.winningSide&&(o[e.winningSide-1]+=1))}))})):Array.isArray(u)&&a.forEach((e=>{if(e.winningSide){const n=e.collectionPosition,r=function({collectionDefinition:t,collectionPosition:e}){const n=t.collectionValueProfiles||[],r=n?.find((t=>t.collectionPosition===e));return r?.matchUpValue}({collectionDefinition:t,collectionPosition:n});v(r)&&(o[e.winningSide-1]+=r)}})),v(p)){let e;if(m?.aggregateValue)c&&(v(l||h||f)&&o[0]!==o[1]?e=o[0]>o[1]?1:2:g[0]!==g[1]&&(e=g[0]>g[1]?1:2));else if(m?.valueGoal)e=o.reduce(((t,e,n)=>e>=m.valueGoal?n+1:t),0);else{const n=Math.floor(t.matchUpCount/2)+1;e=g.reduce(((t,e,r)=>e>=n?r+1:t),0)}e&&(I?n[d].values[e-1]+=p:s[e-1]+=p)}else I?(n[d].values[0]+=o[0]||0,n[d].values[1]+=o[1]||0):s=o;I?(n[d].sideWins[0]+=g[0]||0,n[d].sideWins[1]+=g[1]||0,n[d].allGroupMatchUpsCompleted=n[d].allGroupMatchUpsCompleted&&c,n[d].matchUpsCount+=a.length):s.forEach(((t,e)=>r[e]+=t||0))}const fo="appliedPolicies",ho="positionActions",Io="context",go="delegatedOutcome",Uo="disabled",yo="disableLinks",So="disableAutoCalc",vo="drawDeletions",wo="entryProfile",To="flightProfile",Po="groupingAttribute",Do="lineUps",No="linkedTournamentsIds",Ro="matchUpHistory",bo="participantRepresentatives",Mo="personRequests",Ao="rankingPoints",Eo="roundTarget",Co="scheduleLimits",Oo="scheduleTiming",Fo="schedulingProfile",ko="subOrder",xo="tally",_o="tieFormatModification",Lo={APPLIED_POLICIES:fo,AUDIT_POSITION_ACTIONS:ho,CONTEXT:Io,DELEGATED_OUTCOME:go,DISABLED:Uo,DISABLE_LINKS:yo,DISABLE_AUTO_CALC:So,DRAW_DELETIONS:vo,DRAW_PROFILE:"drawProfile",ENTRY_PROFILE:wo,EVENT_PROFILE:"eventProfile",FLIGHT_PROFILE:To,GROUPING_ATTRIBUTE:Po,LINEUPS:Do,LINKED_TOURNAMENTS:No,MATCHUP_HISTORY:Ro,PARTICIPANT_REPRESENTATIVES:bo,PERSON_REQUESTS:Mo,RANKING_POINTS:Ao,ROUND_TARGET:Eo,SCHEDULE_LIMITS:Co,SCHEDULE_TIMING:Oo,SCHEDULING_PROFILE:Fo,STATUS_DETAIL:"statusDetail",SUB_ORDER:ko,TALLY:xo,TIE_FORMAT_MODIFICATIONS:_o,FACTORY:"factory"},Bo=[go,Uo,yo,To,Do,Ro,bo,Mo,Eo,Co,Oo,Fo,ko,xo];function Vo({onlySpecifiedPolicyTypes:t=!1,policyTypes:e=[],tournamentRecord:n,drawDefinition:r,structure:i,event:a}){if(!Array.isArray(e))return{error:ne};const o={};return n&&s(n),a&&s(a),r&&s(r),i&&s(i),{appliedPolicies:o,...L};function s(n){const r=n?.extensions,i=r?.find((t=>t.name===fo))?.value;if(i)for(const a of Object.keys(i))(t?e.includes(a):!e.length||e.includes(a))&&(o[a]=ri(i[a],!1,!0))}}function jo({policyTypes:t=[],tournamentRecord:e,drawDefinition:n,structure:r,event:i}){if(!Array.isArray(t))return{error:ne};const{appliedPolicies:a}=Vo({tournamentRecord:e,drawDefinition:n,structure:r,event:i}),o={};for(const s of t){const t=a?.[s];t&&(o[s]=t)}return Object.keys(o).length?{policyDefinitions:o}:{info:ue.message}}const Go="WALKOVER",qo="RETIRED",$o="COMPETITIVE",Wo="ROUTINE",Ho="DECISIVE",zo="winRatio",Yo={[Ka]:{policyName:"Competitive Bands Default",profileBands:{[Ho]:20,[Wo]:50}}};function Ko({policyDefinitions:t,tournamentRecord:e,contextProfile:n,drawDefinition:r,event:i}){const a={policies:{}};if(!n)return a;const o=jo({tournamentRecord:e,drawDefinition:r,event:i}).policyDefinitions;if(n.withCompetitiveness){const e=t?.[Ka]||o?.[Ka]||Yo[Ka];a.policies[Ka]=e}return a}function Jo({matchUps:t,matchUpId:e}){return{matchUp:(t||[]).find((t=>t.matchUpId===e))}}const Qo=(t,e)=>(t||0)+(e||0);function Xo(t,e){const n=Array.isArray(t)?t[0]:t;return isNaN(n)&&Go||n<=e[Ho]&&Ho||n<=e[Wo]&&Wo||$o}function Zo({score:t}){const e=t?.sets||[],n=e.reduce(((t,e)=>(t[0]+=e.side1Score||0,t[1]+=e.side2Score||0,t)),[0,0]),r=e.reduce(((t,e)=>(t[0]+=e.side1TiebreakScore||0,t[1]+=e.side2TiebreakScore||0,t)),[0,0]);return r.reduce(Qo)&&(n[r[0]>r[1]?0:1]+=1),{sets:e,games:n,score:t}}function ts(t){const e=Math.min(...t.games),n=Math.max(...t.games);return Math.round(e/n*100)}function es(t){return t.map(ts).sort().map((t=>parseFloat(t.toFixed(2))))}function ns({tournamentRecord:t,drawDefinition:e,policyType:n,structure:r,event:i}){if(!t)return{error:$};const{appliedPolicies:a}=Vo({tournamentRecord:t,drawDefinition:e,structure:r,event:i});return a?.[n]?{policy:a[n]}:{info:ue?.message}}function rs({profileBands:t,tournamentRecord:e,matchUp:n}){if(!n)return{error:te};const{score:r,winningSide:i}=n;if(!i)return{error:xn};const a=!t&&e&&ns({policyType:Ka,tournamentRecord:e}).policy,o=t||a?.profileBands||Yo[Ka].profileBands,s=es([Zo({score:r})]),c=Xo(s,o),u=Array.isArray(s)?s[0]:s;return{...L,competitiveness:c,pctSpread:u}}function is(t){const{matchUpAverageTimes:e,matchUpFormat:n}=t||{},r=e?.map((({matchUpFormatCodes:t})=>t?.filter((t=>t===n)))).flat().filter(Boolean).sort(((t,e)=>(t?.length||0)-(e?.length||0)))||[],i=r.includes(n)?n:r[0],a=e?.find((({matchUpFormatCodes:t,averageTimes:e})=>t?.find((t=>i===t))&&e));return a?.averageTimes}function as(t){const{matchUpRecoveryTimes:e,averageMinutes:n,matchUpFormat:r}=t||{};return e?.find((({matchUpFormatCodes:t,averageTimes:e,recoveryTimes:i})=>{if(e&&n){const{greaterThan:t=0,lessThan:r=360}=e;if(n>t&&n<r)return!0}return t?.find((t=>t===r))&&i}))?.recoveryTimes}function os({timesBlockArray:t,categoryName:e,categoryType:n}){return t.filter((t=>Array.isArray(t))).map((t=>t.sort(((t,e)=>(e.categoryNames?.length||0)-(t.categoryNames?.length||0))).find((({categoryTypes:t,categoryNames:r})=>!r?.length&&!t?.length||r?.includes(e)||t?.includes(n))))).find(Boolean)}const ss="DYNAMIC",cs="RANKING",us="RATING",ds="SCALE",ps="SEEDING",ls={RANKING:cs,RATING:us,SCALE:ds,SEEDING:ps};function ms({participant:t}){const e=t.timeItems?.filter((({itemType:t})=>t?.startsWith(ds)&&[cs,us,ps].includes(t.split(".")[1]))),n={ratings:{},rankings:{},seedings:{}};if(e?.length){const t=t=>e.filter((e=>e?.itemType===t)).sort(((t,e)=>new Date(t.createdAt||void 0).getTime()-new Date(e.createdAt||void 0).getTime())).pop(),r=T(e.map((({itemType:t})=>t)));for(const e of r){const r=t(e);if(r){const[,t,e,i,a]=r.itemType.split("."),o=a?`${i}.${a}`:i,s=(t===ps?"seedings":t===cs&&"rankings")||"ratings";n[s][e]||(n[s][e]=[]),n[s][e].push({scaleValue:r.itemValue,scaleDate:r.itemDate,scaleName:o})}}}return{...L,...n}}function fs({tournamentParticipants:t=[],policyDefinitions:e={},contextProfile:n,participantId:r,internalUse:i,personId:a}){const o=ri(t.find((t=>r&&t.participantId===r||a&&t.person&&t.person.personId===a)),!1,i);if(o){const t=e?.[eo];if(n?.withScaleValues){const{ratings:t,rankings:e}=ms({participant:o});o.rankings=e,o.ratings=t}if(t?.participant)return li({template:t.participant,source:o})}return o}function hs({tournamentRecord:t,participantId:e}){return{participant:(t.participants||[]).reduce(((t,n)=>n.participantId===e?n:t),void 0)}}const Is="extensionQueries";function gs({element:t,name:e}){if(!t||!e)return Oi({result:{error:me},stack:Is});if(!Array.isArray(t.extensions))return{info:Gn};const n=t.extensions.find((t=>t?.name===e));return{extension:n,info:n?void 0:Gn}}function Us({tournamentRecord:t,name:e}){return gs({element:t,name:e})}function ys({event:t,name:e}){return t?gs({element:t,name:e}):Oi({result:{error:At},stack:Is})}function Ss({drawDefinition:t,name:e}){return t?gs({element:t,name:e}):Oi({result:{error:Y},stack:Is})}function vs({tournamentRecord:t,categoryName:e,categoryType:n,event:r}){e=e??r?.category?.categoryName??r?.category?.ageCategoryCode,n=n??r?.category?.categoryType??r?.category?.subType;const{policy:i}=ns({policyType:ro,tournamentRecord:t,event:r}),a=t?Us({name:Oo,tournamentRecord:t}).extension:void 0,o=a?.value,s=r&&ys({name:Oo,event:r}).extension,c=s?.value;return{scheduleTiming:{tournamentScheduling:o,eventScheduling:c,categoryName:e,categoryType:n,policy:i}}}const ws="DOUBLES_SINGLES",Ts="SINGLES_DOUBLES",Ps="total",Ds="participantConflict",Ns="matchUpConflict",Rs="ISSUE_IDS",bs="CONFLICT",Ms="WARNING",As="ERROR",Es="ISSUE",Cs="STATE",Os={SINGLES_DOUBLES:Ts,DOUBLES_SINGLES:ws,TOTAL:Ps,CONFLICT_MATCHUP_ORDER:Ns,CONFLICT_PARTICIPANTS:Ds,SCHEDULE_ISSUE_IDS:Rs,SCHEDULE_CONFLICT:bs,SCHEDULE_WARNING:Ms,SCHEDULE_ERROR:As,SCHEDULE_ISSUE:Es,SCHEDULE_STATE:Cs};function Fs({defaultAverageMinutes:t=90,defaultRecoveryMinutes:e=0,tournamentRecord:n,matchUpFormat:r,categoryName:i,categoryType:a,eventType:o,event:s}){if(!n)return{error:$};o=o||s?.eventType||Bi.Singles;const c={averageTimes:[{minutes:{default:t}}],recoveryTimes:[{minutes:{default:e}}]},{scheduleTiming:u}=vs({tournamentRecord:n,categoryName:i,categoryType:a,event:s});return ks({eventType:o,timingDetails:{...u,matchUpFormat:r,categoryType:a,defaultTiming:c}})}function ks({timingDetails:t,eventType:e}){const n=function({matchUpFormat:t,categoryName:e,categoryType:n,defaultTiming:r,tournamentScheduling:i,eventScheduling:a,policy:o}){return os({categoryName:e,categoryType:n,timesBlockArray:[a?.matchUpAverageTimes&&is({...a,matchUpFormat:t}),i?.matchUpAverageTimes&&is({...i,matchUpFormat:t}),o?.matchUpAverageTimes&&is({...o,matchUpFormat:t}),o?.defaultTimes?.averageTimes,r?.averageTimes]})}(t),r=Object.keys(n?.minutes||{}),i=n?.minutes&&(r?.includes(e)&&n.minutes[e]||n.minutes.default),a=function({tournamentScheduling:t,eventScheduling:e,averageMinutes:n,defaultTiming:r,matchUpFormat:i,categoryName:a,categoryType:o,policy:s}){return os({categoryName:a,categoryType:o,timesBlockArray:[e?.matchUpRecoveryTimes&&as({...e,averageMinutes:n,matchUpFormat:i}),t?.matchUpRecoveryTimes&&as({...t,averageMinutes:n,matchUpFormat:i}),s?.matchUpRecoveryTimes&&as({...s,averageMinutes:n,matchUpFormat:i}),s?.defaultTimes?.recoveryTimes,r?.recoveryTimes]})}({...t,averageMinutes:i}),o=Object.keys(a?.minutes||{}),s=a?.minutes&&(o?.includes(e)&&a.minutes[e]||a.minutes.default),c=e===ba?Ts:ws;return{averageMinutes:i,recoveryMinutes:s,typeChangeRecoveryMinutes:a?.minutes&&(o?.includes(c)&&a.minutes[c]||s)}}function xs({requiredAttributes:t=["name","value"],extension:e}){if(!e||"object"!=typeof e)return!1;if("string"!=typeof e.name)return!1;const n=Object.keys(e);return t.filter((t=>n.includes(t))).length===t.length}function _s({event:t,eventId:e}){if(!t)return{error:At};const n=ys({name:To,event:t}),r=n?.extension,i=e?ri(r?.value,!1,!0):r?.value;return e&&t.drawDefinitions?.forEach((t=>{i?.flights?.forEach((e=>{e.drawId===t.drawId&&Object.assign(e,{drawDefinition:t})}))})),{flightProfile:i}}function Ls({tournamentRecord:t,eventId:e,drawId:n}){const r="findEvent";if(!t)return Oi({result:{error:$},stack:r});const i=t?.events??[];if(n){let t;const e=i.find((e=>{const r=(e?.drawDefinitions??[]).find((t=>t.drawId===n));if(r)t=r;else{const{flightProfile:t}=_s({event:e}),r=t?.flights?.find((t=>t.drawId===n));if(r)return{drawId:n,entries:r.drawEntries,drawName:r.drawName}}return r}));if(e)return{event:e,drawDefinition:t}}if(e){const t=i.find((t=>t.eventId===e));return t?{event:t,drawDefinition:void 0}:{event:void 0,drawDefinition:void 0,...Oi({result:{error:Et},stack:r})}}return{event:void 0,drawDefinition:void 0,...Oi({result:{error:J},context:{drawId:n,eventId:e},stack:r})}}function Bs(t){if("object"!=typeof t)return{error:me};const e="addExtension";if(!t?.element)return Oi({result:{error:me},stack:e});if("object"!=typeof t.element)return Oi({result:{error:xn},stack:e});if(!xs({extension:t.extension}))return Oi({result:{error:xn,info:"invalid extension"},stack:e});t.element.extensions||(t.element.extensions=[]);if(t?.creationTime??!0){const e=(new Date).toISOString();Object.assign(t.extension,{createdAt:e})}const n=t.element.extensions.find((({name:e})=>e===t.extension.name));return n?n.value=t.extension.value:t.extension.value&&t.element.extensions.push(t.extension),{...L}}const Vs="element required",js="missing name";function Gs(t){return t&&"object"==typeof t?t?.element?"object"!=typeof t?.element?{error:xn}:t?.name?t?.element.extensions?(t.element.extensions=t.element.extensions.filter((e=>e?.name!==t.name)),{...L}):{...L,info:Gn}:{error:me,info:js}:{error:me,info:Vs}:{error:me}}function qs(t){return t&&"object"==typeof t?t.tournamentRecord?Bs({creationTime:t.creationTime,element:t.tournamentRecord,extension:t.extension}):{error:$}:{error:me}}function $s(t){return t&&"object"==typeof t?t.drawDefinition?Bs({creationTime:t.creationTime,element:t.drawDefinition,extension:t.extension}):{error:J}:{error:me}}function Ws(t){return t&&"object"==typeof t?t.event?Bs({creationTime:t.creationTime,extension:t.extension,element:t.event}):{error:At}:{error:me}}function Hs(t){return t&&"object"==typeof t?t.tournamentRecord?Gs({element:t.tournamentRecord,name:t.name}):{error:$}:{error:me}}function zs(t){return t&&"object"==typeof t?t?.event?Gs({element:t.event,name:t.name}):{error:Et}:{error:me}}function Ys({tournamentRecords:t,extension:e}){if(!xs({extension:e}))return{error:xn};for(const n of Object.values(t)){const t=qs({tournamentRecord:n,extension:e});if(t.error)return Oi({result:t,stack:"addExtension"})}return{...L}}function Ks({tournamentRecords:t,name:e}){if(!e)return{error:me,info:js};let n;return Object.keys(t).find((r=>{const i=t[r],{extension:a}=Us({tournamentRecord:i,name:e});return n=a,!!a}))?{extension:n}:{error:Gn}}function Js({tournamentRecords:t,name:e}){if(!e)return{error:me,info:js};let n=0;for(const r of Object.keys(t)){const i=Hs({tournamentRecord:t[r],name:e});if(i.error)return Oi({result:i,stack:"removeExtension"});i.info!==Gn&&n++}return{...L,removed:n}}function Qs({tournamentRecords:t}){if("object"!=typeof t||!Object.keys(t).length)return{error:q};return{linkedTournamentIds:Object.assign({},...Object.keys(t).map((e=>{const n=t[e],r=n?.tournamentId,{extension:i}=Us({tournamentRecord:n,name:No});return{[e]:(i?.value?.tournamentIds||[]).filter((t=>t!==r))}})))}}function Xs(t){return{tournamentIds:Object.keys(t).filter(Boolean)}}function Zs({extension:t,dates:e=[]}){if(!t)return!1;if("boolean"==typeof t.value&&t.value)return!0;if("object"==typeof t.value&&Array.isArray(t.value.dates)){if(!e.length)return!0;return!!e.filter((e=>t.value.dates.includes(e))).length}}function tc({element:t,name:e}){const n="findExtension";if(!t||!e)return Oi({result:{error:me},stack:n});if(!Array.isArray(t.extensions))return Oi({result:{error:Gn},stack:n});const r=t.extensions.find((t=>t?.name===e));return r?{extension:r}:Oi({result:{error:Gn},stack:n})}function ec({convertExtensions:t,ignoreDisabled:e,venue:n,court:r}){const i={...ri(r,t,!0),venueId:n.venueId},{extension:a}=tc({name:Uo,element:r});if(e&&a){const t="object"==typeof a.value&&a.value.dates||[],e=!0===a.value?[]:i.dateAvailability.map((e=>{const n=e.date;if(n&&!t.includes(n))return e})).filter(Boolean);i.dateAvailability=e}return{inContextCourt:i}}const nc="addDrawDefinition",rc="addMatchUps",ic="addParticipants",ac="addScaleItems",oc="addVenue",sc="audit",cc="deleteParticipants",uc="deleteVenue",dc="deletedDrawIds",pc="deletedMatchUpIds",lc="modifyDrawDefinition",mc="modifyDrawEntries",fc="modifyEventEntries",hc="modifyMatchUp",Ic="modifyParticipants",gc="modifyPositionAssignments",Uc="modifySeedAssignments",yc="modifyTournamentDetail",Sc="modifyVenue",vc="mutations",wc="publishEvent",Tc="publishEventSeeding",Pc="publishOrderOfPlay",Dc="unPublishEvent",Nc="unPublishEventSeeding",Rc="unPublishOrderOfPlay",bc="updateInContextMatchUp",Mc={ADD_DRAW_DEFINITION:nc,ADD_MATCHUPS:rc,ADD_PARTICIPANTS:ic,ADD_SCALE_ITEMS:ac,ADD_VENUE:oc,AUDIT:sc,DELETE_PARTICIPANTS:cc,DELETE_VENUE:uc,DELETED_DRAW_IDS:dc,DELETED_MATCHUP_IDS:pc,MODIFY_DRAW_DEFINITION:lc,MODIFY_DRAW_ENTRIES:mc,MODIFY_EVENT_ENTRIES:fc,MODIFY_MATCHUP:hc,MODIFY_PARTICIPANTS:Ic,MODIFY_POSITION_ASSIGNMENTS:gc,MODIFY_SEED_ASSIGNMENTS:Uc,MODIFY_TOURNAMENT_DETAIL:yc,MODIFY_VENUE:Sc,MUTATIONS:vc,PUBLISH_EVENT_SEEDING:Tc,PUBLISH_EVENT:wc,PUBLISH_ORDER_OF_PLAY:Pc,UNPUBLISH_EVENT_SEEDING:Nc,UNPUBLISH_EVENT:Dc,UNPUBLISH_ORDER_OF_PLAY:Rc,UPDATE_INCONTEXT_MATCHUP:bc};function Ac({tournamentRecord:t,disableNotice:e,context:n,venue:r}){if(!t)return{error:$};if(!r)return{error:me,info:"missing venue"};t.venues||(t.venues=[]),r.venueId||(r.venueId=hi());if(t.venues.reduce(((t,e)=>t||e.venueId===r.venueId),void 0))return{error:ln};if(n){Bs({element:r,extension:{value:n,name:Io}})}return t.venues.push(r),e||dr({payload:{venue:r,tournamentId:t.tournamentId},topic:oc}),{...L,venue:ri(r)}}function Ec({convertExtensions:t,tournamentRecord:e,ignoreDisabled:n,dates:r}){if(!e)return{error:$};const i=ri(e.venues??[],t).filter((t=>{if(!n)return t;const{extension:e}=tc({name:Uo,element:t});return!e?.value&&t})).filter(Boolean),a=i.reduce(((e,i)=>{const a=(i?.courts||[]).filter((t=>{if(!n&&!r?.length)return t;const{extension:e}=tc({name:Uo,element:t});return Zs({extension:e,dates:r})})).filter(Boolean).map((e=>{const{inContextCourt:r}=ec({convertExtensions:t,ignoreDisabled:n,venue:i,court:e});return r}));return a.length?e.concat(a):e}),[]);return{venues:i,courts:a}}function Cc({tournamentRecords:t,tournamentRecord:e,venueId:n}){if(!e)return{error:$};if(!n)return{error:fn};const r=(e.venues??[]).reduce(((t,e)=>e.venueId===n?e:t),void 0);if(!r&&t){const i=(Qs({tournamentRecords:t}).linkedTournamentIds||[])[e.tournamentId];for(const a of i){const i=Cc({tournamentRecord:t[a],venueId:n});if(i.success&&i.venue)return Ac({tournamentRecord:e,venue:i.venue}),{...L,venue:r}}}return r?{...L,venue:r}:{error:mn}}function Oc({tournamentRecords:t,tournamentRecord:e,courtId:n}){if(!e)return{error:$};if(!n)return{error:le};let r,i;if((e.venues??[]).forEach((t=>{(t.courts??[]).forEach((e=>{e.courtId===n&&(r=e,i=t)}))})),r)return{...L,court:r,venue:i};if(t){const a=(Qs({tournamentRecords:t}).linkedTournamentIds??[])[e.tournamentId];for(const o of a){const a=Oc({tournamentRecord:t[o],courtId:n});if(a.success)return a.venue&&Ac({tournamentRecord:e,venue:a.venue}),{...L,court:r,venue:i}}}return Oi({result:{error:dn},stack:"findCourt"})}function Fc({tournamentRecord:t,internalUse:e,courtId:n}){if(!t)return{error:$};if(!n)return{error:le};const r=Oc({tournamentRecord:t,courtId:n});if(r.error)return r;const i=r.court&&(({altitude:t,courtId:e,courtName:n,courtDimensions:r,latitude:i,longitude:a,surfaceCategory:o,surfaceType:s,surfacedDate:c,pace:u,notes:d})=>({altitude:t,courtId:e,courtName:n,courtDimensions:r,latitude:i,longitude:a,surfaceCategory:o,surfaceType:s,surfacedDate:c,pace:u,notes:d}))(r.court);return{...L,courtInfo:ri(i,!1,e)}}function kc({tournamentRecord:t,venueId:e}){if(!t)return{error:$};if(!e)return{error:fn};const n=Cc({tournamentRecord:t,venueId:e});if(n.error)return n;const r=(n.venue?.courts??[]).map((e=>(({courtInfo:t})=>({...t}))(Fc({courtId:e.courtId,internalUse:!0,tournamentRecord:t})))),i=n.venue&&(({venueId:t,venueName:e,venueAbbreviation:n})=>({venueAbbreviation:n,venueName:e,venueId:t}))(n.venue),a=i&&{...i,courtsInfo:r};return{...L,venueData:ri(a,!1,!0)}}const xc="CHECK_IN",_c="CHECK_OUT",Lc="SCHEDULE.ASSIGNMENT.VENUE",Bc="SCHEDULE.ALLOCATION.COURTS",Vc="SCHEDULE.ASSIGNMENT.COURT",jc="SCHEDULE.COURT.ORDER",Gc="SCHEDULE.DATE",qc="SCHEDULE.ASSIGN.OFFICIAL",$c="SCHEDULE.TIME.SCHEDULED",Wc="SCHEDULE.TIME.START",Hc="SCHEDULE.TIME.STOP",zc="SCHEDULE.TIME.RESUME",Yc="SCHEDULE.TIME.END",Kc="SCHEDULE.TIME.MODIFIERS",Jc="TO_BE_ANNOUNCED",Qc="NEXT_AVAILABLE",Xc="FOLLOWED_BY",Zc="AFTER_REST",tu="RAIN_DELAY",eu=[Jc,Qc,Xc,Zc,tu],nu="SCALE",ru="RATING",iu="RANKING",au="SEEDING",ou="PUBLISH",su="PUBLIC",cu="STATUS",uu={MUTUALLY_EXCLUSIVE_TIME_MODIFIERS:eu,AFTER_REST:Zc,ALLOCATE_COURTS:Bc,ASSIGN_COURT:Vc,ASSIGN_OFFICIAL:qc,ASSIGN_VENUE:Lc,CHECK_IN:xc,CHECK_OUT:_c,COMPLETED_DATE:"COMPLETED.DATE",COURT_ORDER:jc,ELIGIBILITY:"ELIGIBILITY",END_TIME:Yc,FOLLOWED_BY:Xc,MEDICAL:"MEDICAL",MODIFICATION:"MODIFICATION",NEXT_AVAILABLE:Qc,NOT_BEFORE:"NOT_BEFORE",OTHER:"other",PENALTY:"PENALTY",PUBLIC:su,PUBLISH:ou,RANKING:iu,RATING:ru,RAIN_DELAY:tu,REGISTRATION:"REGISTRATION",RESUME_TIME:zc,RETRIEVAL:"RETRIEVAL",SCALE:nu,SCHEDULE:"SCHEDULE",SCHEDULED_DATE:Gc,SCHEDULED_TIME:$c,SEEDING:au,START_TIME:Wc,STATUS:cu,STOP_TIME:Hc,SUSPENSION:"SUSPENSION",TIME_MODIFIERS:Kc,TO_BE_ANNOUNCED:Jc};function du(t){return t.createdAt?new Date(t.createdAt).getTime():0}function pu({visibilityThreshold:t,timeItems:e,itemType:n}){const r=e.filter((e=>e&&e.itemType===n&&(!t||du(e)<new Date(t).getTime()))).sort(((t,e)=>du(t)-du(e))).pop(),i=r&&du(r);return{itemValue:r?.itemValue,timeStamp:i}}function lu({visibilityThreshold:t,timeStamp:e,schedule:n,matchUp:r}){const{itemValue:i,timeStamp:a}=pu({timeItems:r?.timeItems||[],itemType:$c,visibilityThreshold:t});return!n||a&&e&&new Date(a).getTime()>new Date(e).getTime()?{scheduledTime:i}:n}function mu({visibilityThreshold:t,timeStamp:e,schedule:n,matchUp:r}){const{itemValue:i,timeStamp:a}=pu({timeItems:r?.timeItems||[],itemType:Gc,visibilityThreshold:t});return!n||a&&e&&new Date(a).getTime()>new Date(e).getTime()?{scheduledDate:i}:n}function fu({visibilityThreshold:t,timeStamp:e,schedule:n,matchUp:r}){const{itemValue:i,timeStamp:a}=pu({timeItems:r?.timeItems||[],itemType:Bc,visibilityThreshold:t});return!n||a&&e&&new Date(a).getTime()>new Date(e).getTime()?{allocatedCourts:ri(i,!1,!0)}:n}function hu({visibilityThreshold:t,timeStamp:e,schedule:n,matchUp:r}){const{itemValue:i,timeStamp:a}=pu({timeItems:r?.timeItems||[],itemType:Vc,visibilityThreshold:t});return!n||a&&e&&new Date(a).getTime()>new Date(e).getTime()?{courtId:i}:n}function Iu({visibilityThreshold:t,timeStamp:e,schedule:n,matchUp:r}){const{itemValue:i,timeStamp:a}=pu({timeItems:r?.timeItems||[],itemType:Lc,visibilityThreshold:t});return!n||a&&e&&new Date(a).getTime()>new Date(e).getTime()?{venueId:i}:n}function gu({visibilityThreshold:t,timeStamp:e,schedule:n,matchUp:r}){const{itemValue:i,timeStamp:a}=pu({timeItems:r?.timeItems||[],itemType:Kc,visibilityThreshold:t});return!n||a&&e&&new Date(a).getTime()>new Date(e).getTime()?{timeModifiers:i}:n}function Uu(t){if(Nr.test(t)){const e=Or();return new Date(`${e}T${t}`)}return new Date(t)}function yu({matchUp:t}){if(!t)return{error:te};if(!t.timeItems)return{error:Tn};const e=t.timeItems.filter((t=>[Wc,Hc,zc,Yc].includes(t?.itemType))).sort(((t,e)=>Uu(t.itemValue).getTime()-Uu(e.itemValue).getTime())),n=e.reduce(((t,e)=>{let n;const r=e?.itemType?.split("."),i=`SCHEDULE.TIME.${e?.itemType?.startsWith("SCHEDULE.TIME")&&r[2]}`;switch(i){case Wc:n=0;break;case Yc:if(t.lastValue&&[Wc,zc].includes(t.lastType)){const r=Uu(e.itemValue).getTime()-Uu(t.lastValue).getTime();n=t.milliseconds+r}else n=t.milliseconds;break;case Hc:if([Wc,"SCHECULE.TIME.RESUME"].includes(t.lastType)){const r=Uu(e.itemValue).getTime()-Uu(t.lastValue).getTime();n=t.milliseconds+r}else n=t.milliseconds;break;default:n=t.milliseconds}return{milliseconds:n,lastType:i,lastValue:e.itemValue}}),{milliseconds:0,lastType:void 0,lastValue:void 0});if([Wc,zc].includes(n.lastType)){const t=(new Date).getTime()-Uu(n.lastValue).getTime();n.milliseconds+=t}return{milliseconds:n.milliseconds,time:Su(n.milliseconds),relevantTimeItems:e}}function Su(t){const e=(t,e=2)=>("00"+t).slice(-e);return e(t/36e5|0)+":"+e(t%36e5/6e4|0)+":"+e(t%6e4/1e3|0)}const vu="SINGLES",wu="SINGLES",Tu="DOUBLES",Pu="DOUBLES",Du="TEAM",Nu="TEAM",Ru={AGE:"AGE",BOTH:"BOTH",DOUBLES:Tu,DOUBLES_EVENT:Pu,RATING:"RATING",SINGLES:vu,SINGLES_EVENT:wu,TEAM_EVENT:Nu,TEAM:Du};function bu({scheduleVisibilityFilters:t,afterRecoveryTimes:e,tournamentRecord:n,scheduleTiming:r,matchUpFormat:i,matchUpType:a,matchUp:o,event:s}){if(!o)return{error:te};if(e&&!o.matchUpType&&!a&&(s||n)&&o.drawId){let t=s?.drawDefinitions?.find((t=>t.drawId===o.drawId));!t&&n&&({drawDefinition:t,event:s}=Ls({tournamentRecord:n,drawId:o.drawId}));const e=o.structureId&&t?.structures?.find((({structureId:t})=>t===o.structureId));a=e?.matchUpType||t?.matchUpType||s?.eventType!==Du&&s?.eventType}const{milliseconds:c,time:u}=yu({matchUp:o}),{startTime:d}=function({matchUp:t}){const e=t=>t.createdAt?new Date(t.createdAt).getTime():0,n=(t?.timeItems||[]).reduce(((t,n)=>{const r=n.itemType===Wc&&n;return r&&(!t||e(r)<e(t))?r:t}),void 0),r=n?.itemValue;return{startTime:r}}({matchUp:o}),{endTime:p}=function({matchUp:t}){const e=t=>t.createdAt?new Date(t.createdAt).getTime():0,n=(t?.timeItems||[]).reduce(((t,n)=>{const r=n.itemType===Yc&&n;return r&&(!t||e(r)>e(t))?r:t}),void 0),r=n?.itemValue;return{endTime:r}}({matchUp:o});let l;const{visibilityThreshold:m,eventIds:f,drawIds:h}=t??{};if(f&&!f.includes(o.eventId)||h&&!h.includes(o.drawId))l=di({time:u,startTime:d,endTime:p,milliseconds:c});else{const t={matchUp:o,visibilityThreshold:m},{allocatedCourts:s}=fu(t),{scheduledTime:f}=lu(t);let{scheduledDate:h}=mu(t);const{venueId:I}=Iu(t),{courtId:g}=hu(t),{courtOrder:U}=function({visibilityThreshold:t,timeStamp:e,schedule:n,matchUp:r}){const{itemValue:i,timeStamp:a}=pu({timeItems:r?.timeItems||[],itemType:jc,visibilityThreshold:t});return!n||a&&e&&new Date(a).getTime()>new Date(e).getTime()?{courtOrder:i}:n}(t),{timeModifiers:y}=gu(t);let S,v,w,T,P;const D=o.matchUpType??a;if(r&&f&&e&&D){const t={matchUpFormat:o.matchUpFormat??i,...r};({averageMinutes:v=0,recoveryMinutes:w=0,typeChangeRecoveryMinutes:T=0}=ks({timingDetails:t,eventType:D})),(v||w)&&(S=p?Xr(qr(p),w):Xr(f,v+w)),T&&(P=p?Xr(qr(p),T):Xr(f,v+T))}!h&&f&&(h=$r(f));const N=Mr({scheduledDate:h,scheduledTime:f}),R={},b=(n&&I&&kc({tournamentRecord:n,venueId:I}))?.venueData||{};I&&(R[I]=b);const{venueName:M,venueAbbreviation:A,courtsInfo:E}=b,C=g&&E?.find((t=>t.courtId===g)),O=C?.courtName;for(const e of s||[]){if(!n)break;e.venueId&&!R[e.venueid]&&(R[e.venueId]=kc({venueId:e.venueId,tournamentRecord:n})?.venueData);const t=R[e.venueId];e.venueName=t?.venueName;const r=t?.courtsInfo?.find((t=>t.courtId===e.courtId));e.courtName=r?.courtName}l=di({typeChangeTimeAfterRecovery:P,timeAfterRecovery:S,scheduledDate:h,scheduledTime:f,isoDateString:N,allocatedCourts:s,timeModifiers:y,venueAbbreviation:A,venueName:M,venueId:I,courtOrder:U,courtName:O,courtId:g,typeChangeRecoveryMinutes:T,recoveryMinutes:w,averageMinutes:v,milliseconds:c,startTime:d,endTime:p,time:u})}const I=o.matchUpStatus&&fa.includes(o.matchUpStatus),{scheduledDate:g}=mu({matchUp:o}),{scheduledTime:U}=lu({matchUp:o});return{schedule:l,endDate:I&&($r(p)||$r(g)||$r(U))||void 0}}function Mu({collectionPosition:t,collectionId:e,lineUp:n}){let r=[];const i=[];if(n){const a=t=>void 0===t?-1:t,o=n.map((n=>{const{collectionAssignments:r,participantId:i}=n,a=r?.find((n=>n.collectionPosition===t&&n.collectionId===e));return a&&{participantId:i,...a}})).filter(Boolean).sort(((t,e)=>a(t.substitutionOrder)-a(e.substitutionOrder)));for(const t of o){const{participantId:e,previousParticipantId:n,substitutionOrder:a}=t;r.includes(e)||(n&&i.push({previousParticipantId:n,substitutionOrder:a,participantId:e}),r=r.filter((t=>t!==n)),r.push(e))}}return{assignedParticipantIds:r,substitutions:i}}const Au="SIGN_IN_STATUS",Eu=qi.Individual,Cu=qi.Group,Ou=qi.Pair,Fu=qi.Team,ku=qi.Team,xu="SIGNED_IN",_u="SIGNED_OUT",Lu={TEAM_PARTICIPANT:ku,INDIVIDUAL:Eu,GROUP:Cu,TEAM:Fu,PAIR:Ou},Bu={INDIVIDUAL:Eu,GROUP:Cu,PAIR:Ou,TEAM:Fu,SIGN_IN_STATUS:Au,SIGNED_OUT:_u,SIGNED_IN:xu};function Vu({tournamentParticipants:t,tournamentRecord:e,participantIds:n}){const r="getPairedParticipant";if(!t&&!e)return{error:$};if(!Array.isArray(n)||n.length>2)return{error:Ce};if(!n.length)return Oi({result:{error:Ge},stack:r});const i=(t=t||e?.participants||[]).filter((t=>t.participantType===Ou&&O(n,t.individualParticipantIds).length===n.length&&t.individualParticipantIds.length===n.length)),a=i[0];if(!a)return Oi({result:{error:Be},stack:r});const o=ri(i.slice(1),!1,!0);return{participant:ri(a),duplicatedPairParticipants:o,...L}}function ju({drawDefinition:t,participantId:e}){if("object"!=typeof t)return{error:Y};if("string"!=typeof e)return{error:Le};const{extension:n}=gs({element:t,name:Do});return{lineUp:(n?.value||{})[e]}}function Gu({matchUps:t=[],interpolate:e}){if(!Sa(t))return{roundMatchUps:[],error:xn};const n=t.reduce(((t,e)=>{const n="string"==typeof e.roundNumber?m(e.roundNumber):e.roundNumber;return!e.roundNumber||t.includes(n)?t:t.concat(n)}),[]).sort(l).map((e=>{const n=t.filter((t=>t.roundNumber===e)),r=n.find((({matchUpType:t})=>t===Ca))?n.filter((({matchUpType:t})=>t===Ca)):n;return{[e]:(i=r,i.sort(((t,e)=>l(t.roundPosition,e.roundPosition))))};var i})),r=t.reduce(((t,e)=>{const n="string"==typeof e.roundNumber?m(e.roundNumber):e.roundNumber;return t[n]||(t[n]=di({abbreviatedRoundName:e.abbreviatedRoundName,finishingRound:e.finishingRound,roundName:e.roundName})),t}),{}),i=Object.assign({},...n);if(e){const t=Math.max(...Object.keys(i).map((t=>m(t))).filter((t=>!isNaN(t)))),e=i[t]?.length;if(e>1&&f(e)){const n=t+1;E(n,n+e/2).forEach(((t,n)=>{i[t]=E(0,e/(2+2*n)).map((()=>({})))}))}}let a=0;const o=Object.assign({},...Object.keys(i).map((t=>{const e=i[t]?.length,n=i[t]?.filter((t=>!fa.includes(t.matchUpStatus)&&!t.score?.scoreStringSide1))?.length,r=e&&e===n;return a=Math.max(a,e),{[t]:{matchUpsCount:e,inactiveCount:n,inactiveRound:r}}})));let s=0,c=0;const u=Object.keys(i).map((t=>m(t))).filter((t=>!isNaN(t)));u.forEach((t=>{const e=i[t].sort(((t,e)=>t.roundPosition-e.roundPosition)),n=e.map((t=>t?.drawPositions||[])).flat();if(o[t].roundNumber=t,o[t].roundFactor=o[t].matchUpsCount?a/o[t].matchUpsCount:1,o[t].finishingRound=r[t]?.finishingRound,o[t].roundName=r[t]?.roundName,o[t].abbreviatedRoundName=r[t]?.abbreviatedRoundName,o[t].finishingPositionRange=i[t]?.[0]?.finishingPositionRange,1!==t&&o[t-1]){const n=o[t-1],r=n.drawPositions,i=n.matchUpsCount/o[t].matchUpsCount,a=x(r,i),s=e.map((e=>{const{roundPosition:n}=e,i=[...e.drawPositions||[],void 0,void 0].slice(0,2);if(!n)return i;const o=i?.filter(Boolean)||[];if(!o?.length)return[void 0,void 0];if(t<3&&2===o?.length)return i?.slice().sort(l);const s=O(r,o).length!==o?.length;if(o?.length&&s)return 1===o?.length?[o[0],void 0]:i?.slice().sort(l);const c=2*(n-1);return a.slice(c,c+2).map((t=>o?.find((e=>t.includes(e)))))}));o[t].drawPositions=s?.flat(),o[t].pairedDrawPositions=s}else{const e=n.sort(l),r=x(e,2);o[t].drawPositions=e,o[t].pairedDrawPositions=r}o[t+1]&&o[t+1].matchUpsCount===o[t].matchUpsCount&&(o[t+1].feedRound=!0,o[t+1].feedRoundIndex=c,o[t].preFeedRound=!0,c+=1),o[t]&&!o[t].feedRound&&(o[t].roundIndex=s,s+=1)}));const d=!!Object.values(o).find((({matchUpsCount:t})=>!f(t)));return{hasNoRoundPositions:t.some((t=>!t.roundPosition)),roundsNotPowerOf2:d,maxMatchUpsCount:a,roundMatchUps:i,roundNumbers:u,roundProfile:o}}function qu(t){const e=t?.matchUp;let n=e?.matchUpType;if(!n&&e.sides?.length){const t=e.sides.find((({participant:t})=>t)),r=t?.participant,i=r?.participantType;n=i===Eu&&ba||i===Ou&&Aa||i===Fu&&Fu||void 0}return{matchUpType:n}}function $u({drawDefinition:t,attributes:e}){let{extension:n}=Ss({name:wo,drawDefinition:t});const r=n?.value||{};return e.forEach((t=>{Object.keys(t).forEach((e=>{r[e]?Object.assign(r[e],t[e]):r[e]=t[e]}))})),n={name:wo,value:r},$s({drawDefinition:t,extension:n}),{entryProfile:r}}function Wu({drawDefinition:t}){const{extension:e}=Ss({name:wo,drawDefinition:t});return{entryProfile:e?.value||{}}}const Hu="MAIN",zu="QUALIFYING",Yu="CONSOLATION",Ku="VOLUNTARY_CONSOLATION",Ju="PLAY_OFF",Qu=[Hu,zu,Yu,Ju,Ku],Xu={[zu]:1,[Hu]:2,[Ju]:3,[Yu]:3,[Ku]:4},Zu="finishingPositions",td="aggregateEventStructures",ed={[Hu]:1,[Ju]:2,[Yu]:3,[zu]:4,[Ku]:5},nd={[Ju]:1,[Hu]:2,[Yu]:3,[zu]:4,[Ku]:5},rd="CLUSTER",id="WATERFALL",ad="ITEM",od="CONTAINER",sd="DRAW",cd="RANDOM",ud="TOP_DOWN",dd="BOTTOM_UP",pd="POSITION",ld="WINNER",md="LOSER",fd="FIRST_MATCHUP",hd="AD_HOC",Id="FEED_IN",gd="COMPASS",Ud="OLYMPIC",yd="SINGLE_ELIMINATION",Sd="DOUBLE_ELIMINATION",vd="FIRST_MATCH_LOSER_CONSOLATION",wd="FIRST_ROUND_LOSER_CONSOLATION",Td="LUCKY_DRAW",Pd="CURTIS_CONSOLATION",Dd="CURTIS_CONSOLATION",Nd="FEED_IN_CHAMPIONSHIP_TO_SF",Rd="FEED_IN_CHAMPIONSHIP_TO_SF",bd="FEED_IN_CHAMPIONSHIP_TO_QF",Md="FEED_IN_CHAMPIONSHIP_TO_QF",Ad="FEED_IN_CHAMPIONSHIP_TO_R16",Ed="FEED_IN_CHAMPIONSHIP_TO_R16",Cd="MODIFIED_FEED_IN_CHAMPIONSHIP",Od="MODIFIED_FEED_IN_CHAMPIONSHIP",Fd="FEED_IN_CHAMPIONSHIP",kd="ROUND_ROBIN",xd="ROUND_ROBIN_WITH_PLAYOFF",_d="DECIDER",Ld="BACKDRAW",Bd={0:{name:"East",abbreviation:"E"},"0-1":{name:"West",abbreviation:"W"},"0-2":{name:"North",abbreviation:"N"},"0-3":{name:"Northeast",abbreviation:"NE"},"0-1-1":{name:"South",abbreviation:"S"},"0-1-2":{name:"Southwest",abbreviation:"SW"},"0-2-1":{name:"Northwest",abbreviation:"NW"},"0-1-1-1":{name:"Southeast",abbreviation:"SE"}},Vd={0:{name:"East",abbreviation:"E"},"0-1":{name:"West",abbreviation:"W"},"0-2":{name:"North",abbreviation:"N"},"0-1-1":{name:"South",abbreviation:"S"}},jd="WIN_RATIO",Gd="ROUND_OUTCOME",qd=[gd,Pd,Md,Ed,Rd,Fd,bd,Ad,Nd,vd,wd,Td,Od,Ud,Ju,xd],$d={MAIN:Hu,QUALIFYING:zu,CONSOLATION:Yu,ITEM:ad,CONTAINER:od,FIRST_MATCHUP:fd,WINNER:ld,LOSER:md,AD_HOC:hd,FEED_IN:Id,COMPASS:gd,PLAY_OFF:Ju,OLYMPIC:Ud,KNOCKOUT:"SINGLE_ELIMINATION",SINGLE_ELIMINATION:yd,DOUBLE_ELIMINATION:Sd,CURTIS:Pd,FICSF:Nd,FICQF:bd,FICR16:Ad,MFIC:Cd,VOLUNTARY_CONSOLATION:Ku,FIRST_MATCH_LOSER_CONSOLATION:vd,FIRST_ROUND_LOSER_CONSOLATION:wd,MODIFIED_FEED_IN_CHAMPIONSHIP:Od,FEED_IN_CHAMPIONSHIP_TO_R16:Ed,FEED_IN_CHAMPIONSHIP_TO_QF:Md,FEED_IN_CHAMPIONSHIP_TO_SF:Rd,FEED_IN_CHAMPIONSHIP:Fd,LUCKY_DRAW:Td,ROUND_ROBIN_WITH_PLAYOFF:xd,ROUND_ROBIN:kd,DECIDER:_d,BACKDRAW:Ld,COMPASS_ATTRIBUTES:Bd,OLYMPIC_ATTRIBUTES:Vd,DRAW:sd,RANDOM:cd,TOP_DOWN:ud,BOTTOM_UP:dd,WATERFALL:id,WIN_RATIO:jd,ROUND_OUTCOME:Gd,MULTI_STRUCTURE_DRAWS:qd,generatedDrawTypes:[hd,gd,Pd,Sd,Md,Ed,Rd,Fd,Id,vd,wd,Td,Od,Ud,Ju,kd,xd,yd],stageOrder:Xu,finishOrder:ed,AGGREGATE_EVENT_STRUCTURES:td,FINISHING_POSITIONS:Zu};function Wd(t,e,n){const r=t=>gs({element:t,name:Eo})?.extension?.value,i=n?.deprioritizeCompleted,a=n?.mode===td&&nd,o=n?.mode===Zu&&ed,s=o||a||Xu,c=t=>(t=>t?.stage===Hu&&1===t?.stageSequence)(t)?-1:s[t?.stage],u=t=>t?.matchUps.every((({matchUpStatus:t})=>fa.includes(t)?1:-1));return i&&u(t)-u(e)||a&&c(t)-c(e)||(t?.stage&&s[t.stage]||0)-(e?.stage&&s[e.stage]||0)||(r(t)||0)-(r(e)||0)||!o&&!a&&(e?.positionAssignments?.length??1/0)-(t?.positionAssignments?.length??1/0)||(t?.stageSequence??0)-(e?.stageSequence??0)||(Hd(t)||0)-(Hd(e)||0)}function Hd(t){return(t?.matchUps||[]).reduce(((t,e)=>{const n=(e.finishingPositionRange?.winner||[]).reduce(((t,e)=>t+e),0);return!t||n<t?n:t}),void 0)}function zd({drawDefinition:t,structureId:e}){if(!t)return{error:Y};if(!e)return{error:Pt};const{structures:n}=Yd({drawDefinition:t}),r=n?.map((t=>t.structures?[...t.structures].concat(t):t)).flat(),i=r?.find((t=>t.structureId===e));if(!i)return{error:Dt};return{structure:i,containingStructure:i.structureType===ad?r?.find((t=>t.structures?.some((t=>t.structureId===e)))):void 0}}function Yd({withStageGrouping:t,drawDefinition:e,stageSequences:n,stageSequence:r,roundTarget:i,sortConfig:a,stages:o,stage:s}){const c=!e&&Y||!e?.structures&&Nt||void 0;if(c)return{error:c,structures:[],stageStructures:{}};const u=e?.structures?.filter((function(t){return!s&&!Array.isArray(o)||s&&t.stage===s||Array.isArray(o)&&o.includes(t.stage)})).filter((function(t){return!r&&!Array.isArray(n)||r&&t.stageSequence===r||Array.isArray(n)&&n.includes(t.stageSequence)})).filter((t=>{const e=gs({element:t,name:Eo})?.extension?.value;return!i||i===e})).sort(((t,e)=>Wd(t,e,a)))??[],d=t?Object.assign({},...Qu.map((t=>{const e=u?.filter((e=>e.stage===t));return e?.length&&{[t]:e}})).filter(Boolean)):{};return{structures:u,stageStructures:d}}const Kd=xi.Alternate,Jd=xi.Confirmed,Qd=xi.DirectAcceptance,Xd=xi.FeedIn,Zd=xi.JuniorExempt,tp=xi.LuckyLoser,ep=xi.OrganiserAcceptance,np=xi.Qualifier,rp=xi.Registered,ip=xi.SpecialExempt,ap=xi.Ungrouped,op=xi.Unpaired,sp=xi.Wildcard,cp=xi.Withdrawn,up=[Jd,Qd,Zd,ep,ip],dp=[Xd,tp,np],pp=[Jd,Qd,Xd,Zd,ep,ip,sp],lp=[Jd,Qd,Xd,Zd,tp,np,ep,ip,sp],mp=[Kd,Jd,Qd,Xd,Zd,tp,ep,np,rp,ip,ap,op,sp,cp],fp=lp,hp={ALTERNATE:Kd,CONFIRMED:Jd,DIRECT_ACCEPTANCE:Qd,DIRECT_ENTRY_STATUSES:pp,DRAW_SPECIFIC_STATUSES:dp,EQUIVALENT_ACCEPTANCE_STATUSES:up,FEED_IN:Xd,JUNIOR_EXEMPT:Zd,LUCKY_LOSER:tp,ORGANISER_ACCEPTANCE:ep,QUALIFIER:np,SPECIAL_EXEMPT:ip,STRUCTURE_ENTERED_TYPES:fp,STRUCTURE_SELECTED_STATUSES:lp,UNGROUPED:ap,UNPAIRED:op,VALID_ENTERED_TYPES:mp,VALID_ENTRY_STATUSES:mp,WILDCARD:sp,WITHDRAWN:cp};function Ip({stage:t,drawDefinition:e}){const{entryProfile:n}=Wu({drawDefinition:e}),r=Object.keys(n).includes(t);if(!r&&Qu.includes(t)){return $u({drawDefinition:e,attributes:[{[t]:{drawSize:void 0,alternates:!0}}]}),!0}return r}function gp({stage:t,drawDefinition:e,entryStatus:n}){return e.entries.reduce(((e,r)=>r.entryStage===t&&r.entryStatus===n?e+1:e),0)}function Up({provisionalPositioning:t,placementGroup:e,drawDefinition:n,stageSequence:r,entryStatuses:i,structureId:a,roundTarget:o,stages:s,stage:c}){const u=n.entries?.reduce(((t,e)=>{const n=gs({name:Eo,element:e})?.extension?.value,a=c&&e.entryStage===c||s?.length&&e.entryStage&&s.includes(e.entryStage),u=!i||e.entryStatus&&i.includes(e.entryStatus),d=e.entryStageSequence??1;return a&&(!r||d===r)&&u&&(!o||!n||o===n)?t.concat(e):t}),[])??[];if(a&&c===Ju){const{playoffEntries:r,error:i}=function({provisionalPositioning:t,drawDefinition:e,structureId:n}){const r=[],i=(e.links??[]).find((t=>t.linkType===pd&&t.target.structureId===n));if(i){const{finishingPositions:n,structureId:a}=i.source,{structure:o}=zd({drawDefinition:e,structureId:a});if(o?.structureType===od){(o.structures??[]).forEach((e=>{const i=e.positionAssignments??[],{structureId:a}=e,o=a,s=Object.assign({},...i.map((t=>{const{participantId:e}=t,n=gs({element:t,name:xo}).extension?.value;return n&&e?{[e]:n}:void 0})).filter(Boolean)),c=Object.keys(s).reduce(((e,n)=>{const r=s[n],i=r.groupOrder||t&&r.provisionalOrder;return e.includes(i)||e.push(i),e}),[]),u=c.length===Object.keys(s).length,d=Object.keys(s).filter((e=>{const r=s[e],i=r.groupOrder||t&&r.provisionalOrder;return n?.includes(i)}));t&&!u||d.forEach((e=>{const i=s[e],{groupOrder:a,provisionalOrder:c,GEMscore:u}=i,d=a||t&&c,p=(n??[]).sort(l).indexOf(d)+1;r.push({entryStage:Ju,entryStatus:Xd,placementGroup:p,groupingValue:o,participantId:e,GEMscore:u})}))}))}}return{playoffEntries:r}}({provisionalPositioning:t,drawDefinition:n,structureId:a});return i&&console.log("playoff entries error"),(r?.length?r:u).filter((t=>!e||t.placementGroup===e))}return u}function yp({stage:t,drawDefinition:e}){return pp.reduce(((n,r)=>(gp({drawDefinition:e,entryStatus:r,stage:t})||0)+n),0)}function Sp({provisionalPositioning:t,drawDefinition:e,structureId:n,structure:r}){let i,a=[];if(r||({structure:r,error:i}=zd({drawDefinition:e,structureId:n})),i||!r)return{seedAssignments:[],error:Dt};n||(n=r.structureId);const{stage:o,stageSequence:s}=r,c=o===Ju&&e&&Up({provisionalPositioning:t,drawDefinition:e,stageSequence:s,structureId:n,stage:o}),u=c?c.filter((t=>1===t.placementGroup)).sort(((t,e)=>(t.GEMscore<e.GEMscore?1:t.GEMscore>e.GEMscore&&-1)||0)).map(((t,e)=>{const n=e+1;return{participantId:t.participantId,seedValue:n,seedNumber:n,seedProxy:!0}})):[];u.length?a=u:r.seedAssignments?a=r.seedAssignments:i=yt;return{seedAssignments:a,seedLimit:r.seedLimit||r?.positionAssignments?.length,stage:o,stageSequence:s,error:i}}function vp({drawDefinition:t}){if("object"!=typeof t)return{error:z};const e={},{structures:n=[],links:r=[]}=t||{},i=n.reduce(((t,e)=>{const{stage:n}=e;return t[n]?t[n].push(e):t[n]=[e],t}),{});for(const o of Object.keys(i)){const t=i[o].find((({stageSequence:t})=>1===t));if(!t)continue;const{structureId:n}=t;a({aggregator:{},targetRound:0,exitProfiles:e,exitProfile:"0",structureId:n,stage:o})}return{exitProfiles:e};function a({exitProfiles:t,exitProfile:e,structureId:i,targetRound:o,aggregator:s,stage:c}){t[i]||(t[i]=[]),"0"===e&&[Yu,Ju].includes(c)||t[i].push(e);const u=r.filter((t=>t.source.structureId===i&&t.source.roundNumber>=o));for(const r of u){const i=r.source.roundNumber,o=r.target.roundNumber,c=r.target.structureId,u=n.find((t=>t.structureId===c)).stage,d=[u,c,o,i].join("|");if(s[d])return;s[d]=!0,a({exitProfile:`${e}-${i}`,structureId:c,exitProfiles:t,targetRound:o,aggregator:s,stage:u})}}}function wp({drawDefinition:t,structure:e}){const n={},r=[];return(t?.structures??[e]).filter((t=>t&&"object"==typeof t)).forEach((t=>{if(!t)return;const{structureId:e,matchUps:i,structures:a}=t,o=Array.isArray(a);if(o)o&&a.forEach((t=>{const{structureName:i}=t,a=t.matchUps;n[t.structureId]={matchUps:a,itemStructureIds:[],structureName:i},a&&(r.push(...a),a.forEach((t=>{t.tieMatchUps&&r.push(...t.tieMatchUps)}))),n[e]||(n[e]={itemStructureIds:[],matchUps:[]}),n[e].itemStructureIds||(n[e].itemStructureIds=[]),n[e].itemStructureIds.push(t.structureId)}));else{const t=i;n[e]={matchUps:t,itemStructureIds:[]},t?.forEach((t=>{r.push(t),t.tieMatchUps&&r.push(...t.tieMatchUps)}))}})),{mappedMatchUps:n,drawMatchUps:r}}function Tp({mappedMatchUps:t,matchUpsMap:e,structureId:n,inContext:r}){const i=(t=e?.mappedMatchUps??t)[n],a=(i?.itemStructureIds||[]).map((e=>{const{matchUps:i,structureName:a}=t[e];return r?i.map((t=>Object.assign(ri(t,!0,!0),{containerStructureId:n,structureId:e,structureName:a}))):i})).flat();return(i?.matchUps||[]).concat(...a)}function Pp({groupedOrder:t,roundPositionsCount:e}){if(!t||t?.length<=e)return t;const n=x(t,t.length/e).map((t=>t.reduce(((t,e)=>t+e)))),r=n.slice().sort(l);return n.map((t=>r.indexOf(t)+1))}function Dp(t){if(!Array.isArray(t))return"";const e=t.filter(U);if(!e.length)return"";return T([Math.min(...e),Math.max(...e)]).join("-")}function Np({drawDefinition:t}){if(!t)return{error:Y};const e={};return{allPositionedParticipantIds:(t.structures||[]).map((t=>{const n=t.stage;e[n]||(e[n]=[]);const{positionAssignments:r}=Rp({structure:t}),i=r?.map(ui("participantId")).filter(Boolean)??[];return e[n].push(...i),i})).flat(),stagePositionedParticipantIds:e}}function Rp({drawDefinition:t,structureId:e,structure:n}){let r,i=[];if(!n){if(!t)return{positionAssignments:i,error:Y};if(({structure:n,error:r}=zd({drawDefinition:t,structureId:e})),r)return{positionAssignments:i,error:r}}return n.structures?i=[].concat(...n.structures.map((t=>Rp({structure:t}).positionAssignments))):n.positionAssignments?i=n.positionAssignments:r=Bt,{positionAssignments:i,error:r}}function bp({drawDefinition:t,structureId:e,structure:n}){const r=Rp({drawDefinition:t,structureId:e,structure:n})?.positionAssignments||[],i=r?.filter((t=>t.participantId??t.bye??t.qualifier)),a=r&&r?.length===i?.length,o=r?.filter((t=>!t.participantId&&!t.bye&&!t.qualifier)),s=r?.filter((t=>!t.participantId&&t.bye)),c=r?.filter((t=>!t.participantId&&t.qualifier));return{allPositionsAssigned:a,positionAssignments:r,unassignedPositions:o,assignedPositions:i,qualifierPositions:c,byePositions:s}}function Mp({drawPositions:t,roundProfile:e,roundNumber:n}){const r=[void 0,void 0];if(t.reduce(((t,e)=>isNaN(parseInt(e))&&t),!0))return{orderedDrawPositions:r,displayOrder:r};const i=e?.[n],a=i?.pairedDrawPositions,o=a?.find((e=>k(e||[],t.filter(Boolean))))??r,s=i?.feedRound;if(function(t){return t.reduce(((t,e)=>!isNaN(parseInt(e))&&t),!0)}(t)){const e=[...t].sort(l);return{orderedDrawPositions:2===e.length?e:o,displayOrder:s?e:o}}if(s){const e=[t.find((t=>!isNaN(m(t)))),void 0];return{orderedDrawPositions:e,displayOrder:e}}return{orderedDrawPositions:o,displayOrder:o}}function Ap({matchUp:t}){let e,n=[],r=[],i=[],a=[];if(t||(e=te),t&&!t.sides&&(e=ee),t&&!t.hasContext&&(e=Pn),!e){a=t.sides.map((t=>t.participantId));const e=t.sides.filter((t=>t.participantType===Eu)).map((t=>t.participantId)).filter(Boolean);n=t.sides.map((t=>t.participant?.individualParticipants)).filter(Boolean).map((t=>t.map((t=>t?.participantId)).filter(Boolean))),i=[...e,...n.flat()].filter(Boolean),r=T(i.concat(a)).filter(Boolean)}return{nestedIndividualParticipantIds:n,allRelevantParticipantIds:r,individualParticipantIds:i,sideParticipantIds:a,error:e}}function Ep({matchUp:t}){if(!t)return{error:te};if(!t.hasContext)return{error:Pn};if(!t.sides||2!==t.sides.filter(Boolean).length)return{error:ee};const{nestedIndividualParticipantIds:e,allRelevantParticipantIds:n,sideParticipantIds:r}=Ap({matchUp:t}),i=(t.timeItems||[]).filter((t=>[xc,_c].includes(t?.itemType))).sort(((t,e)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime())),a=i.map((t=>t.itemValue)).filter((t=>i.filter((e=>e?.itemValue===t)).reverse()[0].itemType===xc));e?.forEach(((t,e)=>{const n=r[e],i=t?.length&&t.every((t=>a.includes(t)));n&&i&&!a.includes(n)&&a.push(n)})),r.forEach(((t,n)=>{a.includes(t)&&(e?.[n]||[]).forEach((t=>{t&&!a.includes(t)&&a.push(t)}))}));return{allParticipantsCheckedIn:r.reduce(((t,e)=>a.includes(e)&&t),!0),checkedInParticipantIds:a,allRelevantParticipantIds:n}}function Cp(t){const{matchUps:e,isCollectionMatchUp:n,excludeMatchUpStatuses:r,matchUpStatuses:i,hasWinningSide:a,matchUpFormats:o,roundPositions:s,matchUpFormat:c,collectionIds:u,isMatchUpTie:d,roundNumbers:p,matchUpIds:l,roundNames:m,stageSequences:f,scheduledDates:h,scheduledDate:I,participantIds:g,processContext:U,tournamentIds:y,matchUpTypes:S,structureIds:v,readyToScore:w,courtIds:T,eventIds:P,venueIds:D,drawIds:N,stages:R,filterMatchUpIds:b=!0,filterMatchUpTypes:M=!0}=t,A=Array.isArray(g)?g.filter(Boolean):[],E=Array.isArray(i)?i.filter(Boolean):[],C=Array.isArray(r)?r.filter(Boolean):[],O=Array.isArray(R)?R.filter(Boolean):[],F=Array.isArray(f)?f.filter(Boolean):[],k=Array.isArray(u)?u.filter(Boolean):[],x=Array.isArray(m)?m.filter(Boolean):[],_=Array.isArray(p)?p.filter(Boolean):[],L=Array.isArray(s)?s.filter(Boolean):[],B=Array.isArray(l)&&b?l.filter(Boolean):[],V=Array.isArray(S)&&M?S.filter(Boolean):[],j=Array.isArray(T)?T.filter(Boolean):[],G=Array.isArray(D)?D.filter(Boolean):[],q=Array.isArray(o)&&o.filter(Boolean)||"string"==typeof c&&[c]||[],$=Array.isArray(h)&&h.filter(Boolean)||"string"==typeof I&&I.length&&[I]||[],W=Array.isArray(y)?y.filter(Boolean):[],H=Array.isArray(P)?P.filter(Boolean):[],z=Array.isArray(N)?N.filter(Boolean):[],Y=Array.isArray(v)?v.filter(Boolean):[];return e.filter((t=>{if(w&&t.matchUpType!==Ea&&!t.readyToScore)return!1;if(t.winningSide&&a&&![1,2].includes(t.winningSide))return!1;if(void 0!==d){if(d&&!t.tieMatchUps)return!1;if(!d&&t.tieMatchUps)return!1}if(void 0!==n){if(n&&!t.collectionId)return!1;if(!n&&t.collectionId)return!1}if(O.length&&!O.includes(t.stage))return!1;if(F.length&&!F.includes(t.stageSequence))return!1;if(k.length&&(!t.collectionId||!k.includes(t.collectionId)))return!1;if(x.length&&(!t.roundName||!x.includes(t.roundName)))return!1;if(_.length&&(!t.roundNumber||!_.includes(t.roundNumber)))return!1;if(L.length&&(!t.roundPosition||!L.includes(t.roundPosition)))return!1;if(E.length&&(!t.matchUpStatus||!E.includes(t.matchUpStatus)))return!1;if(C.length&&t.matchUpStatus&&C.includes(t.matchUpStatus))return!1;if(B.length&&!B.includes(t.matchUpId))return!1;if(V.length&&(!t.matchUpType||!V.includes(t.matchUpType)))return!1;if(q.length&&(!t.matchUpFormat||!q.includes(t.matchUpFormat)))return!1;if($?.length){const{scheduledTime:e}=lu({matchUp:t}),{scheduledDate:n}=mu({matchUp:t}),r=$r(e)||n;if(!$.find((t=>ei(t,r))))return!1}if(j.length){const{courtId:e}=hu({matchUp:t}),{allocatedCourts:n}=fu({matchUp:t}),r=n?.map((({courtId:t})=>t));if(!j.filter(Boolean).includes(e)||r?.includes(e))return!1}if(G.length){const{venueId:e}=Iu({matchUp:t});if(!G.filter(Boolean).includes(e))return!1}if(U){if(W.length&&!W.includes(t.tournamentId))return!1;if(H.length&&!H.includes(t.eventId))return!1;if(z.length&&!z.includes(t.drawId))return!1;if(Y.length&&!Y.includes(t.structureId))return!1;if(A.length){const e=t.sides?.map((({participantId:t})=>t)).filter(Boolean)??[];if(!A.some((t=>e.includes(t))))return!1}}return!0}))}function Op({roundsNotPowerOf2:t,drawDefinition:e,structure:n,matchUps:r}){if(!n)return!1;r=r??n.matchUps??[],t=t??Gu({matchUps:r}).roundsNotPowerOf2;const i=!!n.positionAssignments?.find((({drawPosition:t})=>t))||!!r?.find((({drawPositions:t})=>t?.length));return(!e?.drawType||e.drawType!==Td)&&!n?.structures&&t&&i}function Fp({drawDefinition:t,structure:e}){if(!e)return!1;const n=e.matchUps||e.roundMatchUps&&Object.values(e.roundMatchUps).flat(),r=n?.find((t=>t?.roundPosition)),i=n?.find((t=>t?.drawPositions?.length));return!(e?.structures||e?.stage===Ku||t?.drawType&&t.drawType!==hd||r||i)}const kp={[to]:{policyName:"Round Naming Default",namingConventions:{round:"Round"},abbreviatedRoundNamingMap:{1:"F",2:"SF",4:"QF"},roundNamingMap:{1:"Final",2:"Semifinal",4:"Quarterfinal"},affixes:{roundNumber:"R",preFeedRound:"Q"},stageConstants:{[Hu]:"",[Ju]:"P",[zu]:"Q",[Yu]:"C"}}};function xp({drawPositionCollectionAssignment:t,positionAssignments:e,displaySideNumber:n,seedAssignments:r,drawPosition:i,isFeedRound:a,sideNumber:o}){const s=e.find((t=>t.drawPosition&&t.drawPosition===i)),c=t?t[i]?.participantId:s?.participantId,u=s?function({displaySideNumber:t,seedAssignments:e,participantId:n,assignment:r,sideNumber:i}){const a={drawPosition:r.drawPosition,displaySideNumber:t,sideNumber:i};if(n){const t=function({seedAssignments:t,participantId:e}){return t?.find((t=>!t.seedProxy&&t.participantId===e))}({seedAssignments:e,participantId:n});Object.assign(a,t,{participantId:n})}else r.bye&&Object.assign(a,{bye:!0});r.qualifier&&Object.assign(a,{qualifier:!0});return a}({displaySideNumber:n,seedAssignments:r,participantId:c,assignment:s,sideNumber:o}):{};a&&(1===o?Object.assign(u,{participantFed:!0}):Object.assign(u,{participantAdvanced:!0}));const d=t?.[i]?.teamParticipant,p=t?.[i]?.participant,l=t?.[i]?.substitutions;return p&&Object.assign(u,{participant:p}),l&&Object.assign(u,{substitutions:l}),d&&Object.assign(u,{teamParticipant:d}),u}const _p="ANY",Lp="MALE",Bp="MIXED",Vp="OTHER",jp="FEMALE",Gp={ANY:_p,MALE:Lp,FEMALE:jp,MIXED:Bp,OTHER:Vp};function qp({scheduleVisibilityFilters:t,tournamentAppliedPolicies:e,provisionalPositioning:n,tournamentParticipants:r,afterRecoveryTimes:i,policyDefinitions:a,tournamentRecord:o,seedAssignments:s,contextFilters:c,contextContent:u,matchUpFilters:d,participantMap:p,scheduleTiming:m,contextProfile:f,drawDefinition:h,context:I={},exitProfiles:g,matchUpsMap:U,structure:y,inContext:S,event:w}){let P={},D={};if(r=r??o?.participants,!y)return{collectionPositionMatchUps:P,error:Rt,roundMatchUps:D,matchUps:[]};const N=Array.isArray(d?.eventIds)?d?.eventIds.filter(Boolean):[],R=Array.isArray(d?.structureIds)?d?.structureIds.filter(Boolean):[],b=Array.isArray(d?.drawIds)?d?.drawIds.filter(Boolean):[],M=!I?.eventId||!N?.length&&!c?.eventIds?.filter(Boolean).length||N?.includes(I.eventId)||c?.eventIds?.includes(I.eventId),A=!R?.length||R.includes(y.structureId),C=!h||!b?.length||b.includes(h.drawId);if(!M||!A||!C)return{collectionPositionMatchUps:P,roundMatchUps:D,matchUps:[]};f&&!u&&(u=Ko({tournamentRecord:o,contextProfile:f,drawDefinition:h}));const{appliedPolicies:O}=Vo({drawDefinition:h}),F={...e,...O,...a},k=F?.scoring?.structures,_=y.stage&&k?.stage&&k?.stage[y.stage],L=y.stageSequence&&_?.stageSequence&&_.stageSequence[y.stageSequence],B=F?.scoring?.requireAllPositionsAssigned||_?.requireAllPositionsAssigned||L?.requireAllPositionsAssigned;U||(U=wp({drawDefinition:h,structure:y}));const{positionAssignments:V,allPositionsAssigned:j}=bp({structure:y}),G=!B||j,{seedAssignments:q}=Sp({provisionalPositioning:n,drawDefinition:h,structure:y});s=s??q;const{roundOffset:$,structureId:W,structureName:H,stage:z,stageSequence:K}=y,{drawId:J,drawName:Q,drawType:X}=h??{};g=g||h&&vp({drawDefinition:h}).exitProfiles;const Z=g?.[W],tt=Z?.length&&(Z[0].split("-").map((t=>parseInt(t))).reduce(((t,e)=>t+e))||0),et=!!y.structures;let nt=Tp({matchUpsMap:U,structureId:W,inContext:S});const rt=F?.[to],it=function({roundNamingPolicy:t,structure:e,matchUps:n}){const{roundProfile:r,roundMatchUps:i}=Gu({matchUps:n}),{structureAbbreviation:a,stage:o}=e,s=Fp({structure:e}),c=Op({structure:e}),u=e.structures,d={},p=kp[to],l=t?.roundNamingMap||p.roundNamingMap||{},m=t?.abbreviatedRoundNamingMap||p.abbreviatedRoundNamingMap||{},f=t?.affixes||p.affixes,h=f.roundNumber||p.affixes.roundNumber,I=(t?.namingConventions||p.namingConventions).round,g=o&&o!==Hu&&o[0],U=t?.stageConstants,y=o&&U?.[o]||g,S=r?Object.keys(r):[];return u||s||c?Object.assign(d,...S.map((t=>({[t]:{roundName:`${I} ${t}`,abbreviatedRoundName:`${h}${t}`}})))):Object.assign(d,...S.map((t=>{if(!r?.[t])return;const{matchUpsCount:e,preFeedRound:n}=r[t],i=2*e,o=l[e]||`${f.roundNumber}${i}`,s=n?`-${f.preFeedRound}`:"",c=[y,a,`${o}${s}`].filter(Boolean).join("-"),u=m[e]||`${f.roundNumber}${i}`;return{[t]:{abbreviatedRoundName:[y,a,`${u}${s}`].filter(Boolean).join("-"),roundName:c}}}))),{roundNamingProfile:d,roundProfile:r,roundMatchUps:i}}({roundNamingPolicy:rt,structure:y,matchUps:nt}),{roundNamingProfile:at,roundProfile:ot}=it;if(D=it?.roundMatchUps??[],d&&(nt=Cp({matchUps:nt,...d,filterMatchUpTypes:!1,filterMatchUpIds:!1})),S){const{sourceDrawPositionRanges:e}=function({drawDefinition:t,structureId:e,matchUpsMap:n}){if(!t)return{error:Y};if(!e)return{error:Pt};const{structure:r}=zd({drawDefinition:t,structureId:e});if(r?.stage!==Yu)return{error:_t,info:"Structure is not CONSOLATION stage"};const{links:i}=t,a=i?.filter((t=>t.target.structureId===e))||[],o=a?.reduce(((t,e)=>{const{structureId:n}=e.source;return t.includes(n)?t:t.concat(n)}),[])||[],s=Object.assign({},...o.map((t=>({[t]:Gu({matchUps:Tp({structureId:t,matchUpsMap:n})}).roundProfile})))),c=Tp({matchUpsMap:n,structureId:e}),{roundProfile:u}=Gu({matchUps:c}),d={};return a?.forEach((t=>{const{structureId:e,roundNumber:n}=t.source,{feedProfile:r,groupedOrder:i,positionInterleave:a,roundNumber:o}=t.target,c=s[e],p=c[1]?.drawPositions,l=c[n],m=l?.matchUpsCount;if(!m)return;const f=m?p.length/m:0,h=p.length/f;let I=p.slice();const g=Pp({roundPositionsCount:I.length,groupedOrder:i}),U=g?.length||1;if(U<=h){const t=x(I,p.length/U);r===dd&&t.forEach((t=>t.reverse())),I=g?.length&&g?.map((e=>t[e-1])).flat()||I}let y=x(I,f);if(g?.length||r!==dd||y.reverse(),a){const t=E(0,a.interleave).map((()=>{})),e=E(0,a.offset).map((()=>{}));y=y.map((e=>[e,...t])),y.unshift(e),y=y.flat(1);const n=y.length-a.offset;y=y.slice(0,n)}d[o]||(d[o]={});const S=u?.[o],v=S?.feedRound?2:1;y.forEach(((t,e)=>{const n=1+e*v;d[o][n]||(d[o][n]=Dp(t))}))})),{sourceDrawPositionRanges:d}}({drawDefinition:h,matchUpsMap:U,structureId:W}),n=h?function({drawDefinition:t,roundProfile:e,structureId:n,matchUpsMap:r}){if(!t)return{error:Y};if(!n)return{error:Pt};if(!e){const t=Tp({matchUpsMap:r,structureId:n});if(({roundProfile:e}=Gu({matchUps:t})),!e)return{error:me}}const i=(Math.min(...e?.[1]?.drawPositions||[])||1)-1,a=Object.keys(e);return{drawPositionsRanges:Object.assign({},...(a||[]).map((t=>{const n=e?.[t]?.matchUpsCount,r=e?.[1]?.drawPositions||[],o=x(r,r.length/n),s=o.map(Dp),c=o.map((t=>t.map((t=>t-i)))).map(Dp),u=a.map((r=>{if(r>t)return;const i=e?.[r]?.drawPositions??[];return x(i,i.length/n)})).filter(Boolean),d=E(0,n).map((t=>u.map((e=>e[t])).flat().filter(Boolean).sort(l))).map((t=>T(t))),p=d.map((t=>{return(e=t,e.reduce(((t,e)=>{const n=t[t.length-1];return n&&n[n.length-1]===e-1||t.push([]),t[t.length-1].push(e),t}),[])).map(Dp).join(", ");var e})),m=Object.assign({},...E(0,n).map((t=>({[t+1]:{firstRoundDrawPositionsRange:s[t],firstRoundOffsetDrawPositionsRange:c[t],possibleDrawPositions:d[t],drawPositionsRange:p[t]}}))));return{[t]:m}})))}}({drawDefinition:h,roundProfile:ot,matchUpsMap:U,structureId:W}).drawPositionsRanges:void 0;nt=nt.map((r=>st({scheduleVisibilityFilters:t,sourceDrawPositionRanges:e,drawPositionsRanges:n,roundNamingProfile:at,initialRoundOfPlay:tt,appliedPolicies:F,isRoundRobin:et,roundProfile:ot,matchUp:r,event:w})));const r=nt?.filter((t=>Array.isArray(t.tieMatchUps)));r.forEach((t=>{const e=t.tieMatchUps;nt=nt.concat(...e)})),c&&(nt=Cp({processContext:!0,...c,matchUps:nt}))}else{const t=nt?.filter((t=>Array.isArray(t.tieMatchUps)));t.forEach((t=>{const e=t.tieMatchUps;nt=nt.concat(...e)}))}return d&&(nt=Cp({matchUps:nt,...d,filterMatchUpTypes:!1,filterMatchUpIds:!1})),(d?.matchUpTypes||d?.matchUpIds)&&(nt=Cp({matchUpTypes:d.matchUpTypes,matchUpIds:d.matchUpIds,matchUps:nt})),(d?.matchUpTypes||d?.matchUpIds||S)&&(D=Gu({matchUps:nt}).roundMatchUps??[]),Ri({drawDefinition:h,structure:y,event:w})?.tieFormat&&({collectionPositionMatchUps:P}=function({matchUps:t}){const e=t.reduce(((t,e)=>!e.collectionPosition||t.includes(e.collectionPosition)?t:t.concat(e.collectionPosition)),[]).map((e=>({[e]:t.filter((t=>t.collectionPosition===e))})));return{collectionPositionMatchUps:Object.assign({},...e)}}({matchUps:nt})),{matchUps:nt,roundMatchUps:D,roundProfile:ot,collectionPositionMatchUps:P};function st({scheduleVisibilityFilters:t,sourceDrawPositionRanges:e,drawPositionsRanges:n,initialRoundOfPlay:c,additionalContext:d,roundNamingProfile:l,tieDrawPositions:g,appliedPolicies:U,isCollectionBye:S,matchUpTieId:w,isRoundRobin:P,roundProfile:D,sideLineUps:N,matchUp:R,event:b}){d=d??{};const M=Ri({drawDefinition:h,structure:y,matchUp:R,event:b})?.tieFormat,A=M?.collectionDefinitions,E=R.collectionId&&A?.find((t=>t.collectionId===R.collectionId)),C=R.collectionId?E?.matchUpFormat:R.matchUpFormat??y?.matchUpFormat??h?.matchUpFormat??b?.matchUpFormat,O=R.matchUpType||E?.matchUpType||y?.matchUpType||h?.matchUpType||b?.eventType!==Du&&b?.eventType,F=S?Ki:R.matchUpStatus,{schedule:k,endDate:x}=bu({scheduleVisibilityFilters:t,afterRecoveryTimes:i,tournamentRecord:o,scheduleTiming:m,matchUpFormat:C,matchUpType:O,matchUp:R,event:b}),_=g??R.drawPositions??[],{collectionPosition:L,collectionId:B,roundPosition:j}=R,q=R.roundNumber??d.roundNumber,Y=B?function({tournamentParticipants:t,positionAssignments:e,collectionPosition:n,drawPositions:r=[],participantMap:i,drawDefinition:a,collectionId:o,sideLineUps:s,matchUpType:c}){if(!o||!n)return;const u=r?.map((r=>{const u=e.find((t=>t.drawPosition===r))?.participantId,d=s?.find((t=>t?.drawPosition===r)),p=d?.teamParticipant||u&&i?.[u]?.participant||t?.find((({participantId:t})=>t===u)),l=d?.lineUp||ju({participantId:u,drawDefinition:a})?.lineUp,{assignedParticipantIds:m,substitutions:f}=Mu({collectionPosition:n,collectionId:o,lineUp:l});if(c!==Aa){const t=m?.[0];return t&&{[r]:{participantId:t,teamParticipant:p,substitutions:f}}}if(m?.length<=2){const e=i?.[m[0]]?.pairIdMap?.[m[1]],n=e&&i[e]?.participant||Vu({participantIds:m,tournamentParticipants:t}).participant,a=n?.participantId;return{[r]:{participantId:a,teamParticipant:p,substitutions:f}}}if(m?.length>2)return{[r]:{teamParticipant:p,substitutions:f}}})).filter(Boolean)||{};return Object.assign({},...u)}({tournamentParticipants:r,positionAssignments:V,collectionPosition:L,drawDefinition:h,participantMap:p,drawPositions:_,collectionId:B,sideLineUps:N,matchUpType:O}):void 0,Z=l?.[q]?.roundName||d.roundName,tt=l?.[q]?.abbreviatedRoundName||d.abbreviatedRoundName,et=D?.[q]?.feedRound,nt=D?.[q]?.preFeedRound,rt=D?.[q]?.roundFactor,it=n?.[q],at=j?it?.[j]:void 0,ot=e?.[q],ct=E?.category?{...I?.category||{},...E.category}:I?.category,ut=R.processCodes?.length&&R.processCodes||E?.processCodes?.length&&E?.processCodes||y?.processCodes?.length&&y?.processCodes||h?.processCodes?.length&&h?.processCodes||b?.processCodes?.length&&b?.processCodes||o?.processCodes,dt=f?.withCompetitiveness&&rs({...u,matchUp:R}),pt=R.finishingPositionRange??d.finishingPositionRange,lt=t=>di(t,void 0,!0),mt={...lt(I),...lt({matchUpFormat:R.matchUpType===Du?void 0:C,tieFormat:R.matchUpType!==Du?void 0:M,roundOfPlay:z!==zu&&v(c)&&c+(q||0),endDate:R.endDate??x,gender:E?.gender,discipline:b?.discipline,category:ct,finishingPositionRange:pt,abbreviatedRoundName:tt,drawPositionsRange:at,competitiveProfile:dt,structureName:H,stageSequence:K,drawPositions:_,matchUpStatus:F,processCodes:ut,isRoundRobin:P,matchUpTieId:w,preFeedRound:nt,matchUpType:O,roundFactor:rt,roundOffset:$,structureId:W,roundNumber:q,feedRound:et,roundName:Z,drawName:Q,drawType:X,schedule:k,drawId:J,stage:z}),...ri(lt(R),!0,!0)};if(C&&R.score?.scoreStringSide1){const t=Ii(C),{bestOf:e,finalSetFormat:n,setFormat:r}=t??{};(n?.tiebreakSet||r?.tiebreakSet||r?.timed)&&(mt.score.sets=mt.score.sets.sort(((t,e)=>t.setNumber-e.setNumber)).map(((t,i)=>(i+1===e?(n?.tiebreakSet||n?.timed)&&(t.tiebreakSet=!0):(r?.tiebreakSet||r?.timed)&&(t.tiebreakSet=!0),t))))}if(Array.isArray(_)){const{orderedDrawPositions:t,displayOrder:e}=Mp({drawPositions:_,roundProfile:D,roundNumber:q}),n=D?.[q]?.feedRound,r=e[0]!==t[0],i=t.concat(void 0,void 0).slice(0,2).map(((t,e)=>{const i=e+1,a=xp({drawPositionCollectionAssignment:Y,positionAssignments:V,displaySideNumber:r?3-i:i,seedAssignments:s,drawPosition:t,isFeedRound:n,sideNumber:i}),o=R.sides?.find((t=>t.sideNumber===i)),c=j?2*(j-1)+e+1:void 0;return lt({sourceDrawPositionRange:c?ot?.[c]:void 0,...o,...a})}));Object.assign(mt,ri({sides:i},!0,!0))}if(r&&mt.sides){const t=a?.[eo],e=e=>{const n=p?.[e]?.participant;return n&&li({template:t?.participant,source:n})};if(mt.sides.filter(Boolean).forEach((t=>{if(t.participantId){const n=ri(e(t.participantId)||r&&fs({policyDefinitions:U,participantId:t.participantId,tournamentParticipants:r,internalUse:!0,contextProfile:f}),void 0,!0);if(n){if(h?.entries){const e=h.entries.find((e=>e.participantId===t.participantId));e?.entryStatus&&(n.entryStatus=e.entryStatus),e?.entryStage&&(n.entryStage=e.entryStage)}Object.assign(t,{participant:n})}}if(t?.participant?.individualParticipantIds?.length&&!t.participant.individualParticipants?.length){const n=t.participant.individualParticipantIds.map((t=>e(t)||r&&fs({policyDefinitions:U,tournamentParticipants:r,internalUse:!0,contextProfile:f,participantId:t})));Object.assign(t.participant,{individualParticipants:n})}})),!mt.matchUpType){const{matchUpType:t}=qu({matchUp:mt});t&&Object.assign(mt,{matchUpType:t})}if(f?.inferGender&&(!mt.gender||mt.gender===Bp)&&2===mt.sides?.length&&mt.matchUpType!==Du){const t=mt.sides.map((t=>{if(mt.matchUpType===ba)return t.participant?.person?.sex;if(2===t.participant?.individualParticipants?.length){const e=T(t.participant.individualParticipants.map((t=>t.person?.sex))).filter(Boolean);if(1===e.length)return e[0]}}));if(2===t.filter(Boolean).length&&1===T(t).length){const e=t[0];mt.inferredGender=e}}}if(mt.tieMatchUps){const r=mt.matchUpStatus===Ki,i=mt.sides?.map((({participant:t,drawPosition:e,sideNumber:n,lineUp:r})=>{const i=t?.participantType===Du&&t;return{teamParticipant:i&&di({participantRoleResponsibilities:i.participantRoleResponsibilities,participantOtherName:i.participanOthertName,participantName:i.participantName,participantId:i.participantId,teamId:i.teamId}),drawPosition:e,sideNumber:n,lineUp:r}}));mt.tieMatchUps=mt.tieMatchUps.map((a=>{const o=mt.matchUpId,s=mt.finishingPositionRange;return st({tieDrawPositions:_,scheduleVisibilityFilters:t,sourceDrawPositionRanges:e,sideLineUps:i,drawPositionsRanges:n,initialRoundOfPlay:c,roundNamingProfile:l,additionalContext:{finishingPositionRange:s,abbreviatedRoundName:tt,roundNumber:q,roundName:Z},appliedPolicies:U,isCollectionBye:r,matchUpTieId:o,isRoundRobin:P,roundProfile:D,matchUp:a,event:b})}))}const ft=mt.sides&&2===mt.sides.filter((t=>t?.participantId)).length,ht=!mt.winningSide,It=G&&ft&&ht;if(Object.assign(mt,{readyToScore:It,hasContext:!0}),ft){const{allParticipantsCheckedIn:t,checkedInParticipantIds:e}=Ep({matchUp:mt});Object.assign(mt,{allParticipantsCheckedIn:t,checkedInParticipantIds:e})}return Array.isArray(f?.exclude)&&f?.exclude.forEach((t=>delete mt[t])),mt}}function $p({tournamentParticipants:t,afterRecoveryTimes:e,contextContent:n,contextProfile:r,drawDefinition:i,matchUpsMap:a,matchUpId:o,inContext:s,context:c,event:u}){if(!i)return{error:Y};if(!o)return{error:Jt};if("string"!=typeof o)return{error:xn};const{structures:d=[]}=Yd({drawDefinition:i});r&&!n&&(n=Ko({contextProfile:r,drawDefinition:i}));for(const p of d){const{matchUps:d}=qp({tournamentParticipants:t,afterRecoveryTimes:e,contextContent:n,drawDefinition:i,contextProfile:r,matchUpsMap:a,inContext:s,structure:p,context:c,event:u}),{matchUp:l}=Jo({matchUps:d,matchUpId:o});if(l)return{matchUp:l,structure:p}}return{error:Xt}}function Wp({collectionGroups:t=[]}){const e=Object.assign({},...t.filter((t=>v(t?.groupValue)&&t?.groupNumber)).map((t=>({[t.groupNumber]:{...t,allGroupMatchUpsCompleted:!0,matchUpsCount:0,sideWins:[0,0],values:[0,0]}}))));return{groupValueGroups:e,groupValueNumbers:Object.keys(e).map((t=>m(t)))}}function Hp(t){const{sideAdjustments:e=[0,0],separator:n="-",drawDefinition:r,matchUpsMap:i,structure:a,matchUp:o,event:s}=t;if(!Array.isArray(e)||2!==e.length||isNaN(e.reduce(((t,e)=>t+e))))return{error:xn};if(!o)return{error:te};const c=Ri({matchUp:o,drawDefinition:r,structure:a,event:s})?.tieFormat||t?.tieFormat;if(!c)return{error:Kt};const u=$i({tieFormat:c});if(u.error)return u;const d=c?.collectionDefinitions||[],p=o?.tieMatchUps||[],l=[0,0],{groupValueGroups:m,groupValueNumbers:f}=Wp(c);for(const S of d)mo({collectionDefinition:S,groupValueNumbers:f,groupValueGroups:m,sideTieValues:l,tieMatchUps:p});for(const S of f){const t=m[S],{allGroupMatchUpsCompleted:e,matchUpCount:n,winCriteria:r,groupValue:i,sideWins:a,values:o}=t;let s;if(r?.aggregateValue)e&&o[0]!==o[1]&&(s=o[0]>o[1]?1:2);else if(r?.valueGoal)s=o.reduce(((t,e,n)=>e>=r.valueGoal?n+1:t),void 0);else{const t=Math.floor(n/2)+1;s=a.reduce(((e,n,r)=>n>=t?r+1:e),void 0)}s&&(l[s-1]+=i||0)}const h=l.map(((t,n)=>(t||0)+e[n])),I={side1Score:h[0],side2Score:h[1],winningSide:void 0},g=h.join(n),U=h.slice().reverse().join(n);let y;if(c?.winCriteria){const{valueGoal:t,aggregateValue:e,tallyDirectives:n}=c.winCriteria;if(t){const e=h.map(((t,e)=>({sideNumber:e+1,points:t}))).find((({points:e})=>e>=t));y=e?.sideNumber}else if(e){p.every((t=>t.matchUpStatus&&fa.includes(t.matchUpStatus)||t.winningSide))&&h[0]!==h[1]&&(y=h[0]>h[1]?1:2)}if(!y&&n){const t=o.matchUpId,e=o.hasContext?o:i?.drawMatchUps?.[t]||r&&$p({inContext:!0,drawDefinition:r,matchUpId:t})?.matchUp;if(e){const{completedTieMatchUps:t,order:n}=lo({matchUps:[e]});if(t&&n?.length){const t=n[0].participantId;y=e.sides.find((({participantId:e})=>e===t))?.sideNumber}}}}return y&&(I.winningSide=y),{scoreStringSide1:g,scoreStringSide2:U,winningSide:y,set:I}}function zp(t){if(t)return ri(t,!1,!0)}function Yp(t){const e=t?.matchUp,n=t?.score||e?.score,r=n?.sets?.[0],{side1Score:i,side2Score:a,side1TiebreakScore:o,side2TiebreakScore:s,side1PointScore:c,side2PointScore:u}=r||{},d=i||a||o||s||c||u;return!!(n?.sets?.length>1||d)}function Kp({matchUpStatus:t}){return la.includes(t)}function Jp({matchUpStatus:t}){return ma.includes(t)}function Qp({matchUpStatus:t,winningSide:e,tieMatchUps:n,sides:r,score:i}){const a=r?.find((({participantId:t})=>t)),o=n?.filter(Qp)?.length;return Yp({score:i})||o||e&&a||t&&function({matchUpStatus:t}){return ha.includes(t)}({matchUpStatus:t})&&![Zi,ca,na].includes(t)}function Xp(t){return"object"!=typeof t?{error:me}:"object"!=typeof t.element?{error:xn}:t.notes?"string"==typeof t.notes||t.notes?.testing?(Object.assign(t.element,{notes:t.notes}),{...L}):{error:xn}:{error:me}}function Zp(t,e){if(!t)return{error:Y};let n=Date.now();t.updatedAt&&n===new Date(t.updatedAt).getTime()&&(n+=1);const r=new Date(n).toISOString(),i=e?.filter(Boolean);return t.updatedAt=r,t.structures?.filter(Boolean).forEach((t=>{i?.length&&!i?.includes(t.structureId)||(t.updatedAt=r)})),{...L}}function tl({drawDefinition:t,tournamentId:e,matchUps:n,eventId:r}){return t&&Zp(t),dr({payload:{matchUps:n,tournamentId:e,eventId:r},topic:rc}),{...L}}function el({drawDefinition:t,tournamentId:e,matchUpIds:n,eventId:r,action:i}){t&&Zp(t),dr({topic:pc,payload:{tournamentId:e,matchUpIds:n,eventId:r,action:i}});for(const a of n)lr({key:a});return{...L}}function nl({drawDefinition:t,tournamentId:e,structureId:n,context:r,eventId:i,matchUp:a}){if(!a)return console.log(te),{error:te};if(t){il({drawDefinition:t,structureIds:n?[n]:void 0,tournamentId:e,eventId:i})}return dr({topic:hc,payload:{matchUp:a,tournamentId:e,context:r},key:a.matchUpId}),{...L}}function rl({tournamentId:t,eventId:e,drawDefinition:n}){return n?(Zp(n),dr({payload:{drawDefinition:n,tournamentId:t,eventId:e},topic:nc,key:n.drawId}),{...L}):(console.log(Y),{error:Y})}function il({drawDefinition:t,tournamentId:e,structureIds:n,eventId:r}){return t?(Zp(t,n),dr({payload:{tournamentId:e,eventId:r,drawDefinition:t},topic:lc,key:t.drawId}),{...L}):{error:Y}}function al({drawDefinition:t,tournamentId:e,structure:n,eventId:r}){if(!t)return{error:Y};if(!n)return{error:Rt};const i=n.seedAssignments,a=n.structureId;return dr({payload:{tournamentId:e,eventId:r,drawId:t.drawId,structureId:a,seedAssignments:i},topic:Uc,key:t.drawId}),il({structureIds:[a],drawDefinition:t,tournamentId:e,eventId:r}),{...L}}function ol({drawDefinition:t,tournamentId:e,structure:n,event:r}){if(!t)return{error:Y};if(!n)return{error:Rt};const i=Rp({structure:n}),a=n.structureId,o=t.drawId,s=r?.eventId;return dr({topic:gc,payload:{positionAssignments:i,tournamentId:e,structureId:a,eventId:s,drawId:o},key:a}),il({structureIds:[a],drawDefinition:t,tournamentId:e,eventId:s}),{...L}}const sl=t=>t?.participantId;function cl({positionAssignments:t,tournamentRecord:e,drawDefinition:n,matchUpFormat:r,matchUps:i,event:a}){if(!Sa(i))return{error:xn};if(!t)return{error:xn};const{policyDefinitions:o}=jo({policyTypes:[Ja],tournamentRecord:e,drawDefinition:n,event:a}),{subOrderMap:s}=function({positionAssignments:t}){const e=(t||[]).filter(sl).map((t=>{const{extension:e}=gs({element:t,name:ko}),n=m(e?.value),r=!isNaN(n)&&n;return r&&{participantId:t.participantId,subOrder:r}})).filter(Boolean),n=N(e.map((({subOrder:t})=>t)));return{subOrderMap:Object.assign({},...e.filter((({subOrder:t})=>1===n[t])).map((({participantId:t,subOrder:e})=>({[t]:e}))))}}({positionAssignments:t}),c=lo({policyDefinitions:o,matchUpFormat:r,subOrderMap:s,matchUps:i});if(c.error)return c;const{participantResults:u,bracketComplete:d,report:p}=c,l=Object.keys(u);return t.forEach((t=>{const{participantId:e}=t;if(l.includes(e)){Bs({element:t,extension:{value:u[e],name:xo}}),u[e].ties||Gs({element:t,name:ko})}else Gs({element:t,name:xo}),Gs({element:t,name:ko})})),il({drawDefinition:n}),{...L,participantResults:u,bracketComplete:d,report:p}}function ul({participantsProfile:t,participants:e=[]}){const n=ri(e,t?.convertExtensions,!0),r=n.filter((t=>t.participantType===Fu)),i=n.filter((t=>t.participantType===Cu)),a=n.filter((t=>t.participantType===Ou));return n.forEach((t=>{if(t.participantType===Eu){const{participantId:e}=t;t.groupParticipantIds=[],t.teamParticipantIds=[],t.pairParticipantIds=[],t.groups=[],t.teams=[],r.forEach((n=>{(n?.individualParticipantIds||[]).forEach((r=>{r!==e||t.teamParticipantIds?.includes(n.participantId)||(t.teamParticipantIds.push(n.participantId),t.teams.push({participantRoleResponsibilities:n.participantRoleResponsibilities,participantOtherName:n.participantOtherName,participantName:n.participantName,participantId:n.participantId,teamId:n.teamId}))}))})),a.forEach((n=>{(n?.individualParticipantIds||[]).forEach((r=>{r!==e||t.pairParticipantIds.includes(n.participantId)||t.pairParticipantIds.push(n.participantId)}))})),i.forEach((n=>{(n?.individualParticipantIds||[]).forEach((r=>{r!==e||t.groupParticipantIds.includes(n.participantId)||(t.groupParticipantIds.push(n.participantId),t.groups.push({participantRoleResponsibilities:n.participantRoleResponsibilities,participantOtherName:n.participantOtherName,participantName:n.participantName,participantId:n.participantId}))}))}))}})),n}const dl=t=>e=>t[e],pl=(t=[])=>t.map(hl).filter(Boolean),ll=(t=[])=>t.map(ml).filter(Boolean),ml=(t={})=>dl(t)("participantId"),fl=(t={})=>dl(t)("drawPosition"),hl=(t={})=>dl(t)("matchUpId");function Il({sourceRoundMatchUpCount:t,inContextDrawMatchUps:e,sourceRoundPosition:n,drawDefinition:r,targetLink:i}){if(!i)return{error:wt};const{target:{structureId:a,feedProfile:o,groupedOrder:s,roundNumber:c,positionInterleave:u}}=i,{structure:d}=zd({drawDefinition:r,structureId:a}),{positionAssignments:p}=Rp({structure:d}),l=e?.filter((t=>t.structureId===d?.structureId)),m=l.filter((t=>t.roundNumber===c&&!t.matchUpTieId)),f=m.length,h=E(1,f+1),I=f/t;let g=Math.ceil(I*n),U=1-n%2;if(u?.interleave&&.5!==I){const t=n+(u.offset+(n-1)*u.interleave);g=Math.ceil(t/2),U=1-t%2}let y=h,S=h[g-1];const v=Pp({groupedOrder:s,roundPositionsCount:h.length}),w=v?.length||1;if(w<=h.length){const t=x(h,f/w);o===dd&&t.forEach((t=>t.reverse())),y=v?.length&&v?.map((e=>t[e-1])).flat()||y}o===ud?S=y[g-1]:o===dd?((!v?.length||w>h.length)&&(g=m.length+1-g),S=y[g-1]):o===cd&&ir()&&console.log(qn,{feedProfile:o});const T=S&&m.reduce(((t,e)=>e.roundPosition===S?e:t),void 0);let P;T?.feedRound?(U=0,P=Math.min(...(T.drawPositions||[]).filter(Boolean))):P=2===T?.drawPositions?.length&&T?.drawPositions[U];const D=p?.find((({drawPosition:t})=>t===P));if(D){const{extension:t}=gs({element:D,name:yo});if(t?.value)return{disabledDrawPosition:P}}return{matchUp:T,targetDrawPosition:P,matchUpDrawPositionIndex:U}}function gl({finishingPositions:t,linkCondition:e,linkType:n,source:r}){const i=r.find((r=>{const i=!r.source?.finishingPositions||!t||k(t,r.source?.finishingPositions);return e===r.linkCondition&&i&&r.linkType===n}));return[ld,md].includes(i?.linkType)&&!i?.source?.roundNumber?Oi({result:{error:xn},stack:"getTargetLink",context:i}):i}function Ul({drawDefinition:t,structureId:e,roundNumber:n}){if(!t)return{error:Y};if(!e)return{error:Pt};return{links:(t.links||[]).filter(Boolean).reduce(((t,r)=>(r.source?.structureId!==e||n&&r.source.roundNumber!==n||(t.source=t.source.concat(r)),r.target?.structureId!==e||n&&r.target.roundNumber!==n||(t.target=t.target.concat(r)),t)),{source:[],target:[]})}}function yl({inContextDrawMatchUps:t=[],useTargetMatchUpIds:e,inContextMatchUp:n,drawDefinition:r,matchUpId:i}){let a=n;t.length&&!a&&(a=t.find((t=>t.matchUpId===i)));const{structure:o}=zd({structureId:a?.structureId,drawDefinition:r}),s=o?.finishingPosition;return s===Gd?function({inContextDrawMatchUps:t,useTargetMatchUpIds:e,drawDefinition:n,structure:r,matchUp:i}){const{winnerMatchUpId:a,loserMatchUpId:o}=i,{links:s}=function({drawDefinition:t,roundNumber:e,structureId:n}){if(!t)return{error:Y};if(!n)return{error:Pt};const{links:r}=Ul({drawDefinition:t,structureId:n});return{links:{source:r.source.reduce(((t,n)=>n.source.roundNumber&&n.source.roundNumber!==e?t:t.concat(n)),[]),target:r.target.reduce(((t,n)=>n.target.roundNumber&&n.target.roundNumber!==e?t:t.concat(n)),[])}}}({roundNumber:i.roundNumber,structureId:r.structureId,drawDefinition:n}),c=s?.source,u=gl({source:c,linkType:ld}),d=gl({linkCondition:fd,linkType:md,source:c});let p=gl({source:c,linkType:md});const l=d&&p;p||(p=d);const m=u?.target?.feedProfile,f=p?.target?.feedProfile,h=d?.target?.feedProfile;let I,g,U,y,S,v,w,T,P,D;if(e&&(a||o)&&(w=a&&m!==sd&&t.find((({matchUpId:t})=>t===a)),y=o&&f!==sd&&t.find((({matchUpId:t})=>t===o)),w||y))return{matchUp:i,targetLinks:{loserTargetLink:p,winnerTargetLink:u},targetMatchUps:{loserMatchUp:y,winnerMatchUp:w}};const{roundPosition:N}=i;D=D||t.filter((t=>t.structureId===r.structureId));const R=D.reduce(((t,e)=>e.roundNumber!==i.roundNumber||e.matchUpTieId?t:t+1),0);p&&!y&&f!==sd&&({matchUpDrawPositionIndex:v,targetDrawPosition:S,matchUp:y}=Il({targetLink:p,sourceRoundMatchUpCount:R,inContextDrawMatchUps:t,sourceRoundPosition:N,drawDefinition:n}));l&&h!==sd&&({matchUpDrawPositionIndex:U,targetDrawPosition:g,matchUp:I}=Il({targetLink:d,sourceRoundMatchUpCount:R,inContextDrawMatchUps:t,sourceRoundPosition:N,drawDefinition:n}));u&&!w&&m!==sd&&({matchUpDrawPositionIndex:P,targetDrawPosition:T,matchUp:w}=Il({targetLink:u,sourceRoundMatchUpCount:R,inContextDrawMatchUps:t,sourceRoundPosition:N,drawDefinition:n}));w||(D=D||t.filter((t=>t.structureId===r.structureId)),({matchUp:w}=function({structureMatchUps:t,matchUp:e}){const{roundNumber:n,roundPosition:r}=e,i=t.filter((t=>t.roundNumber===n&&!t.matchUpTieId)),a=t.filter((t=>t.roundNumber===n+1&&!t.matchUpTieId));if(a.length){let t;return a.length===i.length?t=a.find((t=>t.roundPosition===r)):a.length===i.length/2&&(t=a.find((t=>t.roundPosition===Math.ceil(r/2)))),{matchUp:t}}return{message:"no progression found"}}({structureMatchUps:D,matchUp:i})));return di({matchUp:i,targetLinks:{loserTargetLink:p,winnerTargetLink:u,byeTargetLink:d},targetMatchUps:{winnerMatchUpDrawPositionIndex:P,loserMatchUpDrawPositionIndex:v,byeMatchUpDrawPositionIndex:U,winnerTargetDrawPosition:T,loserTargetDrawPosition:S,byeTargetDrawPosition:g,winnerMatchUp:w,loserMatchUp:y,byeMatchUp:I},targetMatchUpIds:!(!a&&!o)})}({inContextDrawMatchUps:t,useTargetMatchUpIds:e,drawDefinition:r,structure:o,matchUp:a}):function({matchUp:t}){return{targetLinks:{loserTargetLink:void 0,winnerTargetLink:void 0},targetMatchUps:{loserMatchUp:void 0,winnerMatchUp:void 0},matchUp:t}}({matchUp:a})}function Sl({drawDefinition:t,inContextDrawMatchUps:e}){const n={};return e.forEach((r=>{const{matchUpId:i,structureId:a,drawPositions:o=[]}=r,{structure:s}=zd({drawDefinition:t,structureId:a});if(s?.finishingPosition===jd){const{roundNumber:t}=r,e=t&&m(t)+1,n=s.matchUps??[],{roundMatchUps:i}=Gu({matchUps:n});if(e&&i?.[e]){const t=[...o].sort(l).map(((t,n)=>{const r=i[e].find((e=>e.drawPositions?.includes(t)));return{matchUpId:r?.matchUpId,roundNumber:e,schedule:r?.schedule,sideNumber:n+1,structureName:s.structureName}}));Object.assign(r,{sidesTo:t})}}else{const a=yl({useTargetMatchUpIds:!0,inContextDrawMatchUps:e,inContextMatchUp:r,drawDefinition:t,matchUpId:i});let{winnerMatchUp:o}=a.targetMatchUps;const{loserMatchUp:s}=a.targetMatchUps;!r.winnerMatchUpId&&o&&(r.winnerMatchUpId=o.matchUpId),!r.loserMatchUpId&&s&&(r.loserMatchUpId=s.matchUpId);const u=wl({upcomingMatchUp:o});let d=wl({upcomingMatchUp:s});if(r.matchUpStatus!==Ki&&s?.matchUpStatus===Ki){const{matchUp:n}=vl({matchUp:s,drawDefinition:t,inContextDrawMatchUps:e})||{};d=n&&wl({upcomingMatchUp:n})||d}const p=r.schedule?.timeAfterRecovery;if(p){if(u?.schedule?.scheduledTime){jr(u.schedule.scheduledTime)<jr(p)&&(n[u.matchUpId]=r.matchUpId,u.schedule.scheduleConflict=r.matchUpId)}if(d?.schedule?.scheduledTime){jr(d.schedule.scheduledTime)<jr(p)&&(n[d.matchUpId]=r.matchUpId,d.schedule.scheduleConflict=r.matchUpId)}}if(Object.assign(r,{winnerTo:u,loserTo:d}),r.drawPositions?.filter(Boolean).length){const t=a.targetLinks?.loserTargetLink,n=t?.linkCondition===fd,i=(c=r,c?.sides?.map((({participant:t,participantId:e,qualifier:n})=>t||e&&{participantId:e}||n&&{qualifier:n})).filter(Boolean)||[]);if(i.length){const t=ll(o?.sides),r=ll(s?.sides),c=i.find((({participantId:e})=>t.includes(e)))?[]:i,u=i.find((({participantId:t})=>r.includes(t)))?[]:i;s&&n&&u.length<2&&u.push({bye:!0,tbd:!0}),c?.length&&o&&(!a.targetMatchUpIds&&o&&(o=e.find((({matchUpId:t})=>t===o.matchUpId))),o.potentialParticipants||(o.potentialParticipants=[]),o.potentialParticipants.push(c)),u?.length&&s&&(a.targetMatchUpIds||(o=e.find((({matchUpId:t})=>t===s.matchUpId))),s.potentialParticipants||(s.potentialParticipants=[]),s.potentialParticipants.push(u))}}}var c})),Object.keys(n).length&&e.forEach((t=>{Object.keys(n).includes(t.matchUpId)&&(t.schedule.scheduleConflict=n[t.matchUpId])})),{scheduleConflictMatchUpIds:n}}function vl({matchUp:t,drawDefinition:e,inContextDrawMatchUps:n}){const{matchUpId:r,matchUpStatus:i,structureId:a}=t||{};if(!t||!a||t?.matchUpStatus===sa)return{matchUp:t};if(i===Ki){let i;if(t.winnerMatchUpId)i=n.find((({matchUpId:e})=>e===t.winnerMatchUpId));else{const t=yl({inContextDrawMatchUps:n,drawDefinition:e,matchUpId:r});({winnerMatchUp:i}=t?.targetMatchUps||{})}return vl({matchUp:i,drawDefinition:e,inContextDrawMatchUps:n})}return{matchUp:void 0}}function wl(t){if(t?.upcomingMatchUp)return(({matchUpId:t,structureId:e,schedule:n,roundNumber:r,roundPosition:i,structureName:a})=>({matchUpId:t,structureId:e,schedule:n,roundNumber:r,roundPosition:i,structureName:a}))(t.upcomingMatchUp)}function Tl({requireParticipants:t=!0,scheduleVisibilityFilters:e,tournamentAppliedPolicies:n,tournamentParticipants:r,afterRecoveryTimes:i,policyDefinitions:a,tournamentRecord:o,matchUpFilters:s,contextFilters:c,contextContent:u,participantMap:d,scheduleTiming:p,contextProfile:l,drawDefinition:m,exitProfiles:f,matchUpsMap:h,structureId:I,inContext:g,structure:U,context:y,event:S}){!U&&I&&({structure:U}=zd({drawDefinition:m,structureId:I}));const v=qp({tournamentAppliedPolicies:n,scheduleVisibilityFilters:e,tournamentParticipants:r,afterRecoveryTimes:i,policyDefinitions:a,tournamentRecord:o,drawDefinition:m,matchUpFilters:s,contextFilters:c,contextProfile:l,contextContent:u,participantMap:d,scheduleTiming:p,exitProfiles:f,matchUpsMap:h,structure:U,inContext:g,context:y,event:S}),w=[],T=[],P=[],D=[],N=[];if(v.error)return v;const{matchUps:R}=v,{assignedPositions:b}=bp({structure:U}),M=b?.filter((t=>t.participantId)).map((t=>t.drawPosition));let A;return R.filter((t=>{const e=1===s?.matchUpTypes?.length&&s.matchUpTypes[0]===Ca;return!(t.matchUpType!==Ca&&e)})).forEach((e=>{if(e.matchUpStatus===zi)return void w.push(e);e.matchUpType===Ca&&(A=!0);const n=e.collectionId,r=n&&e.sides?.every((t=>t.participantId)),i=!n&&2===e.drawPositions?.filter(Boolean).length,a=!n&&e.drawPositions?.every((t=>M?.includes(t))),o=b?.filter((t=>t.bye)).map((t=>t.drawPosition)),s=!n&&e.drawPositions?.find((t=>o?.includes(t))),c=Ia.includes(e.matchUpStatus)&&(r||i&&(!t||a));return s?N.push(e):Ua({matchUp:e})?T.push(e):c?P.push(e):D.push(e)})),{includesTeamMatchUps:A,abandonedMatchUps:w,completedMatchUps:T,upcomingMatchUps:P,pendingMatchUps:D,byeMatchUps:N,structure:U}}function Pl(t){Object.assign(t,{requireParticipants:!1});const e=Dl(t);if(e.error)return Oi({result:e,stack:"getAllDrawMatchUps"});const{abandonedMatchUps:n,completedMatchUps:r,upcomingMatchUps:i,pendingMatchUps:a,byeMatchUps:o,matchUpsMap:s}=e;return{matchUps:(n??[]).concat(...r??[],...i??[],...a??[],...o??[]),matchUpsMap:s}}function Dl(t){if(!t?.drawDefinition)return{error:Y};let{tournamentParticipants:e,contextContent:n,matchUpsMap:r}=t;const{scheduleVisibilityFilters:i,tournamentAppliedPolicies:a,requireParticipants:o,participantsProfile:s,afterRecoveryTimes:c,policyDefinitions:u,tournamentRecord:d,contextFilters:p,contextProfile:l,drawDefinition:m,matchUpFilters:f,scheduleTiming:h,participantMap:I,nextMatchUps:g,inContext:U,context:y,event:S}=t;let v=[],w=[],T=[],P=[],D=[];l&&!n&&(n=Ko({policyDefinitions:u,tournamentRecord:d,contextProfile:l,event:S})),!e?.length&&d&&(e=d?.participants,(U||s?.withGroupings)&&e?.length&&(e=ul({participants:e,participantsProfile:s})));const{structures:N}=Yd({drawDefinition:m});if(!N)return{error:Dt};r||(r=wp({drawDefinition:m}));const R=m&&vp({drawDefinition:m}).exitProfiles;N.forEach((t=>{const{byeMatchUps:s=[],pendingMatchUps:N=[],upcomingMatchUps:b=[],completedMatchUps:M=[],abandonedMatchUps:A=[]}=Tl({matchUpFilters:g?void 0:f,contextFilters:g?void 0:p,inContext:U||g||p,tournamentAppliedPolicies:a,scheduleVisibilityFilters:i,tournamentParticipants:e,requireParticipants:o,afterRecoveryTimes:c,policyDefinitions:u,tournamentRecord:d,participantMap:I,scheduleTiming:h,contextContent:n,contextProfile:l,drawDefinition:m,exitProfiles:R,matchUpsMap:r,structure:t,context:y,event:S});v=v.concat(...A),w=w.concat(...M),T=T.concat(...b),P=P.concat(...N),D=D.concat(...s)}));const b=t=>f||g||p?(f&&(t=Cp({matchUps:t,...f})),p&&(t=Cp({matchUps:t,...p,processContext:!0})),t):t,M={abandonedMatchUps:b(v),completedMatchUps:b(w),upcomingMatchUps:b(T),pendingMatchUps:b(P),byeMatchUps:b(D),matchUpsMap:r,...L};if(g){const t="object"==typeof g||{abandoned:!0,completed:!0,upcoming:!0,pending:!0,bye:!0},{abandoned:e,completed:n,upcoming:r,pending:i,bye:a}=t;Sl({inContextDrawMatchUps:[].concat(...e&&v||[],...n&&w||[],...r&&T||[],...i&&P||[],...a&&D||[]),drawDefinition:m})}return M}const Nl={matchUpStatus:sa,matchUpStatusCodes:[],score:{scoreStringSide1:"",scoreStringSide2:"",sets:void 0},matchUpFormat:void 0,winningSide:void 0};function Rl({matchUpStatusCodes:t,removeWinningSide:e,tournamentRecord:n,drawDefinition:r,matchUpFormat:i,matchUpStatus:a,removeScore:o,winningSide:s,matchUpId:c,matchUp:u,event:d,notes:p,score:l}){const m="modifyMatchUpScore";let f;const h=u.matchUpType===Ca;if(h&&r){if(c&&u.matchUpId!==c){const t=$p({drawDefinition:r,matchUpId:c,event:d});if(!t.matchUp)return{error:Xt};({matchUp:u,structure:f}=t)}}else u.matchUpId!==c&&console.log("!!!!!");a&&[ca,ea].includes(a)||o?Object.assign(u,{...Nl}):l&&(u.score=l);const I=a&&u?.matchUpStatus===Zi&&a!==Zi;let g;if(a&&(u.matchUpStatus=a),i&&(u.matchUpFormat=i),t&&(u.matchUpStatusCodes=t),s&&(u.winningSide=s),e&&(u.winningSide=void 0),!f&&r&&({structure:f}=$p({drawDefinition:r,matchUpId:c,event:d})),!a||u.winningSide||!Yp(u)||fa.includes(a)||[Yi,oa].includes(a)||(u.matchUpStatus=Vi.InProgress),I&&u?.processCodes?.length||a===Zi){const t=Vo({tournamentRecord:n,drawDefinition:r,structure:f,event:d})?.appliedPolicies;g=t?.[oo]?.processCodes?.incompleteAssignmentsOnDefault}if(!u.collectionId){const t=f?.structureType===od,e=Fp({drawDefinition:r,structure:f});if(Op({drawDefinition:r,structure:f})||e||t){const a=(t=>{i=h?"SET1-S:T100":i??u.matchUpFormat??t?.matchUpFormat??r?.matchUpFormat??d?.matchUpFormat;const a=h?{matchUpTypes:[Ca]}:void 0,{matchUps:o}=qp({afterRecoveryTimes:!1,inContext:!0,matchUpFilters:a,structure:t,event:d});return e&&(t.positionAssignments=T(o.flatMap((t=>(t.sides??[]).map((t=>t.participantId)))).filter(Boolean)).map((t=>({participantId:t})))),cl({positionAssignments:t.positionAssignments,tournamentRecord:n,drawDefinition:r,matchUpFormat:i,matchUps:o,event:d})})(t&&f.structures.find((t=>t?.matchUps.find((t=>t.matchUpId===c))))||f);if(a.error)return Oi({result:a,stack:m})}}if(p){const t=Xp({element:u,notes:p});if(t.error)return Oi({result:t,stack:m})}const U=n?.tournamentId,y=fr().topics.includes(bc),S=(y||g)&&wp({drawDefinition:r}),v=S&&Pl({matchUpFilters:{matchUpIds:[c]},nextMatchUps:!0,tournamentRecord:n,inContext:!0,drawDefinition:r,matchUpsMap:S}).matchUps?.[0];if(y&&v&&function({tournamentId:t,inContextMatchUp:e}){e&&dr({topic:bc,payload:{inContextMatchUp:e,tournamentId:t},key:e.matchUpId})}({tournamentId:U,inContextMatchUp:v}),Array.isArray(g)&&v&&!v.sides?.every((({participantId:t})=>t)))if(a===Zi)u.processCodes?u.processCodes.push(...g):u.processCodes=g;else for(const w of g||[]){const t=w&&u?.processCodes?.lastIndexOf(w);u?.processCodes?.splice(t,1)}return nl({eventId:d?.eventId,context:m,drawDefinition:r,tournamentId:U,matchUp:u}),{...L}}function bl({tournamentRecord:t,exitWhenNoValues:e,drawDefinition:n,matchUpStatus:r,removeScore:i,matchUpsMap:a,matchUpId:o,event:s}){const c=$p({drawDefinition:n,event:s,matchUpId:o});if(c.error)return c;if(!c.matchUp)return{error:Xt};const{matchUp:u,structure:d}=c;if(!u.tieMatchUps)return{error:ee};const{extension:p}=tc({name:So,element:u});if(p?.value){if(!i)return{...L,score:u.score};Gs({element:u,name:So})}const l=Ri({drawDefinition:n,structure:d,matchUp:u,event:s})?.tieFormat;u.tieFormat=zp(l);const m=Hp({drawDefinition:n,matchUpsMap:a,structure:d,matchUp:u,event:s}),{winningSide:f,set:h,scoreStringSide1:I,scoreStringSide2:g}=m,U=h?.side1Score||h?.side2Score;if(e&&!u.score&&!U)return{...L};const y={scoreStringSide1:I,scoreStringSide2:g,sets:h?[h]:[]},S=f&&[1,2].includes(f),v=S&&Qi||Qp({matchUpStatus:r??u.matchUpStatus,tieMatchUps:u.tieMatchUps,winningSide:u.winningSide,score:y})&&na||sa,w=!(!u.winningSide||S),T=u.tieMatchUps.find((({score:t,winningSide:e,matchUpStatus:n})=>t?.sets?.length&&(t.sets[0].side1Score||t.sets[0].side2Score)||n&&fa.includes(n)||e));let P;if(u.tieFormat&&!S&&!T){const t=Ri({drawDefinition:n,structure:d,event:s})?.tieFormat;t&&JSON.stringify(l)===JSON.stringify(t)&&(u.tieFormatId=void 0,u.tieFormat=void 0,P=!0)}return Rl({matchUpStatus:v,score:y,removeWinningSide:w,tournamentRecord:t,drawDefinition:n,removeScore:i,winningSide:f,matchUpId:o,matchUp:u,event:s}),{...L,score:y,removeWinningSide:w,tieFormatRemoved:P,winningSide:f}}function Ml(t){const{winnerFirst:e=!0,addOutcomeString:n,reversed:r=!1,matchUpStatus:i,matchUpFormat:a,autoComplete:o,winningSide:s,sets:c}=t;if(!c)return{error:me,info:"missing sets"};const u=a&&Ii(a),{bestOf:d,finalSetFormat:p,setFormat:l}=u||{},m=r||!(!e||!s||1===s),f=n?function({matchUpStatus:t}){const e={[aa]:"RET",[ca]:"WO",[ta]:"DF/DF",[ea]:"WO/WO",[oa]:"SUS",[zi]:"ABN",[Zi]:"DEF",[Xi]:"DR"};return t&&e[t]||""}({matchUpStatus:i}):"",h=c?.sort(Al).map((function(t){const e=d&&t.setNumber===d&&p?p:l,n=e?.tiebreakSet||(f=t,!(U(f?.side1Score)||U(f?.side2Score))&&(t=>U(t?.side1TiebreakScore)||U(t?.side2TiebreakScore))(t)),{side1Score:r,side2Score:i,side1TiebreakScore:a,side2TiebreakScore:s}=t,c=a||(U(a)||o?0:""),u=s||(U(s)||o?0:"");var f;if(n){return`[${(m?[u,c]:[c,u]).join("-")}]`}const h=Math.min(c,u),I=h?`(${h})`:"",g=r||(U(r)||o?0:""),y=i||(U(i)||o?0:"");let S=m?`${[y,g].join("-")}${I}`:`${[g,y].join("-")}${I}`;["-"," "].includes(S)&&(S="");return S})).filter(Boolean).join(" ")||"";return f?2===s?`${f} ${h}`:`${h} ${f}`:h}function Al(t,e){return t.setNumber-e.setNumber}function El({existingMatchUpStatus:t,matchUpFormat:e,matchUpStatus:n,winningSide:r,score:i}){if("object"!=typeof i)return{error:xn};const{sets:a,scoreStringSide1:o,scoreStringSide2:s}=i,c="scoreString must be a string!";if(void 0!==o&&"string"!=typeof o)return{error:xn,info:c};if(void 0!==s&&"string"!=typeof s)return{error:xn,info:c};if(void 0!==a&&!Array.isArray(a))return{error:xn,info:Ci("sets")};if(a?.length){const o=a.map((t=>t?.setNumber)).filter(Boolean);if(o.length!==T(o).length)return{error:xn,info:"setNumbers not unique"};for(const t of a){const{side1Score:e,side2Score:n,side1TiebreakScore:r,side2TiebreakScore:i,side1PointScore:a,side2PointScore:o,winningSide:s,setNumber:c}=t;if(![[e,n],[r,i],[a,o]].filter((t=>t.some((t=>void 0!==t)))).every((t=>t.every((t=>v(t))))))return{error:xn,info:"non-numeric values"};if(![c,s].filter((t=>void 0!==t)).every((t=>v(t))))return{error:xn,info:"non-numeric values"};if(s&&![1,2].includes(s))return{error:xn,info:"winningSide must be 1 or 2"}}const{valid:s}=function({existingMatchUpStatus:t,matchUpFormat:e,matchUpStatus:n,winningSide:r,score:i}){const a=i?.sets||[],o=(a?.filter((t=>t?.winningSide))||[]).reduce(((t,e)=>{const{winningSide:n}=e;return n?(t[n-1]++,t):t}),[0,0]),s=r?r-1:void 0,c=void 0!==s?1-s:void 0,u=void 0!==s&&o[s],d=void 0!==c&&o[c],p=e?Ii(e):void 0,l=Math.max(...o),m=N(o)[l],f=p?.bestOf,h=f&&Math.ceil(f/2)||1,I=n||t,g=I&&[Zi,aa,ca].includes(I),U=!p||!a.length||a.every(((t,e)=>{const n=e+1,r=n===f,i=n===a.length,{side1Score:o,side2Score:s,side1TiebreakScore:c,side2TiebreakScore:u,winningSide:d}=t,l=Math.max(o||0,s||0),m=c||u,{finalSetFormat:h,setFormat:I}=p,U=r&&h||I;if(m){const{tiebreakTo:t,NoAD:e}=U?.tiebreakFormat||{},n=Math.max(c||0,u||0);if(e&&n>t)return!1;if(n<t&&d){if(i&&!g)return!1;if(!i)return!1}}return!U.setTo||!(!U.noTiebreak&&l>U.setTo+1)})),y=(!e||l===h)&&1===m&&o.indexOf(l)+1||void 0;return{valid:U&&(r&&u>d&&r===y||!r&&!y||g)}}({existingMatchUpStatus:t,matchUpStatus:n,matchUpFormat:e,winningSide:r,score:i});if(!s)return{error:Te,info:"score is invalid for matchUpFormat or winningSide does not match calculated winningSide"}}return{valid:!0}}function Cl({analysis:t,set:e}){const n=Fl({set:e}),{isDecidingSet:r,isTiebreakSet:i,matchUpScoringFormat:a}=t;return Ol({matchUpScoringFormat:a,isDecidingSet:r,isTiebreakSet:i,set:e})&&n}function Ol(t){let e=t.matchUpScoringFormat;const{ignoreTiebreak:n=!1,matchUpFormat:r,isTiebreakSet:i,isDecidingSet:a,set:o}=t;if(!o)return{error:me};e=e||r;const s=a&&e.finalSetFormat||e?.setFormat||{},{side1Score:c,side2Score:u}=o,{NoAD:d,setTo:p,tiebreakAt:l,tiebreakFormat:m}=s,f=m?.NoAd,h=Fl({set:o}),I=Math.abs(c-u),g=c>=p||u>=p,U=i||c>=p&&u>=p||l&&l<p&&(c===l||u===l),y=n||U&&(1===h&&o.side1TiebreakScore>o.side2TiebreakScore||2===h&&o.side2TiebreakScore>o.side1TiebreakScore);return(g&&(I>=(d||U&&(l&&!i||i&&f)?1:2)||U)||i)&&(!U||y)}function Fl({set:t}){if(t.side1Score||t.side2Score){if(t.side1Score>t.side2Score)return 1;if(t.side2Score>t.side1Score)return 2}else if(t.side1TiebreakScore||t.side2TiebreakScore){if(t.side1TiebreakScore>t.side2TiebreakScore)return 1;if(t.side2TiebreakScore>t.side1TiebreakScore)return 2}}const kl=" ",xl="DEF",_l="WO",Ll="ABN",Bl="SUS",Vl="RET",jl="INT",Gl=[Vl,xl,_l,"WO/WO",Ll,Bl,jl],ql="DEFAULTED",$l="WALKOVER",Wl="ABANDONED",Hl="SUSPENDED",zl="RETIRED",Yl="INTERRUPTED",Kl=[zl,ql,$l],Jl="()",Ql="[]",Xl=["up","left","shift+tab"],Zl=["enter","down","tab","right"],tm="backspace",em="r",nm="s",rm="a",im="d",am="w",om="i",sm=[em,im,am,rm,nm,om],cm="space",um=["[","("],dm=[...Xl,...Zl,cm,"]"],pm="-",lm="-",mm=["/"],fm=["0","1","2","3","4","5","6","7","8","9"].concat(sm),hm=fm.map((t=>`shift+${t}`)),Im=[pm,tm].concat(dm,mm),gm=[fm,hm,Im].join(","),Um=[gm,Xl,Zl,["=","+","num_1","num_2","shift+=","shift+-"]].join(",");[].concat(...fm,...fm,...Im,...fm,...fm,...fm,...fm,...fm,...fm);const ym={OUTCOMEKEYS:sm,SIDE1KEYS:fm,SIDE2KEYS:hm,MODIFIERS:Im,PROMPT:"Enter Score",MOVEUP:Xl,MOVEDOWN:Zl,HOTKEYS:Um};function Sm({scoreString:t,lowSide:e,outcome:n}){if(({scoreString:t}=vm({scoreString:t})),2===e){return t+((t&&t[t.length-1])!==kl?kl:"")+n}return n+kl+t}function vm({scoreString:t}){if(!t)return{scoreString:""};let e=!1;for(const n of Gl){const r=t?.indexOf(n);0===r?t=t.slice(n.length+1).trim()+kl:r>0&&(t=t.slice(0,r)),r>=0&&(e=!0)}return t?.trim()||(t=""),{scoreString:t,removed:e}}function wm({analysis:t,scoreString:e,sets:n,lowSide:r}){let i,a;if(!e)return{scoreString:e,sets:n};const{scoreString:o,removed:s}=vm({scoreString:e});if(e=o,s)return{scoreString:e,sets:n,outcomeRemoved:!0};let c=n[n.length-1]||{};const u=Object.values(c).filter((t=>void 0!==t)).length;c.setNumber&&1===u&&(c=(n=n.slice(0,n.length-1))[n.length-1]||{});const{tiebreakSet:d}=t.setFormat,{tiebreakTo:p,NoAD:l}=d||{},{isTiebreakEntry:m}=Tm({brackets:Ql,scoreString:e}),f=function(t){const e=t.split("");return e.reduce(((t,e,n)=>(e.match(/\d+/g)&&t.push(n),t)),[]).pop()}(e);if(f>=0){i=e.slice(0,f);const{isTiebreakEntry:o}=Tm({brackets:Jl,scoreString:i}),{lastOpenBracketIndex:s,isTiebreakEntry:u}=Tm({brackets:Ql,scoreString:i}),d=i&&i[i.length-1].trim(),h=i&&!isNaN(d);let I=t.isIncompleteSetScore;if(m&&u){const t=i.slice(s+1).split(lm),n=t?.length>0&&void 0!==t[0]&&!isNaN(parseInt(t[0]))&&parseInt(t[0])||void 0,a=t?.length>1&&void 0!==t[1]&&parseInt(t[1])||void 0,o=[n,a];if(a){const t=1===r?1:0;o[t]=(o?.[1-t]||0)+(l?1:2),(o[t]||0)<p&&(o[t]=p),i=e.slice(0,s+1),i+=o.join(lm)}else void 0!==n?(i=e.slice(0,s+1),i+=n):(i=e.slice(0,s),I=!0);c.side1TiebreakScore=o[0]||0,c.side2TiebreakScore=o[1]||0}if(i.length||(i=void 0),I){const e=c.side1Score?.toString();if(e){const t=e?.slice(0,e.length-1);c.side1Score=!isNaN(t)&&parseInt(t)||void 0,void 0===c.side1Score&&(c.side2Score=void 0)}t.isTimedSet?(a=c.side1Score?n:n?.slice(0,n.length-1)||[],a[n.length-1]=c):a=n?.slice(0,n.length-1)||[]}else if(h){const e=c.side2Score?.toString(),r=c.side1Score?.toString();if(!t.isTiebreakEntry&&!t.isMatchTiebreak)if(c.side2Score){const t=e?.slice(0,e.length-1);c.side2Score=!isNaN(t)&&parseInt(t)||void 0}else{const t=r?.slice(0,r.length-1);c.side1Score=!isNaN(t)&&parseInt(t)||void 0}t.isTimedSet?c.side1Score?(a=n||[],a[n.length-1]=c):a=n?.slice(0,n.length-1)||[]:(a=n||[],a[n.length-1]=c),a[a.length-1]&&Object.assign(a[a.length-1],{winningSide:void 0})}else o?(a=n||[],Object.assign(a[a.length-1]||{},{winningSide:void 0,side1TiebreakScore:void 0,side2TiebreakScore:void 0})):(m&&!u?a=n?.slice(0,n.length-1)||[]:(a=n,a[n.length-1]=c),m||(a[a.length-1].side2Score=0,a[a.length-1].winningSide=void 0));return{scoreString:i,sets:a}}return{scoreString:e,sets:n}}function Tm({brackets:t=Jl,scoreString:e}){if(!e)return{};const[n,r]=t.split(""),i=e.split(""),a=Math.max(...C(n,i));return{isTiebreakEntry:a>Math.max(...C(r,i)),lastOpenBracketIndex:a}}function Pm(t){const{lowValue:e=0,NoAD:n=!1,tiebreakTo:r}=t||{};return e+1>=r?e+(n?1:2):parseInt(r)}function Dm({matchUpFormat:t,matchUpStatus:e,winningSide:n,sets:r}){const i=Ii(t),{bestOf:a}=i,o=Math.ceil(a/2),s=r?.reduce(((t,e)=>{const{winningSide:n}=e;return n&&t[n-1]++,t}),[0,0]);let c=s?.indexOf(o)+1||void 0;return Kl.includes(e)&&n&&(c=n),{matchUpWinningSide:c}}function Nm({lowSide:t,value:e,sets:n,scoreString:r,winningSide:i,matchUpStatus:a}){let o;return e===em?r?(o=!0,r=Sm({scoreString:r,lowSide:t,outcome:Vl}),i=2===t?1:2,a=zl):(o=!0,r=Sm({scoreString:r,lowSide:t,outcome:xl}),i=2===t?1:2,a=ql):e===im?(o=!0,r=Sm({scoreString:r,lowSide:t,outcome:xl}),i=2===t?1:2,a=ql):e===am?(o=!0,n=[],r=_l,i=2===t?1:2,a=$l):e===nm&&r?(o=!0,r=Sm({scoreString:r,lowSide:t,outcome:Bl}),a=Hl,i=void 0):e===rm?(o=!0,r=Sm({scoreString:r,lowSide:t,outcome:Ll}),a=Wl,i=void 0):e===om&&r&&(o=!0,r=Sm({scoreString:r,lowSide:t,outcome:jl}),a=Yl,i=void 0),{updated:o,sets:n,scoreString:r,matchUpStatus:a,winningSide:i}}function Rm({matchUpFormat:t,scoreString:e,winningSide:n,value:r,sets:i}){const a=(i?.filter((t=>t?.winningSide))?.length||0)+(n?0:1),o=Ii(t),s=a===o?.bestOf,c=s&&o?.finalSetFormat||o?.setFormat||{},u=c?.timed,d=s&&i[o?.bestOf-1],p=d?.winningSide,{isTiebreakEntry:l}=Tm({brackets:Jl,scoreString:e}),{isTiebreakEntry:m}=Tm({brackets:Ql,scoreString:e}),f=l||m,h=!!c.tiebreakSet,I=e?.[e.length-1]?.trim(),g=e&&!isNaN(I),U=!f&&I===pm,y=l&&um.includes(I),S=m&&um.includes(I),v=m&&I===lm,w=e?.split(""),[T]=Ql.split(""),P=w&&Math.max(...C(T,w)),D=w&&Math.max(...C(lm,w)),N=w&&D>P,R=i[i.length-1]?.winningSide,b=i?.length&&!R,M=Gl.find((t=>e?.indexOf(t)>=0)),A=!isNaN(r),E=r===cm,O=dm.includes(r),F=e?.split("").find((t=>um.includes(t))),k=O&&m&&!S&&(v||!function({scoreString:t}){if(!t)return!1;const e=t&&t[t.length-1].trim(),n=t&&!isNaN(e),[r,i]=Ql.split(""),a=t.split(""),o=Math.max(...C(r,a)),s=Math.max(...C(i,a)),c=Math.max(...C(lm,a));return n&&o>s&&c>o}({scoreString:e}));return{isTiebreakSetValue:h&&A,matchUpScoringFormat:o,setNumber:a,setFormat:c,matchTiebreakHasJoiner:N,isGameScoreEntry:b,isSpace:E,isCloser:O,isTiebreakCloser:O&&F&&f&&g,isDecidingSet:s,isTiebreakSet:h,isTimedSet:u,isNumericEnding:g,isNumericValue:A,hasOpener:F,hasOutcome:M,finalSet:d,finalSetIsComplete:p,lastSetIsComplete:R,isInvalidSetTiebreakValue:E&&f&&y,isInvalidMatchTiebreakValue:k,isTiebreakEntry:f,isSetTiebreakEntry:l,isMatchTiebreakEntry:m,isIncompleteSetScore:U,isIncompleteSetTiebreak:y,isIncompleteMatchTiebreak:S,isPartialMatchTiebreakValue:v}}function bm({matchUpScoringFormat:t,isDecidingSet:e,isTiebreakSet:n,setObject:r}){if(!r)return;const i=Mm({set:r}),a=function({ignoreTiebreak:t=!1,matchUpScoringFormat:e,matchUpFormat:n,isTiebreakSet:r,isDecidingSet:i,set:a}){if(!a)return{error:me,info:"missing set"};e=e||n&&Ii(n);const o=i&&e.finalSetFormat||e?.setFormat||{},{side1Score:s,side2Score:c}=a,{setTo:u,tiebreakAt:d,tiebreakFormat:p}=o,l=p?.NoAd,m=Mm({set:a}),f=Math.abs(s-c),h=s>=u||c>=u,I=r||s>=u&&c>=u||d&&d<u&&(s===d||c===d),g=t||I&&(1===m&&a.side1TiebreakScore>a.side2TiebreakScore||2===m&&a.side2TiebreakScore>a.side1TiebreakScore),U=I&&(d&&!r||r&&l)?1:2,y=f>=U;return(h&&(y||I)||r)&&(!I||g)}({matchUpScoringFormat:t,isDecidingSet:e,isTiebreakSet:n,set:r});return a&&i||void 0}function Mm({set:t}){if(t.side1Score||t.side2Score){if(t.side1Score>t.side2Score)return 1;if(t.side2Score>t.side1Score)return 2}else if(t.side1TiebreakScore||t.side2TiebreakScore){if(t.side1TiebreakScore>t.side2TiebreakScore)return 1;if(t.side2TiebreakScore>t.side1TiebreakScore)return 2}}function Am(t){const{setObject:e,matchUpScoringFormat:n}=t;if(!e)return{error:pe};const{setNumber:r}=e||{},{bestOf:i}=n||{},a=!(!r||!i||r!==i),o=a&&n?.finalSetFormat||n?.setFormat,s=!!o?.tiebreakSet,c=!!o?.timed,u=!s&&!c,d=!!(r&&i&&r<=i),p=[e?.side1Score,e?.side2Score],l=[e?.side1PointScore,e?.side2PointScore],m=[e?.side1TiebreakScore,e?.side2TiebreakScore],f=p.filter((t=>void 0!==t)).length,h=l.filter((t=>void 0!==t)).length,I=m.filter((t=>void 0!==t)).length,g=p?.filter((t=>!isNaN(t))).length,U=m?.filter((t=>!isNaN(t))).length,{tiebreakAt:y}=o||{},S=y&&2===p.filter((t=>t>=y)).length,v=S&&((p[0]>p[1]?1:p[1]>p[0]&&2)||void 0),w=!(!U||g),T=!!e?.winningSide,{error:P,result:D}=function({setObject:t,setFormat:e,sideGameScores:n,sideTiebreakScores:r}){if(!t)return{result:!1,error:pe};const i=!!e?.tiebreakSet,a=!!e?.timed;if(!e||i||a)return{result:!1,error:xn};const o=2===n?.filter((t=>!isNaN(t))).length;if(!o)return{result:!1,error:we};const{setTo:s,tiebreakAt:c,tiebreakFormat:u,NoAD:d}=e||{},p=!(!s||!n?.find((t=>t>=s)));if(!p)return{result:!1,error:we};const l=[1,2].includes(t?.winningSide);if(!t||!l)return{result:!1,error:Pe};const m=t?.winningSide-1,f=1-m,h=n[m],I=n[f],g=h-I;if(!(h>I))return{result:!1,error:{message:"winningSide game scoreString is not high"}};const U=c&&u,y=2===r?.filter((t=>!isNaN(t))).length,S=r?.[m],v=r?.[f],w=c&&2===n.filter((t=>t>=c)).length;if(U){const{NoAD:t,tiebreakTo:e}=u;if(w){if(g>1)return{result:!1,error:{message:"invalid winning game scoreString (5)"}};if(!y)return{result:!1,error:{message:"invalid tiebreak scores (1)"}};if(isNaN(e))return{result:!1,error:{message:"tiebreakTo error"}};if(!!(!e||!r?.find((t=>t>=e))))return{result:!1,error:{message:"invalid tiebreak scores (2)"}};if(h>(c<s?s:s+1))return{result:!1,error:{message:"invalid winning game scoreString (1)"}};if(!S||!v||S<v)return{result:!1,error:{message:"winningSide tiebreak value is not high"}};const n=S-v;if(n&&v>=e-1&&n<(t?1:2))return{result:!1,error:{message:"invalid tiebreak scores (3)"}}}if(h>s&&!w)return{result:!1,error:{message:"invalid winning game scoreString (2)"}}}const T=d?1:2,P=I>=s-1,D=g&&P&&!w&&g<T;if(D)return{result:!1,error:{message:"invalid winning game scoreString (3)"}};if(g>T&&h>s)return{result:!1,error:{message:"invalid winning game scoreString (4)"}};return{result:!0}}({setObject:e,setFormat:o,sideGameScores:p,sideTiebreakScores:m}),{error:N,result:R}=function({setObject:t,setFormat:e,sideTiebreakScores:n}){if(!t)return{result:!1,error:pe};const r=!!e?.tiebreakSet,i=!!e?.timed;if(!e||!r||i)return{result:!1,error:{message:"not tiebreak set"}};const a=[1,2].includes(t?.winningSide);if(!t||!a)return{result:!1,error:Pe};const{tiebreakSet:o}=e||{},{NoAD:s,tiebreakTo:c}=o||{},u=2===n?.filter((t=>!isNaN(t))).length;if(!u)return{result:!1,error:{message:"invalid tiebreak scores (1)"}};if(isNaN(c))return{result:!1,error:{message:"tiebreakTo error"}};const d=!!n?.find((t=>t>=c));if(!d)return{result:!1,error:{message:"invalid tiebreak scores (2)"}};const p=t?.winningSide-1,l=1-p,m=n[p],f=n[l];if(!m||!f||m<f)return{result:!1,error:{message:"winningSide tiebreak value is not high"}};const h=s?1:2,I=m-f,g=f>=c-1;if(I&&g&&I<h)return{result:!1,error:{message:"invalid tiebreak scores (3)"}};return{result:!0}}({setObject:e,setFormat:o,sideTiebreakScores:m}),b=u&&!w&&D||s&&w&&R,M={expectTiebreakSet:s,expectTimedSet:c,hasTiebreakCondition:S,isCompletedSet:T,isDecidingSet:a,isTiebreakSet:w,isValidSet:d&&!(s&&!w)&&!(u&&w)&&(!T||b),isValidSetNumber:d,isValidSetOutcome:b,leadingSide:v,setFormat:o,sideGameScores:p,sideGameScoresCount:f,sidePointScores:l,sidePointScoresCount:h,sideTiebreakScores:m,sideTiebreakScoresCount:I,winningSide:bm({isDecidingSet:a,isTiebreakSet:w,matchUpScoringFormat:n,setObject:e})};return void 0!==e?.winningSide&&(w?(M.isValidTiebreakSetOutcome=R,R||(M.tiebreakSetError=N)):(M.isValidStandardSetOutcome=D,D||(M.standardSetError=P))),M}const Em=t=>{const{isSide1:e,lowValue:n,setTo:r,tiebreakAt:i,NoAD:a}=t;if(void 0===n)return!1;let o,s=m(n);s?.toString().length>2&&(s=parseInt(s.toString().slice(0,2))),i&&i<r&&s>i&&(s=i),o=a&&!i?s<r?r:r-1:s+1<r&&r||i&&i<r&&s===i&&r||!i&&s+2||r+1;return[e?s:o,e?o:s]},Cm=t=>{const{isSide1:e,lowValue:n,tiebreakTo:r,tiebreakNoAd:i}=t;if(void 0===n)return!1;let a="string"==typeof n?parseInt(n):n;a?.toString().length>2&&(a=parseInt(a.toString().slice(0,2))),i&&a>r-1&&(a=r-1);const o=function(t){const{lowValue:e,NoAD:n,tiebreakTo:r}=t,i=n?1:2;if(e+1>=r)return e+i;return r}({lowValue:a,NoAD:i,tiebreakTo:r});return[e?a:o,e?o:a]};const Om={stringifyMatchUpFormat:s,isValidMatchUpFormat:Ti,parseMatchUpFormat:Ii,generateTieMatchUpScore:Hp,getTiebreakComplement:Cm,updateTieMatchUpScore:bl,generateScoreString:Ml,checkSetIsComplete:Ol,validateTieFormat:$i,getSetComplement:Em,scoreHasValue:Yp,keyValueScore:function(t){let{lowSide:e=1,value:n}=t,{scoreString:r,sets:i,winningSide:a,matchUpStatus:o}=t;const{matchUpFormat:s,shiftFirst:c,auto:u=!0}=t;let d,p;const l=c&&2===e||!c&&1===e;if(!gm.includes(n))return{updated:!1,info:"invalid key"};c&&(e=3-e);const{matchUpWinningSide:f}=Dm({sets:i,winningSide:a,matchUpStatus:o,matchUpFormat:s});a=f;const h=Rm({value:n,winningSide:a,scoreString:r,sets:i,matchUpFormat:s});if(mm.includes(n)&&(n=pm),h.hasOpener&&h.isTiebreakEntry&&!h.isTiebreakSet&&l&&0===m(n)&&(h.isTiebreakCloser=!0),dm.includes(n)&&h.hasOpener&&(n=""),dm.includes(n)&&(n=cm),h.lastSetIsComplete){const t=r?.length&&r[r.length-1];r&&" "!==t&&(r+=" ")}if(h.isTimedSet)({info:p,sets:i,scoreString:r,updated:d,matchUpStatus:o,winningSide:a}=function(t){let{sets:e,info:n,scoreString:r,winningSide:i,matchUpStatus:a}=t;const{analysis:o,lowSide:s,value:c}=t;let u,d;e?.length||c===tm||(e=[{setNumber:1}]);const p=e.length-1;if(sm.includes(c)){const t=e[e.length-1]||{},{side1Score:d,side2Score:p}=t;d&&!p?n="missing side2Score":o.finalSetIsComplete||i?n="final set is already complete":o.isIncompleteSetScore?n="incomplete set scoreString":o.isIncompleteSetScore||({sets:e,scoreString:r,winningSide:i,matchUpStatus:a,updated:u}=Nm({lowSide:s,value:c,sets:e,scoreString:r,matchUpStatus:a,winningSide:i}))}else if(c===tm){if(({scoreString:r,sets:e,outcomeRemoved:d}=wm({analysis:o,scoreString:r,sets:e})),""===r?.trim()&&(r=r.trim()),r||(e=[]),d){const t=e[e.length-1]||{},{side1Score:n,side2Score:r}=t;if(n&&r){const i=(n>r?1:r>n&&2)||void 0;i&&(t.winningSide=i,e.push({setNumber:e.length+1}))}}a=void 0,i=void 0,u=!0}else if(o.hasOutcome)n="has outcome";else{if(i)return{sets:e,scoreString:r,winningSide:i,matchUpStatus:a,updated:!1,info:"matchUp is complete"};if(c===cm){const t=e[e.length-1]||{},{side1Score:n,side2Score:a}=t,s=(n>a?1:a>n&&2)||void 0;!s||i||o.isIncompleteSetScore||(e[e.length-1].winningSide=s,e.push({setNumber:e.length+1}),r+=" ",u=!0)}else if(c===pm&&void 0!==e[p].side1Score&&void 0===e[p].side2Score&&r&&o.isNumericEnding)r+="-",e[p].side2Score=0,a=void 0,i=void 0,u=!0;else if(!isNaN(c)){let t;if(void 0===e[p].side2Score){const n=m((e[p].side1Score||0).toString()+c).toString().slice(0,2);e[p].side1Score=m(n),t=e[p].side1Score.toString(),u=!0}else{const n=m((e[p].side2Score||0).toString()+c).toString().slice(0,2);e[p].side2Score=m(n),t=[e[p].side1Score,e[p].side2Score].join("-"),u=!0}if(u){const n=(e.slice(0,p)||[]).filter((t=>t)).map((t=>{const{side1Score:e,side2Score:n}=t;return[e,n].join("-")})).join(" ");r=n?n+" "+t:t}}}return{sets:e,scoreString:r,winningSide:i,matchUpStatus:a,info:n,updated:u}}({analysis:h,lowSide:e,scoreString:r,sets:i,matchUpStatus:o,winningSide:a,value:n}));else if(sm.includes(n))h.finalSetIsComplete||a?p="final set is already complete":h.isTiebreakEntry||h.isIncompleteSetScore?h.isTiebreakEntry||h.isIncompleteSetScore?p="incomplete set scoreString or tiebreak entry":console.log("handle case",{value:n}):({sets:i,scoreString:r,matchUpStatus:o,winningSide:a,updated:d}=Nm({lowSide:e,sets:i,scoreString:r,matchUpStatus:o,winningSide:a,value:n}));else if(n===tm)d=!0,({scoreString:r,sets:i}=wm({analysis:h,scoreString:r,sets:i,lowSide:e})),r||(i=[]),o=void 0,a=void 0;else if(h.hasOutcome)p="has outcome";else if(n!==pm||h.isMatchTiebreakEntry)if(n===lm&&h.isMatchTiebreakEntry&&!h.isSetTiebreakEntry)h.matchTiebreakHasJoiner?p="existing joiner":h.isNumericEnding&&(d=!0,r+=lm);else if([pm,lm].includes(n))p="invalid location for joiner";else{if(a)return{updated:!1,info:"matchUp is complete"};if(h.isIncompleteSetScore)h.isNumericValue&&({sets:i,scoreString:r,updated:d}=function({analysis:t,scoreString:e,sets:n,value:r}){let i;if(!n?.length)return{sets:[]};const a=n[n.length-1];r=m(r);const{validSide2Score:o,requiresTiebreak:s}=function({analysis:t,set:e={},value:n}){const r=t.isDecidingSet&&t.matchUpScoringFormat.finalSetFormat||t.matchUpScoringFormat.setFormat,{tiebreakAt:i,setTo:a,NoAD:o}=r,{side1Score:s}=e;let c,u;return c=i&&i<a?s===i?n<=a:n<=i:s===a?o?n<a:n<=a+1:s===a-1?o?n<=a:n<=a+1:s===a+1?n===a||n===a-1:n<=a,c&&(u=i&&i<a?s===a&&n===i||s===i&&n===a:s>=a&&n>=a&&s!==n),{validSide2Score:c,requiresTiebreak:u}}({analysis:t,set:a,value:r});if(o){i=!0,e=(e||"")+r,a.side2Score=r;const o=Cl({analysis:t,set:n[n.length-1]});a.winningSide=o||void 0,s?e+=Jl.split("")[0]:t.isDecidingSet||(e+=kl)}return{sets:n,scoreString:e,updated:i}}({analysis:h,scoreString:r,sets:i,value:n}));else if(h.isInvalidMatchTiebreakValue)p="invalid matchUp tiebreak character";else if(h.isInvalidSetTiebreakValue)p="invalid set tiebreak character";else if(h.isTiebreakCloser){const t=h.isSetTiebreakEntry?Jl:Ql,e=t.split("").reverse()[0],n=t.split("")[0],a=i[i.length-1],{tiebreakFormat:o}=h.setFormat,{tiebreakTo:s,NoAD:c}=o||{},u=Fl({set:a});if(!h.isTiebreakSet){const t=parseInt(r.split(n).reverse()[0]),e=Pm({lowValue:t,tiebreakTo:s,NoAD:c});1===u?(a.side1TiebreakScore=e,a.side2TiebreakScore=t):(a.side1TiebreakScore=t,a.side2TiebreakScore=e)}r=(r||"")+e,h.isDecidingSet||(r+=kl);const p=Cl({analysis:h,set:a});a.winningSide=p||void 0,d=!0}else if(h.isTiebreakSetValue)({info:p,scoreString:r,sets:i,updated:d}=function({analysis:t,auto:e,lowSide:n,scoreString:r="",sets:i,value:a}){let o,s;const{tiebreakSet:{tiebreakTo:c,NoAD:u}}=t.setFormat,[d]=Ql.split("");if(t.isMatchTiebreakEntry||(r+=d),i[t.setNumber-1]){const{lastOpenBracketIndex:t}=Tm({brackets:Ql,scoreString:r}),d=(r.slice((t??0)+1)+(e?"":a)).split(lm);if((d[n-1]?.length||0)>=2)s="tiebreak digit limit";else if(e){1===n&&(d[0]=(d[0]||"")+a),2===n&&(d[1]=(d[1]||"")+a);const e=[d[0]||0,d[1]||0].map((t=>m(t))),s=1===n?1:0;e[s]=e[1-s]+(u?1:2),e[s]<c&&(e[s]=c);const p=i[i.length-1];p.side1TiebreakScore=e[0],p.side2TiebreakScore=e[1],r=r.slice(0,(t??0)+1),r+=e.join(lm),o=!0}else{const t=[d[0]||0,d[1]||0].map((t=>m(t))),e=i[i.length-1];e.side1TiebreakScore=t[0],e.side2TiebreakScore=t[1],r+=a,o=!0}}else{const t=Pm({lowValue:m(a||0),tiebreakTo:c,NoAD:u}),e=[m(a),t];2===n&&e.reverse();const s={side1TiebreakScore:e[0],side2TiebreakScore:e[1],setNumber:i?.length+1||1};i.push(s),r+=e.join(lm),o=!0}return{info:s,scoreString:r,sets:i,updated:o}}({analysis:h,auto:u,lowSide:e,scoreString:r,sets:i,value:n}));else if(h.isSetTiebreakEntry){const[t]=Jl.split(""),e=Math.max(...C(t,r.split(""))),i=r.slice(e+1),a=i&&0===m(i),o=m(i?i+n:n),{tiebreakFormat:s}=h.setFormat,{tiebreakTo:c,NoAD:u}=s||{};!a&&i.length<2?u&&o>c-1?p="invalid low value for NoAD tiebreak":(d=!0,r=(r||"")+n):p=a?"tiebreak begins with zero":"tiebreak digit limit"}else if(h.isCloser)p=`invalid key: ${n}`;else if(h.isGameScoreEntry)p="game scoreString entry";else if(h.lastSetIsComplete||!i.length){d=!0;const{scoreString:t,set:a}=function({analysis:t,lowSide:e,scoreString:n,value:r}){const{setTo:i,tiebreakAt:a,NoAD:o}=t?.setFormat||{},s=r===parseInt(a||i);if(a&&a<i&&r>a)return{scoreString:n};if(o&&r===i||r>i)return{scoreString:n};const c=s?r+1:r+1===i?r+(o?1:2):i,u=[r,c];2===e&&u.reverse();const d=Jl.split("")[0];n=(n||"")+(u.join(pm)+(s?d:kl));const p={side1Score:u[0],side2Score:u[1]},l=Cl({analysis:t,set:p});return p.winningSide=l||void 0,{scoreString:n,set:p}}({analysis:h,lowSide:e,scoreString:r,value:m(n)});a&&(a.setNumber=i?.length+1||1),i=i?.concat(a).filter(Boolean)||[a],r=t||void 0}else console.log("error: unknown outcome")}else(!h.isSetTiebreakEntry||h.isSetTiebreakEntry&&!h.isNumericEnding)&&(d=!0,({scoreString:r,sets:i}=wm({analysis:h,scoreString:r,sets:i,lowSide:e})),o=void 0);if(d){i=i?.filter(Boolean);const{matchUpWinningSide:t}=Dm({sets:i,winningSide:a,matchUpStatus:o,matchUpFormat:s});return a=t,!t||o&&![sa,ra].includes(o)?!r||a||[Hl,Wl,Yl].includes(o)||(o=void 0):(o="COMPLETED",i=i.filter((t=>{const{side1Score:e,side2Score:n,side1TiebreakScore:r,side2TiebreakScore:i}=t;return e||n||r||i}))),{updated:d,scoreString:r,sets:i,winningSide:a,matchUpStatus:o,info:p}}return{updated:d,scoreString:r,sets:i,winningSide:a,matchUpStatus:o,info:p}},validateScore:El,reverseScore:function(t){if(!t?.score)return{error:me};const{sets:e}=t.score,n=e.map((t=>{const{side1TiebreakScore:e,side2TiebreakScore:n,winningSide:r,side1Score:i,side2Score:a,setNumber:o}=t;return di({winningSide:r?3-r:void 0,side1TiebreakScore:n,side2TiebreakScore:e,side1Score:a,side2Score:i,setNumber:o})}));return{reversedScore:{sets:n,scoreStringSide1:Ml({sets:n}),scoreStringSide2:Ml({sets:n,reversed:!0})},...L}},analyzeSet:Am};const Fm=[{ioc:"",iso2:"",iso:"",label:"NONE",phone:""},{ioc:"AND",iso2:"AD",iso:"AND",label:"Andorra",phone:"376"},{ioc:"UAE",iso2:"AE",iso:"ARE",label:"United Arab Emirates",phone:"971"},{ioc:"AFG",iso2:"AF",iso:"AFG",label:"Afghanistan",phone:"93"},{ioc:"ANT",iso2:"AG",iso:"ATG",label:"Antigua and Barbuda",phone:"1-268"},{ioc:"AIA",iso2:"AI",iso:"AIA",label:"Anguilla",phone:"1-264"},{ioc:"ALB",iso2:"AL",iso:"ALB",label:"Albania",phone:"355"},{ioc:"ARM",iso2:"AM",iso:"ARM",label:"Armenia",phone:"374"},{ioc:"ANG",iso2:"AO",iso:"AGO",label:"Angola",phone:"244"},{ioc:"",iso2:"AQ",iso:"ATA",label:"Antarctica",phone:"672"},{ioc:"ARG",iso2:"AR",iso:"ARG",label:"Argentina",phone:"54"},{ioc:"ASA",iso2:"AS",iso:"ASM",label:"American Samoa",phone:"1-684"},{ioc:"AUT",iso2:"AT",iso:"AUT",label:"Austria",phone:"43"},{ioc:"AUS",iso2:"AU",iso:"AUS",label:"Australia",phone:"61",suggested:!0},{ioc:"ARU",iso2:"AW",iso:"ABW",label:"Aruba",phone:"297"},{ioc:"AZE",iso2:"AZ",iso:"AZE",label:"Azerbaijan",phone:"994"},{ioc:"BIH",iso2:"BA",iso:"BIH",label:"Bosnia and Herzegovina",phone:"387"},{ioc:"BAR",iso2:"BB",iso:"BRB",label:"Barbados",phone:"1-246"},{ioc:"BAN",iso2:"BD",iso:"BGD",label:"Bangladesh",phone:"880"},{ioc:"BEL",iso2:"BE",iso:"BEL",label:"Belgium",phone:"32"},{ioc:"BUR",iso2:"BF",iso:"BFA",label:"Burkina Faso",phone:"226"},{ioc:"BUL",iso2:"BG",iso:"BGR",label:"Bulgaria",phone:"359"},{ioc:"BRN",iso2:"BH",iso:"BHR",label:"Bahrain",phone:"973"},{ioc:"BDI",iso2:"BI",iso:"BDI",label:"Burundi",phone:"257"},{ioc:"BEN",iso2:"BJ",iso:"BEN",label:"Benin",phone:"229"},{ioc:"",iso2:"BL",iso:"BLM",label:"Saint Barthelemy",phone:"590"},{ioc:"BER",iso2:"BM",iso:"BMU",label:"Bermuda",phone:"1-441"},{ioc:"BRU",iso2:"BN",iso:"BRN",label:"Brunei Darussalam",phone:"673"},{ioc:"BOL",iso2:"BO",iso:"BOL",label:"Bolivia",phone:"591"},{ioc:"BRA",iso2:"BR",iso:"BRA",label:"Brazil",phone:"55"},{ioc:"BAH",iso2:"BS",iso:"BHS",label:"Bahamas",phone:"1-242"},{ioc:"BHU",iso2:"BT",iso:"BTN",label:"Bhutan",phone:"975"},{ioc:"",iso2:"BV",iso:"BVT",label:"Bouvet Island",phone:"47"},{ioc:"BOT",iso2:"BW",iso:"BWA",label:"Botswana",phone:"267"},{ioc:"BLR",iso2:"BY",iso:"BLR",label:"Belarus",phone:"375"},{ioc:"BIZ",iso2:"BZ",iso:"BLZ",label:"Belize",phone:"501"},{ioc:"CAN",iso2:"CA",iso:"CAN",label:"Canada",phone:"1",suggested:!0},{ioc:"",iso2:"CC",iso:"CCK",label:"Cocos (Keeling) Islands",phone:"61"},{ioc:"CGO",iso2:"CD",iso:"COG",label:"Congo, Republic of the",phone:"242"},{ioc:"CAF",iso2:"CF",iso:"CAF",label:"Central African Republic",phone:"236"},{ioc:"COD",iso2:"CG",iso:"CGD",label:"Congo, Democratic Republic of the",phone:"243"},{ioc:"SUI",iso2:"CH",iso:"CHE",label:"Switzerland",phone:"41"},{ioc:"CIV",iso2:"CI",iso:"CIV",label:"Cote d'Ivoire",phone:"225"},{ioc:"COK",iso2:"CK",iso:"COK",label:"Cook Islands",phone:"682"},{ioc:"CHI",iso2:"CL",iso:"CHL",label:"Chile",phone:"56"},{ioc:"CMR",iso2:"CM",iso:"CMR",label:"Cameroon",phone:"237"},{ioc:"CHN",iso2:"CN",iso:"CHN",label:"China",phone:"86"},{ioc:"COL",iso2:"CO",iso:"COL",label:"Colombia",phone:"57"},{ioc:"CRC",iso2:"CR",iso:"CRI",label:"Costa Rica",phone:"506"},{ioc:"CUB",iso2:"CU",iso:"CUB",label:"Cuba",phone:"53"},{ioc:"CPV",iso2:"CV",iso:"CPV",label:"Cape Verde",phone:"238"},{ioc:"CUW",iso2:"CW",iso:"CUW",label:"Curacao",phone:"599"},{ioc:"CXR",iso2:"CX",iso:"CXR",label:"Christmas Island",phone:"61"},{ioc:"CYP",iso2:"CY",iso:"CYP",label:"Cyprus",phone:"357"},{ioc:"CZE",iso2:"CZ",iso:"CZE",label:"Czech Republic",phone:"420"},{ioc:"GER",iso2:"DE",iso:"DEU",label:"Germany",phone:"49",suggested:!0},{ioc:"DJI",iso2:"DJ",iso:"DJI",label:"Djibouti",phone:"253"},{ioc:"DEN",iso2:"DK",iso:"DNK",label:"Denmark",phone:"45"},{ioc:"DMA",iso2:"DM",iso:"DMA",label:"Dominica",phone:"1-767"},{ioc:"DOM",iso2:"DO",iso:"DOM",label:"Dominican Republic",phone:"1-809"},{ioc:"ALG",iso2:"DZ",iso:"DZA",label:"Algeria",phone:"213"},{ioc:"ECU",iso2:"EC",iso:"ECU",label:"Ecuador",phone:"593"},{ioc:"EST",iso2:"EE",iso:"ESE",label:"Estonia",phone:"372"},{ioc:"EGY",iso2:"EG",iso:"EGY",label:"Egypt",phone:"20"},{ioc:"",iso2:"EH",iso:"ESH",label:"Western Sahara",phone:"212"},{ioc:"ERI",iso2:"ER",iso:"ERI",label:"Eritrea",phone:"291"},{ioc:"ESP",iso2:"ES",iso:"ESP",label:"Spain",phone:"34"},{ioc:"ETH",iso2:"ET",iso:"ETH",label:"Ethiopia",phone:"251"},{ioc:"FIN",iso2:"FI",iso:"FIN",label:"Finland",phone:"358"},{ioc:"FIJ",iso2:"FJ",iso:"FJI",label:"Fiji",phone:"679"},{ioc:"FLK",iso2:"FK",iso:"FLK",label:"Falkland Islands (Malvinas)",phone:"500"},{ioc:"FSM",iso2:"FM",iso:"FSM",label:"Micronesia, Federated States of",phone:"691"},{ioc:"FAR",iso2:"FO",iso:"FRO",label:"Faroe Islands",phone:"298"},{ioc:"FRA",iso2:"FR",iso:"FRA",label:"France",phone:"33",suggested:!0},{ioc:"GAB",iso2:"GA",iso:"GAB",label:"Gabon",phone:"241"},{ioc:"GBR",iso2:"GB",iso:"GBR",label:"United Kingdom",phone:"44"},{ioc:"GRN",iso2:"GD",iso:"GRD",label:"Grenada",phone:"1-473"},{ioc:"GEO",iso2:"GE",iso:"GEO",label:"Georgia",phone:"995"},{ioc:"FGU",iso2:"GF",iso:"GUF",label:"French Guiana",phone:"594"},{ioc:"",iso2:"GG",iso:"GGY",label:"Guernsey",phone:"44"},{ioc:"",iso2:"GH",iso:"GHA",label:"Ghana",phone:"233"},{ioc:"GIB",iso2:"GI",iso:"GIB",label:"Gibraltar",phone:"350"},{ioc:"GRL",iso2:"GL",iso:"GRL",label:"Greenland",phone:"299"},{ioc:"GAM",iso2:"GM",iso:"GMB",label:"Gambia",phone:"220"},{ioc:"GUI",iso2:"GN",iso:"GIN",label:"Guinea",phone:"224"},{ioc:"GUD",iso2:"GP",iso:"GLP",label:"Guadeloupe",phone:"590"},{ioc:"GEQ",iso2:"GQ",iso:"GNQ",label:"Equatorial Guinea",phone:"240"},{ioc:"GRE",iso2:"GR",iso:"GRC",label:"Greece",phone:"30"},{ioc:"",iso2:"GS",iso:"SGS",label:"South Georgia and the South Sandwich Islands",phone:"500"},{ioc:"GUA",iso2:"GT",iso:"GTM",label:"Guatemala",phone:"502"},{ioc:"GUM",iso2:"GU",iso:"GUM",label:"Guam",phone:"1-671"},{ioc:"GBS",iso2:"GW",iso:"GNB",label:"Guinea-Bissau",phone:"245"},{ioc:"GUY",iso2:"GY",iso:"GUY",label:"Guyana",phone:"592"},{ioc:"HKG",iso2:"HK",iso:"HKG",label:"Hong Kong",phone:"852"},{ioc:"",iso2:"HM",iso:"HMD",label:"Heard Island and McDonald Islands",phone:"672"},{ioc:"HON",iso2:"HN",iso:"HND",label:"Honduras",phone:"504"},{ioc:"CRO",iso2:"HR",iso:"HRV",label:"Croatia",phone:"385"},{ioc:"HAI",iso2:"HT",iso:"HTI",label:"Haiti",phone:"509"},{ioc:"HUN",iso2:"HU",iso:"HUN",label:"Hungary",phone:"36"},{ioc:"INA",iso2:"ID",iso:"IDN",label:"Indonesia",phone:"62"},{ioc:"IRL",iso2:"IE",iso:"IRL",label:"Ireland",phone:"353"},{ioc:"ISR",iso2:"IL",iso:"ISR",label:"Israel",phone:"972"},{ioc:"",iso2:"IM",iso:"IMN",label:"Isle of Man",phone:"44"},{ioc:"IND",iso2:"IN",iso:"IND",label:"India",phone:"91"},{ioc:"",iso2:"IO",iso:"IOT",label:"British Indian Ocean Territory",phone:"246"},{ioc:"IRQ",iso2:"IQ",iso:"IRQ",label:"Iraq",phone:"964"},{ioc:"IRI",iso2:"IR",iso:"IRN",label:"Iran, Islamic Republic of",phone:"98"},{ioc:"ISL",iso2:"IS",iso:"ISL",label:"Iceland",phone:"354"},{ioc:"ITA",iso2:"IT",iso:"ITA",label:"Italy",phone:"39"},{ioc:"",iso2:"JE",iso:"JEY",label:"Jersey",phone:"44"},{ioc:"JAM",iso2:"JM",iso:"JAM",label:"Jamaica",phone:"1-876"},{ioc:"JOR",iso2:"JO",iso:"JOR",label:"Jordan",phone:"962"},{ioc:"JPN",iso2:"JP",iso:"JPN",label:"Japan",phone:"81",suggested:!0},{ioc:"KEN",iso2:"KE",iso:"KEN",label:"Kenya",phone:"254"},{ioc:"KGZ",iso2:"KG",iso:"KGZ",label:"Kyrgyzstan",phone:"996"},{ioc:"CAM",iso2:"KH",iso:"KHM",label:"Cambodia",phone:"855"},{ioc:"KIR",iso2:"KI",iso:"KIR",label:"Kiribati",phone:"686"},{ioc:"COM",iso2:"KM",iso:"COM",label:"Comoros",phone:"269"},{ioc:"SKN",iso2:"KN",iso:"KNA",label:"Saint Kitts and Nevis",phone:"1-869"},{ioc:"KOR",iso2:"KP",iso:"KOR",label:"Korea, Democratic People's Republic of",phone:"850"},{ioc:"PRK",iso2:"KR",iso:"PRK",label:"Korea, Republic of",phone:"82"},{ioc:"KUW",iso2:"KW",iso:"KWT",label:"Kuwait",phone:"965"},{ioc:"CAY",iso2:"KY",iso:"CYM",label:"Cayman Islands",phone:"1-345"},{ioc:"KAZ",iso2:"KZ",iso:"KAZ",label:"Kazakhstan",phone:"7"},{ioc:"LAO",iso2:"LA",iso:"LAO",label:"Lao People's Democratic Republic",phone:"856"},{ioc:"LIB",iso2:"LB",iso:"LBN",label:"Lebanon",phone:"961"},{ioc:"LCA",iso2:"LC",iso:"LCA",label:"Saint Lucia",phone:"1-758"},{ioc:"LIE",iso2:"LI",iso:"LIE",label:"Liechtenstein",phone:"423"},{ioc:"SRI",iso2:"LK",iso:"LKA",label:"Sri Lanka",phone:"94"},{ioc:"LBR",iso2:"LR",iso:"LBR",label:"Liberia",phone:"231"},{ioc:"LES",iso2:"LS",iso:"LSO",label:"Lesotho",phone:"266"},{ioc:"LTU",iso2:"LT",iso:"LTU",label:"Lithuania",phone:"370"},{ioc:"LUX",iso2:"LU",iso:"LUX",label:"Luxembourg",phone:"352"},{ioc:"LAT",iso2:"LV",iso:"LVA",label:"Latvia",phone:"371"},{ioc:"LBA",iso2:"LY",iso:"LBY",label:"Libya",phone:"218"},{ioc:"MAR",iso2:"MA",iso:"MAR",label:"Morocco",phone:"212"},{ioc:"MON",iso2:"MC",iso:"MCO",label:"Monaco",phone:"377"},{ioc:"MDA",iso2:"MD",iso:"MDA",label:"Moldova, Republic of",phone:"373"},{ioc:"MNE",iso2:"ME",iso:"MNE",label:"Montenegro",phone:"382"},{ioc:"",iso2:"MF",iso:"MAF",label:"Saint Martin (French part)",phone:"590"},{ioc:"MAD",iso2:"MG",iso:"MDG",label:"Madagascar",phone:"261"},{ioc:"MSH",iso2:"MH",iso:"MHL",label:"Marshall Islands",phone:"692"},{ioc:"MKD",iso2:"MK",iso:"MKD",label:"Macedonia, the Former Yugoslav Republic of",phone:"389"},{ioc:"MLI",iso2:"ML",iso:"MLI",label:"Mali",phone:"223"},{ioc:"MYA",iso2:"MM",iso:"MMR",label:"Myanmar",phone:"95"},{ioc:"MGL",iso2:"MN",iso:"MNG",label:"Mongolia",phone:"976"},{ioc:"MAC",iso2:"MO",iso:"MAC",label:"Macao",phone:"853"},{ioc:"NMA",iso2:"MP",iso:"NMP",label:"Northern Mariana Islands",phone:"1-670"},{ioc:"MRT",iso2:"MQ",iso:"MTQ",label:"Martinique",phone:"596"},{ioc:"MTN",iso2:"MR",iso:"MRT",label:"Mauritania",phone:"222"},{ioc:"MNT",iso2:"MS",iso:"MSR",label:"Montserrat",phone:"1-664"},{ioc:"MLT",iso2:"MT",iso:"MLT",label:"Malta",phone:"356"},{ioc:"MRI",iso2:"MU",iso:"MUS",label:"Mauritius",phone:"230"},{ioc:"MDV",iso2:"MV",iso:"MDV",label:"Maldives",phone:"960"},{ioc:"MAW",iso2:"MW",iso:"MWI",label:"Malawi",phone:"265"},{ioc:"MEX",iso2:"MX",iso:"MEX",label:"Mexico",phone:"52"},{ioc:"MAS",iso2:"MY",iso:"MYS",label:"Malaysia",phone:"60"},{ioc:"MOZ",iso2:"MZ",iso:"MOZ",label:"Mozambique",phone:"258"},{ioc:"NAM",iso2:"NA",iso:"NAM",label:"Namibia",phone:"264"},{ioc:"NCL",iso2:"NC",iso:"NCL",label:"New Caledonia",phone:"687"},{ioc:"NIG",iso2:"NE",iso:"NER",label:"Niger",phone:"227"},{ioc:"NFI",iso2:"NF",iso:"NFK",label:"Norfolk Island",phone:"672"},{ioc:"NGR",iso2:"NG",iso:"NGA",label:"Nigeria",phone:"234"},{ioc:"NCA",iso2:"NI",iso:"NIC",label:"Nicaragua",phone:"505"},{ioc:"NED",iso2:"NL",iso:"NLD",label:"Netherlands",phone:"31"},{ioc:"NOR",iso2:"NO",iso:"NOR",label:"Norway",phone:"47"},{ioc:"NEP",iso2:"NP",iso:"NPL",label:"Nepal",phone:"977"},{ioc:"NRU",iso2:"NR",iso:"NRU",label:"Nauru",phone:"674"},{ioc:"NIU",iso2:"NU",iso:"NIU",label:"Niue",phone:"683"},{ioc:"NZL",iso2:"NZ",iso:"NZL",label:"New Zealand",phone:"64"},{ioc:"OMA",iso2:"OM",iso:"OMN",label:"Oman",phone:"968"},{ioc:"PAN",iso2:"PA",iso:"PAN",label:"Panama",phone:"507"},{ioc:"PER",iso2:"PE",iso:"PER",label:"Peru",phone:"51"},{ioc:"FPO",iso2:"PF",iso:"PYF",label:"French Polynesia",phone:"689"},{ioc:"PNG",iso2:"PG",iso:"PNG",label:"Papua New Guinea",phone:"675"},{ioc:"PHI",iso2:"PH",iso:"PHL",label:"Philippines",phone:"63"},{ioc:"PAK",iso2:"PK",iso:"PAK",label:"Pakistan",phone:"92"},{ioc:"POL",iso2:"PL",iso:"POL",label:"Poland",phone:"48"},{ioc:"SPM",iso2:"PM",iso:"SPM",label:"Saint Pierre and Miquelon",phone:"508"},{ioc:"",iso2:"PN",iso:"PCN",label:"Pitcairn",phone:"870"},{ioc:"PUR",iso2:"PR",iso:"PRI",label:"Puerto Rico",phone:"1"},{ioc:"PLE",iso2:"PS",iso:"PSE",label:"Palestine, State of",phone:"970"},{ioc:"POR",iso2:"PT",iso:"PRT",label:"Portugal",phone:"351"},{ioc:"PLW",iso2:"PW",iso:"PLW",label:"Palau",phone:"680"},{ioc:"PAR",iso2:"PY",iso:"PRY",label:"Paraguay",phone:"595"},{ioc:"QAT",iso2:"QA",iso:"QAT",label:"Qatar",phone:"974"},{ioc:"REU",iso2:"RE",iso:"REU",label:"Reunion",phone:"262"},{ioc:"ROU",iso2:"RO",iso:"ROU",label:"Romania",phone:"40"},{ioc:"SRB",iso2:"RS",iso:"SRB",label:"Serbia",phone:"381"},{ioc:"RUS",iso2:"RU",iso:"RUS",label:"Russia",phone:"7"},{ioc:"RWA",iso2:"RW",iso:"RWA",label:"Rwanda",phone:"250"},{ioc:"KSA",iso2:"SA",iso:"SAU",label:"Saudi Arabia",phone:"966"},{ioc:"SOL",iso2:"SB",iso:"SLB",label:"Solomon Islands",phone:"677"},{ioc:"SEY",iso2:"SC",iso:"SYC",label:"Seychelles",phone:"248"},{ioc:"SUD",iso2:"SD",iso:"SDN",label:"Sudan",phone:"249"},{ioc:"SWE",iso2:"SE",iso:"SWE",label:"Sweden",phone:"46"},{ioc:"SIN",iso2:"SG",iso:"SGP",label:"Singapore",phone:"65"},{ioc:"HEL",iso2:"SH",iso:"SHN",label:"Saint Helena",phone:"290"},{ioc:"SLO",iso2:"SI",iso:"SVN",label:"Slovenia",phone:"386"},{ioc:"",iso2:"SJ",iso:"SJM",label:"Svalbard and Jan Mayen",phone:"47"},{ioc:"SVK",iso2:"SK",iso:"SVK",label:"Slovakia",phone:"421"},{ioc:"SLE",iso2:"SL",iso:"SLE",label:"Sierra Leone",phone:"232"},{ioc:"SMR",iso2:"SM",iso:"SMR",label:"San Marino",phone:"378"},{ioc:"SEN",iso2:"SN",iso:"SEN",label:"Senegal",phone:"221"},{ioc:"SOM",iso2:"SO",iso:"SOM",label:"Somalia",phone:"252"},{ioc:"SUR",iso2:"SR",iso:"SUR",label:"Suriname",phone:"597"},{ioc:"",iso2:"SS",iso:"SSD",label:"South Sudan",phone:"211"},{ioc:"STP",iso2:"ST",iso:"STP",label:"Sao Tome and Principe",phone:"239"},{ioc:"ESA",iso2:"SV",iso:"SLV",label:"El Salvador",phone:"503"},{ioc:"",iso2:"SX",iso:"SMX",label:"Sint Maarten",phone:"1-721"},{ioc:"SYR",iso2:"SY",iso:"SYR",label:"Syria",phone:"963"},{ioc:"",iso2:"SZ",iso:"SWZ",label:"Swaziland",phone:"268"},{ioc:"TKS",iso2:"TC",iso:"TCA",label:"Turks and Caicos Islands",phone:"1-649"},{ioc:"CHA",iso2:"TD",iso:"TCD",label:"Chad",phone:"235"},{ioc:"",iso2:"TF",iso:"ATF",label:"French Southern Territories",phone:"262"},{ioc:"TOG",iso2:"TG",iso:"TGO",label:"Togo",phone:"228"},{ioc:"THA",iso2:"TH",iso:"THA",label:"Thailand",phone:"66"},{ioc:"TJK",iso2:"TJ",iso:"TJK",label:"Tajikistan",phone:"992"},{ioc:"",iso2:"TK",iso:"TKL",label:"Tokelau",phone:"690"},{ioc:"TLS",iso2:"TL",iso:"TLS",label:"Timor-Leste",phone:"670"},{ioc:"TKM",iso2:"TM",iso:"TKM",label:"Turkmenistan",phone:"993"},{ioc:"TUN",iso2:"TN",iso:"TUN",label:"Tunisia",phone:"216"},{ioc:"TGA",iso2:"TO",iso:"TON",label:"Tonga",phone:"676"},{ioc:"TUR",iso2:"TR",iso:"TUR",label:"Turkey",phone:"90"},{ioc:"TTO",iso2:"TT",iso:"TTO",label:"Trinidad and Tobago",phone:"1-868"},{ioc:"TUV",iso2:"TV",iso:"TUV",label:"Tuvalu",phone:"688"},{ioc:"TPE",iso2:"TW",iso:"TWN",label:"Taiwan",phone:"886"},{ioc:"TAN",iso2:"TZ",iso:"TZA",label:"United Republic of Tanzania",phone:"255"},{ioc:"UKR",iso2:"UA",iso:"UKR",label:"Ukraine",phone:"380"},{ioc:"UGA",iso2:"UG",iso:"UGA",label:"Uganda",phone:"256"},{ioc:"USA",iso2:"US",label:"United States",phone:"1",suggested:!0,iso:"USA"},{ioc:"URU",iso2:"UY",iso:"URY",label:"Uruguay",phone:"598"},{ioc:"UZB",iso2:"UZ",iso:"UZB",label:"Uzbekistan",phone:"998"},{ioc:"",iso2:"VA",iso:"VAT",label:"Holy See (Vatican City State)",phone:"379"},{ioc:"VIN",iso2:"VC",iso:"VCT",label:"Saint Vincent and the Grenadines",phone:"1-784"},{ioc:"VEN",iso2:"VE",iso:"VEN",label:"Venezuela",phone:"58"},{ioc:"IVB",iso2:"VG",iso:"VGB",label:"British Virgin Islands",phone:"1-284"},{ioc:"ISV",iso2:"VI",iso:"VIR",label:"US Virgin Islands",phone:"1-340"},{ioc:"VIE",iso2:"VN",iso:"VNM",label:"Vietnam",phone:"84"},{ioc:"VAN",iso2:"VU",iso:"VUT",label:"Vanuatu",phone:"678"},{ioc:"WAF",iso2:"WF",iso:"WLF",label:"Wallis and Futuna",phone:"681"},{ioc:"SAM",iso2:"WS",iso:"WSM",label:"Samoa",phone:"685"},{ioc:"KOS",iso2:"XK",iso:"KOS",label:"Kosovo",phone:"383"},{ioc:"YEM",iso2:"YE",iso:"YEM",label:"Yemen",phone:"967"},{ioc:"MAY",iso2:"YT",iso:"MYT",label:"Mayotte",phone:"262"},{ioc:"RSA",iso2:"ZA",iso:"ZAF",label:"South Africa",phone:"27"},{ioc:"ZAM",iso2:"ZM",iso:"ZMB",label:"Zambia",phone:"260"},{ioc:"ZIM",iso2:"ZW",iso:"ZWE",label:"Zimbabwe",phone:"263"}],km="ELO",xm="NTRP",_m="WTN",Lm={ELO:km,NTRP:xm,TRN:"TRN",UTR:"UTR",WTN:_m},Bm={[km]:{defaultInitialization:1500,decimalsCount:0,range:[0,3e3],ascending:!0},[xm]:{accessors:["ntrpRating","dntrpRatingHundredths"],attributes:{ustaRatingType:""},accessor:"dntrpRatingHundredths",defaultInitialization:3,decimalsCount:1,ascending:!0,range:[1,7]},UTR:{defaultInitialization:6,accessors:["utrRating"],accessor:"utrRating",decimalsCount:2,ascending:!0,range:[1,16]},[_m]:{attributes:{confidence:{generator:!0,range:[60,100]}},accessors:["wtnRating","confidence"],defaultInitialization:23,accessor:"wtnRating",ascending:!1,decimalsCount:2,range:[40,1]}};var Vm={collectionDefinitions:[{collectionName:"Doubles",matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Singles",matchUpCount:2,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1}],tieFormatName:"DOMINANT_DUO",winCriteria:{valueGoal:2}},jm={collectionDefinitions:[{collectionName:"Mixed Doubles",gender:"MIXED",matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Male Singles",matchUpCount:1,gender:"MALE",matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Female Singles",gender:"FEMALE",matchUpCount:1,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1}],tieFormatName:"DOMINANT_DUO_MIXED",winCriteria:{valueGoal:2}},Gm={collectionDefinitions:[{collectionGroupNumber:1,matchUpType:"DOUBLES",matchUpCount:1,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpValue:1},{collectionGroupNumber:1,matchUpType:"SINGLES",matchUpCount:3,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpValue:1},{collectionGroupNumber:2,matchUpType:"DOUBLES",matchUpCount:1,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpValue:2},{collectionGroupNumber:2,matchUpType:"SINGLES",matchUpCount:3,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpValue:2},{collectionGroupNumber:3,matchUpType:"DOUBLES",matchUpCount:1,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpValue:3},{collectionGroupNumber:3,matchUpType:"SINGLES",matchUpCount:3,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpValue:3}],collectionGroups:[{groupNumber:1,groupName:"Day 1"},{groupNumber:2,groupName:"Day 2"},{groupNumber:3,groupName:"Day 3"}],tieFormatName:"LAVER_CUP",winCriteria:{valueGoal:13}},qm={collectionDefinitions:[{collectionName:"Round 1",matchUpCount:3,matchUpFormat:"SET1-S:T20",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Round 2",matchUpCount:3,matchUpFormat:"SET1-S:T20",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Round 3",matchUpCount:3,matchUpFormat:"SET1-S:T20",matchUpType:"DOUBLES",scoreValue:1}],tieFormatName:"Doubles Shuffle",unrestrictedSelections:!0,winCriteria:{aggregateValue:!0}},$m={collectionDefinitions:[{scoreValue:1,matchUpType:"SINGLES",collectionName:"Men's Singles",matchUpFormat:"SET1-S:T60",gender:"MALE",matchUpCount:3},{scoreValue:1,matchUpType:"SINGLES",collectionName:"Women's Singles",matchUpFormat:"SET1-S:T60",gender:"FEMALE",matchUpCount:3},{scoreValue:1,matchUpType:"DOUBLES",collectionName:"Men's Doubles",matchUpFormat:"SET1-S:T60",gender:"MALE",matchUpCount:1},{matchUpValue:1,matchUpType:"DOUBLES",collectionName:"Women's Doubles",matchUpFormat:"SET1-S:T60",gender:"FEMALE",matchUpCount:1},{matchUpValue:1,matchUpType:"DOUBLES",collectionName:"Mixed Doubles",matchUpFormat:"SET1-S:T60",gender:"MIXED",matchUpCount:1}],tieFormatName:"Time Tennis Dual",winCriteria:{aggregateValue:!0}},Wm={collectionDefinitions:[{scoreValue:1,matchUpType:"SINGLES",collectionName:"Men's Singles",matchUpFormat:"SET1-S:T60",gender:"MALE",matchUpCount:1},{scoreValue:1,matchUpType:"SINGLES",collectionName:"Women's Singles",matchUpFormat:"SET1-S:T60",gender:"FEMALE",matchUpCount:1},{matchUpValue:1,matchUpType:"DOUBLES",collectionName:"Mixed Doubles",matchUpFormat:"SET1-S:T60",gender:"MIXED",matchUpCount:1}],tieFormatName:"Time Tennis Pro Circuit",winCriteria:{aggregateValue:!0}},Hm={collectionDefinitions:[{category:{ageCategoryCode:"14U"},collectionName:"14U Singles",matchUpCount:2,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{category:{ageCategoryCode:"16U"},collectionName:"16U Singles",matchUpCount:2,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{category:{ageCategoryCode:"18U"},collectionName:"18U Singles",matchUpCount:2,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{category:{ageCategoryCode:"14U"},collectionName:"14U Doubles",collectionGroupNumber:1,matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{category:{ageCategoryCode:"16U"},collectionName:"16U Doubles",collectionGroupNumber:1,matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{category:{ageCategoryCode:"18U"},collectionName:"18U Doubles",collectionGroupNumber:1,matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1}],collectionGroups:[{groupNumber:1,groupName:"Doubles",groupValue:1,winCriteria:{valueGoal:2}}],tieFormatName:"USTA_BREWER_CUP",winCriteria:{valueGoal:4}},zm={winCriteria:{valueGoal:23},tieFormatName:"USTA_OZAKI_CUP",collectionDefinitions:[{category:{ageCategoryCode:"18U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"18U Boys Singles",matchUpType:"SINGLES",matchUpCount:3,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"18U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"18U Girls Singles",matchUpType:"SINGLES",gender:"FEMALE",matchUpCount:3,matchUpValue:1},{category:{ageCategoryCode:"18U"},collectionName:"18U Boys Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",matchUpCount:1,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"18U"},collectionName:"18U Girls Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"FEMALE",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"18U"},collectionName:"18U Mixed Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"MIXED",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"16U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"16U Boys Singles",matchUpType:"SINGLES",matchUpCount:3,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"16U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"16U Girls Singles",matchUpType:"SINGLES",gender:"FEMALE",matchUpCount:3,matchUpValue:1},{category:{ageCategoryCode:"16U"},collectionName:"16U Boys Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",matchUpCount:1,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"16U"},collectionName:"16U Girls Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"FEMALE",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"16U"},collectionName:"16U Mixed Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"MIXED",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"14U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"14U Boys Singles",matchUpType:"SINGLES",matchUpCount:3,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"14U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"14U Girls Singles",matchUpType:"SINGLES",gender:"FEMALE",matchUpCount:3,matchUpValue:1},{category:{ageCategoryCode:"14U"},collectionName:"14U Boys Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",matchUpCount:1,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"14U"},collectionName:"14U Girls Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"FEMALE",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"14U"},collectionName:"14U Mixed Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"MIXED",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"12U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"12U Boys Singles",matchUpType:"SINGLES",matchUpCount:3,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"12U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"12U Girls Singles",matchUpType:"SINGLES",gender:"FEMALE",matchUpCount:3,matchUpValue:1},{category:{ageCategoryCode:"12U"},collectionName:"12U Boys Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",matchUpCount:1,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"12U"},collectionName:"12U Girls Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"FEMALE",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"12U"},collectionName:"12U Mixed Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"MIXED",matchUpCount:1,matchUpValue:1}]},Ym={collectionDefinitions:[{collectionName:"Doubles",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7@7",matchUpType:"DOUBLES",collectionValue:1},{collectionName:"Singles",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1}],tieFormatName:"USTA_COLLEGE",winCriteria:{valueGoal:4}},Km={collectionDefinitions:[{collectionName:"Male Singles",matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpCount:4,matchUpValue:1,gender:"MALE"},{collectionName:"Female Singles",matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",gender:"FEMALE",matchUpCount:4,matchUpValue:1},{collectionName:"Male Doubles",matchUpFormat:"SET1-S:8/TB7@7",matchUpType:"DOUBLES",matchUpCount:2,matchUpValue:1,gender:"MALE"},{collectionName:"Female Doubles",matchUpFormat:"SET1-S:8/TB7@7",matchUpType:"DOUBLES",gender:"FEMALE",matchUpCount:2,matchUpValue:1},{collectionName:"Mixed Doubles",matchUpFormat:"SET1-S:8/TB7@7",matchUpType:"DOUBLES",matchUpCount:4,matchUpValue:1,gender:"MIXED"}],tieFormatName:"USTA_GOLD_TEAM_CHALLENGE",winCriteria:{valueGoal:9}},Jm={collectionDefinitions:[{collectionName:"Male Singles",gender:"MALE",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Female Singles",gender:"FEMALE",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Male Doubles",gender:"MALE",matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Female Doubles",gender:"FEMALE",matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Mixed Doubles",gender:"MIXED",matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1}],tieFormatName:"USTA_INTERSECTIONAL",winCriteria:{valueGoal:8}},Qm={collectionDefinitions:[{collectionName:"Male Singles",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Female Singles",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Male Doubles",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Female Doubles",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1}],tieFormatName:"USTA_LEVEL_1",winCriteria:{valueGoal:10}},Xm={collectionDefinitions:[{category:{ageCategoryCode:"16U"},collectionName:"16U Singles",matchUpCount:4,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1},{category:{ageCategoryCode:"18U"},collectionName:"18U Singles",matchUpCount:4,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1},{category:{ageCategoryCode:"16U"},collectionName:"16U Doubles",matchUpCount:2,matchUpFormat:"SET1-S:6/TB7",matchUpType:"DOUBLES",matchUpValue:1},{category:{ageCategoryCode:"18U"},collectionName:"18U Doubles",matchUpCount:2,matchUpFormat:"SET1-S:6/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Tiebreak Doubles",matchUpCount:1,matchUpFormat:"SET1-S:TB10",matchUpType:"DOUBLES",matchUpValue:1,processCodes:["RANKING.IGNORE"]}],tieFormatName:"USTA_SECTION_BATTLE",winCriteria:{valueGoal:9}},Zm={collectionDefinitions:[{collectionName:"Male Singles",gender:"MALE",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Female Singles",gender:"FEMALE",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Mixed Doubles",gender:"MIXED",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1}],tieFormatName:"USTA_SOUTHERN_LEVEL_5",winCriteria:{valueGoal:8}},tf={collectionDefinitions:[{collectionName:"Female Doubles",gender:"FEMALE",matchUpCount:1,matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Male Doubles",gender:"MALE",matchUpCount:1,matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Female Singles",gender:"FEMALE",matchUpCount:1,matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"SINGLES",scoreValue:1},{collectionName:"Male Singles",matchUpCount:1,gender:"MALE",matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"SINGLES",scoreValue:1},{collectionName:"Mixed Doubles",matchUpCount:1,gender:"MIXED",matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Overtime",matchUpCount:1,gender:"MIXED",matchUpFormat:"SET1-S:T20",matchUpType:"DOUBLES",scoreValue:1}],tieFormatName:"USTA_TOC",winCriteria:{aggregateValue:!0}},ef={collectionDefinitions:[{collectionName:"Female Doubles",gender:"FEMALE",matchUpCount:1,matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Male Doubles",gender:"MALE",matchUpCount:1,matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Female Singles",gender:"FEMALE",matchUpCount:1,matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"SINGLES",scoreValue:1},{collectionName:"Male Singles",matchUpCount:1,gender:"MALE",matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"SINGLES",scoreValue:1},{collectionName:"Mixed Doubles",matchUpCount:1,gender:"MIXED",matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Mixed Doubles",matchUpCount:1,gender:"MIXED",matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Overtime",matchUpCount:1,gender:"MIXED",matchUpFormat:"SET1-S:T20",matchUpType:"DOUBLES",scoreValue:1}],tieFormatName:"USTA_WTT_ITT",winCriteria:{aggregateValue:!0}},nf={collectionDefinitions:[{collectionName:"Male Singles",gender:"MALE",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Female Singles",gender:"FEMALE",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Male Doubles",gender:"MALE",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Female Doubles",gender:"FEMALE",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Mixed Doubles",gender:"MIXED",matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1}],tieFormatName:"USTA_ZONAL",winCriteria:{valueGoal:10}};const rf={COLLEGE_D3:{collectionDefinitions:[{collectionName:"Doubles",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7@7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Singles",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1}],tieFormatName:"COLLEGE_D3",winCriteria:{valueGoal:5}},COLLEGE_DEFAULT:{collectionDefinitions:[{collectionName:"Doubles",collectionValue:1,matchUpCount:3,matchUpFormat:"SET1-S:6/TB7",matchUpType:"DOUBLES"},{collectionName:"Singles",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1}],tieFormatName:"COLLEGE_DEFAULT",winCriteria:{valueGoal:5}},COLLEGE_JUCO:{collectionDefinitions:[{collectionName:"Doubles",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Singles",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1}],tieFormatName:"COLLEGE_JUCO",winCriteria:{valueGoal:5}},DOMINANT_DUO:Vm,DOMINANT_DUO_MIXED:jm,LAVER_CUP:Gm,TEAM_DOUBLES_3_AGGREGATION:qm,TIME_TENNIS_DUAL:$m,TIME_TENNIS_PRO_CIRCUIT:Wm,USTA_BREWER_CUP:Hm,USTA_OZAKI_CUP:zm,USTA_COLLEGE:Ym,USTA_GOLD_TEAM_CHALLENGE:Km,USTA_INTERSECTIONAL:Jm,USTA_LEVEL_1:Qm,USTA_SECTION_BATTLE:Xm,USTA_SOUTHERN_LEVEL_5:Zm,USTA_TOC:tf,USTA_WTT_ITT:ef,USTA_ZONAL:nf},af="qualifierDrawPositionAssignment",of="withdrawParticipantAtDrawPosition",sf="alternateDrawPositionAssignment",cf="luckyLoserDrawPositionAssignment",uf="removeDrawPositionAssignment",df="swapDrawPositionAssignments",pf="modifyPairAssignment",lf="modifyParticipantOtherName",mf="assignDrawPosition",ff="removeSeededParticipant",hf="assignDrawPositionBye",If="modifySeedAssignment",gf="addPenalty",Uf="MODIFY_PAIR",yf="QUALIFIER",Sf="ALTERNATE",vf="WITHDRAW",wf="ASSIGN",Tf="REMOVE",Pf="LUCKY",Df="REMOVE_SEED",Nf="SWAP",Rf="NICKNAME",bf="SEED_VALUE",Mf="PENALTY",Af="BYE",Ef={MODIFY_PAIR_ASSIGNMENT:Uf,QUALIFYING_PARTICIPANT:yf,ALTERNATE_PARTICIPANT:Sf,WITHDRAW_PARTICIPANT:vf,ASSIGN_PARTICIPANT:wf,LUCKY_PARTICIPANT:Pf,REMOVE_ASSIGNMENT:Tf,SWAP_PARTICIPANTS:Nf,ADD_NICKNAME:Rf,REMOVE_SEED:Df,ADD_PENALTY:Mf,ASSIGN_BYE:Af,SEED_VALUE:bf},Cf={[Qa]:{policyName:"positionActionsDefault",enabledStructures:[{stages:[zu,Hu],stageSequences:[1],enabledActions:[],disabledActions:[]},{stages:[],stageSequences:[],enabledActions:[Rf,Mf,yf,bf],disabledActions:[]}],disbledStructures:[],otherFlightEntries:!1,activePositionOverrides:[]}},Of="ADULT",Ff="JUNIOR",kf="WHEELCHAIR",xf={[ro]:{defaultTimes:{averageTimes:[{categoryNames:[],minutes:{default:90}}],recoveryTimes:[{minutes:{[Aa]:30,default:60}}]},defaultDailyLimits:{[ba]:2,[Aa]:2,total:3},matchUpAverageTimes:[{matchUpFormatCodes:[va],averageTimes:[{categoryNames:[],minutes:{default:90}},{categoryTypes:[kf],minutes:{default:120}}]},{matchUpFormatCodes:["SET3-S:6/TB7-F:TB10"],averageTimes:[{categoryNames:[],minutes:{default:85}}]},{matchUpFormatCodes:["SET3-S:6/TB7-F:TB7"],averageTimes:[{categoryNames:[],minutes:{default:70}}]},{matchUpFormatCodes:["SET3-S:4NOAD-F:TB7"],averageTimes:[{categoryNames:[],minutes:{default:55}}]},{matchUpFormatCodes:["SET3-S:4/TB7"],averageTimes:[{categoryNames:[],minutes:{default:60}}]},{matchUpFormatCodes:["SET3-S:4/TB7-F:TB7"],averageTimes:[{categoryNames:[],minutes:{default:50}}]},{matchUpFormatCodes:["SET3-S:4/TB7-F:TB10"],averageTimes:[{categoryNames:[],minutes:{default:55}}]},{matchUpFormatCodes:["SET3-S:4/TB5@3"],averageTimes:[{categoryNames:[],minutes:{default:45}}]},{matchUpFormatCodes:["SET1-S:8/TB7","SET1-S:8/TB7@7"],averageTimes:[{categoryNames:[],minutes:{default:40}}]},{matchUpFormatCodes:["SET1-S:5/TB9@4"],averageTimes:[{categoryNames:[],minutes:{default:30}}]},{matchUpFormatCodes:["SET1-S:6/TB7"],averageTimes:[{categoryNames:[],minutes:{default:30}}]},{matchUpFormatCodes:["SET1-S:6NOAD"],averageTimes:[{categoryNames:[],minutes:{default:30}}]},{matchUpFormatCodes:["SET1-S:4/TB7","SET1-S:4/TB5@3","SET3-S:TB10","SET1-S:T20"],averageTimes:[{categoryNames:[],minutes:{default:20}}]},{matchUpFormatCodes:["SET1-S:4NOAD"],averageTimes:[{categoryNames:[],minutes:{default:20}}]},{matchUpFormatCodes:["SET1-S:TB10"],averageTimes:[{categoryNames:[],minutes:{default:10}}]}],matchUpRecoveryTimes:[{matchUpFormatCodes:["SET3-S:6/TB7","SET3-S:6/TB7-F:TB10","SET3-S:6/TB7-F:TB7"],recoveryTimes:[{categoryTypes:[Of,kf],minutes:{default:60,[Aa]:30}},{categoryTypes:[Ff],minutes:{default:60,[Aa]:60}}]},{matchUpFormatCodes:["SET3-S:4/TB7-F:TB7","SET3-S:4/TB7-F:TB10","SET3-S:4NOAD-F:TB7","SET3-S:4/TB7","SET3-S:4/TB5@3"],recoveryTimes:[{categoryTypes:[Of,kf],minutes:{default:30}},{categoryTypes:[Ff],minutes:{default:60}}]},{matchUpFormatCodes:["SET1-S:8/TB7","SET1-S:8/TB7@7","SET1-S:5/TB9@4","SET1-S:6/TB7","SET1-S:6NOAD","SET1-S:4/TB7","SET1-S:4NOAD","SET3-S:TB10","SET1-S:T20"],recoveryTimes:[{categoryNames:[],minutes:{default:30}}]},{matchUpFormatCodes:["SET1-S:4/TB5@3"],recoveryTimes:[{categoryTypes:[Of,Ff],minutes:{default:30}},{categoryTypes:[kf],minutes:{default:15}}]},{matchUpFormatCodes:["SET1-S:TB10"],recoveryTimes:[{categoryNames:[],minutes:{default:15}}]}],matchUpDailyLimits:[]}},_f={[so]:{validSeedPositions:{ignore:!0},duplicateSeedNumbers:!0,drawSizeProgression:!0,seedingProfile:{positioning:"SEPARATE"},policyName:"USTA SEEDING",seedsCountThresholds:[{drawSize:4,minimumParticipantCount:3,seedsCount:2},{drawSize:16,minimumParticipantCount:12,seedsCount:4},{drawSize:32,minimumParticipantCount:24,seedsCount:8},{drawSize:64,minimumParticipantCount:48,seedsCount:16},{drawSize:128,minimumParticipantCount:96,seedsCount:32},{drawSize:256,minimumParticipantCount:192,seedsCount:64}]}},Lf={reset:"\x1b[0m",bright:"\x1b[1m",dim:"\x1b[2m",red:"\x1b[31m",brightred:"\x1b[91m",green:"\x1b[32m",brightgreen:"\x1b[92m",yellow:"\x1b[33m",brightyellow:"\x1b[93m",blue:"\x1b[34m",brightblue:"\x1b[94m",lightblue:"\x1b[105m",magenta:"\x1b[35m",brightmagenta:"\x1b[95m",cyan:"\x1b[36m",brightcyan:"\x1b[96m",white:"\x1b[37m",brightwhite:"\x1b[97m"},Bf=[];function Vf(t,e){"string"==typeof t&&(t={method:t}),(e||ir())&&Bf.push(t)}function jf(t){const e=function(t){const e=Bf.slice();return t&&(Bf.length=0),e}(t),n=e.map((t=>{const{color:e,keyColors:n,method:r,newline:i}=t,a=Object.keys(Lf).includes(e)?Lf[e]:Lf.cyan,o=Object.keys(t).filter((t=>!["color","keyColors","method","newline"].includes(t))).map((e=>{const r=n&&Object.keys(n).includes(e)&&Lf[n[e]]?Lf[n[e]]:Lf.brightwhite;return`${Lf.white}${e}: ${r}${t[e]}`})).join(", ");return[i?"\n":"",a,r,r?.length<15?"\t\t":"\t",Lf.white,o,Lf.reset,"\n"].join("")}));n?.length&&console.log(...n)}function Gf({collectionDefinitions:t=[],collectionGroups:e=[]}){let n=0;const{groupValueNumbers:r}=Wp({collectionGroups:e});let i;for(const a of t||[]){const{collectionValueProfiles:t,collectionGroupNumber:e,collectionValue:o,matchUpCount:s,matchUpValue:c,scoreValue:u,setValue:d}=a,p=e&&r.includes(e);if(v(d||u))i=!0;else{if(p)continue;if("number"==typeof o&&v(o))n+=o;else if(t?.length)for(const e of t)n+=e.matchUpValue;else"number"==typeof c&&v(c)&&(n+=(s||0)*c)}}for(const a of e)n+=a.groupValue||0;if(i||!n)return{aggregateValue:!0};return{valueGoal:Math.floor(n/2)+1}}function qf({participant:t,withISO2:e,withIOC:n}){const{person:r,individualParticipants:i}=t;[r,i?.map((({person:t})=>t))].flat().filter(Boolean).forEach((function(t){const{nationalityCode:r}=t||{};if(r){const i=Fm.find((({iso:t})=>t===r));n&&i?.ioc&&!t.iocNationalityCode&&(t.iocNationalityCode=i.ioc),e&&i?.iso2&&!t.iso2NationalityCode&&(t.iso2NationalityCode=i.iso2),i?.label&&!t.countryName&&(t.countryName=i.label)}}))}function $f({returnPreviousValues:t,itemSubTypes:e,itemType:n,element:r}){if(!r)return{error:me,info:Vs};if(e&&!Array.isArray(e))return{error:xn,context:{itemSubTypes:e}};if(!Array.isArray(r.timeItems))return{error:Tn};const i=r.timeItems.filter((t=>t?.itemType===n)).filter((t=>!e?.length||e.some((e=>t?.itemSubTypes?.includes(e))))).sort(((t,e)=>new Date(t.createdAt||void 0).getTime()-new Date(e.createdAt||void 0).getTime())),a=i.pop();if(a){const e={timeItem:a,...L};return t&&Object.assign(e,{previousItems:i}),e}return{info:Gn}}function Wf({returnPreviousValues:t,itemSubTypes:e,itemType:n,event:r}){if(!r)return{error:At};if(!r.timeItems)return{info:Gn};const{timeItem:i,previousItems:a,info:o}=$f({returnPreviousValues:t,element:r,itemSubTypes:e,itemType:n});return i&&{timeItem:i,previousItems:a}||{info:o}}function Hf({returnPreviousValues:t,tournamentRecord:e,itemSubTypes:n,itemType:r}){if(!e)return{error:$};if(!e.timeItems)return{info:Gn};const{timeItem:i,previousItems:a,info:o}=$f({element:e,returnPreviousValues:t,itemSubTypes:n,itemType:r});return i&&{timeItem:i,previousItems:a}||{info:o}}const zf={[Cu]:"groupParticipantIds",[Ou]:"pairParticipantIds",[Fu]:"teamParticipantIds"},Yf={[Cu]:"groups",[Fu]:"teams"};function Kf({withIndividualParticipants:t,convertExtensions:e,tournamentRecord:n,withSignInStatus:r,withScaleValues:i,internalUse:a,withISO2:o,withIOC:s}){const c={};for(const u of n.participants??[]){const t=u?.participantId;t&&Xf({participantMap:c,participantId:t})}for(const u of n.participants??[]){const t=ri(u,e,a),{participantId:n,individualParticipantIds:d,participantType:p}=t;if(Object.assign(c[n].participant,t),d&&Qf({individualParticipantIds:d,participantCopy:t,participantMap:c,participantType:p,participantId:n}),r&&(c[n].participant.signedIn=Jf(t)),i){const{ratings:e,rankings:r,seedings:i}=ms({participant:t});c[n].participant.seedings=i,c[n].participant.rankings=r,c[n].participant.ratings=e}(s||o)&&qf({participant:c[n].participant,withISO2:o,withIOC:s})}return t&&function({participantMap:t}){const e=Object.values(t);for(const n of e){const e=n.participant;if(e.individualParticipantIds?.length){e.individualParticipants=[];for(const n of e.individualParticipantIds)e.individualParticipants.push(t[n].participant)}}}({participantMap:c}),{participantMap:c}}function Jf(t){const{timeItem:e}=$f({itemType:Au,element:t});return e?.itemValue===xu}function Qf({individualParticipantIds:t,participantCopy:e,participantMap:n,participantType:r,participantId:i}){for(const a of t){const o=n[a].participant;if(o[zf[r]].push(i),[Fu,Cu].includes(r)){const{participantRoleResponsibilities:t,participantOtherName:n,participantName:i,participantId:a,teamId:s}=e;o[Yf[r]].push({participantRoleResponsibilities:t,participantOtherName:n,participantName:i,participantId:a,teamId:s})}if(r===Ou){const e=t.find((t=>t!==a));n[a].pairIdMap[i]=e,n[a].pairIdMap[e]=i}}}function Xf({participantMap:t,participantId:e}){if(t[e])return;const n={walkoverWins:0,defaultWins:0,walkovers:0,defaults:0,losses:0,wins:0};t[e]={structureParticipation:{},potentialMatchUps:{},scheduleConflicts:[],scheduleItems:[],participant:{groupParticipantIds:[],pairParticipantIds:[],teamParticipantIds:[],seedings:{},rankings:{},ratings:{},groups:[],teams:[]},statistics:{},opponents:{},pairIdMap:{},matchUps:{},events:{},draws:{},counters:{[ba]:{...n},[Aa]:{...n},[Fu]:{...n},...n}}}function Zf({participantsProfile:t,useParticipantMap:e,tournamentRecord:n,contextProfile:r,inContext:i}){if(e){const e=Kf({...t,...r,tournamentRecord:n})?.participantMap;return{participantMap:e}}let a=ri(n.participants,!1,!0)||[];if((t?.withIOC||t?.withISO2)&&a.forEach((e=>qf({participant:e,...t}))),(i||t?.withGroupings)&&a?.length&&(a=ul({participantsProfile:t,participants:a})),t?.withScaleValues&&a?.length)for(const o of a){const{ratings:t,rankings:e}=ms({participant:o});o.rankings=e,o.ratings=t}return{participants:a}}function th(t){if(!t?.tournamentRecord)return{error:$};let{participantMap:e,participants:n}=t;const{scheduleVisibilityFilters:r,participantsProfile:i,afterRecoveryTimes:a,useParticipantMap:o,policyDefinitions:s,tournamentRecord:c,inContext:u=!0,contextProfile:d,matchUpFilters:p,contextFilters:l,nextMatchUps:m,context:f}=t,h=t.tournamentId??c.tournamentId,I=c?.events??[];n||({participants:n,participantMap:e}=Zf({participantsProfile:i,policyDefinitions:s,useParticipantMap:o,tournamentRecord:c,contextProfile:d,inContext:u}));const{appliedPolicies:g}=Vo({tournamentRecord:c}),U={...f,tournamentId:h,indoorOutDoor:c.indoorOutdoor,surfaceCategory:c.surfaceCategory,endDate:c.endDate},y=Ko({policyDefinitions:s,tournamentRecord:c,contextProfile:d});return{matchUps:I.flatMap((t=>(U.eventDrawsCount=t.drawDefinitions?.length??0,nh({context:U,scheduleVisibilityFilters:r,tournamentAppliedPolicies:g,participantsProfile:i,afterRecoveryTimes:a,policyDefinitions:s,tournamentRecord:c,contextContent:y,contextFilters:l,contextProfile:d,matchUpFilters:p,participantMap:e,nextMatchUps:m,participants:n,inContext:u,event:t}).matchUps??[]))).concat(...c.matchUps??[])}}function eh(t){let{participants:e,participantMap:n,contextContent:r}=t;const{scheduleVisibilityFilters:i,tournamentAppliedPolicies:a,participantsProfile:o,afterRecoveryTimes:s,policyDefinitions:c,useParticipantMap:u,tournamentRecord:d,contextFilters:p,contextProfile:l,drawDefinition:m,matchUpFilters:f,nextMatchUps:h,inContext:I,context:g,event:U}=t,{eventId:y,eventName:S,eventType:v,category:w,gender:T,matchUpFormat:P}=U??{},D={...g,eventId:y,eventType:v,eventName:S,category:w,gender:T,matchUpFormat:P,indoorOutDoor:U?.indoorOutdoor??d?.indoorOutdoor,surfaceCategory:U?.surfaceCategory??d?.surfaceCategory,endDate:U?.endDate};return e?.length||n||!d||({participants:e=[],participantMap:n}=Zf({participantsProfile:o,useParticipantMap:u,policyDefinitions:c,tournamentRecord:d,contextProfile:l,inContext:I})),l&&!r&&(r=Ko({policyDefinitions:c,tournamentRecord:d,contextProfile:l,drawDefinition:m,event:U})),Pl({context:D,tournamentAppliedPolicies:a,scheduleVisibilityFilters:i,tournamentParticipants:e,participantsProfile:o,afterRecoveryTimes:s,policyDefinitions:c,tournamentRecord:d,drawDefinition:m,contextContent:r,contextFilters:p,contextProfile:l,matchUpFilters:f,participantMap:n,nextMatchUps:h,inContext:I,event:U})}function nh(t){let{participants:e=[],contextContent:n,participantMap:r}=t;const{scheduleVisibilityFilters:i,tournamentAppliedPolicies:a,participantsProfile:o,afterRecoveryTimes:s,policyDefinitions:c,useParticipantMap:u,tournamentRecord:d,contextFilters:p,contextProfile:l,matchUpFilters:m,nextMatchUps:f,inContext:h,context:I,event:g}=t;if(!g)return{error:At};const{eventId:U,eventName:y,endDate:S,category:v,gender:w,matchUpFormat:T}=g,P=[],D={...I,...di({indoorOutDoor:g.indoorOutdoor??d?.indoorOutdoor,surfaceCategory:g.surfaceCategory??d?.surfaceCategory,endDate:g.endDate??d?.endDate,tournamentId:d?.tournamentId,matchUpFormat:T,eventName:y,category:v,gender:w,eventId:U})};if(S&&(D.endDate=S),l&&!n&&(n=Ko({policyDefinitions:c,tournamentRecord:d,contextProfile:l,event:g})),!e?.length&&!r&&d){const t=Zf({participantsProfile:o,useParticipantMap:u,policyDefinitions:c,tournamentRecord:d,contextProfile:l,inContext:h});r=t.participantMap,e=t.participants??[]}const N=g.drawDefinitions??[],R=vs({tournamentRecord:d,event:g}).scheduleTiming,b=N.flatMap((t=>{const{matchUps:u,matchUpsMap:I}=Pl({tournamentParticipants:e,tournamentAppliedPolicies:a,scheduleVisibilityFilters:i,context:D,participantsProfile:o,afterRecoveryTimes:s,policyDefinitions:c,tournamentRecord:d,contextFilters:p,contextProfile:l,drawDefinition:t,contextContent:n,matchUpFilters:m,participantMap:r,scheduleTiming:R,nextMatchUps:f,inContext:h,event:g});return I?.drawMatchUps&&P.push(...I.drawMatchUps),u??[]}));return{matchUps:b,eventMatchUps:P}}function rh(t){if(!t?.tournamentRecord)return{error:$};let e=t.contextContent;const{scheduleVisibilityFilters:n,participantsProfile:r,afterRecoveryTimes:i,policyDefinitions:a,useParticipantMap:o,tournamentRecord:s,inContext:c=!0,contextFilters:u,contextProfile:d,matchUpFilters:p,nextMatchUps:l,context:m}=t,f=t.tournamentId??s.tournamentId,h=s?.events??[],{participants:I,participantMap:g}=Zf({participantsProfile:r,policyDefinitions:a,useParticipantMap:o,tournamentRecord:s,contextProfile:d,inContext:c});d&&!e&&(e=Ko({policyDefinitions:a,tournamentRecord:s,contextProfile:d}));const{appliedPolicies:U}=Vo({tournamentRecord:s}),y=u?.eventIds??[];return h.filter((t=>!y.includes(t.eventId))).map((t=>{const o=_s({event:t}).flightProfile;return ih({context:{eventDrawsCount:o?.flights?.length||t.drawDefinitions?.length||0,...m},tournamentAppliedPolicies:U,scheduleVisibilityFilters:n,participantsProfile:r,afterRecoveryTimes:i,policyDefinitions:a,tournamentRecord:s,contextFilters:u,contextProfile:d,contextContent:e,matchUpFilters:p,participantMap:g,participants:I,tournamentId:f,nextMatchUps:l,inContext:c,event:t})})).reduce(((t,e)=>{const n=e&&Object.keys(e).filter((t=>!["success","matchUpsMap"].includes(t)));return n?.forEach((n=>{t[n]||(t[n]=[]),t[n]=t[n].concat(e[n]),t.matchUpsCount+=e[n].length})),t}),{matchUpsCount:0})}function ih(t){let{participants:e,contextContent:n,participantMap:r}=t;const{tournamentAppliedPolicies:i,scheduleVisibilityFilters:a,participantsProfile:o,afterRecoveryTimes:s,policyDefinitions:c,useParticipantMap:u,tournamentRecord:d,contextFilters:p,contextProfile:l,matchUpFilters:m,nextMatchUps:f,tournamentId:h,inContext:I,context:g,event:U}=t;if(!U)return{error:At};const{eventId:y,eventName:S,endDate:v}=U,w={...g,...di({eventId:y,eventName:S,endDate:v??d?.endDate,tournamentId:h??d?.tournamentId,indoorOutDoor:U.indoorOutdoor??d?.indoorOutdoor,surfaceCategory:U.surfaceCategory??d?.surfaceCategory})};!e&&d&&({participants:e,participantMap:r}=Zf({participantsProfile:o,policyDefinitions:c,useParticipantMap:u,tournamentRecord:d,contextProfile:l,inContext:I})),l&&!n&&(n=Ko({policyDefinitions:c,tournamentRecord:d,contextProfile:l,event:U}));return(U.drawDefinitions??[]).reduce(((t,u)=>{const h=Dl({context:w,tournamentAppliedPolicies:i,scheduleVisibilityFilters:a,tournamentParticipants:e,participantsProfile:o,afterRecoveryTimes:s,policyDefinitions:c,tournamentRecord:d,drawDefinition:u,contextContent:n,contextFilters:p,contextProfile:l,matchUpFilters:m,participantMap:r,nextMatchUps:f,inContext:I,event:U}),g=Object.keys(h);return g?.forEach((e=>{t[e]||(t[e]=[]),t[e]=t[e].concat(h[e])})),t}),{})}function ah({finishingPositionOffset:t=0,finishingPositionLimit:e,positionsFed:n,roundsCount:r,roundLimit:i,matchUps:a,lucky:o,fmlc:s}){if(!Sa(a))return[];const{roundProfile:c,roundNumbers:u=[]}=Gu({interpolate:!0,matchUps:a});r=r||Math.max(...u,0);const d=i?r-i:0,p=d&&c?.[r-d]?.matchUpsCount,l=c&&Object.values(c).map(ui("matchUpsCount")),m=(t,n)=>{let r=Math.min(...t);p&&n&&1===r&&(r=p);let i=Math.max(...t);return e&&i>e&&(i=e),[r,i]},f=c&&Object.assign({},...u.map((e=>{const i=(r||0)+1-e-d,a=c[e].matchUpsCount,u={finishingPositionRange:{},finishingRound:i},p=l?.slice(e-1).reduce(((t,e)=>t+(e||0)),0),f=1+t+(s&&1!==e&&n||0),h=E(f,o?f+2*a:p+f+1),I=p+1-a,g=m(h.slice(I)),U=m(h.slice(0,I),!0);return u.finishingPositionRange={loser:g,winner:U},{[e]:u}}))),h=ir({finishingRound:!0});return a.filter(Boolean).forEach((t=>{const e=t.roundNumber&&f[t.roundNumber];h&&!e&&console.log({roundFinishingData:f,matchUp:t}),t.finishingRound=e?.finishingRound,t.finishingPositionRange=e?.finishingPositionRange})),a}function oh({inContextDrawMatchUps:t,drawDefinition:e,matchUpsMap:n}){if(!e)return{error:Y};const r={loserMatchUpIds:{},winnerMatchUpIds:{}};t||({matchUps:t,matchUpsMap:n}=Pl({inContext:!0,drawDefinition:e,matchUpsMap:n}));const i=n?.drawMatchUps.some((t=>t.finishingPositionRange));if(!i&&1===e?.structures?.length&&!e?.structures[0].structures){ah({matchUps:n?.drawMatchUps||[]})}return(t||[]).filter((({collectionId:t})=>!t)).forEach((i=>{const{matchUpId:a,structureId:o}=i,s=yl({inContextDrawMatchUps:t,drawDefinition:e,matchUpId:a}),{winnerMatchUp:c,loserMatchUp:u}=s.targetMatchUps,d=c?.matchUpId,p=u?.matchUpId,l=Tp({matchUpsMap:n,structureId:o}).find((t=>t.matchUpId===a));if(l&&(d&&(r.winnerMatchUpIds[l.matchUpId]=d,Object.assign(l,{winnerMatchUpId:d}),Object.assign(i,{winnerMatchUpId:d})),p&&(r.loserMatchUpIds[l.matchUpId]=p,i.loserMatchUpId=p,l.loserMatchUpId=p,i.finishingPositionRange))){const t=u.finishingPositionRange&&[...i.finishingPositionRange.loser,...u.finishingPositionRange.loser],e=t&&[Math.min(...t),Math.max(...t)];i.finishingPositionRange.loser=e,l.finishingPositionRange.loser=e}})),{inContextDrawMatchUps:t,goesToMap:r}}function sh(t){const{sides:e,matchUpType:n}=t||{},r=t.potentialParticipants?.length?t.potentialParticipants.flat().map((t=>n===Aa?t?.individualParticipantIds||[]:t.participantId)).flat():[],i=(e||[]).map((t=>n===Aa&&(t?.participant?.individualParticipantIds||[])||t?.participantId&&[t.participantId]||[])).flat();return{individualParticipantIds:i.concat(r).flat(),enteredIndividualParticipantIds:i,potentialIndividualParticipantIds:r}}function ch({scheduleVisibilityFilters:t,afterRecoveryTimes:e,participantsProfile:n,tournamentRecords:r,policyDefinitions:i,matchUpFilters:a,contextFilters:o,nextMatchUps:s,inContext:c}){if("object"!=typeof r||!Object.keys(r).length)return{error:q};return{matchUps:Object.keys(r).map((u=>{const d=r[u];return th({scheduleVisibilityFilters:t,afterRecoveryTimes:e,participantsProfile:n,policyDefinitions:i,tournamentRecord:d,matchUpFilters:a,contextFilters:o,nextMatchUps:s,inContext:c}).matchUps??[]})).flat()}}function uh({scheduleVisibilityFilters:t,participantsProfile:e,tournamentRecords:n,policyDefinitions:r,matchUpFilters:i,contextFilters:a,nextMatchUps:o,inContext:s}){if("object"!=typeof n||!Object.keys(n).length)return{error:q};return Object.keys(n).map((c=>{const u=n[c];return rh({scheduleVisibilityFilters:t,participantsProfile:e,policyDefinitions:r,tournamentRecord:u,matchUpFilters:i,contextFilters:a,nextMatchUps:o,inContext:s})})).reduce(((t,e)=>(Object.keys(e).forEach((n=>{t[n]||(t[n]=[]),t[n]=t[n].concat(e[n])})),t)),{})}function dh(t,e){return function(t,e){return(Xu[t?.stage]||0)-(Xu[e?.stage]||0)}(t,e)||(t?.stageSequence||0)-(e?.stageSequence||0)||t?.roundNumber&&e.roundNumber&&t?.roundNumber-e?.roundNumber||(t?.roundPosition||0)-(e?.roundPosition||0)}function ph(t){let e=t.tournamentRecords??{};const n=t.matchUps??[];let r=t.drawIds??[];const{includeParticipantDependencies:i,tournamentRecord:a,drawDefinition:o}=t;if(!Array.isArray(n))return{error:Zt};if(!Array.isArray(r))return{error:lt};const s=t.matchUpIds?.length?t.matchUpIds:n.map((t=>t.matchUpId));if(!Array.isArray(s))return{error:Qt};const c={},u={},d={},p={};a&&!Object.keys(e).length&&(e={[a.tournamentId]:a});const l=Object.values(e),m=l.reduce(((t,e)=>t.concat(e.events??[]).map((t=>(t.drawDefinitions||[]).map((t=>t.links||[])))).flat(1/0)),[]).filter((({linkType:t})=>t===pd));let f=n;if(m.length){f=ch({nextMatchUps:!0,tournamentRecords:e}).matchUps;const t=m.reduce(((t,e)=>{const n=e.source?.structureId,r=e.target?.structureId;return n&&r&&(d[r]=n),n&&!t.includes(n)&&t.push(n),t}),[]);for(const e of t)c[e]=[];for(const e of f??[]){const n=e.containerStructureId||e.structureId;t.includes(n)&&c[n].push(e.matchUpId)}}const h=t=>{u[t]||(u[t]={dependentMatchUpIds:[],participantIds:[],matchUpIds:[],sources:[]},p[t]=[])},I=(t,e)=>{u[t].matchUpIds.forEach((t=>{u[e].matchUpIds.push(t)})),u[e].matchUpIds.push(t),u[t].dependentMatchUpIds.push(e),i&&u[t].participantIds.forEach((t=>u[e].participantIds.push(t)))},g=t=>{const e=Object.keys(c).length;for(const n of t||[]){const{matchUpId:t,winnerMatchUpId:r,loserMatchUpId:a}=n;if(!s.length||s.includes(t)){if(h(t),i){const{individualParticipantIds:e}=sh(n);u[t].participantIds=e}r&&(h(r),I(t,r),p[r].push(t)),a&&(h(a),I(t,a),p[a].push(t)),u[t].sources.push(p[t]);const o=p[t].map((t=>u[t].sources[0])).flat(),s=p[t].map((t=>u[t].sources[1])).flat();if(u[t].sources.push(o,s),e){const e=n.containerStructureId||n.structureId,r=d[e];if(c[r])for(const n of c[r])h(n),I(n,t),p[n].push(t)}}}};if(o)oh({drawDefinition:o}),f?.length||(f=eh({drawDefinition:o}).matchUps),g(f);else{if(f?.length||(f=ch({nextMatchUps:!0,tournamentRecords:e}).matchUps),!r.length){const t=l?.length?l.map((({events:t=[]})=>t.map((({drawDefinitions:t=[]})=>t.map((({drawId:t})=>t)))))).flat(1/0):[];t&&(r=t)}for(const t of r){const n=f?.filter((e=>e.drawId===t)).sort(dh),r=n?.find((({roundPosition:t})=>!t));if(!r){const r=n?.find((({tournamentId:t})=>t)),{drawDefinition:i}=Ls({tournamentRecord:e[r?.tournamentId],drawId:t});i&&oh({drawDefinition:i})}g(n)}}return{positionDependencies:c,matchUpDependencies:u,sourceMatchUpIds:p,matchUps:f,...L}}function lh({tournamentRecords:t,matchUps:e}){if(!Sa(e))return{error:Zt};if(e.some((({matchUpId:t,hasContext:e})=>t&&!e)))return{info:"matchUps must have { inContext: true, nextMatchUps: true }",error:Pn};const n=E(1,Math.max(...e.map((({schedule:t})=>t?.courtOrder||1)).map((t=>m(t))))+1).map((t=>e.filter((e=>m(e.schedule?.courtOrder)===t)))),r={},i={},a={};n.flat().filter(Boolean).sort(dh).forEach((({schedule:t})=>delete t[Cs]));const o=ph({includeParticipantDependencies:!0,tournamentRecords:t,drawIds:T(e.map((({drawId:t})=>t)))}).matchUpDependencies,s=n.map(((t,e)=>t.reduce(((t,n)=>{if(!n.matchUpId)return t;const{matchUpId:s,winnerMatchUpId:c,loserMatchUpId:u,schedule:d,sides:p,potentialParticipants:l}=n,m=d?.courtId;r[s]=e,i[m]=[],t.matchUpIds.push(s),a[s]=n;const f=o[s].matchUpIds;f.length&&t.sourceMatchUpIds.push(...f);const h=p?.map((t=>[t.participant?.individualParticipantIds,t.participantId])).flat().filter(Boolean)||[],I=l?.flat().map((({individualParticipantIds:t,participantId:e})=>[t,e])).flat().filter(Boolean)||[];return t.participantIds.push(...I,...h),c&&t.targetMatchUpIds.push(c),u&&t.targetMatchUpIds.push(u),t}),{sourceMatchUpIds:[],targetMatchUpIds:[],participantIds:[],matchUpIds:[]}))),c=s.map((()=>[])),u=(t,e,n,o)=>{if(!a[t].schedule[Cs]){a[t].schedule[Cs]=e,a[t].schedule[Rs]=o,c[r[t]].push({matchUpId:t,issueType:n,issueIds:o,issue:e});const s=a[t].schedule.courtId;i[s]||(i[s]=[]),i[s].push({matchUpId:t,issue:e,issueType:n,issueIds:o})}};return s.forEach(((t,e)=>{const n=e?s[e-1]:void 0,r=s.slice(e+1),i={},c=N(t.participantIds),d=Object.keys(c).filter((t=>c[t]>1)),p=t.matchUpIds.filter((t=>o[t].participantIds.some((t=>d.includes(t)))));p.forEach((t=>{i[t]||(i[t]={}),i[t][bs]||(i[t][bs]=p.filter((e=>e!==t)))}));const l=n&&t.participantIds.filter((t=>n.participantIds.includes(t)));l&&l.forEach((e=>{const r=t.matchUpIds.concat(n.matchUpIds).filter((t=>o[t].participantIds.includes(e)));r.forEach((t=>{i[t]||(i[t]={}),i[t][Ms]||(i[t][Ms]=r.filter((e=>e!==t)))}))})),t.matchUpIds.forEach((e=>{const s=o[e].matchUpIds;for(const t of r){const n=t.matchUpIds.filter((t=>s.includes(t)));n?.length&&(n.forEach((t=>u(t,As,Ns,[e]))),u(e,As,Ns,n))}if(i[e]?.[bs]&&u(e,bs,Ds,i[e][bs]),t.sourceMatchUpIds.includes(e)){const n=t.matchUpIds.filter((t=>o[t].matchUpIds.includes(e)));u(e,bs,Ns,n),t.matchUpIds.filter((t=>o[t].matchUpIds.includes(e))).forEach((t=>u(t,bs,Ns,[e])))}const c=n?.matchUpIds?.filter((t=>{return n=t,o[e].sources.reduce(((t,e,r)=>e.includes(n)&&r+1||t),0)>1;var n}));if(c?.length&&(u(e,Es,Ns,c),c.forEach((t=>u(t,Es,Ns,[e])))),i[e]?.[Ms]&&u(e,Ms,Ds,i[e][Ms]),n?.targetMatchUpIds?.includes(e)){const t=a[e].schedule.courtId,r=s.filter((t=>n.matchUpIds.includes(t)));r.some((e=>a[e].schedule.courtId===t))||(r.forEach((t=>u(t,Ms,Ns,[e]))),u(e,Ms,Ns,r))}}))})),{courtIssues:i,rowIssues:c}}function mh(t,e){return(t||"").localeCompare(e||"")}function fh(t){if(!t)return{};const e=[],n=t.tieFormatName,r=t.collectionDefinitions?.map((t=>{const{matchUpType:n,matchUpFormat:r,matchUpCount:i,category:a,gender:o}=t;e.includes(r)||e.push(r);const s=a?.ageCategoryCode;return[i,n===Ma?"D":"S",s,r,o].join(";")})).join("|");return{tieFormatName:t&&n||"UNNAMED",matchUpFormats:e,tieFormatDesc:r}}function hh({considerations:t={},descendant:e,ancestor:n}){const r={},i={},{matchUpFormats:a,tieFormatDesc:o}=fh(e),{matchUpFormats:s,tieFormatDesc:c}=fh(n),u=T((a??[]).filter((t=>!(s??[]).includes(t))).concat((s??[]).filter((t=>!(a??[]).includes(t))))),d=!(!t?.collectionName||e.collectionDefinitions.map((({collectionName:t})=>t)).join("|")===n.collectionDefinitions.map((({collectionName:t})=>t)).join("|")),p=!(!t?.collectionOrder||e.collectionDefinitions.map((({collectionOrder:t})=>t)).join("|")===n.collectionDefinitions.map((({collectionOrder:t})=>t)).join("|")),l=Object.assign({},...(e?.collectionDefinitions||[]).map((t=>({[t.collectionId]:t})))),m=Object.assign({},...(n?.collectionDefinitions||[]).map((t=>({[t.collectionId]:t}))));r.collectionIds=F(Object.keys(l),Object.keys(m)),i.collectionIds=F(Object.keys(m),Object.keys(l)),r.collectionsValue=Ih(l),i.collectionsValue=Ih(m),r.groupsCount=n?.collectionGroups?.length??(0-(e?.collectionGroups?.length??0)||0),i.groupsCount=r.groupsCount?-1*r.groupsCount:0;const f=r.collectionsValue.totalValue-i.collectionsValue.totalValue,h=r.collectionsValue.totalMatchUps-i.collectionsValue.totalMatchUps,I=i.collectionsValue.assignmentValues.length!==r.collectionsValue.assignmentValues.length,g=i.collectionsValue.assignmentValues.some(((t,e)=>{const n=r.collectionsValue.assignmentValues[e];return!n||(t.valueKey!==n.valueKey||(t.value!==n.value||!!Array.isArray(t.value)&&t.value.every(((t,e)=>n.value[e]===t))))})),U=d||p||c!==o||I||g||0!==f,y=[...i.collectionsValue.invalidValues,...r.collectionsValue.invalidValues],S=y.length&&y;return{matchUpFormatDifferences:u,matchUpCountDifference:h,descendantDifferences:r,ancestorDifferences:i,orderDifference:p,valueDifference:f,nameDifference:d,descendantDesc:o,ancestorDesc:c,...L,different:U,invalid:S}}function Ih(t){const e=[],n=[];let r=0;return{totalValue:Object.keys(t).sort(mh).reduce(((i,a)=>{const o=t[a],{collectionValueProfiles:s,collectionValue:c,matchUpCount:u,matchUpValue:d,scoreValue:p,setValue:l}=o,m={collectionValueProfiles:s,collectionValue:c,matchUpValue:d,scoreValue:p,setValue:l},f=Object.keys(m).filter((t=>![void 0,null].includes(m[t])));1!==f.length&&e.push({collectionId:a});const h=f[0];if(h){const t="collectionValueProfiles"===h?Object.values(s):m[h];n.push({valueKey:h,value:t})}return r+=u,s?i+s.reduce(((t,e)=>t+e.value),0):u?v(d)?i+d*u:v(p)?i+p*u:v(l)?i+l*u:i+c:i}),0),totalMatchUps:r,invalidValues:e,assignmentValues:n}}const gh=["collectionId","collectionPosition","drawPositions","extensions","finishingPositionRange","finishingRound","isMock","matchUpId","matchUpStatus","matchUpStatusCodes","orderOfFinish","processCodes","roundNumber","tieFormat","tieMatchUps","roundPosition","score","sides","winnerMatchUpId","loserMatchUpId","matchUpDuration","winningSide"];function Uh({drawDefinition:t,stages:e}){if(!t)return{error:Y};const n=T((t?.structures||[]).filter((t=>!e?.length||t.stage&&e.includes(t.stage))).map((t=>{const{positionAssignments:e}=Rp({structure:t});return e?e.map(ui("participantId")):[]})).flat().filter(Boolean));return{...L,assignedParticipantIds:n}}function yh({requireTimeStamp:t,scaleAttributes:e,participant:n}){if(!n)return{error:xe};if("object"!=typeof e)return{error:xn};if(n.timeItems||(n.timeItems=[]),Array.isArray(n.timeItems)){const{accessor:r,scaleType:i,eventType:a,scaleName:o}=e,s=[ds,i,a,o].join("."),c=n.timeItems.filter((t=>t?.itemType===s)).filter((e=>!t||e?.itemDate)).sort(((t,e)=>(t.createdAt?new Date(t.createdAt).getTime():0)-(e.createdAt?new Date(e.createdAt).getTime():0))).pop();if(c){const[t,e,n,i]=c.itemType?.split(".")??[];if(t!==ds)return{error:Nn};const a=r&&ai({element:c.itemValue,accessor:r}),o=a?.value||c.itemValue,s={eventType:n,scaleDate:c.itemDate,scaleValue:o,scaleName:i,scaleType:e};return{...L,scaleItem:s}}}return{...L,scaleItem:void 0}}function Sh({court:t,date:e}){const n=e&&t.dateAvailability.find((t=>ei(t.date,e))),r=t.dateAvailability.find((t=>!t.date));return n||r}function vh({includeBookingTypes:t=[],courtDate:e}){const n=[];let r=Jr(e.startTime);(e.bookings||[]).filter((e=>!e.bookingType||!t.includes(e.bookingType))).sort(((t,e)=>Gr(t.startTime).localeCompare(Gr(e.startTime)))).forEach((t=>{const e={startTime:qr(r.toISOString()),endTime:t.startTime};Jr(t.startTime)>r&&n.push(e),Jr(t.endTime)>r&&(r=Jr(t.endTime))}));const i={startTime:qr(r.toISOString()),endTime:e.endTime};return Jr(e.endTime)>r&&n.push(i),n}function wh(t){const{averageMatchUpMinutes:e,includeBookingTypes:n,periodStart:r,date:i}=t,a=t.courts,o=Jr(r),s=Zr(o,e),{enoughTime:c}=function({averageMatchUpMinutes:t,includeBookingTypes:e,periodStartTime:n,periodEndTime:r}){function i(e){const i=Jr(e.startTime),a=Jr(e.endTime);return!(i>n)&&(!(a<r)&&Qr(n,a)>=t)}return{enoughTime:t=>!!vh({includeBookingTypes:e,courtDate:t}).filter(i).length}}({averageMatchUpMinutes:e,includeBookingTypes:n,periodStartTime:o,periodEndTime:s});return{availableToScheduleCount:(a?.filter((t=>{if(!Array.isArray(t.dateAvailability))return!1;const e=Sh({date:i,court:t});return!(!e||!c(e))}))||[]).length}}function Th(t){const{remainingScheduleTimes:e=[],clearScheduleDates:n,periodLength:r=30,scheduleDate:i,courts:a=[]}=t;let{bookings:o=[]}=t;if(!Array.isArray(a)||!a.length)return{error:xn,courts:a};if(!Array.isArray(o))return{error:Ie};if(!Cr(i))return{error:ye};n&&(Array.isArray(n)?n.includes(i)&&(o=[]):o=[]);const{courtBookings:s,unassignedBookings:c}=o.reduce(((t,e)=>{const{courtId:n}=e;return n?t.courtBookings[n]?t.courtBookings[n].push(e):t.courtBookings[n]=[e]:t.unassignedBookings.push(e),t}),{courtBookings:{},unassignedBookings:[]}),u=a.map(((t,n)=>{const{courtId:r,courtName:a}=t,o=s[r]||[],c=Sh({date:i,court:t})||{},{bookings:u=[],startTime:d,endTime:p,date:l}=c;return{courtId:r,courtName:a,dateAvailability:{bookings:[e[n]&&{startTime:d,endTime:e[n]},...ri(u,!1,!0),...o].filter(Boolean),startTime:d,endTime:p,date:l}}}));c.sort(((t,e)=>jr(t.startTime)-jr(e.startTime)));const d=[];for(const p of c){const{startTime:t,endTime:e,averageMinutes:n,recoveryMinutes:i,matchUpId:a}=p,o=jr(t),s=jr(e),c=u.map((t=>{const e=vh({courtDate:t.dateAvailability});return{courtName:t.courtName,courtId:t.courtId,timeSlots:e}})).flat().reduce(((t,{courtId:e,courtName:n,timeSlots:i})=>{let a;return i.find((({startTime:e,endTime:n})=>{a=jr(e)-o;const i=o>=jr(e);return s<=jr(n)&&0!==t.startDifference&&((0===a||a+r>=0)&&(void 0===t.startDifference||a<t.startDifference)||i)}))?{courtName:n,courtId:e,startDifference:a}:t}),{});if(c.courtId){const r={averageMinutes:n,recoveryMinutes:i,matchUpId:a,startTime:t,endTime:e};d.push(r);const o=u.find((({courtId:t})=>t===c.courtId));o?.dateAvailability.bookings.push(r)}else console.log({unassignedBooking:p})}return{virtualCourts:u.map((({courtId:t,courtName:e,dateAvailability:n})=>({dateAvailability:[n],courtName:e,courtId:t}))),assignedBookings:d}}function Ph({averageMatchUpMinutes:t,periodLength:e=30,recoveryMinutes:n}){const r=(t||90)+(n||0);return e>r?r:e||30}function Dh({scheduleDate:t,startTime:e,endTime:n,courts:r}){const i=(e?"startTime":n&&"endTime")||void 0;return r.reduce(((r,a)=>{const o=Sh({date:t,court:a}),s=i&&(o?.[i]||a[i]);return s&&(!r||e&&jr(s)<jr(r)||n&&jr(s)>jr(r))?s:r}),void 0)}function Nh(t){const{startTime:e="8:00",endTime:n="20:30",count:r=10,date:i}=t||{};return E(0,r).map((()=>({dateAvailability:[{date:i,startTime:e,endTime:n}]})))}function Rh(t){let{date:e=Or(),startTime:n="08:00",endTime:r="19:00",periodLength:i,courts:a}=t;const{calculateStartTimeFromCourts:o=!0,remainingScheduleTimes:s,averageMatchUpMinutes:c,clearScheduleDates:u,courtsCount:d,bookings:p}=t;i=i||Ph({averageMatchUpMinutes:c}),e=$r(e),n=qr(n),r=qr(r);let l=0,f=0,h=0,I=0,g=0;!a&&d&&(a=Nh({startTime:n,endTime:r,count:d,date:e}));const{virtualCourts:U}=Th({remainingScheduleTimes:s,clearScheduleDates:u,scheduleDate:e,periodLength:i,bookings:p,courts:a}),{firstTimeSlotStartTime:y}=function({averageMinutes:t,startTime:e,endTime:n,courts:r,date:i}){let a;if(e=e||Dh({courts:r,scheduleDate:i,startTime:!0}),n=n||Dh({courts:r,scheduleDate:i,endTime:!0}),e&&n){const o=Jr(e),s=Jr(n);for(const e of r||[])Array.isArray(e.dateAvailability)&&vh({courtDate:Sh({court:e,date:i})}).forEach((e=>{const n=Jr(e.startTime),r=Jr(e.endTime);if(n>s||n<o)return!1;if(r<o)return!1;if(Qr(n,r)>=t){const t=qr(n.toISOString());(!a||t<a)&&(a=t)}}))}return{firstTimeSlotStartTime:a}}({averageMinutes:c,courts:U,startTime:n,endTime:r,date:e});o&&y&&(n=y||n);const S=jr(n),v=jr(r)-S,w=E(0,Math.floor(v/i)+1).map((t=>{const n=function(t){let e=Math.floor(t/60);const n=t-60*e;return e>23&&(e%=24),[ti(e),ti(n)].join(":")}(S+t*i),{availableToScheduleCount:r}=wh({courts:U||[],averageMatchUpMinutes:c,periodStart:n,date:e}),a=r>f?r-f:0;g+=t?r:0;const o=t?g/t:r,s=t?i*o/c*(t-1)+o:o,u=r?f&&s-l||a:0;l=s,f=r,h+=u;const d=m(h)-I;return I+=d,{periodStart:n,add:d,availableToScheduleCount:r,newCourts:a,totalMatchUps:I}}));return{scheduleTimes:w.reduce(((t,e)=>{const n=E(0,e.add).map((()=>({scheduleTime:e.periodStart})));return t.concat(...n)}),[]).flat(),timingProfile:w,totalMatchUps:I}}const bh={getCourtsAvailableAtPeriodStart:wh,generateTimeSlots:vh,getScheduleTimes:Rh,courtGenerator:Nh};function Mh({tiebreakTo:t=7,scoreString:e}){return e.split(" ").filter(Boolean).map(((e,n)=>function({set:e,setNumber:n}){const r=e?.startsWith("[")&&e.split("[")[1].split("]")[0].split("-").map((t=>parseInt(t))),i=e.includes("(")&&e.split("(")[0]||e.includes("[")&&e.split("[")[0]||e,a=!r&&i.split("-").map((t=>parseInt(t))),o=r?(r[0]>r[1]?1:r[0]<r[1]&&2)||void 0:(a[0]>a[1]?1:a[0]<a[1]&&2)||void 0,s=e.includes("(")?e.split("(")[1].split(")")[0]:void 0,c=s&&Cm({lowValue:s,isSide1:2===o,tiebreakTo:t})||[],[u,d]=a||[],[p,l]=r||c||[];return{side1Score:u,side2Score:d,side1TiebreakScore:p,side2TiebreakScore:l,winningSide:o,setNumber:n}}({set:e,setNumber:n+1})))}function Ah({drawPositions:t}){const e=[].concat(...t.map((e=>t.filter((t=>t!==e)).map((t=>[e,t]))))),n=T(e.map(Eh)).map((t=>t.split("|").map((t=>+t))));return{groupMatchUps:e,uniqueMatchUpGroupings:n}}function Eh(t){return[...t].sort(l).join("|")}function Ch({groupSize:t,drawPositionOffset:e}){const n=t=>[...Array(t)].map(((t,e)=>e)),r=n(2*Math.round(t/2)+1).slice(1),i=n(r.length-1).map((()=>[]));let a=r.slice(0,r.length/2),o=r.slice(r.length/2);r.slice(1).forEach(((t,e)=>{a.forEach(((t,n)=>{i[e].push([a[n],o[n]])}));const n=a.shift(),r=a.pop(),s=o.shift();a=[n,s,...a].filter(Boolean),o=[...o,r].filter(Boolean)}));const s=a.shift(),c=a.pop(),u=o.shift();a=[s,u,...a].filter(Boolean),o=[...o,c].filter(Boolean);const d=t=>t[0].reduce(((t,e)=>t+e));return[...i].reverse().sort(((t,e)=>d(t)-d(e))).map((n=>n.filter((e=>e.every((e=>e<=t)))).map((t=>Eh(t.map((t=>t+e)))))))}const Oh={getRoundRobinGroupMatchUps:Ah,determineRoundNumber:function({rounds:t,hash:e}){return t.reduce(((t,n,r)=>n.includes(e)?r+1:t),void 0)},drawPositionsHash:Eh,groupRounds:Ch},Fh="\\d+-\\d+",kh="\\d+-\\d+\\(\\d+\\)",xh="\\[\\d+-\\d+\\]",_h=new RegExp(`(${Fh}),`,"g"),Lh=new RegExp(`(${kh}),`,"g"),Bh=[Fh,kh,xh,"\\d+-\\d+\\(\\d+-\\d+\\)"],Vh=["0","1","2","00","01","10","11","002","012","102","112","000","001","010","100","011","101","110","111","002","012","102","112","0002","0012","0102","1002","0112","1012","1102","1112","3","03","13","013","103"].map((t=>{const e=t.split("").map((t=>Bh[t])).join(" ");return new RegExp(`^${e}$`)}));function jh(t){return!t||Vh.some((e=>e.test(t)))}function Gh(t){return/^\(\d+\)$/.test(t)||/^\(\d+$/.test(t)}function qh(t){const e=(n=t,n?.split("-").join("").split("/").join(""));var n;if(/^\d+$/.test(e)&&2===e.length){const t=e.split("");return 1===Math.abs(t.reduce(((t,e)=>+t-+e)))}return!1}function $h(t,e){const n=[t.slice(e,e+2),e?t.slice(0,1):t.slice(2)].map((t=>parseInt(t.join("")))),r=e?n.reverse():n;if(Math.abs(r.reduce(((t,e)=>+t-+e)))>=2)return r.join("-")}function Wh(t){return 2===t.length?t.split("").join("-"):([", ",",","/"," "].forEach((e=>t=t.split(e).join("-"))),t=t.replace(/-{2,}/,"-"))}function Hh(t){return t.startsWith("(")&&t.endsWith(")")}function zh(t){if(!/^[\d-]+(\(\d\))*$/.test(t))return t;const e=C("-",t.split(""));if(!e.length)return t;const n=t.split("-"),r=!(n.length%2),i=!!(e.length%2);if(r&&i&&e.length>n.length/2){e.filter(((t,e)=>e%2)).forEach((e=>{t=t.substring(0,e)+" "+t.substring(e+1)}))}return t}function Yh({score:t}){const e=t.split(""),n=[];let r;const i=()=>r=[void 0,void 0,void 0],a=()=>{let t=`${r[0]}-${r[1]}`;return r[2]&&(t+=` (${r[2]})`),i(),r.push(r),t};i();const o=()=>void 0!==r[0]&&void 0!==r[1]&&Math.abs(parseInt(r[0])-parseInt(r[1]));for(;e.length;){const t=e.shift(),i=U(t)&&parseInt(t),s=void 0!==r[0]&&void 0!==r[1];if(U(i)){if(void 0===r[0]){r[0]=i;continue}if(void 0===r[1]&&(r[1]=i,o())){n.push(a()),r=[void 0,void 0];continue}if(s&&1===e.length&&U(e[0])){const t=e.pop();r[0]=r[0].toString()+r[1].toString(),r[1]=t,n.push(a()),r=[void 0,void 0]}s&&o()}}return{sets:n}}function Kh(t){const e=t.indexOf("1"),n=t.split(""),r=n.every((t=>!isNaN(t)));if(r&&3===t.length&&0===e){const t=$h(n,e);if(t)return t}if(r&&7===t.length&&e>3){const t=$h(n.slice(4),e-4);if(t)return`${n[0]}-${n[1]} ${n[2]}-${n[3]} ${t}`}}function Jh(t){let{score:e}=t;const{applied:n,matchUpStatus:r}=t,i=e?.toString().split(""),a=i?.every((t=>U(t))),o=t=>Math.abs(t[0]-t[1]);if("number"==typeof e||a){e=e.toString().toLowerCase(),a&&(e=i.join(""));const t=a?i.map((t=>parseInt(t))):e.split("").map((t=>parseInt(t)));if(Yh({score:e}),t.length,3===e.length&&1===o(t.slice(0,2))){const[r,i,a]=t;e=`${r}-${i}(${a})`,n.push("numericTiebreakPattern1")}else if(3===e.length&&1===t[0]){const[r,i,a]=t;e=`[${r}${i}-${a}]`,n.push("numericTiebreakPattern2")}else if(4===e.length&&1===o(t.slice(0,2))&&"987654".split("").includes(t[0].toString())){const[r,i,a,o]=t;e=`${r}-${i}(${Math.min(a,o)})`,n.push("numericTiebreakPattern3")}else if(4===e.length&&1===t[0]&&1===t[2]){const[r,i,a,o]=t;e=`[${r}${i}-${a}${o}]`,n.push("bigSuper")}else if(4===e.length){const[r,i,a,o]=t;e=`${r}${i} ${a}${o}`,n.push("split4")}else if(5===e.length&&1===o(t.slice(0,2))){const[r,i,a,o,s]=t;e=`${r}-${i}(${a}) ${o}-${s}`,n.push("numericTiebreakPattern4")}else if(5===e.length&&1===o(t.slice(3))){const[r,i,a,o,s]=t;e=`${r}-${i} ${a}-${o}(${s})`,n.push("numericTiebreakPattern5")}else if(7===t.length)if(o(t.slice(0,2))>1&&o(t.slice(2,4))>1&&1===t[4]){const[r,i,a,o,s,c,u]=t;e=`${r}-${i} ${a}-${o} [${s}${c}-${u}]`,n.push("numericTiebreakPattern6")}else if(1===o(t.slice(0,2))&&o(t.slice(3,5))>1&&o(t.slice(5,7))>1){const[r,i,a,o,s,c,u]=t;e=`${r}-${i}(${a}) ${o}-${s} ${c}-${u}`,n.push("numericTiebreakPattern7")}else if(o(t.slice(0,2))>1&&1===o(t.slice(2,4))&&o(t.slice(5,7))>1){const[r,i,a,o,s,c,u]=t;e=`${r}-${i} ${a}-${o}(${s}) ${c}-${u}`,n.push("numericTiebreakPattern8")}else if(o(t.slice(0,2))>1&&o(t.slice(2,4))>1&&1===o(t.slice(4,6))){const[r,i,a,o,s,c,u]=t;e=`${r}-${i} ${a}-${o} ${s}-${c}(${u})`,n.push("numericTiebreakPattern9")}else e=e.slice(0,2)+" "+e.slice(2,4)+" "+e.slice(4),n.push("numericMatchTiebreakPattern");else if(e.length%2){const t=Kh(e);t&&e!==t&&n.push("parsedSuperPattern"),e=t||e}else{const r=x(e.split(""),2).map((t=>t.join(""))),i=r.map((t=>{const[e,n]=t.split("").map((t=>parseInt(t))),r=e>n?1:2;return Math.abs(e-n)>1&&r||-1*r})),a=i.reduce(((t,e)=>t>0&&e>0),1),o=N(i),s=N(i.map((t=>Math.abs(t)))),c=i[0]<0,u=!c&&i[1]<0;if(i[0]>0&&i[1]>0&&i[0]!==i[1])e=[r.slice(0,2).join(" "),r.slice(2).join("-")].join(" "),n.push("numeric3rdSetTiebreakPattern");else if(a)e=r.join(" "),n.push("chunkSplit");else if(6==t.length){if(2==o[1]||2===o[2])if(Object.values(s).includes(3)){const[r,a,o,s,c,u]=t,d=i.reduce(((t,e,n)=>e<0?n:t),void 0);if(0===d){e=`${r}-${a}(${Math.min(o,s)}) ${c}-${u}`,n.push("chunkSplitTiebreak1")}else if(1===d){e=`${r}-${a} ${o}-${s}(${Math.min(c,u)})`,n.push("chunkSplitTiebreak2")}else e=`${r}-${a} ${o}-${s}`,n.push("chunkSplitTrimExtraneous")}else e=r.join(" "),n.push("chunkSplit")}else if(8===t.length){const[n,r,a,o,s,d,p,l]=t;c||u?1===t[5]&&(e=c?`${n}-${r}(${a}) ${o}-${s} [${d}${p}-${l}]`:`${n}-${r} ${a}-${o}(${s}) [${d}${p}-${l}]`):(i[0],i[1])}}}return{score:e,applied:n,matchUpStatus:r}}function Qh(t){const e=[0,0],n=[],r=t.split(" "),i=/(\d+)-(\d+)/;r.forEach((t=>{if(i.test(t)){const r=t.match(i).slice(1).map((t=>parseInt(t))),a=r[0]>r[1]?1:r[1]>r[0]&&2;a&&(e[a-1]+=1,n.push(a))}}));const a=e[0]>e[1]?1:e[1]>e[0]&&2,o=e[0]>0&&e[0]===e[1],s=e.reduce(((t,e)=>t+e),0);return{setsWon:e,setsTied:o,setWinners:n,totalSets:s,winningSide:a}}const Xh={handleTiebreakSlashSeparation:function({score:t}){const e=new RegExp(/\(\d+\/\d+\)/g),n=t.match(e);for(const r of n||[]){const e=r.replace("/","-");t=t.replace(r,e)}return{score:t}},handleSetSlashSeparation:function({score:t}){return new RegExp(/-\d+\/\d+-/).test(t)&&(t=t.split("/").join(" ")),{score:t}},punctuationAdjustments:function({score:t,applied:e}){t=function(t){const e="[];",n="()",r=e+n,i=[e[0],n[0]],a=Object.assign({},...r.split("").map((t=>({[t]:0}))));let o="";const s=t.split("").map((t=>{const s=r.includes(t)&&t,c=i.includes(s);if(c&&s)return a[s]+=1,o=s,t;if(!c&&s&&o&&s!==o){a[o]-=1;const t=e.includes(o)&&e||n.includes(o)&&n||"",r=t.split("").find((t=>t!==o));if(!t.includes(s))return a[s]||(o=""),r;a[o]||(o="")}return t})).join("");return t!==s?s:t}(t);const n=/\)(\d+)/g;if(n.test(t))for(const S of t.match(n)){const e=S.replace(")",") ");t=t.replace(S,e)}const r=/\(([\d- ]+)\)/,i=(t=(t=t.replace(/\)\//g,") / ")).replace(/\/\)/g,")")).match(/\(([\d- ]+)\)/g);for(const S of i||[]){const[e]=S.match(r).slice(1),n=e.replace(/ /g,"");t=t.replace(S,`(${n})`)}let a=/\(\(\d-\d\)\)/g;if(a.test(t)){const e=t.match(a);e.length&&e.forEach((e=>{const n=e.match(/\((\(\d-\d\))\)/).slice(1)[0];t=t.replace(e,n)}))}if(a=/\(\((\d)\)\)/g,a.test(t)){const e=t.match(a);e.length&&e.forEach((e=>{const n=e.match(/\((\(\d\))\)/).slice(1)[0];t=t.replace(e,n)}))}/(^|\s)6-,/.test(t)&&(t=t.replace(/(^|\s)6-,/g,"6-0,"));const o=new RegExp(/[-,]{2,}/g);t=t.replace(o,"-"),["- "," -"].forEach((e=>{const n=new RegExp(`(\\d+)${e}(\\d+)`,"g"),r=t.match(n);r&&r.forEach((n=>t=t.replace(n,n.split(e).join("-"))))})),/^[(-/,]+$/.test(t)&&(t=""),/\)[-/,]+$/.test(t)&&(t=t.slice(0,t.length-1)),/\d \/\d/.test(t)&&(t=t.replace(/ \//g,"/")),t.includes(" /")&&(t=t.replace(/ \//g," "));const s=/\(\d+, \)/g;if(s.test(t)){t.match(s).forEach((e=>{const[n]=e.match(/\((\d+), \)/).slice(1);2===n.length?t=t.replace(e,`(${n})`):1===n.length&&"6"===n&&(t=t.replace(e,"(6-0)"))}))}const c=/\((\d+)\/\)/g;if(c.test(t)){t.match(c).forEach((e=>{const[n]=e.match(/\((\d+)\/\)/).slice(1);t=2===n.length?t.replace(e,`(${n})`):1===n.length&&"6"===n?t.replace(e,"(6-0)"):t.replace(e,`(${n})`)}))}const u=/\d\/\d\/,/g;if(u.test(t)){t.match(u).forEach((n=>{const[r]=n.match(/(\d\/\d)\/,/).slice(1);t=t.replace(n,`${r},`),e.push("slashComma")}))}const d=/\(\/(\d+)\)/g;if(d.test(t)){t.match(d).forEach((e=>{const[n]=e.match(/\(\/(\d+)\)/).slice(1);t=2===n.length?t.replace(e,`(${n})`):1===n.length&&parseInt(n)<6?t.replace(e,`(6-${n})`):t.replace(e,`(${n})`)}))}let p,l,m,f,h;const I=()=>{h=N(t.split("")),l=h["("]===(h[")"]||0)+1,p=(h["("]||0)+1===h[")"],m=h["["]===h["]"]+1,f=l&&!m};I();const g=/(\d+-\d+\(\d+)0,/;if(g.test(t)){const[e]=t.match(g).slice(1);t=t.replace(g,e+")")}if(h["("]===h[")"]&&h["("]>1){const e=t.split(")(").join(") (").split(" ");t=e.every(Hh)?e.map((t=>{const e=t.slice(1,t.length-1);return e.length>2?e:t})).join(" "):e.join(" ")}I();const U=/[A-Za-z]+/.test(t),y=/\d+/.test(t);if(!U&&!y)return{score:""};if(/^\[.+\]$/.test(t)&&"()/,- ".split("").some((t=>h[t]))&&(t=t.slice(1,t.length-1)),/^\(.+\)$/.test(t)&&1===h["("]&&1===h[")"]&&"[]/,".split("").some((t=>h[t]>1))&&(t=t.slice(1,t.length-1)),t.startsWith("(")&&t.endsWith("))")&&(t=t.slice(1,t.length-1)),h["("]>(h[")"]||0)&&"("===t[t.length-1]&&(t=t.slice(0,t.length-1)+")",I()),1!==h["("]||h[")"]||"("!==t[0]||(t+=")",I()),h["("]>(h[")"]||0)&&"(("===t.slice(0,2)&&(t=t.slice(1)),p){if(/^9\d/.test(t))t="("+t.slice(1);else if("("!==t[0])t="("+t;else{const e=[];let n=0;for(const r of t.split("").reverse())")"===r&&(n?e.push("("):n+=1),"("===r&&(n-=1),e.push(r);e.reverse(),t=e.join("")}I()}if(h[")"]>(h["("]||0)&&")"===t[0]&&(t="("+t.slice(1),I()),f&&(t.endsWith(9)||/\d+0$/.test(t))&&(t=t.slice(0,t.length-1)+")",I()),!f||t.endsWith(")")&&!t.startsWith("((")||(t+=")",I()),f){let e="",n=0;for(const r of t.split(""))"("===r&&(n?e+=")":n+=1),")"===r&&(n-=1),e+=r;t=e}if(I(),m&&!l&&(t+="]"),t.includes("([")&&t.includes("])")&&(t=t.split("([").join("[").split("])").join("]"),I()),/\(\d+0$/.test(t)&&(t=t.slice(0,t.length-1)+")"),I(),1===h[")"]&&!h["("]&&t.endsWith(")")&&(t=t.slice(0,t.length-1)),t.startsWith("(")&&t.endsWith(")")&&1===h["("]&&1===h[")"]&&(t=t.slice(1,t.length-1),I()),/^\([\d ]+.*[\d ]+\)$/.test(t)&&h["("]===h[")"]){const e=t.slice(1,t.length-1);(t=>{const e=t.indexOf("("),n=t.indexOf(")");return e>=0&&n>=0&&e<n})(e)&&(t=e,I())}return{score:t,applied:e}},handleGameSeparation:function({score:t}){const e=new RegExp(/^\d+\/\d+/),n=t.split(" ");n.some((t=>e.test(t)))&&(t=n.map((t=>e.test(t)?t.replace("/","-"):t)).join(" "));const r=/^(\d+), *(\d+)$/;if(r.test(t)){const[e,n]=t.match(r).slice(1);t=[e,n].join("-")}return{score:t}},joinFloatingTiebreak:function({score:t}){if("string"!=typeof t)return{score:t};const e=t=>t?.split("-").join("").split("/").join(""),n=t=>t.split("[").join("(").split("]").join(")");let r=(t=t.split(", ").join(" ")).split(" ");t=r.map((t=>{const e=/^-(\d+)$/;if(e.test(t)){const[n]=t.match(e).slice(1);if(2===n.length)return n.split("").join("-")}return t})).join(" "),r=t.split(" ");const i=r.filter(Gh);let a=0,o="";for(const l of i){const t=C(l,r).filter((t=>!a||t>a))[0],n=r.slice(a,t-1),i=r[t-1],s=e(i);if(/^\d+$/.test(s)&&2===s.length){const e=s.split(""),r=Math.abs(e.reduce(((t,e)=>+t-+e)));if(1===r){o+=[n.join(" "),[i,l].join("")].join(" "),a=t+1}else if(0===r){const r=Math.max(...e);if([4,5,6,7,8,9].includes(r)){const e=[r,[6,4].includes(r)?r+1:r-1].sort().reverse().join("-");o+=[n.join(" "),[e,l].join("")].join(" "),a=t+1}}}}if(i.length&&o.length){return o=[o,r.slice(a).join(" ")].join(" "),{score:o.trim()}}if(2===r.length&&["(","["].some((t=>r[1].includes(t)))){const t=e(r[0]).split("");if(1===Math.abs(t.reduce(((t,e)=>+t-+e),0)))return r[1]=n(r[1]),{score:r.join("")}}const s=r.map((t=>function(t){return/^\(\d+-\d+\)$/.test(t)||/^\[\d+-\d+\]$/.test(t)}(t)?"bracket":qh(t)&&"set"));if(s.includes("set")&&s.includes("bracket")){let t,e="";return r.forEach(((r,i)=>{"bracket"===s[i]&&"set"===t?(r=n(r),e+=r):e+=` ${r}`,t=s[i]})),{score:e.trim()}}let c;r=t.split(" ");let u=r.map((t=>{const e=new RegExp(/^(\d+)-(\d+)$/);if(e.test(t)){const[n,r]=t.match(e).slice(1),i=Math.abs([n,r].reduce(((t,e)=>+t-+e))),a=Math.max(n,r);if(1===i)return c="tiebreakSet",c;if(i>=2&&a>=7&&"tiebreakSet"===c)return c="tiebreak",c}}));const d=C("tiebreak",u);if(d.length){let e="";r.forEach(((t,n)=>{d.includes(n)?e+=`(${t}) `:d.includes(n+1)?e+=`${t}`:e+=`${t} `})),t=e.trim()}const p=/(\d+-\d+)\((\d+)-(\d+)\)$/;if(p.test(t)){const[e,n,r]=t.match(p).slice(1),i=Math.max(n,r)>=10;!qh(e)&&i&&(t=t.replace(p,`${e} [${n}-${r}]`))}return u=[],t=t.split(" ").map((t=>{const e=/^\((.*)\)$/,n=e.test(t),r=(new RegExp(xh).test(t)?"super":new RegExp(kh).test(t)&&"tiebreak")||new RegExp(Fh).test(t)&&"standard"||"unknown";return u.push(r),"standard"===r&&n?t.match(e)[1]:t})).join(" "),{score:t}},handleBracketSpacing:function({score:t,applied:e}){return t.includes("( ")&&(e.push("removeParenSpacingAfterOpen"),t=t.split("( ").map((t=>t.trim())).join("(")),t.includes(" )")&&(e.push("removeParenSpacingBeforeClose"),t=t.split(" )").map((t=>t.trim())).join(")")),[_h,Lh].forEach((n=>{const r=t.match(n);r?.length&&(r.forEach((e=>{t=t.replace(e,e.slice(0,e.length-1)+" ")})),e.push("setsEndComma"))})),{score:t=t.split(" ").filter(Boolean).map(zh).join(" "),applied:e}},handleSpaceSeparator:function({score:t}){if(t.includes(",")){const e=t.split(",").map((t=>t.trim())),n=t=>/\d \d/.test(t);e.every(n)&&(t=e.map((t=>{const e=/\d+ \d+/g;for(const n of t.match(e)){const[e,r]=n.match(/(\d+) (\d+)/).slice(1);t=t.replace(n,`${e}-${r}`)}return t})).join(" "))}if(t.includes(" ")){const e=t.replace(/[ ,]/g,"");e.split("").every((t=>U(t)))&&4===e.length&&(t=e)}return{score:t}},separateScoreBlocks:function({score:t,applied:e}){return"string"!=typeof t?{score:t}:{score:t=t.toLowerCase().split(" ").map((t=>{if(/^\d+$/.test(t)&&t.length>2){const n=t.indexOf("1");if(t.length%2){if(3===t.length&&0===n){const r=$h(t.split(""),n);return e.push("getSuper"),r}}else{const{score:n,applied:r}=Jh({score:t,applied:[]});n!==t&&(t=n,e.push(...r))}}return t})).join(" "),applied:e}},matchKnownPatterns:function({score:t,applied:e}){for(const T of[".",","," ","/"]){const n=new RegExp(`^(\\d+)\\${T}(\\d+)$`);if(n.test(t)){const r=t.match(n).slice(1).map((t=>parseInt(t))),i=Math.abs(r[0]-r[1]);i<=10&&i>=2&&(t=t.split(T).join("-"),e.push("variedJoinerPattern"))}}t.includes(";")&&(t=t.split(";").join(" "),e.push("semicolon set separation"));const n=/(^|\s)(\d)\/(\d)(\d)\/(\d)(\(|$)/;if(n.test(t)){const[r,i,a,o,s,c]=t.match(n).slice(1);t=t.replace(n,`${r}${i}-${a} ${o}-${s}${c}`),e.push("smashSlashPattern")}/.*\s6[/-]+$/.test(t)&&(t+="0",e.push("incompleteFinalSetPattern"));const r=/\(6,\)/g;r.test(t)&&(t=t.replace(r,"(6, 0)"),e.push("missingZeroPattern1"));const i=/^\d{3,}\(/,a=/\(\d+\)\d+/;[i,a].forEach((()=>{const n=t.split(" ");t=n.map((t=>(i.test(t)&&(t=t.replace("("," (")),a.test(t)&&(t=t.replace(")",") ")),t))).join(" "),e.push("spaceConsiderationPatterns")}));const o=zh(t);o!==t&&(t=o,e.push("deDashMash"));const s=/^(\d)[-/,]+(\d{2})[-/,]+(\d)$/;if(s.test(t)){const[n,r,i]=t.match(s).slice(1),[a,o]=r.split("");t=`${n}-${a} ${o}-${i}`,e.push("smashSetPattern")}const c=/^(\d+)[ -](\d+)$/,u=/^([\d -]+)\/([\d -]+)$/;if(u.test(t)){const[n,r]=t.match(u).slice(1),i=n.trim(),a=r.trim();if(c.test(i)&&c.test(a)){const n=i.match(c).slice(1,3).join("-"),r=a.match(c).slice(1,3).join("-");t=`${n} ${r}`,e.push("slashSeparationPattern")}}const d=/^([\d -]+),([\d -]+)$/;if(d.test(t)){const[n,r]=t.match(d).slice(1),i=n.trim(),a=r.trim();if(c.test(i)&&c.test(a)){const n=i.match(c).slice(1,3).join("-"),r=a.match(c).slice(1,3).join("-");t=`${n} ${r}`,e.push("commaSeparationPattern")}}const p=/^\d \d,/;if(p.test(t)){const n=t.match(p)[0],r=n.slice(0,n.length-1).split(" ").join("-");t=t.replace(n,r),e.push("singleSetCommaSeparationPattern")}let l=0;const m=/(\d+)-(\d{2})-(\d+)/;for(;m.test(t)&&l<3;){const[n,r,i]=t.match(m).slice(1),a=r.split(""),o=`${n}-${a[0]} ${a[1]}-${i}`;t=t.replace(m,o),e.push("noSetSeparationPattern"),l+=1}const f=t.match(/(^|\s)7-6\s(\d+)\s/g);if(f?.length){const n=/(^|\s)7-6\s(\d+)\s/;f.forEach((r=>{const i=r.match(n).slice(2)[0];t=t.replace(r,`7-6(${i}) `),e.push("floatingTiebreakPattern1")}))}let h=t.match(/\d \d /);h?.forEach((n=>{const r=n.slice(0,n.length-1).split(" ").join("-");t=t.replace(n,r),e.push("spaceSeparatedSetPattern1")})),h=t.match(/ \d \d$/),h?.forEach((n=>{const r=" "+n.slice(1).split(" ").join("-");t=t.replace(n,r),e.push("spaceSeparatedSetPattern2")}));const I=/^\d, *\d\/\d, *\d/;if(I.test(t)){const n=t.match(I)[0],r=n.split("/").map((t=>`(${t})`)).join(" ")+" ";t=t.replace(n,r),e.push("slashCommaSetPattern")}const g=/\(6-\)/g;g.test(t)&&(t=t.replace(g,"(6-0)"),e.push("missingZeroPattern2"));const U=/(?<!-)(\d+)\/(\d+)(?!-)/g;if(U.test(t)){const n=t.match(U),r=/(?<!-)(\d+)\/(\d+)(?!-)/;let i=t;n.forEach((t=>{const[e,n]=t.match(r).slice(1),a=`${e}-${n}`;i=i.replace(t,a)})),t=i,e.push("slashSetPattern")}const y=/(.*)\s(1\d)\s(\d+)$/;if(y.test(t)){const[n,r,i]=t.match(y).slice(1);n.replace(/\D/g,"").length>=4&&(t=n+` ${r}${i}`,e.push("spaceSeparatedSuperPattern"))}const S=/(^|\s)(\d+-\d+)\s(\d+)(\s|$)/g;for(const T of t.match(S)||[]){const[n,r,i,a]=T.match(/(^|\s)(\d+-\d+)\s(\d+)(\s|$)/).slice(1),[o,s]=r.split("-").map((t=>parseInt(t)));1===Math.abs(o-s)&&(t=t.replace(T,`${n}${r}(${i})${a}`),e.push("spaceSeparatedSetPattern"))}const v=/\d-\d \(\d{1,2}\)(\s|$|,)/g;for(const T of t.match(v)||[]){const n=/(\d-\d) \((\d{1,2})\)(\s|$|,)/,[r,i,a]=T.match(n).slice(1),[o,s]=r.split("-").map((t=>parseInt(t)));1===Math.abs(o-s)&&(t=t.replace(T,`${r}(${i})${a}`),e.push("floatingTiebreakPattern2"))}const w=/(^|\s)(\d \d)\(/g;for(const T of t.match(w)||[]){const n=/(^|\s)(\d \d)\(/,[r,i]=T.match(n).slice(1);t=t.replace(T,`${r}${i.split(" ").join("-")}(`),e.push("spacedTiebreakPattern")}return{score:t,applied:e}},removeDanglingBits:function({score:t,attributes:e}){(t.endsWith(" am")||t.endsWith(" pm"))&&(t=""),t=t.replace(/[A-Za-z]+/g,"").trim(),[".",","].some((e=>t.endsWith(e)))&&(t=t.slice(0,t.length-1));const n="()/-".split("").some((e=>t.includes(e)));if(/ \d$/.test(t)&&n){e={removed:t.slice(t.length-2).trim()},t=t.slice(0,t.length-2)}const r=/(.*)[A-Za-z]+$/;if(r.test(t)){const e=t.match(r).slice(1)[0];t=e.trim()}return{score:t,attributes:e}},removeErroneous:function({score:t,applied:e}){if("string"!=typeof t)return{score:t};if([3,4].includes(t.length)&&Kh(t)){return{score:Kh(t)}}return{score:t=t.toLowerCase().split(" ").map((t=>{if(!/^\d+$/.test(t)||1!==t.length)return t;e.push("removeErroneous1")})).filter(Boolean).join(" "),applied:e}},handleWalkover:function({score:t,applied:e}){return["walkover","wo","w/o","w-o"].includes(t?.toString().toLowerCase())?(e.push("handleWalkover"),{matchUpStatus:"walkover",score:"",applied:e}):{score:t}},properTiebreak:function({score:t,matchUpStatus:e}){let n=t?.split(" ");t=n.map((t=>{if(t.endsWith("]")){const e=t.split("[");if(qh(e[0]))return e[0]+`(${e[1].slice(0,e[1].length-1)})`}return t})).join(" ");const r=new RegExp(/(\([\d ]+\))/g);if(r.test(t))for(const s of t.match(r)){const e=s.replace(" ","-");let n=e.match(/\((.*)\)/)?.[1];if(U(n)&&n?.[0]>2)if([2,4].includes(n.length))n=n.split("").join("-");else if(3===n.length){const t=n.indexOf("1");n=$h(n.split(""),t)}t=t.replace(s,`(${n})`)}n=t?.split(" ");let i=new RegExp(/^(\d[-/]+\d)\((\d+)[-/]+(\d+)\)$/);const a=n.length-1;t=n.map(((t,n)=>{const r=[void 0,"","COMPLETED"].includes(e)||n!==a;if(i.test(t)&&r){const[e,n,r]=Array.from(t.match(i)).slice(1);return`${e}(${Math.min(n,r)})`}return t})).join(" "),n=t?.split(" "),i=new RegExp(/^(\d{2})\((\d+)\)$/),t=n.map((t=>{if(i.test(t)){const[e,n]=Array.from(t.match(i)).slice(1),r=e.split("");return`${r[0]}-${r[1]}(${n})`}return t})).join(" "),n=t?.split(" "),i=new RegExp(/^\((\d[-/]+\d)\)(\d+)$/),t=n.map((t=>{if(i.test(t)){const[e,n]=Array.from(t.match(i)).slice(1);return qh(e)?`${e}(${n})`:e}return t})).join(" "),n=t?.split(" "),i=new RegExp(/^1-0\((\d+)\)$/),t=n.map((t=>{if(i.test(t)){const[e]=t.match(i).slice(1);return`[${e<9?10:parseInt(e)+2}-${e}]`}return t})).join(" ");const o=/\((\d)+0 /;if(o.test(t)){const e=t.match(o)[1];t=t.replace(o,`(${e}) `)}return{score:t}},handleNumeric:Jh,handleRetired:function({score:t,profile:e,applied:n}){t=t?.toString().toLowerCase();const r=/^(.*\d+.*)(ret|con)+[A-Za-z ]*$/;if(r.test(t)){const[e]=t.match(r).slice(1);return n.push("handleRetired"),{score:e.trim(),matchUpStatus:"retired",applied:n}}const i=e?.matchUpStatuses?.retired,a=["rtd",...Array.isArray(i)?i:[i].filter(Boolean)].find((e=>t?.endsWith(e)));return a?(n.push("handleRetired"),{matchUpStatus:"retired",score:t?.replace(a,"").trim(),applied:n}):{score:t}},containedSets:function({score:t,attributes:e,identifier:n}){if("string"!=typeof t)return{score:t,identifier:n};const r=new RegExp(/\([\d,/ ]+\)/g),i=t.match(r);for(const d of i||[]){const e=d.match(/^\((.*)\)$/),n=e?.slice(1)?.[0],r=t.split(d)[0].split(")").reverse()[0].replace(/\D/g,"");if(2===n?.length&&r?.length>=2){const t=r.slice(r.length-2).split("").map((t=>parseInt(t)));if(1===Math.abs(t[0]-t[1]))continue}const i=zh(Wh(n));t=t.replace(d,`(${i})`).trim()}const a=new RegExp(/\[[\d,/ ]+\]/g),o=t.match(a);o?.forEach((e=>{const n=Wh(e.match(/^\[(.*)\]$/)[1]);t=t.replace(e,`(${n}) `).trim()}));const s=[")(","), (",") (",")[",") [","](","] ("];if(t.startsWith("(")&&[")","]"].some((e=>t.endsWith(e)))&&s.some((e=>t.includes(e)))){let e="";const n=t.split(/[)\]]/).filter(Boolean).map((t=>(t.startsWith(",")&&(t=t.slice(1)),t.trim()))),r=n.every((t=>t.includes(",")||Gh(t))),i=n.every((t=>t.includes("/")||Gh(t))),a=n.every((t=>t.includes("-")||Gh(t))),o=(r?",":a&&"-")||i&&"/";if(o){let r;n.forEach((t=>{if(t.startsWith("("))if("set"===r&&(e+=" "),t.includes(o))e+=t.slice(1).split(o).map((t=>t.trim())).join("-"),r="set";else{const n=t.slice(1);e+=`(${n}) `,r="tiebreak"}else if(t.startsWith("[")){const n=t.slice(1).split(o).map((t=>parseInt(t.trim()))),i=Math.min(...n);e+="set"===r?`(${i}) `:`[${n.join("-")}] `,r="tiebreak"}})),t=e.trim()}}const c=N(t.split(""));1===c["("]&&1===c[")"]&&t.startsWith("(")&&t.endsWith(")")&&(t=t.slice(1,t.length-1),1===c["-"]&&qh(t)&&U(e?.removed)&&(t+=`(${e.removed})`,e.removed=void 0));const u=/\(\)/g;return u.test(t)&&(t=t.replace(u,"").trim()),{score:t}},sensibleSets:function({score:t,matchUpStatus:e,attributes:n}){const r=[];let i;const a=t.split(" "),o=a.length;t=a.map(((t,n)=>{if(new RegExp(kh).test(t)){const n=t.slice(3),r=t.slice(0,3),i=r.split("-");if(!qh(r)&&!e){const t=Math.max(...i),e=[t,t-1];return(r.indexOf(t)?e.reverse().join("-"):e.join("-"))+n}}else if(2===t.length&&U(t))return t.split("").join("-");t=zh(t);const a=(new RegExp(`^${xh}$`).test(t)?"super":new RegExp(`^${kh}$`).test(t)&&"tiebreak")||new RegExp(`^${Fh}$`).test(t)&&"standard"||"unknown";if(r.push(a),o>1&&"standard"===a&&n<2){const[e,r]=t.split("-"),a=Math.abs(parseInt(e)-parseInt(r)),o=Math.max(e,r),s=Math.min(e,r),c=[parseInt(e),parseInt(r)].indexOf(s);if(o>9&&a>2){const e=o.toString().split(""),r=e.find((t=>parseInt(t)>s||n&&parseInt(t)<=i))||e[0];r&&(t=c?[r,s].join("-"):[s,r].join("-"))}o>(i||0)&&(i=o)}if("standard"===a){const[n,r]=t.split("-");if(!Math.abs(parseInt(n)-parseInt(r))&&"RETIRED"!==e)return""}return t})).filter(Boolean).join(" ");const{setsWon:s,setWinners:c,totalSets:u}=Qh(t);if(1===u&&"6"===n?.removed&&(t+=" 6-0"),t.split(" ").length>2&&Math.max(...s)>=2&&c[0]===c[1]&&(t=t.split(" ").slice(0,2).join(" ")),Math.max(...s)>2){const e=[0,0];t=t.split(" ").map(((t,n)=>(e[c[n]]+=1,Math.max(...e)>2?void 0:t))).filter(Boolean).join(" ")}return{score:t,profile:r}},stringScore:function({score:t}){return{score:t=t?.toString().toLowerCase()||""}},superSquare:function({score:t}){const{setsTied:e,winningSide:n}=Qh(t),r=/\s\((\d+)\)$/;if(!n&&e&&r.test(t)){const e=t.match(r).slice(1)[0],n=e<=8?10:e+2;t=t.replace(r,` [${n}-${e}]`)}const i=t.split(" "),a=i[i.length-1];if(!a.includes("-")||a.indexOf("(")>0)return{score:t};let o=a.split("(").join("").split(")").join("").split("-");if(!o.every((t=>U(t))))return{score:t};if("76"===o[0]){const e=2===o[1].length?Math.min(...o[1].split("").map((t=>parseInt(t)))):o[1];t=[...i.slice(0,i.length-1),`7-6(${e})`].join(" ")}else{o=o.map((t=>parseInt(t)));const e=Math.max(...o);let n=Math.abs(o[0]-o[1]);if(e>=10){if(n>2&&o.every((t=>+t>=10))){const t=o.map((t=>t===e?t-10:10)).sort();n=Math.abs(t[0]-t[1]),n>2&&(o=t)}t=[...i.slice(0,i.length-1),`[${o.join("-")}]`].join(" ")}else 3===i.length&&e>=7&&n>2&&(t=[...i.slice(0,i.length-1),`[${o.join("-")}]`].join(" "))}return{score:t}},setBuilder:Yh,excisions:function({score:t}){const e=new RegExp(/^\[\d+\](.*)$/);e.test(t)&&(t=t.match(e).slice(1)[0].trim());const n=/\(,/g;return n.test(t)&&(t=t.replace(n,"(")),{score:t}},replaceOh:function({score:t,applied:e}){return"string"!=typeof t?{score:t}:(t.toLowerCase().includes("o")&&(t=t.toLowerCase().split(" ").map((t=>t.split("o").join("0"))).join(" "),e.push("replaceOh")),{score:t,applied:e})}};let Zh={};const tI=["handleNumeric","handleWalkover","handleRetired","replaceOh","stringScore","punctuationAdjustments","excisions","handleSpaceSeparator","matchKnownPatterns","removeDanglingBits","handleBracketSpacing","matchKnownPatterns","containedSets","separateScoreBlocks","handleGameSeparation","removeErroneous","joinFloatingTiebreak","handleSetSlashSeparation","handleTiebreakSlashSeparation","properTiebreak","sensibleSets","superSquare"],eI=["handleNumeric","separateScoreBlocks","sensibleSets","superSquare"];const{FACTORY:nI}=Lo;function rI({tournamentRecord:t,value:e}){const{extension:n}=tc({element:t,name:nI});Bs({element:t,extension:{name:nI,value:{...n?.value,...e}}})}function iI(t){const{mutationStatus:e,tournamentId:n,directives:r,timeStamp:i}=t||{},{topics:a}=fr();for(const o of[...a].sort(oI)){const t=pr({topic:o});t&&hr({topic:o,notices:t})}e&&i&&a.includes(vc)&&hr({notices:[{tournamentId:n,directives:r,timeStamp:i}],topic:vc})}const aI={[Nc]:5,[Dc]:5,[Rc]:5,[Uc]:5,[gc]:5,[lc]:5,[mc]:5,[fc]:5,[hc]:1,[bc]:1,[Ic]:5,[Sc]:5,[pc]:4,[cc]:4,[uc]:4,[dc]:4,[rc]:3,[nc]:2};function oI(t,e){return(aI[e]||0)-(aI[t]||0)}function sI({tournamentRecords:t,convertExtensions:e,ignoreDisabled:n,venueIds:r=[],dates:i}){if("object"!=typeof t||!Object.keys(t).length)return{error:q};const a=[],o=[],s=[],c=[];return Object.keys(t).forEach((u=>{const d=t[u];for(const t of d.venues||[])if(d.venues,!r.length||r.includes(t.venueId)){if(n){const{extension:e}=tc({name:Uo,element:t});if(e?.value)continue}a.includes(t.venueId)||(c.push(ri(t,e,!0)),a.push(t.venueId));for(const r of t.courts||[])if(!o.includes(r.courtId)){if(n&&i){const{extension:t}=tc({name:Uo,element:r});if(Zs({extension:t,dates:i}))continue}const{inContextCourt:a}=ec({convertExtensions:e,ignoreDisabled:n,venue:t,court:r});s.push(a),o.push(r.courtId)}}})),{courts:s,venues:c}}function cI({tournamentRecords:t,requireCourts:e,dates:n}){if("object"!=typeof t||!Object.keys(t).length)return{error:q};return Object.keys(t).reduce(((r,i)=>{const a=t[i],{venues:o}=Ec({tournamentRecord:a,dates:n});return o?.forEach((t=>{const{venueId:n,courts:i}=t;(!e||i?.length)&&!r.venueIds.includes(n)&&(r.venues.push(t),r.venueIds.push(n))})),r}),{venues:[],venueIds:[]})}function uI({duplicateValues:t=!0,creationTime:e=!0,removePriorValues:n,timeItem:r,element:i}){if(!r)return{error:wn};if(!i)return{error:me,info:Vs};const a=r&&Object.keys(r),o=["itemType","itemValue"];if(!(o.filter((t=>a.includes(t))).length===o.length))return{error:Sn};if(i.timeItems){const{itemType:e,itemSubTypes:n,itemValue:a}=r,{timeItem:o}=$f({itemSubTypes:n,itemType:e,element:i});if(JSON.stringify(o?.itemValue)===JSON.stringify(a)&&!t)return{...L}}else i.timeItems=[];if(r.itemSubTypes&&!r.itemSubTypes.length&&delete r.itemSubTypes,e){const t=(new Date).toISOString();Object.assign(r,{createdAt:t})}n&&(i.timeItems=i.timeItems.filter((({itemType:t})=>r.itemType!==t)));return n&&!r.itemValue||i.timeItems.push(r),{...L}}function dI({creationTime:t=!0,removePriorValues:e,tournamentRecord:n,duplicateValues:r,participantId:i,timeItem:a}){if(!n)return{error:$};if(!i)return{error:Le};const o=hs({tournamentRecord:n,participantId:i});return o.error?o:uI({element:o.participant,removePriorValues:e,duplicateValues:r,creationTime:t,timeItem:a})}function pI(t){const{removePriorValues:e,tournamentRecord:n,duplicateValues:r,creationTime:i,timeItem:a}=t;return n?uI({element:n,removePriorValues:e,duplicateValues:r,creationTime:i,timeItem:a}):{error:$}}function lI(t){const{removePriorValues:e,duplicateValues:n,creationTime:r,timeItem:i,event:a}=t;return a?uI({removePriorValues:e,duplicateValues:n,element:a,creationTime:r,timeItem:i}):{error:Et}}function mI({removePriorValues:t,tournamentRecord:e,duplicateValues:n,drawDefinition:r,disableNotice:i,matchUpId:a,timeItem:o,event:s}){const{matchUp:c}=$p({drawDefinition:r,event:s,matchUpId:a});if(!c)return{error:Xt};const u=uI({removePriorValues:t,element:c,duplicateValues:n,timeItem:o});return i||nl({tournamentId:e?.tournamentId,eventId:s?.eventId,context:"addTimeItem",drawDefinition:r,matchUp:c}),u}function fI({removePriorValues:t,tournamentRecords:e,tournamentRecord:n,drawDefinition:r,disableNotice:i,courtDayDate:a,matchUpId:o,courtIds:s}){if(!n&&!e)return{error:$};if(!o)return{error:Jt};const c=$p({drawDefinition:r,matchUpId:o});if(c.error)return c;if(c?.matchUp?.matchUpType!==Ea)return{error:ee};if(!(void 0===s||Array.isArray(s)&&s.length&&s.every((t=>"string"==typeof t))))return{error:xn,context:{courtIds:s}};let u;if(s){const t=sI({tournamentRecords:e?n:n&&{[n.tournamentId]:n}});if(t.error)return t;const r=t.courts?.filter((t=>s.includes(t.courtId)));if(r?.length!==s.length)return{error:xn,context:{courtIds:s}};u=r?.map((t=>({venueId:t.venueId,courtId:t.courtId})))}return mI({duplicateValues:!1,removePriorValues:t,tournamentRecord:n,drawDefinition:r,disableNotice:i,matchUpId:o,timeItem:{itemType:Bc,itemDate:a,itemValue:u}})}function hI({removePriorValues:t,tournamentRecords:e,tournamentRecord:n,drawDefinition:r,disableNotice:i,matchUpId:a,venueId:o}){if(!n)return{error:$};if(!a)return{error:Jt};if(o){const t=Cc({tournamentRecords:e,tournamentRecord:n,venueId:o});if(t.error)return t}return mI({duplicateValues:!1,removePriorValues:t,tournamentRecord:n,drawDefinition:r,disableNotice:i,matchUpId:a,timeItem:{itemType:Lc,itemValue:o}})}function II({removePriorValues:t,tournamentRecords:e,tournamentRecord:n,drawDefinition:r,disableNotice:i,courtDayDate:a,matchUpId:o,courtId:s}){if(!n&&!e)return{error:$};if(!o)return{error:Jt};if(s){const t=Oc({tournamentRecords:e,tournamentRecord:n,courtId:s});if(t.error)return t;const a=t.venue?.venueId;hI({tournamentRecords:e,tournamentRecord:n,drawDefinition:r,disableNotice:i,matchUpId:o,venueId:a})}return mI({duplicateValues:!1,removePriorValues:t,tournamentRecord:n,drawDefinition:r,disableNotice:i,matchUpId:o,timeItem:{itemType:Vc,itemDate:a,itemValue:s}})}function gI(t){const e="addMatchUpScheduledTime";let n=t.matchUp;const{removePriorValues:r,tournamentRecord:i,drawDefinition:a,disableNotice:o,scheduledTime:s,matchUpId:c}=t;if(!c)return Oi({result:{error:Jt},stack:e});if(!Er(s))return Oi({result:{error:Se},stack:e});if(!n){const t=$p({drawDefinition:a,matchUpId:c});if(t.error)return Oi({result:t,stack:e});n=t.matchUp}const u=$r(s),d=mu({matchUp:n}).scheduledDate,p=u&&!d,l=gu({matchUp:n}).timeModifiers||[];if(l?.length){const t=UI({disableNotice:!0,removePriorValues:r,tournamentRecord:i,timeModifiers:[],drawDefinition:a,matchUpId:c,matchUp:n});if(t?.error)return Oi({result:t,stack:e})}const m=zr(s,!0,p);return mI({duplicateValues:!1,removePriorValues:r,tournamentRecord:i,drawDefinition:a,disableNotice:o,matchUpId:c,timeItem:{itemType:$c,itemValue:m}})}function UI({removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,timeModifiers:i,matchUpId:a,matchUp:o}){const s="addMatchUpTimeModifiers";if(!a)return Oi({result:{error:Jt},stack:s});if(void 0!==i&&!Array.isArray(i))return Oi({info:Ci("timeModifiers"),result:{error:xn},stack:s});if(!o){const t=$p({drawDefinition:n,matchUpId:a});if(t.error)return Oi({result:t,stack:s});o=t.matchUp}let c=gu({matchUp:o}).timeModifiers||[];const u=i.filter((t=>!c.includes(t)));if(i.length&&!u.length)return{...L};if(u.some((t=>eu.includes(t)))){c=c.filter((t=>!eu.includes(t)));const r=gI({disableNotice:!0,removePriorValues:t,scheduledTime:"",tournamentRecord:e,drawDefinition:n,matchUpId:a});if(r.error)return Oi({result:r,stack:s})}const d=i?.length?[...u,...c]:void 0;return mI({duplicateValues:!1,removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,matchUpId:a,timeItem:{itemType:Kc,itemValue:d}})}function yI(t,e){const n=Nr.test(t)?t:qr(t),r=$r(t)||$r(e)||Fr(new Date);return new Date(`${r}T${n}`).getTime()}function SI({errorOnAnachronism:t=!1,checkChronology:e=!0,matchUpDependencies:n,inContextMatchUps:r,removePriorValues:i,tournamentRecords:a,tournamentRecord:o,drawDefinition:s,disableNotice:c,drawMatchUps:u,matchUpId:d,schedule:p,event:l}){if(!p)return{error:me,info:"Missing schedule"};if(!s)return{error:Y};if(!d)return{error:Jt};const m="drawEngine.addMatchUpScheduleItems";let f,h;if(u)f=u.find((t=>t.matchUpId===d));else{const t=$p({drawDefinition:s,event:l,matchUpId:d});if(t.error)return t;f=t.matchUp}const{endTime:I,courtId:g,courtIds:U,courtOrder:y,resumeTime:S,scheduledDate:w,scheduledTime:T,startTime:P,stopTime:D,timeModifiers:N,venueId:R}=p;!e||n&&r||({matchUpDependencies:n,matchUps:r}=ph({drawDefinition:s}));const b=n?.[d]?.matchUpIds;if(p.scheduledDate&&e&&b){const e=r?.filter((t=>(t.schedule?.scheduledDate||$r(t.schedule?.scheduledTime))&&b.includes(t.matchUpId))).map((({schedule:t})=>{const e=Mr(t);return new Date(e).getTime()}));if(e?.length){const n=Mr(p),r=new Date(n).getTime();if(Math.max(...e)>=r){if(t)return Oi({result:{error:V},stack:m});h=V}}}if(void 0!==w){const t=vI({disableNotice:!0,removePriorValues:i,tournamentRecord:o,drawDefinition:s,scheduledDate:w,matchUpId:d});if(t?.error)return Oi({result:t,stack:m,context:{scheduledDate:w}})}if(void 0!==T){const t=gI({disableNotice:!0,removePriorValues:i,tournamentRecord:o,drawDefinition:s,scheduledTime:T,matchUpId:d,matchUp:f});if(t?.error)return Oi({result:t,stack:m,context:{scheduledTime:T}})}if(void 0!==P){const t=PI({disableNotice:!0,removePriorValues:i,tournamentRecord:o,drawDefinition:s,matchUpId:d,startTime:P,event:l});if(t?.error)return Oi({result:t,stack:m,context:{startTime:P}})}if(void 0!==D){const t=NI({disableNotice:!0,removePriorValues:i,tournamentRecord:o,drawDefinition:s,matchUpId:d,stopTime:D,event:l});if(t?.error)return Oi({result:t,stack:m,context:{stopTime:D}})}if(void 0!==S){const t=RI({disableNotice:!0,removePriorValues:i,tournamentRecord:o,drawDefinition:s,resumeTime:S,matchUpId:d,event:l});if(t?.error)return Oi({result:t,stack:m,context:{resumeTime:S}})}if(void 0!==I){const t=DI({disableNotice:!0,removePriorValues:i,tournamentRecord:o,drawDefinition:s,matchUpId:d,endTime:I,event:l});if(t?.error)return Oi({result:t,stack:m,context:{endTime:I}})}if(void 0!==U){const t=fI({disableNotice:!0,removePriorValues:i,tournamentRecord:o,drawDefinition:s,matchUpId:d,courtIds:U});if(t?.error)return Oi({result:t,stack:m,context:{courtIds:U}})}if(void 0!==g&&void 0!==w){const t=II({courtDayDate:w,disableNotice:!0,removePriorValues:i,tournamentRecords:a,tournamentRecord:o,drawDefinition:s,matchUpId:d,courtId:g});if(t?.error)return Oi({result:t,stack:m,context:{courtId:g}})}if(void 0!==R){const t=hI({disableNotice:!0,removePriorValues:i,tournamentRecords:a,tournamentRecord:o,drawDefinition:s,matchUpId:d,venueId:R});if(t?.error)return Oi({result:t,stack:m,context:{venueId:R}})}if(void 0!==y&&v(y)){const t=wI({disableNotice:!0,removePriorValues:i,tournamentRecord:o,drawDefinition:s,courtOrder:y,matchUpId:d});if(t?.error)return Oi({result:t,stack:m,context:{courtOrder:y}})}if(void 0!==N){const t=UI({disableNotice:!0,removePriorValues:i,tournamentRecord:o,drawDefinition:s,timeModifiers:N,matchUpId:d,matchUp:f});if(t?.error)return Oi({result:t,stack:m,context:{timeModifiers:N}})}return c||nl({tournamentId:o?.tournamentId,eventId:l?.eventId,context:m,drawDefinition:s,matchUp:f}),h?{...L,warnings:[h]}:{...L}}function vI({scheduledDate:t,removePriorValues:e,tournamentRecord:n,drawDefinition:r,disableNotice:i,matchUpId:a}){if(!a)return{error:Jt};const o=t&&Rr.test(t);if(t&&!o)return{error:ye};return mI({duplicateValues:!1,removePriorValues:e,tournamentRecord:n,drawDefinition:r,disableNotice:i,matchUpId:a,timeItem:{itemValue:$r(t),itemType:Gc}})}function wI({removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,courtOrder:i,matchUpId:a}){if(!a)return{error:Jt};if(i&&!v(i))return{error:xn,info:"courtOrder must be numeric"};const o=i&&m(i);return mI({duplicateValues:!1,removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,matchUpId:a,timeItem:{itemType:jc,itemValue:o}})}function TI({removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,participantId:i,officialType:a,matchUpId:o}){if(!o)return{error:Jt};const s={itemType:"SCHEDULE.ASSIGNMENT.OFFICIAL",itemValue:i};return a&&(s.itemSubTypes=[a]),mI({duplicateValues:!1,removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,matchUpId:o,timeItem:s})}function PI({removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,matchUpId:i,startTime:a,event:o}){if(!i)return{error:Jt};if(!Er(a))return{error:Se};const{matchUp:s}=$p({drawDefinition:n,event:o,matchUpId:i}),{scheduledDate:c}=mu({matchUp:s}),u=(s?.timeItems??[]).filter((t=>[Hc,zc,Yc].includes(t?.itemType))).map((t=>yI(t.itemValue,c))).reduce(((t,e)=>!t||e<t?e:t),void 0);if(!u||yI(a,c)<u){s?.timeItems&&(s.timeItems=s.timeItems.filter((t=>t.itemType!==Wc)));const o=zr(a,!0,!0);return mI({duplicateValues:!1,removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,matchUpId:i,timeItem:{itemType:Wc,itemValue:o}})}return{error:Un}}function DI({validateTimeSeries:t=!0,removePriorValues:e,tournamentRecord:n,drawDefinition:r,disableNotice:i,matchUpId:a,endTime:o,event:s}){if(!a)return{error:Jt};if(!Er(o))return{error:Se};const{matchUp:c}=$p({drawDefinition:r,event:s,matchUpId:a}),{scheduledDate:u}=mu({matchUp:c}),d=(c?.timeItems??[]).filter((t=>[Wc,zc,Hc].includes(t?.itemType))).map((t=>yI(t.itemValue,u))).reduce(((t,e)=>!t||e>t?e:t),void 0);if(!t||!d||yI(o,u)>d){c?.timeItems&&(c.timeItems=c.timeItems.filter((t=>t.itemType!==Yc)));const t=zr(o,!0,!0);return mI({duplicateValues:!1,removePriorValues:e,tournamentRecord:n,drawDefinition:r,disableNotice:i,matchUpId:a,timeItem:{itemType:Yc,itemValue:t}})}return{error:hn}}function NI({removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,matchUpId:i,stopTime:a,event:o}){if(!i)return{error:Jt};if(!Er(a))return{error:Se};const{matchUp:s}=$p({drawDefinition:n,event:o,matchUpId:i}),{scheduledDate:c}=mu({matchUp:s}),u=s?.timeItems??[];if(u.reduce(((t,e)=>e.itemType===Yc||t),void 0))return{error:In};const d=u.filter((t=>[Wc,zc,Hc].includes(t?.itemType))).sort(((t,e)=>yI(t.itemValue,c)-yI(e.itemValue,c))),p=d[d.length-1],l=p&&p.itemType===Hc,m=d.filter((t=>!l||t.createdAt!==p.createdAt)).map((t=>yI(t.itemValue,c))).reduce(((t,e)=>!t||e>t?e:t),void 0);if(yI(a,c)>m){if(s?.timeItems&&l){const t=p.createdAt;s.timeItems=s.timeItems.filter((e=>e.createdAt!==t))}return mI({duplicateValues:!0,removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,matchUpId:i,timeItem:{itemValue:zr(a,!0,!0),itemType:Hc}})}return{error:gn}}function RI({removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,resumeTime:i,matchUpId:a,event:o}){if(!a)return{error:Jt};if(!Er(i))return{error:Se};const{matchUp:s}=$p({drawDefinition:n,event:o,matchUpId:a}),{scheduledDate:c}=mu({matchUp:s}),u=s?.timeItems??[];if(u.reduce(((t,e)=>e.itemType===Yc||t),void 0))return{error:In};const d=u.filter((t=>[Wc,zc,Hc].includes(t?.itemType))).sort(((t,e)=>yI(t.itemValue,c)-yI(e.itemValue,c))),p=d[d.length-1],l=p&&p.itemType===zc,m=d.filter((t=>!l||t.createdAt!==p.createdAt)).map((t=>yI(t.itemValue,c))).reduce(((t,e)=>!t||e>t?e:t),void 0);if(yI(i,c)>m){if(s?.timeItems&&l){const t=p.createdAt;s.timeItems=s.timeItems.filter((e=>e.createdAt!==t))}return mI({duplicateValues:!0,removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,matchUpId:a,timeItem:{itemValue:zr(i,!0,!0),itemType:zc}})}return{error:yn}}function bI({tournamentRecords:t}){if(!t)return{error:q};return Object.keys(t).reduce(((e,n)=>{e.tournamentIdMap[n]=[];const r=t[n].events||[],i=r.map((({eventId:t})=>t)),a=r.map((t=>(t.drawDefinitions||[]).map((({drawId:t})=>t)))).flat();return e.tournamentIdMap[n].push(...i,...a),e.eventIds.push(...i),e.drawIds.push(...a),e}),{eventIds:[],drawIds:[],tournamentIdMap:{}})}function MI({tournamentRecords:t,eventId:e,drawId:n}){const{tournamentIdMap:r}=bI({tournamentRecords:t});return(r?Object.keys(r):[]).find((t=>e&&r?.[t].includes(e)||n&&r?.[t].includes(n)))}function AI({tournamentRecords:t,tournamentRecord:e,tournamentId:n,drawId:r}){if(!e&&!t)return{error:$};if(!r)return{error:lt};if(!e&&t){if("string"!=typeof n&&!(n=MI({tournamentRecords:t,drawId:r})))return{error:H};if(!(e=t[n]))return{error:$}}const i=e&&Ls({tournamentRecord:e,drawId:r});return i?.drawDefinition?{drawDefinition:i.drawDefinition,event:i.event,tournamentRecord:e,...L}:Oi({result:{error:J},stack:"getDrawDefinition"})}function EI({errorOnAnachronism:t=!1,checkChronology:e=!0,matchUpDependencies:n,tournamentRecords:r,tournamentRecord:i,matchUpDetails:a,matchUpIds:o,schedule:s}){if(!i)return{error:$};if(!(a||o&&Array.isArray(o)))return{error:Qt};if(!(a||s&&"object"==typeof s))return{error:Dn};let c;const u=[];let d=0;if(e&&!n){const t=ph({tournamentRecords:r});n=t.matchUpDependencies,c=t.matchUps}c||(c=th({tournamentRecord:i})?.matchUps??[]);const p=c.reduce(((t,e)=>{const{matchUpId:n,drawId:r}=e;return t[r]?t[r].push(n):t[r]=[n],t}),{}),l=a?.map((t=>t.matchUpId));for(const m of Object.keys(p)){const{drawDefinition:f}=AI({tournamentRecord:i,drawId:m});if(!f)continue;const h=p[m].filter((t=>o?.includes(t)??l?.includes(t))),I=eh({inContext:!1,drawDefinition:f}).matchUps;for(const o of h){const p=SI({schedule:a?.find((t=>t.matchUpId===o))?.schedule||s,matchUpDependencies:n,errorOnAnachronism:t,inContextMatchUps:c,tournamentRecords:r,tournamentRecord:i,checkChronology:e,drawDefinition:f,drawMatchUps:I,matchUpId:o});if(p?.warnings?.length&&u.push(...p.warnings),p?.success&&(d+=1),p.error)return p}}return u.length?{...L,scheduled:d,warnings:u}:{...L,scheduled:d}}function CI({errorOnAnachronism:t,matchUpContextIds:e,tournamentRecords:n,checkChronology:r,matchUpDetails:i,schedule:a}){if(!n)return{error:q};if(!Array.isArray(e)&&!Array.isArray(i))return{error:xn};if((!i||e)&&!a)return{error:me,info:"schedule is required"};const o=[];let s=0;const{matchUpDependencies:c}=ph({tournamentRecords:n});for(const u of Object.values(n)){const{tournamentId:d}=u,p=e?.filter((t=>t.tournamentId===d)).map(hl),l=i?.filter((t=>t?.tournamentId===d));if(p?.length||l?.length){const e=EI({matchUpDetails:l,matchUpDependencies:c,errorOnAnachronism:t,tournamentRecords:n,tournamentRecord:u,checkChronology:r,matchUpIds:p,schedule:a});if(e.warnings?.length&&o.push(...e.warnings),e.scheduled&&(s+=e.scheduled),e.error)return e}}return o.length?{...L,scheduled:s,warnings:o}:{...L,scheduled:s}}function OI({drawPosition:t,matchUps:e=[]}){return{initialRoundNumber:e.filter((({drawPositions:e})=>t&&e?.includes(t))).map((({roundNumber:t})=>t)).sort(l)[0]}}function FI({structureId:t,matchUpsMap:e,matchUp:n}){const r=n?.roundPosition,i=r+(r%2?1:-1);return{pairedPreviousMatchUp:Tp({matchUpsMap:e,structureId:t}).find((({roundNumber:t,roundPosition:e})=>t===n?.roundNumber&&e===i))}}function kI({inContextDrawMatchUps:t,sourceMatchUpStatus:e,sourceMatchUpId:n,matchUpsMap:r,matchUp:i}){const a=t.find((t=>t.matchUpId===n)),{pairedPreviousMatchUp:o}=FI({structureId:a?.structureId,matchUp:a,matchUpsMap:r});if(a&&o){const n=o?.matchUpId,r=t.find((t=>t.matchUpId===n)),s=a?.structureId===r?.structureId?a?.roundPosition<r?.roundPosition?1:2:a.structureId===r?.structureId?2:1;i.matchUpStatusCodes=(i.matchUpStatusCodes??[]).map((t=>t.sideNumber===s?{...t,previousMatchUpStatus:e}:t))}}function xI({inContextDrawMatchUps:t,positionAssignments:e,sourceMatchUpStatus:n,targetDrawPosition:r,tournamentRecord:i,sourceMatchUpId:a,drawDefinition:o,dualMatchUp:s,matchUpsMap:c,matchUp:u,event:d}){if(s){const e=t.find((({matchUpId:t})=>u.matchUpId===t)),n=e.sides?.find((t=>t.drawPosition===r))?.sideNumber,i=u.sides?.find((t=>t.sideNumber===n));i&&delete i.lineUp}u.drawPositions=(u.drawPositions||[]).map((t=>t===r?void 0:t)).filter(Boolean);const p=e.filter((({drawPosition:t})=>u.drawPositions?.includes(t))).filter((t=>t.bye)).length;return u.matchUpStatus=p&&Ki||[Zi,ca].includes(u.matchUpStatus)&&u.matchUpStatus||sa,[ca,Zi].includes(u.matchUpStatus)&&(u.winningSide=void 0),u.matchUpStatusCodes&&kI({inContextDrawMatchUps:t,sourceMatchUpStatus:n,sourceMatchUpId:a,matchUpsMap:c,matchUp:u}),nl({tournamentId:i?.tournamentId,eventId:d?.eventId,context:`removeSubsequentDrawPosition-${r}`,drawDefinition:o,matchUp:u}),{...L}}function _I({positionAssignments:t,tournamentRecord:e,drawDefinition:n,matchUpsMap:r,structure:i,event:a}){const{matchUps:o}=qp({drawDefinition:n,matchUpsMap:r,structure:i,event:a});o.forEach((r=>{const i=t.filter((({drawPosition:t})=>r.drawPositions?.includes(t))).filter((t=>t.bye)).length;if(!r.winningSide){const t=i?Ki:sa;Object.assign(r,{matchUpStatus:t}),nl({tournamentId:e?.tournamentId,context:"modifyRoundRobinMatchUpsStatus",eventId:a?.eventId,drawDefinition:n,matchUp:r})}}))}function LI({tournamentRecord:t,drawDefinition:e,event:n}){const r=t?.events||n&&[n],i=r?.map((t=>t?.drawDefinitions)).flat().filter(Boolean)||e&&[e]||[],a={},o={},s=i.map((t=>t?.structures?.filter((t=>t?.structures)))).flat().filter(Boolean);for(const c of s){const{structures:t,structureId:e}=c||{};t&&e&&(a[e]=t?.map((t=>t.structureId)))&&t.forEach((t=>o[t.structureId]=c?.structureId))}return{containedStructures:a,containerStructures:o}}function BI(t){const{drawDefinition:e,findContainer:n,structureId:r,event:i}=t;let a=t.structure;const{containedStructures:o}=LI({drawDefinition:e}),s=r&&o[r]||[];if(!a){const t=zd({drawDefinition:e,structureId:r});if(t.error)return t;a=n&&t.containingStructure||t.structure}if(Fp({drawDefinition:e,structure:a}))return{structure:a,isAdHoc:!0,error:ot};const{matchUps:c}=Pl({inContext:!0,matchUpFilters:{isCollectionMatchUp:!1},drawDefinition:e,event:i}),u=c?.filter((t=>t.structureId===r||s.includes(t.structureId))),{matchUpDependencies:d}=ph({drawIds:[e.drawId],matchUps:c,drawDefinition:e}),p=[],m=[],f={},h=[];for(const l of c||[]){if(l.structureId===r||s.includes(l.structureId)){m.push(...l.drawPositions||[]);const t=l.roundNumber;for(const e of(l.drawPositions||[]).filter(Boolean))(!f[e]||t&&f[e]>t)&&(f[e]=t)}Qp(l)&&(h.push(l),p.push(l.matchUpId,...d?.[l?.matchUpId]?.matchUpIds||[]))}const I=T(m.filter(Boolean)).sort(l),g=T(p),U=T(u?.map((({matchUpId:t,drawPositions:e})=>g.includes(t)?e:[])).flat().filter(Boolean)).sort(l),{positionAssignments:y}=Rp({drawDefinition:e,structure:a}),S=y?.filter((t=>t.bye)).map((t=>t.drawPosition)),v=y?.filter((t=>t.qualifier)).map((t=>t.drawPosition)),w=I?.filter((t=>!U.includes(t)))||[];return{allDrawPositions:I,inContextStructureMatchUps:u,drawPositionInitialRounds:f,activeDependentMatchUpIds:g,qualifyingDrawPositions:v,inactiveDrawPositions:w,positionAssignments:y,activeDrawPositions:U,byeDrawPositions:S,activeMatchUps:h,structure:a}}function VI(t){let{inContextDrawMatchUps:e,participantId:n,drawPosition:r}=t;const{tournamentRecord:i,drawDefinition:a,structureId:o,matchUpsMap:s,event:c}=t,{structure:u}=zd({drawDefinition:a,structureId:o}),d=(bp({drawDefinition:a,structure:u}).positionAssignments||[]).find((t=>n&&t.participantId===n||r&&t.drawPosition===r));if(d&&n&&!r&&(r=d?.drawPosition),!r)return{error:st};n||(n=d?.participantId);const{activeDrawPositions:p}=BI({drawDefinition:a,structureId:o});if(p.includes(r))return{error:at};e||({matchUps:e}=Pl({inContext:!0,drawDefinition:a,matchUpsMap:s}));return jI({inContextDrawMatchUps:e,tournamentRecord:i,drawDefinition:a,structureId:o,drawPosition:r,matchUpsMap:s,event:c}).drawPositionCleared?(ol({tournamentId:i?.tournamentId,drawDefinition:a,structure:u,event:c}),{...L,participantId:n}):{error:nt}}function jI({inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,drawPosition:r,matchUpsMap:i,structureId:a,event:o}){const{structure:s}=zd({drawDefinition:n,structureId:a});if(!s)return{error:Dt};const c=bp({drawDefinition:n,structure:s}).positionAssignments||[],u=c.some((t=>{if(t.drawPosition===r)return delete t.participantId,delete t.qualifier,delete t.bye,!0}));if(s.structureType===od)return _I({positionAssignments:c,tournamentRecord:e,drawDefinition:n,matchUpsMap:i,structure:s}),{drawPositionCleared:u,...L};const{matchUps:d}=qp({drawDefinition:n,matchUpFilters:{isCollectionMatchUp:!1},matchUpsMap:i,structure:s,event:o}),{roundProfile:p,roundMatchUps:l}=Gu({matchUps:d}),f=p&&Object.keys(p),h=f?.map((t=>m(t)));let I=r;const g=h?.map((t=>{const e=p?.[t],n=e?.pairedDrawPositions?.find((t=>t.includes(I))),r=n?.find((t=>t!==I)),i=c.find((t=>t.drawPosition===r)),a=p?.[t+1],o=i?.bye,s=a?.pairedDrawPositions?.find((t=>t.includes(r))),u=o&&s&&a&&a.drawPositions?.includes(r),d=n&&{pairedDrawPositionByeAdvancedPair:!u&&s,pairedDrawPosition:r,targetDrawPosition:I,relevantPair:n,roundNumber:t};return u&&(I=r),d})).filter((t=>t?.targetDrawPosition)),U=g?.reduce(((t,e)=>{const{roundNumber:n,relevantPair:r,targetDrawPosition:i,pairedDrawPosition:a,pairedDrawPositionByeAdvancedPair:o}=e,s=[{roundNumber:n,targetDrawPosition:i,relevantPair:r},o&&{roundNumber:n+1,targetDrawPosition:a,relevantPair:o,subsequentRoundRemoval:!0}].filter(Boolean);return t.concat(...s)}),[]);return U?.forEach((({roundNumber:u,targetDrawPosition:d,relevantPair:p})=>{const m=l?.[u].find((t=>k(t.drawPositions.filter(Boolean),p.filter(Boolean))));m&&(!function({inContextDrawMatchUps:t,targetDrawPosition:e,tournamentRecord:n,drawDefinition:r,matchUpsMap:i,roundNumber:a,structureId:o}){const{structure:s}=zd({drawDefinition:r,structureId:o});if(!s)return{error:Dt};if(s.structureType===od)return;i=i||wp({drawDefinition:r});const c=i?.mappedMatchUps||{},u=c[o].matchUps,{initialRoundNumber:d}=OI({drawPosition:e,matchUps:u}),p=u?.filter((t=>t.roundNumber>=a&&t.roundNumber!==d&&t.drawPositions?.includes(e))),l=Rp({drawDefinition:r,structureId:o}).positionAssignments??[];p?.forEach((a=>GI({drawPosition:e,targetMatchUp:a,inContextDrawMatchUps:t,positionAssignments:l,tournamentRecord:n,drawDefinition:r,matchUpsMap:i,structure:s})))}({inContextDrawMatchUps:t,targetDrawPosition:d,tournamentRecord:e,drawDefinition:n,structureId:a,roundNumber:u,matchUpsMap:i}),GI({inContextDrawMatchUps:t,positionAssignments:c,tournamentRecord:e,drawDefinition:n,targetMatchUp:m,drawPosition:r,matchUpsMap:i,structure:s,event:o}))})),{tasks:U,drawPositionCleared:u,positionAssignments:c}}function GI({inContextDrawMatchUps:t,positionAssignments:e,tournamentRecord:n,drawDefinition:r,targetMatchUp:i,drawPosition:a,matchUpsMap:o,structure:s,event:c}){const u="removeDrawPosition",d=i.drawPositions?.slice(),p=i.matchUpStatus,l=i.winningSide,m=(o=o??wp({drawDefinition:r})).mappedMatchUps[s.structureId].matchUps,{initialRoundNumber:f}=OI({drawPosition:a,matchUps:m});if(i.roundNumber&&f&&i.roundNumber>f){const t=(i.drawPositions??[]).map((t=>t===a?void 0:t));i.drawPositions=t}if(i.matchUpType===Ca){const e=t?.find((t=>t.matchUpId===i.matchUpId)),o=(e?.sides??[]).reduce(((t,e,n)=>e.drawPosition===a?n:t),void 0);void 0!==o&&i.sides?.[o]?.lineUp&&(delete i.sides?.[o].lineUp,nl({tournamentId:n?.tournamentId,context:`${u}-TEAM`,eventId:c?.eventId,matchUp:i,drawDefinition:r}))}const h=yl({matchUpId:i.matchUpId,inContextDrawMatchUps:t,drawDefinition:r}),{targetLinks:{winnerTargetLink:I},targetMatchUps:{loserMatchUp:g,winnerMatchUp:U,loserMatchUpDrawPositionIndex:y}}=h,S=e.filter((({drawPosition:t})=>i.drawPositions?.includes(t))).filter((t=>t.bye)).length,v=S&&Ki||i.matchUpStatus&&[Zi,ca].includes(i.matchUpStatus)&&i.matcHUpStatus||2===i.drawPositions?.length&&sa||void 0;i.matchUpStatus=v,i.matchUpStatus&&[ca,Zi].includes(i.matchUpStatus)&&(i.winningSide=void 0);const w=d?.find((t=>!i.drawPositions?.includes(t)));if(d?.includes(a)&&p===i.matchUpStatus&&l===i.winningSide||(w&&Vf({method:u,color:"brightyellow",removedDrawPosition:w}),nl({tournamentId:n?.tournamentId,eventId:c?.eventId,matchUp:i,context:`${u}-${a}`,drawDefinition:r})),g&&g.structureId!==h.matchUp.structureId&&!S){const{drawPositions:e,roundNumber:i}=g;if(1===i){const i=e[y];jI({structureId:g.structureId,drawPosition:i,inContextDrawMatchUps:t,tournamentRecord:n,drawDefinition:r,matchUpsMap:o})}else{const i=Math.min(...e.filter(Boolean)),a=function({loserMatchUpDrawPosition:t,inContextDrawMatchUps:e,tournamentRecord:n,drawDefinition:r,loserMatchUp:i,matchUpsMap:a,event:o}){const{structure:s}=zd({structureId:i.structureId,drawDefinition:r}),{positionAssignments:c}=Rp({structure:s}),u=c?.find((e=>e.drawPosition===t));if(u?.bye){const s=VI({drawPosition:t,structureId:i.structureId,inContextDrawMatchUps:e,tournamentRecord:n,drawDefinition:r,matchUpsMap:a,event:o});if(s.error)return s}return{...L}}({loserMatchUpDrawPosition:i,inContextDrawMatchUps:t,tournamentRecord:n,drawDefinition:r,loserMatchUp:g,matchUpsMap:o,event:c});if(a.error)return Oi({result:a,stack:u});const s=(o?.mappedMatchUps||{})[g.structureId].matchUps,{initialRoundNumber:d}=OI({drawPosition:i,matchUps:s});1===d&&(Vf({method:u,color:"brightyellow",loserMatchUpDrawPosition:i}),jI({structureId:g.structureId,drawPosition:i,inContextDrawMatchUps:t,tournamentRecord:n,drawDefinition:r,matchUpsMap:o}))}}return U&&U.structureId!==h.matchUp.structureId&&I.target.feedProfile,{...L}}function qI(t){const{dualWinningSideChange:e,inContextDrawMatchUps:n,tournamentRecord:r,drawDefinition:i,matchUpStatus:a,matchUpsMap:o,dualMatchUp:s,targetData:c,matchUpId:u,structure:d,event:p}=t,l=Boolean(t.matchUp.collectionId),m=Fp({drawDefinition:i,structure:d}),{drawPositions:f,winningSide:h}=c.matchUp||{};if(!m&&!f)return{error:it};const{targetLinks:{loserTargetLink:I,winnerTargetLink:g,byeTargetLink:U},targetMatchUps:{loserMatchUp:y,winnerMatchUp:S,byeMatchUp:v}}=c,w=Rl({...t,matchUpStatus:a||sa,removeWinningSide:!0});if(w.error)return w;let T;if(l){const{matchUpTieId:n,matchUpsMap:a}=t;if(T=bl({matchUpId:n,tournamentRecord:r,drawDefinition:i,matchUpsMap:a,event:p}),!e&&!T.removeWinningSide)return{...L}}if(m)return{...L};const{matchUps:P}=qp({afterRecoveryTimes:!1,inContext:!0,drawDefinition:i,matchUpsMap:o,structure:d}),{positionAssignments:D}=bp({structure:d}),N=h-1,R=1-N,b=f[N],M=f[R],{winnerParticipantId:A,loserParticipantId:E}=D?.reduce(((t,e)=>(e.drawPosition===M&&(t.loserParticipantId=e.participantId),e.drawPosition===b&&(t.winnerParticipantId=e.participantId),t)),{winnerParticipantId:void 0,loserParticipantId:void 0})||{},C=P.filter((t=>t.drawPositions?.includes(M)));if(S&&$I({sourceMatchUpStatus:a,sourceMatchUpId:u,inContextDrawMatchUps:n,winningDrawPosition:b,winnerParticipantId:A,tournamentRecord:r,winnerTargetLink:g,drawDefinition:i,winnerMatchUp:S,dualMatchUp:s,matchUpsMap:o}),y){const{winnerHadMatchUpStatus:t}=function({matchUpStatuses:t=[Ki,ca,Zi],drawPositionMatchUps:e,loserDrawPosition:n,sourceMatchUps:r}){const i=e?.reduce(((t,e)=>!t||e.roundNumber>t.roundNumber?e:t),void 0),a=i?.drawPositions?.find((t=>t!==n)),o=r.filter((t=>t?.drawPositions?.includes(a))).map((t=>t.matchUpStatus)),s=r.filter((t=>t?.drawPositions?.includes(n))).map((t=>t.matchUpStatus));return{sourceMatchUp:i,winnerHadMatchUpStatus:k(o||[],t),winnerMatchUpStatuses:o,loserHadMatchUpStatus:k(s||[],t),loserMatchUpStatuses:s}}({drawPositionMatchUps:C,loserDrawPosition:M,sourceMatchUps:P}),e=I.linkCondition;if(t&&e===fd){WI({targetLink:I,inContextDrawMatchUps:n,drawDefinition:i,drawPosition:Math.min(...y.drawPositions),matchUpsMap:o,event:p})}const c=function({sourceMatchUpStatus:t,loserParticipantId:e,tournamentRecord:n,loserTargetLink:r,sourceMatchUpId:i,drawDefinition:a,loserMatchUp:o,matchUpsMap:s,dualMatchUp:c,event:u}){const d="removeDirectedLoser",p=r.target.structureId,{structure:l}=zd({drawDefinition:a,structureId:p});if(!l)return{error:Dt};const{positionAssignments:m}=bp({structure:l}),f=m?.find((t=>t.participantId===e))?.drawPosition;if(m?.forEach((t=>{t.participantId===e&&delete t.participantId})),l.seedAssignments=(l.seedAssignments||[]).filter((t=>t.participantId!==e)),c){const t=o?.sides.reduce(((t,e,n)=>e.drawPosition===f?n:t),void 0),e=s?.drawMatchUps?.find((({matchUpId:t})=>t===o.matchUpId)),r=e?.sides?.[t];r&&(delete r.lineUp,nl({tournamentId:n?.tournamentId,eventId:u?.eventId,matchUp:e,context:d,drawDefinition:a}))}return{...L}}({sourceMatchUpStatus:a,sourceMatchUpId:u,loserParticipantId:E,tournamentRecord:r,loserTargetLink:I,drawDefinition:i,loserMatchUp:y,dualMatchUp:s,matchUpsMap:o,event:p});if(c.error)return c}if(v){WI({sourceMatchUpId:u,targetLink:U,inContextDrawMatchUps:n,drawDefinition:i,drawPosition:Math.min(...v.drawPositions),matchUpsMap:o,event:p})}const O=T&&{tieMatchUpResult:T};return{...L,...O}}function $I({inContextDrawMatchUps:t,winningDrawPosition:e,sourceMatchUpStatus:n,winnerParticipantId:r,tournamentRecord:i,winnerTargetLink:a,sourceMatchUpId:o,drawDefinition:s,winnerMatchUp:c,matchUpsMap:u,dualMatchUp:d,event:p}){const{structureId:l,roundNumber:m}=c;if(a){const t=a.target.structureId,{structure:e}=zd({drawDefinition:s,structureId:t});if(!e)return{error:Dt};const{positionAssignments:n}=bp({structure:e});e.seedAssignments=(e.seedAssignments||[]).filter((t=>t.participantId!==r));const o=n?.find((t=>t.participantId===r)),d=o?.drawPosition,{matchUps:l}=qp({drawDefinition:s,structure:e,event:p}),m=N(l.map((t=>t.drawPositions)).flat(1/0).filter(Boolean));if(1===(d?m[d]:void 0))n?.forEach((t=>{t.participantId===r&&delete t.participantId}));else{const t=l.filter((({drawPositions:t})=>t.includes(d)));console.log("not removing from position assignments since instances > 1",{drawPositionMatchUps:t,winnerTargetLink:a})}const f=u?.drawMatchUps?.find((({matchUpId:t})=>t===c.matchUpId));f&&nl({tournamentId:i?.tournamentId,eventId:p?.eventId,matchUp:f,context:"removeDirectedWinner",drawDefinition:s})}return m&&function({inContextDrawMatchUps:t,sourceMatchUpStatus:e,targetDrawPosition:n,tournamentRecord:r,sourceMatchUpId:i,drawDefinition:a,structureId:o,dualMatchUp:s,roundNumber:c,matchUpsMap:u,event:d}){const{structure:p}=zd({drawDefinition:a,structureId:o});if(p?.structureType===od)return{...L};u=u||wp({drawDefinition:a});const l=(u?.mappedMatchUps||{})[o].matchUps,{initialRoundNumber:m}=OI({drawPosition:n,matchUps:l}),f=l?.filter((t=>t.roundNumber>=c&&t.roundNumber!==m&&t.drawPositions?.includes(n))),{positionAssignments:h}=Rp({drawDefinition:a,structureId:o});for(const I of f||[])xI({inContextDrawMatchUps:t,sourceMatchUpStatus:e,positionAssignments:h,targetDrawPosition:n,tournamentRecord:r,sourceMatchUpId:i,drawDefinition:a,dualMatchUp:s,matchUpsMap:u,matchUp:I,event:d})}({targetDrawPosition:e,inContextDrawMatchUps:t,sourceMatchUpStatus:n,tournamentRecord:i,sourceMatchUpId:o,drawDefinition:s,dualMatchUp:d,matchUpsMap:u,roundNumber:m,structureId:l}),{...L}}function WI({inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,drawPosition:r,matchUpsMap:i,targetLink:a,event:o}){return VI({inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,matchUpsMap:i,drawPosition:r,structureId:a.target.structureId,event:o}),{...L}}function HI(t){let{sourceMatchUp:e}=t;const{targetMatchUp:n,structure:r,matchUpsMap:i,drawPosition:a}=t,o=n.roundNumber>1&&n.roundNumber-1,s=Tp({structureId:r.structureId,matchUpsMap:i});!e&&a&&(e=s.find((({drawPositions:t,roundNumber:e})=>e===o&&t?.includes(a))));const c=e?.roundPosition,u=c+(c%2?1:-1),d=o&&s.find((({roundNumber:t,roundPosition:e})=>t===o&&e===u)),p=d?.matchUpStatus;return{pairedPreviousMatchUp:d,pairedPreviousMatchUpIsDoubleExit:[ea,ta].includes(p)}}function zI({drawDefinition:t,positionAction:e}){const{extension:n}=tc({name:ho,element:t}),r=Array.isArray(n?.value)&&n?.value||[];if(!r?.length){const e=t.structures.find((t=>t.stage===Hu));if(e){const t=Rp({structure:e}).positionAssignments?.map((({drawPosition:t,participantId:e,bye:n,qualifier:r})=>({drawPosition:t,participantId:e,qualifier:r,bye:n})));r.push({name:"initialMainAssignments",initialAssignments:t})}}Bs({element:t,extension:{name:ho,value:r.concat(e)}})}function YI({provisionalPositioning:t,isPositionAction:e,tournamentRecord:n,drawDefinition:r,drawPosition:i,matchUpsMap:a,structureId:o,structure:s,event:c}){if(!r)return{error:Y};if(s||({structure:s}=zd({drawDefinition:r,structureId:o})),!s)return{error:Dt};o||({structureId:o}=s);const u="assignDrawPositionBye";Vf({method:u,color:"cyan",drawPosition:i}),a||(a=wp({drawDefinition:r}));const{positionAssignments:d}=Rp({structure:s}),{activeDrawPositions:p}=BI({drawDefinition:r,structureId:o}),l=d?.find((t=>t.drawPosition===i));if(l?.bye)return{...L};const m=p?.includes(i);if(m)return{error:at};const f=d?.find((t=>t.drawPosition===i));if(!f)return{error:ot};const{filled:h,containsBye:I,assignedParticipantId:g}=function(t){const e=t.bye,n=t.qualifier,r=t.participantId,i=e||n||r;return{containsBye:e,containsQualifier:n,assignedParticipantId:r,filled:i}}(f);if(I)return{...L};if(h&&!I)return Oi({result:{error:tt},stack:u});const U=Pl({inContext:!0,drawDefinition:r,matchUpsMap:a}).matchUps||[],{matchUps:y}=qp({provisionalPositioning:t,drawDefinition:r,matchUpFilters:{isCollectionMatchUp:!1},matchUpsMap:a,structure:s});if(d?.forEach((t=>{t.drawPosition===i&&(t.bye=!0)})),s.structureType===od)return function({tournamentRecord:t,drawDefinition:e,drawPosition:n,matchUps:r,event:i}){r.forEach((r=>{r.drawPositions?.includes(n)&&JI({eventId:i?.eventId,tournamentRecord:t,drawDefinition:e,matchUp:r})}))}({tournamentRecord:n,drawDefinition:r,drawPosition:i,matchUps:y}),ol({tournamentId:n?.tournamentId,drawDefinition:r,structure:s,event:c}),KI({assignedParticipantId:g,isPositionAction:e,drawDefinition:r,drawPosition:i,structureId:o,stack:u});const{roundProfile:S,roundMatchUps:v}=Gu({matchUps:y}),w=S&&Object.keys(S).map((t=>parseInt(t))).reverse(),T=w?.find((t=>S?.[t].drawPositions?.includes(i))),P=T&&v?.[T].find((({drawPositions:t})=>t?.includes(i)));JI({tournamentRecord:n,drawDefinition:r,matchUp:P,event:c});const D=P.drawPositions?.find((t=>t!==i));if(D){const t=QI({sourceDrawPositions:P.drawPositions,matchUpId:P.matchUpId,inContextDrawMatchUps:U,drawPositionToAdvance:D,tournamentRecord:n,drawDefinition:r,matchUpsMap:a});if(t.error)return t}return ol({tournamentId:n?.tournamentId,drawDefinition:r,structure:s,event:c}),KI({assignedParticipantId:g,isPositionAction:e,drawDefinition:r,drawPosition:i,structureId:o,stack:u})}function KI({assignedParticipantId:t,isPositionAction:e,drawDefinition:n,drawPosition:r,structureId:i,stack:a}){if(e){zI({drawDefinition:n,positionAction:{removedParticipantId:t,drawPosition:r,structureId:i,name:a}})}return Oi({result:{...L},stack:a})}function JI({tournamentRecord:t,drawDefinition:e,eventId:n,matchUp:r,event:i}){Object.assign(r,{matchUpStatus:Ki,score:void 0,winningSide:void 0}),nl({tournamentId:t?.tournamentId,eventId:n??i?.eventId,context:"setMatchUpStatusBye",drawDefinition:e,matchUp:r})}function QI({drawPositionToAdvance:t,inContextDrawMatchUps:e,sourceDrawPositions:n,tournamentRecord:r,drawDefinition:i,matchUpsMap:a,matchUpId:o,event:s}){Vf({method:"advanceDrawPosition",color:"cyan",drawPositionToAdvance:t});const c=a.drawMatchUps.find((t=>t.matchUpId===o)),u=e.find((t=>t.matchUpId===o)),d=u?.structureId,{structure:p}=zd({drawDefinition:i,structureId:d}),{positionAssignments:m}=Rp({structure:p}),f=m?.filter((t=>t.bye)).map((t=>t.drawPosition)),h=c?.drawPositions?.find((e=>e!==t)),I=h&&f?.includes(h),{targetLinks:{loserTargetLink:g},targetMatchUps:{loserMatchUp:U,winnerMatchUp:y,loserTargetDrawPosition:S}}=yl({inContextDrawMatchUps:e,drawDefinition:i,matchUpId:o});if(y&&y.structureId===p?.structureId&&function({drawPositionToAdvance:t,inContextDrawMatchUps:e,sourceDrawPositions:n,tournamentRecord:r,drawDefinition:i,winnerMatchUp:a,matchUpsMap:o,event:s}){const c="advanceWinner",u=o.drawMatchUps.find((t=>t.matchUpId===a.matchUpId)),d=e.find((t=>t.matchUpId===a.matchUpId)),p=d?.structureId,{structure:m}=zd({drawDefinition:i,structureId:p}),{positionAssignments:f}=Rp({structure:m}),h=f?.find((({drawPosition:e})=>e===t)),I=h?.bye,g=u.drawPositions?.filter(Boolean),U=f?.filter((t=>g?.includes(t.drawPosition))),y=f?.find((({drawPosition:e})=>e===t)),S=n?.find((e=>e!==t)),v=S&&U?.find((({drawPosition:t})=>t===S)),w=v?.bye,T=I&&w;T&&console.log({isByeAdvancedBye:T});if(g?.length>1&&I&&!w)return Oi({result:{error:tt},stack:c});const P=g?.find((e=>e!==t));let D=T;const N=[...(u.drawPositions||[]).filter(Boolean),void 0,void 0].slice(0,2),R=N.map((e=>!e&&!D||e===t?(D=!0,t):e)).sort(l);if(!D)return console.log("@@@@@@@",{advancingAssignmentIsBye:y,drawPositionToAdvance:t,existingAssignments:U}),Oi({result:{error:tt},stack:c});const b=f?.find((({drawPosition:t})=>t===P))?.bye,M=f?.find((({drawPosition:e})=>e===t))?.bye,A=M||b?Ki:sa;Object.assign(u,{matchUpStatus:A,score:void 0,winningSide:void 0,drawPositions:R});const E=u.drawPositions.find((t=>!N.includes(t)));Vf({method:c,color:"brightyellow",changedDrawPosition:E,pairedDrawPositionIsBye:b,drawPositionIsBye:M}),nl({tournamentId:r?.tournamentId,matchUp:u,eventId:s?.eventId,context:c,drawDefinition:i});const{targetLinks:{loserTargetLink:C},targetMatchUps:{loserMatchUp:O,loserTargetDrawPosition:F}}=yl({matchUpId:a.matchUpId,inContextDrawMatchUps:e,drawDefinition:i});if(b||M){const n=b?t:P;if(n)QI({drawPositionToAdvance:n,matchUpId:a.matchUpId,inContextDrawMatchUps:e,tournamentRecord:r,drawDefinition:i,matchUpsMap:o});else if(M&&C&&O)if(O.feedRound)XI({loserTargetDrawPosition:F,tournamentRecord:r,loserTargetLink:C,drawDefinition:i,loserMatchUp:O,matchUpsMap:o});else{const t=1-a.roundPosition%2,e=O.drawPositions[t],n=YI({structureId:C.target.structureId,drawPosition:e,tournamentRecord:r,drawDefinition:i,event:s});if(n.error);}}}({drawPositionToAdvance:t,inContextDrawMatchUps:e,sourceDrawPositions:n,tournamentRecord:r,drawDefinition:i,winnerMatchUp:y,matchUpsMap:a,event:s}),U&&I&&U.structureId!==p?.structureId){const{roundNumber:t}=U;if(1===t){const t=YI({structureId:g.target.structureId,drawPosition:S,tournamentRecord:r,drawDefinition:i,event:s});if(t.error)return t}else XI({loserTargetDrawPosition:S,tournamentRecord:r,loserTargetLink:g,drawDefinition:i,loserMatchUp:U,matchUpsMap:a,event:s})}return{...L}}function XI({loserTargetDrawPosition:t,tournamentRecord:e,loserTargetLink:n,drawDefinition:r,loserMatchUp:i,matchUpsMap:a,event:o}){const{roundNumber:s}=i;Vf({method:"assignFedDrawPositionBye",color:"cyan",loserTargetDrawPosition:t});const c=(a?.mappedMatchUps||{})[i.structureId].matchUps,{initialRoundNumber:u}=OI({drawPosition:t,matchUps:c});if(u===s){const i=YI({structureId:n.target.structureId,drawPosition:t,tournamentRecord:e,drawDefinition:r,event:o});if(i.error)return i}}function ZI({inContextTargetMatchUp:t,drawPositionSideIndex:e,teamParticipantId:n,tournamentRecord:r,drawDefinition:i,matchUp:a,event:o}){const s=t?.sides?.[e]?.sideNumber,c=s&&a.sides?.find((t=>t.sideNumber===s)),{extension:u}=gs({element:i,name:Do}),d=(u?.value||{})[n];if(c)a?.sides?.forEach((t=>{t.sideNumber===s&&(t.lineUp=d)}));else{a.sides=[1,2].map((t=>({...a.sides?.find((e=>e.sideNumber===t))||{},sideNumber:t})));const t=a.sides.find((t=>t.sideNumber===s));t&&(t.lineUp=d)}nl({tournamentId:r?.tournamentId,context:"updateSidLineUps",eventId:o?.eventId,drawDefinition:i,matchUp:a})}function tg({inContextDrawMatchUps:t,drawPosition:e,matchUpId:n}){const r=t.filter((({winnerMatchUpId:t,loserMatchUpId:e})=>e===n||t===n)).sort(((t,e)=>t.roundPosition-e.roundPosition));return t.find((t=>t.matchUpId===n)).feedRound?1:r.reduce(((t,n,r)=>n.drawPositions?.includes(e)?r+1:t),void 0)}function eg({inContextDrawMatchUps:t,sourceMatchUpStatus:e,tournamentRecord:n,sourceMatchUpId:r,drawDefinition:i,matchUpStatus:a,drawPosition:o,matchUpsMap:s,matchUpId:c,event:u}){const d="assignMatchUpDrawPosition";s||(s=wp({drawDefinition:i})),t||(t=Pl({inContext:!0,drawDefinition:i,matchUpsMap:s}).matchUps??[]);const p=t.find((t=>t.matchUpId===c)),m=p?.structureId,f=i?.structures?.find((t=>t.structureId===m));if(!f)return{error:Dt};const h=s?.drawMatchUps?.find((t=>t.matchUpId===c)),I=h?.drawPositions??[],{positionAdded:g,positionAssigned:U,updatedDrawPositions:y}=function({drawPosition:t,drawPositions:e}){let n=!1,r=!!e?.includes(t);return{updatedDrawPositions:r?e||[]:[...e,void 0,void 0].slice(0,2).map((e=>e||r?e:(r=!0,n=!0,t))).sort(l).filter(Boolean),positionAdded:n,positionAssigned:r}}({drawPosition:o,drawPositions:I}),{positionAssignments:S}=Rp({drawDefinition:i,structure:f}),v=S?.filter((t=>y.includes(t.drawPosition))),w=v?.find((({bye:t})=>t)),T=h?.matchUpStatus&&[ca,Zi].includes(h.matchUpStatus)&&y.filter(Boolean).length<2;if(a=w&&Ki||a||T&&h.matchUpStatus||h?.matchUpStatus&&[ea,ta].includes(h.matchUpStatus)&&h.matchUpStatus||sa,h&&g){t=Pl({inContext:!0,drawDefinition:i,matchUpsMap:s}).matchUps??[];const u=T&&tg({inContextDrawMatchUps:t,drawPosition:o,matchUpId:c})||void 0;h?.matchUpStatusCodes&&kI({inContextDrawMatchUps:t,sourceMatchUpStatus:e,sourceMatchUpId:r,matchUpsMap:s,matchUp:h}),Object.assign(h,{drawPositions:y,winningSide:u,matchUpStatus:a}),nl({tournamentId:n?.tournamentId,eventId:p?.eventId,context:d,drawDefinition:i,matchUp:h})}const P=yl({inContextDrawMatchUps:t,inContextMatchUp:p,drawDefinition:i,matchUpId:c}),{targetMatchUps:{winnerMatchUp:D,loserMatchUp:N,loserTargetDrawPosition:R},targetLinks:{loserTargetLink:b}}=P,M=Tp({structureId:f.structureId,matchUpsMap:s});if(U&&w){if(D)if([Ki,ea,ta].includes(a)){const e=eg({matchUpId:D.matchUpId,inContextDrawMatchUps:t,tournamentRecord:n,drawDefinition:i,drawPosition:o,matchUpsMap:s});if(e.error)return e}else{const{structureId:t}=D;t!==f.structureId&&console.log("winnerMatchUp in different structure... participant is in different targetDrawPosition")}}else if(D&&p&&!p.feedRound){const{pairedPreviousMatchUpIsDoubleExit:e}=HI({targetMatchUp:h,drawPosition:o,matchUpsMap:s,structure:f});if(e){const e=eg({matchUpId:D.matchUpId,inContextDrawMatchUps:t,tournamentRecord:n,drawDefinition:i,drawPosition:o,matchUpsMap:s});if(e.error)return e}}if(h?.matchUpType===Ca){const e=t?.find((({matchUpId:t})=>t===h.matchUpId)),r=(e?.sides??[]).reduce(((t,e,n)=>e.drawPosition===o?n:t),void 0),a=S?.find((t=>t.drawPosition===o))?.participantId;a&&void 0!==r&&ZI({inContextTargetMatchUp:e,drawPositionSideIndex:r,teamParticipantId:a,tournamentRecord:n,drawDefinition:i,matchUp:h})}if(b?.linkCondition===fd&&2===y.filter(Boolean).length&&!w){if(M.filter((({drawPositions:t,roundNumber:e})=>1===e&&k(t,y))).every((({matchUpStatus:t})=>[Qi,aa].includes(t)))&&N){const{structureId:t}=N,e=YI({drawPosition:R,tournamentRecord:n,drawDefinition:i,structureId:t,matchUpsMap:s,event:u});if(e.error)return e}}return U?{...L}:Oi({result:{error:tt},context:{drawPosition:o},stack:d})}function ng(t){const{tournamentRecord:e,appliedPolicies:n,drawDefinition:r,matchUpsMap:i,targetData:a,structure:o,event:s}=t,c="doubleExitAdvancement";if(o.structureType===od)return Oi({result:{...L},stack:c});const{matchUp:u,targetMatchUps:d,targetLinks:p}=a,{loserMatchUp:l,winnerMatchUp:m,loserTargetDrawPosition:f}=d;if(l&&l.matchUpStatus!==Vi.Bye){const{loserTargetLink:a}=p;if(n?.progression?.doubleExitPropagateBye){const t=ig({loserTargetDrawPosition:f,tournamentRecord:e,loserTargetLink:a,drawDefinition:r,loserMatchUp:l,matchUpsMap:i,event:s});if(t.error)return Oi({result:t,stack:c})}else{const{feedRound:n,drawPositions:r,matchUpId:i}=l,a=n?2:2-r.indexOf(f),o=rg({...t,targetMatchUp:l,walkoverWinningSide:a,tournamentRecord:e,sourceMatchUp:u,matchUpId:i});if(o.error)return Oi({result:o,stack:c})}}if(m){const n=rg({...t,matchUpId:m.matchUpId,targetMatchUp:m,tournamentRecord:e,sourceMatchUp:u});if(n.error)return Oi({result:n,stack:c})}return Oi({result:{...L},stack:c})}function rg(t){const{inContextDrawMatchUps:e,tournamentRecord:n,drawDefinition:r,sourceMatchUp:i,targetMatchUp:a,matchUpsMap:o}=t,s=r.structures.find((({structureId:t})=>t===a.structureId)),c=t.matchUpStatus===Vi.DoubleDefault?Vi.DoubleDefault:Vi.DoubleWalkover,u=t.matchUpStatus===Vi.DoubleDefault?Vi.Defaulted:Vi.Walkover,d="conditionallyAdvanceDrawPosition",p=o.drawMatchUps.find((t=>t.matchUpId===a.matchUpId));if(!p)return{error:te};const l=i?.drawPositions||[];let m=p.drawPositions?.filter(Boolean);const f=i?.structureId===a.structureId;if(f&&k(l,m)&&(m=m.filter((t=>!l.includes(t)))),f&&m.length>1)return Oi({result:{error:tt},stack:d});const{pairedPreviousMatchUpIsDoubleExit:h,pairedPreviousMatchUp:I}=HI(t),g=yl({matchUpId:a.matchUpId,inContextDrawMatchUps:e,drawDefinition:r}),{targetMatchUps:U,targetLinks:y}=g,{loserTargetDrawPosition:S,winnerMatchUp:v,loserMatchUp:w}=U;if(w){const{loserTargetLink:t}=y,e=ig({loserTargetDrawPosition:S,loserMatchUp:w,tournamentRecord:n,loserTargetLink:t,drawDefinition:r,matchUpsMap:o});if(e.error)return Oi({result:e,stack:d})}const T=p.drawPositions?.filter(Boolean)||[],P=1===T.length,D=t.walkoverWinningSide||P&&tg({drawPosition:T[0],matchUpId:a.matchUpId,inContextDrawMatchUps:e})||void 0,N=[Vi.Walkover,Vi.Defaulted].includes(p.matchUpStatus)&&!T.length,R=1===p.finishingRound,b=N&&!R?c:u,M=e.find((t=>t.matchUpId===I.matchUpId));let A,E=[];i&&(i?.structureId===M?.structureId?A=i.roundPosition<I?.roundPosition?1:2:a.feedRound?A=i.structureId===a.structureId?2:1:D&&(A=3-D));const C=t.matchUpStatus,O=I?.matchUpStatus;1===A?E=[{matchUpStatus:ag(C),previousMatchUpStatus:C,sideNumber:1},{matchUpStatus:ag(O),previousMatchUpStatus:O,sideNumber:2}]:2===A&&(E=[{matchUpStatus:ag(O),previousMatchUpStatus:O,sideNumber:1},{matchUpStatus:ag(C),previousMatchUpStatus:C,sideNumber:2}]),E.length&&(E=E.map((t=>di(t))));const F=Rl({...t,matchUp:p,winningSide:D,matchUpStatusCodes:E,matchUpStatus:b});if(F.error)return Oi({result:F,stack:d});if(N)return ng({...t,matchUpStatus:b,targetData:g});if(!v)return Oi({result:{...L},stack:d});const x=2===m.length?m[D-1]:m[0],{positionAssignments:_}=Rp({structure:s}),B=_?.find((t=>t.drawPosition===x)),V=o.drawMatchUps.find((t=>t.matchUpId===v.matchUpId)),j=V?.drawPositions?.filter(Boolean),G=1===j.length;if(x){if(B?.bye){const n=yl({matchUpId:V.matchUpId,inContextDrawMatchUps:e,drawDefinition:r});if(G){const t=j.filter(Boolean)[0],n=tg({drawPosition:t,matchUpId:V.matchUpId,inContextDrawMatchUps:e}),i=Rl({matchUpId:V.matchUpId,matchUp:V,matchUpStatus:u,matchUpStatusCodes:[],removeScore:!0,drawDefinition:r,winningSide:n});return i.error?Oi({result:i,stack:d}):QI({drawPositionToAdvance:t,matchUpId:V.matchUpId,inContextDrawMatchUps:e,drawDefinition:r,matchUpsMap:o})}if([Vi.Walkover,Vi.Defaulted].includes(v.matchUpStatus)){const e=ng({...t,matchUpId:V.matchUpId,matchUpStatus:b,targetData:n});if(e.error)return Oi({result:e,stack:d})}return Oi({result:{...L},stack:d})}return eg({matchUpId:v.matchUpId,drawPosition:x,inContextDrawMatchUps:e,drawDefinition:r})}if(h){if(!V)return{error:te};if(G){const t=j[0],n=tg({matchUpId:a.matchUpId,inContextDrawMatchUps:e,drawPosition:t});console.log("existing drawPosition is winningSide",{walkoverWinningSide:n})}const n=[Vi.Walkover,Vi.Defaulted].includes(V.matchUpStatus)?u:c,i=Rl({matchUpId:V.matchUpId,matchUp:V,matchUpStatusCodes:[],removeScore:!0,drawDefinition:r,matchUpStatus:n});if(i.error)return Oi({result:i,stack:d});if(n===c){const e=ng({...t,matchUpId:a.matchUpId,matchUpStatus:n,targetData:g});if(e.error)return e}}return Oi({result:{...L},stack:d})}function ig(t){const{loserTargetDrawPosition:e,tournamentRecord:n,loserTargetLink:r,drawDefinition:i,matchUpsMap:a,event:o}=t,s=r?.target?.structureId,{structure:c}=zd({drawDefinition:i,structureId:s});return c?YI({drawPosition:e,tournamentRecord:n,drawDefinition:i,structureId:s,matchUpsMap:a,event:o}):{error:Rt}}function ag(t){return t===Vi.DoubleWalkover?Vi.Walkover:t===Vi.DoubleDefault?Vi.Defaulted:t}function og(t){const{tournamentRecord:e,drawDefinition:n,matchUpStatus:r,structure:i,matchUp:a}=t,o=!(!a.tieMatchUps||a.rondPosition||!t.inContextDrawMatchUps.find((t=>t.matchUpId===a.matchUpId)).containerStructureId),s=r===Ki,c=a.winningSide,u=[ea,ta].includes(r),d=Kp({matchUpStatus:r}),p=Jp({matchUpStatus:r}),l=!d&&!p,m=t.matchUpTieId||c&&d&&!u,f=c&&u;return l&&{error:jt}||m&&sg(t)||f&&function(t){const e=qI(t);return e.error?e:ng(t)}(t)||c&&qI(t)||p&&Rl({...t,removeScore:[Ji,ca].includes(r),matchUpStatus:r||sa})||s&&function({tournamentRecord:t,drawDefinition:e,structure:n,matchUp:r}){const i="attemptToSetMatchUpStatusBYE";if(r?.winningSide)return Oi({result:{error:$t},context:{matchUpStatus:Ki},stack:i});const{positionAssignments:a}=bp({structure:n}),o=a?.filter((t=>t.bye)).map((t=>t.drawPosition)),s=r.drawPositions?.some((t=>o?.includes(t)));return s?(r.matchUpStatus=Ki,r.matchUpStatusCodes=[],nl({tournamentId:t?.tournamentId,context:i,drawDefinition:e,matchUp:r}),{...L}):Oi({result:{error:Vt},info:"matchUp does not include BYE",stack:i})}({tournamentRecord:e,drawDefinition:n,structure:i,matchUp:a})||!d&&{error:jt}||u&&function(t){const e=sg({...t,removeScore:!0});return e.error?e:ng(t)}(t)||o&&sg(t)||Oi({result:{error:$t},stack:"attemptToSetMatchUpStatus"})}function sg(t){const e="scoreModification";if(t.isCollectionMatchUp&&t.dualMatchUp?.winningSide&&!t.projectedWinningSide){const n=qI(t);if(n.error)return Oi({result:n,stack:e})}const n=Boolean(t.matchUp.collectionId),r=Rl(t);if(n){const{matchUpTieId:n,drawDefinition:i,matchUpsMap:a}=t,o=bl({tournamentRecord:t.tournamentRecord,matchUpId:n,event:t.event,drawDefinition:i,matchUpsMap:a});if(o.error)return Oi({result:o,stack:e});Object.assign(r,{tieMatchUpResult:o})}return Oi({result:r,stack:e})}function cg({drawDefinition:t,structureId:e}){if(!t)return{error:Y};const{structure:n}=zd({drawDefinition:t,structureId:e}),r=(t?.links||[]).filter((t=>t.source?.structureId===e)).map((t=>t.target?.structureId));return{playoffStructures:(t?.structures||[]).filter((t=>r.includes(t.structureId))),structure:n}}function ug({withStageGrouping:t,stageSequences:e,stageSequence:n,roundTarget:r,stages:i,event:a,stage:o}){if(!a)return{error:At};const s={},c=[];for(const u of a.drawDefinitions||[]){const{structures:a,stageStructures:d}=Yd({withStageGrouping:t,stageSequences:e,drawDefinition:u,stageSequence:n,roundTarget:r,stages:i,stage:o});if(c.push(...a),d)for(const t of Object.keys(d))s[t]||(s[t]=[]),s[t].push(...d[t])}return{structures:c,stageStructures:s}}function dg(t){if(!t?.drawDefinition)return!1;const e=Tl(t),n=e?.includesTeamMatchUps;let{completedMatchUps:r,pendingMatchUps:i,upcomingMatchUps:a}=e||{};n&&(r=r?.filter((({matchUpType:t})=>t===Ca)),i=i?.filter((({matchUpType:t})=>t===Ca)),a=a?.filter((({matchUpType:t})=>t===Ca)));return!!(r?.length&&!i?.length&&!a?.length)}function pg(t){const{drawDefinition:e,structureId:n}=t;if(!e)return{error:Y};const{playoffStructures:r}=cg({drawDefinition:e,structureId:n});if(!r?.length)return!1;const i=e?.entries?.filter((t=>lp.includes(t?.entryStatus)))?.length||0;let a=0;return(r||[]).reduce(((t,e)=>{const n=Rp({structure:e}).positionAssignments??[],r=n?.filter((t=>(t.participantId&&a++,t?.bye||t?.participantId))).length;return r&&t}),!!r.length)||a===i}function lg({drawDefinition:t,structure:e,matchUp:n}){const r=[];if(e.finishingPosition===jd){if(dg({drawDefinition:t,structure:e})){const{structureIds:i}=function({drawDefinition:t,structure:e,matchUp:n}){const{drawPositions:r}=n,{positionAssignments:i}=Rp({drawDefinition:t,structure:e}),a=i?.filter((({drawPosition:t})=>r?.includes(t))),o=a?.map((t=>{const{extension:e}=gs({element:t,name:xo});return e?.value?.groupOrder})),{containerStructures:s}=LI({drawDefinition:t}),c=s[e.structureId],u=Ul({drawDefinition:t,structureId:c})?.links?.source,d=u?.filter((t=>k(o,t.source?.finishingPositions||[]))).map((t=>t.source.structureId));return{structureIds:d}}({drawDefinition:t,structure:e,matchUp:n});i?.length&&r.push(...i)}}return{connectedStructureIds:r}}function mg(t){const{dualWinningSideChange:e,matchUpStatusCodes:n,tournamentRecord:r,drawDefinition:i,matchUpFormat:a,matchUpStatus:o,winningSide:s,matchUpId:c,structure:u,matchUp:d,event:p,score:l}=t,m=Kp({matchUpStatus:o})||[Ji,zi].includes(o)&&e,f=Boolean(d.collectionId),h=Fp({drawDefinition:i,structure:u}),I=f||h||function({structure:t,matchUp:e}){const{drawPositions:n}=e,{positionAssignments:r}=bp({structure:t}),i=r?.filter((t=>n?.includes(t.drawPosition)&&t.participantId));return 2===i?.length}({structure:u,matchUp:d});if(!I)return{error:kt};const g=[ca].includes(o);return Oi({result:Rl({matchUpStatusCodes:m&&n||[],matchUpStatus:m&&o||Qi,tournamentRecord:r,drawDefinition:i,matchUpFormat:a,removeScore:g,winningSide:s,matchUpId:c,matchUp:d,event:p,score:l}),stack:"attemptToModifyScore"})}function fg({lineUp:t}){if(!Array.isArray(t))return;const e={};return T(t.flatMap((({collectionAssignments:t})=>t.map((({collectionId:t,collectionPosition:e})=>[t,e].join("|")))))).forEach((n=>{const[r,i]=n.split("|"),a=parseInt(i),{assignedParticipantIds:o}=Mu({collectionPosition:a,collectionId:r,lineUp:t});o.forEach((t=>{e[t]||(e[t]=[]),e[t].push({collectionId:r,collectionPosition:a})}))})),Object.keys(e).map((t=>({participantId:t,collectionAssignments:e[t]})))}function hg(t){if(!t)return 1/0;if(v(t))return m(t);const e=t.split("-")[0];return v(e)?m(e):1/0}function Ig(t){return oi(t)?t.split(" ").map((t=>t.split("").map(((t,e)=>e?t.toLowerCase():t.toUpperCase())).join(""))).join(" "):t}function gg(t){return oi(t)?Ig(t.replace(/_/g," ")):t}const Ug=({finishingPosition:t=Gd,qualifyingRoundNumber:e,structureAbbreviation:n,seedAssignments:r=[],stageSequence:i=1,structureOrder:a,seedingProfile:o,matchUpFormat:s,structureType:c,structureName:u,matchUpType:d,matchUps:p=[],structureId:l,roundOffset:m,roundLimit:f,stageOrder:h,structures:I,stage:g})=>{const U={structureId:l??hi(),structureAbbreviation:n,finishingPosition:t,seedAssignments:r,matchUpFormat:s,stageSequence:i,structureName:u};a&&(U.structureOrder=a),c&&(U.structureType=c),o&&("string"==typeof o?U.seedingProfile=o:"object"==typeof o&&"string"==typeof o.positioning&&(U.seedingProfile=o.positioning)),d&&(U.matchUpType=d),m&&(U.roundOffset=m),h&&(U.stageOrder=h),f&&(U.roundLimit=f),g&&(U.stage=g),e&&(U.qualifyingRoundNumber=e);const y=p.flatMap((({drawPositions:t})=>t)).filter(Boolean);return I?U.structures=I:(U.matchUps=p,U.positionAssignments=T(y).sort(((t,e)=>t-e)).map((t=>({drawPosition:t})))),U};function yg(t){const{groupNameBase:e="Group",playoffAttributes:n,stageSequence:r=1,structureOptions:i,appliedPolicies:a,seedingProfile:o,stage:s=Hu,matchUpType:c,roundTarget:u,structureId:d,groupNames:p,drawSize:l,idPrefix:m,isMock:f,uuids:h}=t,I=t.structureName??n?.[0]?.name??gg(Hu),{groupCount:g,groupSize:U}=function({appliedPolicies:t,structureOptions:e,drawSize:n}){let r=e?.groupSize;const i=e?.groupSizeLimit||8,{validGroupSizes:a}=Sg({groupSizeLimit:i,drawSize:n}),o=a&&Math.max(...a),s=r&&a?.includes(r);s||(r=r&&r>4||!a?.includes(4)?o:4);const c=Math.ceil(n/r);return{groupSize:r,groupCount:c}}({structureOptions:i,appliedPolicies:a,drawSize:l}),y=jd;let S;const v=E(1,g+1).map((t=>{const n=function({structureOrder:t,matchUpType:e,groupSize:n,drawSize:r,idPrefix:i,isMock:a,uuids:o}){const s=(t-1)*n,c=E(1+s,n+1+s),{uniqueMatchUpGroupings:u}=Ah({drawPositions:c}),d=Ch({groupSize:n,drawPositionOffset:s}),p=u.map(m).sort(((t,e)=>(t.roundNumber||1/0)-(e.roundNumber||1/0)));return p;function l(t){return d.reduce(((e,n,r)=>n.includes(t)?r+1:e),void 0)}function m(n){const s=l(Eh(n)),c=[1,r],u=function({structureOrder:t,drawPositions:e,roundNumber:n,idPrefix:r,uuids:i}){return r?`${r}-${t}-${n}-DP-${e.join("-")}`:i?.pop()||hi()}({structureOrder:t,drawPositions:n,roundNumber:s,idPrefix:i,uuids:o}),d={matchUpStatus:s?Vi.ToBePlayed:Vi.Bye,matchUpType:e,finishingPositionRange:{winner:c,loser:c},drawPositions:n,roundNumber:s,matchUpId:u};return a&&(d.isMock=!0),d}}({groupSize:U,structureOrder:t,matchUpType:c,drawSize:l,idPrefix:m,isMock:f});S=Math.max(...n.map((({roundNumber:t})=>t)));const r=p?.[t-1]??`${e} ${t}`;return Ug({structureId:h?.pop(),structureType:ad,finishingPosition:y,structureOrder:t,structureName:r,matchUps:n})})),w=Ug({structureId:d||h?.pop(),structureType:od,finishingPosition:y,seedingProfile:o,structureName:I,stageSequence:r,structures:v,stage:s});return u&&Bs({extension:{name:Eo,value:u},element:w}),{structures:[w],maxRoundNumber:S,groupCount:g,links:[],groupSize:U,...L}}function Sg({drawSize:t,groupSizeLimit:e=10}){const n=E(3,e+1).filter((e=>{const n=Math.ceil(t/e),r=n*e-t,i=Math.ceil(t/n),a=Math.ceil(r/n);return(!r||r<e)&&i===e&&i>=3&&a<2}));return{...L,validGroupSizes:n}}function vg(t){const{roundRobinGroupsCount:e,participantsCount:n,cluster:r}=t;if(!v(n))return{seedBlocks:void 0,...Oi({result:{error:xn},context:{participantsCount:n},stack:"getSeedBlocks"})};const i=y(n);if(e){const t=Math.min(e,i),n=[];let r=1;for(E(0,t).forEach((()=>{n.push([r]),r++}));r<i;){const e=E(r,r+t);r+=t,n.push(e)}return{...L,seedBlocks:n}}const a=E(1,i+1),o=[];let s=i/2;for(;s>1;){const t=x(a,s),e=t.length;t.forEach(((t,n)=>{let i;const a=n<e/2,s=n%2==0,c=t[0],u=t[t.length-1];i=r&&e>4?8===e?a?u:c:s?c:u:a?c:u,k(t,o)||o.push(i)})),s/=2}const c=a.filter((t=>!o.includes(t)));for(;c.length;)c.length%2==0?o.push(c.pop()):o.push(c.shift());const u=E(0,20).map((t=>Math.pow(2,t)));u.unshift(1);const d=u.indexOf(i);let p=0;const l=[];return E(0,d).forEach((t=>{l.push(o.slice(p,p+u[t])),p+=u[t]})),{...L,seedBlocks:l}}function wg({roundRobinGroupsCount:t,drawSize:e}){const n="getSeedGroups";if(!v(e))return{seedGroups:void 0,...Oi({result:{error:xn},context:{drawSize:e},stack:n})};if(t){if(!v(t))return{seedGroups:void 0,...Oi({context:{roundRobinGroupsCount:t},result:{error:xn},stack:n})};let r=1;return{seedGroups:E(0,Math.floor(e/t)).map((()=>{const e=E(r,r+t);return r+=t,e}))}}{const{seedBlocks:n}=vg({participantsCount:e,roundRobinGroupsCount:t});let r=0;return{seedGroups:(n||[]).map((t=>(t||[]).map((()=>(r+=1,r)))))}}}function Tg({provisionalPositioning:t,appliedPolicies:e,drawDefinition:n,allPositions:r,structure:i}){let a=[];if(!i)return{error:Rt};const{matchUps:o,roundMatchUps:s}=qp({matchUpFilters:{roundNumbers:[1]},provisionalPositioning:t,structure:i}),{seedAssignments:c}=Sp({provisionalPositioning:t,drawDefinition:n,structure:i}),{positionAssignments:u}=bp({structure:i}),d=u?.length,p=c?.length??0;let l=[];const m=Object.keys(s).map((t=>parseInt(t))).sort(((t,e)=>t-e)).map((t=>{const e=s[t].map((t=>t.drawPositions)).flat(1/0).filter(Boolean),n=e.filter((t=>!l.includes(t)));return l=l.concat(...e),n})).filter((t=>t.length)).reverse(),f=m.pop(),h=f&&Math.min(...f)-1||0,I=e?.seeding?.seedingProfile,g=f?.length||0,U=m.filter((t=>t.filter((t=>t<=p)).length)),{stage:y,structureType:S,roundLimit:v}=i,w=S===od,T=!w&&m?.length,P=!w&&y===zu&&v,D=U.flat(1/0),N=T?D?.length:0,R=r?d:p,b=Op({drawDefinition:n,structure:i,matchUps:o}),M=b?0:!T&&R||R&&D.length<R&&R-D.length||0;if(P){const t=i?.matchUps?i.matchUps.filter((({roundNumber:t})=>t===i.roundLimit)).length:0,e=f.length/t;if(T);else{const t=Rg(I),n=x(f,e);let r=1;const i=E(0,n[0].length).map((()=>{const t=E(r,r+n.length);return r+=n.length,t}));({validSeedBlocks:a}=Pg({drawPositionBlocks:n,positioning:t,seedGroups:i}))}}else if(w){const t=function({seedingProfile:t,structure:e}){const n=e.structures||[],r=n.length,i=Rp({structure:e})?.positionAssignments,a=Rg(t),o=i?.length??0,{seedGroups:s}=wg({roundRobinGroupsCount:r,drawSize:o});return Pg({drawPositionBlocks:n.map((t=>Rp({structure:t}).positionAssignments?.map((t=>t.drawPosition)))),positioning:a,seedGroups:s})}({seedingProfile:I,structure:i});({validSeedBlocks:a}=t)}else if(T)a=U.map((t=>({seedNumbers:t,drawPositions:t})));else if(b){x(f,2).map(((t,e)=>({drawPositions:[t[0]],seedNumbers:[e+1]}))).forEach((t=>a.push(t)))}if(!w&&!b&&!P){const{blocks:t}=function(t){const{drawPositionOffset:e=0,roundRobinGroupsCount:n,seedNumberOffset:r=0,seedingProfile:i,seedCountGoal:a,baseDrawSize:o}=t;let s=1;const c=[],{seedBlocks:u}=vg({cluster:Rg(i)===rd,participantsCount:o,roundRobinGroupsCount:n});s=0;for(const p of u){if(s+1>a)break;const t=p.map((t=>t+e)),n=d(s+1,p.length).map((t=>+t+r));s+=p.length,c.push({drawPositions:t,seedNumbers:n})}return{blocks:c};function d(t,e){return Array.from(new Array(e),((e,n)=>n+t))}}({drawPositionOffset:h,seedNumberOffset:N,seedCountGoal:M,seedingProfile:I,baseDrawSize:g});t.forEach((t=>a.push(t)))}const A=a.flatMap((t=>t.drawPositions)).reduce(((t,e)=>f?.includes(e)&&t),!0);return b||T||w||A?{isLuckyStructure:b,validSeedBlocks:a,isContainer:w,isFeedIn:T}:{error:vt,validSeedBlocks:[],isContainer:w,isFeedIn:T}}function Pg({positioning:t,seedGroups:e,drawPositionBlocks:n}){const r=[],i=(t,e)=>t-e,a=(t,e)=>e-t,o=[];return e.forEach(((e,s)=>{s&&t!==id&&P(e),e.forEach(((t,e)=>{const c=s%2?n.length-e-1:e,u=n[c].sort(s%2?a:i).find((t=>!o.includes(t)));o.push(u),r.push({seedNumbers:[t],drawPositions:[u]})}))})),{validSeedBlocks:r}}function Dg({appliedPolicies:t,drawDefinition:e,seedBlockInfo:n,drawPosition:r,structureId:i,seedNumber:a}){const{structure:o}=zd({drawDefinition:e,structureId:i});t||(t=Vo({drawDefinition:e}).appliedPolicies);let s=n?.validSeedBlocks;if(!s&&o&&(s=Tg({appliedPolicies:t,drawDefinition:e,structure:o})?.validSeedBlocks),t?.seeding?.validSeedPositions?.ignore)return!0;if(t?.seeding?.validSeedPositions?.strict){const t=s.find((t=>t.seedNumbers.includes(a)));return(t?.drawPositions||[]).includes(r)}return[].concat(...s.map((t=>t.drawPositions))).includes(r)}function Ng(t){const{provisionalPositioning:e,drawDefinition:n,seedBlockInfo:r,structureId:i,randomize:a}=t,{structure:o}=zd({drawDefinition:n,structureId:i}),{seedAssignments:s}=Sp({provisionalPositioning:e,drawDefinition:n,structure:o}),{positionAssignments:c}=bp({structure:o}),u=c?.filter((t=>t.participantId??t.bye??t.qualifier)),d=u?.map((t=>t.drawPosition)).filter(Boolean),{appliedPolicies:p}=Vo({drawDefinition:n}),l=(r?.validSeedBlocks||o&&Tg({provisionalPositioning:e,appliedPolicies:p,drawDefinition:n,structure:o})?.validSeedBlocks||[]).filter((t=>t.drawPositions.filter((t=>!d?.includes(t))).length))[0],m=s?.map((t=>t.participantId)).filter(Boolean),f=c?.map((t=>t.participantId)).filter(Boolean),h=m?.filter((t=>f?.includes(t))),I=m?.filter((t=>!f?.includes(t))),g=s?.filter((t=>I?.includes(t.participantId))),U=s?.filter((t=>!t.participantId)),y=(g?.length&&g.length>0?g.length:U?.length??0)&&l?.drawPositions.filter((t=>!d?.includes(t)))||[],S=a?P(y):y,v=[],w=S.map((()=>{const t=function(t,e){const n=t.filter((t=>!e.includes(t.participantId))),r=Math.min(...n.map((t=>hg(t.seedValue)))),i=n.filter((t=>hg(t.seedValue)===r));return P(i).pop()}(g,v),e=t?.participantId;return e&&v.push(e),e})).filter(Boolean),T=s?.filter((t=>h?.includes(t.participantId))).map((t=>t.seedNumber)),D=(l?.seedNumbers||[]).filter((t=>!T?.includes(t))),N=s?.filter((t=>D.includes(t.seedNumber))).map((t=>t.participantId)),R=p?.seeding?.duplicateSeedNumbers;return{nextSeedBlock:l,unplacedSeedParticipantIds:void 0===R||R?w:N,unplacedSeedNumbers:D,unfilledPositions:S,unplacedSeedAssignments:g}}function Rg(t){return"string"==typeof t?t:"object"==typeof t?t.positioning:void 0}function bg({participantId:t,drawDefinition:e,entryStatus:n,entryStage:r}){if(!e)return{error:Y};const i=e.entries?.find((e=>!(e.participantId!==t||n&&n!==e.entryStatus||r&&r!==e.entryStage)));return t&&i}function Mg({provisionalPositioning:t,tournamentRecord:e,drawDefinition:n,seedingProfile:r,participantId:i,seedBlockInfo:a,structureId:o,seedNumber:s,seedValue:c,eventId:u,event:d}){const p="assignSeed",{structure:l}=zd({drawDefinition:n,structureId:o}),{positionAssignments:m}=bp({structure:l}),f=Sp({provisionalPositioning:t,drawDefinition:n,structure:l}).seedAssignments,h=f.map((t=>t.seedNumber)),I=bg({drawDefinition:n,participantId:i});if(i&&!I)return Oi({result:{error:Ee},context:{participantId:i},stack:p});const g=d?_s({event:d}).flightProfile?.flights?.length:0,U=g&&g>1,y=m?.find((t=>t.participantId===i)),S=y?.drawPosition;if(S){if(!Dg({drawPosition:S,drawDefinition:n,seedBlockInfo:a,structureId:o,seedNumber:s}))return Oi({result:{error:Z},context:{assignedDrawPosition:S},info:"invalid seed position",stack:p})}let v;return h.includes(s)||f.push({seedNumber:s,seedValue:c}),f.forEach((t=>{t.participantId===i&&t.seedNumber!==s&&(t.participantId=void 0),t.seedNumber===s&&(t.participantId=i,r?.groupSeedingThreshold||U||(t.seedValue=c||s),v=!0)})),v?(al({tournamentId:e?.tournamentId,drawDefinition:n,structure:l,eventId:u}),{...L}):Oi({result:{error:St},stack:p})}function Ag({inContextDrawMatchUps:t,drawDefinition:e,assignments:n,matchUpsMap:r,structure:i}){const a=LI({drawDefinition:e})?.containedStructures,o=a?.[i.structureId]?.map((({structureId:t})=>t))||[];o.push(i?.structureId);const s=n?.map((({drawPosition:t})=>t))||[],c=t?.filter((t=>o.includes(t.structureId)&&O(t.drawPositions||[],s).length))||[],u=c.map((({matchUpId:t})=>t)),d=r?.drawMatchUps?.filter((t=>u.includes(t.matchUpId)))||[];return{drawPositions:s,matchUps:d,targetMatchUps:c}}function Eg({lineUp:t,tieFormat:e}){const n=[];if(!Array.isArray(t))return n.push(Ci("lineUp")),{valid:!1,errors:n,error:xn};const r=t.every((t=>{if("object"!=typeof t)return n.push("lineUp entries must be objects"),!1;const{participantId:e,collectionAssignments:r}=t;return e?"string"!=typeof e?(n.push("participantIds must be strings"),!1):Array.isArray(r)?r.every((t=>{if("object"!=typeof t)return n.push("collectionAssignments must be objects"),!1;const{collectionPosition:e}=t;return"number"==typeof e||(n.push("collectionPosition must be a number"),!1)})):(n.push(Ci("collectionAssignments")),!1):(n.push("Missing participantId"),!1)})),i=T(t.map(ml)).length===t.length;i||n.push("Duplicated participantId(s)");return{valid:r&&i,errors:n,error:n.length?xn:void 0}}function Cg({drawDefinition:t,participantId:e,tieFormat:n,lineUp:r}){if("object"!=typeof t)return{error:Y};if("string"!=typeof e)return{error:Le};const i=Eg({lineUp:r,tieFormat:n});if(!i.valid)return i;const{extension:a}=tc({element:t,name:Do}),o=a?.value||{};o[e]=fg({lineUp:r});return Bs({element:t,extension:{name:Do,value:o}}),rl({drawDefinition:t}),{...L}}function Og({inContextDrawMatchUps:t,inheritance:e=!0,tournamentRecord:n,drawDefinition:r,matchUpsMap:i,assignments:a,structure:o,event:s}){if(!r)return{error:Y};const{drawPositions:c,matchUps:u,targetMatchUps:d}=Ag({inContextDrawMatchUps:t,matchUpsMap:i,assignments:a,structure:o});for(const p of d)p.matchUpType===Ea&&(p.sides||[]).forEach(((t,i)=>{if(t?.drawPosition&&c?.includes(t.drawPosition)){const a=u.find((({matchUpId:t})=>t===p.matchUpId));if(a?.sides?.[i]){if(delete a.sides[i].lineUp,!1===e){const e=p.tieFormat,n=t.participantId;e&&n&&Cg({drawDefinition:r,participantId:n,lineUp:[],tieFormat:e})}nl({tournamentId:n?.tournamentId,context:"resetLineUps",eventId:s?.eventId,drawDefinition:r,matchUp:a})}}}));return{...L}}function Fg({provisionalPositioning:t,inContextDrawMatchUps:e,isQualifierPosition:n,sourceMatchUpStatus:r,tournamentRecord:i,drawDefinition:a,seedingProfile:o,participantId:s,seedBlockInfo:c,drawPosition:u,matchUpsMap:d,structureId:p,event:l}){const m="assignDrawPosition";if(!s&&!n)return Oi({result:{error:Le},stack:m});d=d||wp({drawDefinition:a}),e||({matchUps:e}=Pl({inContext:!0,drawDefinition:a,matchUpsMap:d}));const f=zd({drawDefinition:a,structureId:p});if(f.error)return Oi({result:f,stack:m});const{structure:h}=f;if(!h)return{error:Dt};if(Fp({drawDefinition:a,structure:h}))return Oi({result:{error:ee},stack:m});const{seedAssignments:I}=Sp({provisionalPositioning:t,drawDefinition:a,structure:h}),g=I?.find((t=>t.participantId===s)),U=g?.seedNumber,{appliedPolicies:y}=Vo({tournamentRecord:i,drawDefinition:a,structure:h,event:l});if(U){if(!Dg({seedNumber:U,appliedPolicies:y,drawDefinition:a,seedBlockInfo:c,drawPosition:u,structureId:p}))return Oi({result:{error:Z},context:{drawPosition:u},stack:m})}const S=bp({structure:h}).positionAssignments||[],v=S?.find((t=>t.drawPosition===u));if(!v)return Oi({result:{error:ot},context:{drawPosition:u},stack:m});const w=S?.map(ml).includes(s);if(w)return Oi({result:{error:ze},context:{drawPosition:u},stack:m});const{containsParticipant:T,containsBye:P}=function(t){const e=t.bye,n=t.qualifier,r=t.participantId;return{containsBye:e,containsQualifier:n,containsParticipant:r,filled:e||n||r}}(v);if(P){const t=VI({inContextDrawMatchUps:e,tournamentRecord:i,drawDefinition:a,drawPosition:u,structureId:p,matchUpsMap:d,event:l});if(t.error)return Oi({result:t,stack:m})}if(T&&v.participantId!==s){const{activeDrawPositions:t}=BI({drawDefinition:a,structureId:p});if(t.includes(u))return Oi({result:{error:at},stack:m});Og({assignments:[v],inContextDrawMatchUps:e,tournamentRecord:i,drawDefinition:a,matchUpsMap:d,structure:h})}if(v.participantId=s,n&&(v.qualifier=!0),(h?.stageSequence||0)>1||h.stage&&[Yu,Ju].includes(h.stage)){const e=h.stage===zu?zu:Hu,n=a.structures?.find((t=>t?.stage===e&&1===t?.stageSequence)),r=(n?.seedAssignments||[]).find((t=>t.participantId===s));if(r?.participantId){const{participantId:e,seedNumber:n,seedValue:s}=r;Mg({eventId:l?.eventId,provisionalPositioning:t,tournamentRecord:i,drawDefinition:a,seedingProfile:o,participantId:e,seedNumber:n,seedValue:s,structureId:p,event:l})}}if(h.structureType!==od)!function({provisionalPositioning:t,inContextDrawMatchUps:e,sourceMatchUpStatus:n,tournamentRecord:r,drawDefinition:i,drawPosition:a,matchUpsMap:o,structure:s,event:c}){const u={isCollectionMatchUp:!1},{matchUps:d}=qp({provisionalPositioning:t,matchUpFilters:u,drawDefinition:i,matchUpsMap:o,structure:s,event:c}),{roundMatchUps:p}=Gu({matchUps:d}),{initialRoundNumber:l}=OI({drawPosition:a,matchUps:d}),m=l&&p?.[l].find((t=>t.drawPositions?.includes(a)));if(m){const t=eg({matchUpId:m.matchUpId,inContextDrawMatchUps:e,sourceMatchUpStatus:n,tournamentRecord:r,drawDefinition:i,drawPosition:a,matchUpsMap:o});if(t.error)return Oi({stack:"assignDrawPositionToMatchUps",context:{drawPosition:a},result:t})}}({provisionalPositioning:t,inContextDrawMatchUps:e,sourceMatchUpStatus:r,tournamentRecord:i,drawDefinition:a,drawPosition:u,matchUpsMap:d,structure:h,event:l});else{_I({positionAssignments:S,tournamentRecord:i,drawDefinition:a,matchUpsMap:d,structure:h});const{drawPositions:t,matchUps:n,targetMatchUps:r}=Ag({assignments:[v],inContextDrawMatchUps:e,drawDefinition:a,matchUpsMap:d,structure:h});if(t&&1===n?.length&&n[0].matchUpType===Ca){const e=(r?.[0].sides||[]).reduce(((e,n,r)=>t?.includes(n.drawPosition)?r:e),void 0);ZI({inContextTargetMatchUp:r[0],teamParticipantId:s,matchUp:n[0],drawPositionSideIndex:e,tournamentRecord:i,drawDefinition:a})}}return ol({tournamentId:i?.tournamentId,drawDefinition:a,structure:h,event:l}),{positionAssignments:S,...L}}function kg(t){const e=mg(t);if(e.error)return e;const n=Kp({matchUpStatus:t.matchUpStatus}),{dualWinningSideChange:r,projectedWinningSide:i,inContextDrawMatchUps:a,tournamentRecord:o,drawDefinition:s,matchUpStatus:c,dualMatchUp:u,matchUpsMap:d,winningSide:p,targetData:m,matchUpId:f,structure:h,matchUp:I,event:g}=t,U="directParticipants",y=Boolean(I.collectionId),S=Fp({drawDefinition:s,structure:h});let v,w=I.drawPositions;if(y){const{matchUpTieId:e,matchUpsMap:n}=t,i=bl({matchUpId:e,tournamentRecord:o,drawDefinition:s,matchUpsMap:n,event:g});v=i&&{tieMatchUpResult:i};const c=a.find((({matchUpId:t})=>t===e));if(w=c?.drawPositions,!r)return Oi({result:{...L,...v},stack:U})}if(S)return Oi({result:{...L,...v},stack:U});if(!w)return Oi({result:{error:it},stack:U});{const t=i?i-1:p-1,e=1-t,r=w[t],h=w[e],{targetLinks:{loserTargetLink:I,winnerTargetLink:y,byeTargetLink:S},targetMatchUps:{winnerMatchUpDrawPositionIndex:v,loserMatchUpDrawPositionIndex:T,winnerMatchUp:P,loserMatchUp:D,byeMatchUp:N}}=m;if(P){const t=function({winnerMatchUpDrawPositionIndex:t,inContextDrawMatchUps:e,projectedWinningSide:n,sourceMatchUpStatus:r,winningDrawPosition:i,tournamentRecord:a,winnerTargetLink:o,sourceMatchUpId:s,drawDefinition:c,winnerMatchUp:u,dualMatchUp:d,matchUpsMap:p,event:l}){const m="directWinner";if(o){const n=u.drawPositions||[],d=n[t],f=o.source.structureId,h=zd({structureId:f,drawDefinition:c});if(h.error)return h;const{structure:I}=h,{positionAssignments:g}=bp({structureId:f,drawDefinition:c}),U=g?.find((t=>t.drawPosition===i)),y=U?.participantId,S=o.target.structureId,{positionAssignments:v}=bp({structureId:S,drawDefinition:c}),w=v?.find((t=>t.participantId===y)),T=w?.drawPosition,P=v?.filter((t=>{const e=n.includes(t.drawPosition),r=!t.participantId&&!t.bye&&!t.qualifier;return e&&r})).map((t=>t.drawPosition)),D=P?.includes(d);if(y&&1===o.target.roundNumber&&D)Fg({drawPosition:d,participantId:y,structureId:S,inContextDrawMatchUps:e,sourceMatchUpStatus:r,tournamentRecord:a,drawDefinition:c,matchUpsMap:p,event:l});else if(y&&P?.length){const t=P.pop();t&&Fg({participantId:y,structureId:S,inContextDrawMatchUps:e,sourceMatchUpStatus:r,tournamentRecord:a,drawDefinition:c,drawPosition:t,matchUpsMap:p,event:l})}else if(T){const t=eg({drawPosition:T,matchUpId:u.matchUpId,inContextDrawMatchUps:e,sourceMatchUpStatus:r,tournamentRecord:a,sourceMatchUpId:s,drawDefinition:c,matchUpsMap:p});if(t.error)return Oi({result:t,stack:m})}else if(I?.stage!==zu){const t="winner target position unavaiallble";return console.log(t),{error:t}}if(I?.seedAssignments&&I.structureId!==S){const t=I.seedAssignments.find((({participantId:t})=>t===y)),e=t?.participantId;t&&e&&Mg({eventId:u?.eventId,structureId:S,...t,tournamentRecord:a,drawDefinition:c,participantId:e})}}else{const t=eg({matchUpId:u.matchUpId,drawPosition:i,inContextDrawMatchUps:e,sourceMatchUpStatus:r,tournamentRecord:a,sourceMatchUpId:s,drawDefinition:c,matchUpsMap:p});if(t.error)return t}if(d&&n){const t=d.sides?.find((t=>t.sideNumber===n));if(t?.lineUp){const e=d.roundPosition,n=u.roundPosition,r=e===n&&1!==e||Math.floor(e/2)===n?2:1,i=p?.drawMatchUps?.find((({matchUpId:t})=>t===u.matchUpId)),o=[1,2].map((t=>({...i.sides?.find((e=>e.sideNumber===t))||{},sideNumber:t})));i.sides=o;const s=i.sides.find((t=>t.sideNumber===r));if(s){const e=t.lineUp?.filter((t=>t?.participantId));s.lineUp=fg({lineUp:e}),nl({tournamentId:a?.tournamentId,eventId:u?.eventId,matchUp:i,context:m,drawDefinition:c})}}}return{...L}}({sourceMatchUpStatus:n&&c||Qi,winnerMatchUpDrawPositionIndex:v,sourceMatchUpId:f,inContextDrawMatchUps:a,projectedWinningSide:i,winningDrawPosition:r,tournamentRecord:o,winnerTargetLink:y,drawDefinition:s,winnerMatchUp:P,dualMatchUp:u,matchUpsMap:d,event:g});if(t.error)return Oi({result:t,stack:U})}if(D){const t=function(t){const{loserMatchUpDrawPositionIndex:e,inContextDrawMatchUps:n,projectedWinningSide:r,sourceMatchUpStatus:i,loserDrawPosition:a,tournamentRecord:o,loserTargetLink:s,drawDefinition:c,loserMatchUp:u,dualMatchUp:d,matchUpsMap:p,event:m}=t,f="directLoser",h=s.linkCondition,I=u.drawPositions||[],g=h===fd&&2===u.roundNumber&&Math.min(...I.filter(Boolean)),U=g||I[e],y=g||I[1-e],S=s.source.structureId,{structure:v}=zd({structureId:S,drawDefinition:c}),{matchUps:w}=qp({afterRecoveryTimes:!1,inContext:!0,drawDefinition:c,structure:v,event:m}),T=w.filter((t=>t.drawPositions?.includes(a))).filter((t=>{const e=t.sides.find((t=>t.drawPosition===a)),n=t.matchUpStatus===ca||t.matchUpStatus===Zi&&!Yp(t);return e?.sideNumber===t.winningSide&&!n})),P=h===fd&&0===T.length,{positionAssignments:D}=bp({structureId:S,drawDefinition:c}),N=D?.find((t=>t.drawPosition===a)),R=N?.participantId,b=s.target.structureId,{positionAssignments:M}=bp({structureId:b,drawDefinition:c}),A=M?.filter((({drawPosition:t})=>I.includes(t))),E=A?.some((t=>t.participantId===R));if(E)return{...L};const C=A?.filter((t=>{const e=I.includes(t.drawPosition),n=!t.participantId&&!t.bye&&!t.qualifier;return e&&n})).map((t=>t.drawPosition)),O=C?.includes(U),F=s.target.roundNumber>1&&C?.length,k=1===s.target.roundNumber&&O;if(g){const t=function(){const t="loserLinkFedFMLC";return Oi(P?{result:_(),stack:t}:{result:x(),stack:t})}();if(t.error)return Oi({result:t,stack:f})}else if(k){const t=_();if(t.error)return Oi({result:t,stack:f})}else{if(!R||!F)return Oi({result:{error:ot},context:{loserDrawPosition:a,loserTargetLink:s},stack:f});{C.sort(l);const t=C[0],e=Fg({participantId:R,structureId:b,drawPosition:t,inContextDrawMatchUps:n,sourceMatchUpStatus:i,tournamentRecord:o,drawDefinition:c,matchUpsMap:p,event:m});if(e.error)return Oi({result:e,stack:f})}}if(v?.seedAssignments&&v.structureId!==b){const t=v.seedAssignments.find((({participantId:t})=>t===R)),e=t?.participantId;t&&e&&Mg({eventId:u?.eventId,structureId:b,...t,tournamentRecord:o,drawDefinition:c,participantId:e})}if(d&&r){const t=d.sides?.find((t=>t.sideNumber===3-r));if(t?.lineUp){const{roundNumber:e,eventId:n}=u,{roundPosition:r}=d,i=1===e?2-r%2:1,a=p?.drawMatchUps?.find((({matchUpId:t})=>t===u.matchUpId)),s=[1,2].map((t=>({...a.sides?.find((e=>e.sideNumber===t))||{},sideNumber:t})));a.sides=s;const l=a.sides.find((t=>t.sideNumber===i));l&&(l.lineUp=fg({lineUp:t.lineUp}),nl({tournamentId:o?.tournamentId,matchUp:a,context:f,drawDefinition:c,eventId:n}))}}return{...L};function x(){return Oi({result:YI({drawPosition:y,structureId:b,tournamentRecord:o,drawDefinition:c,event:m}),stack:"assignLoserPositionBye"})}function _(){return Oi({result:R?Fg({drawPosition:U,participantId:R,structureId:b,inContextDrawMatchUps:n,sourceMatchUpStatus:i,tournamentRecord:o,drawDefinition:c,matchUpsMap:p,event:m}):{error:Le},stack:"assignLoserDrawPosition"})}}({sourceMatchUpStatus:n&&c||Qi,loserMatchUpDrawPositionIndex:T,sourceMatchUpId:f,inContextDrawMatchUps:a,projectedWinningSide:i,loserDrawPosition:h,tournamentRecord:o,loserTargetLink:I,drawDefinition:s,loserMatchUp:D,winningSide:p,matchUpsMap:d,dualMatchUp:u,event:g});if(t.error)return Oi({result:t,stack:U})}if(N){const t=N.drawPositions||[],e=YI({drawPosition:Math.min(...t.filter(Boolean)),structureId:S.target.structureId,tournamentRecord:o,drawDefinition:s,event:g});if(e.error)return Oi({result:e,stack:U})}}return Oi({result:{...L,...v},stack:U})}function xg(t){const{inContextDrawMatchUps:e,targetData:n,drawDefinition:r,relevantLink:i}=t;if(i?.linkCondition===fd&&n?.matchUp?.matchUpStatus===Ki)return!1;const{targetMatchUps:{loserMatchUp:a,winnerMatchUp:o},targetLinks:s}=n,c=[Zi,ca].includes(a?.matchUpStatus),u=o?.drawPositions?.filter(Boolean).length||0;if(a?.winningSide&&!c||o?.winningSide&&2===u&&(!o.feedRound||![ca,Zi].includes(o?.matchUpStatus)))return!0;const d=a&&yl({matchUpId:a.matchUpId,inContextDrawMatchUps:e,drawDefinition:r}),p=o&&yl({matchUpId:o.matchUpId,inContextDrawMatchUps:e,drawDefinition:r}),l=d&&xg({relevantLink:s?.loserTargetLink,targetData:d,inContextDrawMatchUps:e,drawDefinition:r});return!(!(p&&xg({targetData:p,inContextDrawMatchUps:e,drawDefinition:r}))&&!l)}function _g(t){const e="attemptToSetWinningSide";let n;const{appliedPolicies:r,disableAutoCalc:i,drawDefinition:a,dualMatchUp:o,winningSide:s,structure:c,matchUp:u}=t;if(o?._disableAutoCalc&&!1!==i)return mg(t);if(u.winningSide&&u.winningSide!==s){const{connectedStructureIds:e}=lg({drawDefinition:a,structure:c,matchUp:u});e.length&&(console.log({connectedStructureIds:e}),n=!0);const r=qI(t);if(r.error)return r}const d=kg(t);if(d.error)return Oi({result:d,stack:e});let p,l;return t.qualifierChanging&&r?.[no]?.autoReplaceQualifiers&&(p=function(t){let e;const{inContextDrawMatchUps:n,inContextMatchUp:r,drawDefinition:i,winningSide:a}=t,o=t.targetData.targetLinks?.winnerTargetLink;if(o.target.feedProfile===sd){const s=r.sides.find((({sideNumber:t})=>t!==a)).participantId,c=n.find((t=>t.structureId===o.target.structureId&&t.roundNumber===o.target.roundNumber&&t.sides.some((({participantId:t})=>t===s))));if(c?.matchUpStatus===sa&&!xg({inContextDrawMatchUps:n,drawDefinition:i,targetData:yl({matchUpId:c.matchUpId,inContextDrawMatchUps:n,drawDefinition:i})})){const{structure:n}=zd({structureId:c.structureId,drawDefinition:i}),o=Rp({structure:n}).positionAssignments;for(const c of o||[])if(c.participantId===s){const s=r.sides.find((({sideNumber:t})=>t===a)).participantId;if(c.participantId=s,n?.positionAssignments)n.positionAssignments=o;else if(n?.structures){const t=Object.assign({},...(o||[]).map((t=>({[t.drawPosition]:t.participantId}))));for(const e of n.structures)e.positionAssignments?.forEach((e=>e.participantId=t[e.drawPosition]))}ol({tournamentId:t.tournamentRecord?.tournamentId,event:t.event,drawDefinition:i,structure:n}),e=!0}}}return{...L,qualifierReplaced:e}}(t).qualifierReplaced),t.qualifierAdvancing&&r?.[no]?.autoPlaceQualifiers&&(l=function(t){let e;const{inContextDrawMatchUps:n,inContextMatchUp:r,drawDefinition:i,winningSide:a}=t,o=t.targetData.targetLinks?.winnerTargetLink;if(o.target.feedProfile===sd){const s=r.sides.find((({sideNumber:t})=>t===a))?.participantId,c=A(n.filter((t=>t.structureId===o.target.structureId&&t.roundNumber===o.target.roundNumber&&t.sides.some((({participantId:t,qualifier:e})=>e&&!t)))));if(c?.matchUpStatus===sa&&!xg({inContextDrawMatchUps:n,drawDefinition:i,targetData:yl({matchUpId:c.matchUpId,inContextDrawMatchUps:n,drawDefinition:i})})){const n=c.sides.find((t=>t.qualifier&&!t.participantId))?.drawPosition,{structure:r}=zd({structureId:c.structureId,drawDefinition:i});if(!r)return{error:Dt};const a=Rp({structure:r}).positionAssignments;for(const o of a||[])if(o.drawPosition===n&&!o.participantId){if(o.participantId=s,r.positionAssignments)r.positionAssignments=a;else if(r.structures){const t=Object.assign({},...(a||[]).map((t=>({[t.drawPosition]:t.participantId}))));for(const e of r.structures)e.positionAssignments?.forEach((e=>e.participantId=t[e.drawPosition]))}ol({tournamentId:t.tournamentRecord?.tournamentId,event:t.event,drawDefinition:i,structure:r}),e=!0}}}return{...L,qualifierPlaced:e}}(t).qualifierPlaced),Oi({result:di({...L,...d,connectedStructures:n,qualifierReplaced:p,qualifierPlaced:l}),stack:e})}const Lg={drawPositionToRemove:"green",iteration:"brightred",winner:"green",loser:"brightred"};function Bg(t){const{inContextDrawMatchUps:e,appliedPolicies:n,drawDefinition:r,matchUpsMap:i,targetData:a,matchUp:o}=t;let{iteration:s=0}=t;s+=1;const c="removeDoubleExit";Vf({method:c,color:"brightyellow",iteration:s,keyColors:Lg});const{targetLinks:{loserTargetLink:u},targetMatchUps:{loserMatchUp:d,winnerMatchUp:p,loserTargetDrawPosition:l}}=a;if(p&&p.matchUpStatus!==Ki){const{stage:e,roundNumber:n,roundPosition:r}=p;Vf({winner:"winner",stage:e,roundNumber:n,roundPosition:r,keyColors:Lg}),Vg({...t,targetMatchUp:p,sourceMatchUp:o,iteration:s})}if(d&&d.matchUpStatus!==Ki){const a=e.find((({matchUpId:t})=>t===d.matchUpId)),{structure:o}=zd({drawDefinition:r,structureId:a.structureId}),{stage:p,roundNumber:m,roundPosition:f,feedRound:h}=d;if(Vf({loser:"loser",stage:p,roundNumber:m,roundPosition:f,keyColors:Lg,feedRound:h}),n?.progression?.doubleExitPropagateBye)WI({drawPosition:l,targetLink:u,inContextDrawMatchUps:e,drawDefinition:r,matchUpsMap:i});else{const e=Vg({...t,structure:o,targetMatchUp:d,iteration:s});if(e.error)return Oi({result:e,stack:c})}}return Oi({result:{...L},stack:c})}function Vg(t){const{inContextDrawMatchUps:e,appliedPolicies:n,drawDefinition:r,sourceMatchUp:i,targetMatchUp:a,matchUpsMap:o,structure:s,iteration:c}=t,u="conditionallyRemoveDrawPosition";Vf({method:u});const d=yl({matchUpId:a.matchUpId,inContextDrawMatchUps:e,drawDefinition:r}),{targetMatchUps:{winnerMatchUp:p}}=d,l=o?.drawMatchUps.find((t=>t.matchUpId===a.matchUpId));let m,f,h,I=[];if(a.feedRound){const t=p?.drawPositions?.filter(Boolean);h=t?.find((t=>a.drawPositions.includes(t)))}else if(i){f=FI({structureId:s.structureId,matchUp:i,matchUpsMap:o})?.pairedPreviousMatchUp,m=[ea,ta].includes(f?.matchUpStatus),I=f?.drawPositions?.filter(Boolean)||[];if([...fa,Ki].includes(f?.matchUpStatus)||f?.winningSide){const t=i.drawPositions||[];let e=a.drawPositions?.filter(Boolean);k(t,e)&&(e=e?.filter((e=>!t.includes(e))));h=t.concat(I).find((t=>e?.includes(t)))}}else h=O(a?.drawPositions||[],p?.drawPositions||[])?.[0];if(p&&h){const{stage:t,roundNumber:n,roundPosition:i}=p;Vf({method:"removeDirectedWinner",drawPositionToRemove:h,keyColors:Lg,color:"brightgreen",stage:t,roundNumber:n,roundPosition:i}),$I({winningDrawPosition:h,winnerMatchUp:p,inContextDrawMatchUps:e,drawDefinition:r,matchUpsMap:o})}let g=Bg({targetData:d,matchUp:a,inContextDrawMatchUps:e,appliedPolicies:n,drawDefinition:r,matchUpsMap:o,structure:s,iteration:c});if(g.error)return Oi({result:g,stack:u});const U=function({pairedPreviousDoubleExit:t,noContextTargetMatchUp:e}){return e.matchUpStatus===Ki?Ki:t?[ta,Zi].includes(e?.matchUpStatus)?Zi:ca:sa}({pairedPreviousDoubleExit:m,noContextTargetMatchUp:l}),y=!m;return g=Rl({...t,matchUpStatus:U,removeScore:y,score:{scoreStringSide1:"",scoreStringSide2:"",sets:void 0},removeWinningSide:!0,matchUp:l,matchUpId:a.matchUpId,matchUpStatusCodes:[]}),g.error?Oi({result:g,stack:u}):{...L}}function jg(t){const{matchUp:e,matchUpStatus:n,score:r,winningSide:i}=t,a="noDownStreamDependencies";if([ea,ta].includes(e?.matchUpStatus)&&![ea,ta].includes(n)){const e=Bg(t);if(e.error)return Oi({result:e,stack:a})}const o=n===ea,s=Yp({score:r})&&!o&&(t.isCollectionMatchUp&&!t.projectedWinningSide||!i),c=t?.inContextMatchUp?.collectionId&&function(t){const{matchUpFormat:e,score:n}=t,r=n?.sets?.length,i=e&&Ii(e),{setFormat:a,finalSetFormat:o,bestOf:s}=i||{},c=s&&r===s&&o||a;return c?.timed||!1}(t.inContextMatchUp),u=t.removeScore||!c&&![ra,zi].includes(n||ra),d=t.isCollectionMatchUp&&t.dualMatchUp.winningSide&&!t.projectedWinningSide||e.winningSide&&!i&&!Yp({score:r}),p=n&&n!==sa,l=n=>{let r;const{structure:i,drawDefinition:a,dualMatchUp:o,disableAutoCalc:s}=t;if(o?._disableAutoCalc&&!1!==s)return mg(t);const{connectedStructureIds:c}=lg({drawDefinition:a,structure:i,matchUp:e});c.length&&(console.log({connectedStructureIds:c}),r=!0),Object.assign(t,{removeScore:n});const u=qI(t);if(u.error)return u;if(t.removingQualifier&&t.appliedPolicies?.[no]?.autoRemoveQualifiers){const e=function(t){let e;const{inContextDrawMatchUps:n,inContextMatchUp:r,drawDefinition:i}=t,a=t.targetData.targetLinks?.winnerTargetLink;if(a.target.feedProfile===sd){const o=r.sides?.find((({sideNumber:t})=>t===r.winningSide))?.participantId,s=n.find((t=>t.structureId===a.target.structureId&&t.roundNumber===a.target.roundNumber&&t.sides?.some((({participantId:t})=>t===o))));if(s?.matchUpStatus===sa&&!xg({inContextDrawMatchUps:n,drawDefinition:i,targetData:yl({matchUpId:s.matchUpId,inContextDrawMatchUps:n,drawDefinition:i})})){const{structure:n}=zd({structureId:s.structureId,drawDefinition:i}),r=Rp({structure:n}).positionAssignments;for(const a of r||[])if(a.participantId===o){if(a.participantId=void 0,n?.positionAssignments)n.positionAssignments=r;else if(n?.structures){const t=Object.assign({},...(r||[]).map((t=>({[t.drawPosition]:t.participantId}))));for(const e of n?.structures||[])e.positionAssignments?.forEach((e=>e.participantId=t[e.drawPosition]))}ol({tournamentId:t.tournamentRecord?.tournamentId,event:t.event,drawDefinition:i,structure:n}),e=!0}}}return{qualifierRemoved:e}}(t);return{...L,connectedStructures:r,...e}}return{...L,connectedStructures:r}};if(d&&i&&t.isCollectionMatchUp)return Gg(t);const m=[Ji,zi].includes(n)&&t.dualWinningSideChange;return Oi({result:(i||m)&&_g(t)||s&&l(u)||p&&og(t)||d&&l(u)||e&&Gg({...t,removeScore:!0})||{...L},stack:a})}function Gg(t){if(t.isCollectionMatchUp&&t.dualMatchUp?.winningSide&&!t.projectedWinningSide){const e=qI(t);if(e.error)return e}const e=Rl({...t});if(t.isCollectionMatchUp){const{matchUpTieId:e,drawDefinition:n,event:r,matchUpsMap:i}=t,{removeWinningSide:a}=bl({tournamentRecord:t.tournamentRecord,matchUpId:e,drawDefinition:n,matchUpsMap:i,event:r});a&&console.log("REMOVE WINNING SIDE")}return Oi({result:e,stack:"scoreModification"})}function qg(t){const e="setMatchUpStatus";t.matchUpStatus&&[ca,ea].includes(t.matchUpStatus)&&(t.score=void 0);const{allowChangePropagation:n,disableScoreValidation:r,tournamentRecords:i,tournamentRecord:a,disableAutoCalc:o,enableAutoCalc:s,drawDefinition:c,matchUpStatus:u,winningSide:d,matchUpId:p,event:l,score:m}=t;if(!c)return{error:Y};if(u&&[Ji,ra,zi,sa].includes(u)&&d)return{error:xn,winningSide:d,matchUpStatus:u};if(![void 0,...pa].includes(u))return Oi({result:{error:$t},info:"matchUpStatus does not exist",stack:"setMatchUpStatus"});const f=wp({drawDefinition:c}),{matchUps:h}=Pl({nextMatchUps:!0,inContext:!0,drawDefinition:c,matchUpsMap:f,event:l}),I=f.drawMatchUps.find((t=>t.matchUpId===p)),g=h?.find((t=>t.matchUpId===p));if(!I||!h)return{error:Xt};if((I.winningSide||d)&&u===Ki)return{context:"Cannot have Bye with winningSide",error:qt,matchUpStatus:u};const U=g?.structureId,{structure:y}=zd({drawDefinition:c,structureId:U}),S=g?.drawPositions?.filter(Boolean);let v;if(I.matchUpType===Ca)if(o)Bs({extension:{name:So,value:!0},element:I});else if(s){const e=I.winningSide;Gs({name:So,element:I});const{winningSide:n,scoreStringSide1:r,scoreStringSide2:i,set:a}=Hp({drawDefinition:c,matchUpsMap:f,structure:y,matchUp:I,event:l}),o={scoreStringSide1:r,scoreStringSide2:i,sets:a?[a]:[]};v=n!==e,Object.assign(t,{winningSide:n,dualWinningSideChange:v,projectedWinningSide:n,score:o})}if(I.matchUpType===Ca&&u&&[Yi].includes(u))return{error:xn,info:"Not supported for matchUpType: TEAM"};const w=g?.matchUpTieId,T=yl({matchUpId:w||p,inContextDrawMatchUps:h,drawDefinition:c});if(m&&I.matchUpType!==Ca&&!r){const t=I.matchUpFormat??y?.matchUpFormat??c?.matchUpFormat??l?.matchUpFormat,e=El({existingMatchUpStatus:I.matchUpStatus,matchUpFormat:t,matchUpStatus:u,winningSide:d,score:m});if(e.error)return e}const P=I?.sides?[]:Rp({drawDefinition:c,structureId:U}).positionAssignments,D=2===I.sides?.map((t=>t.participantId)).filter(Boolean).length||2===S?.length&&P?.filter((t=>S.includes(t.drawPosition))).every((t=>t.participantId));if(u&&da.includes(u)&&!D)return Oi({info:"present in participantRequiredMatchUpStatuses",context:{matchUpStatus:u,bothSideParticipants:D},result:{error:$t}});const N=Vo({policyTypes:[no],tournamentRecord:a,drawDefinition:c,event:l})?.appliedPolicies??{};"object"==typeof t.policyDefinitions&&Object.assign(N,t.policyDefinitions);const R=g?.stage===zu&&1===g.finishingRound,b=R&&d,M=R&&I.winningSide&&!d&&(!t.matchUpStatus||t.matchUpStatus&&Jp({matchUpStatus:t.matchUpStatus}))&&(!t.outcome||!Yp({outcome:t.outcome})),A=b&&d!==I.winningSide&&I.winningSide;if(Object.assign(t,{inContextDrawMatchUps:h,qualifierAdvancing:b,qualifierChanging:A,removingQualifier:M,inContextMatchUp:g,appliedPolicies:N,matchUpTieId:w,matchUpsMap:f,targetData:T,structure:y,matchUp:I}),w){const{matchUp:e}=$p({matchUpId:w,inContext:!0,drawDefinition:c,matchUpsMap:f,event:l});if(e){const n=Ri({matchUp:e,drawDefinition:c,structure:y,event:l})?.tieFormat,{projectedWinningSide:r}=function({drawDefinition:t,matchUpStatus:e,matchUpsMap:n,winningSide:r,dualMatchUp:i,tieFormat:a,structure:o,matchUp:s,event:c,score:u}){const d=ri(i,void 0,!0);for(const l of d?.tieMatchUps||[])l.matchUpId===s.matchUpId&&(l.winningSide=r,l.score=u,Yp({score:u})||e?e&&(l.matchUpStatus=e):Object.assign(l,{...Nl}));a=a||Ri({matchUp:s,structure:o,drawDefinition:t,event:c})?.tieFormat;const{winningSide:p}=Hp({matchUp:d,drawDefinition:t,matchUpsMap:n,structure:o,tieFormat:a,event:c});return{projectedWinningSide:p}}({drawDefinition:c,matchUpStatus:u,dualMatchUp:e,matchUpsMap:f,winningSide:d,tieFormat:n,structure:y,matchUp:I,event:l,score:m});v=r!==e.winningSide,Object.assign(t,{isCollectionMatchUp:!0,dualWinningSideChange:v,projectedWinningSide:r,matchUpTieId:w,dualMatchUp:e,tieFormat:n})}}const E=xg(t),C=Kp({matchUpStatus:u});if(!w){if(E&&!d&&(u&&Jp({matchUpStatus:u})||u&&[ea,ta].includes(u)))return{error:qt,activeDownstream:E,winningSide:d};if(d&&d===I.winningSide&&u&&!C)return{context:"winningSide must include directing matchUpStatus",error:qt,directingMatchUpStatus:C,matchUpStatus:u}}const{schedule:O}=t;if(O){const t=SI({disableNotice:!0,tournamentRecords:i,tournamentRecord:a,drawDefinition:c,matchUpId:p,schedule:O});if(t.error)return t}const F=I.matchUpType!==Ca&&!v&&d&&I.winningSide&&I.winningSide!==d;if(n&&F&&I.roundPosition)return function(t){const{tournamentRecord:e,inContextMatchUp:n,structure:r,drawDefinition:i}=t,a=n.roundNumber,o=n.sides.find((t=>t.sideNumber===n.winningSide)),s=n.sides.find((t=>t.sideNumber!==n.winningSide)),{drawPosition:c,participantId:u}=o,{drawPosition:d,participantId:p}=s,{matchUps:l}=qp(t),m=l.filter((({drawPositions:t,roundNumber:e})=>t?.includes(c)&&e>a));ir({changeWinner:!0})&&console.log({existingWinnerSubsequentMatchUps:m}),m.forEach((n=>{n.drawPositions=n.drawPositions?.map((t=>t===c?d:t))||[],nl({tournamentId:e?.tournamentId,eventId:t.event?.eventId,context:"swapWinnerLoser",drawDefinition:i,matchUp:n})}));const{stage:f,stageSequence:h}=r,I=i.structures.filter((({stage:t,stageSequence:e})=>t===f&&e>h)).map((({structureId:t})=>t)),{targetLinks:{loserTargetLink:g,winnerTargetLink:U}}=t.targetData,y=[g?.target.structureId,U?.target?.structureId].filter(Boolean);return i.structures.filter((({stage:t,structureId:e})=>t!==f&&y.includes(e))).forEach((({stage:t,stageSequence:e,structureId:n})=>{I.includes(n)||I.push(n),i.structures.filter((({stage:n,stageSequence:r})=>n===t&&r>e)).forEach((({structureId:t})=>{I.includes(t)||I.push(t)}))})),i.structures.filter((({structureId:t})=>I.includes(t))).forEach((t=>{const{positionAssignments:e}=Rp({structure:t}),n=e?.find((({participantId:t})=>t===u)),r=e?.find((({participantId:t})=>t===p));n&&(n.participantId=p),r&&(r.participantId=u)})),Rl(t)}(t);const k=d&&!w||t.projectedWinningSide;Vf({method:e,activeDownstream:E,matchUpWinner:k,winningSide:d});const x=!E&&jg(t)||k&&function(t){const{matchUp:e,winningSide:n,matchUpTieId:r,dualWinningSideChange:i}=t;return n===e.winningSide||r&&!i?$g(t):Oi({stack:"winningSideWithDownstreamDependencies",result:{error:Me},context:{winningSide:n,matchUp:e}})}(t)||C&&$g(t)||{error:Bn};return Oi({result:x,stack:e})}function $g(t){const{tournamentRecord:e,matchUp:n,event:r}=t,i=t.isCollectionMatchUp&&n.winningSide&&!t.winningSide&&!Yp({score:t.score}),a=t.isCollectionMatchUp?t.matchUpStatus||i&&sa||Qi:t.matchUpStatus||Qi,o=t.removeScore||[Ji,ca].includes(a)&&![ra,zi].includes(a),s=Rl({...t,matchUpStatus:a,removeWinningSide:i,removeScore:o});if(s.error)return s;if(t.isCollectionMatchUp){const{matchUpTieId:n,drawDefinition:i,matchUpsMap:a}=t,o=bl({matchUpId:n,tournamentRecord:e,drawDefinition:i,matchUpsMap:a,event:r});if(o.error)return o;Object.assign(s,{tieMatchUpResult:o})}return s}function Wg(t){let e=t.structureIds;const{tournamentRecord:n,drawDefinition:r,matchUpFormat:i,structureId:a,matchUpId:o,event:s}=t;if(!r)return{error:Y};if(!i)return{error:zt};if(!Ti(i))return{error:Gt};if(o){const t=$p({drawDefinition:r,matchUpId:o,event:s});if(t.error)return t;if(!t.matchUp)return{error:Xt};const e=t.matchUp;if(e?.matchUpType===Du)return{error:ee,info:"Cannot set matchUpFormat when { matchUpType: TEAM }"};e.matchUpFormat=i,nl({tournamentId:n?.tournamentId,eventId:s?.eventId,context:"setMatchUpFormat",drawDefinition:r,matchUp:e})}else if(Array.isArray(e)){if(s?.eventType===Du)return{error:Mt};for(const t of e){const e=zd({drawDefinition:r,structureId:t});if(e.error)return e;if(!e.structure)return{error:Dt};e.structure.matchUpFormat=i}}else if(a){if(s?.eventType===Du)return{error:Mt};const t=zd({drawDefinition:r,structureId:a});if(t.error)return t;if(!t.structure)return{error:Dt};t.structure.matchUpFormat=i}else r&&(r.matchUpFormat=i);return e=e||(a?[a]:void 0),il({drawDefinition:r,structureIds:e}),{...L}}function Hg(t){const{matchUpFormat:e,matchUpStatus:n,winningSide:r,score:i}=t;if(!i)return{sets:[]};const a=i.sets||[];let o=Ml({winnerFirst:!1,matchUpFormat:e,matchUpStatus:n,sets:a}),s=Ml({winnerFirst:!1,reversed:!0,matchUpFormat:e,matchUpStatus:n,sets:a});const c=Ml({matchUpFormat:e,matchUpStatus:n,winningSide:r,sets:a}),u=o===c?s:o;return r&&(o=1===r?c:u,s=2===r?c:u),{score:{sets:a,scoreStringSide1:o,scoreStringSide2:s}}}function zg(t){const{tournamentRecords:e,policyDefinitions:n,tournamentRecord:r,disableAutoCalc:i,enableAutoCalc:a,drawDefinition:o,matchUpFormat:s,matchUpId:c,schedule:u,event:d,notes:p}=t;if(!o)return{error:lt};if(!c)return{error:Jt};const{policy:l}=ns({policyType:oo,tournamentRecord:r,event:d}),m=void 0!==t.allowChangePropagation&&t.allowChangePropagation||void 0!==l?.allowChangePropagation&&l.allowChangePropagation||void 0,{outcome:f}=t;if(s){const t=Wg({tournamentRecord:r,drawDefinition:o,matchUpFormat:s,matchUpId:c,event:d});if(t.error)return t}if(f?.score?.sets&&!f.score.scoreStringSide1){const{score:t}=Hg(f);f.score=t,f.score.sets=f.score.sets.filter((t=>t.side1Score||t.side2Score||t.side1TiebreakScore||t.side2TiebreakScore))}return qg({matchUpStatusCodes:f?.matchUpStatusCodes,matchUpStatus:f?.matchUpStatus,winningSide:f?.winningSide,allowChangePropagation:m,score:f?.score,tournamentRecords:e,policyDefinitions:n,tournamentRecord:r,disableAutoCalc:i,enableAutoCalc:a,drawDefinition:o,matchUpFormat:s,matchUpId:c,schedule:u,event:d,notes:p})}function Yg(t){if(!t.tournamentRecord)return{error:$};const{tournamentRecords:e,tournamentRecord:n,outcomes:r,policyDefinitions:i}=t,a={};r.forEach((t=>{const{eventId:e}=t;a[e]||(a[e]=[]),a[e].push(t)}));for(const o of Object.keys(a)){const{event:t}=Ls({tournamentRecord:n,eventId:o});for(const r of a[o]){const{drawId:a}=r,o=t?.drawDefinitions?.find((t=>t.drawId===a));if(o&&a){const{matchUpFormat:s,matchUpId:c}=r,u=zg({schedule:r?.schedule,tournamentRecords:e,policyDefinitions:i,tournamentRecord:n,drawDefinition:o,matchUpFormat:s,matchUpId:c,outcome:r,drawId:a,event:t});if(u.error)return u}}}return{...L}}function Kg({courtPrefix:t="C|",minRowsCount:e,courtsData:n}){if(!Array.isArray(n))return{error:xn};const r=n?.reduce(((t,e)=>{const n=e.matchUps||[],r=Math.max(0,...n.map((t=>t.schedule.courtOrder||0)));return r>t?r:t}),1),i=E(0,e?Math.max(e,r):r).map((t=>({matchUps:E(0,n.length).map((e=>{const r=n[e],{courtId:i,venueId:a}=r;return{schedule:{courtOrder:t+1,venueId:a,courtId:i}}}))})));return n.forEach(((t,e)=>{for(const n of t.matchUps){const t=n.schedule?.courtOrder;t&&(i[t-1].matchUps[e]=n)}})),{courtPrefix:t,rows:i.map(((e,n)=>Object.assign({rowId:`rowId-${n+1}`},...e.matchUps.map(((e,n)=>({[`${t}${n}`]:e}))))))}}function Jg(t){const{flight:e,suppressNotifications:n,modifyEventEntries:r,existingDrawCount:i,allowReplacement:a,checkEntryStatus:o,tournamentRecord:s,drawDefinition:c,event:u}=t;if(!c)return{error:lt};if(!u)return{error:At};u.drawDefinitions||(u.drawDefinitions=[]);const{drawId:d,drawName:p,entries:l}=c,{entries:f}=u;let h=0;if(void 0!==i&&i!==u.drawDefinitions.length)return{error:xn,info:"drawDefintions count mismatch"};const{flightProfile:I}=_s({event:u}),g=e&&I?.flights?.find((t=>t.flightNumber===e.flightNumber)),U=I?.links?.find((t=>t?.target?.drawId===d))?.source?.drawId;if(U&&!u.drawDefinitions.find((t=>t.drawId===U)))return Oi({result:{error:Y},info:{sourceDrawId:U}});if(g&&g.drawId!==c.drawId)return Oi({result:{error:z},info:{relevantFlight:g}});const y=l?.every((({participantId:t,entryStatus:e})=>{const n=g?.drawEntries.find((e=>e.participantId===t));return!e||n?.entryStatus===e})),S=!o||f&&l?.every((({participantId:t,entryStatus:e,entryStage:n})=>{const r=f.find((e=>e.participantId===t&&(!e.entryStage||e.entryStage===n)));return r?.entryStatus===e}));if(g&&!y)return Oi({result:{error:z},context:{drawEntriesPresentInFlight:y,matchingEventEntries:S,relevantFlight:g},info:"Draw entries are not present in flight or do not match entryStatuses"});if(r&&l?.filter(Boolean).forEach((t=>{if(t?.entryStatus&&lp.includes(t?.entryStatus)){const e=f?.filter(Boolean).find((e=>e.participantId===t.participantId));e&&t.entryStatus&&e?.entryStatus!==t.entryStatus&&(e.entryStatus=t.entryStatus,h+=1)}})),f&&!S)return Oi({result:{info:"Draw entries do not match event entryStatuses",context:{matchingEventEntries:S,eventEntries:f},error:z}});const v=I?.flights?.map((({flightNumber:t})=>!isNaN(t)&&m(t)))?.filter(Boolean)||[],w=u.drawDefinitions.map((({drawOrder:t})=>t&&m(t)))?.filter(Boolean)||[];let T=Math.max(0,...w,...v)+1;const P=I?.flights?.find((t=>t.drawId===d));let D;if(P){P.drawName=c.drawName,D={name:To,value:{...I,flights:I.flights}};const t=P.flightNumber;t&&!w.includes(t)?T=t:P.flightNumber=T}else{const t=I?.flights||[];t.push({manuallyAdded:!0,flightNumber:T,drawEntries:l,drawName:p,drawId:d}),D={name:To,value:{...I||{},flights:t}}}Ws({event:u,extension:D}),Object.assign(c,{drawOrder:T});const N=u.drawDefinitions.find((t=>t.drawId===d)),R=s?.tournamentId,b=u.eventId;if(N){if(!a)return{error:mt};const t=eh({drawDefinition:N})?.matchUps,e=t?.map(hl)??[],r=eh({drawDefinition:c})?.matchUps;if(!n){e?.length&&el({matchUpIds:e,action:"modifyDrawDefinition",tournamentId:R,eventId:b}),r?.length&&tl({matchUps:r,tournamentId:R,eventId:b}),u.drawDefinitions=u.drawDefinitions.map((t=>t.drawId===d?c:t));const t=c.structures?.map((({structureId:t})=>t));il({drawDefinition:c,tournamentId:R,structureIds:t,eventId:b})}}else if(u.drawDefinitions.push(c),!n){const{matchUps:t}=eh({drawDefinition:c,event:u});t&&tl({tournamentId:s?.tournamentId,matchUps:t}),rl({drawDefinition:c,tournamentId:R,eventId:b})}return{...L,modifiedEventEntryStatusCount:h}}function Qg({allowDuplicateParticipantIdPairs:t,returnParticipant:e,tournamentRecord:n,disableNotice:r,pairOverride:i,participant:a}){const o="addParticipant";if(!n)return{error:$};if(!a)return Oi({result:{error:xe},stack:o});a.participantId||(a.participantId=hi()),n.participants||(n.participants=[]);const{participantId:s,individualParticipantIds:c}=a;if(n.participants.reduce(((t,e)=>e.participantId===s||t),!1))return{error:Ve};const{participantType:u,participantRole:d}=a;if(!u||!Object.keys(Lu).includes(u))return{error:Fe,participantType:u};if(!d)return{error:ke};const p=n.participants||[],l=p.filter((t=>t.participantType===Eu)).map((t=>t.participantId));if(u!==Eu&&a.person)return{error:xn,person:a.person};if(c&&!Array.isArray(c))return{error:xn,individualParticipantIds:c};if(u===Ou){if(a.person)return{error:xn,person:a.person};if(!a.individualParticipantIds)return Oi({result:{error:Ge},stack:o});if(2!==a.individualParticipantIds.length&&!i)return Oi({info:"PAIR must be 2 individualParticipantIds",result:{error:Ce},stack:o});{const t=p.filter((t=>t.participantType===Eu)).map((t=>t.participantId));if(!Array.isArray(a.individualParticipantIds))return Oi({result:{error:Ce},stack:o});if(!a.individualParticipantIds.reduce(((e,n)=>t.includes(n)&&e),!0))return Oi({result:{error:Ce},stack:o})}const n=p.filter((t=>t.participantType===Ou)).map((t=>({individualParticipantIds:t.individualParticipantIds,participant:t}))),r=a.participantType===Ou&&n.find((t=>2===O(t.individualParticipantIds,a.individualParticipantIds).length));if(r&&!t)return{...L,existingParticipant:!0,participant:e&&ri(r.participant)};if(!a.participantName){const t=p.filter((t=>a.individualParticipantIds?.includes(t.participantId)));let e=t.map((t=>t.person?.standardFamilyName)).filter(Boolean).join("/");1===t.length&&(e+="/Unknown"),a.participantName=e}}else if(u===Eu){if(!a.person?.standardFamilyName||!a.person?.standardGivenName)return{error:He};if(!a.participantName){const t=`${a.person.standardFamilyName.toUpperCase()}, ${a.person.standardGivenName}`;a.participantName=t}}else{if(!u||![Fu,Cu].includes(u))return{error:Fe};if(c||(a.individualParticipantIds=[]),a.individualParticipantIds?.length)for(const t of a.individualParticipantIds){if("string"!=typeof t)return Oi({result:{participantId:t,error:xn},stack:o});if(!l.includes(t))return Oi({result:{participantId:t,error:Be},stack:o})}}n.participants.push(a),r||dr({payload:{tournamentId:n.tournamentId,participants:[a]},topic:ic});return di({participant:e&&ri(a),...L})}function Xg({allowDuplicateParticipantIdPairs:t,returnParticipants:e,participants:n,tournamentRecord:r}){if(!r)return{error:$};r.participants||(r.participants=[]);const i=r.participants.map((t=>t.participantId))||[];n.forEach((t=>{t.participantId||(t.participantId=hi())}));const a=n.filter((t=>!i.includes(t.participantId))),o=n.filter((t=>i.includes(t.participantId))),s=a.filter((t=>t.participantType===Eu)),c=a.filter((t=>t.participantType!==Eu)),u=s.concat(...c),d=[];if(u.length){for(const e of u){const n=Qg({allowDuplicateParticipantIdPairs:t,returnParticipant:!0,disableNotice:!0,tournamentRecord:r,participant:e});if(n.error)return n;n.success&&!n.existingParticipant&&d.push(n.participant)}d.length&&dr({topic:ic,payload:{tournamentId:r.tournamentId,participants:d}});const n={participants:e&&ri(d),addedCount:d.length,...L};return o.length&&Object.assign(n,{notAdded:o,info:Ye}),di(n)}return{info:"No new participants to add",addedCount:0,...L}}function Zg({event:t}){const e=`${ou}.${cu}`,{timeItem:n}=$f({element:t,itemType:e});if(n?.itemValue?.PUBLIC){const{drawIds:t=[],seeding:e}=n.itemValue.PUBLIC||{},r={published:void 0,seedingScaleNames:[],drawIds:[]};return e&&Object.assign(r,n.itemValue.PUBLIC.seeding),{publishedDrawIds:t,publishedSeeding:r}}}function tU({publishedSeeding:t,usePublishState:e,withSeeding:n,participant:r,event:i}){const a={},o=t=>[ds,ps,i.eventType,t].join("."),s=Object.assign({},...(r.timeItems||[]).filter((({itemType:t})=>t.split(".")[1]===ps)).map((({itemType:t,itemValue:e})=>({[t]:e})))),c=(t?.stageSeedingScaleNames&&Object.values(t?.stageSeedingScaleNames)||Array.isArray(t?.seedingScaleNames)&&t.seedingScaleNames||[]).map(o),u=O(Object.keys(s),c);if(!(e&&(Object.keys(s).length||t?.drawIds?.length)&&!u.length)&&u.length){if(t?.stageSeedingScaleNames){const e=Object.keys(t.stageSeedingScaleNames).map((e=>{const n=o(t.stageSeedingScaleNames[e]);return[e,s[n]]})).filter((t=>t[1])).map((t=>({[t[0]]:{seedValue:t[1]}}))),n=Object.assign({},...e);a.seedAssignments=n}else if(u){const t=u.map((t=>s[t]));a.seedValue=t.pop()}}else if(e||"object"!=typeof n){const{categoryName:n,ageCategoryCode:o}=i.category||{};let s;for(const t of[o,i.eventId,n]){const e=yh({scaleAttributes:{eventType:i.eventType,scaleType:ps,scaleName:t},participant:r});if(e.scaleItem){s=e.scaleItem;break}}if(s){if(!e||t?.published&&!t?.published?.drawIds?.length){const t=s.scaleValue;a.seedValue=t}}}else{const t=Object.keys(n).map((t=>{const e=o(n[t]);return[t,s[e]]})).filter((t=>t[1])).map((t=>({[t[0]]:{seedValue:t[1]}}))),e=Object.assign({},...t);a.seedAssignments=e}return a}function eU({extensionConversions:t,seedAssignments:e,participant:n,withSeeding:r,seedValue:i,eventId:a,ranking:o,entry:s}){const{entryStatus:c,entryStage:u,entryPosition:d,extensions:p}=s,l=p?.length?Object.assign({},...ii(p)):{},m=Object.assign(l,{...t,entryPosition:d,entryStatus:c,entryStage:u,ranking:o,eventId:a});n.events[a]=di(m,!1,!1,!0),r&&(e&&(n.events[a].seedAssignments=e),i&&(n.events[a].seedValue=i))}function nU(t){const{participantMap:e,participantId:n,matchUpStatus:r,roundPosition:i,structureId:a,matchUpType:o,roundNumber:s,matchUpId:c,potential:u,schedule:d,drawId:p,score:l}=t;if(!d||!Object.keys(d).length)return;r===Ki||e[n].scheduleItems.push({...d,scheduledDate:$r(d?.scheduledDate),scheduledTime:qr(d?.scheduledTime),scoreHasValue:Yp({score:l}),matchUpStatus:r,roundPosition:i,structureId:a,matchUpType:o,roundNumber:s,matchUpId:c,potential:u,drawId:p})}function rU({finishingPositionRange:t={},participantMap:e,finishingRound:n,participantWon:r,matchUpStatus:i,participantId:a,stageSequence:o,roundNumber:s,structureId:c,matchUpId:u,drawId:d,stage:p}){const l=e[a],m=t=>Math.abs(t[0]-t[1]);l.structureParticipation[c]||(l.structureParticipation[c]={rankingStage:p,walkoverWinCount:0,defaultWinCount:0,stageSequence:o,winCount:0,structureId:c,drawId:d});const f=l.structureParticipation[c],{winner:h,loser:I}=t,g=r?h:I;r&&(f.winCount+=1,i===ca&&(f.walkoverWinCount+=1),i===Zi&&(f.defaultWinCount+=1)),g&&(!f.finishingPositionRange||m(g)<m(f.finishingPositionRange))&&(f.finishingPositionRange=g),n&&((!f.finishingRound||n<f.finishingRound)&&(f.finishingMatchUpId=u,f.finishingRound=n,f.roundNumber=s),1===n&&(f.participantWon=r))}function iU(t){const{withScheduleItems:e,scheduleAnalysis:n,withTeamMatchUps:r,participantMap:i,withOpponents:a,withMatchUps:o,withEvents:s,withDraws:c,finishingPositionRange:u,finishingRound:d,matchUpStatus:p,stageSequence:l,roundNumber:m,structureId:f,score:h,stage:I,withRankingProfile:g,tieWinningSide:U,roundPosition:y,matchUpTieId:S,matchUpSides:v,collectionId:w,matchUpType:T,winningSide:P,matchUpId:D,schedule:N,eventId:R,drawId:b,sides:M}=t,A=a&&2===M?.length&&Object.assign({},...M.map((({sideNumber:t},e)=>{const n=M[1-e].participantId;return t&&{[t]:n}})).filter(Boolean));for(const E of M){const{participantId:t,sideNumber:M,bye:C}=E;if(C)continue;const O=P===M,F=t=>{const e=i[t]?.participant,n=e?.participantType,r=[{participantId:t,participantType:n}];if(n!==ku)for(const a of e?.individualParticipantIds||[]){const t=i[a]?.participant;r.push({participantType:t?.participantType,participantId:a})}return r},k=(t,r)=>{if(o){if(i[t].matchUps[D]={participantWon:O,matchUpType:T,structureId:f,sideNumber:M,matchUpId:D,eventId:R,drawId:b,stage:I},a){const e=F(r);i[t].matchUps[D].opponentParticipantInfo=e}w&&(i[t].matchUps[D].collectionId=w)}a&&r&&(i[t].opponents[r]={participantId:r,matchUpId:D,eventId:R,drawId:b}),g&&rU({finishingPositionRange:u,participantMap:i,participantWon:O,finishingRound:d,matchUpStatus:p,participantId:t,stageSequence:l,roundNumber:m,structureId:f,matchUpId:D,drawId:b,stage:I}),(n||e)&&nU({participantMap:i,participantId:t,matchUpStatus:p,roundPosition:y,matchUpType:T,roundNumber:m,structureId:f,matchUpId:D,schedule:N,drawId:b,score:h})},x=({participant:t,partnerParticipantId:e})=>{const n=(t,e)=>{t&&(t.partnerParticipantIds||(t.partnerParticipantIds=[]),t.partnerParticipantIds.includes(e)||t.partnerParticipantIds.push(e))};c&&n(t?.draws?.[b],e),s&&n(t?.events?.[R],e),o&&n(t?.matchUps?.[D],e)};if(t&&i[t]){const e=A?.[M];k(t,e);const n=i[t]?.participant.participantType===Ou,a=i[t]?.participant.individualParticipantIds||[];if(S){if(r){const e=t=>i[t].matchUps[S]={participantWon:U===M,matchUpType:Bi.Team,matchUpId:S,sideNumber:M};e(t),a.forEach(e)}if(c&&!i[t].draws[b]){const e=v.find((t=>t.sideNumber===M))?.participant?.participantId,n=i[e]?.draws?.[b]?.entryStatus,r=t=>i[t].draws[b]={entryStatus:n,eventId:R,drawId:b};r(t),a.forEach(r)}}if(n&&(a.forEach((t=>i[t]&&k(t,e))),a.forEach(((t,e)=>{const n=a[1-e],r=i[t];r&&x({participant:r,partnerParticipantId:n})})),s&&v)){const e=v.find((t=>t.sideNumber===M))?.participant?.participantId;if(e){const n=i[e]?.events[R];n?(i[t].events[R]={...n},a.forEach((t=>i[t].events[R]={...n}))):console.log("Missing teamEntry",{eventId:R,teamParticipantId:e})}}if(P){const e=t=>{O?(i[t].counters[T].wins+=1,i[t].counters.wins+=1,p===ca&&(i[t].counters[T].walkoverWins+=1,i[t].counters.walkoverWins+=1),p===Zi&&(i[t].counters[T].defaultWins+=1,i[t].counters.defaultWins+=1)):(i[t].counters[T].losses+=1,i[t].counters.losses+=1,p===ca&&(i[t].counters[T].walkovers+=1,i[t].counters.walkovers+=1),p===Zi&&(i[t].counters[T].defaults+=1,i[t].counters.defaults+=1))};e(t),a.forEach(e)}}}}function aU({participantFilters:t={},tournamentRecord:e,participants:n=[]}){if(!Object.keys(t).length)return n;const{accessorValues:r,drawEntryStatuses:i,positionedParticipants:a,eventEntryStatuses:o,participantRoles:s,participantRoleResponsibilities:c,participantTypes:u,participantIds:d,signInStatus:p,enableOrFiltering:l,eventIds:m,genders:f}=t,h=oU(m)&&e?.events?.filter((t=>m?.includes(t.eventId)))||e?.events||[],I=i&&function({drawEntryStatuses:t,tournamentEvents:e}){const n=({entryStatus:e})=>!Array.isArray(t)||t.includes(e);return T(e.reduce(((t,e)=>{const{flightProfile:r}=_s({event:e}),i=r?.flights?.map((({drawEntries:t})=>Array.isArray(t)?t.filter(n).map(ml):[])).flat()||[],a=e.drawDefinitions?.map((({entries:t})=>t?t.filter(n).map(ml):[]))||[];return t.concat(...i,...a)}),[]))}({drawEntryStatuses:i,tournamentEvents:h}),g=o&&function({eventEntryStatuses:t,tournamentEvents:e}){return T(e.reduce(((e,n)=>{const r=(n.entries||[]).filter((({entryStatus:e})=>!Array.isArray(t)||t.includes(e))).map(ml);return e.concat(...r)}),[]))}({eventEntryStatuses:o,tournamentEvents:h}),U=void 0!==a&&[!0,!1].includes(a)&&h.reduce(((t,e)=>t.concat(...(e.drawDefinitions||[]).map((t=>Np({drawDefinition:t}).allPositionedParticipantIds)).filter(Boolean))),[]),y=t=>r?.reduce(((e,n)=>{const{accessor:r,value:i}=n,{values:a}=ai({element:t,accessor:r});return e&&a?.includes(i)}),!0);if(n=n?.filter((t=>{const e=$f({element:t,itemType:Au})?.timeItem?.itemValue,{participantRoleResponsibilities:n,participantType:i,participantRole:o,participantId:m,person:h}=t,S=Array.isArray(f)&&f?.length&&h?.sex&&f.includes(h.sex);return l?f&&S||a&&U.includes(m)||!1===a&&!U.includes(m)||I?.includes(m)||g?.includes(m)||d?.includes(m)||p&&e===p||u&&i&&oU(u)&&u.includes(i)||s&&o&&oU(s)&&s.includes(o)||c&&oU(n)&&oU(c)&&c.find((t=>n?.includes(t)))||r?.length&&oU(r)&&y(t):(!f||S)&&(void 0===a||a&&U.includes(m)||!1===a&&!U.includes(m))&&(!I||I.includes(m))&&(!g||g.includes(m))&&(!d||d.includes(m))&&(!p||e===p)&&(!u||i&&oU(u)&&u.includes(i))&&(!s||o&&oU(s)&&s.includes(o))&&(!c||oU(n)&&oU(c)&&c.find((t=>n?.includes(t))))&&(!r?.length||oU(r)&&y(t))})),h.length&&m){const t=h.filter((t=>m.includes(t.eventId))).map((t=>{const n=(t.entries||[]).map((t=>t.participantId));if(t.eventType===vu)return n;const r=(e?.participants||[]).filter((t=>n.includes(t.participantId))).map((t=>t.individualParticipantIds)).flat(1);return n.concat(...r)})).flat(1);n=n?.filter((e=>t.includes(e.participantId)))}return n}function oU(t){return t&&Array.isArray(t)&&t.length}function sU(t){const{withIndividualParticipants:e,participantFilters:n={},withPotentialMatchUps:r,withRankingProfile:i,convertExtensions:a,policyDefinitions:o,withScheduleItems:s,tournamentRecord:c,scheduleAnalysis:u,withSignInStatus:d,withTeamMatchUps:p,withScaleValues:l,usePublishState:m,contextProfile:f,withStatistics:h,withOpponents:I,withMatchUps:g,internalUse:U,withSeeding:y,withEvents:S,withDraws:v,withISO2:w,withIOC:P}=t;if(!c)return{error:$};(g||i)&&ph({tournamentRecord:c});let{participantMap:D}=Kf({withIndividualParticipants:e,convertExtensions:a,tournamentRecord:c,withSignInStatus:d,withScaleValues:l,internalUse:U,withISO2:w,withIOC:P});const N=function(t){const{participantFilters:e,convertExtensions:n,policyDefinitions:r,tournamentRecord:i,usePublishState:a,contextProfile:o,participantMap:s,withPotentialMatchUps:c,withRankingProfile:u,withScheduleItems:d,scheduleAnalysis:p,withTeamMatchUps:l,withStatistics:m,withOpponents:f,withMatchUps:h,withSeeding:I,withEvents:g,withDraws:U}=t,y=e?.participantIds,S=t=>{const e=[t];return e.push(t),s[t]?.participant.individualParticipantIds?.forEach((t=>e.push(t))),e.some((t=>!y?.length||y.includes(t.relevantParticipantId)))?e:[]},v={withMatchUps:h||u,withEvents:g||u,withDraws:U||u,withPotentialMatchUps:c,withRankingProfile:u,withScheduleItems:d,scheduleAnalysis:p,withTeamMatchUps:l,withStatistics:m,participantMap:s,withOpponents:f,withSeeding:I},w=[],P={},D=[],N={},R={},b={},M=({eventType:t,scaleNames:e,participantId:n})=>s[n].participant?.rankings?.[t]?.find((t=>e.includes(t.scaleName)))?.scaleValue;for(const A of i?.events||[]){if(e?.eventIds&&!e.eventIds.includes(A.eventId))continue;const{drawDefinitions:t=[],extensions:y=[],eventType:w,eventName:E,category:C,entries:O,eventId:F,gender:k}=A,{flightProfile:x}=_s({event:A}),_=x?.flights??[],L=Zg({event:A}),B=L?.publishedSeeding;if(L&&(N[F]=L),g||I||u){const t=n?Object.assign({},...ii(y)):{};R[F]={...t,eventName:E,eventType:w,category:C,eventId:F,gender:k};const e=[C?.categoryName,C?.ageCategoryCode].filter(Boolean);for(const n of O){const{participantId:r}=n;if(!r||!s[r])continue;const i=M({eventType:w,scaleNames:e,participantId:r});let o,c;if(I){const t=s[r].participant;({seedAssignments:o,seedValue:c}=tU({publishedSeeding:B,usePublishState:a,withSeeding:I,participant:t,event:A}))}const u=e=>{if(s[e]?.events?.[F])return;const r=s[e];eU({extensionConversions:t,seedAssignments:o,participant:r,withSeeding:I,seedValue:c,eventId:F,ranking:i,entry:n})};u(r),(s[r].participant.individualParticipantIds||[]).forEach(u)}}const V=N?.[F]?.publishedSeeding;if(U||u||I){const e=t=>t?Object.assign({},...t.map((({participantId:t,seedValue:e,seedNumber:n})=>({[t]:{seedValue:e,seedNumber:n}})))):void 0,n=T([...t.map(ui("drawId")),..._.map(ui("drawId"))]);for(const r of n){const n=t.find((t=>t.drawId===r)),i=_?.find((t=>t.drawId===r)),o=n?.entries||i?.drawEntries,{structures:c=[],drawOrder:d,drawName:p,drawType:l}=n??{},m=i?.flightNumber,f=[C?.categoryName,C?.ageCategoryCode].filter(Boolean),h=(n?.structures||[]).sort(((t,e)=>Wd(t,e))).map((({structureId:t,structures:e})=>[t,...(e||[]).map((({structureId:t})=>t))])).flat(1/0);let y,S,v,T,P=0;const D=c.filter((({stage:t,stageSequence:e})=>t===Hu&&1===e||t===zu)).flatMap((t=>{const{seedAssignments:e,stageSequence:n,stage:r}=t,{positionAssignments:i}=Rp({structure:t});return r===Hu?(P=i?.length??0,v=i,T=e):1===n&&(y=i,S=e),i})).map((({participantId:t})=>t)).filter(Boolean),N=e(T),R=e(S),A=n?o.filter((({participantId:t})=>D.includes(t))):o,E=!a||V?.published&&(0===V?.drawIds?.length||V?.drawIds?.includes(r));for(const t of A){const{entryStatus:e,entryStage:n,entryPosition:i,participantId:a}=t,o=M({participantId:a,scaleNames:f,eventType:w}),c=t=>{if(s[t].draws?.[r])return;const c=I&&E,d=c?{}:void 0,p=c?N?.[a]?.seedValue||N?.[a]?.seedNumber:void 0,l=p?N?.[a]:void 0,m=c?R?.[a]?.seedValue||R?.[a]?.seedNumber:void 0,f=m?R?.[a]:void 0;d&&p&&(d[Hu]=l),d&&m&&(d[zu]=f);const h=p||m;h&&(s[t].participant.seedings[w]||(s[t].participant.seedings[w]=[]),l&&s[t].participant.seedings[w].push({...l,scaleName:r}),f&&s[t].participant.seedings[w].push({...f,scaleName:r}),d&&(s[t].events[F].seedAssignments||(s[t].events[F].seedAssignments={}),Object.keys(d).forEach((e=>s[t].events[F].seedAssignments[e]=d[e])))),(g||u)&&s[t]&&F&&(s[t].events[F]||(s[t].events[F]={}),c?s[t].events[F].seedValue=h:s[t].events[F].seedValue&&(s[t].events[F].seedValue=void 0)),(U||u)&&(s[t].draws[r]=di({seedAssignments:d,entryPosition:i,entryStatus:e,entryStage:n,eventId:F,ranking:o,drawId:r},!1,!1,!0))};if(![ap,op].includes(e)){c(a);const t=s[a].participant.individualParticipantIds||[];t?.forEach(c)}}b[r]={qualifyingPositionAssignments:y,qualifyingSeedAssignments:S,mainPositionAssignments:v,qualifyingSeedingMap:R,mainSeedAssignments:T,orderedStructureIds:h,mainSeedingMap:N,flightNumber:m,drawOrder:d,drawName:p,drawType:l,drawSize:P,drawId:r}}}if(u||p||l||m||f||h||U){const t=!!p||c,e=nh({afterRecoveryTimes:!!p,policyDefinitions:r,tournamentRecord:i,inContext:!0,contextProfile:o,participantMap:s,nextMatchUps:t,event:A})?.matchUps??[];for(const n of e){const{finishingPositionRange:e,potentialParticipants:r,tieMatchUps:a=[],sides:o=[],winningSide:c,matchUpType:u,matchUpId:l,eventId:m,drawId:f,collectionId:h,stageSequence:I,finishingRound:g,matchUpStatus:U,roundPosition:y,roundNumber:w,structureId:T,schedule:D,score:N,stage:R}=n;P[l]=n;const b={finishingPositionRange:e,finishingRound:g,stageSequence:I,roundPosition:y,collectionId:h,roundNumber:w,structureId:T,schedule:D,eventId:m,drawId:f,score:N,stage:R};iU({...b,...v,matchUpStatus:U,winningSide:c,matchUpType:u,matchUpId:l,sides:o});for(const t of a){const{winningSide:e,sides:n=[],matchUpId:r,matchUpStatus:i,matchUpType:a}=t;iU({...b,...v,winningSide:e,tieWinningSide:c,matchUpTieId:l,matchUpId:r,sides:n,matchUpSides:o,matchUpStatus:i,matchUpType:a})}if(Array.isArray(r)&&(t||p||d)){const t=r.flat().map(ui("participantId")).filter(Boolean);t?.forEach((t=>{const e=S(t);e?.forEach((t=>{s[t]&&(s[t].potentialMatchUps[l]=di({tournamentId:i?.tournamentId,matchUpId:l,eventId:m,drawId:f}))})),(p||d)&&nU({potential:!0,participantMap:s,participantId:t,matchUpStatus:U,roundPosition:y,structureId:T,matchUpType:u,roundNumber:w,matchUpId:l,schedule:D,drawId:f,score:N})}))}}D.push(...e)}}if(m||u||p){const t=Object.values(s);for(const e of t){const{wins:t,losses:n,[ba]:{wins:r,losses:i},[Aa]:{wins:a,losses:o}}=e.counters,c=(t,n,r)=>{const i=n+r,a=n,o=i&&a/i;e.statistics[t]={denominator:i,numerator:a,statValue:o,statCode:t}};if(m&&(c(zo,t,n),c(`${zo}.${ba}`,r,i),c(`${zo}.${Aa}`,a,o)),u){const t=(t=[])=>Math.abs(t[0]-t[1]);for(const n of Object.keys(e.draws)){const{orderedStructureIds:r=[],flightNumber:i}=b[n]||{};if(e.structureParticipation&&r.length){let a,o=0;const s=r.map((n=>{const r=e.structureParticipation[n];if(!r)return;a||(a=r?.finishingPositionRange),t(a)>t(r?.finishingPositionRange)&&(a=r?.finishingPositionRange);const s=r.stage!==zu;s&&(o+=1);const c=s?o:void 0;return di({...r,participationOrder:c,flightNumber:i})})).filter(Boolean);e.draws[n]&&(e.draws[n].finishingPositionRange=a,e.draws[n].structureParticipation=s)}}}if(p){const t=si(p)?p.scheduledMinutesDifference:0,n=e.scheduleItems||[],r=e.potentialMatchUps||{},i=n.reduce(((t,e)=>{const{scheduledDate:n,scheduledTime:r}=e;return t[n]||(t[n]=[]),r&&t[n].push(e),t}),{});Object.values(i).forEach((t=>t.sort(Yr)));for(const o of n){const{typeChangeTimeAfterRecovery:n,timeAfterRecovery:a,scheduledDate:s,scheduledTime:c}=o,u=i[s],d=jr(c);for(const i of u){if(i.matchUpId===o.matchUpId||[ca,Zi].includes(i.matchUpStatus)&&!i.scoreHasValue)continue;const s=o.matchUpType!==i.matchUpType&&n||a,c=o.drawId===i.drawId,u=r[o.matchUpId]&&r[i.matchUpId],p=jr(i.scheduledTime),l=Math.abs(p-d),m=p>d;!(t&&!isNaN(t)?l<=t:m&&jr(i.scheduledTime)<jr(s))||u&&c||!m||e.scheduleConflicts.push({priorScheduledMatchUpId:o.matchUpId,matchUpIdWithConflict:i.matchUpId})}}const a=e.participant.participantId;e.scheduleConflicts.length&&w.push(a),s[a].scheduleConflicts=e.scheduleConflicts}}}return{participantIdsWithConflicts:w,eventsPublishStatuses:N,derivedEventInfo:R,derivedDrawInfo:b,mappedMatchUps:P,participantMap:s,matchUps:D}}({withMatchUps:g??i,withEvents:S??i,withDraws:v??i,withPotentialMatchUps:r,participantFilters:n,withRankingProfile:i,convertExtensions:a,withScheduleItems:s,policyDefinitions:o,tournamentRecord:c,scheduleAnalysis:u,withTeamMatchUps:p,usePublishState:m,withStatistics:h,participantMap:D,withOpponents:I,contextProfile:f,withSeeding:y}),{participantIdsWithConflicts:R,eventsPublishStatuses:b,derivedEventInfo:M,derivedDrawInfo:A,mappedMatchUps:E}=N,C=N.matchUps;D=N.participantMap;const O=u??r,F=Object.values(D).map((({potentialMatchUps:t,scheduleConflicts:e,scheduleItems:n,participant:r,statistics:a,opponents:o,matchUps:c,events:d,draws:p})=>{const l=Object.values(p),m=Object.values(o);return I&&l?.forEach((t=>{t.opponents=m.filter((e=>e.drawId===t.drawId))})),di({...r,scheduleConflicts:u?e:void 0,draws:v||i?l:void 0,events:S||i?Object.values(d):void 0,matchUps:g||i?Object.values(c):void 0,opponents:I?m:void 0,potentialMatchUps:O?Object.values(t):void 0,statistics:h?Object.values(a):void 0,scheduleItems:s?n:void 0},!1,!1,!0)})),k=o?.[eo],x=k?.participant,_=aU({participants:F,participantFilters:n,tournamentRecord:c});return{participantIdsWithConflicts:R,eventsPublishStatuses:b,derivedEventInfo:M,derivedDrawInfo:A,mappedMatchUps:E,participantMap:D,participants:x?_.map((t=>li({source:t,template:x}))):_,...L,matchUps:C}}function cU(t,e,n){if(!t&&e)return e;if(t&&!e)return t;if("object"!=typeof t||"object"!=typeof e)return t;return T(Object.keys(t).concat(Object.keys(e))).reduce(((r,i)=>{if(e[i])if(t[i])if(typeof t[i]!=typeof e[i])r[i]=e[i];else if(Array.isArray(t[i]))if(!0===n||Array.isArray(n)&&n.includes(i)){const n=T(t[i].map((t=>JSON.stringify(t))).concat(e[i].map((t=>JSON.stringify(t))))).map((t=>JSON.parse(t)));r[i]=n}else r[i]=e[i];else"object"==typeof t[i]?r[i]=cU(t[i],e[i],n):r[i]=e[i];else r[i]=e[i];else r[i]=t[i];return r}),{})}function uU({tournamentRecords:t,policyDefinitions:e,contextProfile:n,participantId:r,personId:i}){if(!t)return{error:q};if("string"!=typeof r&&"string"!=typeof i)return{error:me,stack:"publicFindParticipant"};let a,o;for(const s of Object.values(t)){o=s.tournamentId;if(a=fs({tournamentParticipants:sU({policyDefinitions:e,tournamentRecord:s}).participants??[],internalUse:!0,policyDefinitions:e,contextProfile:n,participantId:r,personId:i}),a)break}return{participant:a,tournamentId:o,...L}}const dU=({penaltyId:t=hi()}={})=>({refereeParticipantId:void 0,penaltyCode:void 0,penaltyType:void 0,extensions:void 0,matchUpId:void 0,createdAt:void 0,issuedAt:void 0,notes:void 0,penaltyId:t});function pU({refereeParticipantId:t,tournamentRecord:e,participantIds:n,penaltyCode:r,penaltyType:i,extensions:a,penaltyId:o,matchUpId:s,issuedAt:c,notes:u}){if(!e)return{error:$};if(!n)return{error:Le};if(!i)return{error:on};const d=(e?.participants||[]).filter((t=>n.includes(t.participantId)));if(!d.length)return{error:Be};const p=(new Date).toISOString(),l=Object.assign(dU({penaltyId:o}),{refereeParticipantId:t,penaltyCode:r,penaltyType:i,matchUpId:s,notes:u,issuedAt:c,createdAt:p});return Array.isArray(a)&&a.forEach((t=>Bs({element:l,extension:t}))),d.forEach((t=>{t.penalties||(t.penalties=[]),t.penalties.push(l)})),dr({topic:Ic,payload:{tournamentId:e.tournamentId,participants:d}}),{...L,penaltyId:l.penaltyId}}function lU({tournamentRecord:t,penaltyId:e}){if(!t)return{error:$};if(!e)return{error:sn};const n=[];let r,i=!1;return(t?.participants||[]).forEach((t=>{let a=!1;t.penalties=(t.penalties||[]).filter((o=>(o.penaltyId===e&&(a=!0,i||(r=o,i=!0)),a&&n.push(t),o.penaltyId!==e)))})),r&&dr({topic:Ic,payload:{tournamentId:t.tournamentId,participants:n}}),r?{...L,penalty:r}:{error:cn}}function mU({tournamentRecord:t}){if(!t)return{error:$};const e=(t?.participants||[]).reduce(((t,e)=>{const{participantId:n}=e;return(e.penalties||[]).forEach((e=>{const{penaltyId:r}=e||{};t[r]?t[r].participants.push(n):t[r]={...e,participantIds:[n]}})),t}),{});return{penalties:Object.values(e)}}function fU({tournamentRecord:t,modifications:e,penaltyId:n}){if(!t)return{error:$};if(!e)return{error:xn,modifications:e};if(!n)return{error:sn};const r=t?.participants||[],i=Object.keys(dU()).filter((t=>"penaltyId"!==t)),a=Object.keys(e).filter((t=>i.includes(t)));if(!a.length)return{error:Vn};let o;const s=[];return r.forEach((t=>{let r=!1;t.penalties=(t.penalties||[]).map((t=>(t.penaltyId===n&&(r=!0,a.forEach((n=>Object.assign(t,{[n]:e[n]}))),o||(o=t)),t))),r&&s.push(t)})),o&&dr({topic:Ic,payload:{tournamentId:t.tournamentId,participants:s}}),o?{...L,penalty:o}:{error:cn}}function hU({drawDefinition:t,structureId:e,matchUpId:n,structure:r,matchUp:i,eventId:a,event:o}){const s="getTieFormat";let c;if(e=r?.structureId??e,((n=i?.matchUpId??n)||e)&&!t)return{error:Y};if(a&&o)c=Di(o);else if(n){if(t&&(!i||!r)){const e=$p({drawDefinition:t,matchUpId:n});if(e.error)return e;if(e.matchUp?.matchUpType!==Ea)return Oi({result:{error:ee},stack:s});r||(r=e.structure),i||(i=e.matchUp)}c=Ni({item:i,drawDefinition:t,structure:r,event:o})||Ni({item:r,drawDefinition:t,structure:r,event:o})||Di(t)||Di(o)}else if(t&&e){if(!r){const n=zd({drawDefinition:t,structureId:e});if(n.error)return n;r=n?.structure}c=Ni({item:r,drawDefinition:t,structure:r,event:o})||Di(t)||Di(o)}else c=Di(t)||Di(o);return c?{...L,structure:r,tieFormat:c,matchUp:i}:Oi({result:{error:Kt},stack:s})}function IU({drawDefinition:t,auditData:e}){const{extension:n}=tc({name:_o,element:t});Bs({element:t,extension:{name:_o,value:Array.isArray(n?.value)?n?.value.concat(e):[e]}})}function gU({tieFormat:t,isMock:e,uuids:n}){const{collectionDefinitions:r}=t??{};return{tieMatchUps:(r??[]).map((t=>UU({collectionDefinition:t,uuids:n,isMock:e}))).filter(Boolean).flat()}}function UU({collectionPositionOffset:t=0,collectionDefinition:e,matchUpsLimit:n,isMock:r,uuids:i}){const{matchUpCount:a,matchUpType:o,collectionId:s,processCodes:c}=e||{};return E(0,n??a??0).map((e=>{const n=t+e+1;return{sides:[{sideNumber:1},{sideNumber:2}],matchUpId:i?.pop()||hi(),matchUpStatus:Vi.ToBePlayed,collectionPosition:n,collectionId:s,processCodes:c,matchUpType:o,isMock:r}}))}function yU({matchUp:t,updateInProgressMatchUps:e}){return!t.winningSide&&![fa].includes(t.matchUpStatus)&&(e||t.matchUpStatus!==na&&!Yp(t))}function SU({from:t,to:e}){const n=Object.keys(t),r=O(n,Object.keys(e)).length===n.length,i=n.filter((n=>t[n]!==e[n])).map((n=>({countChange:e[n]-t[n],collectionId:n}))),a=n.every((n=>t[n]===e[n]));return{equivalent:r&&a,matchUpsCountChanges:i}}function vU({check:t,matchUp:e}){let n="";const r=[];return{changesArePossible:t.matchUpsCountChanges.every((({collectionId:t,countChange:i})=>{const a=e.tieMatchUps.filter((e=>e.collectionId===t&&e.matchUpStatus===sa)).map(ui("matchUpId")),o=a.length+i>=0||i>0;return!o&&i<0&&(n="Insufficient TO_BE_PLAYED matchUps"),r.push({toBePlayedTieMatchUpIds:a,collectionId:t,countChange:i}),o})),changes:r,cannotChangeReaon:n}}function wU({updateInProgressMatchUps:t=!1,tournamentRecord:e,collectionOrder:n,collectionName:r,tieFormatName:i,drawDefinition:a,matchUpFormat:o,matchUpCount:s,collectionId:c,matchUpType:u,structureId:d,matchUpId:p,category:l,eventId:m,gender:f,event:h,collectionValueProfiles:I,collectionValue:g,matchUpValue:U,scoreValue:y,setValue:S}){const w="modifyCollectionDefinition";if(o&&!Ti(o))return Oi({result:{error:xn},context:{matchUpFormat:o},stack:w});if(r&&"string"!=typeof r)return Oi({result:{error:xn},context:{collectionName:r},stack:w});if(f&&!Object.values(Gp).includes(f))return Oi({result:{error:xn},context:{gender:f},stack:w});if(l&&"object"!=typeof l)return Oi({result:{error:xn},context:{category:l},stack:w});const T={collectionValueProfiles:I,collectionValue:g,matchUpValue:U,scoreValue:y,setValue:S};if(!(Object.values(T).filter(Boolean).length||n||r||o||s||u))return Oi({result:{error:me},stack:w});if(Object.values(T).filter(Boolean).length>1)return Oi({info:"Only one value assignment allowed per collectionDefinition",result:{error:xn},stack:w});let P=hU({drawDefinition:a,structureId:d,matchUpId:p,eventId:m,event:h});if(P.error)return Oi({result:P,stack:w});const{matchUp:D,structure:R,tieFormat:b}=P,M=zp(b),A=b?.collectionDefinitions.find((t=>t.collectionId===c)),E=M?.collectionDefinitions.find((t=>t.collectionId===c));if(!A)return Oi({info:"source collectionDefinition",result:{error:Gn},context:{collectionId:c},stack:w});const C=g??U??y??S;if(I){const t=Hi({matchUpCount:s??A?.matchUpCount,collectionValueProfiles:I});if(t.errors)return Oi({result:{error:xn},info:t.errors,stack:w})}else if(C&&!v(C))return Oi({result:{error:xn},info:"value is not an integer",context:{value:C},stack:w});const F=I&&(!A.collectionValueProfiles||(k=A.collectionValueProfiles,x=I,!(O(Object.keys(k),Object.keys(x)).length===Object.keys(k).length&&O(Object.values(k),Object.values(x)).length===Object.values(k).length)));var k,x;const _=[];if((v(g)&&A.collectionValue!==g||v(U)&&A.matchUpValue!==U||v(y)&&A.scoreValue!==y||v(S)&&A.setValue!==S||F)&&(E.collectionValueProfiles=void 0,E.collectionValue=void 0,E.matchUpValue=void 0,E.scoreValue=void 0,E.setValue=void 0,Object.assign(E,T),_.push({collectionId:c,...di(T)})),(v(y)||v(S))&&E.collectionGroupNumber){const t=E.collectionGroupNumber;M.collectionDefinitions=M.collectionDefinitions.map((e=>{const{collectionGroupNumber:n,...r}=e;return n===t?r:e})),M.collectionGroups=M.collectionGroups.filter((({groupNumber:e})=>e!==t)),_.push({collectionId:c,change:"collectionGroupNumber removed"})}const{aggregateValue:B,valueGoal:V}=Gf(M),j=di({aggregateValue:B,valueGoal:V});if(j.aggregateValue===b?.winCriteria.aggregateValue&&j.valueGoal===b?.winCriteria.valueGoal||(M.winCriteria=j,_.push({collectionId:c,winCriteria:j})),v(n)&&A.collectionOrder!==n&&(E.collectionOrder=n,_.push({collectionId:c,collectionOrder:n})),r&&A.collectionName!==r&&(E.collectionName=r,_.push({collectionId:c,collectionName:r})),o&&A.matchUpFormat!==o&&(E.matchUpFormat=o,_.push({collectionId:c,matchUpFormat:o})),v(s)&&A.matchUpCount!==s&&(E.matchUpCount=s,_.push({collectionId:c,matchUpCount:s})),u&&A.matchUpType!==u)return Oi({result:{error:qn},context:{matchUpType:u},stack:w});l&&A.category!==l&&(E.category=l,_.push({collectionId:c,category:l})),f&&A.gender!==f&&(E.gender=f,_.push({collectionId:c,gender:f}));const G=di(M);if(P=$i({tieFormat:G}),P.error)return Oi({result:P,stack:w});if(!_.length)return Oi({result:{...L,modifications:_}});if(b?.tieFormatName!==i?(G.tieFormatName=i,_.push({tieFormatName:i})):_.length&&(delete G.tieFormatName,_.push("tieFormatName removed: modifications without new tieFormatName")),P=function({updateInProgressMatchUps:t,tournamentRecord:e,drawDefinition:n,structure:r,tieFormat:i,eventId:a,matchUp:o,event:s,uuids:c}){const u="updateTieFormat",d=e?.tournamentId;let p=0,l=0,m=0,f=0;const h=i?.collectionDefinitions.reduce(((t,e)=>(t[e.collectionId]=(t[e.collectionId]||0)+e.matchUpCount,t)),{}),I=({tieFormat:t})=>{const e=t?.collectionDefinitions.reduce(((t,e)=>(t[e.collectionId]=(t[e.collectionId]||0)+e.matchUpCount,t)),{});return SU({from:e,to:h}).equivalent},g=hU({drawDefinition:n})?.tieFormat,U=hU({event:s})?.tieFormat;if(s&&a){for(const t of s.drawDefinitions??[])y({drawDefinition:t});s.tieFormat=zp(i),f+=1}else if(o){if(!o.tieMatchUps)return Oi({result:{error:ee},stack:u});const e=N(o.tieMatchUps?.map((({collectionId:t})=>t))),r=SU({to:h,from:e}),{changes:a,changesArePossible:p,cannotChangeReaon:m}=vU({matchUp:o,check:r});if(r.equivalent){if(!yU({matchUp:o,updateInProgressMatchUps:t}))return Oi({result:{error:Ne},info:"matchUp is IN_PROGRESS or COMPLETE",stack:u});o.tieFormat=zp(i),f+=1}else{if(!p)return Oi({context:{collectionMap:h,matchUpMap:e},result:{error:Wt},info:m||"specified changes not possible",stack:u});v({tieFormat:i,matchUp:o,changes:a,uuids:c})}l+=1,nl({eventId:s?.eventId,context:u,drawDefinition:n,tournamentId:d,matchUp:o})}else if(r){const t=g??U,e=S({inheritedTieFormat:t,structure:r})?.modifiedMatchUpsCount;e&&(l+=e,p+=1,f+=1);const a=!r.tieFormat||hh({ancestor:r.tieFormat,descendant:i}).different;a&&(r.tieFormat=zp(i),p+=1,f+=1),(e||a)&&n&&il({structureIds:[r.structureId],eventId:s?.eventId,drawDefinition:n})}else{if(!n)return{error:Y};y({drawDefinition:n}),n.tieFormat=zp(i),f+=1}return{modifiedStructuresCount:p,modifiedMatchUpsCount:l,addedMatchUpsCount:m,modifiedCount:f,...L,tieFormat:i};function y({drawDefinition:t}){const e=t.structures||[],n=[];for(const r of e){if(r.tieFormat)continue;const t=U,e=S({inheritedTieFormat:t,structure:r})?.modifiedMatchUpsCount;if(e){p+=1,l+=e;const t=r.structureId;n.push(t)}}return il({structureIds:n,eventId:s?.eventId,drawDefinition:t}),n.length}function S({inheritedTieFormat:r,structure:o}){let s=0;const d=qp({matchUpFilters:{matchUpTypes:[Ca]},structure:o})?.matchUps||[];for(const p of d){const o=yU({matchUp:p,updateInProgressMatchUps:t});let d=!1;const l=SU({from:N(p.tieMatchUps?.map((({collectionId:t})=>t))),to:h});if(l.equivalent)p.tieFormat&&I(p)&&o&&(p.tieFormat=zp(i),d=!0);else{const{changes:t,changesArePossible:e}=vU({matchUp:p,check:l});if(e&&!p.tieFormat)v({changes:t,matchUp:p,tieFormat:i,uuids:c});else{if(!r)return Oi({result:{error:Kt},stack:u});(!p.tieFormat||hh({ancestor:r,descendant:p.tieFormat}).different)&&(p.tieFormat=r,d=!0)}}d&&(s+=1,nl({tournamentId:e?.tournamentId,drawDefinition:n,context:u,eventId:a,matchUp:p}))}return{modifiedMatchUpsCount:s}}function v({uuids:t,matchUp:e,tieFormat:r,changes:i}){e.tieFormat=zp(r);const o=[],s=[];return i.forEach((n=>{if(n.countChange>0){const i=Math.max(0,...e.tieMatchUps.filter((t=>t.collectionId===n.collectionId)).map(ui("collectionPosition"))),a=r.collectionDefinitions.find((t=>t.collectionId===n.collectionId)),o=UU({matchUpsLimit:n.countChange,collectionPositionOffset:i,collectionDefinition:a,uuids:t});s.push(...ri(o,!1,!0)),m+=s.length,e.tieMatchUps.push(...o)}else{const t=n.toBePlayedTieMatchUpIds.slice(0,Math.abs(n.countChange));console.log("remove",t.length),o.push(...t),e.tieMatchUps=e.tieMatchUps.filter((({matchUpId:e})=>!t.includes(e)))}})),s.length&&tl({matchUps:s,drawDefinition:n,tournamentId:d,eventId:a}),o.length&&el({matchUpIds:o,action:"updateTieFormat",drawDefinition:n,tournamentId:d,eventId:a}),{matchUpIdsRemoved:o,matchUpsAdded:s}}}({tieFormat:G,updateInProgressMatchUps:t,tournamentRecord:e,drawDefinition:a,structure:R,eventId:m,matchUp:D,event:h}),!P.error){const{appliedPolicies:t}=Vo({tournamentRecord:e});if(t?.audit?.[_o]){IU({drawDefinition:a,auditData:di({collectionDefinition:E,drawId:a?.drawId,action:w,structureId:d,matchUpId:p,eventId:m})})}}return Oi({result:{...P,modifications:_},stack:w})}function TU(t){const{method:e,tournamentRecords:n,...r}=t,i=t.tournamentId||MI(r);if("string"!=typeof i)return{error:H};const a=n[i];return a?e({...r,tournamentRecord:a}):{error:$}}function PU({tieFormat:t,orderMap:e}){const n=zp(t);return n.collectionDefinitions.forEach((t=>{const n=e[t.collectionId];n&&(t.collectionOrder=n)})),n.collectionDefinitions.sort(((t,e)=>D(t.collectionOrder)-D(e.collectionOrder))),n}function DU({tournamentRecord:t,drawDefinition:e,structureId:n,matchUpId:r,orderMap:i,eventId:a,matchUp:o,event:s}){if("object"!=typeof i||!Object.values(i).every((t=>v(t))))return Oi({result:{error:xn},context:{orderMap:i}});if(a&&s?.tieFormat)NU({tournamentRecord:t,event:s,orderMap:i});else if(r){const n=e&&$p({drawDefinition:e,matchUpId:r});if(n?.error)return n;if(!(o=n.matchUp))return{error:te};o?.tieFormat&&(o.tieFormat=PU({tieFormat:o.tieFormat,orderMap:i}),nl({tournamentId:t?.tournamentId,eventId:s?.eventId,drawDefinition:e,matchUp:o}))}else if(n){const r=zd({drawDefinition:e,structureId:n});if(r.error)return r;const a=r.structure;if(a?.tieFormat)a.tieFormat=PU({tieFormat:a.tieFormat,orderMap:i}),bU({eventId:s?.eventId,tournamentRecord:t,drawDefinition:e,structure:a,orderMap:i}),il({drawDefinition:e,structureIds:[a.structureId]});else if(e.tieFormat)RU({structureIds:[n],tournamentRecord:t,drawDefinition:e,orderMap:i,event:s});else{if(!s?.tieFormat)return{error:Gn};NU({structureIds:[n],tournamentRecord:t,orderMap:i,event:s})}}else{if(!e?.tieFormat)return{error:Gn};RU({tournamentRecord:t,drawDefinition:e,orderMap:i,event:s})}return{...L}}function NU({tournamentRecord:t,structureIds:e,orderMap:n,event:r}){const i=PU({tieFormat:r.tieFormat,orderMap:n});e?.length||(r.tieFormat=i);for(const a of r.drawDefinitions??[])RU({tournamentRecord:t,drawDefinition:a,structureIds:e,orderMap:n,event:r})}function RU({tournamentRecord:t,drawDefinition:e,structureIds:n,orderMap:r,event:i}){const a=PU({tieFormat:e.tieFormat??i?.tieFormat,orderMap:r});n?.length||(e.tieFormat=a);const o=[];for(const s of e.structures??[])n?.length&&!n.includes(s.structureId)||((s.tieFormat||n?.includes(s.structureId))&&(s.tieFormat=PU({tieFormat:s.tieFormat??e.tieFormat??i?.tieFormat,orderMap:r})),bU({eventId:i?.eventId,tournamentRecord:t,drawDefinition:e,structure:s,orderMap:r}),o.push(s.structureId));il({drawDefinition:e,structureIds:o})}function bU({tournamentRecord:t,drawDefinition:e,structure:n,orderMap:r,eventId:i}){const a=qp({matchUpFilters:{matchUpTypes:[Ca]},structure:n})?.matchUps;for(const o of a)o.tieFormat&&(o.tieFormat=PU({tieFormat:o.tieFormat,orderMap:r}),nl({tournamentId:t?.tournamentId,drawDefinition:e,eventId:i,matchUp:o}))}function MU({updateInProgressMatchUps:t=!0,tieFormatComparison:e,tournamentRecord:n,drawDefinition:r,tieFormatName:i,collectionId:a,structureId:o,matchUpId:s,eventId:c,matchUp:u,event:d}){const p="removeCollectionDefinition";let l=u?void 0:hU({drawDefinition:r,structureId:o,matchUpId:s,eventId:c,event:d});if(l?.error)return Oi({result:l,stack:p});const m=l?.structure;u=u??l?.matchUp;const f=l?.tieFormat,h=zp(f);if(l=$i({tieFormat:h}),l.error)return Oi({result:l,stack:p});const I=h?.collectionDefinitions?.find((t=>t.collectionId===a));if(!I)return Oi({result:{error:Gn,collectionId:a}});h.collectionDefinitions=h.collectionDefinitions.filter((t=>t.collectionId!==a)),I.collectionGroupNumber&&(h.collectionDefinitions=h.collectionDefinitions.map((t=>{const{collectionGroupNumber:e,...n}=t;return n})),h.collectionGroups=h.collectionGroups.filter((({groupNumber:t})=>t!==I.collectionGroupNumber)));const{aggregateValue:g,valueGoal:U}=Gf(h);h.winCriteria=di({aggregateValue:g,valueGoal:U});const y=f?.winCriteria.valueGoal,S=f?.winCriteria.aggregateValue;(y&&y!==U||g&&!S)&&(i?h.tieFormatName=i:delete h.tieFormatName);let v=[];s&&u?v=[u]:o&&m?v=qp({matchUpFilters:{matchUpTypes:[Ca]},structure:m})?.matchUps??[]:r?v=eh({matchUpFilters:{matchUpTypes:[Ca]},drawDefinition:r})?.matchUps??[]:d&&(v=nh({matchUpFilters:{matchUpTypes:[Ca]},drawDefinition:r})?.matchUps??[]);const w=(v||[]).filter((n=>{const r=n.tieMatchUps?.filter((t=>t.collectionId===a)),i=r?.some(Yp),o=!(!e||!n.tieFormat)&&hh({descendant:n.tieFormat,ancestor:h})?.different;return t&&!i||!n.winningSide&&n.matchUpStatus!==Qi&&(t||n.matchUpStatus!==na&&!Yp(n)&&!o)}));if(!w.length)return{error:bn};if(s&&u&&t){const t=u.tieMatchUps?.filter((t=>t.collectionId===a));for(const e of t??[]){let t=qg({matchUpId:e.matchUpId,tieMatchUpId:u?.matchUpId,winningSide:void 0,removeScore:!0,tournamentRecord:n,drawDefinition:r,event:d});if(t.error)return t;if(t=$p({drawDefinition:r,matchUpId:s}),t.error)return t;u=t?.matchUp}}const T=[];for(const N of w){for(const t of N?.sides??[])t.lineUp=(t.lineUp??[]).map((t=>({participantId:t.participantId,collectionAssignments:(t?.collectionAssignments??[]).filter((t=>t.collectionId!==a))})));if(N.tieMatchUps=(N.tieMatchUps??[]).filter((t=>{const e=t.collectionId===a;return e&&T.push(t.matchUpId),!e})),N.tieFormat&&(N.tieFormat=zp(h)),t){const t=bl({matchUpId:N.matchUpId,exitWhenNoValues:!0,tournamentRecord:n,drawDefinition:r,event:d});if(t.error)return t}nl({tournamentId:n?.tournamentId,eventId:d?.eventId,drawDefinition:r,context:p,matchUp:N})}T.length&&el({tournamentId:n?.tournamentId,matchUpIds:T,eventId:d?.eventId,drawDefinition:r});const P=di(h);if(l=$i({tieFormat:P}),l.error)return Oi({result:l,stack:p});if(c&&d)d.tieFormat=P;else if(s&&u)u.tieFormat=P;else if(m)m.tieFormat=P;else if(r)r.tieFormat=P;else if(!u||!r)return{error:Y};il({drawDefinition:r,eventId:d?.eventId});const{appliedPolicies:D}=Vo({tournamentRecord:n});if(D?.audit?.[_o]){IU({drawDefinition:r,auditData:di({drawId:r?.drawId,action:p,collectionId:a,structureId:o,matchUpId:s,eventId:c})})}return{tieFormat:P,deletedMatchUpIds:T,targetMatchUps:w,...L}}function AU({updateInProgressMatchUps:t=!0,collectionDefinition:e,referenceCategory:n,tournamentRecord:r,enforceCategory:i,referenceGender:a,drawDefinition:o,tieFormatName:s,enforceGender:c,structureId:u,matchUpId:d,matchUp:p,eventId:l,uuids:m,event:f}){const h="addCollectionDefinition",I=Vo({tournamentRecord:r,drawDefinition:o,event:f}).appliedPolicies??{},g=I?.[Xa];i=i??g?.participants?.enforceCategory,c=c??g?.participants?.enforceGender;const U=!(!(n??f?.category)||!1===i),y=!(!(a??f?.gender)||!1===c),S=Wi({referenceCategory:n??f?.category,collectionDefinition:e,referenceGender:a,checkCategory:U,checkGender:y,event:f});if(S.error)return Oi({result:S,stack:h});let v=p?.tieFormat?void 0:hU({drawDefinition:o,structureId:u,matchUpId:d,eventId:l,event:f});if(v?.error)return Oi({result:{error:v.error},stack:h});const w=v?.structure;p=p??v?.matchUp;const T=p?.tieFormat??v?.tieFormat,P=zp(T);if(v=$i({tieFormat:P}),v?.error)return Oi({result:{error:v.error},stack:h});if(e.collectionId){if(P.collectionDefinitions.map((({collectionId:t})=>t)).includes(e.collectionId))return Oi({context:{collectionId:e.collectionId},result:{error:_n}})}else e.collectionId=hi();P.collectionDefinitions.push(e),P.collectionDefinitions.sort(((t,e)=>(t.collectionOrder||0)-(e.collectionOrder||0))).forEach(((t,e)=>t.collectionOrder=e+1));const{aggregateValue:D,valueGoal:N}=Gf(P);P.winCriteria=di({aggregateValue:D,valueGoal:N});const R=T?.winCriteria.valueGoal,b=T?.winCriteria.aggregateValue;(R&&R!==N||D&&!b)&&(s?P.tieFormatName=s:delete P.tieFormatName);const M=[],A=[];let E=[];const C=di(P);if(v=$i({tieFormat:C}),v?.error)return Oi({result:{error:v.error},stack:h});if(l&&f){f.tieFormat=C;for(const n of f.drawDefinitions??[])if(!n.tieFormat)for(const r of n.structures??[]){if(r.tieFormat)continue;const n=EU({updateInProgressMatchUps:t,collectionDefinition:e,structure:r,uuids:m});A.push(...n.newMatchUps),E.push(...n.targetMatchUps),M.push(r.structureId)}CU({modifiedMatchUps:E,eventId:f?.eventId,modifiedStructureIds:M,tournamentRecord:r,drawDefinition:o,addedMatchUps:A,stack:h})}else if(u&&w){w.tieFormat=C;const n=EU({updateInProgressMatchUps:t,collectionDefinition:e,structure:w,uuids:m});A.push(...n.newMatchUps),E=n.targetMatchUps,CU({modifiedMatchUps:E,eventId:f?.eventId,modifiedStructureIds:M,tournamentRecord:r,drawDefinition:o,addedMatchUps:A,stack:h})}else if(d&&p){if(!yU({matchUp:p,updateInProgressMatchUps:t}))return Oi({result:{error:Ne},stack:h});p.tieFormat=C;const n=UU({collectionDefinition:e,uuids:m});Array.isArray(p.tieMatchUps)||(p.tieMatchUps=[]),p.tieMatchUps.push(...n),A.push(...n),CU({modifiedMatchUps:[p],eventId:f?.eventId,modifiedStructureIds:M,tournamentRecord:r,drawDefinition:o,addedMatchUps:A,stack:h})}else{if(!o)return{error:Y};o.tieFormat=C;for(const n of o.structures??[]){const r=EU({updateInProgressMatchUps:t,collectionDefinition:e,structure:n,uuids:m});M.push(n.structureId),A.push(...r.newMatchUps),E.push(...r.targetMatchUps)}CU({modifiedMatchUps:E,eventId:f?.eventId,tournamentRecord:r,drawDefinition:o,addedMatchUps:A,stack:h})}if(I?.audit?.[_o]){IU({drawDefinition:o,auditData:di({drawId:o?.drawId,collectionDefinition:e,action:h,structureId:u,matchUpId:d,eventId:l})})}return{tieFormat:C,targetMatchUps:E,addedMatchUps:A,...L}}function EU({updateInProgressMatchUps:t,collectionDefinition:e,structure:n,uuids:r}){const i=[],a=qp({matchUpFilters:{matchUpTypes:[Ca]},structure:n})?.matchUps,o=a.filter((e=>yU({matchUp:e,updateInProgressMatchUps:t})&&!e.tieFormat));for(const s of o){const t=UU({collectionDefinition:e,uuids:r});Array.isArray(s.tieMatchUps)||(s.tieMatchUps=[]),s.tieMatchUps.push(...t),i.push(...t)}return{newMatchUps:i,targetMatchUps:o}}function CU({modifiedStructureIds:t,tournamentRecord:e,modifiedMatchUps:n,drawDefinition:r,addedMatchUps:i,eventId:a,stack:o}){tl({tournamentId:e?.tournamentId,matchUps:i,drawDefinition:r,eventId:a}),n?.forEach((t=>{nl({tournamentId:e?.tournamentId,drawDefinition:r,context:o,matchUp:t,eventId:a})})),il({structureIds:t,drawDefinition:r,eventId:a})}function OU({updateInProgressMatchUps:t,originalValueGoal:e,tournamentRecord:n,wasAggregateValue:r,tieFormatName:i,drawDefinition:a,structureId:o,structure:s,tieFormat:c,matchUpId:u,matchUp:d,eventId:p,event:l}){const{aggregateValue:m,valueGoal:f}=Gf(c);c.winCriteria=di({aggregateValue:m,valueGoal:f}),(e&&e!==f||m&&!r)&&(i?c.tieFormatName=i:delete c.tieFormatName);const{targetMatchUps:h}=function({updateInProgressMatchUps:t,drawDefinition:e,structureId:n,structure:r,matchUpId:i,matchUp:a}){let o=[];return i&&a?o=[a]:n&&r?o=qp({matchUpFilters:{matchUpTypes:[Ca]},structure:r})?.matchUps||[]:e&&(o=eh({matchUpFilters:{matchUpTypes:[Ca]},drawDefinition:e})?.matchUps||[]),{targetMatchUps:o.filter((e=>!e.winningSide&&e.matchUpStatus!==Qi&&(t||e.matchUpStatus!==na&&!Yp(e))))}}({updateInProgressMatchUps:t,drawDefinition:a,structureId:o,structure:s,matchUpId:u,matchUp:d});!function({updateInProgressMatchUps:t,tournamentRecord:e,drawDefinition:n,targetMatchUps:r,tieFormat:i,event:a}){for(const o of r){const r=!!o.tieFormat;let s;if(r&&(o.tieFormat=zp(i)),t){const t=bl({matchUpId:o.matchUpId,exitWhenNoValues:!0,tournamentRecord:e,drawDefinition:n,event:a});if(t.error)return t;s=t.score}r&&!s&&nl({tournamentId:e?.tournamentId,context:"updateTargetTeamMatchUps",eventId:a?.eventId,matchUp:o,drawDefinition:n})}}({updateInProgressMatchUps:t,tournamentRecord:n,targetMatchUps:h,drawDefinition:a,tieFormat:c,event:l});const I=di(c),g=$i({tieFormat:I});if(g.error)return g;if(p&&l)l.tieFormat=I;else if(u&&d)d.tieFormat=c;else if(s)s.tieFormat=I;else if(a)a.tieFormat=I;else if(!d||!a)return{error:Y};return il({drawDefinition:a,eventId:l?.eventId}),{...L}}function FU({updateInProgressMatchUps:t=!0,collectionGroupNumber:e,tournamentRecord:n,drawDefinition:r,tieFormatName:i,structureId:a,matchUpId:o,matchUp:s,eventId:c,event:u}){if(!e)return{error:me};if(isNaN(e))return{error:xn};const d="removeCollectionGroup";let p=s?void 0:hU({drawDefinition:r,structureId:a,matchUpId:o,eventId:c,event:u});if(p?.error)return Oi({result:p,stack:d});const l=p?.structure;s=s??p?.matchUp;const m=p?.tieFormat,f=m?.winCriteria.valueGoal,h=m?.winCriteria.aggregateValue,I=zp(m);if(p=$i({tieFormat:I}),p.error)return Oi({result:p,stack:d});const g=[];if(I.collectionDefinitions=I.collectionDefinitions.map((t=>{const{collectionGroupNumber:n,...r}=t;return n!==e?t:(g.push(t.collectionId),r)})),I.collectionGroups=I.collectionGroups.filter((({groupNumber:t})=>t!==e)),p=OU({updateInProgressMatchUps:t,originalValueGoal:f,wasAggregateValue:h,tournamentRecord:n,drawDefinition:r,tieFormatName:i,structureId:a,structure:l,tieFormat:I,matchUpId:o,matchUp:s,eventId:c,event:u}),!p.error){const{appliedPolicies:t}=Vo({tournamentRecord:n});if(t?.audit?.[_o]){IU({drawDefinition:r,auditData:di({drawId:r?.drawId,collectionGroupNumber:e,action:d,structureId:a,matchUpId:o,eventId:c})})}}return Oi({result:{...p,modifiedCollectionIds:g},stack:d})}function kU({updateInProgressMatchUps:t=!0,tournamentRecord:e,groupDefinition:n,drawDefinition:r,collectionIds:i,tieFormatName:a,structureId:o,matchUpId:s,matchUp:c,eventId:u,event:d}){const p="addCollectionGroup";if(!Array.isArray(i))return Oi({result:{error:me},stack:p});let l=c?void 0:hU({drawDefinition:r,structureId:o,matchUpId:s,eventId:u,event:d});if(l?.error)return Oi({result:l,stack:p});const m=l?.structure;c=c||l?.matchUp;const f=l?.tieFormat,h=f?.winCriteria.valueGoal,I=zp(f);if(l=$i({tieFormat:I}),l.error)return Oi({result:l,stack:p});for(const U of I.collectionDefinitions){const{collectionId:t,collectionGroupNumber:e}=U;if(e&&i.includes(t))return Oi({info:"collectionIds cannot be part of other collectionGroups",result:{error:xn},stack:p})}const g=(I.collectionGroups||[]).reduce(((t,e)=>e.groupNumber>t?e.groupNumber:t),0)+1;return n.groupNumber=g,I.collectionDefinitions=I.collectionDefinitions.map((t=>i.includes(t.collectionId)?{...t,collectionGroupNumber:g}:t)),I.collectionGroups=[...I.collecitonGroups||[],n],OU({updateInProgressMatchUps:t,originalValueGoal:h,tournamentRecord:e,drawDefinition:r,tieFormatName:a,structureId:o,structure:m,tieFormat:I,matchUpId:s,matchUp:c,eventId:u,event:d})}function xU({updateInProgressMatchUps:t=!1,tieFormatComparison:e,modifiedTieFormat:n,tournamentRecord:r,drawDefinition:i,structureId:a,matchUpId:o,eventId:s,uuids:c,event:u}){const d="modifyTieFormat";if(!$i({tieFormat:n}).valid)return Oi({result:{error:Wt},info:"falied validation",stack:d});const p=hU({drawDefinition:i,structureId:a,matchUpId:o,eventId:s,event:u});if(p.error)return Oi({result:p,stack:d});const{matchUp:l,tieFormat:m}=p,f=zp(m),h=hh({descendant:n,ancestor:f});if(h.invalid)return Oi({context:{invalid:h.invalid},result:{error:Wt},stack:d});if(!h?.different)return Oi({result:{...L},info:"Nothing to do",stack:d});const I=f.collectionDefinitions.map((({collectionId:t})=>t)),g=n.collectionDefinitions.map((({collectionId:t})=>t)),U=I.filter((t=>!g.includes(t))),y=n.collectionDefinitions.filter((({collectionId:t})=>!I.includes(t))),S=y.map(ui("collectionId")),v=[];let w;const T=n.tieFormatName;for(const P of n.collectionDefinitions){if(S.includes(P.collectionId))continue;const e=wU({updateInProgressMatchUps:t,...P,tournamentRecord:r,tieFormatName:T,drawDefinition:i,structureId:a,matchUpId:o,eventId:s,event:u});if(e.modifications&&v.push(...e.modifications),e.error)return Oi({result:e,stack:d});e.tieFormat&&(w=e.tieFormat)}for(const P of y){const e=AU({updateInProgressMatchUps:t,collectionDefinition:P,tournamentRecord:r,drawDefinition:i,tieFormatName:T,structureId:a,matchUpId:o,matchUp:l,eventId:s,uuids:c,event:u});if(e.error)return Oi({result:e,stack:d});e.tieFormat&&(w=e.tieFormat)}for(const P of U){const n=MU({updateInProgressMatchUps:t,tieFormatComparison:e,tournamentRecord:r,drawDefinition:i,tieFormatName:T,collectionId:P,structureId:a,matchUpId:o,eventId:s,matchUp:l,event:u});if(n.error)return Oi({result:n,stack:d});n.tieFormat&&(w=n.tieFormat)}return m?.tieFormatName!==T?(w.tieFormatName=T,v.push({tieFormatName:T})):(v.length||S.length||U.length)&&(delete w.tieFormatName,v.push("tieFormatName removed: modifications without new tieFormatName")),w.collectionDefinitions=w.collectionDefinitions.sort(((t,e)=>D(t.collectionOrder)-D(e.collectionOrder))).map(((t,e)=>({...t,collectionOrder:e+1}))),{processedTieFormat:zp(w),modifications:v,...L}}function _U(t){Object.assign(t,{inContext:!0});const{matchUp:e,error:n}=LU(t);return{matchUp:ri(e,!0,!0),error:n}}function LU({participantsProfile:t,afterRecoveryTimes:e,tournamentRecord:n,contextContent:r,contextProfile:i,drawDefinition:a,matchUpId:o,inContext:s,eventId:c,drawId:u,event:d}){if(!n)return{error:$};if("string"!=typeof o)return{error:Jt};if(!a||!d){const t=(th({tournamentRecord:n}).matchUps??[]).find((t=>t.matchUpId===o));if(!t)return{error:Xt};({eventId:c,drawId:u}=t),({event:d,drawDefinition:a}=Ls({tournamentRecord:n,eventId:c,drawId:u}))}if(!a)return{error:J};i&&!r&&(r=Ko({tournamentRecord:n,contextProfile:i}));const p={surfaceCategory:d?.surfaceCategory??n.surfaceCategory,indoorOutDoor:d?.indoorOutdoor??n.indoorOutdoor,endDate:d?.endDate??n.endDate,tournamentId:n.tournamentId,eventId:c??d?.eventId,drawId:u},{participants:l=[]}=Zf({participantsProfile:t,tournamentRecord:n,contextProfile:i,inContext:s}),{matchUp:m,structure:f}=$p({context:s?p:void 0,tournamentParticipants:l,afterRecoveryTimes:e,contextContent:r,drawDefinition:a,contextProfile:i,matchUpId:o,inContext:s,event:d});return{matchUp:m,structure:f,drawDefinition:a}}function BU({tournamentRecord:t,drawDefinition:e,matchUpId:n,event:r,uuids:i}){const a="resetTieFormat";if(!t)return Oi({result:{error:$},stack:a});if("string"!=typeof n)return Oi({result:{error:Jt},stack:a});const o=LU({tournamentRecord:t,matchUpId:n});if(o.error)return o;const{matchUp:s,structure:c}=o;if(!s?.tieMatchUps)return Oi({result:{error:ee},info:"Must be a TEAM matchUp",stack:a});if(!s.tieFormat)return{...L};const u=Ri({structure:c,drawDefinition:e,event:r})?.tieFormat;if(!u)return Oi({result:{error:Gn},info:"No inherited tieFormat",stack:a});const d=[],p=[],l=[],m=[];for(const f of u.collectionDefinitions){const{matchUpCount:t,collectionId:e}=f;p.push(e);const n=(s.tieMatchUps||[]).filter((t=>t.collectionId===e));if(n.length>t)n.sort(((t,e)=>(t.matchUpStatus===sa?1:0)-(e.matchUpStatus===sa?1:0))),l.push(...n.slice(0,t)),d.push(...n.slice(3).map(hl));else if(l.push(...n),n.length<t){const e=UU({collectionDefinition:f,matchUpsLimit:t-n.length,uuids:i});m.push(...e)}}for(const f of s?.tieMatchUps||[])f.collectionId&&!p.includes(f.collectionId)&&d.push(f.matchUpId);return m.length&&(l.push(...m),tl({tournamentId:t?.tournamentId,eventId:r?.eventId,matchUps:m,drawDefinition:e})),d.length&&el({tournamentId:t?.tournamentId,matchUpIds:d,eventId:r?.eventId,drawDefinition:e}),s&&(s.tieMatchUps=l,s.tieFormatId=void 0,s.tieFormat=void 0,nl({tournamentId:t?.tournamentId,structureId:c?.structureId,eventId:r?.eventId,context:a,drawDefinition:e,matchUp:s})),{...L,newMatchUps:m,deletedMatchUpIds:d}}function VU(t){const{tournamentRecord:e,drawDefinition:n,matchUpId:r,event:i}=t,a="resetScorecard";if(!n)return Oi({result:{error:Y},stack:a});if(!r)return Oi({result:{error:Jt},stack:a});if("string"!=typeof r)return Oi({result:{error:xn,matchUpId:r},stack:a});const o=wp({drawDefinition:n}),{matchUps:s}=Pl({nextMatchUps:!0,inContext:!0,drawDefinition:n,matchUpsMap:o}),c=o.drawMatchUps.find((t=>t.matchUpId===r)),u=s?.find((t=>t.matchUpId===r));if(!c||!s)return{error:Xt};if(c.matchUpType!==Bi.Team)return{error:ee};const d=yl({inContextDrawMatchUps:s,drawDefinition:n,matchUpId:r}),p=u?.structureId,{structure:l}=zd({drawDefinition:n,structureId:p});Object.assign(t,{inContextDrawMatchUps:s,inContextMatchUp:u,matchUpsMap:o,targetData:d,structure:l,matchUp:c});if(xg(t))return{error:Me};for(const f of c.tieMatchUps??[]){const t=qg({matchUpId:f.matchUpId,matchUpTieId:r,winningSide:void 0,removeScore:!0,tournamentRecord:e,drawDefinition:n,event:i});if(t.error)return Oi({result:t,stack:a})}const m=bl({event:t.event,removeScore:!0,tournamentRecord:e,drawDefinition:n,matchUpsMap:o,matchUpId:r});if(m.error)return Oi({result:m,stack:a});if(t.tiebreakReset&&!m.tieFormatRemoved){const t=Ri({drawDefinition:n,structure:l,event:i})?.tieFormat;if(c.tieFormat&&t){const{matchUpCountDifference:a,descendantDifferences:o,ancestorDifferences:s,valueDifference:u}=hh({descendant:c.tieFormat,ancestor:t});if(1===o.collectionIds.length&&!s.collectionIds.length&&!s.groupsCount&&1===a&&1===u){const t=BU({tournamentRecord:e,drawDefinition:n,matchUpId:r,event:i});if(t.error)return t}}}return{...L}}const jU={modifyCollectionDefinition:function(t){return TU({...t,method:wU})},removeCollectionDefinition:function(t){return TU({...t,method:MU})},orderCollectionDefinitions:function(t){return TU({...t,method:DU})},addCollectionDefinition:function(t){return TU({...t,method:AU})},removeCollectionGroup:function(t){return TU({...t,method:FU})},addCollectionGroup:function(t){return TU({...t,method:kU})},modifyTieFormat:function(t){return TU({...t,method:xU})},resetScorecard:function(t){return TU({...t,method:VU})},resetTieFormat:function(t){return TU({...t,method:BU})},addExtension:Ys,findExtension:Ks,removeExtension:Js,addEventExtension:function({tournamentRecords:t,extension:e,eventId:n}){if("string"!=typeof n)return{error:At};if(!xs({extension:e}))return{error:xn};for(const r of Object.values(t)){const{event:t}=Ls({tournamentRecord:r,eventId:n});if(t)return Ws({event:t,extension:e})}return{error:Et}},linkTournaments:function({tournamentRecords:t}){if("object"!=typeof t||!Object.keys(t).length)return{error:q};const e=Xs(t),{tournamentIds:n}=e;if(n?.length>1){return Ys({tournamentRecords:t,extension:{name:No,value:{tournamentIds:n}}})}return{...L}},unlinkTournament:function({tournamentRecords:t,tournamentId:e}){if("object"!=typeof t)return{error:xn};if(!e)return{error:H};const n=Xs(t),{tournamentIds:r}=n;if(!r.includes(e))return{error:H};let i;return r.every((n=>{const r=t[n],{extension:a}=Us({tournamentRecord:r,name:No});if(!a)return!0;const o=a?.value?.tournamentIds||[];if(!o?.length||1===o.length&&o.includes(e)||n===e){const t=Hs({name:No,tournamentRecord:r});return t.error&&(i=t.error),t.success}const s=o.filter((t=>t!==e));a.value={tournamentIds:s};const c=qs({tournamentRecord:r,extension:a});return c.error&&(i=c.error),c.success})),i?{error:i}:{...L}},unlinkTournaments:function({tournamentRecords:t}){return"object"==typeof t&&Object.keys(t).length?Oi({result:Js({name:No,tournamentRecords:t}),stack:"unlinkTournaments"}):{error:q}},getLinkedTournamentIds:Qs,addDrawDefinition:function({tournamentRecords:t,existingDrawCount:e,allowReplacement:n,drawDefinition:r,tournamentId:i,eventId:a,flight:o}){if(!a)return{error:At};if(!(i=i??MI({tournamentRecords:t,eventId:a})))return{error:H};const s=t[i];if(!s)return{error:$};const c=Ls({tournamentRecord:s,eventId:a});return c.event?c.error?c:Jg({event:c.event,existingDrawCount:e,allowReplacement:n,drawDefinition:r,flight:o}):{error:Et}},getCompetitionParticipants:function(t){const{tournamentRecords:e}=t||{};if("object"!=typeof e||!Object.keys(e).length)return{error:q};let n=[];const r=[],i=[],a={};for(const o of Object.values(e)){const{participants:e,participantIdsWithConflicts:s,mappedMatchUps:c}=sU({tournamentRecord:o,...t});c&&Object.assign(a,c);for(const t of e??[]){const{participantId:e}=t;i.includes(e)?n=n.map((n=>n.participantId!==e?n:cU(n,t,!0))):(i.push(e),n.push(t))}s?.forEach((t=>{r.includes(t)||r.push(t)}))}return{competitionParticipants:n,participantIdsWithConflicts:r,mappedMatchUps:a,...L}},getParticipants:function(t){const{tournamentRecords:e}=t||{};if("object"!=typeof e||!Object.keys(e).length)return{error:q};const n={},r=[],i={},a={},o=[],s={},c=[];for(const u of Object.values(e)){const{participantIdsWithConflicts:e,mappedMatchUps:d,participantMap:p,participants:l,matchUps:m,derivedEventInfo:f,derivedDrawInfo:h}=sU({tournamentRecord:u,...t});Object.assign(s,d),Object.assign(n,p),Object.assign(i,f),Object.assign(a,h),r.push(...l??[]),o.push(...m??[]),e?.forEach((t=>{c.includes(t)||c.push(t)}))}return{participantIdsWithConflicts:c,derivedEventInfo:i,derivedDrawInfo:a,participantMap:n,mappedMatchUps:s,participants:r,...L,matchUps:o}},addParticipant:function({tournamentRecords:t,returnParticipant:e,pairOverride:n,tournamentId:r,participant:i}){if("string"!=typeof r)return{error:H};const a=t[r];return a?Qg({returnParticipant:e,tournamentRecord:a,pairOverride:n,participant:i}):{error:$}},courtGridRows:Kg,setMatchUpStatus:function(t){const e=t.tournamentRecords,n=t.tournamentId||MI(t);if("string"!=typeof n)return{error:H};const r=e[n];if(!r)return{error:$};const{drawDefinition:i,event:a}=Ls({eventId:t.eventId,drawId:t.drawId,tournamentRecord:r});return zg({tournamentRecord:r,...t,drawDefinition:i,event:a})},bulkMatchUpStatusUpdate:function(t){const{tournamentRecords:e,outcomes:n}=t;if(!Array.isArray(n))return{error:me,info:Ci("outcomes")};const r=n.reduce(((t,e)=>t.includes(e.tournamentId)?t:t.concat(e.tournamentId)),[]);for(const i of r){const t=e[i];if(!t)return{error:$};const r=n.filter((t=>t.tournamentId===i));if(r.length){const e=Yg({tournamentRecord:t,outcomes:r});if(e.error)return e}}return{...L}},bulkScheduleMatchUps:CI,addPenalty:function(t){const{tournamentRecords:e,participantIds:n}=t;let r;for(const i of Object.values(e)){const e=sU({tournamentRecord:i}).participants??[],a=e?.map(ui("participantId")).filter((t=>n.includes(t)));if(a.length){r=pU({...t,penaltyId:t.penaltyId||r,tournamentRecord:i,participantIds:a}).penaltyId}}return r?{...L,penaltyId:r}:{error:Be}},removePenalty:function(t){const{tournamentRecords:e}=t;if("object"!=typeof e||!Object.keys(e).length)return{error:q};for(const n of Object.values(e)){const e=lU({tournamentRecord:n,...t});if(e.error&&e.error!==cn)return e}return{...L}},modifyPenalty:function(t){const{tournamentRecords:e}=t;if("object"!=typeof e||!Object.keys(e).length)return{error:q};for(const n of Object.values(e)){const e=fU({tournamentRecord:n,...t});if(e.error&&e.error!==cn)return e}return{...L}},getCompetitionPenalties:function({tournamentRecords:t}){if("object"!=typeof t||!Object.keys(t).length)return{error:q};const e=[];for(const n of Object.values(t)){const{penalties:t}=mU({tournamentRecord:n});e.push(...t||[])}return{penalties:e}},findParticipant:uU};function GU({removePriorValues:t=!0,tournamentRecord:e,status:n=su}){if(!e)return{error:$};const r=`${ou}.${cu}`,{timeItem:i}=Hf({tournamentRecord:e,itemType:r}),a=i?.itemValue||{[n]:{}};a[n]&&delete a[n].orderOfPlay;return pI({timeItem:{itemValue:a,itemType:r},removePriorValues:t,tournamentRecord:e}),dr({topic:Rc,payload:{tournamentId:e.tournamentId}}),{...L}}function qU({scheduledDates:t=[],removePriorValues:e,tournamentRecord:n,status:r=su,eventIds:i=[]}){if(!n)return{error:$};const a=`${ou}.${cu}`,{timeItem:o}=Hf({tournamentRecord:n,itemType:a}),s=o?.itemValue||{[r]:{}};s[r].orderOfPlay={published:!0,scheduledDates:t,eventIds:i};return pI({timeItem:{itemValue:s,itemType:a},removePriorValues:e,tournamentRecord:n}),dr({topic:Pc,payload:{tournamentId:n.tournamentId,scheduledDates:t,eventIds:i}}),{...L}}const $U={unPublishOrderOfPlay:function(t){const e=t?.tournamentRecords;if(!e)return{error:q};for(const n of Object.values(e)){const e=GU({tournamentRecord:n,...t});if(e.error)return e}return{...L}},publishOrderOfPlay:function(t){const e=t?.tournamentRecords;if(!e)return{error:q};for(const n of Object.values(e)){const e=qU({tournamentRecord:n,...t});if(e.error)return e}return{...L}}};function WU({tournamentRecord:t,matchUpFormat:e,event:n}){if(!t)return{error:$};if(!Ti(e))return{error:Gt};const{extension:r}=ys({event:n,name:Oo}),i=r?.value,{extension:a}=Us({tournamentRecord:t,name:Oo}),o=a?.value;return{matchUpFormat:e,averageTimes:[i?.matchUpAverageTimes&&is({...i,matchUpFormat:e}),o?.matchUpAverageTimes&&is({...o,matchUpFormat:e})].find((t=>t)),recoveryTimes:[i?.matchUpRecoveryTimes&&as({...i,matchUpFormat:e}),o?.matchUpRecoveryTimes&&as({...o,matchUpFormat:e})].find((t=>t))}}function HU({tournamentRecord:t,recoveryTimes:e,matchUpFormat:n,averageTimes:r,event:i}){if(!t)return{error:$};if(r&&!Array.isArray(r))return{error:xn};if(e&&!Array.isArray(e))return{error:xn};const a=Oo;if(i){const{extension:t}=ys({event:i,name:a});Ws({event:i,extension:{name:a,value:zU({...t?.value||{},matchUpFormat:n,averageTimes:r,recoveryTimes:e})}})}else{const{extension:i}=Us({tournamentRecord:t,name:a});qs({extension:{name:a,value:zU({...i?.value||{},matchUpFormat:n,averageTimes:r,recoveryTimes:e})},tournamentRecord:t})}return{...L}}function zU(t){const{matchUpRecoveryTimes:e=[],matchUpAverageTimes:n=[],matchUpFormat:r}=t;let{averageTimes:i,recoveryTimes:a}=t;i=(i||[]).filter((t=>t?.categoryNames?.length||t?.categoryTypes?.length));const o=i?.length&&n.map((t=>t?.matchUpFormatCodes.includes(r)?{...t,matchUpFormatCodes:t.matchUpFormatCodes?.filter((t=>t!==r))}:t)).filter((({matchUpFormatCodes:t})=>t?.length)).concat({matchUpFormatCodes:[r],averageTimes:i});a=(a||[]).filter((t=>t?.categoryNames?.length||t?.categoryTypes?.length));const s=a?.length&&e.map((t=>t?.matchUpFormatCodes.includes(r)?{...t,matchUpFormatCodes:t.matchUpFormatCodes?.filter((t=>t!==r))}:t)).filter((({matchUpFormatCodes:t,averageTimes:e})=>t?.length||e)).concat({matchUpFormatCodes:[r],recoveryTimes:a});return{matchUpAverageTimes:o?.length&&o||n,matchUpRecoveryTimes:s?.length&&s||e}}function YU({tournamentRecord:t,recoveryMinutes:e,averageMinutes:n,matchUpFormat:r,categoryType:i,event:a}){if(!t)return{error:$};if(!Ti(r))return{error:xn};if(!a)return{error:At};const{averageTimes:o=[],recoveryTimes:s=[]}=WU({tournamentRecord:t,matchUpFormat:r,event:a}),c=a.category,u=c?.categoryName||c?.ageCategoryCode||a?.eventId;let d={categoryNames:[u],minutes:{}};const p={categoryNames:[u],minutes:{}},l=t=>{if(t.categoryTypes?.includes(i)&&console.log("encountered:",{categoryType:i}),!t.categoryNames?.includes(u)||(t.categoryNames=t.categoryNames.filter((t=>t!==u)),d={minutes:t.minutes,categoryNames:[u]},t.categoryNames.length))return t},f=!isNaN(m(n)),h=!isNaN(m(e)),I=o.map(l).filter((t=>t?.categoryNames?.length)),g=s.map(l).filter((t=>t?.categoryNames?.length));return f&&(Object.assign(d.minutes,{[a?.eventType||ba]:n}),I.push(d)),h&&(Object.assign(p.minutes,{[a?.eventType||ba]:e}),g.push(p)),f||h?HU({averageTimes:f&&I,recoveryTimes:h&&g,tournamentRecord:t,matchUpFormat:r,event:a}):{error:xn}}function KU({tournamentRecords:t,extensionName:e}){if("object"!=typeof t||!Object.keys(t).length)return{error:q};const n=[];let r;for(const i of Object.values(t)){const{extension:t}=Us({name:e,tournamentRecord:i});t&&!r&&(n.push({method:"addExtension",params:{extension:t}}),r=!0);const a=i.events||[];for(const r of a){const{eventId:t}=r,{extension:i}=ys({name:e,event:r});i&&n.push({params:{eventId:t,extension:i},method:"addEventExtension"})}}return{methods:n}}function JU({tournamentRecord:t,matchUpFormats:e,categoryType:n,event:r}){if(!t)return{error:$};if(!r)return{error:At};let i,a=[];if(e?.length){const t=[];a=e.map((e=>{const n="string"==typeof e?{matchUpFormat:e}:e;if(!t.includes(n?.matchUpFormat)&&Ti(n?.matchUpFormat))return t.push(n.matchUpFormat),n})).filter(Boolean)}else{const{policy:e}=ns({policyType:oo,tournamentRecord:t,event:r});if(e?.matchUpFormats)a=e?.matchUpFormats;else{const{extension:t}=ys({name:Oo,event:r});let e,n;({matchUpAverageTimes:e,matchUpRecoveryTimes:n}=t?.value?t.value:xf[ro]),a=T([...(e||[]).map((t=>t.matchUpFormatCodes)),...(n||[]).map((t=>t.matchUpFormatCodes))].flat()).map((t=>({matchUpFormat:t}))),i="default scheduling policy in use"}}const{eventType:o,eventId:s,category:c}=r,u=c?.categoryName??c?.ageCategoryCode??s;if(!s)return{error:At};return di({eventMatchUpFormatTiming:a.map((({matchUpFormat:e,description:i})=>({matchUpFormat:e,description:i,...Fs({tournamentRecord:t,matchUpFormat:e,categoryName:u,categoryType:n,eventType:o,event:r})}))),info:i})}function QU({tournamentRecords:t,schedulingProfile:e}){if(!e)return{valid:!0};if(!Array.isArray(e))return{valid:!1,error:xn};const{venueIds:n,tournamentsMap:r}=function(t){const e=t?.tournamentRecords&&Object.values(t?.tournamentRecords)||[],n={},{venueIds:r,eventIds:i,drawIds:a,structureIds:o,tournamentIds:s}=e.reduce(((t,e)=>{const{tournamentIds:r,tournamentMap:i,structureIds:a,venueIds:o,eventIds:s,drawIds:c}=XU({tournamentRecord:e});return o.forEach((e=>{t.venueIds.includes(e)||t.venueIds.push(e)})),t.tournamentIds.push(...r),t.structureIds.push(...a),t.eventIds.push(...s),t.drawIds.push(...c),Object.assign(n,i),t}),{tournamentIds:[],structureIds:[],venueIds:[],eventIds:[],drawIds:[]});return{tournamentsMap:n,tournamentIds:s,structureIds:o,venueIds:r,eventIds:i,drawIds:a}}({tournamentRecords:t});let i,a;const o=e.every((t=>{const{scheduleDate:e,venues:o}=t;return!!Cr(e)&&o.every((t=>{const{venueId:e,rounds:o}=t;if("string"!=typeof e)return a="venueId should be a string",!1;if(!Array.isArray(o))return a="rounds should be an array",!1;if(!n.includes(e))return i=mn,!1;return!!o.every((t=>{if(!t)return a="empty round",!1;const{roundSegment:e,tournamentId:n,structureId:i,roundNumber:o,eventId:s,drawId:c}=t,u=r?.[n]?.[s]?.[c]?.[i],d=u?.includes(o);d||(a="Invalid rounds");const{segmentNumber:p,segmentsCount:l}=e||{},m=!e||v(p)&&f(l)&&p<=l;return m||(a="Invalid segment"),d&&m}))}))}));return o||i||(i=xn),{valid:!!o,error:i,info:a}}function XU(t){const{tournamentRecord:e={},tournamentMap:n={},requireCourts:r}=t,i=[],a=[],o=[],s=[],c=(e?.venues||[]).map((({venueId:t,courts:e})=>(!r||e?.length)&&t)),u=e?.tournamentId;if(u){i.push(u),n[u]={};(e?.events||[]).forEach((t=>{const e=t.eventId;o.push(e),n[u][e]={},(t.drawDefinitions||[]).forEach((t=>{const r=t.drawId;s.push(r),n[u][e][r]={};const{structures:i}=Yd({drawDefinition:t});(i||[]).forEach((t=>{const i=t.structureId,{matchUps:o}=qp({structure:t}),{roundMatchUps:s}=Gu({matchUps:o}),c=s&&Object.keys(s).map((t=>parseInt(t)));n[u][e][r][i]=c,a.push(i),t.structures?.length&&t.structures.forEach((t=>{a.push(t.structureId),n[u][e][r][t.structureId]=c}))}))}))}))}return{tournamentMap:n,tournamentIds:i,structureIds:a,venueIds:c,eventIds:o,drawIds:s}}function ZU({defaultRecoveryMinutes:t=0,defaultAverageMinutes:e,tournamentRecords:n,matchUpFormat:r,categoryName:i,categoryType:a,tournamentId:o,eventType:s,eventId:c}){if(!Ti(r))return{error:Gt};let u;return Object.keys(n).filter((t=>!o||t===o)).forEach((t=>{if(u)return;const e=n[t],o=c?Ls({tournamentRecord:e,eventId:c})?.event:void 0;return u=Fs({tournamentRecord:e,matchUpFormat:r,categoryName:i,categoryType:a,eventType:s,event:o}),u?.averageMinutes||u?.recoveryMinutes})),{recoveryMinutes:u?.recoveryMinutes||t,averageMinutes:u?.averageMinutes||e,typeChangeRecoveryMinutes:u?.typeChangeRecoveryMinutes||u?.recoveryMinutes||t}}function ty({scheduleCompletedMatchUps:t,containedStructureIds:e,tournamentRecords:n,periodLength:r=30,matchUps:i,rounds:a}){if("object"!=typeof n)return{error:q};if(!Array.isArray(a))return{error:me,info:Ci("rounds")};const o={},s=[];a.sort(((t,e)=>(t.sortOrder??0)-(e.sortOrder??0))),e=e??Object.assign({},...Object.values(n).map((t=>LI({tournamentRecord:t}).containedStructures))),i||({matchUps:i}=ch({nextMatchUps:!0,tournamentRecords:n}));let c=0;const u={},d={},p={},l=a.flatMap((a=>{const l=a.periodLength||r,m=[];e?.[a.structureId]?m.push(...e[a.structureId]):m.push(a.structureId);let h=i?Cp({tournamentIds:[a.tournamentId],roundNumbers:[a.roundNumber],matchUpIds:a.matchUpIds,eventIds:[a.eventId],drawIds:[a.drawId],processContext:!0,structureIds:m,matchUps:i}).sort(dh):[];const{segmentNumber:I,segmentsCount:g}=a.roundSegment||{};if(v(I)&&f(h?.length)&&f(g)&&I>0&&I<=g&&g<h?.length&&!a.matchUpIds?.length){const t=h.length/g,e=t*(I-1);h=h.slice(e,e+t)}const U=n[a.tournamentId],y=Ls({drawId:a.drawId,tournamentRecord:U}).event,S=[];for(const t of h){const e=t.matchUpFormat;e&&(o[e]||(o[e]=[],o[e].push(t)),S.push(e))}for(const e of S){const{eventType:r,category:i}=y??{},{categoryName:o,ageCategoryCode:m}=i??{},{typeChangeRecoveryMinutes:f,recoveryMinutes:I,averageMinutes:g,error:U}=ZU({categoryName:o??m,categoryType:i?.categoryType,tournamentId:a.tournamentId,eventId:a.eventId,tournamentRecords:n,matchUpFormat:e,eventType:r});if(U)return{error:U,round:a};const S=h.filter((e=>(t||!fa.includes(e.matchUpStatus))&&e.matchUpStatus!==Ki)).map(hl);S.forEach((t=>{p[t]={typeChangeRecoveryMinutes:f,recoveryMinutes:I,averageMinutes:g},u[t]=I,d[t]=g})),s.push(...S),c=Math.max(g||0,c);return{roundPeriodLength:l,recoveryMinutes:I,averageMinutes:g,matchUpIds:S,hash:`${g}|${l}`}}}));return{scheduledRoundsDetails:l,greatestAverageMinutes:c,matchUpFormatCohorts:o,recoveryMinutesMap:u,averageMinutesMap:d,orderedMatchUpIds:s,minutesMap:p,...L}}function ey({tournamentRecord:t}){if(!t)return{error:$};const e=(({tournamentId:t,tournamentRank:e,tournamentStatus:n,formalName:r,tournamentName:i,promotionalName:a,onlineResources:o,localTimeZone:s,startDate:c,endDate:u,hostCountryCode:d,tournamentContacts:p,tournamentAddresses:l})=>({tournamentId:t,tournamentRank:e,tournamentStatus:n,formalName:r,tournamentName:i,promotionalName:a,onlineResources:o,localTimeZone:s,startDate:c,endDate:u,hostCountryCode:d,tournamentContacts:p,tournamentAddresses:l}))(t);return{...L,tournamentInfo:ri(e,!1,!0)}}function ny({tournamentRecords:t}){const e=Object.keys(t).reduce(((e,n)=>{const r=t[n],{tournamentInfo:{startDate:i,endDate:a}}=ey({tournamentRecord:r}),o=i&&new Date($r(i));(!e.startDate||o&&o<e.startDate)&&(e.startDate=o);const s=a&&new Date($r(a));return(!e.endDate||s&&s>e.endDate)&&(e.endDate=s),e}),{startDate:void 0,endDate:void 0}),n=e.startDate&&$r(e.startDate.toISOString()),r=e.endDate&&$r(e.endDate.toISOString());return n&&r?{startDate:n,endDate:r}:{error:fe}}function ry({tournamentRecords:t}){if("object"!=typeof t||!Object.keys(t).length)return{error:q};const{extension:e}=Ks({name:Fo,tournamentRecords:t});let n=e?.value||[];if(n.length){const{venueIds:e}=cI({requireCourts:!0,tournamentRecords:t}),{eventIds:r,drawIds:i}=bI({tournamentRecords:t}),{updatedSchedulingProfile:a,modifications:o,issues:s}=oy({schedulingProfile:n,venueIds:e,eventIds:r,drawIds:i});if(o){n=a;const e=iy({tournamentRecords:t,schedulingProfile:n});return e.error?e:{schedulingProfile:n,modifications:o,issues:s}}}return{schedulingProfile:n,modifications:0}}function iy({tournamentRecords:t,schedulingProfile:e}){const n=QU({tournamentRecords:t,schedulingProfile:e});if(n.error)return n;if(!e)return Js({tournamentRecords:t,name:Fo});return Ys({tournamentRecords:t,extension:{name:Fo,value:e}})}function ay({tournamentRecords:t,scheduleDate:e,venueId:n,round:r}){if(!Cr(e))return{error:ye};const{extension:i}=Ks({tournamentRecords:t,name:Fo}),a=i?.value||[];let o=a.find((t=>ei(e,t.scheduleDate)));if(!o){const{startDate:n,endDate:r}=ny({tournamentRecords:t}),i=new Date(e);if(n&&i<new Date(n)||r&&i>new Date(r))return{error:ye};o={scheduleDate:e,venues:[]},a.push(o)}let s=o.venues.find((t=>t.venueId===n));s||(s={venueId:n,rounds:[]},o.venues.push(s));const c=["notBeforeTime"],u=t=>Object.keys(t).filter((t=>!c.includes(t))).sort().map((e=>si(t[e])?u(t[e]):t[e])).flat().join("|");if(s.rounds.find((t=>u(t)===u(r))))return Oi({result:{error:Tt},stack:"addSchedulingProfileRound"});s.rounds.push(r);const d=iy({tournamentRecords:t,schedulingProfile:a});return d.error?d:{...L}}function oy({schedulingProfile:t,venueIds:e,eventIds:n,drawIds:r}){const i=[],a=t?.map((t=>{const a=$r(t?.scheduleDate);if(!a)return void i.push(`Invalid date: ${t?.scheduledDate}`);const o=(t?.venues||[]).map((t=>{const{rounds:a,venueId:o}=t;if(!e.includes(o))return void i.push(`Missing venueId: ${o}`);const s=a.filter((t=>{const e=n.includes(t.eventId)&&r.includes(t.drawId);return e||i.push(`Invalid eventId: ${t.eventId} or drawId: ${t.drawId}`),e}));return s.length?{venueId:o,rounds:s}:void 0})).filter(Boolean);return o.length&&a&&{...t,venues:o}})).filter(Boolean);return{updatedSchedulingProfile:a,modifications:i.length,issues:i}}function sy({tournamentRecords:t}){const{schedulingProfile:e}=ry({tournamentRecords:t});if(e){const{venueIds:n}=cI({tournamentRecords:t}),{eventIds:r,drawIds:i}=bI({tournamentRecords:t}),{updatedSchedulingProfile:a,modifications:o}=oy({schedulingProfile:e,venueIds:n,eventIds:r,drawIds:i});if(o)return iy({tournamentRecords:t,schedulingProfile:a})}return{...L}}function cy({schedulingProfile:t,matchUps:e=[]}){const n={},r=({eventId:t,drawId:e,structureId:n,roundNumber:r})=>`${t}|${e}|${n}${r}`;if(t?.length){t.map((({venues:t})=>t.map((({rounds:t})=>t)))).flat().forEach((t=>{t.sort(((t,e)=>(t.sortOrder||0)-(e.sortOrder||0))).forEach((({eventId:t,drawId:e,structureId:i,roundNumber:a},o)=>{const s=r({eventId:t,drawId:e,structureId:i,roundNumber:a});n[s]=o}))}))}const i=[],a={noScheduledDate:[]};for(const s of e){const t=s.schedule||{},e=t.scheduledDate&&$r(t.scheduledDate)||t.scheduledTime&&$r(t.scheduledTime)||"noScheduledDate";a[e]||(a[e]=[]),a[e].push(s)}const o=Object.keys(a).sort();for(const s of o){const t=a[s],e={noScheduledTime:[]};for(const n of t){const t=n.schedule||{},r=t.scheduledTime&&qr(t.scheduledTime)||"noScheduledTime";e[r]||(e[r]=[]),e[r].push(n)}const o=Object.keys(e).sort();for(const a of o){const t=e[a];t.sort(((t,e)=>(n[r(t)]||0)-(n[r(e)]||0))),i.push(...t)}}return i}function uy(t){if("object"!=typeof t?.tournamentRecords||!Object.keys(t?.tournamentRecords).length)return{error:q};const{courts:e,venues:n}=sI(t),r=ry(t).schedulingProfile,{sortDateMatchUps:i=!0,courtCompletedMatchUps:a,alwaysReturnCompleted:o,activeTournamentId:s,tournamentRecords:c,withCourtGridRows:u,minCourtGridRows:d,usePublishState:p,status:l=su,sortCourtsData:m}=t,f=p?Hf({tournamentRecord:c[s??Ir()],itemType:`${ou}.${cu}`}).timeItem:void 0,h=f?.itemValue?.[l],I=o?uh({...t,matchUpFilters:{...t.matchUpFilters,matchUpStatuses:[Vi.Completed]},contextFilters:t.contextFilters}).completedMatchUps:[];if(p&&(!h||!Object.keys(h).length))return{completedMatchUps:I,dateMatchUps:[],courtsData:[],venues:n};const g=p?function({tournamentRecords:t}){const e=[];for(const n of Object.values(t))for(const t of n.events??[]){const{timeItem:n}=Wf({itemType:`${ou}.${cu}`,event:t}),r=n?.itemValue?.[su];if(r?.drawIds?.length)e.push(...r.drawIds);else{const n=(t.drawDefinitions??[]).map((({drawId:t})=>t)).filter(Boolean);e.push(...n)}}return{drawIds:e}}({tournamentRecords:c}).drawIds:void 0;g?.length&&(t.contextFilters||(t.contextFilters={}),t.contextFilters?.drawIds?t.contextFilters.drawIds=t.contextFilters.drawIds.filter((t=>g.includes(t))):t.contextFilters.drawIds=g),h?.eventIds?.length&&(t.matchUpFilters||(t.matchUpFilters={}),t.matchUpFilters?.eventIds&&t.matchUpFilters.eventIds.length?t.matchUpFilters.eventIds=t.matchUpFilters.eventIds.filter((t=>h.eventIds.includes(t))):t.matchUpFilters.eventIds=h.eventIds),h?.scheduledDates?.length&&(t.matchUpFilters||(t.matchUpFilters={}),t.matchUpFilters.scheduledDates&&t.matchUpFilters.scheduledDates.length?t.matchUpFilters.scheduledDates=t.matchUpFilters.scheduledDates.filter((t=>h.scheduledDates.includes(t))):t.matchUpFilters.scheduledDates=h.scheduledDates),o&&(t.matchUpFilters||(t.matchUpFilters={}),t.matchUpFilters?.excludeMatchUpStatuses?.length?t.matchUpFilters.excludeMatchUpStatuses.includes(Qi)||t.matchUpFilters.excludeMatchUpStatuses.push(Qi):t.matchUpFilters.excludeMatchUpStatuses=[Qi]);const{completedMatchUps:U,upcomingMatchUps:y,pendingMatchUps:S}=uh({...t,matchUpFilters:t.matchUpFilters,contextFilters:t.contextFilters}),v=[...y??[],...S??[]],w=i?cy({matchUps:v,schedulingProfile:r}):v,T=e?.map((t=>{const e=function({courtId:t}){const e=(a?w.concat(U??[]):w).filter((e=>e.schedule?.courtId===t||e.schedule?.allocatedCourts?.map((({courtId:t})=>t)).includes(t)));return m?cy({matchUps:e,schedulingProfile:r}):e}(t);return{surfaceCategory:t?.surfaceCategory??"",matchUps:e,...t}})),P={courtsData:T,completedMatchUps:o?I:U,dateMatchUps:w,venues:n};if(u){const{rows:t,courtPrefix:e}=Kg({minRowsCount:d,courtsData:T});P.courtPrefix=e,P.rows=t}return P}function dy({calculateStartTimeFromCourts:t=!0,defaultRecoveryMinutes:e=0,averageMatchUpMinutes:n=90,remainingScheduleTimes:r,clearScheduleDates:i,tournamentRecords:a,periodLength:o,scheduleDate:s,startTime:c,venueIds:u,endTime:d}){if("object"!=typeof a||!Object.keys(a).length)return{error:q};o=o||Ph({recoveryMinutes:e,averageMatchUpMinutes:n});const{courts:p,venues:l}=sI({dates:[s],ignoreDisabled:!0,tournamentRecords:a}),m=p?.filter((t=>!u||u.includes(t.venueId)));c||(c=m?.reduce(((t,e)=>{const n=e.dateAvailability?.find((t=>!t.date||ei(s,t.date))),r=n?.startTime||e.startTime;return r&&(!t||jr(r)<jr(t))?r:t}),void 0)),d||(d=m?.reduce(((t,e)=>{const n=e.dateAvailability?.find((t=>!t.date||ei(s,t.date))),r=n?.endTime||e.endTime;return r&&(!t||jr(r)>jr(t))?r:t}),void 0));const f=Object.values(a),h=Object.assign({},...f.map((t=>(t.events||[]).map((e=>{const{scheduleTiming:n}=vs({tournamentRecord:t,event:e});return{[e.eventId]:{event:e,scheduleTiming:n}}})))).flat()),I=uy({sortDateMatchUps:!1,tournamentRecords:a,matchUpFilters:{scheduledDate:s,venueIds:u}}),g=I?.dateMatchUps||[],U=I?.completedMatchUps||[],y=[];y.push(...g),y.push(...U);const S={averageTimes:[{minutes:{default:n}}],recoveryTimes:[{minutes:{default:e}}]},v=y?.map((({eventId:t,schedule:e,matchUpFormat:n})=>{const{event:r,scheduleTiming:i}=h[t],a=r?.eventType,s={...i,defaultTiming:S,matchUpFormat:n},{averageMinutes:c,recoveryMinutes:u}=ks({eventType:a,timingDetails:s}),{courtId:d,venueId:p}=e,l=qr(e.scheduledTime),m=Xr(l,c);return{recoveryMinutes:u,averageMinutes:c,periodLength:o,startTime:l,endTime:m,courtId:d,venueId:p}})),w={calculateStartTimeFromCourts:t,remainingScheduleTimes:r,averageMatchUpMinutes:n,date:s,clearScheduleDates:i,periodLength:o,startTime:c,endTime:d,bookings:v,courts:m},{scheduleTimes:T}=Rh(w);return{venueId:1===u?.length&&u[0]||1===l?.length&&l[0].venueId||void 0,scheduleTimes:T,dateScheduledMatchUpIds:y.map(hl)}}function py({matchUpScheduleTimes:t,matchUpDependencies:e,allDateMatchUpIds:n,matchUp:r}){const i=(e?.[r.matchUpId]?.matchUpIds||[]).filter((t=>n.includes(t))),a=i.filter((e=>!t[e]));return{dependenciesScheduled:!a?.length,remainingDependencies:a}}function ly({matchUpPotentialParticipantIds:t,matchUpNotBeforeTimes:e,timeAfterRecovery:n,matchUp:r}){const{individualParticipantIds:i}=sh(r);n=n||r.schedule?.timeAfterRecovery;const a=e=>{t[e]||(t[e]=[]),t[e]=T(t[e].concat(...i))},o=t=>{n&&(!e[t]||n>e[t])&&(e[t]=n)},s=r.winnerTo?.matchUpId||r.winnerMatchUpId;s&&(n&&o(s),a(s));const c=r.loserTo?.matchUpId||r.loserMatchUpId;c&&(n&&o(c),a(c)),r.sidesTo?.length&&r.sidesTo.forEach((({matchUpId:t})=>{t&&(n&&o(t),a(t))}))}function my({individualParticipantProfiles:t,participantId:e}){t[e]||(t[e]={typeChangeTimeAfterRecovery:void 0,timeAfterRecovery:void 0,priorMatchUpType:void 0,potentialRecovery:{},potentialCounted:{},potentialBookings:{},bookings:[],counters:{}})}function fy({matchUpPotentialParticipantIds:t,individualParticipantProfiles:e,typeChangeRecoveryMinutes:n,averageMatchUpMinutes:r=0,matchUpNotBeforeTimes:i,matchUpDependencies:a,recoveryMinutes:o=0,scheduleTime:s,matchUp:c}){const u=qr(c?.schedule?.endTime),d=u?Xr(u,m(o)):Xr(s,m(r)+m(o)),p=n&&(u?Xr(qr(u),n):Xr(s,m(r)+m(n))),l=a?.[c.matchUpId]?.participantIds||[],f=(c.roundPosition&&t[c.matchUpId]||[]).flat();l.forEach((t=>{my({individualParticipantProfiles:e,participantId:t});const n=e[t].priorMatchUpType!==c.matchUpType&&p||d;f.includes(t)?function({individualParticipantProfiles:t,recoveryValue:e,participantId:n,scheduleTime:r,drawId:i}){t[n].potentialRecovery[i]||(t[n].potentialRecovery[i]=[]),t[n].potentialRecovery[i].push(e),t[n].potentialBookings[i]||(t[n].potentialBookings[i]=[]),t[n].potentialBookings[i].push({timeAfterRecovery:e,scheduleTime:r})}({individualParticipantProfiles:e,drawId:c.drawId,recoveryValue:n,participantId:t,scheduleTime:s}):(e[t].timeAfterRecovery=n,e[t].bookings.push({scheduleTime:s,timeAfterRecovery:n}))})),ly({matchUpPotentialParticipantIds:t,matchUpNotBeforeTimes:i,timeAfterRecovery:d,matchUp:c})}function hy({matchUpScheduleTimes:t,matchUpDependencies:e,scheduleTime:n,matchUpId:r,details:i}){let a;const o=i.minutesMap?.[r]?.recoveryMinutes,s=i.minutesMap?.[r]?.averageMinutes,c=Xr(n,(s||0)+(o||0)),u=e?.[r]?.dependentMatchUpIds||[];if(u.length){const e=u.reduce(((e,n)=>{const r=t[n];if(!r)return e;const i={scheduleTime:r,matchUpId:n};return r&&!e.matchUpId||jr(r)<jr(e.scheduleTime)?i:e}),{});e.scheduleTime&&jr(c)>jr(e.scheduleTime)&&(a=e)}return{scheduledDependent:a}}const Iy="DO_NOT_SCHEDULE",gy={DO_NOT_SCHEDULE:Iy};function Uy({averageMatchUpMinutes:t=90,requestConflicts:e={},potentials:n=!0,personRequests:r,scheduleTime:i,scheduleDate:a,matchUp:o}){const s=function(t){const{sides:e,matchUpType:n}=t||{};return(e||[]).map((t=>n===Aa&&(t?.participant?.individualParticipants||[])||t?.participant&&[t.participant]||[])).flat()}(o).map((({person:t})=>t?.personId));if(n){const t=(o?.potentialParticipants||[]).flat().map((({person:t})=>t?.personId));s.push(...t)}const c=s.map((t=>r[t]?.map((e=>({...e,personId:t}))))).filter(Boolean).flat().filter((t=>t.requestType===Iy&&ei(a,t.date))),u=[],d=o?.matchUpId,p=Jr(qr(i),$r(a)),l=qr(Zr(p,t).toISOString());for(const m of c){const{requestId:t,startTime:n,endTime:r}=m;(i>n&&i<r||l>n&&l<r)&&(u.push({matchUpId:d,request:m,scheduleTime:i}),e[t]?(e[t].scheduleTimes.includes(i)||e[t].scheduleTimes.push(i),e[t].matchUpIds.includes(d)||e[t].matchUpIds.push(d)):e[t]={request:m,scheduleTimes:[i],matchUpIds:[d]})}return{conflicts:u}}function yy({matchUpPotentialParticipantIds:t,individualParticipantProfiles:e,matchUp:n,value:r}){const{matchUpType:i}=n,{individualParticipantIds:a}=sh(n),o=(t[n.matchUpId]||[]).filter((t=>!k(t,a))).flat();[...a,...o].forEach((t=>{if(my({individualParticipantProfiles:e,participantId:t}),!e[t].potentialCounted[n.drawId]){const a=e[t].counters;a[i]?a[i]+=r:r>0&&(a[i]=r),a[Ps]?a[Ps]+=r:r>0&&(a[Ps]=r),o.includes(t)&&(e[t].potentialCounted[n.drawId]=!0)}}))}const Sy=({scheduleAttributes:t=["scheduledDate","scheduledTime"],schedule:e={}})=>!!Object.keys(e).filter((e=>t.includes(e))).filter((t=>e[t])).length;function vy({matchUpPotentialParticipantIds:t,individualParticipantProfiles:e,dateScheduledMatchUpIds:n,greatestAverageMinutes:r,dateScheduledMatchUps:i,matchUpNotBeforeTimes:a,matchUpScheduleTimes:o,matchUpDependencies:s,clearScheduleDates:c,scheduleDate:u,minutesMap:d,matchUps:p}){n||(i=p?.filter((t=>{const e=t.schedule||{};return Sy({schedule:e})&&(!u||t.schedule.scheduledDate===u)})),n=i.map(hl));const l=Array.isArray(c)?c.includes(u):c,m=l?[]:p.filter((({matchUpId:t})=>n.includes(t)));for(const f of m){yy({matchUpPotentialParticipantIds:t,individualParticipantProfiles:e,value:1,matchUp:f});const n=f.schedule?.scheduledTime;if(n){o[f.matchUpId]=n;const i=d?.[f.matchUpId]?.recoveryMinutes;fy({individualParticipantProfiles:e,matchUpPotentialParticipantIds:t,matchUpNotBeforeTimes:a,matchUpDependencies:s,averageMatchUpMinutes:r,recoveryMinutes:i,scheduleTime:n,matchUp:f})}}return{clearDate:l,dateScheduledMatchUpIds:n,dateScheduledMatchUps:i}}function wy({scheduledRoundsDetails:t,greatestAverageMinutes:e,garmanSinglePass:n}){const r=[];let i,a,o,s,c=[];for(const u of t.filter(Boolean))s||(s=u.hash),(u.hash===s||n)&&(c=c.concat(u.matchUpIds)),u.hash===s||n||(s=u.hash,r.push({averageMinutes:o,recoveryMinutes:a,roundPeriodLength:i,matchUpIds:c}),c=u.matchUpIds),o=n?e:u.averageMinutes,a=u.recoveryMinutes,i=u.roundPeriodLength;return c.length&&r.push({averageMinutes:o,recoveryMinutes:a,roundPeriodLength:i,matchUpIds:c}),{groupedRounds:r}}function Ty({matchUpPotentialParticipantIds:t,scheduleCompletedMatchUps:e,dateScheduledMatchUpIds:n,matchUpNotBeforeTimes:r,matchUpScheduleTimes:i,orderedMatchUpIds:a,clearDate:o,matchUps:s}){const c=Object.keys(i),u=a.map((t=>s.find((e=>e.matchUpId===t)))).filter(Boolean).filter((t=>{const r=!o&&(n.includes(t.matchUpId)||c.includes(t.matchUpId)),i=[Ki,Zi,Qi,zi,aa,ca,ea,ta].includes(t?.matchUpStatus);return e||!r&&!t.winningSide&&!i})),{matchUpMap:d}=u.reduce(((e,n)=>{const{drawId:i,tournamentId:a}=n;return e.matchUpMap[a]||(e.matchUpMap[a]={}),e.matchUpMap[a][i]?e.matchUpMap[a][i].push(n):e.matchUpMap[a][i]=[n],ly({matchUpPotentialParticipantIds:t,matchUpNotBeforeTimes:r,matchUp:n}),e}),{matchUpMap:{}});return{matchUpsToSchedule:u,matchUpMap:d}}function Py({defaultRecoveryMinutes:t=0,averageMatchUpMinutes:e=90,dateScheduledMatchUps:n,tournamentRecords:r,venueIds:i=[],periodLength:a,scheduleDate:o,matchUps:s}){if("object"!=typeof r)return{error:q};if(!Sa(s)&&!Array.isArray(n))return{error:Zt};a=a||Ph({recoveryMinutes:t,averageMatchUpMinutes:e});const c=Object.assign({},...Object.values(r).map((t=>(t.events||[]).map((e=>{const{scheduleTiming:n}=vs({tournamentRecord:t,event:e});return{[e.eventId]:{event:e,scheduleTiming:n}}})))).flat()),u={averageTimes:[{minutes:{default:e}}],recoveryTimes:[{minutes:{default:t}}]};n||(n=s?.filter((t=>{const e=t.schedule;return Sy({schedule:e})&&(!o||t.schedule.scheduledDate===o)})));const d=n?.filter((t=>!i.length||i.includes(t.schedule.venueId))),p=d?.map((({eventId:t,schedule:e,matchUpFormat:n})=>{const{event:r,scheduleTiming:i}=c[t],o=r?.eventType,s={...i,defaultTiming:u,matchUpFormat:n},{averageMinutes:d,recoveryMinutes:p}=ks({timingDetails:s,eventType:o}),{courtId:l,venueId:m}=e,f=qr(e.scheduledTime),h=Xr(f,d);return{recoveryMinutes:p,averageMinutes:d,periodLength:a,startTime:f,courtId:l,endTime:h,venueId:m}})).filter(Boolean);return{bookings:p,relevantMatchUps:d,dateScheduledMatchUps:n}}function Dy({calculateStartTimeFromCourts:t=!0,remainingScheduleTimes:e,defaultRecoveryMinutes:n,averageMatchUpMinutes:r,clearScheduleDates:i,tournamentRecords:a,tournamentRecord:o,periodLength:s,scheduleDate:c,startTime:u,venueIds:d,matchUps:p,endTime:l}){if(o&&!a&&(a={[o.tournamentId]:o}),"object"!=typeof a||!Object.keys(a).length)return{error:q};s=s??Ph({recoveryMinutes:n,averageMatchUpMinutes:r});const{courts:m,venues:f}=sI({dates:[c],ignoreDisabled:!0,tournamentRecords:a}),h=m?.filter((t=>!d||d.includes(t.venueId)))??[];u=u??Dh({courts:h,scheduleDate:c,startTime:!0}),l=l??Dh({courts:h,scheduleDate:c,endTime:!0});const{bookings:I,dateScheduledMatchUps:g}=Py({defaultRecoveryMinutes:n,averageMatchUpMinutes:r,tournamentRecords:a,scheduleDate:c,periodLength:s,venueIds:d,matchUps:p}),U={calculateStartTimeFromCourts:t,remainingScheduleTimes:e,averageMatchUpMinutes:r,clearScheduleDates:i,date:c,periodLength:s,startTime:u,bookings:I,endTime:l,courts:h},{scheduleTimes:y}=Rh(U),S=1===d?.length&&d[0]||1===f?.length&&f[0].venueId||void 0,v=g?.map(ui("matchUpId"));return{dateScheduledMatchUpIds:v,dateScheduledMatchUps:g,scheduleTimes:y,venueId:S}}function Ny({matchUpPotentialParticipantIds:t,individualParticipantProfiles:e,scheduleCompletedMatchUps:n,containedStructureIds:r,matchUpNotBeforeTimes:i,matchUpScheduleTimes:a,matchUpDependencies:o,clearScheduleDates:s,tournamentRecords:c,periodLength:u,scheduleDate:d,useGarman:p,matchUps:l,courts:m,venues:f}){const h={},I=[],g=[];for(const U of f){const{rounds:f=[],venueId:y}=U,{scheduledRoundsDetails:S,greatestAverageMinutes:v,orderedMatchUpIds:w,minutesMap:T}=ty({scheduleCompletedMatchUps:n,containedStructureIds:r,tournamentRecords:c,periodLength:u,matchUps:l,rounds:f});g.push(...w??[]);const{groupedRounds:P}=wy({scheduledRoundsDetails:S,greatestAverageMinutes:v,garmanSinglePass:!0});let D,N,R=[];p&&({scheduleTimes:R,dateScheduledMatchUpIds:D,dateScheduledMatchUps:N}=Dy({averageMatchUpMinutes:P[0]?.averageMinutes,scheduleDate:$r(d),venueIds:[U.venueId],clearScheduleDates:s,tournamentRecords:c,periodLength:u,matchUps:l}));const b=vy({matchUpPotentialParticipantIds:t,individualParticipantProfiles:e,dateScheduledMatchUpIds:D,greatestAverageMinutes:v,matchUpNotBeforeTimes:i,matchUpScheduleTimes:a,matchUpDependencies:o,clearScheduleDates:s,scheduleDate:d,minutesMap:T,matchUps:l}),M=b.clearDate;({dateScheduledMatchUpIds:D,dateScheduledMatchUps:N}=b);const{matchUpsToSchedule:A,matchUpMap:E}=Ty({matchUpPotentialParticipantIds:t,scheduleCompletedMatchUps:n,dateScheduledMatchUpIds:D,matchUpNotBeforeTimes:i,matchUpScheduleTimes:a,orderedMatchUpIds:w,clearDate:M,matchUps:l}),C=m.filter((t=>t.venueId===y));h[y]={previousRemainingScheduleTimes:[],courtsCount:C.length,greatestAverageMinutes:v,scheduledRoundsDetails:S,dateScheduledMatchUps:N,matchUpsToSchedule:A,scheduleTimes:R,groupedRounds:P,venueCourts:C,minutesMap:T,matchUpMap:E},s||I.push(...D)}return{allDateScheduledMatchUpIds:I,venueScheduledRoundDetails:h,allDateMatchUpIds:g}}function Ry({individualParticipantProfiles:t,matchUpNotBeforeTimes:e,matchUpDependencies:n,scheduleTime:r,matchUp:i,details:a}){const o=(n?.[i.matchUpId]?.participantIds||[]).flat(),s=a?.minutesMap?.[i.matchUpId]?.averageMinutes||0,c=a?.minutesMap?.[i.matchUpId]?.recoveryMinutes||0,u=o.every((e=>{my({individualParticipantProfiles:t,participantId:e});const n=t[e];if(!n.timeAfterRecovery)return!0;const a=qr(i?.schedule?.endTime),o=a?Xr(a,m(c)):Xr(r,m(s)+m(c));return!!![...Object.keys(n.potentialBookings).filter((t=>t!==i.drawId)).map((t=>n.potentialBookings[t])).flat(),...n.bookings].find((t=>function(t,e){const n=jr(t.scheduleTime),r=jr(t.timeAfterRecovery),i=jr(e.scheduleTime),a=jr(e.timeAfterRecovery),o=n>i&&n<a,s=i>n&&i<r,c=r>i&&r<a,u=a>n&&a<r;return di({hasOverlap:n===i||r===a||o||c||s||u,startAisContained:o,endAisContained:c,startBisContained:s,endBisContained:u},!0)}({scheduleTime:r,timeAfterRecovery:o},t).hasOverlap))})),d=e[i.matchUpId],p=d?Qr(Jr(d),Jr(r),!1):0;return{enoughTime:u&&p>=0}}function by({individualParticipantProfiles:t,matchUpPotentialParticipantIds:e,matchUpDailyLimits:n={},matchUp:r}){const{matchUpId:i,matchUpType:a}=r,{enteredIndividualParticipantIds:o}=sh(r),s=(r.roundPosition&&e[i]||[]).flat(),c=T(o.concat(...s));c.forEach((e=>{my({individualParticipantProfiles:t,participantId:e})}));return{participantIdsAtLimit:c.filter((e=>{const r=t[e];if(r)return[a,Ps].find((t=>{const e=r.counters?.[t]||0,i=n[t]||0;return e&&i&&e>=i}))})),relevantParticipantIds:c}}const My="deleteDrawDefinitions",Ay="autoSchedulingAudit",Ey="deleteEvents",Cy={AUTO_SCHEDULING_AUDIT:Ay,DELETE_EVENTS:Ey,DELETE_DRAW_DEFINITIONS:My};function Oy({autoSchedulingAudit:t,tournamentRecords:e}){dr({topic:sc,payload:t});const n=t=>{if(!t)return 0;return Object.values(t).reduce(((t,e)=>t+e.length||0),0)},r=(t?.schedulingProfile||[]).reduce(((t,e)=>t+e.venues.reduce(((t,e)=>t+e.rounds.length),0)),0),i={scheduledDatesCount:t.scheduledDates?.length,noTimeMatchUpIdsCount:n(t?.noTimeMatchUpIds),scheduledMatchUpIdsCount:n(t?.scheduledMatchUpIds),overLimitMatchUpIdsCount:n(t?.overLimitMatchUpIds),requestConflictsCount:n(t?.requestConflicts),profileRoundsCount:r},a={itemType:Ay,itemValue:i};for(const o of Object.values(e))pI({tournamentRecord:o,timeItem:a})}function Fy({averageMinutes:t,startTime:e,endTime:n,court:r,date:i}){if(!Array.isArray(r.dateAvailability))return{error:me,stack:"getEarliestCourtTime"};const a=Dh({scheduleDate:i,courts:[r],startTime:!0}),o=Dh({scheduleDate:i,courts:[r],endTime:!0});e=e||a,n=n||o;const s=vh({courtDate:Sh({court:r,date:i})}),c=Jr(e),u=Jr(n);return{earliestCourtTime:s.reduce(((e,n)=>{const r=Jr(n.startTime),i=Jr(n.endTime);if(r>u||i<c)return e;const a=c>r?c:r;if(Qr(a,i)>=t){const t=qr(a.toISOString());(!e||t<e)&&(e=t)}return e}),void 0),courtStartTime:a,courtEndTime:o}}function ky({tournamentRecords:t,requestType:e}){if("object"!=typeof t||!Object.keys(t).length)return{error:q};const n={};for(const r of Object.values(t)){const{extension:t}=Us({name:Mo,tournamentRecord:r}),i=t?.value||[];for(const r of i){const{personId:t,requests:i}=r||{};n[t]||(n[t]=[]);for(const r of i)e&&r.requestType!==e||n[t].push(r)}}return{personRequests:n}}function xy({tournamentRecords:t,personRequests:e}){if(!t)return{error:q};if(!e)return{...L};const n=Object.values(t);for(const r of n){const t=r.participants??[],n=[];for(const r of Object.keys(e))if(fs({tournamentParticipants:t,personId:r})){const t=e[r];t.length&&n.push({personId:r,requests:t})}if(Object.keys(n).length){qs({tournamentRecord:r,extension:{name:Mo,value:n}})}}return{...L}}function _y({personRequests:t,personId:e,requests:n}){t[e]||(t[e]=[]);const r=n.filter((({requestType:t})=>t)).map((t=>{let{date:e,startTime:n,endTime:r}=t;return t.requestType===Iy&&(e=$r(e),n=qr(n),r=qr(r),e&&n&&r)?{date:e,startTime:n,endTime:r,requestType:t.requestType}:t})).filter(Boolean);for(const i of r)i.requestId=mi(),t[e].push(i);return{mergeCount:r.length}}function Ly({scheduleAttributes:t=["scheduledDate","scheduledTime"],ignoreMatchUpStatuses:e=fa,tournamentRecord:n,scheduledDates:r,venueIds:i=[]}){if("object"!=typeof n)return{error:$};if(!Array.isArray(e)||!Array.isArray(i))return{error:xn};i.length&&t.push("venueId");const a=(th({matchUpFilters:{scheduledDates:r},tournamentRecord:n}).matchUps||[]).filter((n=>n.matchUpStatus&&!e.includes(n.matchUpStatus)&&Sy({schedule:n.schedule,scheduleAttributes:t})&&(!i?.length||i.includes(n.schedule.venueId)))).map(hl),o=th({tournamentRecord:n,inContext:!1}).matchUps||[];let s=0;for(const c of o)a.includes(c.matchUpId)&&(c.timeItems=(c.timeItems||[]).filter((t=>t?.itemType&&![Bc,Vc,Lc,Gc,$c].includes(t?.itemType))),s+=1);return{...L,clearedScheduleCount:s}}function By({scheduleAttributes:t=["scheduledDate","scheduledTime"],ignoreMatchUpStatuses:e=fa,tournamentRecords:n,scheduledDates:r,venueIds:i}){const a=si(n)?Object.values(n).map((({tournamentId:t})=>t)).filter(Boolean):[];if(!a?.length)return{error:q};for(const o of a){const a=Ly({ignoreMatchUpStatuses:e,scheduleAttributes:t,tournamentRecord:n[o],scheduledDates:r,venueIds:i});if(a.error)return a}return{...L}}function Vy({tournamentRecord:t}){if(!t)return{error:$};const{policy:e}=ns({policyType:ro,tournamentRecord:t}),{extension:n}=Us({name:Co,tournamentRecord:t}),r=n?.value?.dailyLimits,i=e?.defaultDailyLimits;return{matchUpDailyLimits:r||i}}function jy({tournamentRecords:t,tournamentId:e}){if("object"!=typeof t||!Object.keys(t).length)return{error:q};let n;return Object.keys(t).filter((t=>!e||t===e)).forEach((e=>{const r=t[e],{matchUpDailyLimits:i}=Vy({tournamentRecord:r});n=i})),{matchUpDailyLimits:n}}function Gy({checkPotentialRequestConflicts:t=!0,scheduleCompletedMatchUps:e,clearScheduleDates:n,scheduleDates:r=[],tournamentRecords:i,periodLength:a,dryRun:o,pro:s}){if(!i)return{error:q};if(!Array.isArray(r))return{error:xn};const c=ry({tournamentRecords:i});if(c.error)return c;const{schedulingProfile:u=[],issues:d=[],modifications:p}=c,l=Object.assign({},...Object.values(i).map((t=>LI({tournamentRecord:t}).containedStructures))),m=r.map((t=>{if(Cr(t))return $r(t)})).filter(Boolean),f=u.map((t=>t.scheduleDate)).map((t=>Cr(t)&&$r(t))).filter((t=>t&&(!r.length||m.includes(t))));if(!f.length)return{error:he};if(n&&!o){By({tournamentRecords:i,scheduledDates:Array.isArray(n)?n:[]})}const{courts:h}=sI({ignoreDisabled:!1,tournamentRecords:i}),{matchUps:I}=ch({matchUpFilters:{matchUpTypes:[ba,Aa]},afterRecoveryTimes:!0,nextMatchUps:!0,tournamentRecords:i}),{matchUpDependencies:g}=ph({includeParticipantDependencies:!0,tournamentRecords:i,matchUps:I}),{matchUpDailyLimits:U}=jy({tournamentRecords:i}),{personRequests:y}=ky({requestType:Iy,tournamentRecords:i}),S={schedulingProfileModifications:p,checkPotentialRequestConflicts:t,scheduleCompletedMatchUps:e,schedulingProfileIssues:d,dateSchedulingProfiles:u.filter((t=>{const e=$r(t?.scheduleDate);return f.includes(e)})).sort(((t,e)=>new Date(t.scheduleDate).getTime()-new Date(e.scheduleDate).getTime())),containedStructureIds:l,matchUpDependencies:g,matchUpDailyLimits:U,clearScheduleDates:n,tournamentRecords:i,schedulingProfile:u,personRequests:y,periodLength:a,matchUps:I,dryRun:o,courts:h};return s?function({schedulingProfileModifications:t,checkPotentialRequestConflicts:e,scheduleCompletedMatchUps:n,schedulingProfileIssues:r,dateSchedulingProfiles:i,containedStructureIds:a,matchUpDependencies:o,matchUpDailyLimits:s,clearScheduleDates:c,tournamentRecords:u,periodLength:d=30,schedulingProfile:p,personRequests:l,matchUps:m,courts:f,dryRun:h}){const I={},g={},U={},y={},S={},v={},w={},T={},P={};for(const R of i){const t=$r(R?.scheduleDate),r=R?.venues||[],i={},p={},D=(t,e)=>{t.forEach((t=>{const n=p[t].counters;n[e]?n[e]+=1:n[e]=1,n[Ps]?n[Ps]+=1:n[Ps]=1}))};I[t]={},g[t]={},v[t]=[],w[t]=[],T[t]=[],P[t]=[];const N={};m.forEach((e=>{e.schedule?.scheduledDate&&ei(t,$r(e.schedule.scheduledDate))&&ly({matchUpPotentialParticipantIds:i,matchUpNotBeforeTimes:N,matchUp:e})}));const{allDateScheduledMatchUpIds:b,venueScheduledRoundDetails:M,allDateMatchUpIds:A}=Ny({matchUpPotentialParticipantIds:i,individualParticipantProfiles:p,scheduleCompletedMatchUps:n,containedStructureIds:a,matchUpNotBeforeTimes:N,matchUpScheduleTimes:S,matchUpDependencies:o,clearScheduleDates:c,tournamentRecords:u,periodLength:d,scheduleDate:t,matchUps:m,courts:f,venues:r}),E=m.filter((({matchUpId:t})=>b.includes(t))),{bookings:C}=Py({dateScheduledMatchUps:E,tournamentRecords:u,scheduleDate:t,periodLength:d}),{virtualCourts:O}=Th({scheduleDate:t,periodLength:d,bookings:C,courts:f}),F=O?.reduce(((e,n)=>{const{earliestCourtTime:r,courtEndTime:i}=Fy({date:t,averageMinutes:0,court:n});return(!e.startTime||Jr(r)<Jr(e.startTime))&&(e.startTime=r),(!e.endTime||Jr(i)>Jr(e.endTime))&&(e.endTime=i),e}),{});let k=F.startTime;const x=({courtId:t,booking:e})=>O?.find((e=>e.courtId===t))?.dateAvailability[0].bookings.push(e),_=10;let L,B=0;for(;!L;){for(const{venueId:n}of r){const r=M[n],a=r.matchUpsToSchedule.length,c=[],u=[];let m,f=0;for(;!m;){for(const a of r.matchUpsToSchedule){if(u.length===r.courtsCount||c.length===r.courtsCount){m=!0;break}const{matchUpId:f,matchUpType:h}=a,{participantIdsAtLimit:v,relevantParticipantIds:T}=by({matchUpPotentialParticipantIds:i,individualParticipantProfiles:p,matchUpDailyLimits:s,matchUp:a});if(v.length){w[t].includes(f)||w[t].push(f);continue}const{dependenciesScheduled:R,remainingDependencies:b}=py({matchUpScheduleTimes:S,matchUpDependencies:o,allDateMatchUpIds:A,matchUp:a});if(!R){g[t][f]||(g[t][f]=[]),g[t][f].push({remainingDependencies:b});continue}const M=[],E=O?.reduce(((n,s)=>{if(u.includes(s.courtId))return n;const{earliestCourtTime:c}=Fy({averageMinutes:r.greatestAverageMinutes,startTime:k,date:t,court:s});if(n.scheduleTime&&jr(c)>=jr(n.scheduleTime))return n;const{scheduledDependent:d}=hy({matchUpScheduleTimes:S,matchUpDependencies:o,scheduleTime:c,matchUpId:f,details:r});if(d)return n;const{enoughTime:m}=Ry({individualParticipantProfiles:p,matchUpNotBeforeTimes:N,matchUpDependencies:o,scheduleTime:c,details:r,matchUp:a});if(!m)return I[t][f]||(I[t][f]=[]),I[t][f].includes(c)||I[t][f].push(c),n;const g=r.minutesMap?.[f]?.averageMinutes||r.greatestAverageMinutes,{conflicts:U}=Uy({potentials:e,averageMatchUpMinutes:g,requestConflicts:P,personRequests:l,scheduleTime:c,scheduleDate:t,matchUp:a});if(U?.length)return M.push(...U),!1;D(T,h);const y=r.minutesMap?.[f]?.recoveryMinutes;return fy({matchUpPotentialParticipantIds:i,individualParticipantProfiles:p,matchUpNotBeforeTimes:N,averageMatchUpMinutes:g,matchUpDependencies:o,recoveryMinutes:y,scheduleTime:c,matchUp:a}),(!n.scheduleTime||jr(c)<jr(n.scheduleTime))&&(n.averageMatchUpMinutes=g,n.recoveryMinutes=y,n.scheduleTime=c,n.courtName=s.courtName,n.courtId=s.courtId),n}),{});if(E.scheduleTime){const{averageMatchUpMinutes:t,recoveryMinutes:e,scheduleTime:i,courtId:a}=E;S[f]=i,y[f]=a,c.push(f),u.push(a);const o=i,s=Xr(o,t);x({courtId:a,booking:{averageMatchUpMinutes:t,recoveryMinutes:e,periodLength:d,matchUpId:f,startTime:o,courtId:a,endTime:s,venueId:n}}),r.matchUpsToSchedule=r.matchUpsToSchedule.filter((t=>t.matchUpId!==f))}else M?.length&&(U[t]||(U[t]=[]),U[t].push(...M))}u.length!==r.courtsCount&&c.length!==r.courtsCount&&r.matchUpsToSchedule.length||(m=!0),r.matchUpsToSchedule.length&&c<r.courtsCount&&(Jr(k)<Jr(F.endTime)?k=Xr(k,d):(m=!0,r.complete=!0)),f+=1,!m&&f>=a&&(m=!0)}r.matchUpsToSchedule?.length||(r.complete=!0)}B+=1,L=r.every((({venueId:t})=>M[t].complete))||B===_}for(const{venueId:e}of r){const n=M[e].matchUpMap;Object.keys(n).forEach((e=>{const r=u[e];r&&Object.keys(n[e]).forEach((i=>{const{drawDefinition:a}=AI({tournamentRecord:r,drawId:i});a&&n[e][i].forEach((({matchUpId:e})=>{const n=S[e],i=y[e];if(n){const o=n.split(":").map(ti).join(":"),s=`${$r(t)}T${o}`;h||(gI({drawDefinition:a,scheduledTime:s,matchUpId:e}),II({courtDayDate:t,tournamentRecords:u,tournamentRecord:r,drawDefinition:a,matchUpId:e,courtId:i})),v[t].push(e)}}))}))})),T[t]=M[e].matchUpsToSchedule.map(hl)}for(const e of R.venues)for(const n of e.rounds){const e=(n.matchUps??[]).map((({matchUpId:t})=>t)),r=e?.filter((e=>v[t].includes(e)));n.canScheduledMatchUpIds=r;let i=Math.round((r?.length||0)/n.matchUpsCount*1e4)/100;(i===1/0||isNaN(i))&&(i=void 0),n.possibleToSchedulePct=i,n.matchUpsCount===r?.length&&(n.possibleToSchedule=!0)}}const D=i.map((({scheduleDate:t})=>t)),N={timeStamp:Date.now(),overLimitMatchUpIds:w,scheduledMatchUpIds:v,schedulingProfile:p,noTimeMatchUpIds:T,requestConflicts:P,scheduledDates:D};return Oy({tournamentRecords:u,autoSchedulingAudit:N}),{...L,schedulingProfileModifications:t,schedulingProfileIssues:r,dateSchedulingProfiles:i,recoveryTimeDeferredMatchUpIds:I,dependencyDeferredMatchUpIds:g,matchUpScheduleTimes:S,overLimitMatchUpIds:w,scheduledMatchUpIds:v,noTimeMatchUpIds:T,requestConflicts:P,scheduledDates:D}}(S):function({schedulingProfileModifications:t,checkPotentialRequestConflicts:e,scheduleCompletedMatchUps:n,schedulingProfileIssues:r,dateSchedulingProfiles:i,containedStructureIds:a,matchUpDependencies:o,matchUpDailyLimits:s,clearScheduleDates:c,schedulingProfile:u,tournamentRecords:d,personRequests:p,periodLength:l,matchUps:m,courts:f,dryRun:h}){const I={},g={},U={},y={},S={},v={},w={},T={},P={},D={};for(const b of i){const t=$r(b?.scheduleDate),r=b?.venues||[],i={},u={},N=(t,e)=>{t.forEach((t=>{const n=u[t].counters;n[e]?n[e]+=1:n[e]=1,n[Ps]?n[Ps]+=1:n[Ps]=1}))};U[t]={},y[t]={},I[t]={},g[t]={},w[t]=[],T[t]=[],P[t]=[],D[t]=[];const R={};m.forEach((e=>{e.schedule?.scheduledDate&&ei(t,$r(e.schedule.scheduledDate))&&ly({matchUpPotentialParticipantIds:i,matchUpNotBeforeTimes:R,matchUp:e})}));const{venueScheduledRoundDetails:M,allDateMatchUpIds:A}=Ny({matchUpPotentialParticipantIds:i,individualParticipantProfiles:u,scheduleCompletedMatchUps:n,containedStructureIds:a,matchUpNotBeforeTimes:R,matchUpScheduleTimes:v,matchUpDependencies:o,clearScheduleDates:c,tournamentRecords:d,useGarman:!0,periodLength:l,scheduleDate:t,matchUps:m,courts:f,venues:r}),E=10;let C,O=0;const F=10;for(;!C;){for(const{venueId:n}of r){let r=0;const a=M[n];for(;a.courtsCount&&a.scheduleTimes?.length&&a.matchUpsToSchedule?.length&&r<=a.courtsCount;){const{scheduleTime:c,attempts:d=0}=a.scheduleTimes.shift(),l=a.matchUpsToSchedule.find((n=>{const{matchUpId:r,matchUpType:d}=n,{participantIdsAtLimit:l,relevantParticipantIds:m}=by({matchUpPotentialParticipantIds:i,individualParticipantProfiles:u,matchUpDailyLimits:s,matchUp:n});if(l.length)return T[t].includes(r)||T[t].push(r),!1;const{scheduledDependent:f}=hy({matchUpScheduleTimes:v,matchUpDependencies:o,scheduleTime:c,matchUpId:r,details:a});if(f)return!1;const{dependenciesScheduled:h,remainingDependencies:I}=py({matchUpScheduleTimes:v,matchUpDependencies:o,allDateMatchUpIds:A,matchUp:n});if(!h)return y[t][r]||(y[t][r]=[]),y[t][r].push({scheduleTime:c,remainingDependencies:I}),!1;const{enoughTime:g}=Ry({individualParticipantProfiles:u,matchUpNotBeforeTimes:R,matchUpDependencies:o,scheduleTime:c,details:a,matchUp:n});if(!g)return U[t][r]||(U[t][r]=[]),U[t][r].push({scheduleTime:c}),!1;const w=a.greatestAverageMinutes,{conflicts:P}=Uy({potentials:e,averageMatchUpMinutes:w,requestConflicts:D,personRequests:p,scheduleTime:c,scheduleDate:t,matchUp:n});if(P?.length)return S[t]||(S[t]=[]),S[t].push(...P),!1;N(m,d);const b=a.minutesMap?.[r]?.recoveryMinutes;return fy({matchUpPotentialParticipantIds:i,individualParticipantProfiles:u,matchUpNotBeforeTimes:R,averageMatchUpMinutes:w,matchUpDependencies:o,recoveryMinutes:b,scheduleTime:c,matchUp:n}),v[r]=c,!0}));a.matchUpsToSchedule=a.matchUpsToSchedule.filter((({matchUpId:t})=>t!==l?.matchUpId)),l?r+=1:(g[t][n]||(g[t][n]=[]),g[t][n].push({scheduleTime:c,attempts:d+1}))}a.matchUpsToSchedule?.length&&(g[t][n]=g[t][n]?.filter((t=>{const e=t.attempts<E;return e&&a.scheduleTimes.push(t),!e}))),a.scheduleTimes?.length&&a.matchUpsToSchedule?.length||(a.complete=!0)}O+=1,C=r.every((({venueId:t})=>M[t].complete))||O===F}for(const{venueId:e}of r){const n=M[e].matchUpMap;Object.keys(n).forEach((r=>{const i=d[r];i&&Object.keys(n[r]).forEach((a=>{const{drawDefinition:o}=AI({tournamentRecord:i,drawId:a});o&&n[r][a].forEach((({matchUpId:n})=>{const r=v[n];if(r){const a=r.split(":").map(ti).join(":"),s=`${$r(t)}T${a}`;h?w[t].push(n):(gI({drawDefinition:o,scheduledTime:s,matchUpId:n}).success&&w[t].push(n),e&&hI({tournamentRecord:i,drawDefinition:o,matchUpId:n,venueId:e}))}}))}))})),P[t]=M[e].matchUpsToSchedule.map(hl),I[t][e]=M[e].scheduleTimes.sort(((t,e)=>jr(t.scheduleTime)-jr(e.scheduleTime)))}for(const e of b.venues)for(const n of e.rounds){const e=n.matchUps?.map((({matchUpId:t})=>t))||[],r=e.filter((e=>w[t].includes(e)));n.canScheduledMatchUpIds=r;let i=Math.round(r.length/n.matchUpsCount*1e4)/100;(i===1/0||isNaN(i))&&(i=0),n.possibleToSchedulePct=i,n.matchUpsCount===r.length&&(n.possibleToSchedule=!0)}}const N=i.map((({scheduleDate:t})=>t)),R={timeStamp:Date.now(),overLimitMatchUpIds:T,scheduledMatchUpIds:w,schedulingProfile:u,noTimeMatchUpIds:P,requestConflicts:D,scheduledDates:N};return Oy({tournamentRecords:d,autoSchedulingAudit:R}),{...L,schedulingProfileModifications:t,schedulingProfileIssues:r,scheduleTimesRemaining:I,dateSchedulingProfiles:i,skippedScheduleTimes:g,recoveryTimeDeferredMatchUpIds:U,dependencyDeferredMatchUpIds:y,matchUpScheduleTimes:v,overLimitMatchUpIds:T,scheduledMatchUpIds:w,noTimeMatchUpIds:P,requestConflicts:D,scheduledDates:N}}(S)}function qy({event:t}){return t?zs({event:t,name:Oo}):{error:At}}function $y({tournamentParticipants:t,tournamentRecord:e,drawDefinition:n,participantId:r,matchUpId:i,matchUp:a,event:o}){if(!r)return{error:Le};if(!i)return{error:te};if(t=t??e?.participants,t?.length){if(!a&&n){const e=$p({tournamentParticipants:t,inContext:!0,drawDefinition:n,matchUpId:i,event:o});if(!e.matchUp)return{error:Xt};a=e.matchUp}const e=Ep({matchUp:a});if(e.error)return e;const{checkedInParticipantIds:s,allRelevantParticipantIds:c}=e;if(!c.includes(r))return{error:Ee};if(s.includes(r))return{error:We}}return mI({tournamentRecord:e,drawDefinition:n,matchUpId:i,timeItem:{itemType:xc,itemValue:r}})}function Wy({tournamentParticipants:t,tournamentRecord:e,drawDefinition:n,participantId:r,matchUpId:i,matchUp:a,event:o}){if(!r)return{error:Le};if(!i&&!a)return{error:Jt};if(t=t??e?.participants,!a){const e=$p({tournamentParticipants:t,inContext:!0,drawDefinition:n,matchUpId:i,event:o});if(e.error)return e;if(!e.matchUp)return{error:Xt};a=e.matchUp}const{matchUpStatus:s,score:c}=a;if(s&&ha.includes(s)||s&&fa.includes(s)||Yp({score:c}))return{error:gt};if(t?.length){const{checkedInParticipantIds:t,allRelevantParticipantIds:e}=Ep({matchUp:a});if(!e?.includes(r))return{error:Ee};if(!t.includes(r))return{error:$e};const{sideParticipantIds:o,nestedIndividualParticipantIds:s}=Ap({matchUp:a}),c=o.indexOf(r);[0,1].includes(c)&&(s[c]||[]).forEach((t=>{mI({drawDefinition:n,matchUpId:i,timeItem:{itemType:_c,itemValue:t}})}))}return mI({tournamentRecord:e,drawDefinition:n,matchUpId:i,timeItem:{itemType:_c,itemValue:r}})}function Hy(t){if(!t?.tournamentRecord)return{error:$};const{tournamentRecord:e,participantId:n,matchUpId:r,drawDefinition:i,event:a}=t,o=e.participants||[],s=LU({tournamentRecord:e,inContext:!0,drawDefinition:i,matchUpId:r,event:a});if(!s.matchUp)return{error:Xt};const c=s.matchUp,{checkedInParticipantIds:u=[]}=Ep({matchUp:c});return u.includes(n)?Wy({tournamentParticipants:o,tournamentRecord:e,drawDefinition:i,participantId:n,matchUpId:r,matchUp:c}):$y({tournamentParticipants:o,tournamentRecord:e,drawDefinition:i,participantId:n,matchUpId:r,matchUp:c})}function zy(t){const{tournamentRecords:e}=t;if(!e)return{error:q};const{removePriorValues:n,tournamentId:r,courtDayDate:i,matchUpId:a,courtId:o,drawId:s}=t,c=e[r];if(!c)return{error:$};const{drawDefinition:u,event:d}=AI({tournamentRecord:c,drawId:s});if(!u)return{error:Y};const p=$p({drawDefinition:u,event:d,matchUpId:a});if(p.error)return p;if(p?.matchUp?.matchUpType===Ea){const{itemValue:t}=pu({timeItems:p.matchUp.timeItems??[],itemType:Bc}),e=o&&t.filter((t=>t.courtId!==o));return mI({duplicateValues:!1,removePriorValues:n,tournamentRecord:c,drawDefinition:u,matchUpId:a,timeItem:{itemType:Bc,itemValue:e}})}return II({tournamentRecord:c,drawDefinition:u,courtDayDate:i,courtId:"",matchUpId:a})}function Yy(t){const{containerStructureId:e,roundSegment:n,isRoundRobin:r,tournamentId:i,roundNumber:a,structureId:o,eventId:s,drawId:c}=t,u=r?e:o,d=[i,s,c,u,a].join("|");return di({structureId:u,roundSegment:n,tournamentId:i,roundNumber:a,eventId:s,drawId:c,id:d})}function Ky({round:t,matchUps:e,events:n,tournamentRecords:r}){const i=n.find((e=>e.eventId===t.eventId)),{eventType:a,category:o,categoryType:s}=i||{},{categoryName:c,ageCategoryCode:u}=o||{},d=N(e.map((({matchUpFormat:t})=>t)));let p=0;return Object.keys(d).forEach((e=>{const n=d[e],i=ZU({categoryName:c||u,tournamentId:t.tournamentId,eventId:t.eventId,tournamentRecords:r,matchUpFormat:e,categoryType:s,eventType:a});if(i.error)return i;const o=i.averageMinutes*n;isNaN(p)||(p+=o)})),{roundMinutes:p}}function Jy(t){const e=t.length,n=t.filter((({sides:t})=>t?.some((({bye:t})=>t)))).length||0,r=t.filter((({winningSide:t,matchUpStatus:e})=>t||fa.includes(e))).length||0,i=t.filter((({schedule:t})=>t?.scheduledDate&&t?.scheduledTime)).length||0,a=e-n;return{unscheduledCount:a-i,incompleteCount:a-i,scheduledCount:i,completedCount:r,matchUpsCount:e,isScheduled:a===i,isComplete:a===r,byeCount:n}}function Qy({tournamentRecords:t,schedulingProfile:e,tournamentRecord:n,withRoundId:r}){if(n&&!t){if("object"!=typeof n)return{error:W};t={[n.tournamentId]:n}}if(e){const n=QU({tournamentRecords:t,schedulingProfile:e});if(n.error)return n}if(!e&&t){const n=ry({tournamentRecords:t});if(n.error)return n;e=n.schedulingProfile}if(!e)return{error:Gn};const i={};return{profileRounds:e.map((({venues:t,scheduleDate:e})=>t.map((({rounds:t})=>t.map((t=>{const n=Yy(t);return n.roundSegment?.segmentsCount&&(i[n.id]=n.roundSegment.segmentsCount),di({id:r?n.id:void 0,scheduleDate:e,...n})})))))).flat(1/0),segmentedRounds:i}}function Xy(t){return SI(t)}function Zy({removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,scheduledDate:i,matchUpId:a}){return vI({removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,scheduledDate:i,matchUpId:a})}function tS({removePriorValues:t,tournamentRecord:e,drawDefinition:n,scheduledTime:r,disableNotice:i,matchUpId:a}){return gI({removePriorValues:t,tournamentRecord:e,drawDefinition:n,scheduledTime:r,disableNotice:i,matchUpId:a})}function eS({tournamentRecord:t,drawDefinition:e,disableNotice:n,matchUpId:r,startTime:i}){return PI({tournamentRecord:t,drawDefinition:e,disableNotice:n,matchUpId:r,startTime:i})}function nS({tournamentRecord:t,drawDefinition:e,disableNotice:n,matchUpId:r,endTime:i}){return DI({tournamentRecord:t,drawDefinition:e,disableNotice:n,matchUpId:r,endTime:i})}function rS({tournamentRecord:t,drawDefinition:e,disableNotice:n,matchUpId:r,stopTime:i}){return NI({tournamentRecord:t,drawDefinition:e,disableNotice:n,matchUpId:r,stopTime:i})}function iS({tournamentRecord:t,drawDefinition:e,disableNotice:n,resumeTime:r,matchUpId:i}){return RI({tournamentRecord:t,drawDefinition:e,disableNotice:n,resumeTime:r,matchUpId:i})}function aS({tournamentRecord:t,drawDefinition:e,disableNotice:n,participantId:r,officialType:i,matchUpId:a}){if(!r)return{error:Le};return fs({tournamentParticipants:sU({tournamentRecord:t,participantFilters:{participantTypes:[Eu],participantRoles:[Gi.Official]}}).participants??[],participantId:r})?TI({drawDefinition:e,disableNotice:n,participantId:r,officialType:i,matchUpId:a}):{error:Be}}function oS({tournamentRecord:t,scheduleChange:e,matchUpIds:n,dryRun:r}){if(!t)return{error:$};if(!n||!Array.isArray(n))return{error:Qt};if("object"!=typeof e)return{error:xn};const i=[],a=[],{minutesChange:o,daysChange:s}=e;if(!o&&!s)return{...L};if(o&&isNaN(o))return{error:xn};if(s&&isNaN(s))return{error:xn};const{matchUps:c}=th({matchUpFilters:{matchUpIds:n},tournamentRecord:t}),u=c?.filter((t=>Sy({schedule:t.schedule}))).filter((t=>(({matchUpStatus:t})=>!fa.includes(t))({matchUpStatus:t.matchUpStatus})));if(!u?.length)return{...L};const{tournamentInfo:d}=ey({tournamentRecord:t}),{startDate:p,endDate:l}=d,m=u?.reduce(((t,e)=>{const{matchUpId:n,drawId:r}=e;return t[r]?t[r].push(n):t[r]=[n],t}),{});for(const U of Object.keys(m)){const e=AI({tournamentRecord:t,drawId:U});if(e.error)return e;const c=e.drawDefinition,d=m[U].filter((t=>n.includes(t)));for(const t of d)if(t&&c){const e=u.find((e=>e.matchUpId===t)),n=e?.schedule,{scheduledTime:d,scheduledDate:m}=n;let f,h,I;if(!f&&s&&m){I=Wr($r(m),s),f=new Date(I)<new Date(p)||new Date(I)>new Date(l)}if(o&&d){const t=$r(d),e=jr(qr(d))+o;if(f=e<0||e>1440,!f){const e=Xr(d,o),n=t&&I||m===t&&t;h=n?`${n}T${e}`:e}}if(f)a.push(t);else{if(!r){if(h){const e=tS({scheduledTime:h,drawDefinition:c,matchUpId:t});if(e.error)return e}if(I){const e=Zy({scheduledDate:I,drawDefinition:c,matchUpId:t});if(e.error)return e}}(h||I)&&i.push(t)}}}const f=th({matchUpFilters:{matchUpIds:n},tournamentRecord:t}).matchUps??[],h=f.filter((({matchUpId:t})=>i.includes(t))),I=f.filter((({matchUpId:t})=>a.includes(t))),g=h.length&&!I.length;return{...L,rescheduled:h,notRescheduled:I,allRescheduled:g}}function sS({tournamentRecord:t,dailyLimits:e}){return t?"object"!=typeof e?{error:On}:qs({extension:{name:Co,value:{dailyLimits:e}},tournamentRecord:t}):{error:$}}const{stageOrder:cS}=$d;function uS(t,e){return t.eventName.localeCompare(e.eventName)||t.eventId.localeCompare(e.eventId)||(cS[t?.stage]||0)-(cS[e?.stage]||0)||e.matchUpsCount-t.matchUpsCount||`${t.stageSequence}-${t.roundNumber}-${t.minFinishingSum}`.localeCompare(`${e.stageSequence}-${e.roundNumber}-${e.minFinishingSum}`)}function dS({excludeScheduleDateProfileRounds:t,excludeScheduledRounds:e,excludeCompletedRounds:n,inContextMatchUps:r,tournamentRecords:i,schedulingProfile:a,tournamentRecord:o,withSplitRounds:s,matchUpFilters:c,scheduleDate:u,withRoundId:d,venueId:p,context:l}){if(r&&!Array.isArray(r||"object"!=typeof r[0]))return{error:xn,inContextMatchUps:r};if(o&&!i){if("object"!=typeof o)return{error:W};i={[o.tournamentId]:o}}const m="object"!=typeof i||!Object.keys(i).length;if((p||u||!r||!a&&(t||n||a||s))&&m)return{error:q};const f=Object.assign({},...Object.values(i??{}).map((({venues:t=[],tournamentId:e})=>({[e]:t?.map((({venueId:t})=>t))})))),h=Object.values(i??{}).map((({events:t=[],tournamentId:e,startDate:n,endDate:r})=>t.map((t=>({...t,validVenueIds:f[e],startDate:t.startDate??n,endDate:t.endDate??r}))))).flat(),{segmentedRounds:I,profileRounds:g}=i&&(t||n||a||s)&&Qy({tournamentRecords:i,schedulingProfile:a})||{},U=t&&Object.assign({},...g.map((t=>({[t.id]:t})))),y=r||i&&ch({tournamentRecords:i,matchUpFilters:c})?.matchUps||[],S=[],v=y&&Object.values(y.reduce(((t,e)=>{const n=Yy(e).id,r=I?.[n],i=[...t[n]?.matchUps??[],e],{containerStructureId:a,stageSequence:o,structureName:s,tournamentId:c,isRoundRobin:u,matchUpType:p,roundNumber:l,roundOffset:m,structureId:f,eventName:h,roundName:g,drawName:U,eventId:y,drawId:S}=e,v=u?a:f;return{...t,[n]:{id:d?n:void 0,structureId:v,stageSequence:o,segmentsCount:r,structureName:s,tournamentId:c,matchUpType:p,roundNumber:l,roundOffset:m,eventName:h,roundName:g,drawName:U,matchUps:i,eventId:y,drawId:S}}}),{})).map((t=>{const{minFinishingSum:e,winnerFinishingPositionRange:n}=(t.matchUps||[]).reduce(((t,e)=>{const n=(e.finishingPositionRange?.winner||[]).reduce(((t,e)=>t+e),0),r=(e.finishingPositionRange?.winner||[]).join("-")||"";return!t.minFinishingSum||n<t.minFinishingSum?{minFinishingSum:n,winnerFinishingPositionRange:r}:t}),{minFinishingSum:0,winnerFinishingPositionRange:""});const r=t.segmentsCount;if(r){const a=t.matchUps.length/r;return x(t.matchUps.sort(((t,e)=>t.roundPosition-e.roundPosition)),a).map(((a,o)=>{const{unscheduledCount:s,incompleteCount:c,matchUpsCount:u,isScheduled:d,isComplete:p,byeCount:m}=Jy(a),f=Ky({matchUps:t.matchUps,tournamentRecords:i,events:h,round:t});return di({...t,...l,roundSegment:{segmentsCount:r,segmentNumber:o+1},winnerFinishingPositionRange:n,unscheduledCount:s,incompleteCount:c,minFinishingSum:e,matchUpsCount:u,isScheduled:d,roundTiming:f,isComplete:p,byeCount:m,matchUps:a})}))}const{unscheduledCount:a,incompleteCount:o,matchUpsCount:s,isScheduled:c,isComplete:u,byeCount:d}=Jy(t.matchUps),p=Ky({matchUps:t.matchUps,tournamentRecords:i,events:h,round:t});return di({...t,...l,winnerFinishingPositionRange:n,unscheduledCount:a,incompleteCount:o,minFinishingSum:e,matchUpsCount:s,isScheduled:c,roundTiming:p,isComplete:u,byeCount:d})})).flat().filter((r=>{if(t){const e=$r(t),n=d?r.id:Yy(r).id;if(e&&U[n]&&$r(U[n].scheduleDate)===e)return!1}const{isComplete:i,isScheduled:a}=r,s=!n||!i,c=!e||!a,l=p||u?h?.find((({eventId:t})=>t===r.eventId)):void 0,m=l?.startDate||o?.startDate,f=l?.endDate||o?.endDate,I=!u||!m||new Date(u)>=new Date(m),g=!u||!f||new Date(u)<=new Date(f),y=I&&g,v=!p||l?.validVenueIds.includes(p),w=s&&c&&v&&y;return w||S.push(r),w})).sort(uS)||[];return{...L,rounds:v,excludedRounds:S}}const pS={scheduleMatchUps:function({tournamentRecords:t,competitionMatchUps:e,matchUpDependencies:n,allDateMatchUpIds:r=[],averageMatchUpMinutes:i=90,recoveryMinutes:a=0,recoveryMinutesMap:o,matchUpPotentialParticipantIds:s={},individualParticipantProfiles:c={},matchUpNotBeforeTimes:u={},matchUpDailyLimits:d={},checkPotentialRequestConflicts:p=!0,remainingScheduleTimes:l,clearScheduleDates:m,periodLength:f=30,scheduleDate:h,matchUpIds:I,venueIds:g,startTime:U,endTime:y,dryRun:S}){if(!t)return{error:q};if(!I)return{error:Qt};if(!Cr(h))return{error:ye};if(isNaN(f)||isNaN(i)||isNaN(a))return{error:xn};e||({matchUps:e}=ch({tournamentRecords:t,nextMatchUps:!0})),n||({matchUpDependencies:n}=ph({includeParticipantDependencies:!0,matchUps:e,tournamentRecords:t})),e.forEach((t=>{t.schedule?.scheduledDate&&ei(h,$r(t.schedule.scheduledDate))&&ly({matchUpPotentialParticipantIds:s,matchUpNotBeforeTimes:u,matchUp:t})}));const v=I.map((t=>e.find((e=>e.matchUpId===t)))).filter(Boolean),{venueId:w,scheduleTimes:T,dateScheduledMatchUpIds:P}=dy({tournamentRecords:t,remainingScheduleTimes:l,startTime:qr(U),endTime:qr(y),scheduleDate:$r(h),averageMatchUpMinutes:i,clearScheduleDates:m,periodLength:f,venueIds:g}),D={},N=[],R={},b={},M={},A=e.filter((({matchUpId:t})=>P?.includes(t)));A.forEach((t=>{yy({matchUpPotentialParticipantIds:s,individualParticipantProfiles:c,matchUp:t,value:1});const e=t.schedule?.scheduledTime;if(e){R[t.matchUpId]=e;const r=o?.[t.matchUpId];fy({recoveryMinutes:r||a,matchUpPotentialParticipantIds:s,individualParticipantProfiles:c,matchUpNotBeforeTimes:u,averageMatchUpMinutes:i,matchUpDependencies:n,scheduleTime:e,matchUp:t})}}));let E=v.filter((t=>{const e=P?.includes(t.matchUpId),n=[Ki,Zi,Qi,zi,aa,ca].includes(t?.matchUpStatus);return!e&&!t.winningSide&&!n}));const{matchUpMap:C,overLimitMatchUpIds:O,participantIdsAtLimit:F}=E.reduce(((t,e)=>{const{drawId:n,tournamentId:r,matchUpType:i}=e,{participantIdsAtLimit:a,relevantParticipantIds:o}=by({individualParticipantProfiles:c,matchUpPotentialParticipantIds:s,matchUpDailyLimits:d,matchUp:e});return a?.length?(t.overLimitMatchUpIds.push(e.matchUpId),t.participantIdsAtLimit.push(...a),t):(o.forEach((t=>{my({individualParticipantProfiles:c,participantId:t});const e=c[t].counters;e[i]?e[i]+=1:e[i]=1,e[Ps]?e[Ps]+=1:e[Ps]=1})),t.matchUpMap[r]||(t.matchUpMap[r]={}),t.matchUpMap[r][n]?t.matchUpMap[r][n].push(e):t.matchUpMap[r][n]=[e],ly({matchUpPotentialParticipantIds:s,matchUpNotBeforeTimes:u,matchUp:e}),t)}),{matchUpMap:{},overLimitMatchUpIds:[],participantIdsAtLimit:[]});E=E.filter((({matchUpId:t})=>!O.includes(t)));let k=0;const x=T?.length??0,{personRequests:_}=ky({tournamentRecords:t,requestType:Iy});for(;T?.length&&E.length&&k<=x;){k++;const{scheduleTime:t}=T.shift(),e=E.find((e=>{const{matchUpId:d}=e,{dependenciesScheduled:l,remainingDependencies:m}=py({matchUpScheduleTimes:R,matchUpDependencies:n,allDateMatchUpIds:r,matchUp:e});if(!l)return M[d]||(M[d]=[]),M[d].push({scheduleTime:t,remainingDependencies:m}),!1;const{enoughTime:f}=Ry({individualParticipantProfiles:c,matchUpNotBeforeTimes:u,matchUpDependencies:n,scheduleTime:t,matchUp:e});if(!f)return b[d]||(b[d]=[]),b[d].push({scheduleTime:t}),!1;const{conflicts:I}=Uy({potentials:p,averageMatchUpMinutes:i,requestConflicts:D,personRequests:_,scheduleTime:t,scheduleDate:h,matchUp:e});if(I?.length)return!1;const g=o?.[e.matchUpId];return fy({recoveryMinutes:g||a,matchUpPotentialParticipantIds:s,individualParticipantProfiles:c,matchUpNotBeforeTimes:u,averageMatchUpMinutes:i,matchUpDependencies:n,scheduleTime:t,matchUp:e}),R[e.matchUpId]=t,!0}));E=E.filter((({matchUpId:t})=>t!==e?.matchUpId)),e||N.push(t)}E.forEach((t=>{yy({individualParticipantProfiles:c,matchUpPotentialParticipantIds:s,value:-1,matchUp:t})}));const B=[];Object.keys(C).forEach((e=>{const n=t[e];n&&Object.keys(C[e]).forEach((r=>{const{drawDefinition:i}=AI({tournamentRecord:n,drawId:r});if(i){C[e][r].forEach((({matchUpId:e})=>{const r=R[e];if(r){const a=r.split(":").map(ti).join(":"),o=`${$r(h)}T${a}`;if(S)B.push(e);else{gI({drawDefinition:i,matchUpId:e,scheduledTime:o}).success&&B.push(e),w&&hI({tournamentRecords:t,tournamentRecord:n,drawDefinition:i,matchUpId:e,venueId:w})}}}))}}))}));const V=pl(E);return{...L,requestConflicts:Object.values(D),remainingScheduleTimes:T?.map((({scheduleTime:t})=>t)),individualParticipantProfiles:c,matchUpNotBeforeTimes:u,participantIdsAtLimit:F,skippedScheduleTimes:N,overLimitMatchUpIds:O,scheduledMatchUpIds:B,noTimeMatchUpIds:V,recoveryTimeDeferred:b,dependencyDeferred:M}},scheduleProfileRounds:Gy,clearScheduledMatchUps:By,bulkRescheduleMatchUps:function({tournamentRecords:t,scheduleChange:e,matchUpIds:n,dryRun:r}){if(!n||!Array.isArray(n))return{error:Qt};if("object"!=typeof e)return{error:xn};const i=[];let a=[];for(const s of Object.values(t)){const t=oS({tournamentRecord:s,scheduleChange:e,matchUpIds:n,dryRun:r});if(t.error)return t;Array.isArray(t.notRescheduled)&&a.push(...t.notRescheduled);const o=pl(t.notRescheduled),c=[];t.rescheduled?.forEach((t=>{const{matchUpId:e}=t;o.includes(e)&&c.push(e),i.push(t)})),c.length&&(a=t?.notRescheduled?.filter((({matchUpId:t})=>!c.includes(t)))||[])}const o=!(!i.length||a.length);return{...L,rescheduled:i,notRescheduled:a,allRescheduled:o}},getScheduledRoundsDetails:ty,getMatchUpDependencies:ph,generateVirtualCourts:Th,generateBookings:Py,proAutoSchedule:function({scheduleCompletedMatchUps:t,tournamentRecords:e,scheduledDate:n,matchUps:r}){if(!Sa(r))return{error:xn};if(r.some((({hasContext:t})=>!t)))return{info:"matchUps must have { inContext: true, nextMatchUps: true }",error:Pn};let i=uy({courtCompletedMatchUps:!0,withCourtGridRows:!0,minCourtGridRows:10,tournamentRecords:e,matchUpFilters:{localPerspective:!0,scheduledDate:n}});if(i.error)return i;const{rows:a}=i,o=[],s=t=>[(t.sides||[]).map((t=>[t.participantId,t.participant?.individualParticipantIds])),(t.potentialParticipants||[]).flat().map((t=>[t.participantId,t.individualParticipantIds]))].flat(1/0).filter(Boolean),c=a?.reduce(((t,e)=>{const n=[],r=[];Object.values(e).forEach((t=>{if(si(t)&&(t.matchUpId&&(n.push(t.matchUpId),o.push(t)),t.sides)){const e=s(t);r.push(...e)}}));const i=Object.values(e).filter((t=>si(t)&&!t.matchUpId));return t.concat({matchUpIds:n,availableCourts:i,rowId:e.rowId,participantIds:r})}),[]);r.filter((({matchUpStatus:e})=>e&&e!==Vi.Bye&&(t||!fa.includes(e)))).sort(dh);const u=ph({matchUps:r.concat(o),includeParticipantDependencies:!0,tournamentRecords:e}).matchUpDependencies,d=[],p=[];for(;r.length&&c.length;){const t=c.shift(),e=[];for(;r.length&&t.availableCourts.length;){const n=r.concat(e).map((t=>t.matchUpId)),i=r.shift(),a=i?.matchUpId,o=a&&u[a].matchUpIds.concat(u[a].dependentMatchUpIds),c=a&&n.some((t=>u[a].matchUpIds.includes(t))),l=a&&p.some((t=>u[a].dependentMatchUpIds.includes(t))),m=t.matchUpIds.some((t=>o.includes(t))),f=s(i),h=t.participantIds.some((t=>f.includes(t)));if(!i||m||c||h||l)i&&e.push(i);else{const e=t.availableCourts.shift();Object.assign(i.schedule,e.schedule),Object.assign(e,i),d.push(i),t.participantIds.push(...f),t.matchUpIds.push(a)}}r.push(...e),p.push(...t.matchUpIds)}const l=d.map((({matchUpId:t,tournamentId:e,schedule:r,drawId:i})=>({tournamentId:e,matchUpId:t,drawId:i,schedule:{...r,scheduledDate:n}})));i=CI({tournamentRecords:e,matchUpDetails:l});const m=r;return{...i,scheduled:d,notScheduled:m}},proConflicts:lh,matchUpScheduleChange:function(t){const e="matchUpScheduleChange",{tournamentRecords:n}=t;if("object"!=typeof n||!Object.keys(n).length)return{error:q};const{sourceMatchUpContextIds:r,targetMatchUpContextIds:i,sourceCourtId:a,targetCourtId:o,courtDayDate:s}=t||{},{drawId:c,matchUpId:u,tournamentId:d}=r||{},{drawId:p,matchUpId:l,tournamentId:m}=i||{};if(!u&&!l)return Oi({result:{error:me},stack:e});const{matchUps:f}=ch({matchUpFilters:{matchUpIds:[u,l].filter(Boolean),drawIds:[c,p].filter(Boolean)},tournamentRecords:t.tournamentRecords}),h=f?.find((({matchUpId:t})=>t===u)),I=f?.find((({matchUpId:t})=>t===l));let g=0;if(o&&u&&!l){const t=U({tournamentId:d,matchUpId:u,courtId:o,matchUp:h,drawId:c,tournamentRecords:n,sourceCourtId:a,courtDayDate:s});if(t?.success&&g++,t.error)return Oi({result:t,stack:e})}else{if(!(a&&o&&u&&l))return{error:me};{const t=U({tournamentId:d,matchUpId:u,courtId:o,matchUp:h,drawId:c,tournamentRecords:n,sourceCourtId:a,courtDayDate:s});if(t.success&&g++,t.error)return Oi({result:t,stack:e,info:"source"});const r=U({tournamentId:m,sourceCourtId:o,matchUpId:l,matchUp:I,courtId:a,drawId:p,tournamentRecords:n,courtDayDate:s});if(r.success&&g++,r.error)return Oi({result:r,stack:e,info:"target"})}}return g?L:Oi({result:{error:bn},stack:e});function U(t){const{tournamentRecords:e,tournamentId:n,matchUp:r,drawId:i}=t,a=e[n],{drawDefinition:o}=AI({tournamentRecord:a,drawId:i});return r.matchUpType===Ca?function({removePriorValues:t,tournamentRecords:e,tournamentRecord:n,drawDefinition:r,sourceCourtId:i,courtDayDate:a,matchUpId:o,matchUp:s,courtId:c}){const u=[c].concat(s.schedule.allocatedCourts.map((({courtId:t})=>t)).filter((t=>t!==i)));return fI({removePriorValues:t,tournamentRecords:e,tournamentRecord:n,drawDefinition:r,courtDayDate:a,matchUpId:o,courtIds:u})}({...t,tournamentRecord:a,drawDefinition:o}):function({tournamentRecords:t,tournamentRecord:e,drawDefinition:n,courtDayDate:r,matchUpId:i,courtId:a}){return II({tournamentRecords:t,tournamentRecord:e,drawDefinition:n,courtDayDate:r,matchUpId:i,courtId:a})}({...t,tournamentRecord:a,drawDefinition:o})}},calculateScheduleTimes:dy,reorderUpcomingMatchUps:function(t){const e="reorderUpcomingMatchUps",{tournamentRecords:n}=t;if("object"!=typeof n||!Object.keys(n).length)return Oi({result:{error:q},stack:e});const{matchUpsContextIds:r,firstToLast:i}=t;if(!r)return Oi({result:{error:me},stack:e});const a=r?.length;if(!a)return{...L};let o=0;return r.forEach(((t,e)=>{const{tournamentId:s,drawId:c,matchUpId:u}=t;let d=e+(i?-1:1);d<0&&(d=a-1),d===a&&(d=0);const p=function({tournamentId:t,scheduledTime:e,matchUpId:r,drawId:i}){const a=n[t],{drawDefinition:o}=AI({tournamentRecord:a,drawId:i});return o?gI({drawDefinition:o,scheduledTime:e,matchUpId:r}):{error:J}}({tournamentId:s,scheduledTime:r[d].schedule.scheduledTime,matchUpId:u,drawId:c});if(!p.success)return p;o++})),o===a?L:Oi({result:{error:Rn},stack:e})},bulkUpdateCourtAssignments:function({tournamentRecords:t,courtAssignments:e,courtDayDate:n}){if(!t)return{error:q};if(!Array.isArray(e))return{error:me,info:Ci("courtAssignments")};const r=e.reduce(((t,e)=>{const{tournamentId:n}=e;return t[n]||(t[n]=[]),t[n].push(e),t}),{});let i;return Object.keys(r).every((e=>{const a=t[e];if(!a)return i={error:$},!1;const o=r[e].reduce(((t,e)=>{const{drawId:n}=e;return t[n]||(t[n]=[]),t[n].push(e),t}),{});Object.keys(o).every((t=>{const{drawDefinition:e}=Ls({tournamentRecord:a,drawId:t});return e?(o[t].every((t=>{const{matchUpId:r,courtId:o}=t,s=II({tournamentRecord:a,drawDefinition:e,courtDayDate:n,matchUpId:r,courtId:o});if(s.success)return s?.success;i={error:Mn}})),!0):(i={error:Y},!1)}))})),i||L},removeMatchUpCourtAssignment:zy,toggleParticipantCheckInState:function(t){const{tournamentRecords:e}=t,{participantId:n,tournamentId:r,matchUpId:i,drawId:a}=t;if(!(e&&r&&n&&i))return{error:me,stack:"toggleParticipantCheckInState"};const o=e[r],{drawDefinition:s,event:c}=AI({tournamentRecord:o,drawId:a});return Object.assign(t,{drawDefinition:s,event:c,tournamentRecord:o}),Hy(t)},findMatchUpFormatTiming:ZU,modifyMatchUpFormatTiming:function({tournamentRecords:t,matchUpFormat:e,recoveryTimes:n,averageTimes:r,tournamentId:i,eventId:a}){if("object"!=typeof t||!Object.keys(t).length)return{error:q};const o=Object.keys(t).filter((t=>!i||i===t));if(i&&!o.includes(i))return{error:xn};let s;for(const c of o){const i=t[c],{event:o}=Ls({tournamentRecord:i,eventId:a});a&&o&&(s=!0);const u=HU({tournamentRecord:i,event:o,matchUpFormat:e,averageTimes:r,recoveryTimes:n});if(u.error)return u}return!a||s?{...L}:{error:Et}},modifyEventMatchUpFormatTiming:function({tournamentRecords:t,recoveryMinutes:e,averageMinutes:n,matchUpFormat:r,categoryType:i,tournamentId:a,eventId:o}){if(!o)return{error:At};const s=Object.keys(t).filter((t=>!a||a===t));if(a&&!s.includes(a))return{error:xn};for(const c of s){const a=t[c],{event:s}=Ls({tournamentRecord:a,eventId:o});if(s)return YU({tournamentRecord:a,recoveryMinutes:e,averageMinutes:n,matchUpFormat:r,categoryType:i,event:s})}return{error:Et}},getMatchUpFormatTimingUpdate:function({tournamentRecords:t}){return KU({extensionName:Oo,tournamentRecords:t})},getEventMatchUpFormatTiming:function({tournamentRecords:t,matchUpFormats:e,categoryType:n,tournamentId:r,eventId:i}){if(!i)return{error:At};const a=Object.keys(t).filter((t=>!r||t===r));if(r&&!a.length)return{error:xn};let o,s,c;return a.forEach((r=>{const a=t[r],{event:u}=Ls({tournamentRecord:a,eventId:i});if(!u)return!1;c=!0;const{eventMatchUpFormatTiming:d,error:p}=JU({tournamentRecord:a,matchUpFormats:e,categoryType:n,event:u});p&&(s=p),o=d})),!c&&{error:Et}||s&&{error:s}||{eventMatchUpFormatTiming:o}},removeEventMatchUpFormatTiming:function({tournamentRecords:t,eventId:e}){if(!t)return{error:q};if("string"!=typeof e)return{error:me,info:"missing eventId"};for(const n of Object.values(t)){const{event:t}=Ls({tournamentRecord:n,eventId:e});if(t)return qy({event:t})}return{error:Et}},getMatchUpDailyLimitsUpdate:function({tournamentRecords:t}){return KU({extensionName:Co,tournamentRecords:t})},getMatchUpDailyLimits:jy,setMatchUpDailyLimits:function({tournamentRecords:t,tournamentId:e,dailyLimits:n}){if("object"!=typeof t||!Object.keys(t).length)return{error:q};const r=Object.keys(t).filter((t=>!e||e===t));if(e&&!r.includes(e))return{error:xn};for(const i of r){const e=sS({tournamentRecord:t[i],dailyLimits:n});if(e.error)return e}return{...L}},getProfileRounds:Qy,getRounds:dS,assignMatchUpVenue:function(t){const e=AI(t);if(e.error)return e;const{tournamentRecord:n,drawDefinition:r}=e,{matchUpId:i,venueId:a,disableNotice:o,removePriorValues:s}=t;return r?hI({tournamentRecords:t.tournamentRecords,removePriorValues:s,tournamentRecord:n,drawDefinition:r,disableNotice:o,matchUpId:i,venueId:a}):{error:Y}},assignMatchUpCourt:function(t){const e=AI(t);if(e.error)return e;const{tournamentRecord:n,drawDefinition:r}=e;if(!n)return{error:$};if(!r)return{error:Y};const{removePriorValues:i,tournamentRecords:a,disableNotice:o,courtDayDate:s,matchUpId:c,courtId:u}=t;return II({removePriorValues:i,tournamentRecords:a,tournamentRecord:n,drawDefinition:r,disableNotice:o,courtDayDate:s,matchUpId:c,courtId:u})},allocateTeamMatchUpCourts:function(t){const e=AI(t);if(e.error)return e;const{tournamentRecord:n,drawDefinition:r}=e;if(!r)return{error:Y};const{removePriorValues:i,tournamentRecords:a,disableNotice:o,courtDayDate:s,matchUpId:c,courtIds:u}=t;return fI({removePriorValues:i,tournamentRecords:a,tournamentRecord:n,drawDefinition:r,disableNotice:o,courtDayDate:s,matchUpId:c,courtIds:u})},addMatchUpScheduleItems:function(t){const e=AI(t);if(e.error)return e;const{tournamentRecord:n,drawDefinition:r}=e;return Xy({...t,tournamentRecord:n,drawDefinition:r})},addMatchUpScheduledDate:function(t){const e=AI(t);if(e.error)return e;const{tournamentRecord:n,drawDefinition:r}=e;if(!r)return{error:Y};const{disableNotice:i,scheduledDate:a,matchUpId:o,removePriorValues:s}=t;return Zy({removePriorValues:s,tournamentRecord:n,drawDefinition:r,disableNotice:i,scheduledDate:a,matchUpId:o})},addMatchUpScheduledTime:function(t){const e=AI(t);if(e.error)return e;const{tournamentRecord:n,drawDefinition:r}=e,{disableNotice:i,scheduledTime:a,matchUpId:o,removePriorValues:s}=t;return r?tS({removePriorValues:s,tournamentRecord:n,drawDefinition:r,disableNotice:i,scheduledTime:a,matchUpId:o}):{error:Y}},addMatchUpCourtOrder:function(t){const e=AI(t);if(e.error)return e;const{tournamentRecord:n,drawDefinition:r}=e,{removePriorValues:i,disableNotice:a,courtOrder:o,matchUpId:s}=t;return function({removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,courtOrder:i,matchUpId:a}){return wI({removePriorValues:t,tournamentRecord:e,drawDefinition:n,disableNotice:r,courtOrder:i,matchUpId:a})}({removePriorValues:i,tournamentRecord:n,drawDefinition:r,disableNotice:a,courtOrder:o,matchUpId:s})},addMatchUpStartTime:function(t){const e=AI(t);if(e.error)return e;const{tournamentRecord:n,drawDefinition:r}=e,{disableNotice:i,startTime:a,matchUpId:o}=t;return eS({tournamentRecord:n,drawDefinition:r,disableNotice:i,startTime:a,matchUpId:o})},addMatchUpStopTime:function(t){const e=AI(t);if(e.error)return e;const{tournamentRecord:n,drawDefinition:r}=e,{disableNotice:i,stopTime:a,matchUpId:o}=t;return rS({tournamentRecord:n,drawDefinition:r,disableNotice:i,stopTime:a,matchUpId:o})},addMatchUpResumeTime:function(t){const e=AI(t);if(e.error)return e;const{tournamentRecord:n,drawDefinition:r}=e,{disableNotice:i,resumeTime:a,matchUpId:o}=t;return iS({tournamentRecord:n,drawDefinition:r,disableNotice:i,resumeTime:a,matchUpId:o})},addMatchUpEndTime:function(t){const e=AI(t);if(e.error)return e;const{tournamentRecord:n,drawDefinition:r}=e,{disableNotice:i,endTime:a,matchUpId:o}=t;return nS({tournamentRecord:n,drawDefinition:r,disableNotice:i,endTime:a,matchUpId:o})},addMatchUpOfficial:function(t){const e=AI(t);if(e.error)return e;const{tournamentRecord:n,drawDefinition:r}=e,{disableNotice:i,participantId:a,officialType:o,matchUpId:s}=t;return aS({tournamentRecord:n,drawDefinition:r,disableNotice:i,participantId:a,officialType:o,matchUpId:s})},getSchedulingProfile:ry,setSchedulingProfile:iy,addSchedulingProfileRound:ay,validateSchedulingProfile:QU,addPersonRequests:function({tournamentRecords:t,personId:e,requests:n}){if(!t)return{error:q};if("string"!=typeof e)return{error:xn};if(!Array.isArray(n))return{error:xn};const{personRequests:r}=ky({tournamentRecords:t}),{mergeCount:i}=_y({personRequests:r,personId:e,requests:n});return i&&r?xy({tournamentRecords:t,personRequests:r}):{error:xn}},getPersonRequests:ky,modifyPersonRequests:function({tournamentRecords:t,requests:e,personId:n}){if(!t)return{error:q};if(!Array.isArray(e))return{error:xn};const r=e.map((({requestId:t})=>t)).filter(Boolean),{personRequests:i}=ky({tournamentRecords:t}),a=t=>{i&&(i[t]=i[t].map((t=>{if(!r.includes(t.requestId))return t;const n=e.find((e=>e.requestId===t.requestId));return n.requestType?Object.assign(t,n):void 0})).filter(Boolean))};if(n&&i?.[n])a(n);else if(i)for(const s of Object.keys(i))a(s);const o=e.filter((t=>!t.requestId));return o.length&&_y({personRequests:i,personId:n,requests:o}),xy({tournamentRecords:t,personRequests:i})},removePersonRequests:function({tournamentRecords:t,requestType:e,requestId:n,personId:r,date:i}){if("object"!=typeof t||!Object.keys(t).length)return{error:q};const{personRequests:a}=ky({tournamentRecords:t}),o=t=>{a&&(a[t]=a[t].filter((t=>!(e&&t.requestType===e||n&&t.requestId===n||i&&t.date===i))),a?.[t]?.length||delete a[t])},s=!(e||n||r||i);if(!s)if(r&&a?.[r])o(r);else if(a)for(const c of Object.keys(a))o(c);return!s&&a&&Object.keys(a).length?xy({tournamentRecords:t,personRequests:a}):Js({tournamentRecords:t,name:Mo})}};function lS({tournamentRecord:t,policyDefinitions:e,allowReplacement:n}){if(!t)return{error:$};if(!e||"object"!=typeof e)return{error:re};t.extensions||(t.extensions=[]);const r=Vo({tournamentRecord:t}).appliedPolicies??{},i=Object.keys(e).map((t=>{if(!r[t]||n)return r[t]=e[t],t})).filter(Boolean);if(i?.length){const e=qs({tournamentRecord:t,extension:{name:fo,value:r}});if(e.error)return e}return i?.length?{...L,applied:i}:{error:se}}function mS({policyDefinitions:t,allowReplacement:e,event:n}){if(!n)return{error:At};if(!t)return{error:re};let r=0;n.extensions||(n.extensions=[]);const i=Vo({event:n}).appliedPolicies??{};if(Object.keys(t).forEach((n=>{i[n]&&!e||(i[n]=t[n],r++)})),r){Ws({event:n,extension:{name:fo,value:i}})}return r?L:{error:ce}}const fS={attachPolicies:function({tournamentRecords:t,policyDefinitions:e}){if("object"!=typeof t||!Object.keys(t).length)return{error:q};for(const n of Object.values(t)){const t=lS({allowReplacement:!0,tournamentRecord:n,policyDefinitions:e});if(t.error)return t}return{...L}}};function hS(){return"\n    This project would not have been possible without the generous input and patience\n    of tournament organizers and directors who worked with early versions of CourtHive/TMX.\n\n    Thanks to Pavel, Ivan, Mladen, Zdenko, Antoina, Jakov, Kreso, Barry, Jeff, Bobby... to name just a few. \n\n    The project would not have even begun without the support of Miro, or the introduction by Sretchko.\n    The project would not have succeeded without the enthusiasm of Randy and Bruce.\n    Thanks to serendipity and Luca and the ensuing TODS conversations with ITF.\n    Thanks to Scott and Jake for sanity checks, suggestions, and camaraderie.\n    Thanks to Zoran for inspiring the async support and getting into the weeds with subscriptions.\n    Thanks to Dave for backing the conversion of TMX 1.x source into the factory repository.\n    Thanks to Vuk and Pavle and Rich and Chris and Deepa for the direct engagement with the APIs.\n    Thanks to Joe for repeatedly challenging me and the many pointers to useful tooling.\n    Thanks to Shannon for the validation of the approach from his deep domain experience.\n    Thanks to Nikola for the ongoing camaraderie and explorations of what we can do with TODS.\n\n    And a special thanks to my family for putting up with the long days and weeks and months of coding\n    and conversations at all hours.\n  "}function IS({restrictQualifyingAlternates:t,structure:e,entry:n}){const{stage:r}=e;if(!n.entryStage||n.entryStage===r||r===zu&&!t||n.entryStage===Hu&&r===Yu)return!0}const gS={[Xa]:{policyName:"matchUpActionsDefault",enabledStructures:[{stages:[],stageSequences:[],enabledActions:[],disabledActions:[]}],participants:{enforceCategory:!0,enforceGender:!0},processCodes:{substitution:["RANKING.IGNORE","RATING.IGNORE"]},substituteAfterCompleted:!1,substituteWithoutScore:!1}},US="positionAction",yS="matchUpAction";function SS({actionType:t=US,appliedPolicies:e,drawDefinition:n,structure:r}){const i=t===US&&Qa||t===yS&&Xa,a=t===US&&Cf||t===yS&&gS,o=i&&(e?.[i]||a?.[i]),s=n.links?.filter((t=>t?.target?.structureId===r?.structureId)),c=s?.map((({target:t})=>t.feedProfile))??[],{enabledStructures:u,disabledStructures:d}=o||{},p=d?.find((t=>{const{stages:e,stageSequences:n,structureTypes:i,feedProfiles:a}=t;return(!a?.length||Array.isArray(a)&&a.some((t=>c.includes(t))))&&(!e?.length||Array.isArray(e)&&e?.includes(r?.stage))&&(!i?.length||Array.isArray(i)&&i?.includes(r?.structureType))&&(!n?.length||Array.isArray(n)&&n.includes(r?.stageSequence))}));return{enabledStructures:u,actionsDisabled:p,actionsPolicy:o}}function vS({activePositionOverrides:t,activeDrawPositions:e,action:n}){return!(!n||!t.includes(n))||!e.length}function wS({enabledStructures:t,drawDefinition:e,structure:n}){if(!1===t)return{};if(!t?.length)return{policyActions:{enabledActions:[],disabledActions:[]}};const{stage:r,stageSequence:i,structureType:a}=n||{},o=e.links?.filter((t=>t?.target?.structureId===n?.structureId)),s=o?.map((({target:t})=>t.feedProfile))||[];return{policyActions:t.find((t=>{const{stages:e,stageSequences:n,structureTypes:o,feedProfiles:c}=t||{},u=!e?.length||Array.isArray(e)&&e.includes(r),d=!n?.length||Array.isArray(n)&&n.includes(i),p=!o?.length||Array.isArray(o)&&o.includes(a),l=!c?.length||Array.isArray(c)&&c.some((t=>s.includes(t)));return d&&p&&l&&t&&u}))}}function TS({action:t,policyActions:e}){const n=!e?.enabledActions||e?.disabledActions?.length&&e.disabledActions.includes(t);if(n)return!1;return(0===e?.enabledActions.length||e?.enabledActions.includes(t))&&!n}const PS="replaceTieMatchUpParticipantId",DS="assignTieMatchUpParticipantId",NS="removeTieMatchUpParticipantId",RS="assignMatchUpSideParticipant",bS="removeMatchUpSideParticipant",MS="substituteParticipant",AS="REMOVE_SUBSTITUTION",ES="REPLACE_PARTICIPANT",CS="REMOVE_PARTICIPANT",OS="setMatchUpStatus",FS="SUBSTITUTION",kS="SCHEDULE",xS="REFEREE",_S="STATUS",LS="START",BS="SCORE",VS="END",jS={REPLACE_TEAM_POSITION_METHOD:PS,ASSIGN_TEAM_POSITION_METHOD:DS,REMOVE_TEAM_POSITION_METHOD:NS,REPLACE_PARTICIPANT:ES,SUBSTITUTION_METHOD:MS,REMOVE_SUBSTITUTION:AS,REMOVE_PARTICIPANT:CS,SCHEDULE_METHOD:OS,SUBSTITUTION:FS,SCHEDULE:kS,PENALTY:"PENALTY",REFEREE:xS,STATUS:_S,SCORE:BS,START:LS,END:VS};function GS({restrictAdHocRoundParticipants:t=!0,policyDefinitions:e,tournamentParticipants:n=[],inContextDrawMatchUps:r,tournamentRecord:i,drawDefinition:a,participantId:o,matchUpsMap:s,sideNumber:c,matchUpId:u,event:d}){if(!a)return{error:Y};if(!u)return{error:Jt};if(c&&![1,2].includes(c))return Oi({result:{error:xn},context:{sideNumber:c}});const p=e?.[Qa]?.otherFlightEntries,{drawId:l}=a,{matchUp:m,structure:f}=$p({drawDefinition:a,matchUpId:u,event:d});if(!m)return{error:Xt};const h=Vo({tournamentRecord:i,drawDefinition:a,structure:f,event:d}).appliedPolicies??{};Object.assign(h,e??{});const I=Fp({drawDefinition:a,structure:f}),g=h?.[Xa]??gS[Xa],{enabledStructures:U}=SS({actionType:yS,appliedPolicies:h,drawDefinition:a,structure:f}),{policyActions:y}=wS({enabledStructures:U,drawDefinition:a,structure:f});s=s??wp({drawDefinition:a}),r||({matchUps:r}=Pl({tournamentParticipants:n,inContext:!0,drawDefinition:a,matchUpsMap:s,event:d}));const S=r?.find((t=>t.matchUpId===u)),v=c&&S?.sides?.find((t=>t.sideNumber===c)),w=S?.sides?.map((t=>t.participantId||t.participant?.participantid)).filter(Boolean)??[],{assignedPositions:P,allPositionsAssigned:D}=bp({structure:f}),{structureId:N}=f??{},R=[];if(!N)return{validActions:R};if(I){const e=(f?.matchUps??[]).filter((({roundNumber:t})=>t===m.roundNumber)),r=a?.entries?.filter((({entryStatus:t})=>t&&pp.includes(t))).map(ml)??[],i=e.map((t=>(t.sides??[]).flatMap(ml))).flat().filter(Boolean),o=r.filter((e=>!(w.includes(e)||t&&i.includes(e)))),s=n?.filter((t=>o?.includes(t.participantId))).map((t=>ri(t,void 0,!0)));s?.forEach((t=>{const e=(a.entries??[]).find((e=>e.participantId===t.participantId));t.entryPosition=e?.entryPosition})),o.length&&R.push({payload:{drawId:l,matchUpId:u,structureId:N,sideNumber:c},method:RS,type:wf,availableParticipantIds:o,participantsAvailable:s});const h=function({eventEntries:t,structure:e}){const n=t=>t.entryStatus===Kd&&IS({structure:e,entry:t}),r=(t,e)=>(t.entryPosition||1/0)-(e.entryPosition||1/0);return t.filter(n).sort(r).map(ml)}({eventEntries:d?.entries??[],structure:f});let I=T(r.concat(h));if(p){const t=d?_s({event:d}):void 0,e=t?.flights?.filter((t=>t.drawId!==l)).flatMap((t=>t.drawEntries.filter((t=>t.participantId&&![cp,ap,op].includes(t.entryStatus))).map((({participantId:t})=>t)))).filter(Boolean);e?.length&&I.push(...e)}I=I.filter((e=>!(w.includes(e)||o.includes(e)||t&&i.includes(e))));const g=n?.filter((t=>I.includes(t.participantId))).map((t=>ri(t,void 0,!0)));if(g.forEach((t=>{const e=(a.entries??[]).find((e=>e.participantId===t.participantId));t.entryPosition=e?.entryPosition})),g.sort(((t,e)=>(t.entryPosition||1/0)-(e.entryPosition||1/0))),I.length&&R.push({payload:{drawId:l,matchUpId:u,structureId:N,sideNumber:c},availableParticipantIds:I,participantsAvailable:g,method:RS,type:Kd}),!Yp(m)&&c){const t=m.sides?.find((t=>t.sideNumber===c));t?.participantId&&R.push({payload:{drawId:l,matchUpId:u,structureId:N,sideNumber:c},method:bS,type:CS})}}const b=dg({drawDefinition:a,structure:f}),M=P?.filter((t=>t.participantId)).map((t=>t.drawPosition)),A=P?.filter((t=>t.bye)).map((t=>t.drawPosition)),E=m.collectionId,C=m.matchUpStatus===Ki||!E&&m.drawPositions?.reduce(((t,e)=>A?.includes(e)||t),!1);if(C)return{validActions:R,isByeMatchUp:C};TS({policyActions:y,action:xS})&&R.push({type:xS,payload:{matchUpId:u}});const O=!Kp({matchUpStatus:m.matchUpStatus}),F=h?.scoring?.structures,k=f?.stage&&F?.stage&&F?.stage[f.stage],x=f?.stageSequence&&k?.stageSequence&&k.stageSequence[f.stageSequence],_=!(h?.scoring?.requireAllPositionsAssigned||k?.requireAllPositionsAssigned||x?.requireAllPositionsAssigned)||D,L=m.sides&&2===m.sides.filter((t=>t?.participantId)).length,B=m.matchUpStatus&&[ea,ta].includes(m.matchUpStatus),V=yl({inContextDrawMatchUps:r,drawDefinition:a,matchUpId:u}),j=xg({inContextDrawMatchUps:r,drawDefinition:a,targetData:V}),G=(2===S?.drawPositions?.length&&S.drawPositions.every((t=>M?.includes(t)))&&2===S?.sides?.length&&S.sides.every((({participantId:t})=>t))||L)&&!(B&&j),q={method:gf,type:Mf,payload:{drawId:l,matchUpId:u,penaltyCode:void 0,penaltyType:void 0,participantIds:[],notes:void 0}};if(O&&R.push({payload:{drawId:l,matchUpId:u,schedule:{}},method:OS,type:kS}),TS({policyActions:y,action:Mf})&&(v?.participant||!c&&w?.length)&&R.push(q),O&&G&&R.push({type:_S}),_&&G){const{matchUpId:t,matchUpFormat:e}=m,n={drawId:l,matchUpId:t,matchUpFormat:e,outcome:{scoreStringSide1:void 0,scoreStringSide2:void 0,sets:[]},winningSide:void 0};R.push({info:"set outcome and winningSide",method:OS,type:BS,payload:n}),TS({policyActions:y,action:LS})&&R.push({type:LS}),TS({policyActions:y,action:VS})&&R.push({type:VS})}if(E&&S){const t=S.sides?.find((t=>t.participant)),n=S.gender===Bp&&S.sideNumber&&1===S.sides?.filter((t=>t.particiapntId)).length&&t?.participant?.person?.sex,i=S.matchUpType,a=g?.participants?.enforceGender?S.gender:void 0,s=S.sides?.flatMap((t=>t.participant?.individualParticipants||t.participant)).filter(Boolean),d=s?.map(ml),p=S.sides?.filter((t=>!c||t.sideNumber===c)).flatMap((t=>t.participant?.individualParticipants||t.participant)).filter(Boolean),f=p?.map(ml),h=r?.find((t=>t.matchUpId===S.matchUpTieId)),I=h?.sides?.map((t=>t.participant.individualParticipants.filter((({participantId:t,person:e})=>!f?.includes(t)&&(!a||a===_p||e.sex===a||a===Bp&&!n||n&&e.sex!==n))))),U=c?I?.[c-1]:I?.map(((t,e)=>({participants:t,sideNumber:e+1}))),T=c?I?.[c-1]?.map(ml):I?.map(((t,e)=>({participants:t?.map(ml),sideNumber:e+1}))),P=c&&(i===Ra&&!f?.length||i===Ma&&(f?.length??0)<2)||!c&&(i===Ra&&(f?.length??0)<2||i===Ma&&(f?.length??0)<4),D=T?.filter((t=>!d?.includes(t))),N=U?.filter((({participantId:t})=>D.includes(t)));if(P&&D?.length&&R.push({availableParticipantIds:D,method:DS,availableParticipants:N,type:wf,payload:{participantId:void 0,tieMatchUpId:u,drawId:l}}),!f?.length||Yp(m)&&!v?.substitutions?.length||R.push({method:NS,type:CS,existingParticipantIds:f,payload:{participantId:void 0,tieMatchUpId:u,drawId:l}}),N?.length&&(!c&&f?.length||c&&v?.participant)&&R.push({availableParticipantIds:D,method:PS,availableParticipants:N,type:ES,existingParticipantIds:f,payload:{existingParticipantId:void 0,participantId:void 0,tieMatchUpId:u,drawId:l}}),TS({policyActions:y,action:AS})&&v?.substitutions?.length){const t=v.participant?.participantType===Eu&&[v.participantId]||v.participant?.participantType===Ou&&v.participant.individualParticipantIds||[],e=v.substitutions.map((t=>t.participantId)).filter((e=>t.includes(e)));o&&!e.includes(o)||R.push({method:NS,type:AS,substitutedParticipantIds:e,payload:{participantId:void 0,tieMatchUpId:u,drawId:l}})}const b=e?.[Xa],M=b?.substituteWithoutScore,A=b?.substituteAfterCompleted;if(TS({policyActions:y,action:FS})&&2===w.length&&(!c&&f?.length||c&&v?.participant)&&(M||Yp(m))&&(A||m.matchUpStatus&&!fa.includes(m.matchUpStatus))&&p?.length&&U.length){const t=p.map(ml);R.push({info:"list of team players available for substitution",method:MS,availableParticipantIds:T,existingParticipantIds:t,availableParticipants:U,existingParticipants:p,type:FS,payload:{substituteParticipantId:void 0,existingParticipantId:void 0,sideNumber:c,matchUpId:u,drawId:l}})}}return{structureIsComplete:b,validActions:R,isDoubleExit:B}}function qS({policyDefinitions:t,tournamentRecord:e,drawDefinition:n,participantId:r,sideNumber:i,matchUpId:a,drawId:o,event:s}){if(!e)return{error:$};if(!o){const t=th({tournamentRecord:e}).matchUps||[];o=t.reduce(((t,e)=>e.matchUpId===a?e.drawId:t),void 0);n=(e.events||[]).map((t=>t.drawDefinitions||[])).flat().reduce(((t,e)=>e.drawId===o?e:t),void 0)}const{policyDefinitions:c}=jo({policyTypes:[Qa],tournamentRecord:e,drawDefinition:n,event:s});return t=t||c,n?GS({tournamentParticipants:e.participants,policyDefinitions:t,drawDefinition:n,participantId:r,sideNumber:i,matchUpId:a,event:s}):{error:J}}const $S={getParticipantScaleItem:function({tournamentRecords:t,policyDefinitions:e,scaleAttributes:n,participantId:r,personId:i}){let a=uU({tournamentRecords:t,policyDefinitions:e,participantId:r,personId:i});if(a.error)return a;const{participant:o,tournamentId:s}=a;return a=yh({participant:o,scaleAttributes:n}),a.error?{...a,tournamentId:s}:{...L,tournamentId:s,...a}},getCompetitionDateRange:ny,getTournamentIds:function({tournamentRecords:t}){const e=Object.keys(t);return{...L,tournamentIds:e}},competitionScheduleMatchUps:uy,getSchedulingProfileIssues:function(t){const{scheduleDates:e=[],tournamentRecords:n,periodLength:r=30}=t||{};if("object"!=typeof n)return{error:W};if(!Array.isArray(e))return{error:xn};if(!e.every(Cr))return{error:ye};const i=[];let a=0;const o={},{schedulingProfile:s}=ry({tournamentRecords:n});if(!s)return{issues:i,...L};const{matchUps:c}=ch({nextMatchUps:!0,tournamentRecords:n});for(const d of s){const{scheduleDate:t,venues:s=[]}=d;if(!e?.length||e.includes(t))for(const e of s||[])if(e){const{rounds:s}=e,u=[],{orderedMatchUpIds:d,scheduledRoundsDetails:p}=ty({tournamentRecords:n,periodLength:r,matchUps:c,rounds:s}),{matchUpDependencies:l}=ph({tournamentRecords:n,matchUps:c}),m=t=>{let e;return p?.find(((n,r)=>{const i=n.matchUpIds.includes(t);return i&&(e=r),i})),e};if(d?.forEach(((t,e)=>{const n=O(d.slice(e+1),l?.[t]?.matchUpIds||[]);n.length&&u.push({matchUpId:t,shouldBeAfter:n})})),u.length){a+=u.length;const e=u.map((({matchUpId:e,shouldBeAfter:n})=>{const r=m(e),i=T(n.map(m));return o[t]||(o[t]={}),o[t][r]||(o[t][r]=[]),i.forEach((e=>{o[t][r].includes(e)||o[t][r].push(e)})),{matchUpId:e,matchUpRoundIndex:r,earlierRoundIndices:i,shouldBeAfter:n}}));i.push(...e)}}}const u={matchUpIdShouldBeAfter:Object.assign({},...i.map((t=>{const{matchUpId:e,shouldBeAfter:n,earlierRoundIndices:r}=t;return{[e]:{earlierRoundIndices:r,shouldBeAfter:n}}})))};return{issuesCount:a,profileIssues:u,roundIndexShouldBeAfter:o,...L}},allCompetitionMatchUps:ch,competitionMatchUps:uh,matchUpActions:function(t){const{tournamentRecords:e,participantId:n,tournamentId:r,sideNumber:i,matchUpId:a,eventId:o,drawId:s}=t??{};if("object"!=typeof e||"string"!=typeof r||"string"!=typeof a||"string"!=typeof s)return{error:xn};const c=e[r];if(!c)return{error:$};const u=Ls({tournamentRecord:c,eventId:o,drawId:s});return u.error?u:qS({drawDefinition:u.drawDefinition,tournamentRecord:c,participantId:n,sideNumber:i,matchUpId:a,drawId:s})},getCompetitionVenues:cI,getVenuesAndCourts:sI,getVenuesReport:function({ignoreDisabled:t=!0,tournamentRecords:e,venueIds:n=[],dates:r=[]}){if(!Array.isArray(r))return{error:xn,dates:r};if(!Array.isArray(n))return{error:xn,venueIds:n};if(!r.every(Cr))return{error:ye};const i=sI({tournamentRecords:e,ignoreDisabled:t,dates:r});if(i.error)return i;const a=i?.venues?.filter((({venueId:t})=>!n?.length||n.includes(t))),o=i.courts?.reduce(((t,e)=>(e.dateAvailability?.forEach((e=>{const n=e.date;t.includes(n)||t.push(n)})),t)),[]).filter((t=>!r.length||r.includes(t))),s={venueIds:a?.map((({venueId:t})=>t))},{matchUps:c}=ch({afterRecoveryTimes:!0,tournamentRecords:e,matchUpFilters:s}),u=a?.map((t=>function(t,e,n){const{venueId:r,courts:i,venueName:a}=e,o={};return t.forEach((t=>{let e=0,a=0,s=0;for(const n of i){const r=n.dateAvailability.find((e=>e.date===t)),i=r&&vh({courtDate:r}),a=i?.reduce(((t,e)=>{const{startTime:n,endTime:r}=e;return t+(jr(r)-jr(n))}),0);a&&(s+=1),e+=a}const c=n.filter((({schedule:e})=>e.venueId===r&&ei(t,e.scheduledDate)));c.forEach((({schedule:t})=>{const e=qr(t.scheduledTime),n=jr(Xr(e,t.averageMinutes))-jr(e);a+=n}));const u=e?(a/e*100).toFixed(2):"100";o[t]={scheduledMatchUpsCount:c.length,availableCourts:s,availableMinutes:e,scheduledMinutes:a,percentUtilization:u}})),{venueId:r,venueName:a,venueReport:o}}(o,t,c)));return{venuesReport:u}},credits:hS};function WS({tournamentRecord:t,courtIds:e,dates:n}){if(!t)return{error:$};if(!Array.isArray(e))return{info:Ci("courtIds"),error:me};const r=!Array.isArray(n)||!n.length||{dates:n},i=t=>Bs({creationTime:!1,element:t,extension:{value:r,name:Uo}});for(const a of t.venues||[])for(const t of a.courts||[])if(e?.includes(t.courtId)){const e=i(t);if(e.error)return e}return{...L}}function HS({tournamentRecord:t,venueIds:e}){if(!t)return{error:$};if(!Array.isArray(e))return{error:me,info:Ci("venueIds")};for(const n of t.venues||[])if(e?.includes(n.venueId)){const t=Bs({creationTime:!1,element:n,extension:{name:Uo,value:!0}});if(t.error)return t}return{...L}}function zS({tournamentRecord:t,courtIds:e,enableAll:n,dates:r}){if(!t)return{error:$};if(!Array.isArray(e)&&!n)return{error:me,info:Ci("courtIds")};for(const i of t.venues||[])for(const t of i.courts||[])if(n||e?.includes(t.courtId))if(Array.isArray(r)){const{extension:e}=tc({element:t,name:Uo});if(e){const n=e.value;Array.isArray(n.dates)&&(n.dates=n.dates.filter((t=>!r.includes(t)))),Bs({creationTime:!1,element:t,extension:{name:Uo,value:n}})}}else Gs({element:t,name:Uo});return{...L}}function YS({tournamentRecord:t,venueIds:e,enableAll:n}){if(!t)return{error:$};if(!Array.isArray(e)&&!n)return{error:me,info:Ci("venueIds")};for(const r of t.venues||[])(n||e?.includes(r.venueId))&&Gs({element:r,name:Uo});return{...L}}function KS({tournamentRecord:t,drawDefinition:e,matchUpId:n,drawId:r}){if(!n)return{error:Jt};if(!e&&!r)return{error:lt};let i;if(!e){if(!t)return{error:$};({drawDefinition:e}=Ls({tournamentRecord:t,drawId:r}))}if(e)({matchUp:i}=$p({drawDefinition:e,matchUpId:n}));else{if(!t)return{error:$};const e=th({tournamentRecord:t,inContext:!1}).matchUps??[];({matchUp:i}=Jo({matchUps:e,matchUpId:n}))}if(!i)return{error:Xt};if(i.timeItems){i.timeItems.find((t=>[Vc,Bc].includes(t.itemType)))&&(i.timeItems=i.timeItems.filter((({itemType:t})=>![Vc,Bc].includes(t))),nl({tournamentId:t?.tournamentId,context:"removeCourtAssignment",drawDefinition:e,matchUp:i}))}return{...L}}function JS({matchUpsCount:t=0}){return{error:Qn,info:`Schedule would be deleted from ${t} ${1===t?"matchUp":"matchUps"}; use { force: true }`}}function QS({tournamentRecord:t,venueId:e,force:n}){if(!t)return{error:$};if("string"!=typeof e)return{error:fn};const r=th({tournamentRecord:t,contextFilters:{venueIds:[e]}}).matchUps||[];if(r.length&&!n)return JS({matchUpsCount:r.length});for(const a of r){const e=KS({matchUpId:a.matchUpId,drawId:a.drawId,tournamentRecord:t});if(e.error)return e}let i;return t.venues=(t.venues||[]).filter((t=>t?.venueId!==e||(i=!0,!1))),i?(dr({payload:{venueId:e,tournamentId:t.tournamentId},topic:uc,key:e}),{...L}):{error:mn}}function XS({tournamentRecord:t}){if(!t)return{error:$};const e=t.tournamentId,{extension:n}=Us({name:Fo,tournamentRecord:t});let r=n?.value||[];if(r.length){const n=t.venues?.map((({venueId:t,courts:e})=>e?.length&&t)),i=bI({tournamentRecords:{[e]:t}}),{eventIds:a,drawIds:o}=i,{updatedSchedulingProfile:s,modifications:c,issues:u}=oy({schedulingProfile:r,venueIds:n,eventIds:a,drawIds:o});if(c){r=s;const e=function({tournamentRecord:t,schedulingProfile:e}){return qs({tournamentRecord:t,extension:{name:Fo,value:e}})}({tournamentRecord:t,schedulingProfile:r});return e.error?e:{schedulingProfile:r,modifications:c,issues:u}}}return{schedulingProfile:r,modifications:0}}function ZS({requireCourts:t=!0,tournamentRecord:e,schedulingProfile:n}){if(!n){const{modifications:t,issues:n}=XS({tournamentRecord:e});return{success:!t,modifications:t,issues:n}}const{venueIds:r,eventIds:i,drawIds:a}=XU({tournamentRecord:e,requireCourts:t}),{modifications:o,issues:s}=oy({schedulingProfile:n,venueIds:r,eventIds:i,drawIds:a});return{success:!o,modifications:o,issues:s}}function tv(t){if(!t?.tournamentRecord&&!Array.isArray(t?.venueMatchUps))return{error:$};if(!t?.courtId)return{error:le};const{scheduleVisibilityFilters:e,tournamentRecord:n,matchUpFilters:r,venueMatchUps:i,courtId:a}=t,{schedulingProfile:o}=XS({tournamentRecord:n});if(Array.isArray(i))return{matchUps:c({matchUps:i,courtId:a})};const{matchUps:s}=th({scheduleVisibilityFilters:e,tournamentRecord:n,matchUpFilters:r});return{matchUps:c({matchUps:s,courtId:a})};function c({matchUps:t,courtId:e}){return cy({matchUps:t.filter((t=>{const n=t.schedule?.allocatedCourts?.map((({courtId:t})=>t));return t.schedule?.courtId===e||n?.includes(e)})),schedulingProfile:o})}}function ev({tournamentRecord:t,drawDefinition:e,disableNotice:n,courtId:r,force:i}){const a=Oc({tournamentRecord:t,courtId:r});if(a.error)return a;const o=a.venue,{matchUps:s}=tv({tournamentRecord:t,courtId:r});if(s?.length&&!i)return JS({matchUpsCount:s.length});for(const c of s||[]){const n=KS({matchUpId:c.matchUpId,drawId:c.drawId,tournamentRecord:t,drawDefinition:e});if(n.error)return n}return o&&(o.courts=(o.courts||[]).filter((t=>t.courtId!==r)),n||dr({topic:Sc,payload:{venue:o,tournamentId:t.tournamentId},key:o.venueId})),{...L}}function nv(t){return parseInt(t)}function rv({startTime:t="",endTime:e=""}={}){if(!(t&&e&&br.test(t)&&br.test(e)))return!1;const[n,r]=t.split(":").map(nv),[i,a]=e.split(":").map(nv);return!(i<n)&&!(n===i&&a<r)}function iv(t,e){const[n,r]=t.startTime.split(":").map(nv),[i,a]=e.startTime.split(":").map(nv);return n<i?-1:n>i?1:r<a?-1:r>a?1:0}function av({dateAvailability:t}){if(!t)return{error:Ue};if(!Array.isArray(t))return{error:ge};const e="Times must be 24 hour => 00:00";for(const n of t){if("object"!=typeof n)return{error:ge};const{date:t,startTime:r,endTime:i,bookings:a=[]}=n;if(!r||!i)return{error:ge};if(t&&!Rr.test(t))return{error:ye,dateAvailability:{date:t},info:"Dates must be formated => YYYY-MM-DD"};if(!br.test(r))return{error:Se,dateAvailability:{startTime:r},info:e};if(!br.test(i))return{error:Se,dateAvailability:{endTime:i},info:e};if(r===i)return{error:Se,dateAvailability:{startTime:r,endTime:i},info:"startTime and endTime are equivalent"};if(!rv({startTime:r,endTime:i}))return{error:Se,dateAvailability:{startTime:r,endTime:i},info:"endTime must be after startTime"};if(a){if(!Array.isArray(a))return{error:Ie};for(const t of a){if("object"!=typeof t)return{error:Ie};const{startTime:n,endTime:r}=t;if(!br.test(n))return{error:Se,booking:{startTime:n},info:e};if(!br.test(r))return{error:Se,booking:{endTime:r},info:e};if(n===r)return{error:Se,dateAvailability:{startTime:n,endTime:r},info:"startTime and endTime are equivalent"};if(!rv({startTime:n,endTime:r}))return{error:Se,dateAvailability:{startTime:n,endTime:r},info:"endTime must be after startTime"}}}}return{valid:!0}}function ov({tournamentRecord:t,dateAvailability:e,disableNotice:n,venueMatchUps:r,courtId:i,force:a}){if(!t)return{error:$};if(!i)return{error:le};const o=av({dateAvailability:e});if(o.error)return o;const{updatedDateAvailability:s,totalMergeCount:c}=function(t){let e=0;const n=t.reduce(((t,e)=>{const{date:n,startTime:r,endTime:i,bookings:a}=e;return t[n]||(t[n]=[]),t[n].push({startTime:r,endTime:i,bookings:a}),t}),{}),r=[];return Object.keys(n).forEach((t=>{n[t].sort(iv);const{mergedAvailability:i,mergeCount:a}=function(t){let e,n,r,i=t.length,a=0;const o=[];for(;t.length&&i;){const s=t.shift(),{startTime:c,endTime:u,bookings:d}=s;if(i-=1,e){if(Qr(Jr(n),Jr(c),!1)>0){const t={startTime:e,endTime:n};r?.length&&(t.bookings=r),o.push(t),e=c,r=d,n=u}else d&&(r?r.push(d):r=d),n=u,a+=1}else e=c,r=d,n=u}const s={startTime:e,endTime:n};r?.length&&(s.bookings=r);return o.push(s),{mergedAvailability:o,mergeCount:a}}(n[t]);r.push(...i.map((e=>({date:t,...e})))),e+=a})),{updatedDateAvailability:r,totalMergeCount:e}}(e);e=s;const u=Oc({tournamentRecord:t,courtId:i});if(u.error)return u;const{court:d,venue:p}=u,{matchUps:l}=tv({tournamentRecord:t,venueMatchUps:r,courtId:i});return l?.length&&console.log("scheduled court matchUps",l.length),d&&(d.dateAvailability=e,!n&&p&&dr({payload:{venue:p,tournamentId:t.tournamentId},topic:Sc,key:p.venueId})),{...L,totalMergeCount:c}}const sv=()=>({altitude:void 0,courtId:void 0,courtName:"",courtDimensions:void 0,latitude:void 0,longitude:void 0,surfaceCategory:void 0,surfaceType:void 0,surfacedDate:void 0,dateAvailability:[],onlineResources:[],pace:void 0,notes:void 0});function cv({tournamentRecord:t,disableNotice:e,venueMatchUps:n,modifications:r,courtId:i,force:a}){if(!t)return{error:$};if(!i)return{error:le};if(!r||"object"!=typeof r)return{error:On};const o=Oc({tournamentRecord:t,courtId:i});if(o.error)return o;const{venue:s,court:c}=o,u=Object.keys(sv()).filter((t=>"courtId"!==t));if(!Object.keys(r).filter((t=>u.includes(t))).length)return{error:Vn};const d=u.filter((t=>!["dateAvailability"].includes(t))),p=Object.keys(r).filter((t=>d.includes(t)));if(c&&p.forEach((t=>Object.assign(c,{[t]:r[t]}))),r.dateAvailability){const o=ov({dateAvailability:r.dateAvailability,tournamentRecord:t,venueMatchUps:n,disableNotice:e,courtId:i,force:a});if(o.error)return o}return e||dr({payload:{venue:s,tournamentId:t.tournamentId},topic:Sc,key:s?.venueId}),{...L,court:ri(c)}}const uv=()=>({venueId:void 0,venueName:"",venueAbbreviation:"",onlineResources:[],venueType:void 0,addresses:[],contacts:[],courts:[],roles:[]});function dv({tournamentRecord:t,disableNotice:e,venueId:n,courtId:r,court:i}){const{venue:a}=Cc({tournamentRecord:t,venueId:n});if(!a)return{error:mn};a.courts||(a.courts=[]);const o={...sv(),venueId:n,courtId:r};o.courtId||(o.courtId=hi());if(a.courts.some((t=>t.courtId===o.courtId)))return{error:pn};{const r=(i?.dateAvailability||[]).map((t=>({...t,date:$r(t.date),startTime:qr(t.startTime),endTime:qr(t.endTime),bookings:t.bookings?.map((({startTime:t,endTime:e,bookingType:n})=>({startTime:qr(t),endTime:qr(e),bookingType:n})))}))),s=Object.keys(o);for(const t of s)if(i?.[t])if("dateAvailability"===t){const t=av({dateAvailability:r});if(!t.valid&&t.error)return t;o.dateAvailability=r}else o[t]=i[t];const c=o;return a.courts.push(c),e||dr({payload:{venue:a,tournamentId:t.tournamentId},topic:Sc,key:a.venueId}),{...L,court:ri(o),venueId:n}}}function pv({courtNameRoot:t="Court",dateAvailability:e=[],venueAbbreviationRoot:n,tournamentRecord:r,courtNames:i=[],courtTimings:a,courtsCount:o,startTime:s,courtIds:c,endTime:u,idPrefix:d,venueId:p,dates:l}){if(!p)return{error:fn};const m=Cc({tournamentRecord:r,venueId:p});if(m.error)return m;const{venue:f}=m;if(!U(o)||!i)return{error:un};const h=E(0,o=o??i.length).map((r=>{const o=a?.[r],c=o?l.map((t=>({date:Fr(t),startTime:s,endTime:u,...o}))):e;return o&&s&&u&&c.push({startTime:s,endTime:u}),{courtName:i[r]||n&&f?.venueAbbreviation&&`${f?.venueAbbreviation} ${r+1}`||`${t} ${r+1}`,dateAvailability:c}})).map(((t,e)=>{const n=c?.pop()||d&&`${d}-${e+1}`;return dv({disableNotice:!0,tournamentRecord:r,courtId:n,venueId:p,court:t})})).map((t=>t.court)).filter(Boolean);return h.length!==o?{error:"Not all courts could be generated",result:m}:(f&&dr({payload:{venue:f,tournamentId:r.tournamentId},topic:Sc,key:f.venueId}),{...L,courts:ri(h)})}function lv({tournamentRecord:t,modifications:e,venueId:n,force:r}){if(!t)return{error:$};if(!e||"object"!=typeof e)return{error:On};if(!n)return{error:fn};const{matchUps:i}=function({scheduleVisibilityFilters:t,tournamentRecord:e,matchUpFilters:n,venueId:r}){if(!e)return{error:$};if(!r)return{error:fn};const{schedulingProfile:i}=XS({tournamentRecord:e}),{matchUps:a}=th({scheduleVisibilityFilters:t,tournamentRecord:e,matchUpFilters:n});return{matchUps:function({matchUps:t,venueId:e}){return cy({matchUps:t.filter((t=>{const n=t.schedule?.allocatedCourts?.map((({venueId:t})=>t));return t.schedule?.venueId===e||n?.includes(e)})),schedulingProfile:i})}({matchUps:a,venueId:r})}}({tournamentRecord:t,venueId:n}),a=Cc({tournamentRecord:t,venueId:n});if(a.error)return a;const o=a.venue,s=Object.keys(uv()).filter((t=>"venueId"!==t));if(!Object.keys(e).filter((t=>s.includes(t))).length)return{error:Vn};const c=s.filter((t=>!["courts","onlineResources"].includes(t))),u=Object.keys(e).filter((t=>c.includes(t)));o&&u.forEach((t=>Object.assign(o,{[t]:e[t]})));const d=o?.courts?.map((t=>t.courtId))??[],p=e.courts?.map((t=>t.courtId))||[],l=d.filter((t=>!p.includes(t)));if(l.length){const e=o?.courts?.filter((t=>l.includes(t.courtId))),n=e?.map((e=>{const n=tv({courtId:e.courtId,tournamentRecord:t,venueMatchUps:i});return n.matchUps?.length??0})).reduce(((t,e)=>t+e));if(!o||n&&!r)return JS({matchUpsCount:n});o.courts=o.courts?.filter((t=>p.includes(t.courtId)))}if(e.courts)for(const m of e.courts){const{courtId:e}=m||{};let a=cv({modifications:m,disableNotice:!0,tournamentRecord:t,venueMatchUps:i,courtId:e,force:r});if(a.error===dn&&(a=dv({disableNotice:!0,tournamentRecord:t,venueId:n,court:m})),a.error)return a}return ZS({tournamentRecord:t}),o&&dr({payload:{venue:o,tournamentId:t.tournamentId},topic:Sc,key:o?.venueId}),{...L,venue:ri(o)}}const mv={disableCourts:function({tournamentRecords:t,courtIds:e,dates:n}){if(!t)return{error:q};if(!Array.isArray(e))return{error:me,info:Ci("courtIds")};for(const r of Object.values(t))WS({tournamentRecord:r,courtIds:e,dates:n});return{...L}},disableVenues:function({tournamentRecords:t,venueIds:e}){if(!t)return{error:q};if(!Array.isArray(e))return{error:me,info:Ci("venueIds")};for(const n of Object.values(t))HS({tournamentRecord:n,venueIds:e});return{...L}},enableCourts:function({tournamentRecords:t,enableAll:e,courtIds:n,dates:r}){if(!t)return{error:q};if(!e&&!Array.isArray(n))return{error:me,info:Ci("courtIds")};for(const i of Object.values(t))zS({tournamentRecord:i,courtIds:n,enableAll:e,dates:r});return{...L}},enableVenues:function({tournamentRecords:t,venueIds:e,enableAll:n}){if(!t)return{error:q};if(!n&&!Array.isArray(e))return{error:me,info:Ci("venueIds")};for(const r of Object.values(t))YS({tournamentRecord:r,venueIds:e,enableAll:n});return{...L}},deleteCourt:function({tournamentRecords:t,courtId:e,force:n}){if(!t)return{error:q};if("string"!=typeof e)return{error:le};let r,i;for(const a of Object.values(t)){if(i=ev({tournamentRecord:a,courtId:e,force:n}),i.error&&i.error!==dn)return i;i.success&&(r=!0)}return r?{...L}:i},deleteVenue:function({tournamentRecords:t,venueId:e,force:n}){if(!t)return{error:q};if("string"!=typeof e)return{error:fn};let r;for(const i of Object.values(t)){const t=QS({tournamentRecord:i,venueId:e,force:n});if(t.error&&t.error!==mn)return t;t.success&&(r=!0)}return sy({tournamentRecords:t}),r?L:{error:mn}},modifyCourt:function({tournamentRecords:t,disableNotice:e,modifications:n,courtId:r,force:i}){if(!t)return{error:q};if(!r)return{error:me,info:"missing courtId"};let a,o;for(const s of Object.values(t)){const t=cv({tournamentRecord:s,disableNotice:e,modifications:n,courtId:r,force:i});t?.error&&(o=t),a=!0}return a?{...L}:o},modifyVenue:function({tournamentRecords:t,modifications:e,venueId:n,force:r}){if(!t)return{error:q};if("string"!=typeof n)return{error:fn};let i,a;for(const o of Object.values(t)){const t=lv({tournamentRecord:o,modifications:e,venueId:n,force:r});if(t.success&&(a=!0),t.error&&(i=t.error),t.error&&t.error!==mn)return t}return sy({tournamentRecords:t}),a?{...L}:{error:i}},addCourts:function(t){const{tournamentRecords:e,venueId:n}=t;if("string"!=typeof n||!n)return{error:fn};let r;for(const i of Object.values(e)){const{venue:e}=Cc({tournamentRecord:i,venueId:n});if(e){const e=pv({...t,tournamentRecord:i});if(e.error)return e;r=!0}}return r?L:{error:mn}},addVenue:function({tournamentRecords:t,disableNotice:e,venue:n,context:r}){if("object"!=typeof n)return{error:xn};let i;n.venueId||(n.venueId=hi());for(const a of Object.values(t)){const t=Ac({disableNotice:!0,tournamentRecord:a,context:r,venue:n});if(t?.error)return t;i=t.venue}return e||dr({topic:oc,payload:{venue:n}}),di({...L,venue:i})}};function fv({convertExtensions:t,removeExtensions:e}){const n=Ur();return{tournamentId:Ir(),tournamentRecords:ri(n,t,!1,e)}}function hv(){const t=Ur(),{extension:e}=Ks({name:No,tournamentRecords:t}),n=e?.value?.tournamentIds||[];return Object.keys(t).forEach((e=>{n.includes(e)||delete t[e]})),Sr(t)}function Iv(t,e=!0){return"object"!=typeof t||Array.isArray(t)?{error:On}:t?.tournamentId?yr(e?ri(t):t):{error:xn}}function gv(t,e=!0){if("object"!=typeof t)return{error:On};if(Array.isArray(t)){if(!(t.filter((t=>t?.tournamentId)).length===t.length))return{error:G};t=Object.assign({},...t.map((t=>({[t.tournamentId]:t}))))}else if(t?.tournamentId)t={[t.tournamentId]:t};else{if(!Object.keys(t).every((e=>t[e].tournamentId===e)))return{error:G}}return Sr(e?ri(t):t)}function Uv({result:t,methodName:e,elapsed:n,params:r,engine:i}){const a=ir(),o={method:e},s=t.error&&(!0===a.errors||Array.isArray(a.errors)&&a.errors.includes(e)),c=Array.isArray(a.params)&&a.params?.includes(e),u=a.params&&!Array.isArray(a.params)||c,d=Array.isArray(a.exclude)&&a.exclude.includes(e);d||[void 0,!1].includes(a.perf)||!(isNaN(a.perf)||n>a.perf)||(o.elapsed=n),d||!s&&!u||(o.params=r),!d&&(s||a.result&&!Array.isArray(a.result)&&(!Array.isArray(a.params)||c)||Array.isArray(a.result)&&a.result?.includes(e))&&(o.result=t),Object.keys(o).length>1&&console.log(i,o),a.makeDeepCopy&&(t.deepCopyIterations=nr.iterators.makeDeepCopy)}const yv=function(){const t={getState:t=>fv({convertExtensions:t?.convertExtensions,removeExtensions:t?.removeExtensions}),version:()=>"1.8.14",reset:()=>(Sr({}),e())};return[jU,fS,$S,$U,pS,mv].forEach((e=>{Object.keys(e).forEach((n=>{t[n]=t=>{if(ir())return r(e[n],t,n);try{return r(e[n],t,n)}catch(i){Pr({engineName:"competitionEngine",methodName:n,params:t,err:i})}}}))})),t.devContext=t=>(ar(t),e()),t.getDevContext=t=>ir(t),t.setState=(t,n,r)=>{sr(n,r);return e(gv(t,n))},t.setTournamentRecord=(t,n,r)=>{sr(n,r);return e(Iv(t,n))},t.removeTournamentRecord=t=>e(wr(t)),t.removeUnlinkedTournamentRecords=()=>e(hv()),t.executionQueue=(e,r)=>function(e,r){if(!Array.isArray(e))return{error:xn};const i=Ur(),a=Ir(),o=r&&ri(i,!1,!0);let s;const c=[];for(const d of e){if("object"!=typeof d)return{error:xn};const{method:e,params:r}=d;if(!t[e]){const t={error:Jn,methodName:e},n=ir();return(n.result&&!Array.isArray(n.result)||Array.isArray(n.result)&&n.result?.includes(e))&&console.log("ce:",t),t}const u=n(i,t[e],{activeTournamentId:a,...r},e);if(u?.error)return o&&gv(o),{...u,rolledBack:!!o};c.push({...u,methodName:e}),s=Date.now()}const u=ur();u&&Object.values(i).forEach((t=>{rI({tournamentRecord:t,value:{version:"1.8.14",timeStamp:s}})}));iI({directives:e,mutationStatus:u,timeStamp:s}),mr();return{success:c.every((t=>t.success)),results:c}}(e,r),t;function e(e){return e?.error?(t.error=e.error,t.success=!1):(t.error=void 0,t.success=!0),t}function n(e,n,r,i){delete t.success,delete t.error;const a=Date.now(),o=n({tournamentRecords:e,...r});return Uv({result:o,methodName:i,elapsed:Date.now()-a,params:r,engine:"ce:"}),o}function r(t,e,r){const i=Ur(),a=Ir(),o=e?.rollbackOnError&&ri(i,!1,!0),s=n(i,t,{activeTournamentId:a,...e},r);s?.error&&o&&gv(o);const c=s?.success&&!0!==e?.delayNotify&&!0!==e?.doNotNotify,u=ur(),d=Date.now();return u&&(Object.values(i).forEach((t=>{rI({tournamentRecord:t,value:{version:"1.8.14",timeStamp:d}})})),s.modificationsApplied=!0),c&&iI({directives:[{method:t,params:e}],mutationStatus:u,timeStamp:d}),(c||!s?.success||e?.doNotNotify)&&mr(),s}}();function Sv({structureName:t=gg(Ku),structureAbbreviation:e,drawDefinition:n,matchUpType:r,structureId:i}){if(!n)return{error:Y};const a=Ug({stage:Ku,structureAbbreviation:e,structureName:t,matchUps:[],structureId:i,matchUpType:r});return n.structures.push(a),il({drawDefinition:n,structureIds:[i]}),{...L}}function vv({targetEntryRound:t=1,finishingPositions:e,sourceRoundNumber:n,sourceStructureId:r,targetStructureId:i,linkType:a=_i.Winner}){if(!r||!i)return{error:Pt};return{link:di({linkType:a,source:{roundNumber:n,structureId:r,finishingPositions:e},target:{feedProfile:sd,roundNumber:t,structureId:i}})}}function wv({idPrefix:t,roundNumber:e,roundPosition:n,uuids:r}){return t?`${t}-${e}-${n}`:r?.pop()||hi()}function Tv({includeMatchUpType:t,matchUpType:e,roundNumber:n,matchUps:r,idPrefix:i,isMock:a,uuids:o,nodes:s}){let c=0;const u=[];let d=1;const p=n-1,l=s?.length;for(;c<(l||0);){const l=s?.[c],m=s?.[c+1];p&&(l.roundNumber=p),m&&p&&(m.roundNumber=p);const f={roundPosition:d,children:[l,m],matchUpId:wv({roundPosition:d,roundNumber:n,idPrefix:i,uuids:o})};u.push(f);const h={drawPositions:f.children.map((t=>t?.drawPosition)).filter(Boolean),matchUpStatus:sa,matchUpId:f.matchUpId,roundPosition:d,roundNumber:n};t&&e&&(h.matchUpType=e),a&&(h.isMock=!0),r.push(h),d++,c+=2}return{roundNodes:u,matchUps:r}}function Pv({finishingPositionOffset:t,finishingPositionLimit:e,qualifyingRoundNumber:n,qualifyingPositions:r,matchUpType:i,roundLimit:a,idPrefix:o,drawSize:s,isMock:c,uuids:u}){if(isNaN(s)||s<2||r&&s<=r)return{matchUps:[],roundsCount:0};if(r&&(!f(s)||s%r)){let t=r;for(;t<s;)t*=2;s=t}const d=r&&!(s%2)&&(!isNaN(r)||n&&!isNaN(n))&&(s/r===Math.round(s/r)||n&&s/n===Math.round(s/n));if(!f(s)&&!d)return{matchUps:[],roundsCount:0};const p=E(1,s+1).map((t=>({drawPosition:t})));let l,m=[],h=1;for(({roundNodes:l,matchUps:m}=Tv({matchUpType:i,roundNumber:h,idPrefix:o,matchUps:m,isMock:c,nodes:p,uuids:u})),h++,a=a||n;l.length>1;)r&&l.length===r&&(a=h-1),({roundNodes:l,matchUps:m}=Tv({nodes:l,matchUpType:i,roundNumber:h,idPrefix:o,matchUps:m,isMock:c,uuids:u})),h++;const I=h-1;return m=ah({finishingPositionOffset:t,finishingPositionLimit:e,roundsCount:I,roundLimit:a,matchUps:m}),a?m=m.filter((t=>a&&(t.roundNumber||0)<=a)):a=h-1,{drawSize:s,matchUps:m,roundsCount:I,roundLimit:a}}function Dv({qualifyingProfiles:t,appliedPolicies:e,idPrefix:n,isMock:r,uuids:i}){const a=[],o=[],s=[],c=(t,e)=>t.stageSequence-e.stageSequence,u=(t,e)=>t.roundTarget-e.roundTarget;let d,p=0,l=0,m=1;for(const f of t.sort(u)){const u=f.structureProfiles||[];m=f.roundTarget||m;let h,g,U,y=1,S=0;for(const a of(u||[]).sort(c)){let c=a.drawSize||I(a.participantsCount);const{qualifyingRoundNumber:l,qualifyingPositions:f,structureOptions:w,matchUpFormat:T,structureName:P,structureId:D,drawType:N}=a,R=a.matchUpType;let b,M,A;if(!v(c))return Oi({result:{error:pt},stack:"generateQualifyingSTructures"});const E=t.length>1?`${m}-`:"",C=u.length>1||E?y:"",O=P||(E||C?`${gg(zu)} ${E}${C}`:gg(zu));if(N===kd){const{structures:t,groupCount:o,maxRoundNumber:s}=yg({structureName:a.structureName||O,structureId:D||i?.pop(),stage:zu,structureOptions:w,appliedPolicies:e,stageSequence:y,matchUpType:R,roundTarget:m,drawSize:c,idPrefix:n,isMock:r,uuids:i});S=o,b=s,M=t[0],d=[1]}else({drawSize:c,matchUps:A,roundLimit:b}=Pv({qualifyingRoundNumber:l,qualifyingPositions:f,matchUpType:R,drawSize:c,idPrefix:n,isMock:r,uuids:i})),M=Ug({structureName:a.structureName||O,structureId:D||i?.pop(),qualifyingRoundNumber:b,stage:zu,matchUpFormat:T,stageSequence:y,matchUpType:R,roundLimit:b,matchUps:A}),m&&Bs({element:M,extension:{name:Eo,value:m}}),S=A?.filter((t=>t.roundNumber===b))?.length||0;if(y>1){const{link:t}=vv({sourceStructureId:g,sourceRoundNumber:h,targetStructureId:M.structureId,finishingPositions:U===pd?[1]:void 0,linkType:U});s.push(t),p+=(c||0)-S}else p+=c||0;U=N===kd?pd:ld,g=M.structureId,h=b,o.push(M),y+=1}l+=S,a.push({qualifiersCount:S,finalQualifyingRoundNumber:h,finalQualifyingStructureId:g,finishingPositions:d,roundTarget:m,linkType:U}),S=0,m+=1}return{qualifiersCount:l,qualifyingDrawPositionsCount:p,qualifyingDetails:a,structures:o,...L,links:s}}function Nv({drawDefinition:t,structureId:e}){const n=zd({drawDefinition:t,structureId:e});if(n.error)return n;const{matchUps:r}=qp({structure:n.structure});return Gu({matchUps:r})}function Rv({finishingPositions:t,drawDefinition:e,structureId:n}){const{roundProfile:r}=Nv({drawDefinition:e,structureId:n}),i=r&&Object.keys(r);return i?.reduce(((e,n)=>(bv(r?.[n]).forEach((r=>{t.forEach((t=>{(function({position:t,rangeDefinition:e}){if(!Array.isArray(e))return!1;if(e.reduce(((t,e)=>t||isNaN(e)),!1))return!1;const[n,r]=e;return E(n,(r||n)+1).includes(t)})({position:t,rangeDefinition:r})&&(e[t]={roundNumber:n})}))})),e)),{})}function bv(t){return[T(t?.finishingPositionRange?.loser||[]),T(t?.finishingPositionRange?.winner||[])]}function Mv(t){return bv(t).map((t=>E(t[0],t[1]&&t[1]+1||t[0]+1)))}function Av({drawDefinition:t,structureIds:e}){if(e&&!Array.isArray(e))return{error:xn,context:{structureIds:e}};if(!t)return{error:Y};const n=(e=e||(t.structures||[]).filter((t=>t.stage!==zu)).map((({structureId:t})=>t))).map((e=>{const{roundProfile:n}=Nv({drawDefinition:t,structureId:e}),r=n&&Object.values(n);return r?.map(Mv).flat()})).flat(),r=n.filter((t=>1===t?.length)).sort(l).flat();return{positionsNotPlayedOff:T(n.flat()).filter((t=>!r.includes(t))),positionsPlayedOff:r}}function Ev({excludeRoundNumbers:t=[],playoffPositions:e=[],drawDefinition:n,structureId:r}){if(!n)return{error:Y};if(!r)return{error:Pt};if(!e)return{error:me,info:"missing playoffPositions"};const i=Av({drawDefinition:n});if(i.error)return i;const a=i.positionsPlayedOff,o=Rv({finishingPositions:e.filter((t=>!a.includes(t))),drawDefinition:n,structureId:r}),s=Object.values(o).reduce(((t,e)=>t.includes(e.roundNumber)?t:t.concat(e.roundNumber)),[]).map((t=>m(t))).filter((e=>!t.includes(e))),c=Rv({finishingPositions:a,drawDefinition:n,structureId:r}),u=c?Object.values(c).reduce(((t,e)=>t.includes(e.roundNumber)?t:t.concat(e.roundNumber)),[]).map((t=>m(t))):[],d=s.filter((t=>!u.includes(t))).sort(l),{roundProfile:p}=Nv({drawDefinition:n,structureId:r}),f=d.map((t=>{const e=p?.[t].finishingPositionRange.loser,[n,r]=e??[0,0];return E(n,(r||n)+1)})).flat().sort(l),{playoffRoundsRanges:h}=function({playoffSourceRounds:t,roundProfile:e}){const n=t.map((t=>{const n=e[t].finishingPositionRange.loser,[r,i]=n,a=E(r,(i||r)+1);return{finishingPositionRange:n.join("-"),finishingPositions:a,roundNumber:t}}));return{playoffRoundsRanges:n}}({playoffSourceRounds:d,roundProfile:p}),I=[...d,...u];return{playoffPositionsReturned:f,playedOffSourceRounds:u,playoffRoundsRanges:h,playoffSourceRounds:d,sourceRounds:I,roundProfile:p}}function Cv({drawDefinition:t,structureId:e}){if(!t)return{error:Y};const{positionsNotPlayedOff:n,positionsPlayedOff:r}=Av({drawDefinition:t}),{structures:i}=Yd({drawDefinition:t}),a=i.filter((t=>!e&&t.stage!==Ku||t.structureId===e)),o={},s=eh({inContext:!0,drawDefinition:t}).matchUps;for(const c of a){const e=c?.structureId,r=Ov({playoffPositions:n,drawDefinition:t,structure:c,matchUps:s}),{error:i,...a}=r;if(i)return r;o[e]={structureId:e,...a}}return e?{positionsPlayedOff:r,...o[e]}:{availablePlayoffProfiles:Object.values(o),availablePlayoffRounds:Object.values(o),positionsPlayedOff:r}}function Ov({playoffPositions:t,drawDefinition:e,structure:n,matchUps:r}){const i=n?.structureId,{links:a}=Ul({drawDefinition:e,structureId:i});if(n.structureType===od||n.structures){const t=Rp({structure:n})?.positionAssignments?.length,o=n.structures.length,s=(t??0)/o,c=a.source?.flatMap((({source:t})=>t?.finishingPositions||[]))||[],u=E(1,s+1).filter((t=>!c.includes(t))),d=r.find((t=>t.containerStructureId===i&&t.finishingPositionRange))?.finishingPositionRange?.winner||[0,1],p=a?.source.map((({target:t})=>t.structureId)),{positionsPlayedOff:l,positionsNotPlayedOff:m}=Av({structureIds:p,drawDefinition:e}),f=[...l??[],...m],h=E(d[0],d[1]+1).filter((t=>!f.includes(t))),I=x(h,h.length/u.length);return{positionsNotPlayedOff:h,playoffFinishingPositionRanges:u.map(((t,e)=>{const n=I[e];return{finishingPosition:t,finishingPositions:n,finishingPositionRange:[Math.min(...n||[]),Math.max(...n||[])].join("-")}})),finishingPositionsAvailable:u,finishingPositionsPlayedOff:c,positionsPlayedOff:l,groupCount:o,groupSize:s}}const o=a?.source?.filter((t=>t.linkCondition!==fd)).map((t=>t.source?.roundNumber))||[],s=a?.source?.filter((t=>t.linkCondition===fd)).map((t=>t.source?.roundNumber))||[],{playoffSourceRounds:c,playoffRoundsRanges:u,roundProfile:d,error:p}=Ev({excludeRoundNumbers:o,playoffPositions:t,drawDefinition:e,structureId:i});for(const l of s){const t=a?.source.find((t=>t.source.roundNumber===l)),e=t?.target.roundNumber,n=t?.target.structureId,i=r.filter((({roundNumber:t,structureId:r})=>r===n&&t===e)),o=i.filter((({sides:t})=>t.find((t=>t.participantFed&&!t.participantId)))).length;if(c&&o===i.length){c.push(l);const t=d?.[l].finishingPositionRange?.loser;if(t){const e=Math.min(...t),n=e+o,r=E(e,n),i={finishingPositionRange:[e,n-1].join("-"),finishingPositions:r,roundNumber:l};u.push(i)}}}return c&&c.sort(l),u.sort(((t,e)=>t.roundNumber-e.roundNumber)),{playoffRounds:c,playoffRoundsRanges:u,error:p}}function Fv({includeMatchUpType:t,drawPosition:e,roundNumber:n,matchUpType:r,idPrefix:i,matchUps:a,isMock:o,uuids:s,nodes:c,fed:u}){const d=c.length,p=e?e-d:void 0,l=E(0,d).map((t=>p?p+t:void 0)),m=[];for(let f=0;f<d;f++){const e=l.shift(),d={drawPosition:e,fed:u+1,feed:!0},p=c[f];p.roundNumber=n-1;const h=wv({roundPosition:p.roundPosition,roundNumber:n,idPrefix:i,uuids:s}),I={roundPosition:p.roundPosition,drawPositions:[e],matchUpStatus:sa,roundNumber:n,matchUpId:h};t&&(I.matchUpType=r),o&&(I.isMock=!0),a.push(I);const g={children:[p,d]};m.push(g)}return{roundNodes:m,matchUps:a,drawPosition:e?e-d:void 0}}function kv(t){let{feedRoundsProfile:e,feedRounds:n=0,skipRounds:r=0,baseDrawSize:i,drawSize:a}=t;const{linkFedFinishingRoundNumbers:o,finishingPositionOffset:s,linkFedRoundNumbers:c,feedsFromFinal:u,isConsolation:d,matchUpType:p,idPrefix:l,isMock:m,uuids:f,fmlc:h}=t;i=i||function(t){const e=g(t);return e>t?e/2:e}(a);const I=function({drawSize:t}){const e=Math.ceil(Math.log(t)/Math.log(2));return E(0,e).reverse().map((t=>Math.pow(2,t)))}({drawSize:i}),U=I.length;let y=0;if(e?.length)y=e.reduce(((t,e)=>t+e),0);else if(a){let t=a-i;e=I.filter((e=>e<=t&&(t-=e,!0))),y=e.reduce(((t,e)=>t+e),0),n=e.length}else r>=U?n=0:u&&(n=U-u,r=0),e=I.filter(((t,e)=>u&&!n||n&&e>=r+n||e<r?0:t)),y=e.reduce(((t,e)=>t+e),0),a=i+y,n=e.length;const S=[...I,...e].sort(((t,e)=>e-t)),v=S.length,w=[...(c??[]).map((t=>t-1)),...(o??[]).map((t=>v-t))].map((t=>S[t])).reduce(((t,e)=>t+e),0);y-=w;let T,P=0,D=[],R=1;let b=E(0,i).map(((t,e)=>({drawPosition:e+1+y}))),M=y+1;for(const g of I){if(({roundNodes:T,matchUps:D}=Tv({matchUpType:p,roundNumber:R,idPrefix:l,matchUps:D,isMock:m,nodes:b,uuids:f})),R++,e.includes(g)){const t=E(0,N(e)[g]),n=v+1-R,r=o?.includes(n)||c?.includes(R);t.forEach((()=>{const t=!r&&M||void 0;({roundNodes:T,matchUps:D,drawPosition:M}=Fv({drawPosition:t,nodes:T,matchUpType:p,roundNumber:R,idPrefix:l,matchUps:D,isMock:m,uuids:f,fed:P})),R++,P+=1}))}b=T}v!==R-1&&console.log("ERROR");D=ah({finishingPositionOffset:d?i-y:s,positionsFed:y,roundsCount:v,matchUps:D,fmlc:h});const A=T?.length?T[0]:T;return A&&(A.roundNumber=R-1,A.matchUps=D),{draw:A,matchUps:D,roundsCount:v}}function xv(t){const{finishingPositionOffset:e=0,playoffAttributes:n,stageSequence:r=1,staggeredEntry:i,structureName:a,stage:o=Hu,matchUpType:s,structureId:c,idPrefix:u,drawSize:d,isMock:p,uuids:l}=t,m={finishingPositionOffset:e,matchUpType:s,drawSize:d,idPrefix:u,isMock:p,uuids:l},{matchUps:f}=i?kv(m):Pv(m),h=Ug({structureName:a||n?.[0]?.name||gg(Hu),structureId:c||l?.pop(),stageSequence:r,matchUpType:s,matchUps:f,stage:o}),I=[h],g=[];if(d>2){const r=d/2,{matchUps:i}=Pv({finishingPositionOffset:e+r,idPrefix:u&&`${u}-c`,drawSize:r,matchUpType:s,isMock:p}),o=gg(Yu),c=n?.["0-1"]?.name??t.consolationStructureName??(a?`${a} ${o}`:o),m=Ug({structureName:c,matchUps:i,structureId:l?.pop(),stage:Yu,stageSequence:1,matchUpType:s});I.push(m);const f={linkType:_i.Loser,source:{roundNumber:1,structureId:h.structureId},target:{roundNumber:1,feedProfile:Li.TopDown,structureId:m.structureId}};g.push(f)}return{...L,structures:I,links:g}}function _v({consolationStructure:t,roundOffset:e=0,mainStructure:n,roundsCount:r,feedPolicy:i,fmlc:a}){const o=t.matchUps.reduce(((t,e)=>(e.drawPositions||[]).filter(Boolean).length&&!t.includes(e.roundNumber)?t.concat(e.roundNumber):t),[]),s=i?.roundGroupedOrder||[],c=i?.roundFeedProfiles;return E(1+e,r+1+e).map((r=>{const i=c&&c[r-1]?c[r-1]:r%2?ud:dd,u=r-e<=2?r-e:2*(r-e-2)+2,d={linkType:md,source:{roundNumber:r,structureId:n.structureId},target:{feedProfile:i,roundNumber:u,structureId:t.structureId}},p=s[r-1];return p&&(d.target.groupedOrder=p),ir()&&(d.source.structureName=n.structureName,d.target.structureName=t.structureName),2===r&&a&&(d.linkCondition=fd,d.target.feedProfile=ud),o.includes(u)?d:void 0})).filter(Boolean)}function Lv(t){const{playoffStructureNameBase:e,finishingPositionOffset:n,stageSequence:r=1,playoffAttributes:i,structureNameMap:a,staggeredEntry:o,stage:s=Hu,matchUpType:c,structureId:u,drawSize:d,idPrefix:p,isMock:l,uuids:m}=t,f={finishingPositionOffset:n,matchUpType:c,drawSize:d,idPrefix:p,isMock:l,uuids:m},{matchUps:h,roundsCount:I}=o?kv(f):Pv(f),g=t.structureName??i?.[0]?.name??gg(Hu),U=Ug({structureId:u||m?.pop(),structureName:g,stageSequence:r,matchUpType:c,matchUps:h,stage:s}),y=[U],S=[];if(d>2){const t=[0,2].slice(0,d/16).map(((t,n)=>{const r=n+1,{consolationStructure:o}=function({playoffStructureNameBase:t,stageSequence:e=1,playoffAttributes:n,structureNameMap:r,roundOffset:i=0,matchUpType:a,structureId:o,idPrefix:s,drawSize:c,isMock:u,index:d,uuids:p}){const l=c/(2*Math.pow(2,i)),{matchUps:m,roundsCount:f}=kv({finishingPositionOffset:l,baseDrawSize:l,isConsolation:!0,feedRounds:1,matchUpType:a,idPrefix:s,isMock:u,uuids:p}),h=0===d&&n?.["0-1"]?.name||1===d&&n?.["0-3"]?.name,I=h||`${gg(Yu)} ${d+1}`,g=r?.[I]||I,U=t?`${t} ${g}`:g,y=Ug({matchUps:m,stage:Yu,structureName:U,stageSequence:e,matchUpType:a,structureId:o});return{consolationStructure:y,consolationRoundsCount:f}}({idPrefix:p&&`${p}-c${n}`,structureId:m?.pop(),playoffStructureNameBase:e,playoffAttributes:i,structureNameMap:a,stageSequence:r,roundOffset:t,matchUpType:c,drawSize:d,isMock:l,index:n,uuids:m});y.push(o);return{consolationStructure:o,links:_v({consolationStructure:o,roundsCount:2,mainStructure:U,roundOffset:t})}})),n=t.map((t=>t.links)).flat();if(S.push(...n),d>=4&&d<=16||d>32){const{matchUps:t}=Pv({idPrefix:p&&`${p}-p3t4`,finishingPositionOffset:2,drawSize:2,matchUpType:c,isMock:l}),n=i?.["3-4"]?.name??gg(Ju),r=a?.[n]||n,o=e?`${e} ${r}`:r,s=Ug({structureId:m?.pop(),matchUps:t,stageSequence:2,stage:Ju,structureName:o,matchUpType:c}),u={linkType:_i.Loser,source:{roundNumber:I-1,structureId:U.structureId},target:{structureId:s.structureId,feedProfile:Li.TopDown,roundNumber:1}};y.push(s),S.push(u)}}return{structures:y,links:S,...L}}function Bv(t){const{finishingPositionOffset:e=0,addNameBaseToAttributeName:n,playoffStructureNameBase:r,finishingPositionNaming:i,finishingPositionLimit:a,playoffAttributes:o,stageSequence:s=1,exitProfile:c="0",exitProfileLimit:u,roundOffsetLimit:d,roundOffset:p=0,drawDefinition:l,staggeredEntry:m,sequenceLimit:f,stage:h=Hu,structureId:I,drawSize:g,idPrefix:U,isMock:y,uuids:S}=t;if(!(!o||!u||o?.[c])||g<2||f&&s>f)return{};const v=[],w=[],T=[],P=t.matchUpType||l?.matchUpType,D=e+1,N=`${D}-${e+g}`,R=o?.[c],b=r&&`${r} `||"",M=o?.[N]??i?.[N],A=t.structureName||M?.name||R?.name&&(n?`${b}${R?.name}`:R.name)||`${b}${N}`,C=M?.abbreviation||R?.abbreviation,O={idPrefix:U&&`${U}-${A}-RP`,finishingPositionOffset:e,matchUpType:P,drawSize:g,isMock:y,uuids:S},{matchUps:F}=m?kv(O):Pv(O),k=Ug({structureId:I||S?.pop(),structureAbbreviation:C,stageSequence:s,structureName:A,matchUpType:P,roundOffset:p,matchUps:F,stage:h});v.push(...F),w.push(k);const x=Math.ceil(Math.log(g)/Math.log(2)),_=d?Math.min(d-p,x):!a||D<a?x:0;return g>2&&E(1,_+1).forEach((t=>function(t){const m=g/Math.pow(2,t);if(m<2)return;const I=g/Math.pow(2,t)+e;if(a&&I+1>a)return;const{structures:y,structureId:D,matchUps:N,links:R}=Bv({finishingPositionOffset:I,exitProfile:`${c}-${t}`,roundOffset:p+t,stageSequence:s+1,drawSize:m,addNameBaseToAttributeName:n,playoffStructureNameBase:r,finishingPositionNaming:i,finishingPositionLimit:a,playoffAttributes:o,exitProfileLimit:u,roundOffsetLimit:d,drawDefinition:l,sequenceLimit:f,matchUpType:P,idPrefix:U,uuids:S,stage:h});if(k.structureId&&D){const e={linkType:_i.Loser,source:{roundNumber:t,structureId:k.structureId},target:{roundNumber:1,feedProfile:Li.TopDown,structureId:D}};R&&k&&R.push(e),R?.length&&T.push(...R)}y?.length&&w.push(...y);N?.length&&v.push(...N);return{structureId:D,childLinks:R,structures:w}}(t))),{structureId:k.structureId,matchUps:v,structureName:A,structures:w,links:T,...L}}function Vv(t){const{finishingPositionOffset:e,stageSequence:n=1,playoffAttributes:r,policyDefinitions:i,feedsFromFinal:a,staggeredEntry:o,structureName:s,stage:c=Hu,structureId:u,matchUpType:d,skipRounds:p,feedRounds:l,idPrefix:m,drawSize:f,isMock:h,uuids:I,fmlc:g}=t,U=t.feedPolicy||i?.[co],y={finishingPositionOffset:e,matchUpType:d,skipRounds:p,drawSize:f,idPrefix:m,isMock:h,uuids:I},{matchUps:S}=o?kv(y):Pv(y),v=Ug({structureName:s||r?.[0]?.name||gg(Hu),structureId:u||I?.pop(),stageSequence:n,matchUpType:d,matchUps:S,stage:c}),w=[v],T=[],P=f/2,{matchUps:D,roundsCount:N}=kv({finishingPositionOffset:P,idPrefix:m&&`${m}-c`,isConsolation:!0,feedsFromFinal:a,baseDrawSize:P,matchUpType:d,feedRounds:l,skipRounds:p,isMock:h,uuids:I,fmlc:g});if(f>2){const e=r?.["0-1"]?.name??gg(Yu),n=t.playoffStructureNameBase?`${t.playoffStructureNameBase} ${e}`:e,i=Ug({matchUps:D,structureId:I?.pop(),stage:Yu,stageSequence:1,structureName:n,matchUpType:d});w.push(i);const a=_v({consolationStructure:i,mainStructure:v,roundsCount:N,feedPolicy:U,fmlc:g});T.push(...a)}return{...L,structures:w,links:T}}function jv({requireSequential:t=!0,playoffMatchUpFormat:e,playoffAttributes:n,sourceStructureId:r,policyDefinitions:i,stageSequence:a,drawDefinition:o,playoffGroups:s,matchUpType:c,feedPolicy:u,groupCount:d,idPrefix:p,isMock:m,uuids:f}){u=u||i?.[co];const h="processPlayoffGroups";let I=0;const g=[],U=[],S=[],{error:v,positionRangeMap:w}=function({playoffGroups:t,drawDefinition:e,structureId:n}){if(!e)return{error:Y};if("string"!=typeof n||!Array.isArray(t))return{error:xn};const r=t.map((({finishingPositions:t})=>t)).flat(),i=Cv({drawDefinition:e,structureId:n}),a=i.playoffFinishingPositionRanges?.filter((t=>r.includes(t.finishingPosition))),o=a?.reduce(((t,e)=>(t[e.finishingPosition]=e,t)),{});return{positionRangeMap:o}}({structureId:r,drawDefinition:o,playoffGroups:s});if(v)return Oi({result:{error:v},stack:h});if(!(!w||s?.every((e=>{const{finishingPositions:n=[]}=e;if(!n.length)return!1;const r=n.sort(l).map(((t,e)=>(n[e+1]||t)-t)).every((t=>t<2));return(!t||r)&&n.every((t=>w[t]))}))))return Oi({context:{validFinishingPositions:Object.values(w)},result:{error:xn},stack:h});for(const l of s){const t=l.finishingPositions,o=w&&t.map((t=>w[t]?.finishingPositions)).flat(),s=d*t.length,h=y(s),v=2===h&&yd||l.drawType||yd;o&&(I=Math.min(...o)-1);const T=o&&`${Math.min(...o)}-${Math.max(...o)}`,P=l.structureName||T&&l.playoffAttributes?.[T]?.name||l.playoffAttributes?.[0]?.name,D={...{addNameBaseToAttributeName:l.addNameBaseToAttributeName,playoffStructureNameBase:l.playoffStructureNameBase,finishingPositionNaming:l.finishingPositionNaming,finishingPositionLimit:l.finishingPositionLimit,structureId:l.structureId??f?.pop(),playoffAttributes:l.playoffAttributes,structureNameMap:l.structureNameMap,sequenceLimit:l.sequenceLimit,structureName:P},idPrefix:p&&`${p}-po`,appliedPolicies:i,finishingPositionOffset:I,stage:Ju,stageSequence:a,matchUpType:c,drawSize:h,isMock:m,uuids:f},N=({playoffStructures:e,playoffLinks:n})=>{const[i]=e,a=Gv({playoffStructureId:i.structureId,finishingPositions:t,sourceStructureId:r});S.push(a),S.push(...n),U.push(...e),g.push({structureId:i.structureId,finishingPositions:t}),I+=s};if(v===yd){const{matchUps:n}=Pv({finishingPositionLimit:I+s,idPrefix:p&&`${p}-po`,finishingPositionOffset:I,matchUpType:c,drawSize:h,isMock:m,uuids:f}),i=Ug({structureId:l.structureId??f?.pop(),matchUpFormat:e,stage:Ju,structureName:P,stageSequence:a,matchUps:n});U.push(i);const o=Gv({playoffStructureId:i.structureId,finishingPositions:t,sourceStructureId:r});S.push(o),I+=s,g.push({structureId:i.structureId,finishingPositions:t})}else if([gd,Ud,Ju].includes(v)){const e={playoffAttributes:l.playoffAttributes??n,playoffStructureNameBase:l.playoffStructureNameBase,structureId:l.structureId??f?.pop(),structureName:l.structureName,idPrefix:p&&`${p}-po`,addNameBaseToAttributeName:!0,finishingPositionOffset:I,stage:Ju,roundOffset:0,stageSequence:a,drawSize:h,isMock:m,uuids:f};v===gd?Object.assign(e,{playoffAttributes:l?.playoffAttributes??n??Bd,roundOffsetLimit:3}):v===Ud&&Object.assign(e,{playoffAttributes:l?.playoffAttributes??n??Vd,roundOffsetLimit:2});const i=Bv(e);if(i.error)return i;if(i.links?.length&&S.push(...i.links),i.structures?.length&&U.push(...i.structures),U.sort(Wd),i.structureId){const e=Gv({playoffStructureId:i.structureId,finishingPositions:t,sourceStructureId:r});S.push(e),g.push({structureId:i.structureId,finishingPositions:t})}I+=s}else if([vd,Fd,Ed,Md,Rd,Od].includes(v)){const e=[f?.pop(),f?.pop()],n={playoffStructureNameBase:l.playoffStructureNameBase,structureId:l.structureId??f?.pop(),playoffAttributes:l.playoffAttributes,idPrefix:p&&`${p}-po`,finishingPositionOffset:I,uuids:e,stage:Ju,structureName:P,matchUpType:c,feedPolicy:u,drawSize:h,isMock:m},i={[vd]:{fmlc:!0,feedRounds:1},[Od]:{feedRounds:1},[Ed]:{feedsFromFinal:3},[Md]:{feedsFromFinal:2},[Rd]:{feedsFromFinal:1}};Object.assign(n,i[v]||{});const{structures:a,links:o}=Vv(n),[d]=a,y=Gv({playoffStructureId:d.structureId,finishingPositions:t,sourceStructureId:r});S.push(y),S.push(...o),U.push(...a),g.push({structureId:d.structureId,finishingPositions:t}),I+=s}else if([kd].includes(v)){const{structures:t,links:e}=yg({...D,structureOptions:l.structureOptions||{groupSize:4}});N({playoffStructures:t,playoffLinks:e})}else if([wd].includes(v)){const{structures:t,links:e}=xv(D);N({playoffStructures:t,playoffLinks:e})}else if([Dd].includes(v)){const{structures:t,links:e}=Lv(D);N({playoffStructures:t,playoffLinks:e})}else if([hd].includes(v)){N({playoffStructures:[Ug({structureId:l.structureId??f?.pop(),structureName:l.structureName,finishingPosition:zo,stage:Ju,stageSequence:a,matchUps:[]})],playoffLinks:[]})}}return{finishingPositionTargets:g,positionRangeMap:w,structures:U,links:S}}function Gv({playoffStructureId:t,finishingPositions:e,sourceStructureId:n}){return{linkType:pd,source:{structureId:n,finishingPositions:e},target:{structureId:t,feedProfile:sd,roundNumber:1}}}function qv({structureName:t,matchUpType:e,idPrefix:n,drawSize:r,isMock:i,uuids:a}){const o=[],{matchUps:s}=kv({linkFedFinishingRoundNumbers:[1],drawSize:r+1,matchUpType:e,idPrefix:n,isMock:i}),c=Ug({structureName:t||gg(Hu),structureId:a?.pop(),stageSequence:1,stage:Hu,matchUpType:e,matchUps:s});o.push(c);const u=r/2,{matchUps:d}=kv({finishingPositionOffset:u,idPrefix:n&&`${n}-c`,drawSize:r-1,isConsolation:!0,matchUpType:e,isMock:i,uuids:a}),p=Ug({structureName:gg(Ld),matchUps:d,structureId:a?.pop(),stage:Yu,stageSequence:2,matchUpType:e});o.push(p);const{matchUps:l}=Pv({idPrefix:n&&`${n}-p1t2`,drawSize:2,matchUpType:e,isMock:i}),m=Ug({structureName:gg(_d),matchUps:l,structureId:a?.pop(),stageSequence:3,stage:Ju,matchUpType:e});o.push(m);const f=function({mainStructure:t,consolationStructure:e,deciderStructure:n}){const r=e.matchUps.reduce(((t,e)=>(e.drawPositions||[]).filter(Boolean).length&&!t.includes(e.roundNumber)?t.concat(e.roundNumber):t),[]),i=t.matchUps.reduce(((t,e)=>!t||e.roundNumber>t?e.roundNumber:t),void 0),a=e.matchUps.reduce(((t,e)=>!t||e.roundNumber>t?e.roundNumber:t),void 0);return[...r.map(((n,i)=>{const a=r.indexOf(n)%2?ud:dd;return{linkType:md,source:{roundNumber:1+i,structureId:t.structureId},target:{feedProfile:a,roundNumber:n,structureId:e.structureId}}})),{linkType:ld,source:{roundNumber:a,structureId:e.structureId},target:{feedProfile:ud,roundNumber:i,structureId:t.structureId}},{linkType:ld,source:{roundNumber:i,structureId:t.structureId},target:{feedProfile:ud,roundNumber:1,structureId:n.structureId}},{linkType:md,source:{roundNumber:i,structureId:t.structureId},target:{feedProfile:ud,roundNumber:1,structureId:n.structureId}}]}({mainStructure:c,consolationStructure:p,deciderStructure:m});return{structures:o,links:f,...L}}function $v(t){const{qualifyingRoundNumber:e,finishingPositionOffset:n,qualifyingPositions:r,matchUpType:i,idPrefix:a,drawSize:o,isMock:s,uuids:c}=t;if(!v(o)||o<2)return{matchUps:[],roundsCount:0};if(f(o))return Pv(t);const u=function(t){const e=m(t);let n=e%2?e+1:e;const r=!!(Math.ceil(n/2)%2),i=[{participantsCount:n,preFeedRound:r}];for(;n>2;){const t=Math.ceil(n/2),e=1===t,r=!(e||!(t%2));n=!e&&r?t+1:t;const a=!!(2!==n&&Math.ceil(n/2)%2);i.push({participantsCount:n,preFeedRound:a,feedRound:r})}return i}(o),d=u.shift(),p=E(1,(d?.participantsCount||0)+1).map((t=>({drawPosition:t})));let l=[],h=1;({matchUps:l}=Tv({roundNumber:h,matchUpType:i,idPrefix:a,matchUps:l,isMock:s,nodes:p,uuids:c})),h++;let I=t.roundLimit||e;for(const m of u){const t=m.participantsCount/2,e=E(1,t+1);r&&t===r&&(I=h-1);const n=e.map((t=>{const e=wv({roundPosition:t,roundNumber:h,idPrefix:a,uuids:c});return{roundPosition:t,roundNumber:h,matchUpId:e}}));l.push(...n),h++}const g=h-1;return l=ah({finishingPositionOffset:n,lucky:!0,roundsCount:g,roundLimit:I,matchUps:l}),I&&(l=l.filter((t=>t.roundNumber<=I))),{matchUps:l,roundsCount:g,roundLimit:I}}function Wv(t){const{playoffAttributes:e,stageSequence:n=1,structureId:r,stage:i=Hu,matchUpType:a,drawSize:o,uuids:s}=t,{appliedPolicies:c}=Vo(t),u=t.policyDefinitions?.[co]||c?.[co];t.skipRounds=t.skipRounds||o<=4&&(u?.feedMainFinal?0:1)||0;const d=t.structureName??e?.[0]?.name??gg(Hu),p={[hd]:()=>({structures:[Ug({structureId:r||s?.pop(),finishingPosition:jd,stageSequence:n,structureName:d,matchUps:[],matchUpType:a,stage:i})],links:[],...L}),[Td]:()=>{const{matchUps:e}=$v(t);return{structures:[Ug({structureId:r||s?.pop(),stageSequence:n,structureName:d,matchUpType:a,matchUps:e,stage:i})],links:[],...L}},[yd]:()=>(()=>{const{matchUps:e}=Pv(t);return{structures:[Ug({structureId:r||s?.pop(),stageSequence:n,structureName:d,matchUpType:a,matchUps:e,stage:i})],links:[],...L}})(),[Sd]:()=>qv(t),[gd]:()=>Bv({...t,roundOffsetLimit:3,playoffAttributes:e??Bd}),[Ud]:()=>Bv({...t,roundOffsetLimit:2,playoffAttributes:e??Vd}),[Ju]:()=>Bv(t),[Id]:()=>{const{matchUps:t}=kv({drawSize:o,uuids:s,matchUpType:a});return{structures:[Ug({structureId:r||s?.pop(),stageSequence:n,structureName:d,matchUpType:a,stage:Hu,matchUps:t})],links:[],...L}},[wd]:()=>xv(t),[vd]:()=>Vv({...t,feedRounds:1,fmlc:!0}),[Cd]:()=>Vv({...t,feedRounds:1}),[Nd]:()=>Vv({...t,feedsFromFinal:1}),[bd]:()=>Vv({...t,feedsFromFinal:2}),[Ad]:()=>Vv({...t,feedsFromFinal:3}),[Fd]:()=>Vv(t),[Pd]:()=>Lv(t),[kd]:()=>yg(t),[xd]:()=>function(t){const{drawDefinition:e,structureOptions:n,requireSequential:r}=t,i={structureName:gg(Hu),...t,stage:Hu},{structures:a,groupCount:o,groupSize:s}=yg(i);if(o<1)return{error:En};const c=n?.playoffGroups||[{finishingPositions:[1],structureName:gg(Ju)}],[u]=a,{structures:d,links:p}=jv({sourceStructureId:u.structureId,requireSequential:r,drawDefinition:e,playoffGroups:c,groupCount:o,groupSize:s,...t});return d&&a.push(...d),{...L,structures:a,links:p}}(t)};return{generators:p}}function Hv(t){const{enforceMinimumDrawSize:e=!0,overwriteExisting:n,appliedPolicies:r,staggeredEntry:i,drawDefinition:a,tieFormat:o,drawSize:s,isMock:c,uuids:u}=t||{},d=t.drawTypeCoercion??r?.[uo]?.drawTypeCoercion??!0,p="generateDrawStructuresAndLinks";let l=d&&2===t.drawSize&&Fi.SingleElimination||t.drawType||Fi.SingleElimination;const h=[],I=[],g=t?.matchUpType??ba,U=a?.structures?.filter((({stage:t})=>t===zu));U&&h.push(...U);const y=U?.map((({structureId:t})=>t)),S=a?.structures?.find((({stage:t,stageSequence:e})=>t===Hu&&1===e)),v=a?.links?.filter((t=>t.target.structureId===S?.structureId&&y?.includes(t.source.structureId))),w=(t,e)=>{if(t.linkType===pd&&e?.structures){const n=t.source.finishingPositions||[];return e.structures.length*n.length}if(t.linkType===ld&&e?.matchUps?.length){const n=t.source.roundNumber;return e.matchUps.filter((({roundNumber:t})=>t===n)).length}},T=U?.map((t=>{const e=v?.find((e=>e.target.structureId===t.structureId)),n=Rp({structure:t})?.positionAssignments?.length??0;if(!e)return n;const r=e?.source.structureId,i=a.structures?.find((t=>t.structureId===r));return n-(w(e,i)||0)})).filter(Boolean).reduce(((t,e)=>t+e),0),P=v?.map((t=>{const e=t.source.structureId,n=U?.find((t=>t.structureId===e));return w(t,n)})).filter(Boolean).reduce(((t,e)=>t+e),0),D=!(!S||S?.matchUps?.length);if(U?.length&&!D)return{error:Yn};const N=!U?.length&&t.qualifyingProfiles,R=N?.length&&Dv({idPrefix:t.idPrefix,qualifyingProfiles:N,appliedPolicies:r,isMock:c,uuids:u});if(R?.error)return R;const{qualifyingDrawPositionsCount:b,qualifyingDetails:M,qualifiersCount:A}=R||{qualifyingDrawPositionsCount:T,qualifiersCount:P};b&&(R?.structures&&h.push(...R.structures),R?.links&&I.push(...R.links)),Object.assign(t,di({drawSize:s,matchUpType:g,tieFormat:o}));const E=l!==hd&&(isNaN(s)||s<2||!i&&![Id,Td].includes(l)&&([xd,kd].includes(l)&&s<3||![kd,xd].includes(l)&&!f(s)));if(E&&!b)return Oi({context:{drawSize:s,invalidDrawSize:E},result:{error:ut},stack:p});const C=qd.includes(l);if(m(s)<4&&C)if(d)l=yd;else if(e)return Oi({context:{enforceMinimumDrawSize:e,invalidDrawSize:E,drawSize:s,drawType:l},result:{error:ut},stack:p});const{generators:O,error:F}=Wv(t);if(F)return{error:F};const k=O[l];if(!k)return{error:rt};const x=k?.();if(x.error)return x;const{structures:_,links:B}=x;if(_?.length){const t=_.find((({stage:t,stageSequence:e})=>t===Hu&&1===e));if(S&&t)if(D){const e=t.structureId;if(t.structureId=S.structureId,B?.length)for(const t of B)t.source.structureId===e&&(t.source.structureId=S.structureId),t.target.structureId===e&&(t.target.structureId=S.structureId)}else if(!n)return{error:Yn};h.push(..._)}h.sort(Wd),B?.length&&I.push(...B);const V=x.structures.find((({stage:t,stageSequence:e})=>t===Hu&&1===e));for(const m of M||[]){const{finalQualifyingRoundNumber:t,finalQualifyingStructureId:e,roundTarget:n,finishingPositions:r,linkType:i}=m,a=V&&vv({targetStructureId:V.structureId,sourceStructureId:e,sourceRoundNumber:t,finishingPositions:r,targetEntryRound:n,linkType:i})?.link;if(a?.error)return a;a&&I.push(a)}return v&&I.push(...v),{...L,qualifyingResult:{qualifyingDrawPositionsCount:b,qualifiersCount:A},structures:h,links:I}}function zv(t){const{provisionalPositioning:e,drawDefinition:n,stageSequence:r,structureId:i,stage:a}=t;if(!n)return{error:Y};const{entryProfile:o}=Wu({drawDefinition:n}),s=a&&r&&o?.[a]?.stageSequence?.[r]?.qualifiersCount||a&&o?.[a]?.qualifiersCount||0,c={};if(!i)return{qualifiersCount:s,roundQualifiersCounts:c};const{structure:u}=zd({drawDefinition:n,structureId:i}),d=n.links?.filter((t=>t?.target?.structureId===u?.structureId));let p=0;if(d?.length)for(const m of d){const t=zd({structureId:m.source.structureId,drawDefinition:n})?.structure;if(t?.stage===zu){const n=m.source.roundNumber,r=m.target.roundNumber;let i=0;if(t.structureType===od){i=(t.structures?.length||0)*(m.source.finishingPositions?.length||0)}else{const r=qp({matchUpFilters:{roundNumbers:[n]},structure:t,afterRecoveryTimes:!1,provisionalPositioning:e,inContext:!1}).matchUps;i=r?.length||0}c[r]||(c[r]=0),c[r]+=i,p+=i}}const l=Object.keys(c);if(l.length<=1){const t=l[0]||1;c[t]=Math.max(c[t]||0,s)}return p=Math.max(p,s),{qualifiersCount:p,roundQualifiersCounts:c}}function Yv({stage:t,drawDefinition:e}){const{entryProfile:n}=Wu({drawDefinition:e});return n?.[t]?.drawSize||0}function Kv({stageSequence:t=1,drawDefinition:e,drawSize:n,stage:r}){if(!e)return{error:Y};if(!Ip({drawDefinition:e,stage:r}))return{error:_t};const i=yp({drawDefinition:e,stage:r}),{qualifiersCount:a}=zv({drawDefinition:e,stageSequence:t,stage:r});if(n<i+a)return{error:dt};const{entryProfile:o}=$u({attributes:[{[r]:{drawSize:n}}],drawDefinition:e});return il({drawDefinition:e}),{...L,entryProfile:o}}function Jv({qualifiersCount:t=0,drawDefinition:e,stage:n}){return e?Ip({drawDefinition:e,stage:n})?n!==Hu?{error:dt,info:"qualifiersCount can only be set for main stage"}:($u({attributes:[{[n]:{qualifiersCount:t}}],drawDefinition:e}),il({drawDefinition:e}),{...L}):{error:_t}:{error:Y}}function Qv(t){const{modifyOriginal:e=!0,stageSequence:n=1,isMock:r}=t||{},i="generateDrawTypeAndModifyDrawDefinition";if(!t.drawDefinition)return Oi({result:{error:Y},stack:i});const a=e?t.drawDefinition:ri(t.drawDefinition,!1,!0);let{tieFormat:o,matchUpType:s}=t;if(o){const t=$i({tieFormat:o});if(t.error)return t}o=zp(o||Ri({drawDefinition:a})?.tieFormat),s=s||a.matchUpType||ba,t.tieFormat=o,t.matchUpType=s;const c=Yv({drawDefinition:a,stage:Hu});t.drawSize=t.drawSize||c,!c&&t.drawSize&&Kv({drawSize:t.drawSize,drawDefinition:a,stageSequence:n,stage:Hu});const u=wp({drawDefinition:a}).drawMatchUps.map(hl),d=Hv(t);if(d.error)return Oi({result:d,stack:i});const{structures:p,links:l,qualifyingResult:m}=d;a.structures=p,a.links=l;const f=Math.max(t.qualifiersCount||0,m?.qualifiersCount||0);if(m?.qualifyingDrawPositionsCount){if(!Yv({stage:zu,drawDefinition:a})){const t=Kv({drawSize:m.qualifyingDrawPositionsCount,stage:zu,drawDefinition:a});if(t.error)return t}}if(f){const t=Jv({qualifiersCount:f,drawDefinition:a,stage:Hu});if(t.error)return t}const h=t.drawSize||c;Object.assign(t,di({drawSize:h,matchUpType:s,tieFormat:o}));const{matchUps:I,matchUpsMap:g}=Pl({drawDefinition:a});o&&I?.forEach((t=>{if(!u.includes(t.matchUpId)){const{tieMatchUps:e}=gU({tieFormat:o,isMock:r});Object.assign(t,{tieMatchUps:e,matchUpType:s})}}));const{inContextDrawMatchUps:U}=oh({drawDefinition:a,matchUpsMap:g});return il({drawDefinition:a}),{inContextDrawMatchUps:U,drawDefinition:a,matchUpsMap:g,...L,structures:p,matchUps:I,links:l}}function Xv({policyAttributes:t,idCollections:e,participants:n,participant:r}){if(!Array.isArray(t))return{error:ae};if(!r)return{error:xe};const i=[];t.forEach((t=>{const{directive:o,groupings:s,key:c,significantCharacters:u}=t||{};if(c){const t=c.split(".");a({value:r,keys:t,significantCharacters:u})}else if(o){const a=t?.includeIds,s=(e?.[o]||[]).filter((t=>!a||a.includes(t)));s?.length&&n?.length&&s.forEach((t=>{const e=n.find((e=>e.participantId===t));if(e?.individualParticipantIds?.includes(r.participantId)){const t=e?.participantId;i.push(t)}}))}else s&&Object.keys(s).forEach((t=>{s[t].includes(r.participantId)&&i.push(t)}))}));return{values:T(i)};function a({value:t,keys:e=[],significantCharacters:n}){for(const[i,o]of e.entries())if(t?.[o])if(Array.isArray(t[o])){const r=t[o],s=e.slice(i);r.forEach((t=>a({value:t,keys:s,significantCharacters:n})))}else r({value:t=t[o],index:i});function r({value:t,index:r}){if(t&&r===e.length-1&&["string","number"].includes(typeof t)){const e=n?t.slice(0,n):t;i.push(e)}}}}function Zv({candidatePositionAssignments:t,participantsWithGroupings:e,policyAttributes:n,idCollections:r}){const i=Object.assign({},...e.map((t=>({[t.participantId]:t}))));return t.map((t=>{const a=i[t.participantId],{values:o}=Xv({participants:e,policyAttributes:n,idCollections:r,participant:a});return{...t,values:o}}))}function tw({participantIdGroups:t,positionAssignments:e,groupsToAvoid:n}){return Object.assign({},...e.filter((t=>t?.participantId)).map((e=>{const{drawPosition:r,participantId:i}=e,a=t&&t[i]||[],o=!!n.some((t=>a.includes(t)));return{[r]:{participantGroups:a,includesGroupsToAvoid:o}}})))}function ew(t){const{unfilledPositions:e,chunkedDrawPositions:n}=t,r=tw(t);return n.map((t=>{const n=e.filter((e=>t.includes(e))),i=function(t){return t.filter((t=>!e(t)));function e(e){const n=nw(e);return!t.includes(n)}}(n),a=n.filter((t=>!i.includes(t))).filter((t=>{const e=nw(t);return!r[e]?.includesGroupsToAvoid}));return{unassigned:n,unpaired:i,pairedNoConflict:a}}))}function nw(t){return Number(t%2?t+1:t-1)}function rw({selectedParticipantGroups:t,participantIdGroups:e,positionAssignments:n,drawPositionChunks:r,unfilledPositions:i,isRoundRobin:a}){const o=r.map((r=>a?function(t){const{unfilledPositions:e,chunkedDrawPositions:n}=t,r=tw(t);return n.map((t=>{const n=e.filter((e=>t.includes(e))),i=n.length===t.length?n:[],a=t.filter((t=>r[t]?.includesGroupsToAvoid)).length;return{unassigned:n,unpaired:i,pairedNoConflict:a?[]:n,conflictsCount:a}}))}({groupsToAvoid:t,chunkedDrawPositions:r,participantIdGroups:e,positionAssignments:n,unfilledPositions:i}):ew({groupsToAvoid:t,chunkedDrawPositions:r,participantIdGroups:e,positionAssignments:n,unfilledPositions:i})));if(a){return{unassigned:o.map((t=>t.map((t=>t.unassigned)).filter((t=>t?.length)))).filter((t=>t?.length)).sort(((t,e)=>(e.length||0)-(t.length||0))),unpaired:o.map((t=>t.map((t=>t.unpaired)).filter((t=>t?.length)))).filter((t=>t?.length)),pairedNoConflict:o.map((t=>t.map((t=>t.pairedNoConflict)).filter((t=>t?.length)))).filter((t=>t?.length)).sort(((t,e)=>(e.length||0)-(t.length||0)))}}return{unassigned:o.map((t=>t.map((t=>t.unassigned)).filter((t=>t?.length)))).filter((t=>t?.length)),unpaired:o.map((t=>t.map((t=>t.unpaired)).filter((t=>t?.length)))).filter((t=>t?.length)),pairedNoConflict:o.map((t=>t.map((t=>t.pairedNoConflict)).filter((t=>t?.length)))).filter((t=>t?.length))}}function iw({positionAssignments:t,participantIds:e}){const n=t.map((t=>t.participantId));return e.filter((t=>!n.includes(t)))}function aw({candidatePositionAssignments:t,unseededParticipantIds:e,participantIdGroups:n,drawPositionChunks:r,drawPositionGroups:i,pairedPriority:a,allGroups:o,groupKey:s}){const c=i.reduce(((t,e)=>e.length>t?e.length:t),0)<=2,u=iw({positionAssignments:t,participantIds:e}),d=function({drawPositionGroups:t,positionAssignments:e}){const n=Object.assign({},...e.map((t=>({[t.drawPosition]:t}))));return t.map((t=>t.filter(Boolean).map((t=>n[t])).filter(Boolean).filter((t=>!t.participantId&&!t.bye)).map((t=>t.drawPosition)))).flat().filter(Boolean)}({positionAssignments:t,drawPositionGroups:i}),{participantId:p,groupKey:l}=function({useSpecifiedGroupKey:t=!1,targetParticipantIds:e,largestFirst:n=!0,allGroups:r,groupKey:i}){const a=Object.assign({},...Object.keys(r).map((t=>[t,r[t].filter((t=>e.includes(t)))])).filter((t=>t[1].length)).map((([t,e])=>({[t]:e})))),o=Object.keys(a).reduce(((t,e)=>a[e].length>t?a[e].length:t),0),s=Object.keys(a).filter((t=>a[t].length===o)),c=A(n?s:Object.keys(a));return{participantId:(i=t&&a[i]?.length?i:c)&&a[i]?A(a[i]):A(e),groupKey:i}}({targetParticipantIds:u,useSpecifiedGroupKey:c,allGroups:o,groupKey:s}),m=function({allGroups:t,participantId:e}){return Object.keys(t).filter((n=>t[n].includes(e)))}({participantId:p,allGroups:o}),f=rw({positionAssignments:t,isRoundRobin:c,selectedParticipantGroups:m,participantIdGroups:n,drawPositionChunks:r,unfilledPositions:d}),{unassigned:h,unpaired:I,pairedNoConflict:g}=f,U=g?.length&&g[0],y=I?.length&&I[0],S=a&&U?U:y,v=a?y:U,w=S?.length&&S||v?.length&&v;let T;if(w?.length){const t=M(w);T=M(t)}else{const t=M(h[0]);T=M(t)}return{newGroupKey:l,selectedParticipantId:p,targetDrawPosition:T}}function ow({isRoundRobin:t,groupedParticipants:e}){const n=[];return t?e.forEach((t=>{const e=t.map((t=>t.drawPosition)),{uniqueMatchUpGroupings:r}=Ah({drawPositions:e}),i=Object.assign({},...t.map((t=>({[t.drawPosition]:t}))));r.forEach((e=>{k(i[e[0]].values||[],i[e[1]].values||[])&&(n.push(e),t.conflict=!0)}))})):e.forEach((t=>{k(t[0]?.values||[],t[1]?.values||[])&&(n.push(t),t.conflict=!0)})),n}function sw({positionedParticipants:t,potentialDrawPositions:e,drawPositionGroups:n,avoidanceConflicts:r,isRoundRobin:i}){return r.map((r=>{const a=r.map((t=>t.drawPosition));return r.filter((t=>e.includes(t.drawPosition))).map((r=>{const o=e.filter((t=>!a?.includes(t))).filter((e=>{const a=n.find((t=>t.includes(e))).find((t=>t!==e)),o=t.find((t=>t.drawPosition===a)),s=ow({isRoundRobin:i,groupedParticipants:[[r,o]]}),c=t.find((t=>t.drawPosition===e)),u=ow({isRoundRobin:i,groupedParticipants:[[c,o]]});return!s.length&&!u.length}));if(o.length)return{drawPosition:r.drawPosition,possibleDrawPositions:o}})).filter(Boolean)})).flat(1)}function cw(t){const{initialPositionAssignments:e,participantsWithGroupings:n,opponentsToPlaceCount:r,unseededByePositions:i,drawPositionGroups:a,policyAttributes:o,idCollections:s,allGroups:c}=t,u=[];let d;const p=Math.min(...(a||[]).map((t=>t?.length)).filter(Boolean)),l=p>2,m=ri(e,!1,!0).filter((t=>!t.qualifier)),f=e.filter((t=>!t.participantId&&(!t.bye||i?.includes(t.drawPosition)))).map((t=>t.drawPosition));E(0,r).forEach((()=>{const{newGroupKey:e,selectedParticipantId:n,targetDrawPosition:r}=aw({...t,candidatePositionAssignments:m,allGroups:c,groupKey:d});d=e,m.forEach((t=>{t.drawPosition===r&&(t.participantId=n)}))}));let h=Zv({candidatePositionAssignments:m,participantsWithGroupings:n,policyAttributes:o,idCollections:s}),I=x(h,p),g=ow({groupedParticipants:I,isRoundRobin:l}),U=0;for(;U<20&&g.length;){const t=sw({positionedParticipants:h,potentialDrawPositions:f,avoidanceConflicts:g,drawPositionGroups:a,isRoundRobin:l});if(t.length){const e=uw({candidatePositionAssignments:m,swapOptions:t});e.error&&console.log({result:e}),h=Zv({candidatePositionAssignments:m,participantsWithGroupings:n,policyAttributes:o,idCollections:s}),I=x(h,p),g=ow({groupedParticipants:I,isRoundRobin:l}),U++}else U=20}return m.forEach((t=>{if(t.bye&&t.participantId){const t=Ut;u.push(t)}if(t.qualifier&&t.participantId){const t=Ut;u.push(t)}})),{positionAssignments:m,conflicts:g.length,groupedParticipants:I,errors:u}}function uw({candidatePositionAssignments:t,swapOptions:e}){const n=M(e);if(!n)return{error:{message:"No swap options"}};const r=n.drawPosition,i=M(n.possibleDrawPositions),a=t.find((t=>t.drawPosition===r)),o=t.find((t=>t.drawPosition===i)),s={participantId:o.participantId,qualifier:o.qualifier,bye:o.bye},c={participantId:a.participantId,qualifier:a.qualifier,bye:a.bye};return Object.assign(a,s),Object.assign(o,c),{...L}}function dw({provisionalPositioning:t,unseededParticipantIds:e,inContextDrawMatchUps:n,unseededByePositions:r,tournamentRecord:i,drawDefinition:a,seedBlockInfo:o,participants:s,matchUpsMap:c,structureId:u,avoidance:d,drawSize:p,entries:m,event:h}){if(!d)return{error:ie};const{candidatesCount:I=1,policyAttributes:U,targetDivisions:y}=d;let{roundsToSeparate:S}=d;const v="randomUnseededSeparation",{structure:w}=zd({drawDefinition:a,structureId:u}),{matchUps:T}=qp({provisionalPositioning:t,matchUpsMap:c,structure:w,event:h});if(y&&f(y)&&!S){const t=function(t){if(!f(t))return!1;let e=t,n=1;for(;2!==e;)n+=1,e/=2;return n}(y)||0,e=T.reduce(((t,e)=>e.roundNumber>t?e.roundNumber:t),0);S=e<t?1:e-t+1}const{positionAssignments:P}=bp({structure:w}),D=ul({participantsProfile:{convertExtensions:!0},participants:s}),N=P?.filter((t=>!t.participantId)),R=P?.map((t=>t.drawPosition)),b=w?.structureType===od,M=b?{structure:w,matchUps:T,allDrawPositions:R,roundsToSeparate:S}:{matchUps:T,allDrawPositions:R,roundsToSeparate:S},{drawPositionGroups:A,drawPositionChunks:C}=b?function(t){const{structure:{structures:e}}=t,n=e.map((t=>t.positionAssignments.map((t=>t.drawPosition))));return{drawPositionGroups:n,drawPositionChunks:[n]}}(M):function({allDrawPositions:t,roundsToSeparate:e,matchUps:n}){const r=n.filter((t=>1===t.roundNumber)).map((t=>t.drawPositions)),i=r.flat().sort(l),a=Math.max(...i),o=t.filter((t=>t>a)),s=i.length,c=E(2===s?1:2,s).filter((t=>t===g(t))),u=c.slice(0,e||c.length).reverse(),d=u.map((t=>x(i,t)));o.length&&console.log({fedDrawPositions:o});return{drawPositionGroups:r,drawPositionChunks:d}}(M),O={};O.groupParticipants=s.filter((t=>t.participantType===Cu)).map((t=>t.participantId)),O.teamParticipants=s.filter((t=>t.participantType===Fu)).map((t=>t.participantId)),O.pairParticipants=s.filter((t=>t.participantType===Ou)).map((t=>t.participantId));const F=function({targetParticipantIds:t,policyAttributes:e,idCollections:n,participants:r}){if(!Array.isArray(e))return{error:ae};if(!Array.isArray(r))return{error:_e};const i={};return t.forEach((t=>{const a=r.find((e=>e.participantId===t)),{values:o}=Xv({policyAttributes:e,idCollections:n,participants:r,participant:a});o&&o.forEach((e=>{i[e]||(i[e]=[]),i[e].includes(t)||i[e].push(t)}))})),i}({targetParticipantIds:e,policyAttributes:U,idCollections:O,participants:s}),k=Object.assign({},...e.map((t=>{const e=Object.keys(F).filter((e=>F[e].includes(t)));return{[t]:e}}))),_=iw({participantIds:e,positionAssignments:P});if(_.length>(N?.length||0))return{error:an};let B;const V=_.length,j=E(0,I).map((()=>cw({initialPositionAssignments:P,participantsWithGroupings:D,unseededParticipantIds:e,opponentsToPlaceCount:V,pairedPriority:!1,unseededByePositions:r,participantIdGroups:k,drawPositionChunks:C,drawPositionGroups:A,policyAttributes:U,idCollections:O,allGroups:F,drawSize:p})));if(B=j.reduce(((t,e)=>!t||(e.conflicts||0)<(t.conflicts||0)?e:t),void 0),!B||B.conflicts){const t=E(0,I).map((()=>cw({initialPositionAssignments:P,participantsWithGroupings:D,unseededParticipantIds:e,opponentsToPlaceCount:V,pairedPriority:!0,unseededByePositions:r,participantIdGroups:k,drawPositionChunks:C,drawPositionGroups:A,policyAttributes:U,idCollections:O,allGroups:F,drawSize:p,entries:m})));B=j.concat(...t).filter((t=>!t.errors?.length)).reduce(((t,e)=>!t||(e.conflicts||0)<(t.conflicts||0)?e:t),void 0)}if(!B)return{error:An};const G=(Rp({structure:w})?.positionAssignments??[]).filter((t=>t.participantId)).map((t=>t.participantId)),q=B.positionAssignments.filter((t=>!G.includes(t.participantId)));for(const l of q)if(l.bye){const t=YI({tournamentRecord:i,drawDefinition:a,seedBlockInfo:o,structureId:u,matchUpsMap:c,event:h,...l});if(t.error)return Oi({result:t,stack:v})}else{const t=Fg({automaticPlacement:!0,inContextDrawMatchUps:n,tournamentRecord:i,drawDefinition:a,seedBlockInfo:o,structureId:u,matchUpsMap:c,event:h,...l});if(t.error)return Oi({result:t,stack:v,context:{assignment:l}})}return{...L}}function pw({provisionalPositioning:t,inContextDrawMatchUps:e,unseededByePositions:n,multipleStructures:r,tournamentRecord:i,drawDefinition:a,seedBlockInfo:o,participants:s,matchUpsMap:c,structureId:u,structure:d,drawSize:p,event:l}){d||({structure:d}=zd({drawDefinition:a,structureId:u})),u||({structureId:u}=d);const{positionAssignments:m}=bp({structure:d}),{seedAssignments:f}=Sp({provisionalPositioning:t,drawDefinition:a,structure:d}),h=f?.map((t=>t.participantId)).filter(Boolean),{stage:I,stageSequence:g}=d,U=I===zu?gs({element:d,name:Eo})?.extension?.value:void 0,y=Up({provisionalPositioning:t,drawDefinition:a,stageSequence:g,entryStatuses:pp,structureId:u,roundTarget:U,stage:I}),S=y.filter((t=>!h?.includes(t.participantId))).map((t=>t.participantId)),v=m?.filter((t=>!t.participantId&&!t.bye&&!t.qualifier)).map((t=>t.drawPosition));if(!r&&S.length>(v?.length||0))return Oi({result:{error:an},context:{unseededParticipantsCount:S.length,unfilledDrawPositionsCount:v?.length},stack:"positionUnseededParticipants"});const{appliedPolicies:w}=Vo({tournamentRecord:i,drawDefinition:a,event:l});let{avoidance:T}=w??{};if(d.stage===Ju){const t=y.reduce(((t,e)=>(t[e.groupingValue]||(t[e.groupingValue]=[]),t[e.groupingValue].push(e.participantId),t)),{});Object.keys(t).length&&(T||(T={policyName:"Playoff Avoidance"}),T.policyAttributes||(T.policyAttributes=[]),T.policyAttributes.push({groupings:t}))}return T&&s?dw({provisionalPositioning:t,unseededParticipantIds:S,inContextDrawMatchUps:e,unseededByePositions:n,tournamentRecord:i,drawDefinition:a,seedBlockInfo:o,participants:s,matchUpsMap:c,structureId:u,avoidance:T,drawSize:p,entries:y}):function({provisionalPositioning:t,unseededParticipantIds:e,inContextDrawMatchUps:n,unfilledDrawPositions:r,multipleStructures:i,tournamentRecord:a,drawDefinition:o,seedBlockInfo:s,matchUpsMap:c,structureId:u,drawSize:d,event:p}){const l=d>2?P(r):r.reverse();for(const m of e){const e=l.pop();if(!i||e){const r=Fg({provisionalPositioning:t,inContextDrawMatchUps:n,tournamentRecord:a,drawDefinition:o,seedBlockInfo:s,participantId:m,drawPosition:e,matchUpsMap:c,structureId:u,event:p});if(r?.error&&console.log("!!!!!",{result:r}),r?.error)return Oi({result:r,stack:"randomUnseededDistribution"})}}return{...L}}({provisionalPositioning:t,unseededParticipantIds:S,inContextDrawMatchUps:e,unfilledDrawPositions:v,multipleStructures:r,tournamentRecord:i,drawDefinition:a,seedBlockInfo:o,structureId:u,matchUpsMap:c,drawSize:p,event:l})}function lw({orderedSortedFirstRoundSeededDrawPositions:t,validSeedBlocks:e,byesToPlace:n}){const r=[];e.forEach((e=>{if(n-r.length>e.drawPositions.length)r.push(...e.drawPositions);else{const n=fw(x(e.drawPositions,2));let i,a=t[r.length];for(;i=mw(n,a);)r.push(i),a=t[r.length]}}));const i=r.map((t=>Array.isArray(t)?P(t):t)).flat(1/0);if(function(t){const e=m(t);if(!isNaN(e))return 0!==e&&1==(e&-e)}(n)){if(e.map((t=>t.seedNumbers[0])).includes(n))return t}return i}function mw(t,e){if(Array.isArray(t)&&2!==t.length)return t.pop();if(!Array.isArray(t[0]))return t.includes(e)?t.indexOf(e)?t.pop():t.shift():Math.round(Math.random())?t.pop():t.shift();const n=t[0].flat(1/0).length,r=t[1].flat(1/0).length;if(n===r){const n=t[0].flat(1/0).includes(e)?t[0]:t[1];return mw(e?n:t[Math.round(Math.random())],e)}return mw(n<r?t[1]:t[0],e)}function fw(t){const e=Math.floor(t.length/2);return t.length>2?[fw(t.slice(0,e)),fw(t.slice(e))]:t}function hw({provisionalPositioning:t,relevantMatchUps:e,appliedPolicies:n,drawDefinition:r,seedBlockInfo:i,byesToPlace:a,structure:o}){i||(i=Tg({provisionalPositioning:t,appliedPolicies:n,drawDefinition:r,structure:o}));const{isFeedIn:s,isLuckyStructure:c,isContainer:u}=i;let{validSeedBlocks:d}=i;n?.seeding?.containerByesIgnoreSeeding&&(d=[]);const p=function({provisionalPositioning:t,drawDefinition:e,structure:n}){const{positionAssignments:r}=bp({structure:n}),{seedAssignments:i}=Sp({provisionalPositioning:t,drawDefinition:e,structure:n}),a=Object.assign({},...(i||[]).filter((t=>t.participantId)).map((t=>({[t.participantId]:t}))));return r?.map((t=>a[t.participantId]?{...t,seedNumber:a[t.participantId].seedNumber,seedValue:a[t.participantId].seedValue}:"")).filter(Boolean)}({provisionalPositioning:t,drawDefinition:r,structure:o})??[],l=T([].concat(...e.map((t=>t.drawPositions)))),m=p.filter((t=>l.includes(t.drawPosition))),f=(t,e)=>hg(t.seedValue)-hg(e.seedValue),h=d.reduce(((t,e)=>{const n=m.filter((t=>e.drawPositions?.includes(t.drawPosition))).sort(f);return t.concat(...n)}),[]).map((t=>t.drawPosition)),I=lw({orderedSortedFirstRoundSeededDrawPositions:h,validSeedBlocks:d,byesToPlace:a});return{strictSeedOrderByePositions:Iw({orderedSeedDrawPositions:h,relevantMatchUps:e}).slice(0,p.length),blockSeedOrderByePositions:Iw({orderedSeedDrawPositions:I,relevantMatchUps:e}).slice(0,p.length),isLuckyStructure:c,positionedSeeds:p,isContainer:u,isFeedIn:s}}function Iw({orderedSeedDrawPositions:t,relevantMatchUps:e}){const n=e.map((t=>t.drawPositions)).map((t=>t?.sort(((t,e)=>t-e)))).filter((t=>t?.[0]+1===t?.[1]));return t.map((t=>n.find((e=>e?.includes(t))))).filter(Boolean).map((e=>e?.reduce(((e,n)=>t.includes(n)?e:n),void 0))).filter(Boolean)}function gw({provisionalPositioning:t,tournamentRecord:e,appliedPolicies:n,drawDefinition:r,seedBlockInfo:i,matchUpsMap:a,structureId:o,structure:s,seedLimit:c,seedsOnly:u,event:d}){s||({structure:s}=zd({drawDefinition:r,structureId:o})),o||(o=s?.structureId);const p=!(s?.structures??s?.stage===zu),{byesCount:m,placedByes:f,relevantMatchUps:h}=function({provisionalPositioning:t,drawDefinition:e,matchUpsMap:n,structure:r,event:i}){const{matchUps:a,roundMatchUps:o}=qp({afterRecoveryTimes:!1,provisionalPositioning:t,drawDefinition:e,matchUpFilters:{isCollectionMatchUp:!1},matchUpsMap:n,structure:r,event:i}),s=o?.[1]||[],c=r?.structureType===od,u=c?a:s,d=c?r?.structures?.length||0:a.length,{structureId:p,stage:l,stageSequence:m}=r,f=Up({entryStatuses:lp,provisionalPositioning:t,drawDefinition:e,stageSequence:m,structureId:p,stage:l}),{qualifiersCount:h}=zv({provisionalPositioning:t,drawDefinition:e,stageSequence:m,structureId:p,stage:l}),I=f.length+h,{positionAssignments:g,unassignedPositions:U}=bp({structure:r}),y=U?.map((t=>t.drawPosition)),S=g?.filter((t=>t.bye)).length,v=g?.filter((t=>t.bye)).map((t=>t.drawPosition)),w=u.map((t=>t.drawPositions)).filter((t=>t?.reduce(((t,e)=>!v?.includes(e)&&t),!0))).flat(1/0).filter((t=>y?.includes(t))),T=g?.length;let P=T?T-I:0;return P>d&&1===r.stageSequence&&r.stage!==Yu&&(P=d),{placedByes:S,byesCount:P,relevantMatchUps:u,placedByePositions:v,roundMatchUps:o,positionsToAvoidDoubleBye:w}}({provisionalPositioning:t,drawDefinition:r,matchUpsMap:a,structure:s,event:d}),I=m-(f||0);if(I<=0)return{...L};const{strictSeedOrderByePositions:g,blockSeedOrderByePositions:U,isLuckyStructure:y,isFeedIn:S}=hw({provisionalPositioning:t,relevantMatchUps:h,appliedPolicies:n,drawDefinition:r,seedBlockInfo:i,byesToPlace:I,structure:s}),v=s?.structureType&&[od,ad].includes(s.structureType)&&n?.seeding?.containerByesIgnoreSeeding,w=p&&U?.length?U:g;let{unseededByePositions:D}=function({provisionalPositioning:t,seedOrderByePositions:e,isLuckyStructure:n,appliedPolicies:r,drawDefinition:i,seedLimit:a,structure:o,isFeedIn:s}){const c=r?.seeding?.seedingProfile,u=o.stage===zu,{positionAssignments:d}=bp({structure:o}),p=d?.filter((t=>t.participantId)).map((t=>t.drawPosition)),{matchUps:m,roundMatchUps:f}=qp({provisionalPositioning:t,matchUpFilters:{isCollectionMatchUp:!1},structure:o}),h=f?.[1]||[],I=o.structureType===od?m:h,g=T([].concat(...I.map((t=>t.drawPositions)))),U=Math.min(...g)-1,y=p?.filter((t=>g.includes(t))),S=t=>{const e=Math.ceil(t.length/2),n=[t.slice(0,e),t.slice(e)],r=n.map((t=>[].concat(...t.flat(1/0)).length)),i=Math.min(...r.flat(1/0)),a=Math.max(...r.flat(1/0)),o=r.indexOf(a),s=i!==a,c=P(n),[u,d]=!i||s?[n[o],n[1-o]]:[c[0],c[1]];return{greaterHalf:u,lesserHalf:d}},v=t=>{const{greaterHalf:e,lesserHalf:n}=S(t),{greaterHalf:r,lesserHalf:i}=S(e),a=P(r.flat(1/0)).pop();return{newlyFilteredChunks:[...n,...i,r.flat().filter((t=>t!==a))],drawPosition:a}},w=t=>!y?.includes(t),D=t=>{let e=x(t.sort(l),Math.ceil(t.length/4)).map((t=>t.filter(w)));const n=[].concat(...e.flat(1/0)).length,r=[];for(let i=0;i<n;i++){const{newlyFilteredChunks:t,drawPosition:n}=v(e);r.push(n),e=t}return r},{validSeedBlocks:N}=Tg({provisionalPositioning:t,allPositions:!0,appliedPolicies:r,drawDefinition:i,structure:o}),R=N?.map((t=>t.drawPositions?.map((t=>t+U))));let b;if(s){const t=g.length,{seedBlocks:e}=vg({cluster:Rg(c)===rd,participantsCount:t});b=e.map((t=>t.map((t=>t+U)))).map(D).filter((t=>t.length))}else b=u?R?.map((t=>t.filter(w))):R?.map(D).filter((t=>t.length));const M=I.map((t=>t.drawPositions)).map((t=>t?.sort(((t,e)=>t-e)))).filter((t=>t?.[0]+1===t?.[1])),A=t=>M.reduce(((e,n)=>n.includes(t)?n.reduce(((e,n)=>n!==t?n:e),void 0):e),void 0);let E=b.map((t=>t.map(A))).flat(1/0).filter(w).filter((t=>!e.includes(t))).filter(Boolean);if(u&&!o.structures){const t=a%4,e=E.slice(0,t),n=f[o.roundLimit]?.length,r=x(E.slice(t),n).map(P).flat();E=e.concat(r)}return{unseededByePositions:E}}({provisionalPositioning:t,seedOrderByePositions:w,isLuckyStructure:y,appliedPolicies:n,drawDefinition:r,seedLimit:c,structure:s,isFeedIn:S});let N=[].concat(...w);if(!u)for(;D.length;){const t=D.find((t=>{return e=t,(N||[]).every((t=>t%2?e!==t+1:e!==t-1));var e}));t?(N.push(t),D=D.filter((e=>e!==t))):(N.push(...D),D=[])}v&&(N=P(N),ir({ignoreSeededByes:v})&&console.log({byePositions:N}));const R=N.slice(0,I);for(const l of R){const n=YI({provisionalPositioning:t,tournamentRecord:e,drawDefinition:r,drawPosition:l,matchUpsMap:a,structureId:o,structure:s,event:d});if(n?.error)return n}return{...L,unseededByePositions:D,byeDrawPositions:R}}function Uw(t){const e=t.structure??zd(t).structure,n="positionQualifiers",r=[];if(e.stage===Yu)return Oi({result:{error:_t},stack:n});const{unplacedRoundQualifierCounts:i,positionAssignments:a,roundDrawPositions:o}=function({drawDefinition:t,structure:e,structureId:n}){e||({structure:e}=zd({drawDefinition:t,structureId:n}));n||({structureId:n}=e);const{positionAssignments:r}=bp({structure:e}),{stage:i,stageSequence:a}=e,{qualifiersCount:o,roundQualifiersCounts:s}=zv({drawDefinition:t,stageSequence:a,structureId:n,stage:i}),c=(s?Object.keys(s):[]).map((t=>m(t))),{matchUps:u}=qp({structure:e}),{roundProfile:d}=Gu({matchUps:u}),p=Object.assign({},...c.filter((t=>d?.[t])).map((t=>({[t]:d?.[t]?.drawPositions?.filter(Boolean)??[]})))),l=r?.filter((t=>t.qualifier)).map((t=>t.drawPosition)),f=o-(l?.length??0),h=l?.length,I=Object.assign({},...c.map((t=>{const e=r?.filter((e=>e.qualifier&&p[t]?.drawPositions?.includes(e.drawPosition))).map((t=>t.drawPosition));return{[t]:(s?.[t]??0)-(e?.length??0)}})));return{unplacedRoundQualifierCounts:I,unplacedQualifiersCount:f,placedQualifiersCount:h,roundQualifiersCounts:s,positionAssignments:r,roundDrawPositions:p,qualifiersCount:o}}(t);for(const s of Object.keys(i)){const t=a?.filter((t=>o[s].includes(t.drawPosition)&&!t.participantId&&!t.qualifier&&!t.bye)).map((t=>t.drawPosition));if(i[s]>(t||0))return Oi({result:{error:rn},context:{unfilledDrawPositions:t},stack:n});E(0,i[s]).forEach((()=>{const e=M(t);r.push(e),a?.forEach((t=>{t.drawPosition===e&&(t.qualifier=!0,delete t.participantId,delete t.bye)}))}))}return{...L,qualifierDrawPositions:r}}function yw({provisionalPositioning:t,inContextDrawMatchUps:e,tournamentRecord:n,appliedPolicies:r,validSeedBlocks:i,drawDefinition:a,seedingProfile:o,seedBlockInfo:s,participants:c,groupsCount:u,structureId:d,matchUpsMap:p,structure:l,event:m}){const f=[],h=[];let I=0;if(l||({structure:l}=zd({drawDefinition:a,structureId:d})),d||(d=l?.structureId),r||(r=Vo({drawDefinition:a}).appliedPolicies),!i){const e=l&&Tg({provisionalPositioning:t,appliedPolicies:r,drawDefinition:a,structure:l});e?.error&&h.push(e.error),i=e?.validSeedBlocks}return E(0,u=u??i?.length??0).forEach((()=>{if(I<(u||0)){const r=function({provisionalPositioning:t,inContextDrawMatchUps:e,tournamentRecord:n,drawDefinition:r,seedingProfile:i,seedBlockInfo:a,participants:o,structureId:s,matchUpsMap:c,event:u}){const{unplacedSeedParticipantIds:d,unfilledPositions:p}=Ng({provisionalPositioning:t,randomize:!0,drawDefinition:r,seedBlockInfo:a,structureId:s,event:u}),{appliedPolicies:l}=Vo({drawDefinition:r}),{avoidance:m}=l??{};const f=[];for(const h of d){const o=p.pop();if(!o)return{error:st};f.push(o);const d=Fg({provisionalPositioning:t,inContextDrawMatchUps:e,tournamentRecord:n,drawDefinition:r,seedingProfile:i,participantId:h,seedBlockInfo:a,drawPosition:o,matchUpsMap:c,structureId:s,event:u});if(!d.success)return d}return{...L,seedPositions:f}}({provisionalPositioning:t,inContextDrawMatchUps:e,tournamentRecord:n,drawDefinition:a,seedingProfile:o,seedBlockInfo:s,participants:c,structureId:d,matchUpsMap:p,event:m});r?.success&&(I++,f.push(...r.seedPositions??[])),r.error&&h.push({seedPositionError:r.error})}})),h.length?{error:h}:{...L,seedPositions:f}}function Sw({applyPositioning:t=!0,provisionalPositioning:e,inContextDrawMatchUps:n,multipleStructures:r,placeByes:i=!0,tournamentRecord:a,appliedPolicies:o,placementGroup:s,drawDefinition:c,seedingProfile:u,participants:d,structureId:p,matchUpsMap:l,seedLimit:m,seedsOnly:f,drawType:h,drawSize:I,event:g}){const U=[];t||(rr.disableNotifications(),c=ri(c,!1,!0));const y=e=>(t||or(),Oi({result:e,stack:"automatedPositioning"})),S=zd({drawDefinition:c,structureId:p});if(S.error)return y(S);const v=S.structure;if(!v)return{error:Dt};o||(o=Vo({drawDefinition:c,structure:v,event:g})?.appliedPolicies);const{qualifiersCount:w}=zv({stageSequence:v.stageSequence,provisionalPositioning:e,stage:v.stage,drawDefinition:c,structureId:p}),T=pp,P=Up({stageSequence:v.stageSequence,provisionalPositioning:e,stage:v.stage,placementGroup:s,drawDefinition:c,entryStatuses:T,structureId:p});if(!P?.length&&!w)return D={...L},t||or(),D;var D;l=l??wp({drawDefinition:c}),n||({matchUps:n}=Pl({inContext:!0,drawDefinition:c,matchUpsMap:l}));let N=[];const R=Tg({provisionalPositioning:e,appliedPolicies:o,drawDefinition:c,structure:v});if(R.error)return R;const{validSeedBlocks:b}=R;if(U.push({validSeedBlocks:b}),Rg(v.seedingProfile||u)===id){let t=i?gw({provisionalPositioning:e,tournamentRecord:a,appliedPolicies:o,drawDefinition:c,seedBlockInfo:R,matchUpsMap:l,structure:v,seedLimit:m,seedsOnly:f,event:g}):void 0;if(t?.error)return y(t);N=t.unseededByePositions,U.push({action:"positionByes",unseededByePositions:N});if(t=yw({seedingProfile:v.seedingProfile?{positioning:v.seedingProfile}:u,provisionalPositioning:e,inContextDrawMatchUps:n,tournamentRecord:a,appliedPolicies:o,validSeedBlocks:b,drawDefinition:c,seedBlockInfo:R,participants:d,matchUpsMap:l,structure:v,event:g}),t.error)return y(t);U.push({seedPositions:t.seedPositions,action:"positionSeedBlocks"})}else{if(h!==Td){const t=yw({seedingProfile:v.seedingProfile?{positioning:v.seedingProfile}:u,provisionalPositioning:e,inContextDrawMatchUps:n,tournamentRecord:a,appliedPolicies:o,validSeedBlocks:b,drawDefinition:c,seedBlockInfo:R,participants:d,matchUpsMap:l,structure:v,event:g});if(t.error)return y(t);U.push({action:"positionSeedBlocks",seedPositions:t.seedPositions})}const t=i?gw({provisionalPositioning:e,tournamentRecord:a,appliedPolicies:o,drawDefinition:c,seedBlockInfo:R,matchUpsMap:l,structure:v,seedLimit:m,seedsOnly:f,event:g}):void 0;if(t?.error)return console.log("positionByes",{result:t}),y(t);N=t?.unseededByePositions,U.push({action:"positionByes",byeDrawPositions:t?.byeDrawPositions,unseededByePositions:N})}const M={};if(!f){let t=Uw({inContextDrawMatchUps:n,tournamentRecord:a,appliedPolicies:o,validSeedBlocks:b,drawDefinition:c,seedBlockInfo:R,participants:d,matchUpsMap:l,structure:v});if(t.error)return y(t);if(t.conflicts&&(M.qualifierConflicts=t.conflicts),U.push({action:"positionQualifiers",qualifierDrawPositions:t.qualifierDrawPositions}),t=pw({provisionalPositioning:e,inContextDrawMatchUps:n,unseededByePositions:N,multipleStructures:r,tournamentRecord:a,drawDefinition:c,seedBlockInfo:R,participants:d,matchUpsMap:l,structureId:p,structure:v,drawSize:I,event:g}),t.error)return y(t);t.conflicts&&(M.unseededConflicts=t.conflicts),U.push({action:"positionUnseededParticipants"})}const{positionAssignments:A}=Rp({drawDefinition:c,structure:v});return il({drawDefinition:c,structureIds:[p]}),t||or(),{positionAssignments:A,conflicts:M,...L,positioningReport:U}}function vw(t){const{applyPositioning:e=!0,provisionalPositioning:n,tournamentRecord:r,drawDefinition:i,seedingProfile:a,structureId:o,placeByes:s,seedsOnly:c,event:u}=t;if(!u)return{error:Et};if(!i)return{error:J};if(!dg({drawDefinition:i,structureId:o})&&!n)return{error:X};const d=cg({drawDefinition:i,structureId:o}).playoffStructures?.sort(((t,e)=>Hd(t)-Hd(e))),p=[],l=r?.participants;if(d)for(const m of d){const{structureId:t}=m,r=Sw({structureId:t,provisionalPositioning:n,applyPositioning:e,drawDefinition:i,seedingProfile:a,participants:l,placeByes:s,seedsOnly:c});if(r.error)return r;r.positionAssignments&&p.push({positionAssignments:r.positionAssignments,structureId:t})}return{...L,structurePositionAssignments:p}}function ww(t){const e="genPlayoffStructure";if(!t.drawDefinition)return Oi({result:{error:Y},stack:e});const n=Cv(t);if(n.error)return Oi({result:n,stack:e});const{structureId:r,addNameBaseToAttributeName:i,playoffStructureNameBase:a,finishingPositionNaming:o,finishingPositionLimit:s,playoffAttributes:c,playoffPositions:u,roundOffsetLimit:d,tournamentRecord:p,exitProfileLimit:l,roundProfiles:f,roundNumbers:h,idPrefix:I,isMock:g,event:U,uuids:y}=t,S=ri(t.drawDefinition,!1,!0),{structure:v}=zd({structureId:r,drawDefinition:S});if(!v)return Oi({result:{error:Dt},stack:e});if(v.structureType===od||v.structures)return function(t){const e="generateAndPopulateRRplayoffStructures";if(!t.playoffGroups)return Oi({result:{error:me},info:"playoffGroups required",stack:e});const{sourceStructureId:n,requireSequential:r,drawDefinition:i,playoffGroups:a,groupCount:o,groupSize:s,event:c}=t,{structures:u=[],links:d=[],finishingPositionTargets:p,positionRangeMap:l,error:m}=jv({requireSequential:r,sourceStructureId:n,playoffGroups:a,groupCount:o,groupSize:s,...t});if(m)return{error:m};const f=p?.map((({finishingPositions:t})=>t)).flat().map((t=>l[t].finishingPositions)).flat();i.structures.push(...u),i.links.push(...d);const{matchUps:h,matchUpsMap:I}=Pl({inContext:!0,drawDefinition:i}),g=u.map((({structureId:t})=>t)),U=h?.filter((({structureId:t})=>g.includes(t))).map(hl),y=I?.drawMatchUps?.filter((({matchUpId:t})=>U?.includes(t)));if(y?.length){const e=Ri({drawDefinition:i,event:c})?.tieFormat;e&&y.forEach((n=>{const{tieMatchUps:r}=gU({isMock:t.isMock,tieFormat:e});Object.assign(n,{tieMatchUps:r,matchUpType:Ea})}))}const{positionAssignments:S}=Rp({structureId:n,drawDefinition:i}),v={};S?.forEach((t=>{const e=tc({element:t,name:xo}),n=e?.extension?.value,r=n?.groupOrder;r&&(v[r]||(v[r]=[]),v[r].push(t.participantId))}));const w=vw({provisionalPositioning:t.provisionalPositioning,structureId:n,applyPositioning:!0,event:t.event,drawDefinition:i});return w.error&&w.error?.code!==X.code?Oi({result:w,stack:e}):{structures:u,links:d,positionsPlayedOff:f,drawDefinition:i,...L}}({sourceStructureId:v.structureId,...t,...n,drawDefinition:S});const{playoffRoundsRanges:w,playoffRounds:T}=n,{playoffPositionsReturned:P,error:D,playoffSourceRounds:N,playoffRoundsRanges:R}=Ev(t);if(D)return Oi({result:{error:D},stack:e});const b=f?.length&&Object.assign({},...f),M=h||"object"==typeof f&&f.map((t=>Object.keys(t))).flat(),A=Array.isArray(M)&&M.map((t=>!isNaN(t)&&m(t))).filter(Boolean);if(A){if(!Array.isArray(A))return Oi({result:{error:xn},context:{validRoundNumbers:A},stack:e});A.forEach((t=>{if(!T?.includes(t))return Oi({result:{error:xn},context:{roundNumber:t},stack:e})}))}u&&u.forEach((t=>{if(!P?.includes(t))return Oi({result:{error:xn},context:{playoffPosition:t},stack:e})}));const E=A||N,C=A?w:R,O=[],F=[];for(const m of E??[]){const t=C?.find((t=>t.roundNumber===m));if(!t)return Oi({result:{error:xn},context:{roundNumber:m},stack:e});const n=t.finishingPositions.length,u=Math.min(...t.finishingPositions)-1,p=2,f=m&&b?.[m]&&p+b[m]-1,h=Bv({exitProfile:`0-${m}`,addNameBaseToAttributeName:i,playoffStructureNameBase:a,finishingPositionOffset:u,playoffAttributes:c,exitProfileLimit:l,stage:Ju,roundOffset:0,drawDefinition:S,sequenceLimit:f,stageSequence:p,drawSize:n,idPrefix:I,isMock:g,uuids:y,finishingPositionNaming:o,finishingPositionLimit:s,roundOffsetLimit:d});if(h.error)return Oi({result:h,stack:e});const{structures:U,links:v}=h;if(U?.length&&O.push(...U),v?.length&&F.push(...v),h.structureId&&m){const t={linkType:_i.Loser,source:{structureId:r,roundNumber:m},target:{structureId:h.structureId,feedProfile:Li.TopDown,roundNumber:1}};F.push(t)}}if(!O.length)return Oi({result:{error:xn},info:"No structures generated",stack:e});S.structures.push(...O),S.links.push(...F);const{matchUps:k,matchUpsMap:x}=Pl({inContext:!0,drawDefinition:S}),_=O.map((({structureId:t})=>t)),B=k?.filter((({structureId:t})=>_.includes(t))).map(hl),V=x?.drawMatchUps?.filter((({matchUpId:t})=>B?.includes(t)));if(V?.length){const t=Ri({drawDefinition:S,event:U})?.tieFormat;t&&V.forEach((e=>{const{tieMatchUps:n}=gU({tieFormat:t,isMock:g});Object.assign(e,{tieMatchUps:n,matchUpType:Ca})}))}const j=k?.filter((t=>Ua({matchUp:t})&&t.structureId===r));j?.forEach((t=>{const{matchUpId:e,score:n,winningSide:r}=t,i=yl({inContextDrawMatchUps:k,drawDefinition:S,matchUpId:e}),a=kg({inContextDrawMatchUps:k,tournamentRecord:p,drawDefinition:S,matchUpsMap:x,winningSide:r,targetData:i,matchUpId:e,structure:v,matchUp:t,score:n,event:U});a.error&&console.log(a.error)}));const G=k?.filter((t=>t.matchUpStatus===Ki&&t.structureId===r));G?.forEach((t=>{const{matchUpId:e}=t,n=yl({inContextDrawMatchUps:k,drawDefinition:S,matchUpId:e}),{targetLinks:{loserTargetLink:r},targetMatchUps:{loserMatchUpDrawPositionIndex:i,loserMatchUp:a}}=n;if(r&&a){const t=r.target.structureId,e=YI({drawPosition:a.drawPositions[i],structureId:t,tournamentRecord:p,drawDefinition:S,event:U});e.error&&console.log(e.error)}}));const q=[],$=oh({inContextDrawMatchUps:k,drawDefinition:S,matchUpsMap:x}).goesToMap,{structure:W}=zd({drawDefinition:t.drawDefinition,structureId:r}),{matchUps:H}=qp({structure:W});return H.forEach((n=>{const r=$?.loserMatchUpIds[n.matchUpId];if(r&&n.loserMatchUpId!==r){n.loserMatchUpId=r;const i={tournamentId:p?.tournamentId,eventId:t.event?.eventId,context:e,matchUp:n};q.push(i)}const i=$?.winnerMatchUpIds[n.matchUpId];if(i&&n.winnerMatchUpId!==i){n.winnerMatchUpId=i;const r={tournamentId:p?.tournamentId,eventId:t.event?.eventId,context:e,matchUp:n};q.push(r)}})),{structures:O,matchUpModifications:q,links:F,drawDefinition:S,...L}}function Tw({drawDefinition:t,drawSize:e}){if(!t)return{error:Y};const n=Kv({stage:Ku,stageSequence:1,drawDefinition:t,drawSize:e});return n.error?n:(il({drawDefinition:t}),{...L})}function Pw(t){const{drawType:e=yd,attachConsolation:n=!0,applyPositioning:r=!0,tournamentRecord:i,staggeredEntry:a,automated:o,placeByes:s,isMock:c,event:u}=t;let d=t?.drawDefinition;if(!d)return{error:Y};const p=i?sU({withIndividualParticipants:!0,tournamentRecord:i})?.participants:[],l=Ku,m=Up({stageSequence:1,drawDefinition:d,stage:l}),f=[kd,Sd,xd].includes(e)?m.length:y(m.length);if(!a&&e===Id&&m.length<2||e===kd&&m.length<3)return{error:ut};let{tieFormat:h,matchUpType:I}=t;if(h){const t=$i({tieFormat:h});if(t.error)return t}h=zp(h??Ri({drawDefinition:d})?.tieFormat),I=I??d.matchUpType??Bi.Singles;const{structures:g}=Yd({stageSequence:1,drawDefinition:d,stage:l});if(g.length>1)return{error:Lt};if(g?.[0]?.matchUps?.length)return{error:Kn};const U=g?.[0]?.structureId;Object.assign(t,di({structureName:t.structureName??gg(Ku),structureId:U,matchUpType:I,tieFormat:h,drawSize:f,stage:l}));const S=Wv(t);if(S.error)return S;const v=S.generators[e];if(!v)return{error:rt};const w=v?.();if(w.error)return w;const{structures:T,links:P}=w,D=T.map((t=>qp({structure:t}).matchUps)).flat();h&&D.forEach((t=>{const{tieMatchUps:e}=gU({tieFormat:h,isMock:c});Object.assign(t,{tieMatchUps:e,matchUpType:I})})),r&&n||(d=ri(d,!1,!0)),d.links||(d.links=[]),P.length&&d.links.push(...P);const N=T.map((({structureId:t})=>t));d.structures||(d.structures=[]);const R=d.structures.map((({structureId:t})=>t));d.structures=d.structures.map((t=>N.includes(t.structureId)?T.find((({structureId:e})=>e===t.structureId)):t));const b=T.filter((({structureId:t})=>!R.includes(t)));return b.length&&d.structures.push(...b),o&&Sw({seedingProfile:t.seedingProfile,applyPositioning:r,tournamentRecord:i,drawDefinition:d,participants:p,structureId:U,placeByes:s,drawSize:f,event:u}),n&&il({drawDefinition:d}),{links:P,structures:T,...L}}function Dw(t){if(!t.drawDefinition)return{error:Y};const e="generateQualifyingStructure";let n=t.drawSize||I(t.participantsCount);const{qualifyingRoundNumber:r,qualifyingPositions:i,targetStructureId:a,structureOptions:o,appliedPolicies:s,drawDefinition:c,structureName:u,structureId:d,roundTarget:p,drawType:l,idPrefix:m,isMock:f,uuids:h}=t;let g,U,y,S,w,T=0,P=1;if(!v(n))return Oi({result:{error:pt},stack:e});const D=zd({structureId:a,drawDefinition:c});if(D.error)return Oi({context:{targetStructureId:a},result:D,stack:e});if(!D.structure)return{error:Dt};const N=D.structure,R=N.matchUpType;if(N.stage===zu)if(N.stageSequence&&N.stageSequence>1)P=N.stageSequence-1;else{let t,n=a,r=2;for(;!t&&n;){N.stageSequence=r;const i=c.links.find((t=>t.source.structureId===n))?.target?.structureId;if(n=i,r+=1,i){const n=zd({structureId:i,drawDefinition:c});if(!n.structure)return{error:Dt};if(n.error)return Oi({context:{targetTargetStructureId:i},result:n,stack:e});n.structure.stage!==zu&&(t=!0)}else t=!0}}const b=p?`${p}-`:"",M=`${P}`,A=u||(b||M?`${gg(zu)} ${b}${M}`:gg(zu));if(l===kd){const{maxRoundNumber:t,structures:e,groupCount:r}=yg({structureName:u||A,structureId:d||h?.pop(),stage:zu,structureOptions:o,appliedPolicies:s,stageSequence:P,matchUpType:R,roundTarget:p,idPrefix:m,drawSize:n,isMock:f,uuids:h});T=r,g=t,y=e[0],w=[1]}else({drawSize:n,matchUps:S,roundLimit:g,roundsCount:U}=Pv({qualifyingRoundNumber:r,qualifyingPositions:i,matchUpType:R,idPrefix:m,drawSize:n,isMock:f,uuids:h})),g||(g=U),y=Ug({structureName:u||A,structureId:d||h?.pop(),qualifyingRoundNumber:g,stage:zu,stageSequence:P,matchUpType:R,roundLimit:g,matchUps:S}),p&&Bs({element:y,extension:{name:Eo,value:p}}),T=S?.filter((t=>t.roundNumber===g))?.length;const E=l===kd?_i.Position:_i.Winner,{link:C}=vv({sourceStructureId:y.structureId,sourceRoundNumber:g,targetStructureId:a,finishingPositions:w,linkType:E});return{qualifyingDrawPositionsCount:n,qualifiersCount:T,...L,structure:y,link:C}}function Nw({drawDefinition:t,tournamentId:e,structure:n,eventId:r,link:i}){if(!t)return{error:Y};if(!n)return{error:Rt};if(!i)return{error:wt};const a=i.target.structureId,o=zd({drawDefinition:t,structureId:a});if(o.error)return Oi({stack:"attachQualifyingStructure",context:{targetStructureId:a},result:o});t.structures||(t.structures=[]),t.links||(t.links=[]),t.structures.push(n),t.links.push(i);return tl({drawDefinition:t,tournamentId:e,matchUps:qp({structure:n})?.matchUps||[],eventId:r}),il({drawDefinition:t,structureIds:[n.structureId]}),{...L}}function Rw(t){return t.matchUpStatus===Ki?t.sides.reduce(((t,e)=>e.participantId||t),void 0):t.winningSide?t.sides.reduce(((e,n)=>n.sideNumber===t.winningSide?n.participantId:e),void 0):void 0}function bw(t){const e=Dw(t);if(e.error)return e;const{structure:n,link:r}=e;return n&&r?Nw({tournamentId:t.tournamentRecord?.tournamentId,eventId:t.event?.eventId||t.eventId,drawDefinition:t.drawDefinition,structure:n,link:r}):{error:xn}}function Mw(t){return Aw(t)}function Aw({matchUpModifications:t,tournamentRecord:e,drawDefinition:n,structures:r,links:i=[],event:a}){const o="attachStructures";if(!n)return{error:Y};if(!Array.isArray(r)||!Array.isArray(i))return Oi({result:{error:xn},stack:o});const s=t=>[t.source.structureId,t.source.roundNumber||t.source.finishingPositions?.join("|"),t.target.roundNumber].join("|"),c=n.links?.map(s);if(i.some((t=>{const e=s(t);return c?.includes(e)})))return Oi({result:{error:Kn},info:"playoff structure exists",stack:o});i.length&&n.links?.push(...i);const u=r.map((({structureId:t})=>t)),d=n.structures?.map((({structureId:t})=>t));n.structures=(n.structures||[]).map((t=>u.includes(t.structureId)?r.find((({structureId:e})=>e===t.structureId)):t));const p=r?.filter((({structureId:t})=>!d?.includes(t)));p.length&&n.structures.push(...p),oh({drawDefinition:n});const l=r.map((t=>qp({structure:t})?.matchUps||[])).flat();tl({tournamentId:e?.tournamentId,eventId:a?.eventId,drawDefinition:n,matchUps:l});if(il({drawDefinition:n,structureIds:r.map((({structureId:t})=>t))}),t?.length){const e={};t.forEach((t=>{const n=t.matchUp?.matchUpId;n&&(e[n]=t)}));const r=t=>{t.matchUps.forEach((t=>{if(e[t.matchUpId]){const{tieMatchUps:n,...r}=e[t.matchUpId].matchUp;if(Object.assign(t,r),n?.length){const r={};n.forEach((t=>e[t.matchUpId]=t)),t.tieMatchUps.forEach((t=>Object.assign(t,r[t.matchUpId])))}e[t.matchUpId].matchUp=t,nl(e[t.matchUpId])}}))};n.structures.forEach((t=>{if(d?.includes(t.structureId))if(t.structures)for(const e of t.structures)r(e);else r(t)}))}const m=p.map(ui("structureId"));return{...L,addedStructureIds:m}}function Ew(t){const{structures:e,links:n,matchUpModifications:r,error:i}=ww(t);if(i)return{error:i};const a=t.drawDefinition;return Mw({tournamentId:t.tournamentRecord?.tournamentId,eventId:t.event?.eventId||t.eventId,matchUpModifications:r,drawDefinition:a,structures:e,links:n})}function Cw({tournamentRecord:t,matchUpIds:e=[],drawDefinition:n,structureId:r,event:i}){if("object"!=typeof n)return{error:Y};if("string"!=typeof r)return{error:Pt};if(!Array.isArray(e))return{error:xn};const a=n.structures?.find((t=>t.structureId===r));if(!a)return{error:Dt};const o=a?.matchUps,s=o?.find((t=>!!t.roundPosition));if(a.structures||s||a.finishingPosition===Gd)return{error:Q};const c=[],u=o?.filter((({matchUpId:t,score:n})=>(Yp({score:n})&&c.push(t),e.includes(t))))??[],d=u.map(ui("matchUpId"));if(d.length){a.matchUps=(a.matchUps??[]).filter((({matchUpId:t})=>!d.includes(t))),el({tournamentId:t?.tournamentId,matchUpIds:d,action:"deleteAdHocMatchUps",eventId:i?.eventId,drawDefinition:n});const e=function(t,e=1){return Array.isArray(t)&&t.every(v)?E(Math.min(...t,e),Math.max(...t)+1).filter((e=>!t.includes(e))):[]}(T(a.matchUps.map(ui("roundNumber"))));if(e.length){e.reverse();for(const r of e)a.matchUps.forEach((e=>{e.roundNumber&&e.roundNumber>r&&(e.roundNumber-=1,nl({tournamentId:t?.tournamentId,context:["adHoc round deletion"],eventId:i?.eventId,drawDefinition:n,matchUp:e}))}))}if(c.length){a.positionAssignments=T(a.matchUps.flatMap((t=>(t.sides??[]).map((t=>t.participantId)))).filter(Boolean)).map((t=>({participantId:t})));const e=a?.matchUpFormat??n?.matchUpFormat??i?.matchUpFormat,r=cl({positionAssignments:a.positionAssignments,matchUps:a.matchUps,tournamentRecord:t,drawDefinition:n,matchUpFormat:e,event:i});r.error&&console.log(r)}il({structureIds:[r],eventId:i?.eventId,drawDefinition:n})}return{...L}}function Ow({drawDefinition:t,orderMap:e}){return t?("object"==typeof e&&Object.values(e).every((t=>v(t)))||Oi({result:{error:xn},context:{orderMap:e}}),t.structures||(t.structures=[]),t.structures.forEach((t=>{const n=e[t.structureId];n&&(t.structureOrder=n)})),t.structures.sort(((t,e)=>D(t.structureOrder)-D(e.structureOrder))),{...L}):{error:Y}}function Fw({drawDefinition:t,structureDetails:e}){if(!si(e))return{error:xn};if(!t)return{error:Y};const n=Object.assign({},...e.map((t=>{if(!si(t))return;const{structureId:e,structureName:n}=t||{};return e&&n?{[e]:n}:void 0})).filter(Boolean));if(!Object.values(n).length)return{error:me};let r=0;for(const i of t.structures||[]){const t=n[i.structureId];t&&(i.structureName=t,r+=1)}return{...L,modificationsApplied:r}}function kw({tournamentRecord:t,drawDefinition:e,structureId:n,event:r}){if("string"!=typeof n)return{error:xn};if(!e)return{error:Y};if(!n)return{error:Pt};const i=e.structures||[],a=[],o=i.find((({stage:t,stageSequence:e})=>t===Hu&&1===e)),s=n===o.structureId,c=i.find((({stage:t})=>t===zu));if(s&&!c)return{error:j};const u=[],d=[n],p=t=>e.links?.map((e=>e.source.structureId===t&&e.target.structureId!==o.structureId&&e.target.structureId)).filter(Boolean),l=i.map((({structureId:t})=>t)),m=Object.assign({},...l.map((t=>({[t]:p(t)}))));for(;d.length;){const t=d.pop(),{structure:r}=zd({structureId:t,drawDefinition:e}),{matchUps:i}=qp({structure:r}),c=pl(i);u.push(...c),e.links=e.links?.filter((e=>e.source.structureId!==t&&e.target.structureId!==t))||[],s&&t===n||(e.structures=(e.structures??[]).filter((e=>(t&&t===e.structureId&&a.push(t),e.structureId!==t))));const p=t&&m[t].filter((t=>t!==o.structureId||n===o.structureId));p?.length&&d.push(...p)}const{matchUps:f}=Pl({drawDefinition:e});return f?.forEach((t=>{t.winnerMatchUpId&&u.includes(t.winnerMatchUpId)&&delete t.winnerMatchUpId,t.loserMatchUpId&&u.includes(t.loserMatchUpId)&&delete t.loserMatchUpId})),s&&(o.positionAssignments=[],o.seedAssignments=[],o.matchUps=[],o.extensions&&(o.extensions=[])),el({tournamentId:t?.tournamentId,matchUpIds:u,action:"removeStructure",eventId:r?.eventId,drawDefinition:e}),il({drawDefinition:e,eventId:r?.eventId}),{...L,removedMatchUpIds:u,removedStructureIds:a}}function xw({participantIdPairings:t,addToStructure:e=!0,tournamentRecord:n,matchUpIds:r=[],drawDefinition:i,matchUpsCount:a,roundNumber:o,structureId:s,newRound:c}){if("object"!=typeof i)return{error:Y};if(s||1!==i.structures?.length||(s=i.structures?.[0]?.structureId),"string"!=typeof s)return{error:Pt};const u=i.structures?.find((t=>t.structureId===s));if(!u)return{error:Dt};let d;const p=u.matchUps??[],l=p?.reduce(((t,e)=>(e.roundPosition&&(d=!0),(e?.roundNumber||0)>t?e.roundNumber:t)),0);if(!a){const t=i?.entries?.filter((t=>{const e=t.entryStatus;return lp.includes(e)}))??[],e=Math.floor(t?.length/2)||1;if(c)a=e;else{const t=o||l||1,n=e-(u.matchUps?.filter((e=>e.roundNumber===t))?.length||0);n>0&&(a=n)}}if(t&&!Array.isArray(t)||a&&!v(a)||r&&!Array.isArray(r)||!t&&!a)return{error:xn,info:"matchUpsCount or pairings error"};if(u.structures||d||u.finishingPosition===Gd)return{error:Q};if(o&&o-1>(l||0))return{error:xn,info:"roundNumber error"};const m=o??(c&&(l??0)+1||l||1);t=t??E(0,a).map((()=>({participantIds:[void 0,void 0]})));const f=t?.map((t=>{const e=t?.participantIds??[void 0,void 0];e.push(void 0,void 0);const n=e.slice(0,2).map(((t,e)=>di({sideNumber:e+1,participantId:t})));return{matchUpStatus:Vi.ToBePlayed,matchUpId:r.pop()??hi(),roundNumber:m,sides:n}}));if(e){const t=_w({tournamentRecord:n,drawDefinition:i,structureId:s,matchUps:f});if(t.error)return t}return{matchUpsCount:f.length,matchUps:f,...L}}function _w({tournamentRecord:t,drawDefinition:e,structureId:n,matchUps:r}){if("object"!=typeof e)return{error:Y};if(n||1!==e.structures?.length||(n=e.structures?.[0]?.structureId),"string"!=typeof n)return{error:Pt};if(!Sa(r))return{error:xn,info:Ci("matchUps")};const i=e.structures?.find((t=>t.structureId===n));if(!i)return{error:Dt};const a=i?.matchUps,o=a.find((t=>!!t.roundPosition));if(i.structures||o||i.finishingPosition===Gd)return{error:Q};return k(th({tournamentRecord:t,inContext:!1})?.matchUps?.map(hl)??[],r.map(hl))?{error:zn,info:"One or more matchUpIds already present in tournamentRecord"}:(i.matchUps.push(...r),tl({tournamentId:t?.tournamentId,drawDefinition:e,matchUps:r}),il({drawDefinition:e,structureIds:[n]}),{...L})}const Lw={generateAndPopulatePlayoffStructures:ww,attachPlayoffStructures:Mw,addPlayoffStructures:Ew,setStructureOrder:Ow,renameStructures:Fw,generateQualifyingStructure:Dw,attachQualifyingStructure:Nw,addQualifyingStructure:bw,getAvailablePlayoffRounds:Cv,getAvailablePlayoffProfiles:Cv,getSourceRounds:Ev,getDrawStructures:Yd,getPositionsPlayedOff:Av,getQualifiersCount:zv,removeStructure:kw,generateAdHocMatchUps:xw,deleteAdHocMatchUps:Cw,addAdHocMatchUps:_w,addVoluntaryConsolationStage:Tw,addVoluntaryConsolationStructure:Sv,generateVoluntaryConsolation:Pw,buildDrawHierarchy:function({matchUps:t,matchUpType:e}){if(!t)return{error:Zt};let n=[],r=[],i=0;e&&(t=t.filter((t=>t.matchUpType===e)));const a=T(t.map((({matchUpType:t})=>t)));if(a.length>1)if(a.includes(Ca))t=t.filter((t=>t.matchUpType===Ca));else if(a.includes(ba))t=t.filter((t=>t.matchUpType===ba));else{if(!a.includes(Aa))return{};t=t.filter((t=>t.matchUpType===Aa))}if(!Sa(t)||!t.length)return{};const o=(t,e)=>m(t)-m(e),s=T(t.map((t=>t.drawPositions)).flat().filter(Boolean)).sort(o),c=E(1,Math.max(...s)+1).filter((t=>!s.includes(t))).sort(o),{roundMatchUps:u}=Gu({matchUps:t}),d=u?.[1],p=u?.[2]||[],l=d?.[0]||{},f=l.drawId,h=l.structureId,I=u?Object.keys(u).map((t=>m(t))):[],g=Math.max(...I),U=u?.[g]?.length||0,y=Math.ceil(Math.log(U)/Math.log(2)),S=E(1,y+1).map((t=>{const e=Math.pow(2,t-1),n=g+y-t+1;return E(1,e+1).map((e=>({drawId:f,structureId:h,matchUpId:hi(),drawPositions:[],sides:[],roundNumber:n,roundPosition:e,finishingRound:t})))}));y&&(t=t.concat(...S.flat()));const v=d?.map((t=>t.drawPositions)),w=v.flat(1/0),P=p.map((t=>t.drawPositions)).flat(1/0).filter((t=>!w.includes(t))).sort(o),D=p.filter((t=>t.drawPositions?.reduce(((t,e)=>P.includes(e)||t),void 0))).map((t=>{const e=t.drawPositions?.reduce(((t,e)=>P.includes(e)?e:t),void 0),n=t.drawPositions?.indexOf(e);return{[e]:t.sides[n]}}));if(c?.length&&P?.length===c?.length){const e=P.map(((t,e)=>[t,c[e]].sort(o))),n=Object.assign({},...D),i=ri(d?.[0].finishingRound,!1,!0),a=ri(d?.[0].finishingPositionRange,!1,!0);r=e.map(((t,e)=>{const r=Math.max(...t||[])/2,o=t?.map((t=>n[t]||{bye:!0,drawPosition:t}));return{sides:o,drawId:f,structureId:h,roundPosition:r,drawPositions:t,roundNumber:1,finishingRound:i,matchUpId:hi(),matchUpStatus:"BYE",sideNumber:e+1,finishingPositionRange:a}})),t=t.concat(...r)}const N=g+y;return E(1,N+1).forEach((e=>{const r=[],a=R({matchUps:t,roundNumber:e}),o=R({matchUps:t,roundNumber:e-1}).map(Rw).filter(Boolean),s=a?.length===n?.length,c=a?.length===n?.length/2;1===e&&a.forEach((t=>{const e=t.drawPositions||[],{matchUpId:n,structureId:i}=t,a=[{...t.sides[0],drawPosition:e[0],matchUpId:n,structureId:i},{...t.sides[1],drawPosition:e[1],matchUpId:n,structureId:i}],o={...t,children:a};r.push(o)})),s?(i++,a.forEach(((t,e)=>{const a=t.drawPositions||[],{matchUpId:s,structureId:c}=t,u=a.filter(Boolean).reduce(((t,e)=>w.includes(e)?t:e),void 0),d=[{...t.sides.filter(Boolean).reduce(((t,e)=>e.participantId&&!o.includes(e.participantId)?e:t),void 0),drawPosition:u,feedRoundNumber:i,sides:t.sides,matchUpId:s,structureId:c},n[e]],p={...t,children:d};r.push(p)}))):c&&a.forEach(((t,e)=>{const i={...t,children:[n[2*e],n[2*e+1]]};r.push(i)})),n=r})),{hierarchy:n[0],missingMatchUps:r,maxRound:g,finalRound:N,matchUps:t};function R({matchUps:t,roundNumber:e}){return t.filter((t=>t.roundNumber===e)).sort(((t,e)=>t.roundPosition-e.roundPosition))}},generateDrawTypeAndModifyDrawDefinition:Qv,generateDrawStructuresAndLinks:Hv};function Bw({participantsCount:t,participantCount:e}){if(!(t=t||e))return{error:xn};const n=y(t);return n?{drawSize:n}:Oi({result:{error:xn},stack:"getEliminationDrawSize",context:{participantsCount:t}})}function Vw(t){let{drawSizeProgression:e=!1,policyDefinitions:n,drawSize:r}=t||{};const{requireParticipantCount:i=!0,tournamentRecord:a,drawDefinition:o,event:s}=t||{},c="getSeedsCount",u=t?.participantsCount||t?.participantCount;if(!n){const t=jo({tournamentRecord:a,drawDefinition:o,event:s});if(t.error)return Oi({result:t,stack:c});n=t.policyDefinitions}const d=v(u);if(u&&!d)return Oi({result:{error:xn},context:{participantsCount:u},stack:c});if(i&&!d)return Oi({result:{error:qe},stack:c});if(isNaN(r)){if(!u)return Oi({result:{error:pt},stack:c});({drawSize:r}=Bw({participantsCount:u}))}if((i&&u||r)>r)return{error:Ke};const p=n[so];if(!p)return{error:oe};const l=p.seedsCountThresholds;if(!l)return{error:It};void 0!==p.drawSizeProgression&&(e=p.drawSizeProgression);return{seedsCount:l.filter((t=>e?t.drawSize<=r:r===t.drawSize)).reduce(((t,e)=>u>=e.minimumParticipantCount?e.seedsCount:t),0)}}function jw({requireParticipantCount:t=!0,enforcePolicyLimits:e=!0,drawSizeProgression:n,participantsCount:r,participantCount:i,appliedPolicies:a,drawDefinition:o,seedingProfile:s,structureId:c,seedsCount:u}){r=r??i;const d=zd({drawDefinition:o,structureId:c});if(d.error)return d;const p=d.structure;if(!p)return{error:Dt};const{positionAssignments:l}=bp({structure:p}),m=l?.length||0;if(u>m)return{error:ht};const f=p.structures?.length,h=v(s?.groupSeedingThreshold)&&s.groupSeedingThreshold,I=wg({roundRobinGroupsCount:f,drawSize:m})?.seedGroups,{seedsCount:g}=Vw({policyDefinitions:a,requireParticipantCount:t,drawSizeProgression:n,participantsCount:r,drawSize:m});return g&&a?.[so]&&u>g&&e&&(u=g),p.seedLimit=u,p.seedAssignments=E(1,u+1).map((t=>{const e=I?.find((e=>e.includes(t))),n=e&&Math.min(...e);return{participantId:void 0,seedNumber:t,seedValue:h&&t>=h?n:t}})),il({drawDefinition:o,structureIds:[c]}),{...L,seedLimit:u}}function Gw({participantPreferences:t,drawPositionResolutions:e={}}){const n=Object.keys(t).reduce(((e,n)=>{const r=t[n].preferences[0];return r&&(e[r]||(e[r]=[]),e[r].push(n)),e}),{}),r=Math.min(...Object.values(n).filter((t=>t.length)).map((t=>t.length))),i=Object.keys(n).filter((t=>n[t].length&&r&&n[t].length===r));let a;return i.forEach((r=>{const i=M(n[r]);e[r]=i,delete t[i]})),Object.values(t).forEach((t=>{t.preferences=t.preferences.filter((t=>{const e=!i.includes(t.toString());return e&&(a=!0),e}))})),{drawPositionResolutions:e,remainingPreferences:a,participantPreferences:t}}function qw({drawPositions:t,structure:e}){if([zu,Hu].includes(e.stage)&&1===e.stageSequence)return;const{positionAssignments:n}=Rp({structure:e}),r=n?.filter((({drawPosition:e})=>t?.includes(e)));r?.forEach((t=>{Bs({element:t,extension:{name:yo,value:!0}})}))}function $w(t){const{participantIdAttributeName:e="participantId",isQualifierPosition:n,positionActionName:r,tournamentRecord:i,drawDefinition:a,participantId:o,drawPosition:s,structureId:c,event:u}=t,d="positionParticipantAction";if(!a)return{error:Y};let{inContextDrawMatchUps:p,matchUpsMap:l}=t;l||(l=wp({drawDefinition:a}),Object.assign(t,{matchUpsMap:l})),p||(({matchUps:p}=Pl({inContext:!0,drawDefinition:a,matchUpsMap:l})),Object.assign(t,{inContextDrawMatchUps:p}));const{positionAssignments:m}=Rp({drawDefinition:a,structureId:c}),f=m?.find((t=>t.drawPosition===s));if(f?.participantId){const t=f.participantId,e=Fg({inContextDrawMatchUps:p,tournamentRecord:i,drawDefinition:a,participantId:o,drawPosition:s,structureId:c,matchUpsMap:l,event:u});return e.success?U({removedParticipantId:t}):Oi({result:e,stack:d})}const h=VI({inContextDrawMatchUps:p,tournamentRecord:i,drawDefinition:a,drawPosition:s,structureId:c,matchUpsMap:l,event:u});if(h.error)return Oi({result:h,stack:d});const I=h.participantId,g=Fg({inContextDrawMatchUps:p,isQualifierPosition:n,tournamentRecord:i,drawDefinition:a,participantId:o,drawPosition:s,structureId:c,matchUpsMap:l,event:u});return g.success?U({removedParticipantId:I}):Oi({result:g,stack:d});function U({removedParticipantId:t}){const{structure:n}=zd({drawDefinition:a,structureId:c});qw({drawPositions:[s],structure:n});return zI({drawDefinition:a,positionAction:{[e]:o,name:r,drawPosition:s,structureId:c}}),Oi({context:{removedParticipantId:t},result:{...L},stack:d})}}function Ww({alternateParticipantId:t,tournamentRecord:e,drawDefinition:n,drawPosition:r,structureId:i}){return $w({positionActionName:"alternateDrawPositionAssignment",participantIdAttributeName:"alternateParticipantid",participantId:t,tournamentRecord:e,drawDefinition:n,drawPosition:r,structureId:i})}function Hw({structurePositionAssignments:t,provisionalPositioning:e,tournamentRecord:n,drawDefinition:r,event:i}){if(!r)return{error:Y};if(!Array.isArray(t))return{error:xn};for(const o of t){const{structureId:t,positionAssignments:a}=o;if(!a)continue;const s=zd({drawDefinition:r,structureId:t});if(s.error)return s;const c=s.structure;if(!c)return{error:Dt};const u=Rp({structure:c}).positionAssignments?.map((({drawPosition:t})=>t)),d=a?.map((({drawPosition:t})=>t));if(O(u,d).length!==u?.length)return Oi({result:{error:xn},info:"drawPositions do not match",stack:"setPositionAssignments"});const p=wp({drawDefinition:r}),{matchUps:l}=Pl({inContext:!0,drawDefinition:r,matchUpsMap:p});for(const o of a||[]){const{drawPosition:s,participantId:u,bye:d,qualifier:m}=o;if(d){const e=YI({tournamentRecord:n,drawDefinition:r,drawPosition:s,matchUpsMap:p,structureId:t,structure:c,event:i});if(e?.error)return e}else if(m)a.forEach((t=>{t.drawPosition===s&&(t.qualifier=!0,delete t.participantId,delete t.bye)}));else if(u){const a=Fg({provisionalPositioning:e,inContextDrawMatchUps:l,tournamentRecord:n,drawDefinition:r,participantId:u,drawPosition:s,matchUpsMap:p,structureId:t,event:i});if(a?.error)return a}}ol({tournamentId:n?.tournamentId,drawDefinition:r,structure:c,event:i})}const a=t.map((({structureId:t})=>t));return il({tournamentId:n?.tournamentId,eventId:i?.eventId,drawDefinition:r,structureIds:a}),{...L}}function zw(t){const e=(t?.entries??[]).filter(Boolean).reduce(((t,e)=>{const{entryStage:n,entryStatus:r}=e,i=`_${n||Hu}${r||""}`;return t[i]||(t[i]=[]),t[i].push(e),t}),{}),n=t=>isNaN(t)?1/0:t;return Object.keys(e).map((t=>e[t].sort(((t,e)=>n(t.entryPosition)-n(e.entryPosition))).map(((t,e)=>({...t,entryPosition:e+1}))))).flat()}function Yw(t){return[op,ap].includes(t)}function Kw({autoEntryPositions:t=!0,ignoreAssignment:e,tournamentRecord:n,drawDefinition:r,participantIds:i,entryStatus:a,entryStage:o,extension:s,eventSync:c,drawId:u,stage:d,event:p}){if(!i||!Array.isArray(i))return{error:Ee,method:"modifyEntriesStatus",participantIds:i};if(!r&&!p)return{error:At};if(a&&!mp.includes(a))return{error:Je};if(o&&!Qu.includes(o))return{error:_t};const l="modifyEntriesStatus",m=[];if(!a&&!s)return Oi({result:{error:me},info:"Missing entryStatus",stack:l});if(s&&!xs({extension:s,requiredAttributes:["name"]}))return Oi({result:{error:xn},info:"Invalid extension",context:{extension:s},stack:l});const f=[];p?.drawDefinitions?.forEach((t=>{const e=Uh({stages:d&&[d],drawDefinition:t}).assignedParticipantIds??[];f.push(...e)}));const h=n?.participants||[];if(!i.every((t=>{const e=fs({tournamentParticipants:h,participantId:t})?.participantType;return!(e&&[qi.Pair,qi.Team].includes(e)&&Yw(a)||a&&p?.eventType&&e===Eu&&[Tu,Nu].includes(p.eventType)&&[Kd,...up].includes(a))})))return{error:Je};const I=p&&_s({event:p}).flightProfile,g=I?.flights?.find((t=>t.drawId===u)),U=t=>{const n=(t||[]).filter((t=>!d||!t.entryStage||d===t.entryStage)).filter((({participantId:t})=>i.includes(t)));return n.every((t=>!((t=>a&&f.includes(t.participantId)&&!(up.includes(t.entryStatus)&&up.includes(a)))(t)&&!e)&&(a&&(t.entryStatus=a,delete t.entryPosition),o&&(t.entryStage=o,delete t.entryPosition),s&&(s.value?Bs({element:t,extension:s}):Gs({element:t,name:s.name})),!0)))?{...L}:{error:ze}},y=({flight:t,drawDefinition:e})=>{p&&(p.entries=zw({entries:p.entries||[]})),t&&(t.drawEntries=zw({entries:t.drawEntries})),e&&(e.entries=zw({entries:e.entries}))},S=t=>{const{flight:e,drawDefinition:n}=t,r="updateDrawEntries";if(e){const t=U(e.drawEntries);if(t.error)return Oi({result:t,stack:r})}if(n){const t=U(n.entries);if(t.error)return Oi({result:t,stack:r});m.includes(n.drawId)||m.push(n.drawId)}return{...L}},v=p?.entries?.find((({entryPosition:t})=>t))||g?.drawEntries?.find((({entryPosition:t})=>t))||r?.entries?.find((({entryPosition:t})=>t));if(t&&!v&&y({flight:g,drawDefinition:r}),g||r){const t=S({flight:g,drawDefinition:r});if(t.error)return Oi({result:t,stack:l})}const w=p?.drawDefinitions?.map((({drawId:t})=>t))||[],T=I?.flights?.filter((t=>!w.includes(t.drawId)))||[];for(const D of T){const t=D&&S({flight:D});if(t?.error)return Oi({result:t,stack:l})}const P=1===I?.flights?.length&&(p?.drawDefinitions?.length||0)<=I?.flights?.length;if(!g&&!r&&a&&dp.includes(a))return{error:en};if(!g&&!r||a===cp||c&&P){const t=U(p?.entries);if(t?.error)return Oi({result:t,stack:l});let e;if(a===cp&&(I?.flights?.every((t=>{const n=U(t.drawEntries);return n.error?(e=n.error,!1):(t.drawEntries=t.drawEntries.filter((({participantId:t})=>!i.includes(t))),!0)})),p?.drawDefinitions?.every((t=>{const n=U(t.entries);return n.error?(e=n.error,!1):(t.entries=t.entries?.filter((({participantId:t})=>!i.includes(t))),!0)}))),e)return Oi({result:{error:e},stack:l})}t&&y({flight:g,drawDefinition:r});for(const D of p?.drawDefinitions||[])m.length&&!m.includes(D.drawId)||il({tournamentId:n.tournamentId,eventId:p?.eventId,drawDefinition:D});return{...L}}function Jw({stage:t,drawDefinition:e}){return Boolean(t===Ku||Ip({stage:t,drawDefinition:e})&&Yv({stage:t,drawDefinition:e}))}function Qw({entryStatus:t=Qd,drawDefinition:e,stageSequence:n,stage:r}){if(t===Kd)return function({stage:t,drawDefinition:e}){const{entryProfile:n}=Wu({drawDefinition:e});return n[t]?.alternates||0}({stage:r,drawDefinition:e})?{positionsAvailable:1/0,...L}:{error:tn};const i=function(t){const{provisionalPositioning:e,drawDefinition:n,stageSequence:r,stage:i}=t,a=Yv({stage:i,drawDefinition:n}),{qualifiersCount:o}=zv({provisionalPositioning:e,drawDefinition:n,stageSequence:r,stage:i});return a&&a-o}({drawDefinition:e,stageSequence:n,stage:r}),a=function({stage:t,drawDefinition:e}){const{entryProfile:n}=Wu({drawDefinition:e});return n[t]?.wildcardsCount||0}({drawDefinition:e,stage:r}),o=gp({entryStatus:sp,drawDefinition:e,stage:r}),s=o+gp({entryStatus:Qd,drawDefinition:e,stage:r}),c=i-s;return r!==Ku&&s>=i?{error:nn}:t===sp?o<a?{...L}:{error:nn}:{positionsAvailable:c,...L}}function Xw(t){const{entryStatus:e=xi.DirectAcceptance,entryStageSequence:n,entryStage:r=Hu,ignoreStageSpace:i,drawDefinition:a,entryPosition:o,participant:s,roundTarget:c,extensions:u,extension:d,drawType:p}=t,l="addDrawEntry";if(!a)return{error:Y};if(!r)return{error:xt};if(p!==hd&&!Jw({stage:r,drawDefinition:a}))return Oi({result:{error:_t},stack:l});const m=Qw({stageSequence:n,stage:r,drawDefinition:a,entryStatus:e});if(!i&&!m.success)return{error:m.error};if(d&&!xs({extension:d}))return Oi({result:{error:xn},info:"Invalid extension",context:{extension:d},stack:l});const f=t.participantId||s?.participantId;if(!f)return Oi({result:{error:Le},stack:l});const h=e===xi.LuckyLoser&&bg({participantId:f,drawDefinition:a,entryStatus:e}),I=r===Ku&&bg({participantId:f,drawDefinition:a,entryStage:r}),g=e!==xi.LuckyLoser&&r!==Ku&&bg({drawDefinition:a,participantId:f});if(g||h||I)return Oi({context:{invalidEntry:g,invalidLuckyLoser:h,invalidVoluntaryConsolation:I},result:{error:Ye},stack:l});const U=di({entryStageSequence:n,participantId:f,entryPosition:o,entryStatus:e,entryStage:r,extensions:u});return d&&Bs({element:U,extension:d}),c&&Bs({extension:{name:"roundEntry",value:c},element:U}),a.entries||(a.entries=[]),a.entries.push(U),il({drawDefinition:a}),{...L}}function Zw(t){const{entryStatus:e=xi.DirectAcceptance,stage:n=ki.Main,autoEntryPositions:r=!0,ignoreStageSpace:i,drawDefinition:a,participantIds:o,stageSequence:s,roundTarget:c,extension:u}=t;if(!n)return{error:xt};if(!a)return{error:Y};if(!Array.isArray(o))return{error:Ce};if(!Jw({stage:n,drawDefinition:a}))return{error:_t};if(u&&!xs({extension:u}))return Oi({result:{error:xn},info:"Invalid extension",context:{extension:u},stack:"addDrawEntries"});const d=Qw({drawDefinition:a,stageSequence:s,entryStatus:e,stage:n});if(!i&&!d.success)return{error:d.error};const p=d.positionsAvailable??0;if(!i&&n!==Ku&&p<o.length)return{error:Ke};const l=o.reduce(((t,r)=>{const i=e===xi.LuckyLoser&&bg({participantId:r,drawDefinition:a,entryStatus:e}),o=n===Ku&&bg({entryStage:n,drawDefinition:a,participantId:r});return e!==xi.LuckyLoser&&n!==Ku&&bg({drawDefinition:a,participantId:r})||i||o?t.concat(r):t}),[]);return o.filter((t=>t&&!l.includes(t))).forEach((t=>{const r={entryStageSequence:s,entryStage:n,participantId:t,entryStatus:e};u&&Bs({element:r,extension:u}),c&&Bs({extension:{name:Eo,value:c},element:r}),a.entries||(a.entries=[]),a.entries.push(r)})),r&&(a.entries=zw({entries:a.entries})),il({drawDefinition:a}),l?.length?{info:"some participantIds could not be added",participantIdsNotAdded:l,...L}:{...L}}function tT({autoEntryPositions:t=!0,entryStageSequence:e,ignoreStageSpace:n,drawDefinition:r,participantIds:i,entryStatus:a,roundTarget:o,entryStage:s,extension:c,drawId:u,event:d}){if(!i?.length)return{error:Ge};if(!d)return{error:Et};if(!u)return{error:lt};const p=(d.entries||[]).map(ml);if(i.filter((t=>!p.includes(t))).length)return{error:Ot};if(r){const u=Zw({stageSequence:e,autoEntryPositions:t,stage:s,ignoreStageSpace:n,drawDefinition:r,participantIds:i,entryStatus:a,roundTarget:o,extension:c});if(u.error)return u}const{flightProfile:l}=_s({event:d}),m=l?.flights.find((t=>t.drawId===u));return m?.drawEntries&&(i.forEach((t=>{const e=a===tp&&eT({participantId:t,entryStatus:a,flight:m}),n=s===Ku&&eT({participantId:t,entryStage:s,flight:m});a!==tp&&s!==Ku&&eT({flight:m,participantId:t})||e||n||m.drawEntries.push({participantId:t,entryStatus:a,entryStage:s})})),t&&(m.drawEntries=zw({entries:m.drawEntries}))),{...L}}function eT({participantId:t,entryStatus:e,entryStage:n,flight:r}){const i=r.drawEntries?.find((r=>!(r.participantId!==t||e&&e!==r.entryStatus||n&&n!==r.entryStage)));return t&&i}function nT({autoEntryPositions:t=!0,participantIds:e=[],entryStatuses:n,stage:r,event:i}){const a="removeEventEntries";if(!i?.eventId)return{error:At};if(!Array.isArray(e)||e.some((t=>!oi(t))))return Oi({result:{error:Ee},stack:a});const o=(i.drawDefinitions??[]).flatMap((t=>Uh({drawDefinition:t}).assignedParticipantIds??[])),s=(n?.length&&i.entries?.filter((t=>t.entryStatus&&n.includes(t.entryStatus)))||[]).map(ui("participantId")).filter((t=>!o.includes(t))),c=(r&&i.entries?.filter((t=>t.entryStage&&t.entryStage===r))||[]).map(ui("participantId")).filter((t=>!o.includes(t)));if(e.length?e=e.filter((t=>(!n?.length||s.includes(t))&&(!r||c.includes(t)))):s.length&&c.length?e=O(s,c):s.length?e=s:c.length&&(e=c),e?.length&&o.some((t=>e.includes(t))))return Oi({result:{error:ze},stack:a});if(!e?.length)return{...L,participantIdsRemoved:[]};const u=[];i.entries=(i.entries||[]).filter((t=>{const n=!e.includes(t?.participantId);return n||u.push(t.participantId),n})),t&&(i.entries=zw({entries:i.entries}));const{flightProfile:d}=_s({event:i});return d?.flights?.forEach((t=>{t.drawEntries=(t.drawEntries||[]).filter((t=>!e.includes(t.participantId)))})),i.drawDefinitions?.forEach((t=>{t.entries=(t.entries||[]).filter((t=>!e.includes(t.participantId)))})),{...L,participantIdsRemoved:u}}function rT(t){const{entryStatus:e=Qd,autoEntryPositions:n=!0,participantIds:r=[],entryStageSequence:i,ignoreEventGender:a,entryStage:o=Hu,tournamentRecord:s,ignoreStageSpace:c,drawDefinition:u,roundTarget:d,extensions:p,extension:l,drawId:m,event:f}=t,h="addEventEntries";if(!f)return{error:At};if(!r?.length)return Oi({result:{error:Ge},stack:h});if(!f?.eventId)return{error:Et};const I=[],g=[];if(p&&(!Array.isArray(p)||!p.every(xs))||l&&!xs({extension:l}))return Oi({context:di({extension:l,extensions:p}),result:{error:xn},info:"Invalid extension(s)",stack:h});const U=!!s,y=[];let S;const v=s?.participants?.filter((t=>{if(!r.includes(t.participantId))return!1;const n=f.eventType===ba&&t.participantType===Eu&&!Yw(e),i=f.eventType===Aa&&t.participantType===Ou;return!(!n||f.gender&&!a&&![Bp,_p].includes(f.gender)&&f.gender!==t.person?.sex)||(!(!i||Yw(e))||(!(f.eventType!==Aa||t.participantType!==Eu||!Yw(e))||(n&&f.gender&&!a&&![Bp,_p].includes(f.gender)&&f.gender!==t.person?.sex?(y.push({participantId:t.participantId,sex:t.person?.sex}),!1):f.eventType===Fu&&(t.participantType===Fu||Yw(e)&&t.participantType===Eu))))})).map((t=>t.participantId))||[],w=r.filter((t=>!U||v.includes(t)));f.entries||(f.entries=[]);const T=f.entries.map((t=>t.participantId||t.participant?.participantId));if(w.forEach((t=>{if(!T.includes(t)){const n=di({participantId:t,entryStatus:e,entryStage:o,extensions:p});l&&Bs({element:n,extension:l}),d&&Bs({extension:{name:Eo,value:d},element:n}),i&&(n.entryStageSequence=i),I.push(n.participantId),f.entries.push(n)}})),m&&!Yw(o)){const t=tT({participantIds:w,autoEntryPositions:n,entryStageSequence:i,ignoreStageSpace:c,drawDefinition:u,entryStatus:e,roundTarget:d,entryStage:o,extension:l,drawId:m,event:f});t.error&&(S=t.error)}if([Aa,Fu].includes(f.eventType)){const t=(f.entries||[]).map((t=>t.participantId)),e=(f.entries||[]).filter((t=>Yw(t.entryStatus))).map((t=>t.participantId)),n=(s?.participants||[]).filter((e=>t.includes(e.participantId)&&[Ou,Fu].includes(e.participantType))).map((t=>t.individualParticipantIds)).flat(1/0),r=e.filter((t=>n.includes(t)));r.length&&(g.push(...r),nT({participantIds:r,autoEntryPositions:!1,event:f}))}if(w.length!==r.length)return Oi({context:{misMatchedGender:y,gender:f.gender},result:{error:Ce},stack:h});n&&(f.entries=zw({entries:f.entries||[]}));const P=I.length-g.length;return Oi({result:{...L,addedEntriesCount:P},stack:h,info:S})}function iT({addIndividualParticipantsToEvents:t,individualParticipantIds:e,groupingParticipantId:n,tournamentRecord:r,suppressErrors:i}){const a="removeIndividualParticipantIds";if(!r)return Oi({result:{error:$},stack:a});if(!n||!e)return Oi({result:{error:me},stack:a});const o=(r.participants||[]).find((t=>t.participantId===n));if(!o)return Oi({result:{error:Be},stack:a});if(![Fu,Cu].includes(o.participantType))return Oi({result:{participantType:o.participantType,error:Fe},stack:a});const s=aT({individualParticipantIds:e,groupingParticipant:o,tournamentRecord:r,suppressErrors:i}),{removed:c,error:u}=s;if(u)return Oi({result:s,stack:a});if(t)for(const d of r.events||[]){const t=(d.entries||[]).map((({participantId:t})=>t)).filter(Boolean);if(t.includes(n)){const e=c?.filter((e=>!t.includes(e)));rT({participantIds:e,entryStatus:ap,tournamentRecord:r,event:d})}}return c&&dr({topic:Ic,payload:{tournamentId:r.tournamentId,participants:[o]}}),{...L,...s}}function aT({individualParticipantIds:t=[],groupingParticipant:e,tournamentRecord:n,suppressErrors:r,mappedMatchUps:i,participants:a}){const o=[];if(!e)return{removed:o};const s=[],c=[];a||({participants:a,mappedMatchUps:i}=sU({withMatchUps:!0,tournamentRecord:n,withEvents:!0}));const u=a?.find((({participantId:t})=>t===e.participantId)),d=u?.events?.map((({eventId:t})=>t)),p=(e.individualParticipantIds||[]).filter((r=>{const u=t?.includes(r),p=u&&a?.find((t=>t.participantId===r))?.matchUps.filter((({eventId:t})=>d.includes(t))).map((({matchUpId:t})=>i?.[t])).filter((({winningSide:t,score:e})=>t||Yp({score:e}))),l=u&&!p?.length;if(u&&!l&&c.push(r),l){o.push(r);for(const t of n.events||[])for(const i of t.drawDefinitions||[]){const{extension:t}=gs({element:i,name:Do});let a=t?.value[e.participantId];t&&a&&(a=a.filter((t=>t.participantId!==r)),Bs({element:i,extension:t}),rl({drawDefinition:i}));const o=eh({drawDefinition:i,inContext:!1}).matchUps||[];for(const e of o){const t=e.sides||[];for(const a of t){const t=a.lineUp||[];t.find((t=>t.participantId===r))&&(a.lineUp=t.filter((t=>t.participantId!==r)),nl({tournamentId:n?.tournamentId,drawDefinition:i,matchUp:e}))}}}}else s.push(r);return!l}));e.individualParticipantIds=p;const l={groupingParticipantId:e.participantId,cannotRemove:c,notRemoved:s,removed:o};return c.length&&!r&&{...l,cannotRemove:c,error:be}||l}function oT({participantRole:t=Gi.Competitor,individualParticipantIds:e=[],groupingTypes:n=[qi.Team,qi.Group],tournamentRecord:r}){if(!r)return{error:$};const i=r.participants||[],{participants:a,mappedMatchUps:o}=sU({withMatchUps:!0,tournamentRecord:r,withEvents:!0});let s=0;return i.filter((e=>(e.participantRole===t||!e.participantRole)&&e.participantType&&n.includes(e.participantType))).forEach((t=>{const{removed:n}=aT({groupingParticipant:t,individualParticipantIds:e,tournamentRecord:r,mappedMatchUps:o,participants:a});n&&s++})),s?L:{error:je}}function sT(t){if(!t?.tournamentRecord)return{error:$};if(!t?.participantIds?.length)return{error:Ge};const{addIndividualParticipantsToEvents:e,tournamentRecord:n,participantIds:r}=t,i=n.participants?.length||0;if(!i)return{...L};const a=(n.events||[])?.filter((({eventType:t})=>t===Du)).map((t=>t?.drawDefinitions?.map((({drawId:t})=>t)))).flat(1/0),o=sU({participantFilters:{participantIds:r},tournamentRecord:n,withDraws:!0}).participants??[],s=a?.length&&O((th({matchUpFilters:{drawIds:a,matchUpTypes:[Aa]},tournamentRecord:n}).matchUps||[]).map((({sides:t})=>t?.map((({participantId:t})=>t)))).flat().filter(Boolean),r),c=o.filter((t=>t.draws?.filter((t=>(!a?.length||!a?.includes(t.drawId))&&t.positionAssignments)).length));if(s?.length||c.length)return{error:ze};const u={},d={};for(const l of n.events||[]){const t=nT({participantIds:r,event:l});if(t.error)return t;u[l.eventId]=t.participantIdsRemoved}n.participants=n.participants.filter((t=>{const n=r.includes(t.participantId)||t.participantType===Ou&&t.individualParticipantIds.some((t=>r.includes(t)));if(!n&&t.participantType===Du&&t.individualParticipantIds.some((t=>r.includes(t)))&&(t.individualParticipantIds=t.individualParticipantIds.filter((t=>!r.includes(t)))),n&&e&&[Ou,Fu].includes(t.participantType))for(const e of t.individualParticipantIds||[])r.includes(e)||(d[t.participantId]||(d[t.participantId]=[]),d[t.participantId].push(e));return!n}));const p=i-n.participants.length;if(oT({individualParticipantIds:r,tournamentRecord:n}),e)for(const l of n.events||[]){rT({participantIds:u[l.eventId].map((t=>d[t]||[])).flat(),entryStatus:ap,tournamentRecord:n,event:l})}return p&&dr({payload:{participantIds:r,tournamentId:n.tournamentId},topic:cc}),p?{...L,participantsRemovedCount:p}:{error:be}}function cT({selected:t=!0,drawDefinition:e,entryStatuses:n,drawId:r,event:i,stage:a}){let o=i.entries??[];if(r){const{flightProfile:t}=_s({event:i}),n=t?.flights?.find((t=>t.drawId===r));n?o=n.drawEntries:e.entries&&(o=e?.entries)}const s=o.filter((e=>(!n?.length||!e.entryStatus||n.includes(e.entryStatus))&&(!a||!e.entryStage||e.entryStage===a)&&(!t||e.entryStatus&&lp.includes(e.entryStatus))));return{entries:o,stageEntries:s}}function uT({removeGroupParticipant:t,tournamentRecord:e,drawDefinition:n,participantId:r,drawId:i,stage:a,event:o}){const s="destroyGroupEntry";if(!e)return{error:$};if(!r)return Oi({result:{error:Le},stack:s});if(!o)return{error:At};if(!o.eventType||![Bi.Doubles,Bi.Team].includes(o.eventType))return Oi({result:{error:Mt},stack:s});const c=e.participants||[],u=c.find((t=>t.participantId===r));if(!u)return Oi({result:{error:Be},stack:s});if(!u.participantType||![qi.Pair,qi.Team].includes(u.participantType)||u.participantType===Du&&o.eventType!==Du||u.participantType===Ou&&o.eventType!==Tu)return{error:Fe};const d=(o.entries||[]).find((t=>t.participantId===r));if(!d)return{error:Qe};const{stageEntries:p}=cT({selected:!1,drawDefinition:n,drawId:i,event:o,stage:a}),l=p.map(ml),m=c.filter((({participantId:t})=>l.includes(t))).map((({individualParticipantIds:t})=>t)).flat().filter(Boolean),f=u.individualParticipantIds?.filter((t=>1===C(t,m).length));let h,I=nT({participantIds:[r],event:o});if(I.error)return I;if(f?.length&&(I=rT({participantIds:f,entryStatus:ap,entryStage:d.entryStage,tournamentRecord:e,drawDefinition:n,drawId:i,event:o}),I.error))return I;if(t){sT({participantIds:[r],tournamentRecord:e}).success&&(h=!0)}return{...L,participantRemoved:h}}function dT({removeGroupParticipant:t,tournamentRecord:e,drawDefinition:n,participantId:r,drawId:i,event:a}){return uT({removeGroupParticipant:t,tournamentRecord:e,drawDefinition:n,participantId:r,drawId:i,event:a})}function pT(t){const{tournamentRecord:e,replaceWithBye:n,drawDefinition:r,destroyPair:i,entryStatus:a,matchUpsMap:o,drawId:s}=t,c="removeDrawPositionAssignment",u=VI(t);if(u.error)return Oi({result:u,stack:c});const{participantId:d}=u,{drawPosition:p,event:l,structureId:m}=t;if([Kd,cp].includes(a)&&d){const{tournamentRecord:e}=t,{participant:n}=hs({tournamentRecord:e,participantId:d}),{participantType:o,individualParticipantIds:u}=n||{};if(i&&o===Ou){const t=dT({tournamentRecord:e,drawDefinition:r,participantId:d,event:l});if(t.error)return Oi({result:t,stack:c});u&&Kw({participantIds:u,tournamentRecord:e,drawDefinition:r,entryStatus:a,drawId:s,event:l})}else Kw({participantIds:[d],tournamentRecord:e,drawDefinition:r,entryStatus:a,drawId:s,event:l})}if(n){const t=YI({tournamentRecord:e,drawDefinition:r,drawPosition:p,structureId:m,matchUpsMap:o,event:l});if(t.error)return Oi({result:t,stack:c})}const{structure:f}=zd({drawDefinition:r,structureId:m});qw({structure:f,drawPositions:[p]});return zI({drawDefinition:r,positionAction:{name:"removeDrawPositionAssignment",replaceWithBye:n,drawPosition:p,entryStatus:a,structureId:m}}),u}function lT({tournamentRecord:t,drawDefinition:e,drawPositions:n,structureId:r,event:i}){if(!e)return{error:Y};if(!r)return{error:Pt};if(2!==n?.length)return{error:xn,drawPositions:n};const a=wp({drawDefinition:e}),{matchUps:o}=Pl({inContext:!0,drawDefinition:e,matchUpsMap:a}),{structure:s}=zd({drawDefinition:e,structureId:r});if(!s)return{error:Dt};let c;if(c=s.structureType===od?function({inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,drawPositions:r,matchUpsMap:i,structure:a,event:o}){const s=a.structures?.reduce(((t,e)=>{const n=e?.positionAssignments.filter((t=>r?.includes(t.drawPosition)));return n&&t.push(...n),t}),[]);if(2===s.filter((({bye:t})=>t)).length)return{...L};if(2===s.filter((({qualifier:t})=>t)).length)return{...L};Og({inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,matchUpsMap:i,assignments:s,structure:a,event:o});const c=s.some((({qualifier:t})=>t));if(s.some((({bye:t})=>t))&&!c)mT({inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,assignments:s,matchUpsMap:i,structure:a,event:o});else{const t=ri(s,!1,!0);s.forEach(((e,n)=>{const r=t[1-n].participantId;e.qualifier=t[1-n].qualifier,e.participantId=r}))}return{...L}}({inContextDrawMatchUps:o,tournamentRecord:t,drawDefinition:e,drawPositions:n,matchUpsMap:a,structure:s,event:i}):function({inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,drawPositions:r,matchUpsMap:i,structure:a,event:o}){const s=a?.positionAssignments.filter((t=>r?.includes(t.drawPosition)));if(!s)return{error:xn,structure:a,info:"Missing positionAssignments"};if(2===s.filter((({bye:t})=>t)).length)return{...L};if(2===s.filter((({qualifier:t})=>t)).length)return{...L};const c=s.some((({qualifier:t})=>t));return s.some((({bye:t})=>t))&&!c?mT({inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,assignments:s,matchUpsMap:i,structure:a,event:o}):function({inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,assignments:r,matchUpsMap:i,structure:a,event:o}){const s=Object.assign({},...r.map(((t,e)=>{const{drawPosition:n}=t;return{[n]:{...r[1-e],drawPosition:n}}})));return a.positionAssignments=a.positionAssignments.map((t=>s[t.drawPosition]||t)),Og({inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,matchUpsMap:i,assignments:r,structure:a,event:o}),{...L}}({inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,assignments:s,matchUpsMap:i,structure:a,event:o})}({inContextDrawMatchUps:o,tournamentRecord:t,drawDefinition:e,drawPositions:n,matchUpsMap:a,structure:s,event:i}),c.error)return c;qw({structure:s,drawPositions:n});if(zI({drawDefinition:e,positionAction:{name:"swapDrawPositionAssignments",drawPositions:n,structureId:r}}),ol({tournamentId:t?.tournamentId,drawDefinition:e,structure:s,event:i}),i.eventType===Nu){const r=qp({matchUpFilters:{matchUpTypes:[Ea]},inContext:!0,structure:s}).matchUps.filter((t=>t.drawPositions?.some((t=>n.includes(t))))),a=qp({structure:s,matchUpFilters:{matchUpTypes:[Ea]}}).matchUps;r.forEach((r=>{(r.sides||[]).forEach((o=>{const s=o?.drawPosition;if(n.includes(s)){const n=o.participantId,c=a.find((({matchUpId:t})=>t===r.matchUpId)),u=r?.sides?.reduce(((t,e,n)=>e.drawPosition===s?n:t),void 0);ZI({inContextTargetMatchUp:r,drawPositionSideIndex:u,teamParticipantId:n,tournamentRecord:t,drawDefinition:e,matchUp:c,event:i})}}))}))}return il({drawDefinition:e,structureIds:[r]}),{...L}}function mT({inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,assignments:r,matchUpsMap:i,structure:a,event:o}){const s=r.find((({bye:t})=>t)),c=r.find((({participantId:t})=>t)),u=s.drawPosition,{participantId:d,drawPosition:p}=c,{structureId:l}=a;let m=pT({drawPosition:u,inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,structureId:l,matchUpsMap:i});return m.error?m:(m=pT({drawPosition:p,inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,structureId:l,matchUpsMap:i}),m.error?m:(YI({drawPosition:p,tournamentRecord:e,drawDefinition:n,structureId:l,matchUpsMap:i,event:o}),m=Fg({drawPosition:u,inContextDrawMatchUps:t,tournamentRecord:e,drawDefinition:n,structureId:l,participantId:d,matchUpsMap:i,event:o}),m.error?m:{...L}))}function fT({inheritance:t=!0,tournamentRecord:e,drawDefinition:n,matchUpId:r,event:i}){if(!n)return{error:Y};const a=$p({drawDefinition:n,matchUpId:r})?.matchUp;if(!a?.tieMatchUps)return{error:ee};const o=$p({inContext:!0,drawDefinition:n,matchUpId:r,event:i})?.matchUp;let s=0;return(a?.sides||[]).forEach((t=>{t.lineUp&&delete t.lineUp})),(o?.sides||[]).forEach((r=>{if(s+=1,!1===t){const t=o?.tieFormat,e=r.participantId;t&&e&&Cg({drawDefinition:n,participantId:e,lineUp:[],tieFormat:t})}nl({tournamentId:e?.tournamentId,context:"resetMatchUpLineUps",eventId:i?.eventId,drawDefinition:n,matchUp:a})})),{...L,modificationsCount:s}}function hT({tournamentRecord:t,drawDefinition:e,drawPosition:n,structureId:r,subOrder:i,event:a}){if(!e)return{error:Y};if(!r)return{error:Pt};if(!n)return{error:st};const{structure:o}=zd({drawDefinition:e,structureId:r});if(!o)return{error:Dt};let s=o;o.structures&&o.structureType===od&&(s=o.structures?.find((t=>t.positionAssignments?.find((t=>t.drawPosition===n)))));const c=s?.positionAssignments,u=c?.find((t=>t.drawPosition===n));u&&Bs({element:u,extension:{name:ko,value:i}});const d=(a?.eventType===Ca||e.matchUpType===Ca||a?.tieFormat||e?.tieFormat||o?.tieFormat)&&{matchUpTypes:[Ca]},{matchUps:p}=qp({structure:s,afterRecoveryTimes:!1,inContext:!0,matchUpFilters:d,event:a});return cl({positionAssignments:c,tournamentRecord:t,drawDefinition:e,matchUpFormat:o?.matchUpFormat||e.matchUpFormat,matchUps:p,event:a}),il({drawDefinition:e,structureIds:[r]}),{...L}}const IT={setSubOrder:hT,clearDrawPosition:VI,assignDrawPosition:Fg,setPositionAssignments:Hw,automatedPositioning:Sw,assignDrawPositionBye:YI,swapDrawPositionAssignments:lT,alternateDrawPositionAssignment:Ww,resolveDrawPositions:function({positionAssignments:t,participantFactors:e}){if(!e||!t)return{error:me};let n=ri(e,!1,!0);const r=t.map((({drawPosition:t})=>t)),i=t.filter((t=>!t.participantId&&!t.bye&&!t.qualifier)).map(fl);let a,o=!0;for(;o;)({drawPositionResolutions:a,remainingPreferences:o,participantPreferences:n}=Gw({participantPreferences:n,drawPositionResolutions:a}));const s=Object.keys(a).map((t=>m(t)));let c=i.filter((t=>!s.includes(t))),u=Object.keys(n);const d=E(1,(p=2,l=r?.length||0,Math.log(l)/Math.log(p)+1)).map((t=>Math.pow(2,t)));var p,l;const f={};for(const I of d){const t=x(r,I).filter((t=>k(t,c))),n={};u.forEach((r=>{t.forEach((t=>{const i=t.join("|");k(t,e[r].preferences)&&(n[i]||(n[i]=[]),n[i].push(r))}))}));if(P(Object.keys(n)).forEach((t=>{const e=n[t].filter((t=>u.includes(t)));for(;e.length;){const n=M(e),r=t.split("|").map((t=>m(t))).filter((t=>c.includes(m(t))));if(r.length){const e=M(r);c=c.filter((t=>t!==e)),u=u.filter((t=>t!==n)),a[e]=n;const i=t.split("|").length;f[i]||(f[i]=0),f[i]+=1}}})),!c.length)break}const h={chunkResolution:f};return u.length&&(u.forEach((t=>{const e=M(c);e&&(a[e]=t)})),h.randomAssignment=u.length),{drawPositionResolutions:a,report:h}},resetMatchUpLineUps:fT,initializeStructureSeedAssignments:jw,getNextSeedBlock:Ng};function gT({drawDefinition:t,event:e,matchUpId:n}){if(!t)return{error:Y};if(!n)return{error:Jt};const{matchUp:r}=$p({drawDefinition:t,event:e,matchUpId:n});return r?Gs({element:r,name:go}):{error:Xt}}function UT(t){return t.participantIdPairings.map((({participantIds:t})=>t.sort().join("|"))).sort().join("/")}function yT({valueSortedPairings:t,stipulated:e=[],pairingValueMap:n,deltaObjects:r,valueObjects:i,actorsCount:a}){const o=[].concat(...e),s=[];let c=0;e.filter(Boolean).forEach((t=>{const[e,r]=t,i=ST(e,r),a=n[i];s.push({participantIds:t,value:a}),c+=n[i]}));x(t,a).map((t=>P(t).map((t=>({...t,value:t.value+Math.random()*Math.round(Math.random())}))))).flat().forEach((t=>{const e=t.pairing.split("|");if(!e.reduce(((t,e)=>o.includes(e)||t),!1)){o.push(...e);const n=t.value;c+=n,s.push({participantIds:e,value:n})}})),s.sort(((t,e)=>t.value-e.value));const u=s.reduce(((t,e)=>{const[n,i]=e.participantIds,a=ST(n,i),o=r[a];return o>t?o:t}),0),d=s.reduce(((t,e)=>{const[n,r]=e.participantIds,a=ST(n,r),o=i[a];return o>t?o:t}),0);return{value:c,participantIdPairings:s,maxDelta:u,maxDiff:d}}function ST(t,e){return[t,e].sort(mh).join("|")}function vT({participantIds:t}){const e={},n=[];t.forEach((r=>{e[r]=t.filter((t=>t!==r)),e[r].forEach((t=>{const e=ST(t,r);n.includes(e)||n.push(e)}))}));const r=Object.assign({},...n.map((t=>({[t]:0}))));return{uniquePairings:n,possiblePairings:e,deltaObjects:r}}const wT=0;function TT({tournamentParticipants:t,adHocRatings:e={},possiblePairings:n,uniquePairings:r,maxIterations:i,deltaObjects:a,valueObjects:o,eventType:s,scaleName:c,salted:u}){r.forEach((n=>{const r=function({tournamentParticipants:t,adHocRatings:e,eventType:n,scaleName:r,pairing:i}){const a=Bm[r]?.defaultInitialization??wT;return i.split("|").map((r=>{if(n===Tu){const n=t?.find((t=>t.participantId===r))?.individualParticipantIds;return n?n?.map((t=>e[t]||a)):2*a}return e[r]||a}))}({tournamentParticipants:t,adHocRatings:e,scaleName:c,eventType:s,pairing:n}),i="number"==typeof u&&u||.5,d=u&&(Math.round(Math.random())?i:-1*i)||0,p=Math.abs(r[0]-r[1])+d,l=Math.abs(r[0]-r[1]);a[n]=l,o[n]||(o[n]=0),o[n]+=p?Math.pow(p,2):0}));const d=r.map((t=>({pairing:t,value:o[t]}))).sort(((t,e)=>t.value-e.value)),{pairingValues:p}=function({possiblePairings:t,valueObjects:e}){const n={};for(const i of Object.keys(t)){const e=t[i].map((t=>r(i,t)));n[i]=e.sort(((t,e)=>t.value-e.value))}function r(t,n){const r=ST(t,n);return{opponent:n,value:e[r]}}return{pairingValues:n}}({possiblePairings:n,valueObjects:o}),{candidate:l,candidatesCount:m,deltaCandidate:f,iterations:h}=function({maxIterations:t=4e3,valueSortedPairings:e,pairingValues:n,valueObjects:r,deltaObjects:i}){const a=Object.assign({},...e.map((t=>({[t.pairing]:t.value})))),o=Object.keys(n);let s=[];const c=yT({actorsCount:o.length,valueSortedPairings:e,pairingValueMap:a,deltaObjects:i,valueObjects:r}),u=[UT(c)];s.push(c);let d,p=c.value,l=c,m=0,f=0,h=o.length;do{h-=1,d=o.length*n[o[0]].length}while(d>t&&h>5);const I=[];o.forEach((t=>{n[t].slice(0,h).forEach((n=>{f+=1;const c=ST(t,n.opponent);if(!I.includes(c)){const d=yT({stipulated:[[t,n.opponent]],actorsCount:o.length,valueSortedPairings:e,pairingValueMap:a,deltaObjects:i,valueObjects:r});if(!u.includes(UT(d))){u.push(UT(d)),s.push(d);const{maxDelta:t,value:e}=d;t<l.maxDelta&&(l=d),(e<p||e===p&&Math.round(Math.random()))&&(p=e),I.push(c),m+=1}}})),s=s.filter((t=>Math.abs(t.value-p)<5))})),s.sort(((t,e)=>t.maxDiff-e.maxDiff));const g=M(s);return{candidatesCount:m,deltaCandidate:l,maxIterations:t,iterations:f,candidate:g}}({valueSortedPairings:d,maxIterations:i,pairingValues:p,deltaObjects:a,valueObjects:o}),{participantIdPairings:I}=l;return{participantIdPairings:I,candidatesCount:m,deltaCandidate:f,iterations:h,candidate:l}}const PT=100,DT=100,NT=4e3;function RT({encounterValue:t=PT,sameTeamValue:e=DT,maxIterations:n=NT,generateMatchUps:r=!0,tournamentParticipants:i,tournamentRecord:a,participantIds:o,addToStructure:s,drawDefinition:c,adHocRatings:u,structureId:d,salted:p=.5,matchUpIds:l,eventType:m,structure:f,scaleName:h}){if(!c)return{error:Y};if(!f&&!d)return{error:Dt};if(f||(f=zd({drawDefinition:c,structureId:d}).structure),!si(f))return{error:Rt};if(!o?.length)return{error:Ge};const{encounters:I}=function({matchUps:t}){const e=[];for(const n of t){const t=n.sides.map(ui("participantId"));if(2===t.length){const[n,r]=t,i=ST(n,r);e.includes(i)||e.push(i)}}return{encounters:e}}({matchUps:f?.matchUps??[]}),g={};for(const A of I)g[A]||(g[A]=0),g[A]+=t;const U=i?.filter((({participantType:t})=>t===Fu));if(U)for(const A of U){const t=A.individualParticipantIds??[],{uniquePairings:n}=vT({participantIds:t});for(const r of n)g[r]||(g[r]=0),g[r]+=e}const{uniquePairings:y,possiblePairings:S,deltaObjects:v}=vT({participantIds:o}),w={tournamentParticipants:i,possiblePairings:S,drawDefinition:c,participantIds:o,uniquePairings:y,maxIterations:n,adHocRatings:u,deltaObjects:v,valueObjects:g,eventType:m,scaleName:h,structure:f,salted:p},{candidatesCount:T,participantIdPairings:P,iterations:D,candidate:N}=TT(w);if(!T)return{error:An};let R;if(r){const t=xw({structureId:f?.structureId,participantIdPairings:P,tournamentRecord:a,addToStructure:s,newRound:!0,drawDefinition:c,matchUpIds:l});if(t.error)return t;R=t.matchUps}const{maxDelta:b,maxDiff:M}=N;return{...L,participantIdPairings:P,candidatesCount:T,iterations:D,matchUps:R,maxDelta:b,maxDiff:M}}function bT({tournamentParticipants:t,restrictEntryStatus:e,adHocRatings:n={},generateMatchUps:r,tournamentRecord:i,addToStructure:a,participantIds:o,encounterValue:s,sameTeamValue:c,drawDefinition:u,scaleAccessor:d,maxIterations:p,structureId:l,matchUpIds:m,scaleName:f,eventType:h,salted:I,event:g}){if("object"!=typeof u||u.drawType&&u.drawType!==hd)return{error:z};if(!Array.isArray(u?.entries)&&o&&!Array.isArray(o))return{error:xn,info:"Missing Entries"};h=h??g?.eventType;const U=u?.entries?.filter((t=>{const n=t.entryStatus;return!e||lp.includes(n)})).map(ml);if(o){const t=o.filter((t=>!U?.includes(t)));if(t?.length)return{error:Ee,invalidParticipantIds:t}}else o=U;if(!l){const t=u?.structures?.filter((t=>1===t.stageSequence))?.reduce(((t,e)=>{const n=e.stage&&Xu[e.stage];return Fp({drawDefinition:u,structure:e})&&n>(Xu[t?.stage]||1)?e:t}),void 0);l=t?.structureId}const y=u?.structures?.find((t=>t.structureId===l));if(!y)return{error:Dt};if(!Fp({drawDefinition:u,structure:y}))return{error:z};t=t??i.participants??[];for(const S of o??[]){const e=t?.find((t=>t.participantId===S));let r=MT({scaleName:`${f}.${ss}`,scaleAccessor:d,participant:e,eventType:h});!r&&f&&(r=MT({scaleAccessor:d,participant:e,scaleName:f,eventType:h})),r&&!n[S]&&(n[S]=r)}return RT({tournamentParticipants:t,generateMatchUps:r,tournamentRecord:i,addToStructure:a,participantIds:o,encounterValue:s,sameTeamValue:c,drawDefinition:u,maxIterations:p,adHocRatings:n,matchUpIds:m,structure:y,eventType:h,salted:I})}function MT({scaleType:t=us,scaleAccessor:e,participant:n,scaleName:r,eventType:i}){const a={eventType:i||Bi.Singles,scaleType:t,scaleName:r},o=n&&yh({scaleAttributes:a,participant:n}),s=o?.scaleItem?.scaleValue;return e&&si(s)?s[e]:s}function AT({drawDefinition:t,matchUpId:e,outcome:n,matchUp:r}){if(!r&&!t)return{error:Y};if(!n)return{error:me,info:"missing outcome"};if(!r&&!e)return{error:te};if(!r){const n=$p({drawDefinition:t,matchUpId:e});if(n.error)return n;r=n.matchUp}if("object"!=typeof n||!n.score?.scoreStringSide1||!n.score?.scoreStringSide2)return{error:xn};return Bs({element:r,extension:{name:go,value:n}})}function ET(t){return null!==t&&(void 0===t||!isNaN(t))}function CT({drawDefinition:t,matchUpId:e,event:n}){if(!t)return{error:Y};const{matchUp:r}=$p({drawDefinition:t,matchUpId:e,event:n});return Bs({extension:{name:So,value:!0},element:r})}function OT({tournamentRecord:t,drawDefinition:e,matchUpId:n,event:r}){if(!e)return{error:Y};const{matchUp:i}=$p({drawDefinition:e,matchUpId:n,event:r});return i?.matchUpType!==Ea?{error:ee}:qg({enableAutoCalc:!0,tournamentRecord:t,drawDefinition:e,matchUpId:n,event:r})}function FT({drawDefinition:t,finishingOrder:e}){if(!t)return{error:Y};const n="setOrderOfFinish";if(!Array.isArray(e))return Oi({info:Ci("finishingOrder"),result:{error:xn},stack:n});const{completedMatchUps:r,matchUpsMap:i}=Dl({inContext:!0,drawDefinition:t}),a=r?.map(hl)??[],o=e.map(hl),{matchUpTypes:s,roundNumbers:c,structureIds:u,matchUpTieIds:d}=(r??[]).filter((({matchUpId:t})=>o.includes(t))).reduce(((t,e)=>{const{matchUpTieId:n,matchUpType:r,roundNumber:i,structureId:a}=e;return t.matchUpTypes.includes(r)||t.matchUpTypes.push(r),t.roundNumbers.includes(i)||t.roundNumbers.push(i),t.structureIds.includes(a)||t.structureIds.push(a),t.matchUpTieIds.includes(n)||t.matchUpTieIds.push(n),t}),{matchUpTypes:[],roundNumbers:[],structureIds:[],matchUpTieIds:[]});if(s.length>1||d.length>1||c.length>1||u.length>1)return Oi({info:"matchUpType, structureId and roundNumber must be equivalent",result:{error:xn},stack:n});let p,l;const m={},f=[],h=[],I=e.every((({orderOfFinish:t,matchUpId:e})=>(f.push(e),t&&h.push(t),m[e]=t,p=a.includes(e),l=void 0===t||v(t)&&Math.floor(t)>0,p&&l)));if(!I)return Oi({result:{error:p?xn:$t},info:(p?!l&&"orderOfFinish must be integer > 0 or undefined":"matchUps must be completed")||void 0,stack:n});const g=r?.filter((t=>t.structureId===u[0]&&t.roundNumber===c[0]&&t.matchUpType===s[0]&&t.matchUpTieId===d[0]&&!f.includes(t.matchUpId)));for(const U of g??[]){const{orderOfFinish:t}=U||{};if(t){if(!v(t))return Oi({context:{orderOfFinish:t,matchUp:U},result:{error:xn},stack:n});h.push(t)}}if(b(h).length!==h.length||Math.max(...h)>h.length)return Oi({info:"Values not unique or greater than expected number of values",result:{error:xn},stack:n});if(u.length){const e=Tl({matchUpFilters:{matchUpIds:o},structureId:u[0],drawDefinition:t,matchUpsMap:i});if(e.error)return Oi({result:e,stack:n});e.completedMatchUps?.forEach((t=>t.orderOfFinish=m[t.matchUpId]))}return{...L}}const kT={resetScorecard:VU,setMatchUpStatus:qg,setMatchUpFormat:Wg,updateTieMatchUpScore:bl,isValidMatchUpFormat:Ti,disableTieAutoCalc:CT,enableTieAutoCalc:OT,addFinishingRounds:ah,addMatchUpTimeItem:mI,resetMatchUpTimeItems:function({tournamentRecord:t,drawDefinition:e,matchUpId:n,event:r}){const{matchUp:i}=$p({drawDefinition:e,event:r,matchUpId:n});return i?(i.timeItems=[],nl({tournamentId:t?.tournamentId,context:"resetTimeItems",eventId:r?.eventId,drawDefinition:e,matchUp:i}),{...L}):{error:Xt}},checkInParticipant:$y,checkOutParticipant:Wy,getCheckedInParticipantIds:Ep,addMatchUpScheduleItems:SI,addMatchUpScheduledDate:vI,addMatchUpScheduledTime:gI,addMatchUpStartTime:PI,addMatchUpEndTime:DI,addMatchUpStopTime:NI,addMatchUpResumeTime:RI,addMatchUpTimeModifiers:UI,addGoesTo:oh,setOrderOfFinish:FT,setDelegatedOutcome:AT,removeDelegatedOutcome:gT,drawMatic:bT,addMatchUpOfficial:TI,findMatchUp:function(t){return Object.assign(t,{inContext:!0}),{matchUp:ri($p(t).matchUp,!1,!0)}},getRoundMatchUps:Gu,validDrawPositions:function({matchUps:t}){if(!t)return{error:Zt};const e=t.map((t=>t.drawPositions)).flat();ir()&&t.forEach((t=>{Array.isArray(t.drawPositions)?t.drawPositions?.forEach((e=>{ET(e)||console.log("invalid drawPosition",t)})):console.log("drawPositions not an array",t)}));const n=e?.every(ET),r=t.find((t=>!Array.isArray(t.drawPositions)));return n&&!r},validateScore:El};function xT({drawDefinition:t,policyDefinitions:e}){if(!t)return{error:Y};if(!e||"object"!=typeof e)return{error:re};t.extensions||(t.extensions=[]);const n=Vo({drawDefinition:t})?.appliedPolicies??{},r=[to,ao],i=Object.keys(e).every((t=>!(n[t]&&!r.includes(t))&&(n[t]=e[t],!0)));if(i){const e=Bs({element:t,extension:{name:fo,value:n}});if(e.error)return e}return il({drawDefinition:t}),i?{...L}:{error:se}}const _T={attachPolicies:xT};function LT({excludedMatchUpStatuses:t=[],includeEventParticipants:e,includeQualifyingStage:n,finishingRoundLimit:r,policyDefinitions:i,roundNumberLimit:a,tournamentRecord:o,drawDefinition:s,matchUpsLimit:c,requirePlay:u,requireLoss:d,allEntries:p,winsLimit:l,event:m}){if(!s)return{error:Y};const f=[ki.Main,ki.PlayOff];n&&f.push(ki.Qualifying);const h=m?.eventType?{matchUpTypes:[m.eventType]}:void 0,I=s?.matchUpType?{matchUpTypes:[s.matchUpType]}:void 0,g=e&&m?nh({contextFilters:{stages:f},matchUpFilters:h,tournamentRecord:o,inContext:!0,event:m})?.matchUps||[]:eh({contextFilters:{stages:f},matchUpFilters:I,tournamentRecord:o,inContext:!0,drawDefinition:s})?.matchUps||[],U=Up({stage:Ku,drawDefinition:s}).map((({participantId:t})=>t)),y={},S={},v={},w={};i||(i=jo({policyTypes:[Ya],tournamentRecord:o,drawDefinition:s,event:m}).policyDefinitions);const T=i?.[Ya];t=t.length&&t||T?.excludedMatchUpStatuses||[],e=void 0!==e?e:T?.includeEventParticipants,p=void 0!==p?p:T?.allEntries,r=r||T?.finishingRoundLimit,a=a||T?.roundNumberLimit,c=c||T?.matchUpsLimit,void 0===u&&(u=void 0===T?.requirePlay||T.requirePlay),void 0===d&&(d=void 0===T?.requireLoss||T.requireLoss),l=l||T?.winsLimit;for(const b of g){if(u&&b.winningSide&&![1,2].includes(b.winningSide)&&b.matchUpStatus!==ea)continue;if(b.finishingRound&&r&&b.finishingRound>=r)continue;if(b.finishingRound&&a&&b.finishingRound<=a)continue;const e=b.sides?.find((({sideNumber:t})=>b.winningSide&&t===3-b.winningSide)),n=b.sides?.find((({sideNumber:t})=>b.winningSide&&t===b.winningSide));if(b.sides?.forEach((e=>{const n=e?.participant?.participantId;n&&(v[n]=e.participant,b.matchUpStatus!==ea||u||(S[n]=e.participant,y[n]||(y[n]=0),t.includes(b.matchUpStatus)||(y[n]+=1)))})),e?.participant){const n=e.participant.participantId;S[n]=e.participant,y[n]||(y[n]=0),b.matchUpStatus&&!t.includes(b.matchUpStatus)&&(y[n]+=1)}if(n?.participant){const e=n.participant.participantId;w[e]||(w[e]=0),w[e]+=1,y[e]||(y[e]=0),b.matchUpStatus&&!t.includes(b.matchUpStatus)&&(y[e]+=1)}}const P=o?.participants&&!u&&!d&&p,D=P?((e&&m?m.entries:s.entries)||[]).filter((t=>![cp,ap].includes(t.entryStatus))).map((({participantId:t})=>t)):[],N=Object.keys(S),R=P?(o?.participants||[]).filter((({participantId:t})=>D.includes(t))):d&&Object.values(S)||Object.values(v);return{eligibleParticipants:R.filter((t=>{return e=t.participantId,(!d||N.includes(e))&&(t=>!u||(y[t]||0)>=0)(t.participantId)&&(t=>!l||(w[t]||0)<=l)(t.participantId)&&(t=>!c||y[t]<=c)(t.participantId)&&(t=>!U.includes(t))(t.participantId);var e})).map((t=>({...t,individualParticipants:t.individualParticipantIds?.map((t=>o?.participants?.find((e=>e.participantId===t))))}))),losingParticipantIds:N,...L}}function BT({tournamentParticipants:t,drawDefinition:e,event:n}){if(!e)return{error:Y};const r=ri(Pl({tournamentParticipants:t,inContext:!0,drawDefinition:e,event:n}).matchUps,!1,!0),i=T(r.reduce(((t,e)=>t.concat(...e.sides.map((t=>t.participantId)).filter(Boolean))),[])),a=Object.assign({},...i.map((t=>{const e=r.filter((e=>e.sides.map((t=>t.participantId)).filter(Boolean).includes(t)));return{[t]:e}})));return{participantIds:i,participantIdMatchUps:a}}function VT({byeAdvancements:t=!1,tournamentParticipants:e,drawDefinition:n}){if(!n)return{error:Y};const{participantIds:r,participantIdMatchUps:i}=BT({tournamentParticipants:e,drawDefinition:n}),a=r.map((e=>{const n=i[e].filter((t=>[Qi,Ki].includes(t.matchUpStatus)||t.winningSide)),r=n.map((n=>{const r=n.sides.find((t=>t.bye)),i=n.sides.find((t=>t.participantId===e)).sideNumber;return(n.winningSide||t&&r&&i)===i?n.finishingPositionRange.winner:n.finishingPositionRange.loser})),a=t=>Math.abs(t[0]-t[1]),o=r.reduce(((t,e)=>t&&a(t)<a(e)?t:e),void 0);return{[e]:{relevantMatchUps:n,finishingPositionRanges:r,finishingPositionRange:o}}}));return Object.assign({},...a)}function jT({targetRoundNumber:t,finishingPosition:e,drawDefinition:n,structureId:r,linkType:i}){const{links:a}=Ul({drawDefinition:n,structureId:r})||{},o=(a?.target||[]).filter((({linkType:t})=>t===i)).filter((({target:e})=>!t||t===e.roundNumber)).map((t=>{const r=t.source.structureId,{structure:i}=zd({structureId:r,drawDefinition:n});if(!e||i?.finishingPosition===e)return t})).filter(Boolean);return{sourceStructureIds:o.map((({source:t})=>t.structureId)),relevantLinks:o}}function GT(t,e){return t.bye||hg(t.seedValue)<hg(e.seedValue)||t.seedValue&&!e.seedValue?-1:(t.seedNumber||0)-(e.seedNumber||0)}function qT({onlyAssignedPositions:t=!0,possiblyDisablingAction:e,tournamentParticipants:n,inactiveDrawPositions:r,activeDrawPositions:i,positionAssignments:a,returnParticipants:o,byeDrawPositions:s,drawDefinition:c,isByePosition:u,drawPosition:d,structureId:p,structure:l,drawId:m,event:f}){if(i.includes(d))return{};const h=r?.filter((t=>t!==d&&!(u&&s.includes(t)))),I=a?.filter((e=>(e=>!t||e.participantId||e.qualifier||e.bye)(e)&&h?.includes(e.drawPosition)))||[],g=I.map((({drawPosition:t})=>t)),{matchUps:U}=qp({afterRecoveryTimes:!1,inContext:!0,drawDefinition:c,structure:l,event:f}),y=U.filter((({drawPositions:t})=>k(t,g))),S=Object.assign({},...y.map((t=>t.sides?.filter((({sourceDrawPositionRange:t})=>t)).map((({drawPosition:t,sourceDrawPositionRange:e})=>({[t]:e}))))).flat()),v=I.map((t=>t.participantId)).filter(Boolean),w=(n||[]).filter((t=>v.includes(t.participantId))),T=Object.assign({},...w.map((t=>({[t.participantId]:t})))),P=I.map((t=>{const e=T?.[t.participantId],n=S[t.drawPosition];return di({...t,participant:o?ri(e,!1,!0):void 0,sourceDrawPositionRange:n})}));if(P.length){return{validSwapAction:{payload:{drawId:m,structureId:p,drawPositions:[d]},willDisableLinks:e,method:df,type:Nf,availableAssignments:P}}}return{}}function $T(t){const{policyDefinitions:e,tournamentParticipants:n=[],returnParticipants:r=!0,provisionalPositioning:i,tournamentRecord:a,drawDefinition:o,drawPosition:s,event:c}=t;if(!c)return{error:At};if(!o)return{error:Y};if(!t.structureId)return{error:Pt};let u=zd({structureId:t.structureId,drawDefinition:o});if(u.error)return u;const d=u.containingStructure||u.structure;if(!d)return{error:Dt};const p=d.structureId;if(u=BI({drawDefinition:o,structureId:p}),void 0===s&&!u.isAdHoc)return{error:st};if(u.isAdHoc)return GS(t);if(u.error)return u;const{drawPositionInitialRounds:l,inactiveDrawPositions:m,activeDrawPositions:f,byeDrawPositions:h}=u,I=Vo({tournamentRecord:a,drawDefinition:o,structure:d,event:c}).appliedPolicies??{};Object.assign(I,e??{});const{actionsPolicy:g,enabledStructures:U,actionsDisabled:y}=SS({actionType:US,appliedPolicies:I,drawDefinition:o,structure:d}),S=g?.activePositionOverrides||[],{sourceStructureIds:v}=jT({finishingPosition:jd,targetRoundNumber:1,linkType:pd,drawDefinition:o,structureId:p})||{};let w;v?.length&&(w=v.reduce(((t,e)=>dg({structureId:e,drawDefinition:o})&&t),!0));const P=v.length,D=v.length&&!w,{policyActions:N}=wS({enabledStructures:U,drawDefinition:o,structure:d}),R=![zu,Hu].includes(d.stage)||1!==d.stageSequence,{drawId:b}=o,M=[],{assignedPositions:A,positionAssignments:E}=bp({structure:d}),C=A?.find((t=>t.drawPosition===s)),O=E?.map((t=>t.drawPosition));if(!O?.includes(s))return{error:ot};const{stage:F,stageSequence:k}=d,x=[F];F===Yu&&x.push(Hu),F===Hu&&x.push(Yu);const _=Up({entryStatuses:pp,provisionalPositioning:i,drawDefinition:o,stageSequence:k,structureId:p,stages:x}),L=Uh({drawDefinition:o,stages:x}).assignedParticipantIds??[],B=_.filter((t=>!L.includes(t.participantId))).map((t=>t.participantId)),V=h.includes(s),j=f.includes(s);if(y)return{info:"Actions Disabled for structure",isByePosition:V,isActiveDrawPosition:j,isDrawPosition:!0,hasPositionAssigned:!!C,validActions:[]};if(TS({policyActions:N,action:wf})&&!j&&E&&!D&&(!C||V)){const{validAssignmentActions:t}=function({positionSourceStructureIds:t,unassignedParticipantIds:e,possiblyDisablingAction:n,provisionalPositioning:r,tournamentParticipants:i,isWinRatioFedStructure:a,positionAssignments:o,returnParticipants:s,appliedPolicies:c,drawDefinition:u,isByePosition:d,drawPosition:p,structureId:l,event:m}){const{drawId:f}=u,h=[];let I,g,U=[];const y=c?.[so]?.validSeedPositions?.ignore;if(!y){const t=Ng({provisionalPositioning:r,randomize:!0,drawDefinition:u,structureId:l,event:m});({unplacedSeedParticipantIds:I,unplacedSeedAssignments:g,unfilledPositions:U}=t)}if(U?.length||(U=o.filter((t=>!t.participantId&&!t.bye&&!t.qualifier)).map((t=>t.drawPosition))),d||h.push({payload:{drawId:f,structureId:l,drawPosition:p,isPositionAction:!0},willDisableLinks:n,method:hf,type:Af}),a&&y){const e=o.map((t=>t.participantId)).filter(Boolean),r={structureIds:t},{completedMatchUps:a}=Dl({inContext:!0,matchUpFilters:r,drawDefinition:u}),c=T((a??[]).filter((({matchUpType:t})=>m?.eventType!==Du||t===Du))?.map((({sides:t})=>t?.map(ui("participantId")))).flat().filter((t=>t&&!e.includes(t)))),d=s?i?.filter((t=>c?.includes(t.participantId))).map((t=>ri(t,void 0,!0))):void 0;return d?.forEach((t=>{const e=(u.entries??[]).find((e=>e.participantId===t.participantId));t.entryPosition=e?.entryPosition})),d?.length&&h.push(di({payload:{drawId:f,structureId:l,drawPosition:p},willDisableLinks:n,method:mf,type:wf,availableParticipantIds:c,participantsAvailable:d})),{validAssignmentActions:h}}if(U.includes(p)||d){let t;if(g?.length){const e=g.filter((t=>I?.includes(t.participantId)));e.sort(GT),t=e.map((t=>t.participantId))}else t=e;const r=s?i?.filter((e=>t.includes(e.participantId))).map((t=>ri(t,void 0,!0))):void 0;r?.length&&h.push(di({payload:{drawId:f,structureId:l,drawPosition:p},willDisableLinks:n,method:mf,type:wf,availableParticipantIds:t,participantsAvailable:r}))}return{validAssignmentActions:h}}({positionSourceStructureIds:v,unassignedParticipantIds:B,possiblyDisablingAction:R,isWinRatioFedStructure:P,tournamentParticipants:n,positionAssignments:E,returnParticipants:r,appliedPolicies:I,drawDefinition:o,isByePosition:V,drawPosition:s,structureId:p,event:c});t?.forEach((t=>M.push(t)))}if(TS({policyActions:N,action:yf})){const{validAssignmentActions:t}=function({drawPositionInitialRounds:t,tournamentParticipants:e,positionAssignments:n,returnParticipants:r,appliedPolicies:i,drawDefinition:a,drawPosition:o,structureId:s,drawId:c}){const u=[],d=[],p=[],l=[],m=n.map((t=>t.participantId)).filter(Boolean),f=i?.[Qa],h=!f?.disableRoundRestrictions&&t[o],I=f?.requireCompletedStructures,{sourceStructureIds:g,relevantLinks:U}=jT({targetRoundNumber:h,linkType:ld,drawDefinition:a,structureId:s})||{};g?.length&&l.push(...g);const{sourceStructureIds:y,relevantLinks:S}=jT({targetRoundNumber:h,linkType:pd,drawDefinition:a,structureId:s})||{};y?.length&&l.push(...y);for(const v of U){const t=a.structures?.find((t=>t.structureId===v.source.structureId));if(t?.stage!==zu)continue;const n=dg({structureId:v.source.structureId,drawDefinition:a});if(!I||n){const n=t.qualifyingRoundNumber,{matchUps:i}=qp({matchUpFilters:{roundNumbers:[n],hasWinningSide:!0},afterRecoveryTimes:!1,tournamentParticipants:e,inContext:!0,structure:t});for(const t of i){const e=t.sides.find((e=>e?.sideNumber===t.winningSide)),n=t.matchUpStatus===Ki&&t.sides?.find((({participantId:t})=>t));if(e||n){const{participantId:t,participant:i}=e||n||{};t&&!m.includes(t)&&(i&&r&&u.push(i),d.push(t))}}}}for(const v of S){const t=a.structures?.find((t=>t.structureId===v.source.structureId));if(t?.stage!==zu)continue;const n=dg({structureId:v.source.structureId,drawDefinition:a});if(!I||n){const{positionAssignments:n}=Rp({structure:t}),i=n?.map((t=>{const e=t.participantId,n=gs({element:t,name:xo}).extension?.value;return n?{participantId:e,groupOrder:n?.groupOrder}:{}})).filter((({groupOrder:t,participantId:e})=>1===t&&!m.includes(e))).map((({participantId:t})=>t))??[];if(i&&d.push(...i),r){const t=e.filter((({participantId:t})=>i.includes(t)));u.push(...t)}}}return d.length&&p.push(di({payload:{qualifyingParticipantId:void 0,drawPosition:o,structureId:s,drawId:c},method:af,type:yf,qualifyingParticipantIds:d,qualifyingParticipants:r?u:void 0})),{validAssignmentActions:p,sourceStructureIds:l}}({drawPositionInitialRounds:l,tournamentParticipants:n,positionAssignments:E,returnParticipants:r,appliedPolicies:I,drawDefinition:o,drawPosition:s,structureId:p,drawId:b});t?.forEach((t=>M.push(t)))}const{participantId:G}=C||{},q=G&&n.find((t=>t.participantId===G));if(C){TS({policyActions:N,action:Tf})&&!j&&(M.push({type:Tf,method:uf,payload:{drawId:b,structureId:p,drawPosition:s},willDisableLinks:R}),V||M.push({type:vf,method:of,payload:{drawId:b,structureId:p,drawPosition:s},willDisableLinks:R}),TS({policyActions:N,action:Af})&&!V&&M.push({type:Af,method:uf,payload:{drawId:b,structureId:p,drawPosition:s,replaceWithBye:!0},willDisableLinks:R}));const t=d.stage===zu||d.stage===Hu&&1===d.stageSequence;if(!V&&vS({activePositionOverrides:S,activeDrawPositions:f,action:bf})&&TS({policyActions:N,action:bf})&&Dg({drawDefinition:o,structureId:p,drawPosition:s})&&t){const{seedAssignments:t}=Sp({drawDefinition:o,structure:d}),{seedNumber:e,seedValue:n}=t?.find((t=>t.participantId===G))??{};M.push({type:bf,method:If,participant:q,seedNumber:e,payload:{drawId:b,structureId:p,participantId:G,seedValue:n}})}if(!V&&vS({activePositionOverrides:S,activeDrawPositions:f,action:Df})&&TS({policyActions:N,action:Df})&&Dg({drawDefinition:o,structureId:p,drawPosition:s})&&t){const{seedAssignments:t}=Sp({drawDefinition:o,structure:d}),{seedNumber:e}=t?.find((t=>t.participantId===G))??{};M.push({method:ff,type:Df,participant:q,seedNumber:e,payload:{participantId:G,structureId:p,drawId:b}})}if(!V&&G){if(TS({policyActions:N,action:Mf})){const t={type:Mf,method:gf,participant:q,payload:{penaltyCode:void 0,penaltyType:void 0,participantIds:[],notes:void 0,drawId:b}};M.push(t)}if(TS({policyActions:N,action:Rf})){const t={type:Rf,method:lf,participant:q,payload:{participantId:G,otherName:void 0}};M.push(t)}}if(TS({policyActions:N,action:Nf})){const{validSwapAction:t}=qT({possiblyDisablingAction:R,tournamentParticipants:n,inactiveDrawPositions:m,activeDrawPositions:f,positionAssignments:E,returnParticipants:r,byeDrawPositions:h,drawDefinition:o,isByePosition:V,drawPosition:s,structureId:p,structure:d,drawId:b});t&&M.push(t)}}if(TS({policyActions:N,action:Sf})&&!D){const{validAlternatesAction:t}=function({tournamentParticipants:t=[],possiblyDisablingAction:e,activeDrawPositions:n,positionAssignments:r,returnParticipants:i,appliedPolicies:a,drawDefinition:o,drawPosition:s,validActions:c,structureId:u,structure:d,drawId:p,event:l}){if(n.includes(s))return{};const m=c.find((t=>t.type===wf))?.availableParticipantIds,f=a?.[Qa]?.otherFlightEntries,h=a?.[Qa]?.restrictQualifyingAlternates,I=(o.entries??[]).filter((({entryStage:t})=>!h||(d.stage===zu?t===zu:t!==zu))).sort(((t,e)=>(t.entryPosition??1/0)-(e.entryPosition??1/0))).map((({participantId:t})=>t)).filter(Boolean),{allPositionedParticipantIds:g}=Np({drawDefinition:o}),U=r.map((t=>t.participantId)).filter(Boolean),y=I.filter((t=>d.stage&&[zu,Hu,Ju].includes(d.stage)?!g?.includes(t):!U.includes(t))),S=(l?.entries??[]).filter((t=>t.entryStatus===Kd&&IS({restrictQualifyingAlternates:h,structure:d,entry:t})&&(d.stage&&[zu,Hu,Ju].includes(d.stage)?!g?.includes(t.participantId):!U.includes(t.participantId)))).sort(((t,e)=>(t.entryPosition??1/0)-(e.entryPosition??1/0))).map((t=>t.participantId));let v=T(y.concat(S));if(f){const t=l?_s({event:l}).flightProfile:void 0,e=t?.flights?.filter((t=>t.drawId!==p)).map((t=>t.drawEntries.filter((t=>t.participantId&&![cp,ap,op].includes(t.entryStatus)&&!I.includes(t.participantId))).map((({participantId:t})=>t)))).flat().filter(Boolean);e?.length&&v.push(...e)}m?.length&&(v=v.filter((t=>!m.includes(t))));const w=i?t?.filter((t=>v.includes(t.participantId))):void 0;if(w?.forEach((t=>{const e=(o.entries??[]).find((e=>e.participantId===t.participantId));t.entryPosition=e?.entryPosition})),w?.sort(((t,e)=>(t.entryPosition||1/0)-(e.entryPosition||1/0))),v.length)return{validAlternatesAction:di({payload:{drawId:p,structureId:u,drawPosition:s},willDisableLinks:e,method:sf,availableAlternatesParticipantIds:v,type:Sf,availableAlternates:w})};return{}}({possiblyDisablingAction:R,tournamentParticipants:n,positionAssignments:E,activeDrawPositions:f,returnParticipants:r,appliedPolicies:I,drawDefinition:o,drawPosition:s,validActions:M,structureId:p,structure:d,drawId:b,event:c});t&&M.push(t)}if(TS({policyActions:N,action:Pf})&&!D&&E){const{validLuckyLosersAction:t}=function({tournamentParticipants:t=[],sourceStructuresComplete:e,possiblyDisablingAction:n,isWinRatioFedStructure:r,activeDrawPositions:i,positionAssignments:a,drawDefinition:o,drawPosition:s,structureId:c,structure:u,drawId:d,event:p}){if(i.includes(s)||r&&!e)return{};const{sourceStructureIds:l,targetStructureIds:m}=o.links?.reduce(((t,e)=>{const n=e.source?.structureId,r=e.target?.structureId;return t.sourceStructureIds.includes(n)||t.sourceStructureIds.push(n),t.targetStructureIds.includes(r)||t.targetStructureIds.push(r),t}),{sourceStructureIds:[],targetStructureIds:[]})||{},f=[],h=o.links?.filter((t=>t.target?.structureId===u.structureId))||[];for(const g of h){const t=g?.source?.structureId,{structure:e}=zd({structureId:t,drawDefinition:o}),n={};if(e?.finishingPosition===Gd&&(1!==l?.length||1!==m?.length)){const{matchUps:t}=qp({drawDefinition:o,structure:u,event:p}),{initialRoundNumber:e}=OI({drawPosition:s,matchUps:t}),r=o.links?.find((t=>t.target?.structureId===u?.structureId&&t.target.roundNumber===e)),i=r?.source?.roundNumber;n.roundNumbers=[i]}const{completedMatchUps:r}=Tl({structureId:t,inContext:!0,matchUpFilters:n,drawDefinition:o}),i=a.map((t=>t.participantId)).filter(Boolean),c=r?.filter((({matchUpType:t,winningSide:e})=>e&&(p?.eventType!==Du||t===Du))).map((({winningSide:t,sides:e})=>t&&e?.[1-(t-1)])).map(ui("participantId")).filter((t=>t&&!i.includes(t)));c?.forEach((t=>{f.includes(t)||f.push(t)}))}const I=t?.filter((t=>f?.includes(t.participantId)));if(I?.forEach((t=>{const e=(o.entries||[]).find((e=>e.participantId===t.participantId));t.entryPosition=e?.entryPosition})),f?.length)return{validLuckyLosersAction:{type:Pf,method:cf,availableLuckyLosers:I,availableLuckyLoserParticipantIds:f,willDisableLinks:n,payload:{drawId:d,structureId:c,drawPosition:s}}};return{}}({sourceStructuresComplete:w,possiblyDisablingAction:R,isWinRatioFedStructure:P,tournamentParticipants:n,activeDrawPositions:f,positionAssignments:E,drawDefinition:o,drawPosition:s,structureId:p,structure:d,drawId:b});t&&M.push(t)}if(q?.participantType===Ou&&TS({policyActions:N,action:Uf})){const{validModifyAssignedPairAction:t}=function({tournamentParticipants:t,returnParticipants:e,drawPosition:n,participant:r,drawId:i,event:a}){const o=a?.entries?.filter((({entryStatus:t})=>[ap,op].includes(t))).map((({participantId:t})=>t))||[];if(o.length){const a=r.individualParticipantIds,s=e?t.filter((({participantId:t})=>o.includes(t))):void 0,c=e?t.filter((({participantId:t})=>a.includes(t))):void 0;return{validModifyAssignedPairAction:di({payload:{participantId:r.participantId,replacementIndividualParticipantId:void 0,existingIndividualParticipantId:void 0,drawPosition:n,drawId:i},method:pf,availableIndividualParticipantIds:o,availableIndividualParticipants:s,existingIndividualParticipantIds:a,existingIndividualParticipants:c,type:Uf},!1,!1,!0)}}return{}}({tournamentParticipants:n,returnParticipants:r,drawPosition:s,participant:q,drawId:b,event:c});t&&M.push(t)}return{hasPositionAssigned:!!C,isActiveDrawPosition:j,isDrawPosition:!0,isByePosition:V,validActions:M}}const WT={allPlayoffPositionsFilled:pg,isCompletedStructure:dg,getAllStructureMatchUps:qp,getStructureMatchUps:Tl,allStructureMatchUps:function(t){const{structure:e}=zd(t);return Object.assign(t,{structure:e,inContext:!0}),qp(t)},allDrawMatchUps:function(t){return Object.assign(t,{inContext:!0}),Pl(t)},drawMatchUps:function(t){return Object.assign(t,{inContext:!0}),Dl(t)},getEliminationDrawSize:Bw,getParticipantIdMatchUps:BT,getParticipantIdFinishingPositions:VT,getEligibleVoluntaryConsolationParticipants:LT,structureActions:function(t){return t?.drawDefinition?{actions:[],state:{isComplete:dg(t),hasPlayoffPositionsFilled:pg(t)}}:{error:Y}},matchUpActions:GS,positionActions:$T,getStructureSeedAssignments:Sp,getNextUnfilledDrawPositions:function({provisionalPositioning:t,drawDefinition:e,seedBlockInfo:n,structureId:r,event:i}){if(!e){return{error:Y,nextUnfilledDrawPositions:[]}}if(!r){return{error:Pt,nextUnfilledDrawPositions:[]}}const a=zd({drawDefinition:e,structureId:r});if(a.error)return a;const{positionAssignments:o=[]}=bp({structure:a.structure}),{unfilledPositions:s}=Ng({provisionalPositioning:t,randomize:!0,drawDefinition:e,seedBlockInfo:n,structureId:r,event:i}),c=o.filter((t=>!t.participantId&&!t.bye&&!t.qualifier)).map((t=>t.drawPosition));return s?.length?{nextUnfilledDrawPositions:s}:{nextUnfilledDrawPositions:c}},getExitProfiles:vp,getValidGroupSizes:Sg,getSeedingThresholds:function({roundRobinGroupsCount:t,participantsCount:e}){if(t){const{validGroupSizes:n}=Sg({drawSize:e}),r=n?.map((t=>Math.ceil(e/t)));if(!r?.includes(t))return Oi({context:{roundRobinGroupsCount:t},result:{error:xn}})}const{seedGroups:n}=wg({drawSize:e,roundRobinGroupsCount:t}),r=n?.map((t=>Math.min(...t)))||[];return{...L,seedingThresholds:r}},getSeedBlocks:vg,getSeedGroups:wg,getMatchUpContextIds:function({matchUps:t,matchUpId:e}){if(!Sa(t))return{error:xn};const n=t.find((t=>t.matchUpId===e)),{drawId:r,eventId:i,structureId:a,tournamentId:o}=n||{};return{matchUpId:e,drawId:r,eventId:i,structureId:a,tournamentId:o}},getMatchUpParticipantIds:Ap,getMatchUpScheduleDetails:bu,generateTieMatchUpScore:Hp,matchUpDuration:yu,credits:hS};function HT({validation:t=!0,tournamentRecord:e,drawDefinition:n,participantId:r,structureId:i,seedValue:a,event:o}){if(!n)return{error:Y};if(!i)return{error:Pt};const{structure:s}=zd({drawDefinition:n,structureId:i});if(!s)return{error:Dt};if(!(!t||U(a)||void 0===a||""===a||"string"==typeof a&&a.split("-").every((t=>U(t)&&m(t)>0))))return{error:xn};const{seedAssignments:c}=Sp({drawDefinition:n,structure:s}),u=c?.map((t=>t.seedNumber)),d=c?.find((t=>t.participantId===r));if(d){const t="string"==typeof a?a.includes("-")&&a.split("-").map((t=>parseInt(t))).join("-")||parseInt(a)>0&&parseInt(a)||"":a&&a>0&&a||"";d.seedValue=t}else{const t={seedNumber:Math.max(0,...u||[])+1,participantId:r};a&&(t.seedValue=a),s.seedAssignments||(s.seedAssignments=[]),s.seedAssignments.push(t)}return al({tournamentId:e?.tournamentId,eventId:o?.eventId,drawDefinition:n,structure:s}),{...L}}const zT={getAssignedParticipantIds:Uh,setStageAlternatesCount:function({alternatesCount:t,drawDefinition:e,stage:n}){return e?Ip({drawDefinition:e,stage:n})?($u({attributes:[{[n]:{alternates:t}}],drawDefinition:e}),t||(e.entries=e.entries?.filter((t=>t.entryStatus!==Kd))||[]),il({drawDefinition:e}),{...L}):{error:_t}:{error:Y}},setStageWildcardsCount:function({wildcardsCount:t=0,drawDefinition:e,stageSequence:n,stage:r}){if(!e)return{error:Y};if(!Ip({drawDefinition:e,stage:r}))return{error:_t};const i=Yv({drawDefinition:e,stage:r}),{qualifiersCount:a}=zv({drawDefinition:e,stageSequence:n,stage:r}),o=function({stage:t,drawDefinition:e}){return gp({entryStatus:sp,drawDefinition:e,stage:t})}({drawDefinition:e,stage:r}),s=yp({drawDefinition:e,stage:r});if(t<o){return{error:Object.assign(dt,{message:"Number of Wildcards cannot be less than number of Wildcards already entered"})}}return s+t+a>i?{error:dt,info:"Total stage Entries cannot be greater than drawPositions"}:($u({attributes:[{[r]:{wildcardsCount:t}}],drawDefinition:e}),il({drawDefinition:e}),{...L})},setStageQualifiersCount:Jv,modifySeedAssignment:HT,setStageDrawSize:Kv,addDrawEntries:Zw,addDrawEntry:Xw,removeEntry:function({autoEntryPositions:t=!0,drawDefinition:e,participantId:n,stages:r}){return e?n?(Uh({drawDefinition:e,stages:r}).assignedParticipantIds??[]).includes(n)?{error:ze}:(e?.entries&&(e.entries=e.entries.filter((t=>t.participantId!==n))),t&&(e.entries=zw({entries:e.entries})),il({drawDefinition:e}),{...L}):{error:Le}:{error:Y}},assignSeed:Mg},YT={generateQualifyingLink:vv},KT=()=>({matchUpType:void 0,drawName:void 0,drawId:void 0,structures:[],entries:[],links:[]}),JT=["drawId","structures"];function QT(t,e=!0){return t?"object"!=typeof t?{error:On}:t.drawId?function(t){const e=Object.keys(t);return JT.reduce(((t,n)=>!!e.includes(n)&&t),!0)}(t)?e?ri(t):t:{error:z}:{error:lt,method:"setState"}:{error:Y}}function XT({drawId:t=hi(),processCodes:e,matchUpType:n,drawType:r}){const i=KT();return Object.assign(i,{processCodes:e,matchUpType:n,drawType:r,drawId:t})}let ZT,tP=[];const eP=function(){const t={getState:t=>({drawDefinition:ri(ZT,t?.convertExtensions,!1,t?.removeExtensions)}),version:()=>"1.8.14",reset:()=>(ZT=void 0,{...L}),newDrawDefinition:t=>(ZT=XT({drawId:t?.drawId,drawType:t?.drawType}),{drawDefinition:ri(ZT),drawId:ZT.drawId,...L}),setDrawDescription:t=>ZT?(ZT.description=t?.description,il({drawDefinition:ZT}),{drawId:ZT.drawId,...L}):{error:Y}};return[YT,WT,Om,zT,_T,kT,IT,Lw].forEach((n=>{Object.keys(n).forEach((r=>{t[r]=t=>{if(ir())return e({params:t,governor:n,methodName:r});try{return e({params:t,governor:n,methodName:r})}catch(i){Pr({engineName:"drawEngine",methodName:r,params:t,err:i})}}}))})),t.devContext=e=>(ar(e),t),t.setParticipants=(e=[])=>(tP=e,t),t.setState=(e,n,r)=>{sr(n,r);return function(e){return e?.error?(t.error=e.error,t.success=!1):(t.error=void 0,t.success=!0,ZT=e,t.drawId=e.drawId),t}(QT(e))},t;function e({params:e,governor:n,methodName:r}){delete t.success,delete t.error;const i=e?.rollbackOnError&&ri(ZT,!1,!0);e={...e,tournamentParticipants:tP,drawDefinition:ZT};const a=n[r](e);if(a?.error)return i&&QT(i),{...a,rolledBack:!!i};const o=a?.success&&!0!==e?.delayNotify&&!0!==e?.doNotNotify;return o&&iI(),(o||!a?.success||e?.doNotNotify)&&mr(),a}}();const nP={modifyCollectionDefinition:wU,orderCollectionDefinitions:DU,removeCollectionDefinition:MU,addCollectionDefinition:AU,removeCollectionGroup:FU,calculateWinCriteria:Gf,addCollectionGroup:kU,modifyTieFormat:xU};function rP({matchUp:t}){const{extension:e}=tc({name:Ro,element:t});if(!e)return{error:Gn};const{history:n=[],undoHistory:r=[]}=e.value;return{history:n,undoHistory:r,...L}}function iP({undoHistory:t,history:e,matchUp:n}){return Bs({element:n,extension:{value:{history:e,undoHistory:t},name:Ro}})}const aP={calculateHistoryScore:function({matchUp:t,updateScore:e}){const n=rP({matchUp:t})?.history||[];if(!Array.isArray(n))return{error:xn,info:"history is not an array"};const{matchUpFormat:r}=t;if(!r)return{error:zt};if(!Ti(r))return{error:Ht};const i=Ii(r),{bestOf:a,finalSetFormat:o,setFormat:s}=i,c=["0","15","30","40","A","G"],u={sets:[]};let d,p,l=[],m=[0,0],f=1,h=0,I=0;const g=t=>[1,2].includes(t),U=()=>(h+=1,{winningSide:void 0,side1Score:0,side2Score:0,setNumber:h,games:[]});let y={winningSide:void 0,side1Score:"",side2Score:"",shots:[]},S={winningSide:void 0,points:[]},w=U(),T=0;for(const P of n){T+=1,p=u.sets.length+1===a;const t=p&&o?o:s,{tiebreakAt:e,setTo:n,NoAD:r,tiebbreakFormat:i}=t,h=w.side1Score===e&&w.side1Score===w.side2Score,D=!!t.tiebreakSet,N=D?t.tiebreakSet:i,{tiebreakTo:R,NoAD:b}=N||{},M=()=>{d=void 0,m=[0,0],f=3-f,w.side1TiebreakScore=0,w.side2TiebreakScore=0,w.side1PointScore="",w.side2PointScore="",I=0},A=t=>{w.winningSide=t;const{s:e,...n}=w;u.sets.push(n),y={winningSide:void 0,side1Score:"",side2Score:"",shots:[]},S={winningSide:void 0,points:[]},w=U(),M()},E=t=>{S.winningSide=t;const{g:e,...n}=S;w.games.push(n),y={winningSide:void 0,side1Score:"",side2Score:"",shots:[]},S={winningSide:void 0,points:[]},M();w[`side${t}Score`]+=1},C=t=>{y.winningSide=t;const{p:e,...n}=y;S.points.push(n),y={winningSide:void 0,side1Score:"",side2Score:"",shots:[]},I=0;const i=t-1;if(h||D){m[i]+=1,d=m.reduce(((t,e)=>t+e))%4/4>.5?f:3-f,w[`side${t}TiebreakScore`]=m[i],w[`side${3-t}TiebreakScore`]=m[1-i];const e=b?1:2;if(m[i]>=R&&m[i]>=m[1-i]+e)return E(t),{gameCompleted:!0}}else if(4===m[1-i]&&3===m[i]?m[1-i]-=1:m[i]+=1,w.side1PointScore=c[m[0]],w.side2PointScore=c[m[1]],5===m[i]||4===m[i]&&m[1-i]<3||r&&4===m[i])return E(t),{gameCompleted:!0}};if(g(P.srv)&&(f=P.srv),["p","s","g","o"].includes(P.u)&&l.push(P.u),P.shotOutcome){y.shots.push(P);if("SERVE"===P.shotType&&["OUT","NET"].includes(P.shotOutcome)&&(I+=1),2===I){C(3-f)}}if(g(P.p)||v(P.pointNumber)){const t=C(P.winningSide||P.p);if(t?.gameCompleted)continue}if(g(P.g)||v(P.gameNumber)){const t=P.winningSide||P.g;S.winningSide=t;const e=`side${t}Score`,i=`side${3-t}Score`;l.length&&(l.includes("p"),l=[]),E(t);if(w[e]===n&&w[e]-w[i]>=(r?1:2)&&(A(t),p))break}if(g(P.s)||v(P.setNumber)){if(A(P.winningSide||P.s),l.length&&(l.includes("p"),l.includes("g"),l=[]),p)break}}return T!==n.length&&console.log({error:"Match completed with excess history"}),(w.side1Score||w.side2Score||w.games.length||w.side1TiebreakScore||w.side2TiebreakScore)&&u.sets.push(w),u.scoreStringSide1=Ml({...u,matchUpFormat:r}),u.scoreStringSide2=Ml({...u,matchUpFormat:r,reversed:!0}),f=d||f,e&&(t.score=u),{...L,servingSide:f,score:u}},setServingSide:function({matchUp:t,sideNumber:e}){if(![1,2].includes(e))return{error:de};const{history:n=[]}=rP({matchUp:t});return n.push({srv:e}),iP({matchUp:t,history:n})},clearHistory:function({matchUp:t}){return iP({matchUp:t})},addPoint:function({matchUp:t,point:e}){if(!e)return{error:me};if("object"!=typeof e)return{error:xn,context:{point:e}};const{history:n=[]}=rP({matchUp:t});return n.push(e),iP({matchUp:t,history:n})},addGame:function({matchUp:t,game:e}){if("object"!=typeof e)return{error:xn,context:{game:e}};const{history:n=[]}=rP({matchUp:t});return n.push(e),iP({matchUp:t,history:n})},addShot:function({matchUp:t,shot:e}){if("object"!=typeof e)return{error:me};const{history:n=[]}=rP({matchUp:t});return n.push(e),iP({matchUp:t,history:n})},addSet:function({matchUp:t,set:e}){if("object"!=typeof e)return{error:me};const{history:n=[]}=rP({matchUp:t});return n.push(e),iP({matchUp:t,history:n})},redo:function({matchUp:t}){const{history:e=[],undoHistory:n=[]}=rP({matchUp:t});return n.length&&e.push(n.pop()),iP({matchUp:t,history:e,undoHistory:n})},undo:function({matchUp:t}){const{history:e=[],undoHistory:n=[]}=rP({matchUp:t});return n.push(e.pop()),iP({matchUp:t,history:e,undoHistory:n})},umo:{scoreboard:()=>{},addPoints:()=>{},addPoint:()=>{}}};function oP(t){const{matchUp:e,sideNumber:n,setNumber:r,isTiebreakValue:i,isPointValue:a}=t||{};let{matchUpFormat:o}=t||{};if(!e)return{error:te};o=o||e?.matchUpFormat;const s=Ii(o),c=!!e?.winningSide,u=e.score?.sets,d=u?.length,p=r&&r-1,l=!!u?.find(((t,e)=>t.setNumber===r&&e===p)),m=u?.filter((t=>t?.winningSide))||[],f=m?.length||0,h=r&&u?.slice(r)||[],I=!!(d&&r&&h?.reduce(((t,e)=>(!e||!e.side1Score&&!e.side2Score&&!e.side1TiebreakScore&&!e.side2TiebreakScore&&!e.side1PointScore&&!e.side2PointScore)&&t),!0)),g=r<=d&&u.find((t=>t.setNumber===r)),U=g&&Am({setObject:g,matchUpScoringFormat:s}),{isCompletedSet:y,sideGameScores:S,sideTiebreakScores:v}=U||{},w=!!(g&&!y&&I||r&&r===d+1&&!c),T=[1,2].includes(n),P=T?n-1:0,D=g&&T&&(!i&&!a&&void 0!==S[P]&&S[P]||i&&void 0!==v[P]&&v[P]),R=!!D,b=m?.map((t=>Am({setObject:t,matchUpScoringFormat:s}).isValidSetOutcome)).reduce(((t,e)=>t&&e),!0),M=m.reduce(((t,e)=>{const{winningSide:n}=e;return t[n-1]++,t}),[0,0]),A=e?.winningSide,E=A&&A-1,C=1-E,O=M[E],F=M[C],k=Math.max(...M),x=N(M)[k],{bestOf:_}=s||{},L=k===(_&&Math.ceil(_/2)||1)&&1===x&&M.indexOf(k)+1||void 0,B=O>F&&A===L;return{completedSetsHaveValidOutcomes:b,validMatchUpWinningSide:B,calculatedWinningSide:L,matchUpScoringFormat:s,validMatchUpOutcome:L&&b&&B,isLastSetWithValues:I,completedSetsCount:f,isCompletedMatchUp:c,isValidSideNumber:T,hasExistingValue:R,existingValue:D,isExistingSet:l,isActiveSet:w,...U}}const sP={tallyParticipantResults:lo,matchUpIsComplete:Ua,analyzeMatchUp:oP,getMatchUpType:qu,scoreHasValue:Yp,validMatchUps:Sa,validMatchUp:ya};let cP,uP={};function dP(t,e=!0){if(!t)return{error:me};if("object"!=typeof t)return{error:On};if(t.matchUpId)cP=t.matchUpId,uP[cP]=e?ri(t):t;else if(Array.isArray(t))for(const n of t.reverse())n.matchUpId&&(uP[n.matchUpId]=e?ri(n):n,cP||(cP=n.matchUpId));else for(const n of Object.values(t))n.matchUpId&&(uP[n.matchUpId]=e?ri(n):n,cP||(cP=n.matchUpId));return e?ri(t):t}function pP(){return uP[cP]}function lP(){return Object.values(uP)}function mP(){cP=void 0,uP={}}function fP(t){return ri(uP[cP],t?.convertExtensions,!1,t?.removeExtensions)}(()=>{const t={getState:t=>fP(t),version:()=>"1.8.14",reset:()=>(mP(),{...L}),drawId:void 0,error:void 0,success:!1,devContext:e=>(ar(e),t),setState:(e,n,r)=>{sr(n,r);return function(e){e?.error?(t.error=e.error,t.success=!1):(t.error=void 0,t.success=!0,t.drawId=e.drawId);return t}(dP(e))}};return[nP,aP,sP,Om].forEach((n=>{Object.keys(n).forEach((r=>{t[r]=t=>{if(ir())return e({params:t,governor:n,methodName:r});try{return e({params:t,governor:n,methodName:r})}catch(i){Pr({engineName:"matchUpEngine",methodName:r,params:t,err:i})}}}))})),t;function e({params:e,governor:n,methodName:r}){t.error=void 0,t.success=!1;const i=e?.matchUp||pP(),a=e?.matchUps||lP(),o=e?.rollbackOnError&&ri(i,!1,!0);e={...e,matchUpId:i?.matchUpId,matchUps:a,matchUp:i};const s=n[r](e);if(s?.error)return o&&dP(o),{...s,rolledBack:!!o};const c=s?.success&&!0!==e?.delayNotify&&!0!==e?.doNotNotify;return c&&iI(),(c||!s?.success||e?.doNotNotify)&&mr(),s}})();function hP(t){const e=t||{};return e.tournamentId||(e.tournamentId=hi()),(!e.startDate||Br(e.startDate)||Dr.test(e.startDate))&&(!e.endDate||Br(e.endDate)||Dr.test(e.endDate))?(e.extensions&&(e.extensions=e.extensions.filter(xs)),{...e}):{error:ye}}function IP(t,e){if("object"!=typeof t)return{error:On};const n=t.unifiedTournamentId?.tournamentId||t.tournamentId;if(!n)return{error:H};const r=!1!==e?ri(t):t;return Sr({[n]:r}),vr(n),r}function gP({convertExtensions:t=!1,removeExtensions:e=!1,tournamentId:n}){if("string"!=typeof n)return{};return{tournamentRecord:ri(gr(n),t,!1,e)}}function UP(t,e,n){if(e){const r=e.drawId||e.matchUp?.drawId;if(r){const{event:i,drawDefinition:a}=Ls({tournamentRecord:t,drawId:r});if(e={...e,event:i,drawDefinition:a},n){const t=wp({drawDefinition:a}),{matchUps:n}=Pl({inContext:!0,drawDefinition:a,matchUpsMap:t});e.matchUpsMap=t,e.inContextDrawMatchUps=n}}if(e.eventId&&!e.event){const{event:n}=Ls({eventId:e.eventId,tournamentRecord:t});n&&(e={...e,event:n})}}return e}function yP({derivedDrawInfo:t,participantId:e,drawId:n}){const r=t[n]?.mainPositionAssignments?.find((t=>t.participantId===e)),i=t[n]?.qualifyingPositionAssignments?.find((t=>t.participantId===e)),a={};if(r){const{participantId:t,...e}=r;t&&(a[Hu]={...e})}if(i){const{participantId:t,...e}=i;t&&(a[zu]={...e})}return Object.keys(a).length?a:void 0}function SP({derivedDrawInfo:t,participantId:e,drawId:n}){const r=t[n]?.mainSeedAssignments?.find((t=>t.participantId===e)),i=t[n]?.qualifyingSeedAssignments?.find((t=>t.participantId===e)),a={};if(r){const{participantId:t,...e}=r;t&&(a[Hu]={...e})}if(i){const{participantId:t,...e}=i;t&&(a[zu]={...e})}return Object.keys(a).length?a:void 0}function vP({scheduleAttributes:t=["scheduledDate","scheduledTime"],matchUps:e=[]}){if(!Sa(e))return{error:Zt};if(!Array.isArray(t))return{error:xn};const n=e.filter(Boolean).filter((({schedule:e})=>Sy({schedule:e,scheduleAttributes:t}))).reduce(((t,e)=>{const{schedule:n}=e,r=$r(n?.scheduledDate),i=qr(n?.scheduledTime);return r&&i&&(t[r]?t[r].push(e):t[r]=[e]),t}),{});return Object.keys(n).forEach((t=>{n[t].sort(((t,e)=>Yr(qr(t.schedule?.scheduledTime),qr(e.schedule?.scheduledTime))))})),{scheduledMatchUps:n}}function wP(t){const e=[],n={},r={},i={},a=t=>{i[t]||(i[t]={groupParticipantIds:[],teamParticipantIds:[],pairParticipantIds:[],potentialMatchUps:{},scheduleItems:[],opponents:{},matchUps:{},events:{},groups:[],teams:[],draws:{},losses:0,wins:0})},{tournamentRecord:o,participantFilters:s,allTournamentParticipants:c}=t,{relevantParticipantIdsMap:u}=function({processParticipantId:t,tournamentRecords:e,tournamentRecord:n}){if("object"!=typeof n&&"object"!=typeof e)return{error:$};const r=e?Object.values(e).map((t=>t?.participants||[])).flat():n?.participants||[];return{relevantParticipantIdsMap:Object.assign({},...r.map((({participantId:e,participantType:n,individualParticipantIds:r})=>("function"==typeof t&&t(e),{[e]:(r||[]).map((t=>({participantType:Eu,relevantParticipantId:t}))).concat({relevantParticipantId:e,participantType:n})}))))}}({processParticipantId:a,tournamentRecord:o}),d=s?.participantIds,p=t=>{const e=t&&u[t]||[];return e.push(t),e.some((t=>!d||d.includes(t.relevantParticipantId)))?e:[]};return t.withGroupings&&c.forEach((t=>{if(t.participantType===Cu){const e=t.participantId;t?.individualParticipantIds?.forEach((n=>{i[n].groupParticipantIds.includes(e)||(i[n].groupParticipantIds.push(e),i[n].groups.push({participantRoleResponsibilities:t.participantRoleResponsibilities,participantOtherName:t.participantOtherName,participantName:t.participantName,participantId:t.participantId}))}))}if(t.participantType===Ca){const e=t.participantId;t?.individualParticipantIds?.forEach((n=>{i[n]?.teamParticipantIds?.includes(e)||(i[n]?.teamParticipantIds.push(e),i[n]?.teams.push({participantRoleResponsibilities:t.participantRoleResponsibilities,participantOtherName:t.participantOtherName,participantName:t.participantName,participantId:t.participantId,teamId:t.teamId}))}))}if(t.participantType===Ou){const e=t.participantId;t?.individualParticipantIds?.forEach((t=>{i[t]&&!i[t].pairParticipantIds.includes(e)&&i[t].pairParticipantIds.push(e)}))}})),t.withMatchUps&&ph({tournamentRecord:o}),(t.withScheduleItems||t.scheduleAnalysis||t.withStatistics||t.withOpponents||t.withMatchUps||t.withSeeding||t.withEvents||t.withDraws)&&t.tournamentEvents?.forEach((e=>{const d=ri(e,!0,!0),l=_s({event:d}).flightProfile,m=l?.flights?.length||d.drawDefinitions?.length||0;(d.drawDefinitions||[]).forEach(((t,n)=>{if(d?.eventType===Ca){const{extension:r}=gs({element:e.drawDefinitions[n],name:Do});r&&(t.extensions=[r])}}));const{eventId:f,eventName:h,eventType:I,category:g}=d,U={eventId:f,eventName:h,eventType:I,category:g},y=d&&Object.keys(d).filter((t=>t.startsWith("_")));y?.forEach((t=>U[t]=d[t]));const S=d.entries||[],v=`${ou}.${cu}`,{timeItem:w}=Wf({itemType:v,event:d});if(w?.itemValue?.PUBLIC){const{drawIds:t=[],seeding:e}=w.itemValue.PUBLIC||{},r={published:void 0,seedingScaleNames:[],drawIds:[]};e&&Object.assign(r,w.itemValue.PUBLIC.seeding),n[f]={publishedDrawIds:t,publishedSeeding:r}}const T=[...Object.values(Lo)].map((t=>`_${t}`)),P=U&&Object.keys(U).filter((t=>!T.includes(t))).reduce(((t,e)=>(t[e]=U[e],t)),{});S?.filter((t=>t?.participantId)).forEach((t=>{const{participantId:e,entryStage:n,entryStatus:r,entryPosition:o}=t,s=p(e);s?.forEach((({relevantParticipantId:t})=>{i[t]||a(t),i[t].events[f]={...P,partnerParticipantIds:[],entryPosition:o,entryStatus:r,entryStage:n,drawIds:[],eventId:f}}))}));const D=d.drawDefinitions?.map((({drawId:t})=>t))||[];U._flightProfile?.flights?.forEach((t=>{const{drawId:e,drawEntries:n}=t;D.includes(e)||n?.forEach((t=>(({drawEntry:t,drawId:e})=>{const{participantId:n,entryStage:a,entryStatus:o,entryPosition:s}=t,c=p(n);c?.forEach((({relevantParticipantId:t})=>{if(i[t].events[f]||(i[t].events[f]={...P,partnerParticipantIds:[],entryPosition:s,entryStatus:o,entryStage:a,drawIds:[],eventId:f}),!i[t].draws[e]){const n=yP({participantId:t,derivedDrawInfo:r,drawId:e}),c=SP({participantId:t,derivedDrawInfo:r,drawId:e});i[t].draws[e]=di({qualifyingDrawSize:r[e]?.qualifyingDrawSize,drawSize:r[e]?.drawSize,partnerParticipantIds:[],positionAssignments:n,eventDrawsCount:m,seedAssignments:c,entryPosition:s,entryStatus:o,entryStage:a,eventId:f,drawId:e})}const n=i[t].events[f].drawIds;n&&!n?.includes(e)&&i[t].events[f].drawIds.push(e)}))})({drawEntry:t,drawId:e})))}));const{drawDetails:N,derivedInfo:R}=function({eventEntries:t,sortConfig:e,event:n}){const r={},i=Object.assign({},...(n.drawDefinitions??[]).map((i=>{const a=Object.assign({},...(t??[]).filter((t=>t.participantId)).map((t=>({[t.participantId]:t}))),...i.entries.filter((t=>t.participantId)).map((t=>({[t.participantId]:t})))),o=Object.values(a),s=Yd({stageSequence:1,drawDefinition:i,stage:Hu})?.structures?.[0],c=s&&Rp({structure:s})?.positionAssignments,u=c?.length,d=Yd({stageSequence:1,stage:zu,drawDefinition:i})?.structures?.[0],p=s&&Rp({structure:d})?.positionAssignments,l=p?.length,m=s?.seedAssignments,f=d?.seedAssignments,h=(i.structures||[]).sort(((t,n)=>Wd(t,n,e))).map((({structureId:t,structures:e})=>[t,...(e||[]).map((({structureId:t})=>t))])).flat(1/0),I=n?._flightProfile?.flights?.find((t=>t.drawId===i.drawId))?.flightNumber;return r[i.drawId]={qualifyingPositionAssignments:p,qualifyingSeedAssignments:f,mainPositionAssignments:c,mainSeedAssignments:m,orderedStructureIds:h,qualifyingDrawSize:l,flightNumber:I,drawSize:u},{[i.drawId]:{drawType:i.drawType,drawEntries:o}}})));return{derivedInfo:r,drawDetails:i}}({eventEntries:S,event:d});if(Object.assign(r,R),d.eventType===Ca||t.withScheduleItems||t.scheduleAnalysis||t.withStatistics||t.withOpponents||t.withMatchUps||t.withDraws){const e=nh({afterRecoveryTimes:t.scheduleAnalysis,participants:c,nextMatchUps:!0,tournamentRecord:o,inContext:!0,event:d})?.matchUps;e?.forEach((t=>function({relevantParticipantIdsMap:t,participantFilters:e,participantIdMap:n,derivedDrawInfo:r,eventDrawsCount:i,drawDetails:a,eventType:o,matchUp:s}){const{collectionId:c,collectionPosition:u,drawId:d,drawName:p,eventId:l,eventName:m,finishingRound:f,finishingPositionRange:h,processCodes:I,loserTo:g,matchUpId:U,matchUpType:y,matchUpFormat:S,matchUpStatus:v,matchUpStatusCodes:w,matchUpTieId:T,roundName:P,roundNumber:D,roundPosition:N,score:R,sides:b,stage:M,stageSequence:A,schedule:E,structureName:C,structureId:O,tieFormat:F,tieMatchUps:k,tournamentId:x,winnerTo:_,winningSide:L}=s,B=e?.participantIds,V=e=>{const n=e&&t[e]||[];return n.push(e),n.some((t=>!B||B.includes(t.relevantParticipantId)))?n:[]},{winner:j,loser:G}=h||{},q=k?.length&&k.filter((({matchUpType:t})=>t===Ma)).map((({sides:t})=>t.map((({sideNumber:t,participantId:e,participant:n})=>t&&e&&{sideNumber:t,participantId:e,participant:n})))).flat().filter(Boolean)||[];if(o===Nu&&y===Ma){const t=(s.sides?.filter(Boolean)||[]).map((({sideNumber:t,participantId:e,participant:n})=>t&&e&&{sideNumber:t,participantId:e,participant:n})).filter(Boolean);q.push(...t)}if(b?.forEach((e=>{const{participantId:h,sideNumber:k}=e;if(!h)return;const{drawType:B,drawEntries:$}=a[d],W=1===k?R?.scoreStringSide1:R?.scoreStringSide2,H=L&&k===L,z=s.sides.find((t=>t.sideNumber===3-k)),Y=z?.participantId,K=Y&&t[Y]||[],J=H?j:G,Q=$.find((t=>t.participantId===h)),X=V(h),Z=[];q?.filter((t=>t.sideNumber===k)).forEach((t=>{const e=t.participantId;e&&!Z.includes(e)&&(X.push({relevantParticipantId:e,participantType:Ou}),Z.push(e))}));const tt=X.filter((t=>o!==Nu||o===Nu&&[Ma,Ea].includes(y)&&[Ou,ku].includes(t.participantType)||o===Nu&&[Ra,Ma].includes(y)&&[Eu].includes(t.participantType)));tt?.forEach((({relevantParticipantId:t,participantType:e})=>{const{entryStage:a,entryStatus:s,entryPosition:h}=Q||{};if(!n[t])return;if(!n[t].draws[d]){const e=yP({participantId:t,derivedDrawInfo:r,drawId:d}),i=SP({participantId:t,derivedDrawInfo:r,drawId:d});n[t].draws[d]=di({qualifyingDrawSize:r[d]?.qualifyingDrawSize,drawSize:r[d]?.drawSize,partnerParticipantIds:[],positionAssignments:e,seedAssignments:i,entryPosition:h,entryStatus:s,entryStage:a,drawName:p,drawType:B,eventId:l,drawId:d})}n[t].events[l]||(n[t].events[l]={partnerParticipantIds:[],drawIds:[],eventName:m,eventId:l});const k=n[t].events[l].drawIds;let V;if(k&&!k?.includes(d)&&n[t].events[l].drawIds.push(d),e===Eu&&y===Ma){const e=tt.find((e=>e.relevantParticipantId!==t&&e.participantType===Eu));V=e?.relevantParticipantId}const j=K?.filter((t=>y===Ea&&e===ku&&t.participantType===ku||y===Ra&&t.participantType===Eu||y===Ma&&(e===Eu?[Eu,Ou].includes(t.participantType):t.participantType===Ou)))||[];j.forEach((({relevantParticipantId:e,participantType:r})=>{n[t].opponents||(n[t].opponents={}),n[t].opponents[e]={eventId:l,drawId:d,matchUpId:U,participantType:r,participantId:e}}));const G=j.map((({relevantParticipantId:t,participantType:e})=>({participantId:t,participantType:e})));(y!==Ea&&[Eu,Ou].includes(e)||y===Ea&&e===ku)&&(n[t].matchUps[U]=di({collectionId:c,collectionPosition:u,drawId:d,eventId:l,eventType:o,eventDrawsCount:i,finishingRound:f,finishingPositionRange:J,loserTo:g,matchUpId:U,matchUpType:y,matchUpFormat:S,matchUpStatus:v,matchUpStatusCodes:w,matchUpTieId:T,opponentParticipantInfo:G,participantWon:H,partnerParticipantId:V,perspectiveScoreString:W,processCodes:I,roundName:P,roundNumber:D,roundPosition:N,schedule:E,score:R,sides:b,stage:M,stageSequence:A,structureName:C,structureId:O,tieFormat:F,tournamentId:x,winnerTo:_,winningSide:L})),V&&(n[t].events[l].partnerParticipantIds.push(V),n[t].draws[d].partnerParticipantIds.push(V),n[t].events[l].partnerParticipantId=V,n[t].draws[d].partnerParticipantId=V),L&&(H?n[t].wins++:n[t].losses++)}))})),Array.isArray(s.potentialParticipants)){const t=ll(s.potentialParticipants.flat());t?.forEach((t=>{const e=V(t);e?.forEach((({relevantParticipantId:t})=>{n[t].potentialMatchUps[U]=di({drawId:d,eventId:l,eventType:o,matchUpId:U,matchUpType:y,matchUpFormat:S,roundName:P,roundNumber:D,roundPosition:N,schedule:E,tieFormat:F,structureName:C,tournamentId:x,potential:!0})}))}))}}({relevantParticipantIdsMap:u,participantFilters:s,participantIdMap:i,derivedDrawInfo:r,eventDrawsCount:m,drawDetails:N,eventType:I,matchUp:t})))}})),t.tournamentParticipants?.forEach((a=>{const{scheduleConflicts:o,scheduleItems:s}=function(t){const{withScaleValues:e=!0,eventsPublishStatuses:n,withEvents:r=!0,withDraws:i=!0,participantIdMap:a,scheduleAnalysis:o,derivedDrawInfo:s,usePublishState:c,withStatistics:u,withOpponents:d,withMatchUps:p,withSeeding:l,participant:m,withISO2:f,withIOC:h}=t,I=[],g=[];if((h||f)&&qf({participant:m,withIOC:h,withISO2:f}),e){const{ratings:t,rankings:e}=ms({participant:m});m.rankings=e,m.ratings=t}const U=m?.participantId;if(!U||!a[U])return{};const{potentialMatchUps:y,opponents:S,matchUps:v,events:w,losses:T,draws:P,wins:D}=a[U],N=D+T,R={statCode:zo,denominator:N,numerator:D,statValue:N&&D/N},b=Object.values(P),M=Object.values(w);if(i&&b){m.draws=b;for(const t of b){const e=n[t.eventId]?.publishedSeeding;if(!c||e?.published&&(0===e?.drawIds?.length||e?.drawIds?.includes(t.drawId))){const e=SP({drawId:t.drawId,derivedDrawInfo:s,participantId:U});e&&(t.seedAssignments=e)}}}if(r&&M&&(m.events=M,l)){const t=Object.assign({},...(m.timeItems||[]).filter((({itemType:t})=>t.split(".")[1]===ps)).map((({itemType:t,itemValue:e})=>({[t]:e}))));for(const e of M){const r=t=>[ds,ps,e.eventType,t].join("."),i=n[e.eventId]?.publishedSeeding,a=(i?.stageSeedingScaleNames&&Object.values(i?.stageSeedingScaleNames)||Array.isArray(i?.seedingScaleNames)&&i.seedingScaleNames||[]).map(r),o=O(Object.keys(t),a),u=!(c&&(Object.keys(t).length||i?.drawIds?.length)&&!o.length);if(u&&o.length){if(i?.stageSeedingScaleNames){const n=Object.keys(i.stageSeedingScaleNames).map((e=>{const n=r(i.stageSeedingScaleNames[e]);return[e,t[n]]})).filter((t=>t[1])).map((t=>({[t[0]]:{seedValue:t[1]}}))),a=Object.assign({},...n);e.seedAssignments=a}else if(o){const n=o.map((e=>t[e]));e.seedValue=n.pop()}}else if(c||"object"!=typeof l){const{categoryName:t,ageCategoryCode:n}=e.category||{};let r;for(const i of[e.eventId,n,t]){const t=yh({scaleAttributes:{eventType:e.eventType,scaleType:ps,scaleName:i},participant:m});if(t.scaleItem){r=t.scaleItem;break}}if(r){const t=r.scaleValue;(!c||i?.published&&(0===i?.drawIds?.length||i?.drawIds?.includes(e.drawId)))&&(e.seedValue=t)}}else{const n=Object.keys(l).map((e=>{const n=r(l[e]);return[e,t[n]]})).filter((t=>t[1])).map((t=>({[t[0]]:{seedValue:t[1]}}))),i=Object.assign({},...n);e.seedAssignments=i}if(e.drawIds?.length)for(const t of e.drawIds||[]){const n=i?.drawIds?.length&&!i?.drawIds?.includes(t);if(u&&!n){const n=SP({drawId:t,derivedDrawInfo:s,participantId:U});if(n&&e.seedAssignments)for(const t of Object.keys(e.seedAssignments))e.seedAssignments[t]=n[t];else e.seedAssignments=n}}}}const A=Object.values(S).flat();d&&A?.length&&(m.opponents=A,b?.forEach((t=>{t.opponents=A.filter((e=>e.drawId===t.drawId))})));const E=Object.values(y),C=Object.values(v);p&&(m.potentialMatchUps=E,m.matchUps=C);const F=C.concat(E),k=vP({matchUps:F})?.scheduledMatchUps||[],{scheduledMinutesDifference:x}=o||{};return Object.keys(k).forEach((t=>{k[t].filter(Boolean).forEach(((e,n)=>{const{schedule:{scheduledTime:r,timeAfterRecovery:i,typeChangeTimeAfterRecovery:a},matchUpStatus:o,roundPosition:s,structureName:c,matchUpType:u,roundNumber:d,matchUpId:p,drawId:l,score:m}=e;g.push({...e.schedule,scheduledTime:qr(e.schedule?.scheduledTime),roundPosition:s,structureName:c,matchUpType:u,roundNumber:d,matchUpId:p,drawId:l});const f=o===Ki||[ca,Zi].includes(o)&&!Yp({score:m});if(r&&!f){const o=jr(r),s=k[t].slice(n+1);for(const t of s)if(t.matchUpStatus!==Ki&&(![ca,Zi].includes(t.matchUpStatus)||Yp(t))&&t.schedule?.scheduledTime){const n=e.matchUpType!==t.matchUpType&&a||i,r=e.drawId===t.drawId,s=e.potential&&t.potential,c=jr(t.schedule?.scheduledTime)-o;!(x&&!isNaN(x)?c<=x:jr(n)>jr(t.schedule?.scheduledTime))||s&&r||I.push({priorScheduledMatchUpId:t.matchUpId,matchUpIdWithConflict:p})}}}))})),u&&(m.statistics=[R]),{scheduleConflicts:I,scheduleItems:g}}({...t,eventsPublishStatuses:n,participantIdMap:i,derivedDrawInfo:r,participant:a});if(t.withSignInStatus){const{timeItem:t}=$f({itemType:Au,element:a});a.signedIn=t?.itemValue===xu}if(t.withScheduleItems&&(a.scheduleItems=s),t.scheduleAnalysis&&(a.scheduleConflicts=o,o?.length&&!e.includes(a.participantId)&&e.push(a.participantId)),!1!==t.withGroupings){const t=i[a.participantId];a.groupParticipantIds=t?.groupParticipantIds,a.pairParticipantIds=t?.pairParticipantIds,a.teamParticipantIds=t?.teamParticipantIds,a.groups=t?.groups,a.teams=t?.teams}t.withTeamMatchUps})),{participantIdsWithConflicts:e,eventsPublishStatuses:n}}const TP="COMPETITOR",PP="OTHER",DP={ADMINISTRATION:"ADMINISTRATION",CAPTAIN:"CAPTAIN",COACH:"COACH",COMPETITOR:TP,MEDIA:"MEDIA",MEDICAL:"MEDICAL",OFFICIAL:"OFFICIAL",OTHER:PP,SECURITY:"SECURITY"};function NP({individualParticipantIds:t,groupingParticipantId:e,removeFromOtherTeams:n,tournamentRecord:r}){const i="addIndividualParticipantIds";if(!r)return Oi({result:{error:$},stack:i});if(!e||!t)return Oi({result:{error:me},stack:i});const a=r.participants||[],o=a.find((t=>t.participantId===e));if(!o)return Oi({result:{error:Be},stack:i});if(o?.participantType&&![Fu,Cu].includes(o.participantType))return Oi({context:{participantType:o.participantType},result:{error:Fe},stack:i});const s=t.filter((t=>{const e=a.find((e=>e.participantId===t));return e?.participantType!==Eu}));if(s.length)return Oi({result:{error:Ce,invalidParticipantIds:s},stack:i});o.individualParticipantIds||(o.individualParticipantIds=[]);const c=o.individualParticipantIds,u=t.filter((t=>!c.includes(t)));u.length&&(n&&oT({individualParticipantIds:u,tournamentRecord:r}),o.individualParticipantIds=o.individualParticipantIds.concat(...u));const{topics:d}=fr();if(d.includes(Ic)){const t=a.find((({participantId:t})=>t===e));dr({topic:Ic,payload:{participants:[t]}})}return function({individualParticipantIds:t,groupingParticipantId:e,tournamentRecord:n}){const r=(n.events||[]).filter((t=>t?.eventType===Du&&t?.entries?.some((t=>t.participantId===e)))),i=e=>!t.includes(e.participantId);for(const a of r){a.entries=(a.entries||[]).filter(i);const{flightProfile:t}=_s({event:a});t?.flights?.forEach((t=>{t.drawEntries=(t.drawEntries||[]).filter(i)})),a?.drawDefinitions?.forEach((t=>{t.entries=(t.entries||[]).filter(i)}))}}({individualParticipantIds:t,groupingParticipantId:e,tournamentRecord:r}),{groupingParticipant:ri(o,!1,!0),added:u.length,...L}}function RP({addParticipants:t=!0,participantAttribute:e,tournamentRecord:n,personAttribute:r,teamNames:i,accessor:a,uuids:o}){if(!n)return{error:$};const s={},c=(n.participants||[]).filter((({participantType:t,participantRole:e})=>t===Eu&&e===TP));let u=0;for(const f of c){const t=a&&ai({element:f,accessor:a})?.value||r&&f.person?.[r]||e&&f[e];if(t){if(!Object.keys(s).includes(t)){s[t]={participantName:i?.[u]||t,participantId:o?.pop()||hi(),individualParticipantIds:[],participantRole:TP,participantType:Fu};const n={name:Po,value:r||e};Bs({element:s[t],extension:n}),u+=1}s[t].individualParticipantIds.push(f.participantId)}}const d=Object.keys(s),p=(n.participants||[]).map((t=>{if(t.participantType!==Fu)return;if(t.participantRole!==TP)return;const{extension:e}=tc({name:Po,element:t}),n=e?.value;return d.includes(n)?t.participantId:void 0})).filter(Boolean);let l=0;const m=[];return Object.keys(s).forEach((e=>{const r=s[e],{participantId:i}=r;p.includes(i)||(n.participants||(n.participants=[]),t&&n.participants.push(r),m.push(r),l++)})),t&&l?(dr({payload:{tournamentId:n.tournamentId,participants:m},topic:ic}),{...L,participantsAdded:l}):m.length?{...L,newParticipants:m}:{error:De}}function bP({personFormat:t,person:e}){const n=t=>t.replace(/\W/g,""),r=t=>t.toLowerCase().indexOf("l")<t.toLowerCase().indexOf("f"),i=t=>t.indexOf(",")>=0;if(!e)return;const a=t.indexOf(" ")>0?" ":"";let o=Ig(e?.standardGivenName??""),s=Ig(e?.standardFamilyName??"");if(!t)return`${o}${a}${s}`;!(t=>t.toLowerCase().indexOf("f.")>=0)(t)||i(t)||r(t)||(o=`${o[0]}.`),(t=>/^[a-z]*$/.test(n(t)))(t)?(o=o.toLowerCase(),s=s.toLowerCase()):(t=>/^[A-Z]*$/.test(n(t)))(t)?(o=o.toUpperCase(),s=s.toUpperCase()):(t=>/^[LAST]{4}/.test(n(t)))(t)&&(s=s.toUpperCase());let c=`${o}${a}${s}`;return(t=>t.toLowerCase().indexOf("f")<0)(t)?c=s:r(t)&&(c=i(t)?`${s},${a}${o}`:`${s}${a}${o}`),c}function MP({participantMap:t,participant:e,formats:n}){const{participantType:r,individualParticipantIds:i,person:a}=e,o=r&&n[r];if(r!==ku&&o){const{personFormat:n,doublesJoiner:s}=o;r===Eu&&(e.participantName=bP({person:a,personFormat:n})),r===Ou&&(e.participantName=i?.map((e=>{const r=t[e]?.person;return bP({person:r,personFormat:n})})).filter(Boolean).join(s??"/"))}}function AP(t){const{updateParticipantName:e=!0,groupingParticipantId:n,removeFromOtherTeams:r,tournamentRecord:i,pairOverride:a,participant:o}=t;if(!i)return{error:$};if(!o)return{error:xe};if(!o.participantId)return Qg({tournamentRecord:i,participant:o});const{participant:s}=hs({participantId:o.participantId,tournamentRecord:i});if(!s)return Qg({tournamentRecord:i,participant:o});const{participantRoleResponsibilties:c,individualParticipantIds:u,participantOtherName:d,participantName:p,participantRole:l,participantType:m,onlineResources:f,contacts:h,person:I}=o;if(m&&s.participantType!==m)return{error:Re};const g={};if(h&&(g.contacts=h),f&&(g.onlineResources=f),p&&"string"==typeof p&&(g.participantName=p),d&&"string"==typeof d&&(g.participantOtherName=d),Array.isArray(u)){const{participants:t}=sU({participantFilters:{participantTypes:[Lu.INDIVIDUAL]},tournamentRecord:i}),n=t?.map(ml);if(n){const r=u.filter((t=>"string"==typeof t&&n.includes(t)));([Cu,Ca].includes(m||s.participantType)||m===Ou&&(2===r.length||a))&&(g.individualParticipantIds=r),s.participantType===Lu.PAIR&&e&&(g.participantName=function({individualParticipants:t,newValues:e}){const n=e.individualParticipantIds;let r=t.filter((({participantId:t})=>n.includes(t))).map((({person:t})=>t?.standardFamilyName)).filter(Boolean).sort().join("/");1===n.length&&(r+="/Unknown");return r}({individualParticipants:t,newValues:g}))}}return Object.keys(DP).includes(l)&&(g.participantRole=l),Object.keys(Lu).includes(m)&&(g.participantType=m),Array.isArray(c)&&(g.participantRoleResponsibilties=c),s.participantType===Lu.INDIVIDUAL&&I&&function({updateParticipantName:t,existingParticipant:e,newValues:n,person:r}){const i={},{standardFamilyName:a,standardGivenName:o,nationalityCode:s,personId:c,sex:u}=r;u&&Object.keys(Gp).includes(u)&&(i.sex=u);let d;c&&"string"==typeof c&&(i.personId=c);s&&"string"==typeof s&&(p=s,Fm.flatMap((({iso:t,ioc:e})=>[t,e])).filter(Boolean).includes(p)||""===s)&&(i.nationalityCode=s);var p;a&&"string"==typeof a&&a.length>1&&(i.standardFamilyName=a,d=!0);o&&"string"==typeof o&&o.length>1&&(i.standardGivenName=o,d=!0);if(d&&t){const t=`${i.standardGivenName} ${i.standardFamilyName}`;n.participantName=t}Object.assign(e.person,i)}({updateParticipantName:e,existingParticipant:s,newValues:g,person:I}),Object.assign(s,di(g)),n&&NP({individualParticipantIds:[s.participantId],groupingParticipantId:n,removeFromOtherTeams:r,tournamentRecord:i}),dr({topic:Ic,payload:{tournamentId:i.tournamentId,participants:[s]}}),{participant:ri(s),...L}}function EP({drawDefinition:t,timeItem:e}){if(!t)return{error:J};if(!e)return{error:wn};const n=e&&Object.keys(e),r=["itemType","itemValue"];if(!(r.filter((t=>n.includes(t))).length===r.length))return{error:Sn};t.timeItems||(t.timeItems=[]);const i=(new Date).toISOString();return Object.assign(e,{createdAt:i}),t.timeItems.push(e),rl({drawDefinition:t}),{...L}}function CP(t){const{removePriorValues:e,tournamentRecord:n,participantId:r,scaleItem:i}=t;let a,o;if(!OP({scaleItem:i}))return{error:Nn};if(r&&Array.isArray(n.participants)&&(o=n.participants.find((t=>t.participantId===r)),o)){const t=FP({removePriorValues:e,participant:o,scaleItem:i});if(t.error)return t;a=!t.valueChanged;const{topics:r}=fr();r.includes(Ic)&&dr({topic:Ic,payload:{tournamentId:n.tournamentId,participants:[o]}})}return a&&{...L,info:jn,existingValue:i?.scaleValue}||o&&{...L,newValue:i?.scaleValue}||{error:Be}}function OP({scaleItem:t}){const e=t&&Object.keys(t),n=["scaleType","eventType","scaleName"];return!!(n.filter((t=>e?.includes(t))).length===n.length)}function FP({removePriorValues:t,participant:e,scaleItem:n}){if(!e)return{error:xe};const r=n&&Object.keys(n),i=["scaleType","eventType","scaleName"];if(!(i.filter((t=>r.includes(t)&&n[t])).length===i.length))return{error:Nn};const a=(new Date).toISOString();e.timeItems||(e.timeItems=[]);const{scaleItem:o}=yh({scaleAttributes:n,participant:e}),s=t=>[void 0,null,""].includes(t),c=!(s(o?.scaleValue)&&s(n.scaleValue))&&JSON.stringify(o?.scaleValue)!==JSON.stringify(n.scaleValue);if(c){const{scaleType:r,eventType:i,scaleName:o}=n,s=[ds,r,i,o].join("."),c=di({itemValue:n.scaleValue,itemDate:n.scaleDate,createdAt:a,itemType:s});n.scaleId&&(c.itemSubTypes=[n.scaleId]),t&&(e.timeItems=e.timeItems.filter((t=>t.itemType!==s))),e.timeItems.push(c)}return{...L,valueChanged:c,newValue:n.scaleValue}}const kP={getTournamentPenalties:mU,modifyPenalty:fU,removePenalty:lU,addPenalty:pU,createGroupParticipant:function({individualParticipantIds:t=[],participantRoleResponsibilities:e,participantRole:n=PP,tournamentRecord:r,participantId:i,groupName:a}){if(!r)return{error:$};if(!a)return{error:me,info:"Missing groupName"};if(!Array.isArray(t))return{info:"Invalid individualParticipantIds",error:xn};const o=(sU({participantFilters:{participantTypes:[Eu]},tournamentRecord:r}).participants??[]).map((t=>t.participantId));for(const d of t)if(!o.includes(d))return{error:Fe,participantId:d};const s=di({participantId:i||hi(),participantRoleResponsibilities:e,participantName:a,individualParticipantIds:t,participantType:Cu,participantRole:n}),c=Qg({participant:s,tournamentRecord:r});if(c.error)return c;const{topics:u}=fr();return u.includes(ic)&&dr({topic:ic,payload:{tournamentId:r.tournamentId,participants:[s]}}),{...L,participant:ri(s)}},scaledTeamAssignment:function({clearExistingAssignments:t=!0,individualParticipantIds:e,reverseAssignmentOrder:n,initialTeamIndex:r=0,scaledParticipants:i=[],teamParticipantIds:a,tournamentRecord:o,scaleAttributes:s,teamNameBase:c,teamsCount:u,eventId:d,event:p}){if(!o)return{error:$};if(!Array.isArray(a)&&!v(u)&&!d||!v(r)||i&&!Array.isArray(i)||s&&("object"!=typeof s||!Object.keys(s).length))return{error:xn};if(!s&&!i.length||!i&&(!e||!s))return{error:me,info:"Missing scaling details"};if(d&&!a){if(p?.eventType!==Nu)return{error:Mt};a=p?.entries?.filter((({entryStatus:t})=>t===Qd)).map(ml)}if(!a?.length&&!u)return{info:"Missing teamParticipantIds or teamsCount",error:me};let l=e||i.map((({participantId:t})=>t));n&&(a?.reverse(),r+=1),r>(a?.length||0)-1&&(r=0);const m=a?.slice(r).concat(...a.slice(0,r))||[],f=[];for(const g of o.participants||[]){const{participantId:t,participantType:e}=g;if(m.includes(t)){if(e!==ku)return{error:Fe,participant:g};f.push(g)}}if(u&&f.length<u){const t=c||"Team",e=E(0,u-(f?.length||0)).map((e=>({participantName:`${t} ${e+1}`,participantType:ku,participantRole:TP}))),{participants:n=[]}=Xg({participants:e,returnParticipants:!0,tournamentRecord:o}),r=n.map(ml),i=o.participants?.filter((({participantId:t})=>r.includes(t)))??[];f.push(...i)}if(!f.length)return{error:Ln};if(t)for(const g of f)g.individualParticipantIds=[];else{const t=f.map((t=>t)).flat();e?.length?l=l.filter((e=>!t.includes(e))):i=i?.filter((({participantId:e})=>!t.includes(e)))}if(!e?.length&&!i?.length)return{error:An,info:"Nothing to be done"};if(!i.length){for(const t of o.participants||[]){const{participantId:e,participantType:n}=t;if(!l.includes(e))continue;if(n!==Eu)return{error:Fe,participant:t};const r=yh({scaleAttributes:s,participant:t})?.scaleItem,a={participantId:e,scaleValue:s?.accessor?r?.scaleValue?.[s?.accessor]:r?.scaleValue};i.push(a)}if(!i.length)return{error:Be}}i.sort(((t,e)=>s?.sortOrder?(e?.scaleValue||0)-(t?.scaleValue||0):(t?.scaleValue||1/0)-(e?.scaleValue||1/0)));for(const g of i)if(!g.participantId)return{error:xn,scaledParticipant:g};let h=0;for(;h<i.length;){for(const t of f){if(h+1>i.length)break;const e=i[h];t.individualParticipantIds.push(e.participantId),h++}f.reverse()}const I=f.map(ml);for(const g of o.events||[]){if(g.eventType!==Nu)continue;const t=(g.entries||[]).filter((t=>I.includes(t.participantId)));for(const e of t){const t=e.participantId,n=f.find((e=>e.participantId===t)),r=n?.individualParticipantIds;g.entries=(g.entries||[]).filter((t=>!r.includes(t.participantId))),(g.drawDefinitions||[]).forEach((t=>{t.entries=(t.entries||[]).filter((t=>!r.includes(t.participantId)))}));const{flightProfile:i}=_s({event:g});(i?.flights||[]).forEach((t=>{t.drawEntries=(t.drawEntries||[]).filter((t=>!r.includes(t.participantId)))}))}}return{...L,scaledParticipants:i}},deleteParticipants:sT,addParticipants:Xg,addParticipant:Qg,addPersons:function({participantRole:t=TP,tournamentRecord:e,persons:n}){if(!e)return{error:$};if(!Array.isArray(n))return{error:xn};if(!Object.keys(DP).includes(t))return{error:Oe};const r=(e.participants||[]).map((({person:t})=>t?.personId)).filter(Boolean),i=[],a=n.filter((t=>t&&(!t.personId||!r.includes(t.personId)))).map((t=>(t.personId||(t.personId=hi()),i.push(t.personId),t)));let o=0,s=0,c=Xg({participants:a.map((e=>{return di({extensions:e.participantExtensions,timeItems:e.participantTimeItems,participantType:Eu,participantRole:t,person:(n=e,r=["participantExtensions","participantTimeItems","pairedPersons"],Object.assign({},...Object.keys(n).filter((t=>!r.includes(t))).map((t=>({[t]:n[t]})))))});var n,r})),tournamentRecord:e});if(c.error)return c;s=c.addedCount||0;const u=[],d=sU({participantFilters:{participantTypes:[Eu]},tournamentRecord:e})?.participants||[];if(t===TP&&n.filter((({pairedPersons:t})=>t)).forEach((({personId:t,pairedPersons:e})=>{Array.isArray(e)&&e.forEach((e=>{const n=[t,e.personId].map((t=>fs({tournamentParticipants:d,personId:t}))).filter(Boolean);if(2===n.length){const t=n.map(ml);u.push(di({extensions:e.participantExtensions,timeItems:e.timeItems,participantRole:TP,individualParticipantIds:t,participantType:Ou}))}}))})),u.length){if(c=Xg({participants:u,tournamentRecord:e}),c.error)return c;o=c.addedCount||0}const p=s+o;return{...L,addedCount:p,newPersonIds:i}},addIndividualParticipantIds:NP,removeIndividualParticipantIds:iT,modifyIndividualParticipantIds:function({individualParticipantIds:t,groupingParticipantId:e,tournamentRecord:n}){const r="modifyIndividualParticipantIds";if(!n)return Oi({result:{error:$},stack:r});if(!e||!t)return Oi({result:{error:me},stack:r});const i=n.participants||[],a=i.find((t=>t.participantId===e));if(!a)return Oi({result:{error:Be},stack:r});if(![Fu,Cu].includes(a.participantType))return Oi({result:{error:Fe},context:{participantType:a.participantType},stack:r});const o=t.filter((t=>{const e=i.find((e=>e.participantId===t));return e?.participantType!==Eu}));if(o.length)return Oi({result:{error:Ce,invalidParticipantIds:o},stack:r});const s=a.individualParticipantIds||[],c=t.filter((t=>!s.includes(t))),u=s.filter((e=>!t.includes(e))),d=NP({individualParticipantIds:c,groupingParticipantId:e,tournamentRecord:n});if(d.error)return Oi({result:d,stack:r});const p=iT({individualParticipantIds:u,groupingParticipantId:e,tournamentRecord:n});if(p.error)return Oi({result:p,stack:r});const{topics:l}=fr();if(l.includes(Ic)){const t=i.find((({participantId:t})=>t===e));dr({topic:Ic,payload:{tournamentId:n.tournamentId,participants:[t]}})}return{...d,...p}},removeParticipantIdsFromAllTeams:oT,getParticipantMembership:function({tournamentRecord:t,participantId:e}){if(!t)return{error:$};if(!e)return{error:Le};const{participants:n}=sU({participantFilters:{participantTypes:[Fu,Ou,Cu]},tournamentRecord:t});return(n||[]).filter((t=>t.individualParticipantIds?.includes(e))).reduce(((t,e)=>{const n=e.participantType;return n&&(t[n]||(t[n]=[]),t[n].push(e)),t}),{})},generateTeamsFromParticipantAttribute:RP,regenerateParticipantNames:function({tournamentRecord:t,formats:e}){if(!t)return{error:$};if(!si(e))return{error:me};const n=t.participants??[],r=ci(n,"participantId");for(const i of n)MP({participant:i,participantMap:r,formats:e});return{...L}},getParticipantIdFinishingPositions:function({tournamentRecord:t,drawDefinition:e,byeAdvancements:n=!1}){return t?VT({tournamentParticipants:t.participants,byeAdvancements:n,drawDefinition:e}):{error:$}},modifyParticipant:AP,modifyParticipantName:function({tournamentRecord:t,participantName:e,participantId:n}){if(!t)return{error:$};if(!n)return{error:Le};if(!e)return{error:me,info:"Missing participantName"};const{participant:r}=hs({tournamentRecord:t,participantId:n});if(!r)return{error:Be};r.participantName=e;const{topics:i}=fr();return i.includes(Ic)&&dr({topic:Ic,payload:{tournamentId:t.tournamentId,participants:[r]}}),{...L}},modifyParticipantOtherName:function({tournamentRecord:t,participantId:e,participantOtherName:n}){if(!t)return{error:$};if(!e)return{error:Le};const{participant:r}=hs({tournamentRecord:t,participantId:e});if(!r)return{error:Be};r.participantOtherName=n;const{topics:i}=fr();return i.includes(Ic)&&dr({topic:Ic,payload:{tournamentId:t.tournamentId,participants:[r]}}),{...L}},mergeParticipants:function({participants:t=[],tournamentRecord:e,arraysToMerge:n}){if(!e)return{error:$};e.participants||(e.participants=[]);const r=t.filter(sl).map((t=>({[t.participantId]:t}))),i=Object.assign({},...r),a=[];e.participants=e.participants.map((t=>{if(i[t.participantId]){const e=cU(t,i[t.participantId],n);return a.push(e),e}return t}));const o=e.participants.map(ml),s=t.filter((({participantId:t})=>!o.includes(t))),{topics:c}=fr();return s.length&&(e.participants=e.participants.concat(...s),c.includes(ic)&&dr({topic:ic,payload:{participants:s}})),a.length&&c.includes(Ic)&&dr({topic:Ic,payload:{tournamentId:e.tournamentId,participants:a}}),{modifiedParticipantsCount:a.length,newParticipantsCount:s.length,...L}},getPairedParticipant:Vu,filterParticipants:aU,setParticipantScaleItem:CP,setParticipantScaleItems:function(t){const{scaleItemsWithParticipantIds:e=[],removePriorValues:n,tournamentRecord:r,auditData:i,context:a}=t;if(!r)return{error:$};if(!r.participants)return{error:_e};let o=0;const s={},c=[];for(const p of e){const t=p?.participantId;if(Array.isArray(p?.scaleItems))for(const e of p.scaleItems){if(!OP({scaleItem:e}))return{error:Nn};Array.isArray(s[t])||(s[t]=[]),s[t].push(e)}}r.participants.forEach((t=>{const{participantId:e}=t||{};Array.isArray(s[e])&&s[e].forEach((e=>{FP({participant:t,scaleItem:e,removePriorValues:n}),c.push(t),o++}))}));const u=o?void 0:bn,{topics:d}=fr();if(d.includes(Ic)&&o&&dr({topic:Ic,payload:{tournamentId:r.tournamentId,participants:c}}),a){const{eventId:t,drawId:e,...n}=a,i=n.scaleAttributes?.scaleType&&[n.scaleAttributes.scaleType];if(Object.keys(n).length){const a={itemType:ac,itemValue:n};if(i&&(a.itemSubTypes=i),e||t){const{drawDefinition:n,event:i}=Ls({tournamentRecord:r,eventId:t,drawId:e});e&&EP({drawDefinition:n,timeItem:a}),t&&lI({event:i,timeItem:a})}else pI({tournamentRecord:r,timeItem:a})}}return i&&d.includes(sc)&&dr({topic:sc,payload:i}),di({...L,modificationsApplied:o,info:u})},modifyParticipantsSignInStatus:function({tournamentRecord:t,participantIds:e,signInState:n}){if(!t)return{error:$};if(!Array.isArray(e))return{error:me};if(![xu,_u].includes(n))return{error:xn,signInState:n};const r=t.participants||[];if(!r.length)return{error:_e};const i=r.map(ml),a=e.filter((t=>!i.includes(t)));if(a.length)return{error:xn,context:{invalidParticipantIds:a}};const o=[],s=(new Date).toISOString();for(const u of r){const{participantId:r}=u;if(e.includes(r)){const e=dI({duplicateValues:!1,tournamentRecord:t,participantId:r,timeItem:{itemType:Au,itemValue:n,createdAt:s}});if(e.error)return e;o.push(u)}}const{topics:c}=fr();return o.length&&c.includes(Ic)&&dr({topic:Ic,payload:{tournamentId:t.tournamentId,participants:o}}),{...L}},getParticipantEventDetails:function({tournamentRecord:t,participantId:e}){if(!t)return{error:$};if(!e)return{error:Le};const n=[e].concat((t.participants||[]).filter((t=>t?.participantType&&[Fu,Ou].includes(t.participantType)&&t.individualParticipantIds?.includes(e))).map((t=>t.participantId)));return{eventDetails:(t.events||[]).filter((t=>k((t?.entries||[]).map((t=>t.participantId)),n))).map((t=>({eventName:t.eventName,eventId:t.eventId})))}},getEligibleVoluntaryConsolationParticipants:function(t){return t.tournamentRecord?LT(t):{error:$}},findParticipant:function({tournamentRecord:t,policyDefinitions:e,convertExtensions:n,participantId:r,personId:i}){return t?"string"!=typeof r&&"string"!=typeof i?{error:me}:{participant:ri(fs({tournamentParticipants:t.participants||[],policyDefinitions:e,participantId:r,personId:i}),n,!0)}:{error:$}},getTournamentParticipants:function(t){const{participantFilters:e={},convertExtensions:n,policyDefinitions:r,withScheduleItems:i,scheduleAnalysis:a,withSignInStatus:o,withTeamMatchUps:s,tournamentRecord:c,usePublishState:u,withScaleValues:d,withStatistics:p,withGroupings:l,withOpponents:m,withMatchUps:f,withSeeding:h,withEvents:I,withDraws:g,inContext:U,withISO2:y,withIOC:S}=t;if(!c)return{error:$};if(!c.participants)return{error:_e};const v=c.participants.map((t=>ri(t,n)));if("object"!=typeof e)return{error:On,participantFilters:e};U&&v?.forEach((t=>{[Ou,Fu,Cu].includes(t.participantType)&&(t.individualParticipants=t.individualParticipantIds?.map((t=>{const e=ri(c.participants.find((e=>e.participantId===t)),n,!0);if(d){const{ratings:t,rankings:n}=ms({participant:e});e.ratings=t,e.rankings=n}return(S||y)&&qf({participant:e,withISO2:y,withIOC:S}),e})))}));let w,T,P=e?aU({participants:v,participantFilters:e,tournamentRecord:c}):v;if(i||o||a||d||p||l||m||f||h||I||g||y||S){const t=wP({tournamentEvents:c.events,allTournamentParticipants:v,tournamentParticipants:P,participantFilters:e,withScheduleItems:i,withSignInStatus:o,tournamentRecord:c,scheduleAnalysis:a,withTeamMatchUps:s,usePublishState:u,withScaleValues:d,withStatistics:p,withGroupings:l,withOpponents:m,withMatchUps:f,withSeeding:h,withEvents:I,withDraws:g,withISO2:y,withIOC:S});w=t?.participantIdsWithConflicts,T=t?.eventsPublishStatuses}const D=r?.[eo];return D?.participant&&(P=P.map((t=>li({template:D.participant,source:t})))),{participantIdsWithConflicts:w,tournamentParticipants:P,eventsPublishStatuses:T}},getParticipantSchedules:function({participantFilters:t={},tournamentRecord:e}){if(!e)return{error:$};if("object"!=typeof t)return{error:On,context:{participantFilters:t}};const n=th({tournamentRecord:e,contextFilters:{eventIds:t.eventIds}}).matchUps||[],r=Object.assign({},...n.map((t=>({[t.matchUpId]:t})))),i=n.filter((({schedule:t})=>t&&Object.keys(t).length)),a=ph({tournamentRecord:e,matchUps:n}).sourceMatchUpIds||[],o={};for(const s of i){const{sides:t}=s;let e;const n=t?.map((t=>{if(t.participant)return[t.participant].concat(...t.participant.individualParticipants||[]);a[s.matchUpId]&&!e&&(e=(a[s.matchUpId]||[]).map((t=>r[t])).filter((({winningSide:t,bye:e})=>!t&&!e)))})).filter(Boolean).flat()||[];for(const r of n){const{participantId:t}=r;o[t]||(o[t]={potentialMatchUps:[],participant:r,matchUps:[]}),o[t].matchUps.push(s)}const i=e?.map((({sides:t})=>t)).flat().map((({participant:t})=>t&&[t].concat(...t.individualParticipants||[]))).filter(Boolean).flat()||[];for(const r of i){const{participantId:t}=r;o[t]||(o[t]={potentialMatchUps:[],participant:r,matchUps:[]}),o[t].potentialMatchUps.push(s)}}return{participantSchedules:Object.values(o).filter((({participant:e})=>!(t.participantIds&&!t.participantIds.includes(e.participantId)||t.participantTypes&&!t.participantTypes.includes(e.participantType)))),...L}},getTournamentPersons:function({tournamentRecord:t,participantFilters:e}){if(!t)return{error:$};let n=t.participants||[];e&&(n=aU({participants:n,participantFilters:e,tournamentRecord:t}));const r={},i=t=>{if(t.person){const{personId:e}=t.person;r[e]?r[e].participantIds.push(t.participantId):r[e]={...t.person,participantIds:[t.participantId]}}};return n.forEach((t=>{t.person&&i(t),t.individualParticipants&&t.individualParticipants.forEach(i)})),{tournamentPersons:Object.values(r)}},getParticipants:sU};function xP({drawDefinition:t}){const e=t.links||[],n={},r={};let i=e.map((t=>{const e=t.source.structureId,i=t.target.structureId;return r[i]=r[i]||t.target.feedProfile===sd,n[i]=T([...n[i]||[],e]).filter(Boolean),[t.source.structureId,t.target.structureId]}));const a=i.length;E(0,Math.ceil(a/2)).forEach((()=>{i=E(0,a).map((t=>{const e=i[t],n=i.reduce(((t,n)=>k(e,n)?t.concat(...n):t),[])||[];return T(e.concat(...n))}))}));const o=i[0],s=i.slice(1).reduce(((t,e)=>{return t&&O(n=e,o).length===n.length;var n}),!0),c=[o].filter(Boolean),u=[o].filter(Boolean);(t.structures||[]).forEach((t=>{const{structureId:e,stage:n}=t;c.find((t=>t.includes(e)))||(c.push([e]),n!==Ku&&u.push(e))}));return{allStructuresLinked:s&&1===u.length,sourceStructureIds:n,hasDrawFeedProfile:r,structureGroups:c}}function _P(t){const{tournamentParticipants:e=[],includePositionAssignments:n,policyDefinitions:r,tournamentRecord:i,inContext:a=!0,drawDefinition:o,noDeepCopy:s,sortConfig:c,context:u,event:d}=t;if(!o)return{error:Y};const p=(({matchUpFormat:t,updatedAt:e,drawType:n,drawName:r,drawId:i})=>({matchUpFormat:t,updatedAt:e,drawName:r,drawType:n,drawId:i}))(o);let l,m;const{allStructuresLinked:f,sourceStructureIds:h,hasDrawFeedProfile:I,structureGroups:g}=xP({drawDefinition:o});if(!f)return{error:bt};let U=!1,y=!1;const S=g.map((t=>{const s={},f=t.map((t=>{const{structure:e}=zd({drawDefinition:o,structureId:t}),{seedAssignments:n}=Sp({drawDefinition:o,structure:e});return e?.stage===Hu&&1===e.stageSequence&&(l=n),e?.stage===zu&&1===e.stageSequence&&(m=n),e})).sort(((t,e)=>Wd(t,e,c))).map((t=>{const{structureId:n}=t;let c=[];[Hu,Yu,Ju].includes(t.stage)&&(c=l),t.stage===zu&&(c=m);const{matchUps:f,roundMatchUps:g,roundProfile:S}=qp({seedAssignments:t?.seedAssignments?.length?void 0:c,context:{drawId:p.drawId,...u},tournamentParticipants:e,policyDefinitions:r,tournamentRecord:i,drawDefinition:o,inContext:a,structure:t,event:d}),{positionAssignments:v}=Rp({structure:t}),w=v?.filter(sl).map((t=>{y=!0;const{drawPosition:e,participantId:n}=t,{extension:r}=gs({element:t,name:xo});return r&&{drawPosition:e,participantId:n,participantResult:r.value}})).filter((t=>t?.participantResult)),T=(({stageSequence:t,structureName:e,structureType:n,matchUpFormat:r,stage:i})=>({stageSequence:t,structureName:e,structureType:n,matchUpFormat:r,stage:i}))(t);T.sourceStructureIds=h[n],T.hasDrawFeedProfile=I[n],T.positionAssignments=v,T.structureActive=f.reduce(((t,e)=>{const n=[Qi,Ji,Zi,aa,ca,na,ta,ea].includes(e.matchUpStatus);return t||n||!!e.winningSide||!!e.score?.scoreStringSide1}),!1);const P=f.reduce(((t,e)=>t&&[Ki,Qi,aa,ca,Zi,zi].includes(e.matchUpStatus)),!!f.length);return T.structureCompleted=P,s[n]=P,T.structureActive&&(U=!0),{...T,participantResults:w,seedAssignments:c,roundMatchUps:g,roundProfile:S,structureId:n}}));return f.forEach((t=>{n||delete t.positionAssignments,t.sourceStructuresComplete=t.sourceStructureIds?.every((t=>s[t]))})),f})).flat();return p.drawActive=U,p.participantPlacements=y,p.drawGenerated=S?.reduce(((t,e)=>t||!!e?.roundMatchUps),!1),p.drawCompleted=S?.reduce(((t,e)=>t&&e.structureCompleted),!0),{structures:s?S:ri(S,!1,!0),drawInfo:s?p:ri(p,!1,!0),...L}}function LP(t){const{includePositionAssignments:e,tournamentRecord:n,participantsProfile:r,policyDefinitions:i,usePublishState:a,status:o=su,sortConfig:s,event:c}=t,u=ri(n,!1,!0),d=ri(c,!1,!0);if(!u)return{error:$};if(!d)return{error:At};const{eventId:p}=d,{tournamentId:l,endDate:m}=u,{timeItem:f}=Wf({itemType:`${ou}.${cu}`,event:d}),h=f?.itemValue?.[o],{participants:I}=sU({withGroupings:!0,withEvents:!1,withDraws:!1,...r,tournamentRecord:u}),g=({stage:t})=>!a||!h?.stages?.length||h.stages.includes(t),U=({structureId:t})=>!a||!h?.structureIds?.length||h.structureIds.includes(t),y=(d.drawDefinitions||[]).filter((({drawId:t})=>!a||!h?.drawIds?.length||h.drawIds.includes(t))).map((t=>(({drawInfo:t,structures:e})=>({...t,structures:e}))(_P({context:{eventId:p,tournamentId:l,endDate:m},includePositionAssignments:e,tournamentParticipants:I,noDeepCopy:!0,policyDefinitions:i,tournamentRecord:u,drawDefinition:t,sortConfig:s,event:d})))).map((({structures:t,...e})=>({...e,structures:t?.filter(U)?.filter(g)}))).filter((t=>t.structures?.length)),{tournamentInfo:S}=ey({tournamentRecord:u}),v={tournamentInfo:S,venuesData:(u.venues||[]).map((t=>(({venueData:t})=>({...t}))(kc({tournamentRecord:u,venueId:t.venueId})))),eventInfo:(({eventId:t,eventName:e,eventType:n,eventLevel:r,surfaceCategory:i,matchUpFormat:a,category:o,gender:s,startDate:c,endDate:u,ballType:d,discipline:p})=>({eventId:t,eventName:e,eventType:n,eventLevel:r,surfaceCategory:i,matchUpFormat:a,category:o,gender:s,startDate:c,endDate:u,ballType:d,discipline:p}))(d),drawsData:y};return v.eventInfo.publish={createdAt:f?.createdAt,state:f?.itemValue},{...L,eventData:v}}function BP(t){let{policyDefinitions:e,drawIds:n,structureIds:r,stages:i}=t;const{includePositionAssignments:a,removePriorValues:o,tournamentRecord:s,status:c=su,event:u,drawIdsToRemove:d,drawIdsToAdd:p,stagesToRemove:l,stagesToAdd:m,structureIdsToRemove:f,structureIdsToAdd:h}=t;if(!s)return{error:$};if(!u)return{error:At};if(!e){const{appliedPolicies:t}=Vo({tournamentRecord:s,event:u});e=t}const I=`${ou}.${cu}`,g=u.drawDefinitions?.map((({drawId:t})=>t))||[],{timeItem:U}=Wf({itemType:I,event:u});n||p||d?n||!p?.length&&!d?.length||(n=U?.itemValue?.PUBLIC?.drawIds||[]):n=g,n=(n||[]).filter((t=>!d?.length||!d.includes(t))),p?.length&&(n=T(n.concat(...p.filter((t=>g.includes(t)))))),r||!h?.length&&!f?.length||(r=U?.itemValue?.PUBLIC?.structureIds||[]),r=(r||[]).filter((t=>!f?.length||!f.includes(t))),h?.length&&(r=T(r.concat(...h))),i||!m?.length&&!l?.length||(i=U?.itemValue?.PUBLIC?.stages||[]),i=(i||[]).filter((t=>!l?.length||!l.includes(t))),m?.length&&(i=T(i.concat(...m)));const y=U?.itemValue?.[c];lI({event:u,timeItem:{itemValue:{[c]:{...y,drawIds:n,structureIds:r,stages:i}},itemType:I},removePriorValues:o});const{eventData:S}=LP({includePositionAssignments:a,usePublishState:!0,tournamentRecord:s,policyDefinitions:e,event:u}),v=S?.eventInfo?.publish?.state;return S.drawsData=S.drawsData.filter((({drawId:t})=>v?.PUBLIC?.drawIds.includes(t))),dr({payload:{eventData:S,tournamentId:s.tournamentId},topic:wc}),{...L,eventData:S}}const VP={getTournamentInfo:ey,getVenueData:kc,getCourtInfo:Fc,getAllEventData:function({tournamentRecord:t,policyDefinitions:e}){if(!t)return{error:$};const n=t.events||[],r=t?.participants||[],{tournamentInfo:i}=ey({tournamentRecord:t}),{venues:a}=Ec({tournamentRecord:t}),o=n.map((n=>{const{eventId:i}=n,a=(({eventId:t,eventName:e,eventType:n,eventLevel:r,surfaceCategory:i,matchUpFormat:a,category:o,gender:s,startDate:c,endDate:u,ballType:d,discipline:p})=>({eventId:t,eventName:e,eventType:n,eventLevel:r,surfaceCategory:i,matchUpFormat:a,category:o,gender:s,startDate:c,endDate:u,ballType:d,discipline:p}))(n),o=vs({tournamentRecord:t,event:n}).scheduleTiming,s=(n.drawDefinitions||[]).map((a=>{const s=(({drawId:t,drawName:e,matchUpFormat:n,updatedAt:r})=>({matchUpFormat:n,updatedAt:r,drawName:e,drawId:t}))(a),{abandonedMatchUps:c,completedMatchUps:u,upcomingMatchUps:d,pendingMatchUps:p}=Dl({requireParticipants:!0,tournamentParticipants:r,context:{eventId:i},policyDefinitions:e,tournamentRecord:t,inContext:!0,scheduleTiming:o,drawDefinition:a,event:n});return{drawInfo:s,matchUps:{abandonedMatchUps:c,completedMatchUps:u,upcomingMatchUps:d,pendingMatchUps:p}}})),{timeItem:c}=Wf({itemType:`${ou}.${cu}`,event:n});return Object.assign(a,{publish:c?.itemValue,drawsData:s}),a}));return{allEventData:{tournamentInfo:i,venuesData:a,eventsData:o}}},getEventData:LP,getDrawData:_P,unPublishEventSeeding:function({removePriorValues:t=!0,seedingScaleNames:e,tournamentRecord:n,status:r=su,stages:i,event:a}){if(!n)return{error:$};if(!a)return{error:At};const o=`${ou}.${cu}`,{timeItem:s}=Wf({itemType:o,event:a}),c=s?.itemValue||{[r]:{}};if(c[r]){if(Array.isArray(i)&&c[r].seeding?.stageSeedingScaleNames)for(const t of i)c[r].seeding.stageSeedingScaleNames[t]&&delete c[r].seeding.stageSeedingScaleNames[t];Array.isArray(e)&&c[r].seeding?.seedingScaleNames&&(c[r].seeding.seedingScaleNames=c[r].seeding.seedingScaleNames.filter((t=>!e.includes(t)))),i||e||delete c[r].seeding}return lI({event:a,timeItem:{itemValue:c,itemType:o},removePriorValues:t}),dr({topic:Nc,payload:{tournamentId:n.tournamentId,eventId:a.eventId}}),{...L}},publishEventSeeding:function({removePriorValues:t=!0,stageSeedingScaleNames:e,seedingScaleNames:n,tournamentRecord:r,status:i=su,drawIds:a=[],event:o}){if(!r)return{error:$};if(!o)return{error:At};const s=`${ou}.${cu}`,{timeItem:c}=Wf({itemType:s,event:o}),u=c?.itemValue||{[i]:{}},d=(u[i].seeding?.seedingScaleNames||n)&&{...u[i].seeding?.seedingScaleNames,...n},p=(u[i].seeding?.stageSeedingScaleNames||e)&&{...u[i].seeding?.stageSeedingScaleNames,...e};return u[i].seeding=di({stageSeedingScaleNames:p,seedingScaleNames:d,published:!0,drawIds:a}),lI({event:o,timeItem:{itemValue:u,itemType:s},removePriorValues:t}),dr({topic:Tc,payload:{tournamentId:r.tournamentId,eventId:o.eventId,drawIds:a}}),{...L}},unPublishEvent:function({removePriorValues:t=!0,tournamentRecord:e,status:n=su,event:r}){if(!e)return{error:$};if(!r)return{error:At};const i=`${ou}.${cu}`,{timeItem:a}=Wf({itemType:i,event:r}),o=a?.itemValue||{[n]:{}};return delete o[n].structureIds,delete o[n].drawIds,lI({event:r,timeItem:{itemValue:o,itemType:i},removePriorValues:t}),dr({topic:Dc,payload:{tournamentId:e.tournamentId,eventId:r.eventId}}),{eventId:r.eventId,...L}},publishEvent:BP,unPublishOrderOfPlay:GU,publishOrderOfPlay:qU};function jP({collectionPosition:t,teamParticipantId:e,dualMatchUpSide:n,drawDefinition:r,participantIds:i,collectionId:a}){if(!a||!t||!Array.isArray(i))return{modifiedLineUp:n?.lineUp||[],error:xn};const o=n?.lineUp||ju({participantId:e,drawDefinition:r})?.lineUp,s=[],c=[];return{modifiedLineUp:o?.map((e=>{if(!i.includes(e.participantId))return e;const n=e.collectionAssignments?.filter((n=>{const r=n.collectionId===a&&n.collectionPosition===t;return r&&(n.previousParticipantId&&s.push(n.previousParticipantId),c.push({participantId:e.participantId,...n})),!r}));return{participantId:e.participantId,collectionAssignments:n}})).filter(Boolean)||[],assignmentsRemoved:c,previousParticipantIds:s}}function GP({tournamentRecord:t,drawDefinition:e,tieMatchUpId:n,event:r}){if(!t)return{error:$};if(!e)return{error:lt};if(!r)return{error:Et};const i=wp({drawDefinition:e}),{matchUp:a}=$p({matchUpId:n,drawDefinition:e,matchUpsMap:i});if(!a)return{error:Xt};const{matchUp:o,structure:s}=$p({tournamentParticipants:t.participants,matchUpId:n,inContext:!0,drawDefinition:e,matchUpsMap:i,event:r});if(!o)return{error:Xt};const{collectionPosition:c,drawPositions:u,collectionId:d,matchUpTieId:p,matchUpType:l}=o;if(l&&![ba,Aa].includes(l))return{error:ee};const{positionAssignments:m}=Rp({structure:s}),f=m?.filter((t=>u?.includes(t.drawPosition))),h=f?.map(ui("participantId")),{participants:I}=sU({tournamentRecord:t,participantFilters:{participantTypes:[Fu],participantIds:h}}),{matchUp:g}=$p({matchUpId:p,drawDefinition:e,matchUpsMap:i}),{matchUp:U}=$p({matchUpId:p,inContext:!0,drawDefinition:e,matchUpsMap:i}),y=Ri({matchUp:g,drawDefinition:e,structure:s,event:r})?.tieFormat;return{inContextDualMatchUp:U,inContextTieMatchUp:o,relevantAssignments:f,collectionPosition:c,teamParticipants:I,collectionId:d,matchUpType:l,dualMatchUp:g,tieMatchUp:a,tieFormat:y,structure:s,...L}}function qP(t){const e=GP(t);if(e.error)return e;const n="assignTieMatchUpParticipantId";let r=t.teamParticipantId;const{tournamentRecord:i,drawDefinition:a,participantId:o,event:s}=t;if(!o)return Oi({result:{error:Le},stack:n});if(t.sideNumber&&![1,2].includes(t.sideNumber))return Oi({result:{error:de},stack:n});const{inContextDualMatchUp:c,inContextTieMatchUp:u,relevantAssignments:d,collectionPosition:p,teamParticipants:l,collectionId:m,matchUpType:f,dualMatchUp:h,tieFormat:I}=e,g=u?.sides?.flatMap((t=>t.participant?.individualParticipantIds||t.participant?.participantId||[]));if(g?.includes(o))return Oi({result:{...L},stack:n});r=r||t.sideNumber&&c?.sides?.find((e=>e.sideNumber===t.sideNumber))?.participantId;const U=sU({participantFilters:{participantIds:[o]},tournamentRecord:i})?.participants?.[0];if(!U)return Oi({result:{error:Be},stack:n});const{appliedPolicies:y}=Vo({tournamentRecord:i,drawDefinition:a,event:s}),S=t.policyDefinitions?.[Xa]||y?.[Xa]||gS[Xa];if(S?.participants?.enforceGender&&[Lp,jp].includes(u?.gender)&&u?.gender!==U.person?.sex)return{error:Ae,info:"Gender mismatch"};const{individualParticipantIds:v,participantType:w}=U;if(f===ba&&w!==Eu)return{error:Fe};const T=w===Eu?[o]:v,P=r&&l?.find((({participantId:t})=>t===r))||l?.find((({individualParticipantIds:t})=>k(T,t)));if(!P)return{error:Ln};if(r||(r=P.participantId),!r)return{error:Be};const D=d?.find((t=>t.participantId===P?.participantId)),N=D?.drawPosition,R=u?.sides?.find((t=>t.drawPosition===N)),b=t.sideNumber||R?.sideNumber;if(!I)return{error:Kt};const M=I.collectionDefinitions?.find((t=>t.collectionId===m));if(!M)return{error:Yt};if(!h?.sides?.length){const{extension:t}=gs({element:a,name:Do}),e=ri(t?.value||{},!1,!0),n=({displaySideNumber:t,drawPosition:e,sideNumber:n})=>({drawPosition:e,sideNumber:n,displaySideNumber:t});h&&(h.sides=c?.sides?.map((t=>{const r=t.participantId;return{...n(t),lineUp:r&&e[r]||[]}})))}const A=h?.sides?.find((t=>t.sideNumber===b)),E=u?.sides?.find((t=>t.sideNumber===b)),C=A?.lineUp??ju({participantId:r,drawDefinition:a})?.lineUp,O=C?.filter((t=>t.collectionAssignments?.find((t=>t.collectionPosition===p&&t.collectionId===m&&!t.previousParticipantId)))),F=O?.map((t=>t?.participantId)),x=F?.length>1&&F||(w===Ou?U.individualParticipantIds:[o]),_=jP({collectionPosition:p,teamParticipantId:r,dualMatchUpSide:A,drawDefinition:a,participantIds:x,collectionId:m});if(_.error)return Oi({result:_,stack:n});const{modifiedLineUp:B}=_;let V;if(f===Aa){if(w!==Ou){let t=$P({collectionPosition:p,teamParticipantId:r,drawDefinition:a,modifiedLineUp:B,participantId:o,collectionId:m,tieFormat:I});if(t?.error)return Oi({result:t,stack:n});if(t=function({side:t}){let e;if(t.participant){const n=t.participant.individualParticipantIds||[];if(1===n.filter(Boolean).length){const{participant:t}=Vu({participantIds:n,tournamentRecord:i});n.push(o);const{participant:r}=Vu({participantIds:n,tournamentRecord:i});if(!r&&t){t.individualParticipantIds=n;const e=AP({pairOverride:!0,tournamentRecord:i,participant:t});if(e.error)return e}else e=t?.participantId}}else{const t=Qg({participant:{individualParticipantIds:[o],participantRole:TP,participantType:Ou},pairOverride:!0,tournamentRecord:i});if(t.error)return t}return{...L,deleteParticipantId:e}}({side:E}),t.error)return t;V=t.deleteParticipantId,A&&(A.lineUp=B),h&&nl({tournamentId:i?.tournamentId,matchUp:h,context:n,drawDefinition:a})}else if(w===Ou)for(const k of x)$P({collectionPosition:p,teamParticipantId:r,drawDefinition:a,modifiedLineUp:B,participantId:k,collectionId:m,tieFormat:I})}else{const t=$P({collectionPosition:p,teamParticipantId:r,drawDefinition:a,modifiedLineUp:B,participantId:o,collectionId:m,tieFormat:I});if(t?.error)return t}if(A&&(A.lineUp=B),h&&nl({tournamentId:i?.tournamentId,matchUp:h,context:n,drawDefinition:a}),V){const{error:t}=sT({participantIds:[V],tournamentRecord:i});t&&console.log("cleanup")}return{...L,modifiedLineUp:B}}function $P({collectionPosition:t,teamParticipantId:e,drawDefinition:n,modifiedLineUp:r,participantId:i,collectionId:a,tieFormat:o}){const s=ju({participantId:e,drawDefinition:n})?.lineUp,c=(r||s)?.find((t=>t?.participantId===i)),u={collectionId:a,collectionPosition:t};if(c)c.collectionAssignments.push(u);else{const t={collectionAssignments:[u],participantId:i};r.push(t)}return Cg({participantId:e,lineUp:r,drawDefinition:n,tieFormat:o})}const WP="ASC",HP="DESC",zP={ASC:"ASC",ASCENDING:WP,DESC:"DESC",DESCENDING:HP};function YP(t){let{tieFormat:e}=t;const{useDefaultEventRanking:n,tournamentRecord:r,drawDefinition:i,scaleAccessor:a,singlesOnly:o,attach:s,event:c}=t;if(c?.eventType!==Nu)return{error:Mt};if(!r)return{error:$};if(!e&&!i)return{error:J};if(e=e||Ri({drawDefinition:i,event:c})?.tieFormat,$i({tieFormat:e}).error)return{error:Wt};if("object"!=typeof a&&!n)return{error:xn,context:{scaleAccessor:a}};const u={},d=(i?.entries||c.entries).filter((t=>t?.entryStatus===Qd)).map(ml),{participants:p=[]}=sU({withIndividualParticipants:!0,withScaleValues:!0,tournamentRecord:r}),l=p.filter((({participantId:t})=>d.includes(t))),m=c?.category?.categoryName||c?.category?.ageCategoryCode,{scaleName:f=m,scaleType:h=cs,sortOrder:I,accessor:g}=a||{},y=h===cs?"rankings":"ratings";const S=(t,e)=>{let r=t[y]?.[e];if(!r&&n&&(r=t[y]?.[Ra]),Array.isArray(r)){const t=r.find((t=>t.scaleName===f))?.scaleValue;if(U(t))return t;if(g&&"object"==typeof t)return t[g]}return 0},v=(t,e,n)=>{const r=I===HP?t:e;return S(I===HP?e:t,n)-S(r,n)},w=(t,e)=>v(t,e,Ra),T=(t,e)=>v(t,e,Ma),P=[],D=e.collectionDefinitions||[];for(const U of l){const t=U.individualParticipants.sort(w),e=o?t:U.individualParticipants.sort(T),n={};for(const i of D){const r=[],{collectionId:a,matchUpCount:o,matchUpType:s,gender:c}=i,u=s===Ra;E(0,o).forEach((i=>{const o=u?t:e,s=i+1,d=[];E(0,u?1:2).forEach((t=>{const e=o.find((e=>{const n=[Lp,jp].includes(c)&&c||c===Bp&&[Lp,jp][t];return!(n&&n!==e.person.sex||r.includes(e.participantId))})).participantId;e&&(d.push(e),r.push(e),n[e]||(n[e]=[]),n[e].push({collectionPosition:s,collectionId:a}))})),u||P.push(d)}))}const r=Object.keys(n).map((t=>({collectionAssignments:n[t],participantId:t})));u[U.participantId]=r}const N=[];for(const U of P){const{participant:t}=Vu({tournamentParticipants:p,participantIds:U});if(!t){const t={individualParticipantIds:U,participantRole:TP,participantType:Ou};N.push(t)}}if(s){for(;N.length;)Qg({participant:N.pop(),tournamentRecord:r});Bs({element:i,extension:{name:Do,value:u}})}return{...L,lineUps:u,participantsToAdd:N}}function KP(t){const{matchUpFormat:e,matchUpStatus:n,winningSide:r,scoreString:i}=t;if(!i)return{outcome:{...Nl,winningSide:r,matchUpStatus:n}};if(r&&![1,2,void 0].includes(r))return{error:xn,winningSide:r};const a=i&&Mh({scoreString:i}),o={},s=Ml({sets:a,matchUpFormat:e}),c=Ml({sets:a,reversed:!0,matchUpFormat:e});return 2===r?(o.scoreStringSide1=c,o.scoreStringSide2=s):(o.scoreStringSide1=s,o.scoreStringSide2=c),o.sets=Mh({scoreString:o.scoreStringSide1}),di({outcome:{matchUpStatus:n,winningSide:r,score:o}})}const JP={[ca]:2,[ea]:1,[ta]:1,[aa]:1,[Zi]:4};function QP(t){let{defaultWithScorePercent:e=2,winningSide:n}=t;const{matchUpStatusProfile:r=JP,matchUpFormat:i=va,pointsPerMinute:a=1,sideWeight:o=4}=t;if(!Ti(i))return{error:Ht};if("object"!=typeof r)return{error:xn};if(e>100&&(e=100),isNaN(e)||isNaN(a)||isNaN(o))return{error:xn};const s=Object.keys(r).filter((t=>Object.keys(ga).includes(t)&&t!==Qi));if(Object.keys(s).reduce(((t,e)=>t+r[e]),0)>100)return{error:xn,matchUpStatusProfile:r};const c=s.reduce(((t,e)=>(t.pointer=t.pointer+r[e],t.valueMap.push([t.pointer,e]),t)),{pointer:0,valueMap:[]}),u=S(1,100),d=(c.valueMap.find((t=>u<=t[0]))||[100,Qi])[1],p={sets:[],scoreStringSide1:"",side2ScoreString:""};if([ca,Zi].includes(d)){n=n||S(1,2);const t={score:p,winningSide:n,matchUpStatus:d};if(!(d===Zi&&S(1,100)>100-e))return{outcome:t}}else if([ea,ta].includes(d))return{outcome:{score:p,matchUpStatus:d}};const l=Ii(i),{bestOf:m,setFormat:f,finalSetFormat:h}=l||{},I=[],g=S(0,1),U=n?[n-1]:[...E(0,o).map((()=>g)),1-g],y=[aa,Zi,ra,oa].includes(d)&&(M(E(1,m))||1);let v;for(const S of E(1,(m||0)+1)){const t=S===m,{set:e,incomplete:n,winningSideNumber:r}=XP({incomplete:y===S,matchUpStatus:d,pointsPerMinute:a,setFormat:t&&h||f,setNumber:S,weightedRange:U});if(I.push(e),n){v=r;break}if(oP({matchUp:{score:{sets:I},matchUpFormat:i}}).calculatedWinningSide)break}const w=oP({matchUp:{score:{sets:I},matchUpFormat:i}}),T=v?n||v:w.calculatedWinningSide,{score:P}=Hg({score:{sets:I},winningSide:T,matchUpStatus:d});return{outcome:{score:P,winningSide:T,matchUpStatus:d}}}function XP({weightedRange:t=[0,1],pointsPerMinute:e,matchUpStatus:n,incomplete:r,setFormat:i,setNumber:a}){const o={setNumber:a},{setTo:s,tiebreakFormat:c,tiebreakAt:u,tiebreakSet:d,timed:p,minutes:l}=i,m=S(0,t.length-1),f=t[m];let h;if(p){const i=l*e,a=Math.round(.2*i),s=i+M([1,-1])*a,c=function(t=1,e=3,n=!0){let r=0;for(let i=0;i<e;i++)r+=Math.random()*(t/e);return n&&t>1?Math.round(r):r}(s,2),u=[c,s-c];f&&u.reverse(),h=t[m]+1;let d=(u[0]>u[1]?1:u[1]>u[0]&&2)||0;if(r){const[t,e]=u;return Object.assign(o,{side1Score:t,side2Score:e}),fa.includes(n)?{set:o,incomplete:r,winningSideNumber:h}:{set:o,incomplete:r}}d||(u[S(0,1)]+=1),d=u[0]>u[1]?1:2,d!==h&&u.reverse();const[p,I]=u;return Object.assign(o,{side1Score:p,side2Score:I,winningSide:h}),{set:o}}if(r)return o.side1Score=S(0,u),o.side2Score=S(0,u),fa.includes(n)&&(h=t[m]+1),{set:o,incomplete:r,winningSideNumber:h};{const e=E(1,s+1).map((t=>E(0,s+2-t).map((()=>t)))).flat(),n=e[S(0,e.length-1)],r=s&&Em({isSide1:!0,tiebreakAt:u,lowValue:n,setTo:s}),a=!r,p=1===t.length&&t[m]+1;if(!a){if(p){(r[0]>r[1]?1:2)!==p&&r.reverse()}else f&&r.reverse();const[t,e]=r;Object.assign(o,{side1Score:t,side2Score:e})}const l=Am({matchUpScoringFormat:{setFormat:i},setObject:o});let h;if(l.hasTiebreakCondition||a){const{NoAD:t,tiebreakTo:e}=c||d||{},n=E(1,e+1).map((t=>E(0,e+2-t).map((()=>t)))).flat(),r=n[S(0,n.length-1)],i=Cm({isSide1:!0,tiebreakNoAd:t,tiebreakTo:e,lowValue:r});if(i)if(a){const t=i[0]>i[1]?1:2;p?t!==p&&i.reverse():f&&i.reverse(),[o.side1TiebreakScore,o.side2TiebreakScore]=i,h=(i[0]>i[1]?1:i[1]>i[0]&&2)||void 0}else 2===l.leadingSide?[o.side1TiebreakScore,o.side2TiebreakScore]=i:[o.side2TiebreakScore,o.side1TiebreakScore]=i}o.winningSide=l.winningSide||l.leadingSide||p||h}return{set:o}}function ZP(t){const{matchUpStatusProfile:e,completeAllMatchUps:n,randomWinningSide:r,tournamentRecord:i,completionGoal:a,drawDefinition:o,event:s}=t;if(!o)return{error:Y};const c=t.matchUpFormat||o.matchUpFormat||s?.matchUpFormat,u=o.structures.slice().sort(Wd);let d=0;const{matchUps:p,matchUpsMap:l}=Pl({contextFilters:{stages:[Hu,zu]},matchUpFilters:{matchUpTypes:[Ca],roundNumbers:[1]},inContext:!0,drawDefinition:o});if(p?.length){const t=s?.category?.ageCategoryCode||s?.category?.categoryName;if(t){YP({singlesOnly:!0,tournamentRecord:i,drawDefinition:o,scaleAccessor:{scaleName:t,sortOrder:WP,scaleType:cs},attach:!0,event:s})}else{const t=p[0]?.structureId,{positionAssignments:e}=Rp({drawDefinition:o,structureId:t});if(e?.length){const{participants:t}=sU({participantFilters:{participantTypes:[qi.Team]},tournamentRecord:i}),n=n=>{const r=n.tieMatchUps.filter((({matchUpType:t})=>t===ba)),a=n.tieMatchUps.filter((({matchUpType:t})=>t===Aa));r.forEach(((n,r)=>{const a=n.matchUpId;n.sides.forEach((n=>{const{drawPosition:c}=n,u=t?.find((t=>{const{participantId:n}=t,r=e.find((t=>t.participantId===n));return r?.drawPosition===c}));if(u){const t=u.individualParticipantIds?.[r];qP({teamParticipantId:u.participantId,participantId:t,tournamentRecord:i,drawDefinition:o,tieMatchUpId:a,event:s})}}))})),a.forEach(((n,r)=>{const a=n.matchUpId;n.sides.forEach((n=>{const{drawPosition:c}=n,u=t?.find((t=>{const{participantId:n}=t,r=e.find((t=>t.participantId===n));return r?.drawPosition===c}));if(u){const t=u.individualParticipantIds?.slice(2*r,2*r+2);t?.forEach((t=>{qP({teamParticipantId:u.participantId,participantId:t,tournamentRecord:i,drawDefinition:o,tieMatchUpId:a,event:s})}))}}))}))};p.forEach(n)}}}const m="string"==typeof n&&n,f=m&&Qi;for(const h of u){if(d>=a)break;const{matchUps:t}=qp({matchUpFilters:{matchUpTypes:[Aa,ba]},afterRecoveryTimes:!1,tournamentRecord:i,inContext:!0,drawDefinition:o,matchUpsMap:l,structure:h,event:s}),n=t.filter((({winningSide:t})=>!t)).sort(dh).map(hl);for(const u of n){if(!isNaN(a)&&d>=a)break;const{matchUps:t}=qp({matchUpFilters:{matchUpTypes:[Aa,ba]},afterRecoveryTimes:!1,tournamentRecord:i,inContext:!0,drawDefinition:o,matchUpsMap:l,structure:h,event:s}),n=t.find((t=>t.matchUpId===u)),p=[ea,ta].includes(n.matchUpStatus);if(n?.readyToScore&&!p){const t=eD({winningSide:!r&&1,matchUpStatusProfile:e,tournamentRecord:i,drawDefinition:o,targetMatchUp:n,matchUpFormat:c,matchUpStatus:f,scoreString:m,event:s});if(t?.error)return t;d+=1}}}return{...L,completedCount:d}}function tD(t){const{matchUpStatusCodes:e,policyDefinitions:n,tournamentRecord:r,drawDefinition:i,targetMatchUp:a,matchUpStatus:o,matchUpFormat:s,scoreString:c,winningSide:u,event:d}=t;if(!a||a.matchUpStatus===Ki)return;const{matchUpId:p}=a||{},{outcome:l}=KP({matchUpFormat:s,matchUpStatus:o,scoreString:c,winningSide:u});return e&&(l.matchUpStatusCodes=e),zg({tournamentRecord:r,policyDefinitions:n,drawDefinition:i,matchUpFormat:s,matchUpId:p,outcome:l,event:d})}function eD(t){const{matchUpStatusProfile:e={},tournamentRecord:n,policyDefinitions:r,drawDefinition:i,matchUpStatus:a,matchUpFormat:o,targetMatchUp:s,scoreString:c,winningSide:u,event:d}=t;if(c||a)return tD(t);const{matchUpId:p}=s||{},{outcome:l}=QP({matchUpStatusProfile:e,matchUpFormat:o,winningSide:u});return zg({policyDefinitions:r,tournamentRecord:n,drawDefinition:i,matchUpFormat:o,matchUpId:p,outcome:l,event:d})}function nD(t){const e=[];for(const n of t||[]){const{stageType:t}=n,r=["M",Hu].includes(t)&&Hu||["Q",zu].includes(t)&&zu||["C",Yu].includes(t)&&Yu||["P",Ju].includes(t)&&Ju||void 0;for(const i of n.draws||[]){const{drawId:t,drawSize:n,matchUps:a}=i,o={stage:r,drawId:t,drawSize:n};e.push(o),console.log(a.map((({roundNumber:t,roundPosition:e})=>({roundNumber:t,roundPosition:e}))),{draw:i,drawDefinition:o})}}return e}const rD={ABANDONED:"ABANDONED",ACTIVE:"ACTIVE",CANCELLED:"CANCELLED",COMPLETED:"COMPLETED",IN_PROGRESS:"IN_PROGRESS"};function iD({tournamentRecord:t}){if(!t)return{error:$};const e={positionsNoOutcomes:[],canBePruned:[],matchPlay:[],inactive:[],drawAnalysis:{}},n={},r=t.events?.map((t=>{const e=t.eventId;return n[e]=t,(t?.drawDefinitions||[]).map((t=>({drawDefinition:t,eventId:e})))})).flat().filter(Boolean);return r.forEach((({drawDefinition:t,eventId:r})=>{let i=0,a=0,o=0;const{allStructuresLinked:s}=xP({drawDefinition:t}),c=n[r],u=(t?.structures||[]).map((e=>{const{stage:n,stageSequence:r,structureId:s}=e,u=Xu[n],{inContextStructureMatchUps:d}=BI({drawDefinition:t,structure:e,event:c}),p=d?.filter((({winningSide:t})=>t)),l=p.filter(Boolean).length||0;a+=l,o+=d.length-a;const m=Math.max(p.filter((({roundNumber:t})=>1===t)).map((({roundPosition:t})=>t))),{positionAssignments:f}=Rp({structure:e}),h=f?.filter((({participantId:t})=>t));i+=h?.length||0;const I=(f?.length||0)-(h?.length||0),{roundMatchUps:g,roundProfile:U,roundNumbers:y,maxMatchUpsCount:S}=Gu({matchUps:d}),v=U&&Object.keys(U).filter((t=>!U[t].inactiveRound)).map((t=>parseInt(t))),w=U&&Object.keys(U).filter((t=>U[t].inactiveRound)).map((t=>parseInt(t))),T=U&&Object.values(U).every((t=>t.inactiveRound));return{positionsAssignedCount:h?.length||0,maxWinningSideFirstRoundPosition:m,unassignedPositionsCount:I,inactiveStructure:T,maxMatchUpsCount:S,inactiveRounds:w,roundMatchUps:g,activeRounds:v,roundNumbers:y,roundProfile:U,structureId:s,stageSequence:r,orderNumber:u,stage:n}})),d=u.find((t=>2===t.orderNumber&&1===t.stageSequence)),p=u.filter((({inactiveStructure:t})=>!t)).length,{links:l}=Ul({drawDefinition:t,structureId:d.structureId}),f=1===m(d.activeRounds[0])&&1===d.activeRounds.length&&1===p,h=u?.every((({inactiveStructure:t})=>t)),I=!l.length&&d.activeRounds.length&&(d.roundProfile[1].inactiveCount||d.inactiveRounds.length),g=t.drawId;i&&!a&&e.positionsNoOutcomes.push(g),h&&e.inactive.push(g),f&&e.matchPlay.push(g),I&&e.canBePruned.push(g);const U={matchUpsWithWinningSideCount:a,matchUpsNoOutcomeCount:o,positionsAssignedCount:i,allStructuresLinked:s,structuresData:u,inactiveDraw:h,isMatchPlay:f,drawId:g};e.drawAnalysis[g]=U})),{...L,drawsAnalysis:e}}function aD(t){const e=t.participants?.filter((({participantType:t})=>t===Fu)),n=2===e?.length,r=1===t.events?.length&&t.events[0],i=1===r?.drawDefinitions?.length&&r.drawDefinitions[0],a=1===i?.structures?.length&&i.structures[0],o=2===a?.positionAssignments?.length;return!!(r.tieFormat&&n&&o)}function oD({tournamentRecord:t,startDate:e,endDate:n}){if(!t)return{error:$};if(e&&!Rr.test(e)||n&&!Rr.test(n))return{error:ye};if(!e&&!n)return{error:fe};if(n&&e&&new Date(n)<new Date(e))return{error:xn};let r;(e&&t.startDate&&new Date(e)>new Date(t.startDate)||n&&t.endDate&&new Date(n)<new Date(t.endDate))&&(r=!0),e&&(t.startDate=e),n&&(t.endDate=n),e&&t.endDate&&new Date(e)>new Date(t.endDate)&&(t.endDate=e),n&&t.startDate&&new Date(n)<new Date(t.startDate)&&(t.startDate=n);const i=r&&function({tournamentRecord:t}){const e=th({tournamentRecord:t}).matchUps??[],n=t.startDate&&new Date(t.startDate),r=t.endDate&&new Date(t.endDate),i=[],a=[];for(const o of e){const{schedule:t,matchUpId:e}=o;if(t&&t.scheduledDate){const o=new Date(t.scheduledDate);(n&&o<n||r&&o>r)&&(a.push(e),i.includes(t.scheduledDate)||i.push(t.scheduledDate))}}if(i.length){if(!Ly({scheduledDates:i,tournamentRecord:t}).clearedScheduleCount)return{error:et}}return{unscheduledMatchUpIds:a}}({tournamentRecord:t})?.unscheduledMatchUpIds;return function({tournamentRecord:t}){if(!t)return{error:$};const{startDate:e,endDate:n}=t,r=_r(e,n),i=[];for(const a of t.venues||[])a?.courts?.length&&i.push(...a.courts);for(const a of i){const{startTime:t,endTime:e}=(a.dateAvailability||[]).reduce(((t,e)=>{const n=jr(t.startTime),r=jr(t.endTime);return e.startTime&&jr(e.startTime)<n&&(t.startTime=e.startTime),e.endTime&&jr(e.endTime)>r&&(t.endTime=e.endTime),t}),{startTime:"08:00",endTime:"18:00"}),n=r.map((n=>{const r=a.dateAvailability?.find((t=>t.date===n));return r||{date:n,startTime:t,endTime:e}})),i=a.dateAvailability?.find((t=>!t.date));i&&n.unshift(i),a.dateAvailability=n}}({tournamentRecord:t}),dr({topic:yc,payload:{startDate:e,endDate:n}}),{...L,unscheduledMatchUpIds:i}}const sD={analyzeTournament:function({tournamentRecord:t}){if(!t)return{error:$};const{drawsAnalysis:e}=iD({tournamentRecord:t}),n={isDual:aD(t),drawsAnalysis:e};return{...L,analysis:n}},analyzeDraws:iD,addOnlineResource:function({tournamentRecord:t,onlineResource:e,organisationId:n,participantId:r,personId:i,courtId:a,venueId:o}){if(!t)return{error:$};if(!si(e))return{error:me};if(3!==O(Object.keys(e),["resourceSubType","resourceType","identifier"]).length)return Oi({result:{error:On},context:{onlineResource:e}});if(n){if(t.parentOrganisation?.parentOrganisationId!==n)return Oi({result:{error:Gn}});t.parentOrganisation.onlineResources||(t.parentOrganisation.onlineResources=[]),t.parentOrganisation.onlineResources.push(e)}else if(r||i){const n=(t.participants??[]).find((t=>i&&t.person?.personId===i||t.participantId===r));if(!n)return Oi(i?{result:{error:Gn}}:{result:{error:Be}});if(i){if(n.person?.personId!==i)return Oi({result:{error:Ae}});n.person.onlineResources||(n.person.onlineResources=[]),n.person.onlineResources.push(e)}else n.onlineResources||(n.onlineResources=[]),n.onlineResources.push(e)}else if(a){const n=(t.venues??[]).filter((t=>!o||t.venueId===o)).flatMap((t=>(t.courts??[]).filter((t=>t.courtId===a))))?.[0];if(!n)return Oi({result:{error:dn}});n.onlineResources||(n.onlineResources=[]),n.onlineResources.push(e)}else if(o){const n=(t.venues??[]).find((t=>t.venueId===o));if(!n)return Oi({result:{error:mn}});n.onlineResources||(n.onlineResources=[]),n.onlineResources.push(e)}else t.onlineResources||(t.onlineResources=[]),t.onlineResources.push(e);return{...L}},removeNotes:function(t){return"object"!=typeof t?{error:me}:"object"!=typeof t.element?{error:xn}:(t.element.notes&&delete t.element.notes,{...L})},addNotes:Xp,completeDrawMatchUps:ZP,getRounds:dS,getProfileRounds:Qy,setTournamentName:function({tournamentRecord:t,promotionalName:e,tournamentName:n,formalName:r}){return t?(n&&(t.tournamentName=n),e&&(t.promotionalName=e),r&&(t.formalName=r),t.promotionalName===t.tournamentName&&delete t.promotionalName,t.formalName===t.tournamentName&&delete t.formalName,{...L}):{error:$}},setTournamentNotes:function({tournamentRecord:t,notes:e}){return t?Xp({element:t,notes:e}):{error:$}},setTournamentDates:oD,setTournamentEndDate:function({tournamentRecord:t,endDate:e}){return oD({tournamentRecord:t,endDate:e})},setTournamentStartDate:function({tournamentRecord:t,startDate:e}){return oD({tournamentRecord:t,startDate:e})},setTournamentCategories:function({tournamentRecord:t,categories:e}){return t?(e=(e||[]).filter((t=>t.categoryName&&t.type)),t.tournamentCategories=e,{...L}):{error:$}},addTimeItem:uI,addEventTimeItem:lI,addTournamentTimeItem:pI,addParticipantTimeItem:dI,addExtension:Bs,addEventExtension:Ws,removeEventExtension:zs,addTournamentExtension:qs,removeTournamentExtension:Hs,addParticipantExtension:function(t){if(!t||"object"!=typeof t)return{error:me};if(!t.participantId)return{error:Le};const e=t.tournamentRecord?.participants||[],n=fs({participantId:t.participantId,tournamentParticipants:e});return n?Bs({creationTime:t.creationTime,extension:t.extension,element:n}):{error:Be}},removeParticipantExtension:function(t){if(!t||"object"!=typeof t)return{error:me};if(!t.participantId)return{error:Le};const e=t.tournamentRecord?.participants||[],n=fs({participantId:t.participantId,tournamentParticipants:e});return n?Gs({element:n,name:t.name}):{error:Be}},addDrawDefinitionExtension:$s,removeDrawDefinitionExtension:function(t){return t&&"object"==typeof t?t.drawDefinition?Gs({element:t.drawDefinition,name:t.name}):{error:J}:{error:me}},setTournamentStatus:function({tournamentRecord:t,status:e}){return t?e&&!Object.keys(rD).includes(e)?{error:xn,info:"Unknown status"}:(t.tournamentStatus=e,{...L}):{error:$}},convertPointEight:function({tournament:t}){if(!t)return{error:$};const{providerTournamentID:e,hostCountryCode:n,tournamentLevel:r,totalPrizeMoney:i,tournamentName:a,extensions:o,startDate:s,endDate:c}=t,u=hP({hostCountryCode:n,tournamentLevel:r,totalPrizeMoney:i,tournamentName:a,tournamentId:e,extensions:o,startDate:s,endDate:c});u.events=[];for(const d of t.events||[]){const{extensions:t,ageCategory:e,discipline:n,eventType:r,eventId:i,gender:a,stages:o}=d,s={drawDefinitions:nD(o),category:{ageCategory:e},gender:["M",Lp].includes(a)&&Lp||["F",jp].includes(a)&&jp||void 0,eventType:["D",Tu].includes(r)&&Tu||["T",Du].includes(r)?Du:vu,extensions:t,discipline:n,eventId:i};u.events.push(s)}return{...L,tournamentRecord:u}}};const cD={allocateTeamMatchUpCourts:fI,addMatchUpCourtOrder:wI,assignMatchUpCourt:II,assignMatchUpVenue:hI,clearMatchUpSchedule:function({scheduleAttributes:t=[Bc,Vc,Lc,Gc,$c,Wc,Yc,zc,Hc],tournamentRecord:e,drawDefinition:n,matchUpId:r}){const i=n?eh({matchUpFilters:{matchUpIds:[r]},inContext:!1,drawDefinition:n}).matchUps?.[0]:th({matchUpFilters:{matchUpIds:[r]},tournamentRecord:e,inContext:!1}).matchUps?.[0];if(!i)return{error:Xt};const a=(i.timeItems||[]).filter((e=>e?.itemType&&!t.includes(e?.itemType)));return i.timeItems=a,nl({tournamentId:e.tournamentId,context:"clearMatchUpSchedule",drawDefinition:n,matchUp:i}),{...L}},addMatchUpScheduleItems:Xy,addMatchUpScheduledDate:Zy,addMatchUpScheduledTime:tS,addMatchUpStartTime:eS,addMatchUpEndTime:nS,addMatchUpStopTime:rS,addMatchUpResumeTime:iS,addMatchUpOfficial:aS,getMatchUpFormatTiming:Fs,modifyMatchUpFormatTiming:HU,getModifiedMatchUpFormatTiming:WU,getEventMatchUpFormatTiming:JU,modifyEventMatchUpFormatTiming:YU,removeEventMatchUpFormatTiming:qy,getMatchUpFormatTimingUpdate:function({tournamentRecord:t}){if(!t)return{error:$};const e=[],{extension:n}=Us({tournamentRecord:t,name:Oo});n&&e.push({method:"addTournamentExtension",params:{extension:n}});const r=t.events||[];for(const i of r){const{eventId:t}=i,{extension:n}=ys({event:i,name:Oo});n&&e.push({method:"addEventExtension",params:{eventId:t,extension:n}})}return{methods:e}},getMatchUpDependencies:ph,getMatchUpDailyLimits:Vy,setMatchUpDailyLimits:sS,getMatchUpDailyLimitsUpdate:function({tournamentRecord:t}){if(!t)return{error:$};const e=[],{extension:n}=Us({name:Co,tournamentRecord:t});n&&e.push({method:"addTournamentExtension",params:{extension:n}});const r=t.events||[];for(const i of r){const{eventId:t}=i,{extension:n}=ys({name:Co,event:i});n&&e.push({params:{eventId:t,extension:n},method:"addEventExtension"})}return{methods:e}},validateSchedulingProfile:QU,setSchedulingProfile:function({tournamentRecord:t,schedulingProfile:e}){return t?Array.isArray(e)?ZS({tournamentRecord:t,schedulingProfile:e}):{error:xn}:{error:$}},getSchedulingProfile:XS,removeMatchUpCourtAssignment:function({drawDefinition:t,courtDayDate:e,matchUpId:n}){return zy({drawDefinition:t,courtDayDate:e,matchUpId:n})},clearScheduledMatchUps:Ly,bulkScheduleMatchUps:EI,bulkRescheduleMatchUps:oS};function uD({tournamentRecord:t,categoryName:e,categoryType:n}){if(!t)return{error:$};const{appliedPolicies:r}=Vo({tournamentRecord:t}),i=r?.[uo];return(i?.allowedDrawTypes||[]).filter((({categoryNames:t,categoryTypes:r})=>!e&&!r||e&&t?.includes(e)||n&&r?.includes(n)))}function dD({policyDefinitions:t,drawDefinition:e,drawSize:n,drawId:r,event:i,stage:a}){if(!i)return{error:At};const{entries:o,stageEntries:s}=cT({drawDefinition:e,drawId:r,stage:a,event:i}),c=s.length,{drawSize:u}=Bw({participantsCount:c}),d=Vw({drawSize:n??u,participantsCount:c,policyDefinitions:t});if(d.error)return Oi({result:d,stack:"getEntriesAndSeedsCount"});const{seedsCount:p}=d;return{entries:o,seedsCount:p,stageEntries:s}}const pD={attachPolicies:lS,attachEventPolicies:mS,removeEventPolicy:function({event:t,policyType:e}){if(!e)return{error:me};if(!t)return{error:At};let n;if(t.extensions){const{appliedPolicies:r}=Vo({event:t});if(r?.[e])if(delete r[e],n=!0,Object.keys(r).length){Ws({event:t,extension:{name:fo,value:r}})}else zs({event:t,name:fo})}return n?L:{error:ue}},findPolicy:ns,getSeedsCount:Vw,getEntriesAndSeedsCount:dD,getAllowedDrawTypes:uD,getAllowedMatchUpFormats:function({tournamentRecord:t,categoryName:e,categoryType:n}){if(!t)return{error:$};const{appliedPolicies:r}=Vo({tournamentRecord:t}),i=r?.[oo];return(i?.matchUpFormats||[]).filter((({categoryNames:t,categoryTypes:r})=>!e&&!r||e&&t?.includes(e)||n&&r?.includes(n)))},getAppliedPolicies:Vo};function lD({participant:t,eventType:e}){const n=t?.person?.personId,r=t?.person?.personOtherIds?.[0],i=t?.person?.tennisId,a=t?.ratings?.[e]?.find((({scaleName:t})=>t===_m)),o=a?.scaleValue,{wtnRating:s,confidence:c}=o||{};return{timeStamp:a?.scaleDate,personOtherId:r,confidence:c,wtnRating:s,personId:n,tennisId:i}}function mD({eventType:t,matchUps:e,eventId:n,drawId:r}){const i={},a=e.filter((t=>n?t.eventId===n:t.drawId===r)).reduce(((t,e)=>((t=>{const e=t?.matchUpFormat;e&&(i[e]||(i[e]=0),i[e]+=1)})(e),(e.sides??[]).flatMap((t=>(t?.participant?.individualParticipants||[t?.participant]).filter(Boolean))).forEach((e=>t[e.participantId]=e)),t)),{}),o=Object.values(a),s=o.map((e=>lD({participant:e,eventType:t}))).filter((({wtnRating:t})=>t)),c=(o.length-s.length)/o.length*100,u=s.reduce(((t,e)=>{const{wtnRating:n,confidence:r}=e;return t.totalWTN+=n,t.totalConfidence+=r,t}),{totalWTN:0,totalConfidence:0}),d=s?.length?u.totalWTN/s.length:0,p=s?.length?u.totalConfidence/s.length:0,l=Object.values(i).reduce(((t,e)=>t+(e||0)),0);return{matchUpFormatCounts:i,matchUpsCount:l,avgConfidence:p,pctNoRating:c,avgWTN:d}}const fD={getStructureReports:function({firstFlightOnly:t=!0,extensionProfiles:e,tournamentRecord:n}){if(!n)return{error:H};const r={},i=Object.assign({},...(e??[]).map((({name:t,label:e,accessor:r})=>{const i=Us({tournamentRecord:n,name:t})?.extension?.value;return{[e||t]:r?ai({element:i,accessor:r})?.value:i}}))),a=n?.tournamentId,o=th({participantsProfile:{withScaleValues:!0},tournamentRecord:n}).matchUps??[],s=t=>{const e=$f({itemType:ac,itemSubTypes:[ps],element:{timeItems:t}})?.timeItem;return e?.itemValue?.scaleBasis},c=n?.events?.flatMap((({timeItems:e,drawDefinitions:n=[],extensions:c,eventType:u,eventId:d,category:p})=>{const l=c?.find((t=>t.name===To)),m=l?.value?.flights?.map((t=>({[t.drawId]:t.flightNumber}))),f=m&&Object.assign({},...m),h=c?.find((t=>t.name===vo))?.value?.length||0,I=Object.values(f),g=f&&Math.min(...I),U=s(e);return r[d]={totalPositionManipulations:0,maxPositionManipulations:0,generatedDrawsCount:0,drawDeletionsCount:h,seedingBasis:U?JSON.stringify(U):void 0,tournamentId:a,eventId:d},n.filter((e=>!t||!m||f[e.drawId]===g)).flatMap((t=>{const{matchUpFormat:e,tieFormat:n,timeItems:c,extensions:l,structures:m,drawType:h,drawId:I}=t,{matchUpFormatCounts:g,matchUpsCount:y,avgConfidence:S,pctNoRating:v,avgWTN:w}=mD({eventType:u,matchUps:o,drawId:I}),T=s(c)||U,P=function({extensions:t}){return t?.find((({name:t})=>t===ho))?.value?.slice(1)}({extensions:l}),D=P?.length||0;return r[d].totalPositionManipulations+=D,r[d].generatedDrawsCount+=1,D>r[d].maxPositionManipulations&&(r[d].maxPositionManipulations=D),m?.filter((t=>1===t.stageSequence&&[zu,Hu,Yu,Ju].includes(t.stage))).map((t=>{const r=[Hu,Ju].includes(t.stage)?o.find((e=>e.structureId===t.structureId&&1===e.finishingRound&&e.winningSide)):void 0,s=r?.sides?.find((t=>t.sideNumber===r.winningSide)),c=s?.participant,l=c?.participantType===ku&&c.participantId,m=c?.participantType===Ou?c.individualParticipants:[],U=lD({participant:m?.[0]||c,eventType:u}),{personId:D,personOtherId:N,tennisId:R,confidence:b,wtnRating:M}=U||{},A=lD({participant:m?.[1],eventType:u}),{personId:E,personOtherId:C,tennisId:O,confidence:F,wtnRating:k}=A||{},{ageCategoryCode:x,categoryName:_,subType:L}=p??{},B=t.matchUpFormat||e,V=(g[B]||0)/y*100,{tieFormatName:j,tieFormatDesc:G}=fh(n),{tieFormatName:q,tieFormatDesc:$}=fh(t.tieFormat),W=G===$,H=!W&&q,z=t.tieFormat&&!W&&$,Y=P?.filter((e=>e.structureId===t.structureId))?.length||0;return{...i,tournamentId:a,eventId:d,structureId:t.structureId,drawId:I,eventType:u,category:L,categoryName:_,ageCategoryCode:x,flightNumber:f[I],drawType:h,stage:t.stage,seedingBasis:T?JSON.stringify(T):void 0,winningPersonId:D,winningPersonOtherId:N,winningPersonTennisId:R,winningPersonWTNrating:M,winningPersonWTNconfidence:b,winningPerson2Id:E,winningPerson2OtherId:C,winningPerson2TennisId:O,winningPerson2WTNrating:k,winningPerson2WTNconfidence:F,winningTeamId:l,positionManipulations:Y,pctNoRating:v,matchUpFormat:B,pctInitialMatchUpFormat:V,matchUpsCount:y,drawTieFormatName:j,drawTieFormatDesc:G,tieFormatName:H,tieFormatDesc:z,avgConfidence:S,avgWTN:w}}))}))}));return{eventStructureReports:Object.values(r),structureReports:c}},getEntryStatusReports:function({tournamentRecord:t}){if(!t)return{error:$};const e=t.tournamentId,{participantMap:n}=sU({withScaleValues:!0,withEvents:!0,withSeeding:!0,tournamentRecord:t,withDraws:!0}),r=(th({matchUpFilters:{matchUpTypes:[Ra,Ma]},tournamentRecord:t}).matchUps??[]).flatMap((({sides:t,matchUpType:e})=>t?.flatMap((t=>e===Ma?t.participant?.individualParticipantIds:t.participant?.participantId||t.participantId)).filter(Boolean))).filter(Boolean),i=[],a={},o={},s={};let c=0;const u=({id:t,entry:r,eventId:o,eventType:s})=>{const{qualifyingSeeding:c,mainSeeding:u,entryStatus:d,entryStage:p,drawId:l}=r;a[t]||(a[t]=[]);const{participant:m,events:f}=n?.[t]??{},h=lD({participant:m,eventType:s}),I=f?.[o]?.ranking;d===vf&&i.push(t),a[t].push({participantType:m?.participantType,participantId:t,tournamentId:e,eventType:s,eventId:o,drawId:l,entryStatus:d,entryStage:p,...h,ranking:I,mainSeeding:u,qualifyingSeeding:c})};for(const l of t.events??[]){const t={},i=e=>{t[e]||(t[e]={count:0}),t[e].count+=1},{drawDefinitions:a=[],eventType:d,eventId:p}=l,m=a.flatMap((t=>{const{drawId:e,entries:r}=t;c+=1;const a=(t.structures??[]).filter((({stage:t,stageSequence:e})=>t===Hu&&1===e||t===zu)).flatMap((({positionAssignments:t})=>t)).map((({participantId:t})=>t)).filter(Boolean);return r?.filter((({participantId:t})=>a.includes(t))).map((t=>{const{participantId:r,entryStatus:a,entryStage:o}=t;i(a);const s=n?.[r]?.draws?.[e]?.seedAssignments?.[Hu],c=n?.[r]?.draws?.[e]?.seedAssignments?.[zu];return{qualifyingSeeding:c,participantId:r,mainSeeding:s,entryStatus:a,entryStage:o,drawId:e}}))})),f=t=>{const e=t.participantId,i=n?.[e].participant.individualParticipantIds?.filter((t=>r.includes(t)));return e&&{[e]:{individualParticipantIds:i}}};d===Pu?(()=>{const t=Object.assign({},...m.map(f).filter(Boolean));m.forEach((e=>{t[e.participantId].individualParticipantIds.forEach((t=>{u({id:t,eventType:d,eventId:p,entry:e})}))}))})():m.forEach((t=>{u({id:t?.participantId,eventType:d,eventId:p,entry:t})}));const h=Object.values(t).reduce(((t,e)=>t+e.count),0);Object.keys(t).forEach((e=>{t[e].pct=t[e].count/h*100})),s[p]={tournamentId:e,eventId:p,entries:m,entryStatuses:t};const I=Object.assign({},...lp.flatMap((e=>[{[e+"_count"]:t[e]?.count},{[e+"_pct"]:t[e]?.pct}])));o[p]={tournamentId:e,eventId:p,...I}}const d=Object.values(n??{}).filter((({participant:{participantType:t,participantRole:e}})=>t===Eu&&e===TP)),p={nonParticipatingEntriesCount:d.filter((({participant:t})=>!r.includes(t.participantId))).map((({participant:t})=>t.participantId)).length,individualParticipantsCount:d.length,eventsCount:Object.values(s).length,drawDefinitionsCount:c,tournamentId:e};return{entryStatusReports:Object.values(o).flat(),participantEntryReports:Object.values(a).flat(),eventReports:Object.values(s).flat(),withDrawnParticipantIds:i,tournamentEntryReport:p}}};function hD(t){const e=GP(t);if(e.error)return e;const n="replaceTieMatchUpParticipantid",{existingParticipantId:r,tournamentRecord:i,newParticipantId:a,drawDefinition:o,substitution:s,event:c}=t;if(!r||!a)return Oi({result:{error:Le},stack:n});if(r===a)return{...L};const{inContextDualMatchUp:u,inContextTieMatchUp:d,collectionPosition:p,collectionId:l,dualMatchUp:m,tieMatchUp:f,tieFormat:h}=e,I=d?.matchUpType,g=d?.sides?.find((t=>t.participant?.participantId===r||t.participant?.individualParticipantIds?.includes(r)));if(!g)return{error:Be};const U=sU({tournamentRecord:i,participantFilters:{participantIds:[r,a]}})?.participants??[];if(2!==U.length)return Oi({result:{error:Le},stack:n});if(U[0].participantType!==U[1].participantType)return Oi({result:{error:Fe},stack:n});const{appliedPolicies:y}=Vo({tournamentRecord:i,drawDefinition:o,event:c}),S=y?.[Xa]||gS[Xa],v=U.find((({participantId:t})=>t===a));if(S?.participants?.enforceGender&&[Lp,jp].includes(d?.gender)&&d?.gender!==v?.person?.sex)return{error:Ae,info:"Gender mismatch"};const w=S?.processCodes?.substitution,{extension:T}=gs({element:o,name:Do}),P=T?.value||{};if(!m?.sides?.length){const t=({displaySideNumber:t,drawPosition:e,sideNumber:n})=>({drawPosition:e,sideNumber:n,displaySideNumber:t});m&&(m.sides=u?.sides?.map((e=>{const n=e.participantId;return{...t(e),lineUp:n&&P[n]||[]}})))}const D=m?.sides?.find((({sideNumber:t})=>t===g.sideNumber));if(!D)return Oi({result:{sideNumber:g.sideNumber,existingParticipantId:r,error:Gn},stack:n});const N=d?.sides?.flatMap((t=>t.participant?.individualParticipantIds||t.participant?.participantId||[]));if(N?.includes(a))return Oi({result:{error:Ye},stack:n});const R=u?.sides?.find((({sideNumber:t})=>t===g.sideNumber))?.participantId,b=D.lineUp,M=b?.find((({participantId:t})=>a===t)),A=b?.reduce(((t,e)=>e.substitutionOrder>t?e.substitutionOrder:t),0),E=b?.map((t=>{const e=ri(t,!1,!0);if(![r,a].includes(e.participantId))return e;if(!s&&[r,a].includes(e.participantId)&&(e.collectionAssignments=e.collectionAssignments?.filter((t=>!(t.collectionPosition===p&&t.collectionId===l)))),s&&r===e.participantId&&(e.collectionAssignments=e.collectionAssignments.map((t=>t.collectionPosition===p&&t.collectionId===l&&void 0===t.substitutionOrder?{...t,substitutionOrder:A}:t))),e.participantId===a){e.collectionAssignments||(e.collectionAssignments=[]);const t={collectionId:l,collectionPosition:p};s&&(t.previousParticipantId=r,t.substitutionOrder=(A||0)+1),e.collectionAssignments.push(t)}return e}))||[];if(!M){const t={collectionId:l,collectionPosition:p};s&&(t.substitutionOrder=(A||0)+1,t.previousParticipantId=r);const e={collectionAssignments:[t],participantId:a};E.push(e)}const C=I===Aa,{assignedParticipantIds:O}=Mu({lineUp:b,collectionPosition:p,collectionId:l}),{assignedParticipantIds:F}=Mu({lineUp:E,collectionPosition:p,collectionId:l});if(D.lineUp=E,R&&h){const t=Cg({participantId:R,lineUp:E,drawDefinition:o,tieFormat:h});if(t.error)return Oi({result:t,stack:n})}else console.log("team participantId not found");let k,x;if(C){const{tournamentRecord:e}=t;let r=Vu({participantIds:F,tournamentRecord:e});if(!r.participant){const t=Qg({returnParticipant:!0,pairOverride:!0,tournamentRecord:e,participant:{participantRole:TP,individualParticipantIds:F,participantType:Ou}});if(t.error)return Oi({result:t,stack:n});k=t.participant?.participantId}r=Vu({participantIds:O,tournamentRecord:e});const i=r.participant?.participantId;if(i){sT({participantIds:[i],tournamentRecord:e}).success&&(x=i)}}if(s||1===g.substitutions?.length){if(s){const t=f?.processCodes||[];w&&t.push(...w),f&&(f.processCodes=t)}else for(const t of w||[]){const e=f?.processCodes?.lastIndexOf(t);void 0!==e&&f?.processCodes?.splice(e,1)}f&&nl({tournamentId:i?.tournamentId,matchUp:f,context:n,drawDefinition:o})}return m&&nl({tournamentId:i?.tournamentId,matchUp:m,context:n,drawDefinition:o}),{...L,modifiedLineUp:E,participantRemoved:x,participantAdded:k}}function ID({tournamentRecord:t,drawDefinition:e,stage:n=Hu,structureId:r,structure:i}){if(!t)return{error:$};if(!i&&!e)return{error:Y};if(i||r||1!==e?.structures?.filter((t=>t.stage===n)).length||(i=e.structures.find((t=>t.stage===n))),!i&&!r)return{error:Pt};const{error:a,positionAssignments:o}=Rp({drawDefinition:e,structureId:r,structure:i});return{error:a,positionAssignments:o||[],structureId:i?.structureId}}function gD({autoPublish:t=!0,policyDefinitions:e,tournamentRecord:n,drawIds:r=[],auditData:i,eventId:a,event:o}){if(!n)return{error:$};const s="deleteDrawDefinitions";if(!e){const{appliedPolicies:t}=Vo({tournamentRecord:n,event:o});e=t}const c=Array.isArray(r)?r[0]:void 0;if(!o){const t=Ls({tournamentRecord:n,eventId:a,drawId:c});if(t.error)return t;o=t.event}const u=[],d=[],p=[];if(!o?.drawDefinitions)return Oi({info:"event has no drawDefinition",result:{...L},stack:s});const l=o.drawDefinitions.map((({drawId:t})=>t));if(r.length||(r=l),!(r=r.filter((t=>l.includes(t)))).length)return Oi({info:"nothing to do; no matching drawIds in event.",result:{...L},stack:s});const m=ri(_s({event:o}).flightProfile,!1,!0),f=({participantId:t,drawPosition:e,qualifier:n,bye:r})=>({bye:r,qualifier:n,drawPosition:e,participantId:t}),h=o.drawDefinitions.filter((t=>{if(r.includes(t.drawId)){const{drawId:e,drawType:r,drawName:s}=t,c=m?.flights?.find((e=>e.drawId===t.drawId));c&&(c.drawEntries=c.drawEntries?.filter((t=>fp.includes(t.entryStatus))));const l=Yd({stageSequence:1,drawDefinition:t,stage:Hu})?.structures?.[0],h=l?ID({structureId:l.structureId,tournamentRecord:n,drawDefinition:t}):void 0,I=h?.positionAssignments?.map(f),g=Yd({stage:zu,drawDefinition:t})?.structures,U=g?.length?g.map((e=>{const r=e.stageSequence,i=ID({structureId:e.structureId,tournamentRecord:n,drawDefinition:t}),a=i?.positionAssignments.map(f);return{positionAssignments:a,stageSequence:r}})):void 0,y={action:My,payload:{drawDefinitions:[t],eventId:a??o?.eventId,auditData:i}};p.push(y),u.push(di({tournamentId:n.tournamentId,eventId:a??o?.eventId,qualifyingPositionAssignments:U,positionAssignments:I,auditData:i,drawType:r,drawName:s,drawId:e}));const{matchUps:S}=eh({event:o,drawDefinition:t});S?.forEach((({matchUpId:t})=>d.push(t)))}return!r.includes(t.drawId)}));if(o.drawDefinitions=h,m){Ws({event:o,extension:{name:To,value:m}})}ZS({tournamentRecord:n});const I=`${ou}.${cu}`,{timeItem:g}=$f({element:o,itemType:I}),U=g?.itemValue?.[su];let y;for(const S of r){const t=U?.drawIds?.includes(S);if(t){y=!0;const t=U.drawIds?.filter((t=>t!==S))||[],e=lI({event:o,timeItem:{itemType:`${ou}.${cu}`,itemValue:{[su]:{drawIds:t}}}});if(e.error)return{error:e.error}}}if(p.length&&dr({topic:sc,payload:p}),d.length&&el({tournamentId:n?.tournamentId,matchUpIds:d}),r.forEach((t=>{!function({tournamentId:t,eventId:e,drawId:n}){dr({payload:{drawId:n,tournamentId:t,eventId:e},topic:dc,key:n}),lr({key:n})}({drawId:t})})),function({event:t,deletedDrawsDetail:e,auditData:n}){const{extension:r}=tc({name:vo,element:t}),i={...n,deletedDrawsDetail:e},a={name:vo,value:Array.isArray(r?.value)?r?.value.concat(i):[i]};Bs({element:t,extension:a})}({event:o,deletedDrawsDetail:u,auditData:i}),t&&y){const t=BP({tournamentRecord:n,event:o,policyDefinitions:e});t.error&&console.log("publish error",t)}return{...L}}function UD({enforceGender:t=!0,consideredEntries:e,tournamentRecord:n,participants:r,event:i}){if(!(r=r||n?.participants))return{error:_e};if(!Array.isArray(r))return{error:xn};if(!i)return{error:At};const{eventType:a,gender:o}=i,s=a===Nu&&Fu||a===Pu&&Ou||Eu,c=Object.assign({},...(e||i.entries||[]).map((t=>({[t.participantId]:t.entryStatus})))),u=Object.keys(c),d=r.filter((t=>u.includes(t.participantId))).filter((e=>{const n=c[e.participantId],r=a&&[Bi.Doubles,Bi.Team].includes(a)&&e.participantType===Eu&&(Yw(n)||n===cp),i=e.participantType!==s&&!r,u=e?.person?.sex,d=t&&o&&a===Bi.Singles&&[ji.Male,ji.Female].includes(o)&&u!==o;return i||d}));if(d.length){const t=d.map((t=>t.participantId));return{error:Ft,invalidParticipantIds:t}}return{...L}}const yD="COLLEGE_DEFAULT",SD="COLLEGE_JUCO",vD="COLLEGE_D3",wD="DOMINANT_DUO",TD="DOMINANT_DUO_MIXED",PD="LAVER_CUP",DD="TEAM_DOUBLES_3_AGGREGATION",ND="TIME_TENNIS_DUAL",RD="TIME_TENNIS_PRO_CIRCUIT",bD="USTA_BREWER_CUP",MD="USTA_OZAKI_CUP",AD="USTA_COLLEGE",ED="USTA_GOLD_TEAM_CHALLENGE",CD="USTA_LEVEL_1",OD="USTA_INTERSECTIONAL",FD="USTA_SECTION_BATTLE",kD="USTA_SOUTHERN_LEVEL_5",xD="USTA_TOC",_D="USTA_WTT_ITT",LD="USTA_ZONAL",BD={COLLEGE_D3:vD,COLLEGE_DEFAULT:yD,COLLEGE_JUCO:SD,DOMINANT_DUO:wD,DOMINANT_DUO_MIXED:TD,LAVER_CUP:PD,TEAM_DOUBLES_3_AGGREGATION:DD,TIME_TENNIS_DUAL:ND,TIME_TENNIS_PRO_CIRCUIT:RD,USTA_BREWER_CUP:bD,USTA_OZAKI_CUP:MD,USTA_COLLEGE:AD,USTA_GOLD_TEAM_CHALLENGE:ED,USTA_INTERSECTIONAL:OD,USTA_LEVEL_1:CD,USTA_SECTION_BATTLE:FD,USTA_SOUTHERN_LEVEL_5:kD,USTA_TOC:xD,USTA_WTT_ITT:_D,USTA_ZONAL:LD},VD="STANDARD",jD={[VD]:{hydrate:!0,doubles:{matchUpCount:3,matchUpValue:1},singles:{matchUpCount:6,matchUpValue:1},valueGoal:5},[vD]:{hydrate:!0,doubles:{matchUpCount:3,matchUpValue:1,matchUpFormat:"SET1-S:8/TB7@7"},singles:{matchUpFormat:va,matchUpCount:6,matchUpValue:1},tieFormatName:vD,valueGoal:5},[yD]:{hydrate:!0,doubles:{matchUpCount:3,collectionValue:1,matchUpFormat:va},singles:{matchUpCount:6,matchUpValue:1,matchUpFormat:va},tieFormatName:yD,valueGoal:4},[SD]:{hydrate:!0,doubles:{matchUpCount:3,matchUpValue:1,matchUpFormat:"SET1-S:8/TB7"},singles:{matchUpCount:6,matchUpValue:1,matchUpFormat:va},tieFormatName:SD,valueGoal:5},[PD]:Gm,[wD]:Vm,[TD]:jm,[DD]:qm,[ND]:$m,[RD]:Wm,[bD]:Hm,[MD]:zm,[AD]:Ym,[ED]:Km,[OD]:Jm,[CD]:Qm,[FD]:Xm,[kD]:Zm,[_D]:ef,[xD]:tf,[LD]:nf},GD=t=>{const e=t?.namedFormat&&Object.keys(jD).includes(t.namedFormat)?t.namedFormat:VD,n=Array.isArray(t?.uuids)?t?.uuids:[];let r;const{category:i,gender:a}=t?.event??{},o=ri(jD[e],!1,!0);return o.hydrate?(r={winCriteria:{valueGoal:o.valueGoal},collectionDefinitions:[{collectionId:n?.pop()??hi(),matchUpFormat:wa,matchUpType:Bi.Doubles,collectionName:"Doubles",...o.doubles},{collectionId:n?.pop()??hi(),matchUpType:Bi.Singles,matchUpFormat:va,collectionName:"Singles",...o.singles}]},o.tieFormatName&&(r.tieFormatName=o.tieFormatName)):(o.collectionDefinitions.forEach((t=>t.collectionId=hi())),r=o),t?.hydrateCollections&&r.collectionDefinitions.forEach((t=>{i&&!t.category&&(t.category=i),a&&!t.gender&&(t.gender=a)})),r};function qD({suppressNotifications:t,tournamentRecord:e,internalUse:n,event:r}){if(!e)return{error:$};if(e.events||(e.events=[]),!r)return{error:At};const{startDate:i,endDate:a}=e;if(!n&&(r.entries?.length||r.drawDefinitions?.length)){const t=di({drawDefinitions:!!r.drawDefinitions?.length,entries:!!r.entries?.length});return{info:"entries/drawDefinitions cannot exist",error:xn,context:t}}const o=Object.assign({},{drawDefinitions:[],eventType:Bi.Singles,entries:[],startDate:i,endDate:a},r);if(r.eventType===Bi.Team)if(r.tieFormat){const t=$i({tieFormat:r.tieFormat});if(t.error)return t}else if(r.tieFormatName){if(!rf[r.tieFormatName])return{context:{tieFormatName:r.tieFormatName},error:xn};const t=GD({namedFormat:r.tieFormatName});o.tieFormat=t}o.eventId||(o.eventId=hi());if(e.events.reduce(((t,e)=>t||e.eventId===o.eventId),void 0))return{error:Ct};{const n=o;if(e.events.push(n),!t){const{topics:t}=fr();if(t.includes(rc)){const t=nh({event:r}).matchUps||[];tl({tournamentId:e?.tournamentId,eventId:r.eventId,matchUps:t})}for(const e of r.drawDefinitions||[])rl({drawDefinition:e})}return{...L,event:o}}}function $D({tournamentRecord:t,drawDefinition:e,participantIds:n,stageSequence:r,stage:i=Hu,eventId:a,event:o}){if(!t)return{error:$};if(!Array.isArray(n))return{error:xn,participantIds:n};if(!o)return{error:At};if(o){const t=WD({element:o,participantIds:n,stageSequence:r,stage:i});if(t.error)return t}if(e){const t=WD({element:e,participantIds:n,stageSequence:r,stage:i});if(t.error)return a?Oi({context:{drawPromotionError:t.error,drawId:e.drawId},result:{...L},stack:"promoteAlternates"}):t}return{...L}}function WD({participantIds:t,stageSequence:e,element:n,stage:r}){const i=(n.entries||[]).filter((t=>t.entryStatus===Kd)),a=(n.entries||[]).filter((e=>t.includes(e.participantId))),o=i.reduce(((t,e)=>{const{entryPosition:n}=e;return isNaN(n)&&t||(!t||n<t.entryPosition)&&e||t}),void 0),s=a.length?a:[o].filter(Boolean);if(!s?.length)return{error:Qe};const c=s.filter((({entryStatus:t})=>t!==Kd));if(c.length)return{error:Je,invalidEntryStatus:c};const u=s.filter((({entryStage:t})=>t&&t!==r));if(u.length)return{error:Xe,invalidStage:u};const d=e&&s.filter((t=>t.stageSequence!==e));if(d?.length)return{error:Ze,invalidStageSequence:d};for(const p of s){p.entryStatus=Qd;const t=p?.entryPosition;isNaN(t)||n.entries.forEach((e=>{e.entryStatus===Kd&&e.entryPosition>t&&(e.entryPosition=e.entryPosition-1)}));const e=Math.max(...n.entries.filter((t=>t.entryStatus===Qd&&!isNaN(t.entryPosition))).map((({entryPosition:t})=>m(t||0))),0);p.entryPosition=e||0}return{...L}}function HD(t){return Cv(t)}function zD({tournamentRecord:t,drawDefinition:e,participantId:n,entryPosition:r,skipRefresh:i,event:a}){if(!t)return{error:$};if(!n)return Oi({result:{error:Le},stack:"setEntryPositions"});if(void 0!==r&&!Number.isSafeInteger(r))return{error:xn,entryPosition:r};(a?.entries||[]).forEach((t=>{t.participantId===n&&(t.entryPosition=r)})),(e?.entries||[]).forEach((t=>{t.participantId===n&&(t.entryPosition=r)}));const o=t=>{t.entries.forEach((t=>{t.entryPosition===r&&t.participantId!==n&&(t.entryPosition+=.1)}))};return i||(a?.entries&&(o(a),a.entries=zw({entries:a.entries})),e?.entries&&(o(e),e.entries=zw({entries:e.entries}))),{...L}}function YD({scaleAttributes:t,scaledEntries:e,stageEntries:n,seedsCount:r,scaleName:i}){if(!t)return{error:me,info:"missing scaleAttributes"};const a=Object.assign({},...(e||[]).slice(0,r).map((({participantId:t},e)=>({[t]:e+1}))));i=i||t.scaleName;const o=(new Date).toISOString();return{scaleItemsWithParticipantIds:n.map((({participantId:e})=>({scaleItems:[{scaleValue:a[e],eventType:t.eventType,scaleType:ps,scaleName:i,scaleDate:o}],participantId:e})))}}function KD({tournamentRecord:t,scaleAttributes:e,drawDefinition:n,entryStatuses:r,drawId:i,event:a,stage:o}){if(!a)return{error:At};if(r&&!Array.isArray(r))return Oi({result:{error:xn},info:Ci("entryStatus"),stack:"removeScaleValues"});let s=a.entries;if(i){const{flightProfile:t}=_s({event:a}),e=t?.flights?.find((t=>t.drawId===i));s=e?e.drawEntries:n?.entries}return function({tournamentRecord:t,scaleAttributes:e,participantIds:n}){if(!t)return{error:$};if(!n)return{error:Ge};if(!e)return{error:me,info:"scaleAttributes required"};const{scaleType:r,eventType:i,scaleName:a}=e,o=[nu,r,i,a].join(".");return t.participants?.forEach((t=>{n.includes(t.participantId)&&t.timeItems&&(t.timeItems=t.timeItems.filter((t=>t&&t?.itemType!==o)))})),{...L}}({tournamentRecord:t,scaleAttributes:e,participantIds:(s||[]).filter((t=>(!o||!t.entryStage||t.entryStage===o)&&(!r||r.includes(t.entryStatus)))).map(ml)})}function JD({tournamentRecord:t,scaleAttributes:e,participantId:n}){if(!t)return{error:$};if(!n)return{error:Le};const{participant:r}=hs({tournamentRecord:t,participantId:n});return r?yh({participant:r,scaleAttributes:e}):{error:Be}}function QD({sortDescending:t=!1,tournamentRecord:e,scaleAttributes:n,scaleSortMethod:r,stageSequence:i,entries:a,event:o,stage:s}){if(!e)return{error:$};return{scaledEntries:(a=a||o?.entries||[]).filter((t=>(!s||!t.entryStage||t.entryStage===s)&&(!i||!t.entryStageSequence||t.entryStageSequence===i)&&lp.includes(t.entryStatus))).map((t=>{const{participantId:r}=t,{scaleItem:i}=JD({tournamentRecord:e,scaleAttributes:n,participantId:r});return{...t,...i}})).filter((t=>{const e=t.scaleValue;return!!(r||!isNaN(e)&&parseFloat(e))&&e})).sort(r||function(e,n){return t?c(n)-c(e):c(e)-c(n)})};function c(e){return parseFloat(e.scaleValue||(t?-1:1e5))}}function XD({event:t,orderedDrawIdsMap:e}){if("object"!=typeof t)return{error:At};if(!e)return{error:me,info:"Missing drawIdsOrderMap"};if("object"!=typeof e)return{error:xn,info:"orderedDrawIdsMap must be an object"};const n=Object.values(e);if(!n.every((t=>!isNaN(t))))return{error:xn,info:"drawOrder must be numeric"};if(T(n).length!==n.length)return{error:xn,info:"drawOrder values must be unique"};if(t.drawDefinitions?.length){const n=(t.drawDefinitions||[]).map((({drawId:t})=>t)),r=Object.keys(e);if(r?.length&&O(n,r).length!==n.length)return{error:xn,info:"Missing drawIds"};t.drawDefinitions.forEach((t=>{t.drawOrder=e[t.drawId]}))}const{flightProfile:r}=_s({event:t});return r?.flights?.forEach((t=>{t.flightNumber=e[t.drawId]})),{...L}}function ZD({tournamentRecord:t,event:e}){if(!t)return{error:$};if(!e)return{error:At};const{flightProfile:n}=_s({event:e}),r=n?.flights&&Object.assign({},...n.flights.sort(((t,e)=>t.flightNumber-e.flightNumber)).map(((t,e)=>({[t.drawId]:e+1}))))||e.drawDefinitions?.length&&Object.assign({},...e.drawDefinitions.sort(((t,e)=>t.drawOrder-e.drawOrder)).map(((t,e)=>({[t.drawId]:e+1}))))||void 0;return r?XD({event:e,orderedDrawIdsMap:r}):{...L}}function tN({deleteExisting:t,event:e,flightProfile:n}){const r="attachFlightProfile";if(!n)return Oi({result:{error:me},stack:r});if(!e)return Oi({result:{error:At},stack:r});const{flightProfile:i}=_s({event:e});if(i&&!t)return Oi({result:{error:Wn},stack:r});if(e.drawDefinitions?.length)return Oi({result:{error:K},stack:r});return Ws({event:e,extension:{name:To,value:n}}),{flightProfile:ri(n,!1,!0),...L}}const eN="splitWaterfall",nN="splitShuttle",rN={SPLIT_LEVEL_BASED:"splitLevelBased",SPLIT_WATERFALL:eN,SPLIT_SHUTTLE:nN};function iN({tournamentRecord:t,drawDefinition:e,flightProfile:n,drawName:r,drawId:i,event:a}){if(!r||"string"!=typeof r)return Oi({result:{error:xn},context:{drawName:r}});n||(n=_s({event:a}).flightProfile);const o=n?.flights?.find((t=>t.drawId===i));if(o){o.drawName=r;Ws({event:a,extension:{name:To,value:{...n,flights:n.flights}}})}return e&&(e.drawName=r,il({tournamentId:t?.tournamentId,drawDefinition:e})),o||e?{...L,flight:o}:{error:Y}}function aN({qualifyingPositions:t,drawEntries:e=[],drawName:n,drawId:r,event:i,stage:a}){const o="addFlight";if(!i)return Oi({result:{error:At},stack:o});if(!n)return Oi({result:{error:me},stack:o});if(e?.length){const t=(i.entries||[]).map(ui("participantId")),n=e.map(ui("participantId"));if(O(n,t).length!==n.length)return Oi({result:{error:xn},stack:o})}const s=_s({event:i})?.flightProfile,c=s?.flights?.map((({flightNumber:t})=>!isNaN(t)&&m(t)))?.filter(Boolean)||[],u=Math.max(0,...c)+1,d={drawId:r||hi(),flightNumber:u,drawEntries:e,drawName:n};a&&(d.stage=a),t&&(d.qualifyingPositions=t);if((s?.flights||[]).find((({drawId:t})=>t===d.drawId)))return Oi({result:{error:$n},stack:o});const p=(s?.flights||[]).concat(d);return Ws({event:i,extension:{name:To,value:{...s||{},flights:p}}})}function oN({itemType:t="attachStructures",matchUpModifications:e,tournamentRecord:n,drawDefinition:r,structures:i,links:a}){if(!n)return{error:$};if(!r)return{error:Y};const o=Aw({matchUpModifications:e,tournamentRecord:n,drawDefinition:r,structures:i,links:a});if(o.error)return o;const s=i?.map((({structureId:t})=>t));return pI({tournamentRecord:n,timeItem:{itemValue:{structureIds:s,drawId:r.drawId},itemType:t}}),o}function sN({tournamentRecord:t,event:e,startDate:n}){if(!t)return{error:$};if(!e)return{error:At};if(!Rr.test(n))return{error:ye};const r=uN(t);if(r.error)return r;const{tournamentStartDate:i,tournamentEndDate:a}=r,o=new Date($r(n)).getTime();if(!i||!a||o<i||o>a)return{error:ye};const s=e.endDate&&new Date($r(e.endDate));return s&&o>s&&(e.endDate=n),e.startDate=n,{...L}}function cN({tournamentRecord:t,event:e,endDate:n}){if(!t)return{error:$};if(!e)return{error:At};if(!Rr.test(n))return{error:ye};const r=uN(t);if(r.error)return r;const{tournamentStartDate:i,tournamentEndDate:a}=r,o=new Date($r(n)).getTime();if(!i||!a||o<i||o>a)return{error:ye};const s=e.startDate&&new Date($r(e.startDate));return s&&o<s&&(e.startDate=n),e.endDate=n,{...L}}function uN(t){const{startDate:e,endDate:n}=t;return Rr.test(e)&&Rr.test(n)?{tournamentStartDate:new Date($r(e)).getTime(),tournamentEndDate:new Date($r(n)).getTime()}:Oi({result:{error:ve},context:{startDate:e,endDate:n}})}function dN(t){const e="prepareStage";let{seedsCount:n}=t;const r=t.preparedStructureIds||[],{provisionalPositioning:i,inContextDrawMatchUps:a,tournamentRecord:o,appliedPolicies:s,qualifyingOnly:c,drawDefinition:u,seedingProfile:d,participants:p,matchUpsMap:l,automated:m,placeByes:f,drawType:h,drawSize:I,entries:g,event:U,enforcePolicyLimits:y=!0,seedAssignmentProfile:S,seedByRanking:v=!0,seededParticipants:w,assignSeedsCount:T,seedingScaleName:P,stageSequence:D=1,roundTarget:N,stage:R}=t,b=U?.eventType,M=g.filter((t=>{const e=gs({name:Eo,element:t})?.extension?.value;return(!t.entryStage||t.entryStage===R)&&(!D||!t.entryStageSequence||t.entryStageSequence===D)&&(!N||!e||e===N)&&pp.includes(t.entryStatus)}));w&&(n=w.length),n>I&&(n=I),n>M.length&&(n=M.length);const{structures:A}=Yd({drawDefinition:u,stageSequence:D,roundTarget:N,stage:R}),E=(A?.length||0)>1,C=A?.find((({structureId:t})=>!r.includes(t)));if(!C)return Oi({result:{error:Dt},stack:e});const O=C?.structureId,F=C?Tg({provisionalPositioning:i,appliedPolicies:s,drawDefinition:u,structure:C}):void 0,{seedLimit:k}=jw({participantsCount:M.length,enforcePolicyLimits:y,appliedPolicies:s,drawDefinition:u,seedingProfile:d,structureId:O,seedsCount:n});k&&k<n&&(n=k);const x=g.map(ml);if(w)w.filter((({participantId:t})=>x.includes(t))).filter((t=>!t.seedNumber||t.seedNumber<=w.length)).sort(((t,e)=>t.seedNumber<e.seedNumber?-1:t.seedNumber<e.seedNumber?1:0)).forEach((t=>{const{participantId:e,seedNumber:n,seedValue:r}=t;Mg({provisionalPositioning:i,tournamentRecord:o,drawDefinition:u,seedingProfile:d,participantId:e,seedBlockInfo:F,structureId:O,seedNumber:n,seedValue:r,event:U})}));else if(U||P){const{categoryName:t,ageCategoryCode:e}=U?.category||{},r={scaleType:ps,scaleName:P||t||e||U.eventId,eventType:b};let{scaledEntries:a}=QD({scaleAttributes:r,tournamentRecord:o,stageSequence:D,entries:g,stage:R});if(!a?.length&&v){const n={scaleName:t||e,scaleType:cs,eventType:b};({scaledEntries:a}=QD({scaleAttributes:n,tournamentRecord:o,stageSequence:D,entries:g,stage:R}))}const s=a?.length??0;s<n&&(n=s),a?.filter((({participantId:t})=>x.includes(t))).slice(0,T||n).forEach(((t,e)=>{const n=e+1,{participantId:r,scaleValue:a}=t;Mg({provisionalPositioning:i,tournamentRecord:o,drawDefinition:u,seedingProfile:d,participantId:r,structureId:O,seedNumber:n,seedValue:S?.[n]||a||n,event:U})}))}let _,L,B=[];if(!1!==m&&h!==hd&&(!c||R===zu)){const t="object"==typeof m&&m.seedsOnly,n=Sw({inContextDrawMatchUps:a,multipleStructures:E,tournamentRecord:o,appliedPolicies:s,drawDefinition:u,seedingProfile:d,participants:p,structureId:O,matchUpsMap:l,placeByes:f,seedLimit:k,seedsOnly:t,drawSize:I,drawType:h,event:U});if(n.conflicts&&(B=n?.conflicts),_=n?.positionAssignments,L=n?.positioningReport,n.error)return Oi({result:n,stack:e})}return{positionAssignments:_,positioningReport:L,stageEntries:M,structureId:O,seedsCount:n,conflicts:B}}function pN(t){const e="generateDrawDefinition",{considerEventEntries:n=!0,ignoreAllowedDrawTypes:r,voluntaryConsolation:i,hydrateCollections:a,policyDefinitions:o,ignoreStageSpace:s,tournamentRecord:c,qualifyingOnly:u,tieFormatName:d,drawEntries:p,addToEvent:l,placeByes:f,event:h}=t,I=Vo({tournamentRecord:c,event:h}).appliedPolicies??{},g=(t.drawTypeCoercion??I?.[uo]?.drawTypeCoercion??!0)&&2===t.drawSize&&Fi.SingleElimination||t.drawType||Fi.SingleElimination,{participants:U}=sU({withIndividualParticipants:!0,tournamentRecord:c}),S=t.enforceGender??o?.[Xa]?.participants?.enforceGender??I?.[Xa]?.participants?.enforceGender,w=!r&&c&&uD({tournamentRecord:c,categoryType:h?.category?.categoryType,categoryName:h?.category?.categoryName});if(w?.length&&!w.includes(g))return Oi({result:{error:ct},stack:e});const T=h?.entries?.filter((t=>t.entryStatus&&[...fp,np].includes(t.entryStatus)))??[],P=(u&&[]||p||(n?T:[])).filter((({entryStage:t})=>!t||t===Hu)),D=h&&U&&UD({consideredEntries:P,enforceGender:S,participants:U,event:h});if(D?.error)return Oi({result:D,stack:e});const N=!t.drawSize&&P.length&&![hd,Sd,Id,kd,xd].includes(g)&&y(P.length)||t.drawSize&&v(t.drawSize)&&m(t.drawSize)||!1;if(isNaN(N)&&g!==hd)return Oi({result:{error:pt},stack:e});let R="number"!=typeof t.seedsCount?m(t.seedsCount??0):t.seedsCount??0;const b=h?.eventType,M=t.matchUpType??b,A=t.drawId?h?.drawDefinitions?.find((e=>e.drawId===t.drawId)):void 0;let{tieFormat:C,matchUpFormat:O}=t;if(M===Ca&&b===Ca){const t=A?.structures?.find((({stage:t})=>t===Hu))?.tieFormat;C=C||t||d&&h?.tieFormat?.tieFormatName===d&&h.tieFormat||d&&GD({namedFormat:d,hydrateCollections:a,event:h})||h?.tieFormat||GD({event:h,hydrateCollections:a}),O=void 0}else O||(C=void 0,h?.matchUpFormat||(O=va));if(C){const t=$i({gender:h?.gender,enforceGender:S,tieFormat:C});if(t.error)return Oi({result:t,stack:e})}if(t.drawId&&"string"!=typeof t.drawId)return Oi({result:{error:xn},stack:e});A&&g!==A.drawType&&(A.drawType=g);let F=A??XT({drawType:g,drawId:t.drawId,processCodes:t.processCodes});if(O||C){if(!(O&&h?.matchUpFormat===O||h?.tieFormat&&C&&JSON.stringify(h.tieFormat)===JSON.stringify(C))){if(C){const t=function(t){const e=$i({tieFormat:t,checkCollectionIds:!1});if(e.error)return e;for(const n of t.collectionDefinitions)n.collectionId||(n.collectionId=hi());return{tieFormat:t}}(C);if(t.error)return Oi({result:t,stack:e});F.tieFormat=t.tieFormat??C}else if(O){const t=Wg({tournamentRecord:c,drawDefinition:F,matchUpFormat:O,event:h});if(t.error)return{error:t.error,info:"matchUpFormat or tieFormat error"}}M&&(F.matchUpType=M)}}if(o){if("object"!=typeof o)return Oi({info:"policyDefinitions must be an object",result:{error:xn},stack:e});{const t={};for(const e of Object.keys(o))JSON.stringify(I?.[e])!==JSON.stringify(o[e])&&(t[e]=o[e]);Object.keys(t).length&&(xT({drawDefinition:F,policyDefinitions:t}),Object.assign(I,t))}}I[so]||(xT({drawDefinition:F,policyDefinitions:_f}),Object.assign(I,_f));let k=A?.structures?.find((t=>t.stage===Hu&&1===t.stageSequence))?.structureId;const x=p??T,_=[];let B,V=[];const j=t.qualifyingPlaceholder&&!t.qualifyingProfiles?.length&&!A,G=A?A.structures?.filter((t=>t.stage===zu)):[],q=1===G?.length&&!G[0].matchUps?.length&&G[0].structureId;if(q){const e=t.qualifyingProfiles,n=e?.length?Dv({idPrefix:t.idPrefix,isMock:t.isMock,uuids:t.uuids,qualifyingProfiles:e,appliedPolicies:I}):void 0;if(n?.error)return n;F.structures=F.structures?.filter((({structureId:t})=>t!==q)),F.links=F.links?.filter((({source:t})=>t.structureId!==q));const{qualifiersCount:r,qualifyingDrawPositionsCount:i,qualifyingDetails:a}=n??{};i&&(n?.structures&&F.structures?.push(...n.structures),n?.links&&F.links?.push(...n.links));const o=F.structures?.find((({stage:t,stageSequence:e})=>t===Hu&&1===e)),{qualifiersCount:s}=zv({stageSequence:1,drawDefinition:F,structureId:k,stage:Hu});let c=Jv({qualifiersCount:Math.max(r??0,s??0),drawDefinition:F,stage:Hu});if(c.error)return c;if(c=Kv({drawSize:i,stage:zu,drawDefinition:F}),c.error)return c;for(const t of(p??[]).filter((({entryStage:t})=>t===ki.Qualifying))){Xw({...t,entryStage:t.entryStage??ki.Main,drawDefinition:F})}for(const t of a||[]){const{finalQualifyingRoundNumber:e,finalQualifyingStructureId:n,roundTarget:r,finishingPositions:i,linkType:a}=t,s=o&&vv({targetStructureId:o.structureId,sourceStructureId:n,sourceRoundNumber:e,finishingPositions:i,targetEntryRound:r,linkType:a})?.link;if(s?.error)return s;s&&(F.links||(F.links=[]),F.links.push(s))}B={drawDefinition:F}}else{if(B=Qv({...t,modifyOriginal:!1,tournamentRecord:c,appliedPolicies:I,drawDefinition:F,matchUpFormat:O,matchUpType:M,tieFormat:C,drawSize:N}),B.error)return Oi({result:B,stack:e});F=B.drawDefinition;for(const t of x){if(p&&t.entryStage&&t.entryStage!==ki.Main)continue;const n=Xw({...t,ignoreStageSpace:s??g===hd,entryStage:t.entryStage??ki.Main,drawDefinition:F,drawType:g});if(p&&n.error)return Oi({result:n,stack:e})}g===Td&&(R=0);const n=dN({...B,...t,qualifyingOnly:!N||u,appliedPolicies:I,drawDefinition:F,participants:U,stage:Hu,seedsCount:R,placeByes:f,drawSize:N,entries:x});if(n.error&&!n.conflicts)return n;if(n.positioningReport?.length&&_.push({[Hu]:n.positioningReport}),k=n.structureId,n.conflicts&&(V=n.conflicts),g===hd&&t.roundsCount){const e=h?.entries?.filter((({entryStage:t,entryStatus:e})=>(!t||t===Hu)&&e&&lp.includes(e))),n=e?.map(ui("participantId")),r=e?Math.floor(e.length/2):0;E(1,t.roundsCount+1).forEach((()=>{if(t.automated){const{restrictEntryStatus:e,generateMatchUps:r,addToStructure:i,maxIterations:a,structureId:o,matchUpIds:s,scaleName:u}=t.drawMatic??{};bT({tournamentRecord:c,participantIds:n,drawDefinition:F,eventType:t.drawMatic?.eventType??M,generateMatchUps:r??!0,restrictEntryStatus:e,addToStructure:i,maxIterations:a,structureId:o,matchUpIds:s,scaleName:u})}else xw({addToStructure:!0,tournamentRecord:c,newRound:!0,drawDefinition:F,matchUpsCount:r})}))}}const $=[];if(t.qualifyingProfiles){const n=(t,e)=>t.stageSequence-e.stageSequence,r=(t,e)=>t.roundTarget-e.roundTarget,i=[];let a=1;t.qualifyingProfiles.sort(r);for(const o of t.qualifyingProfiles){if(!Array.isArray(o.structureProfiles))return Oi({info:Ci("structureProfiles"),result:{error:me},stack:e});a=o.roundTarget||a;const r=o.structureProfiles?.sort(n)||[];let s=1;for(const e of r){const{qualifyingRoundNumber:n,qualifyingPositions:r,seededParticipants:o,seedingScaleName:c,seedsCount:d=0,seedingProfile:p,seedByRanking:l,placeByes:m,drawSize:f}=e,h=dN({...B,...t,stageSequence:s,qualifyingRoundNumber:n,preparedStructureIds:i,qualifyingPositions:r,seededParticipants:o,stage:zu,seedingScaleName:c,appliedPolicies:I,drawDefinition:F,qualifyingOnly:u,seedingProfile:p,seedByRanking:l,participants:U,roundTarget:a,seedsCount:d,placeByes:m,drawSize:f,entries:x});if(h.error)return h;h.structureId&&i.push(h.structureId),s+=1,h.conflicts?.length&&$.push(...h.conflicts),h.positioningReport?.length&&_.push({[zu]:h.positioningReport})}a+=1}}else if(k&&j){const t=Ug({structureName:gg(zu),stage:zu}),{link:e}=vv({sourceStructureId:t.structureId,targetStructureId:k,sourceRoundNumber:0,linkType:_i.Position});F.structures||(F.structures=[]),F.structures.push(t),F.links||(F.links=[]),F.links.push(e)}return F.drawName=t.drawName??(g&&gg(g)),"object"==typeof i&&function(t){const{tournamentRecord:e}=t;e&&Sv({participants:e.participants,...t})}({...i,tournamentRecord:c,appliedPolicies:I,drawDefinition:F,matchUpType:M}),l&&Jg({tournamentRecord:c,drawDefinition:F,event:h}),{existingDrawDefinition:!!A,qualifyingConflicts:$,positioningReports:_,drawDefinition:F,structureId:k,...L,conflicts:V}}const lN={generateQualifyingStructure:function(t){const{tournamentRecord:e}=t;return e?Dw({participants:e.participants,...t}):{error:$}},attachQualifyingStructure:function({tournamentRecord:t,drawDefinition:e,structure:n,link:r}){if(!t)return{error:$};if(!e)return{error:Y};const i=Nw({tournamentId:t.tournamentId,drawDefinition:e,structure:n,link:r});return i.error||pI({tournamentRecord:t,timeItem:{itemType:"attachQualifyingStructures",itemValue:{structureId:n.structureId,drawId:e.drawId}}}),i},attachPlayoffStructures:function(t){return oN({...t,itemType:"attachPlayoffStructures"})},addQualifyingStructure:function(t){const e=t.tournamentRecord;if(!e)return{error:$};const n=bw(t);if(n.error)return n;const{qualifyingRoundNumber:r,qualifyingPositions:i,targetStructureId:a,drawDefinition:o,structureName:s,matchUpType:c,drawSize:u,drawType:d}=t;return pI({tournamentRecord:e,timeItem:{itemType:"addQualifyingStructures",itemValue:di({drawId:o.drawId,structureName:s,targetStructureId:a,qualifyingPositions:i,qualifyingRoundNumber:r,matchUpType:c,drawSize:u,drawType:d})}}),n},setStructureOrder:Ow,attachStructures:oN,renameStructures:function(t){return Fw(t)},disableTieAutoCalc:function(t){return t.tournamentRecord?CT(t):{error:$}},enableTieAutoCalc:function(t){return t.tournamentRecord?OT(t):{error:$}},validateCollectionDefinition:Wi,modifyCollectionDefinition:wU,orderCollectionDefinitions:DU,removeCollectionDefinition:MU,addCollectionDefinition:AU,removeCollectionGroup:FU,addCollectionGroup:kU,modifyTieFormat:xU,resetScorecard:function(t){return VU(t)},resetTieFormat:BU,setEventStartDate:sN,setEventEndDate:cN,setEventDates:function({tournamentRecord:t,event:e,startDate:n,endDate:r}){if(!t)return{error:$};if(!e)return{error:At};if(!n&&!r)return{error:me,info:"missing date"};if(n&&!Rr.test(n))return{error:ye};if(r&&!Rr.test(r))return{error:ye};if(n&&r){if(new Date($r(n))>new Date($r(r)))return{error:xn}}if(n){const r=sN({tournamentRecord:t,event:e,startDate:n});if(r.error)return r}if(r){const n=cN({tournamentRecord:t,event:e,endDate:r});if(n.error)return n}return{...L}},deleteEvents:function({removePairParticipants:t,tournamentRecord:e,eventIds:n}){if(!e)return{error:$};if(!e.events)return{error:Et};if(!Array.isArray(n))return{error:me,info:Ci("drawIds")};const r=[],i=[],a=[],o=[];if(e.events=(e.events||[]).filter((t=>{if(n.includes(t.eventId)){const n={action:Ey,payload:{events:[t]}};r.push(n),i.push({tournamentId:e.tournamentId,eventName:t.eventName,eventType:t.eventType,category:t.category,eventId:t.eventId,gender:t.gender})}const s=t.eventType===Tu?(t.entries||[]).map((({entryStatus:t,participantId:e})=>t!==ap&&e)).filter(Boolean):[],c=n.includes(t.eventId);return c?o.push(...s):a.push(...s),!c})),t){const t=o.filter((t=>!a.includes(t)));e.participants=e.participants.filter((({participantId:e})=>!t.includes(e)))}if(ZS({tournamentRecord:e}),r.length){dr({topic:sc,payload:r});pI({tournamentRecord:e,timeItem:{itemType:Ey,itemValue:i}})}return{...L}},modifyEvent:function({tournamentRecord:t,eventUpdates:e,eventId:n,event:r}){const i="modifyEvent";if(!t)return Oi({result:{error:$},stack:i});if(!oi(n))return Oi({result:{error:At},context:{eventId:n},stack:i});if(!si(e))return Oi({result:{error:xn},context:{eventUpdates:e},stack:i});const a=r?.entries?.filter((({entryStatus:t})=>{const e=t;return[...lp,Kd].includes(e)})).map((({participantId:t})=>t))??[],o=a?sU({participantFilters:{participantIds:a},withIndividualParticipants:!0,tournamentRecord:t}).participants??[]:[],s=[],c=o.reduce(((t,e)=>{const n=e.person?.sex?[e.person.sex]:e.individualParticpants?.map((t=>t.person?.sex))||[];return s.push(...n),t.includes(e.participantType)?t:t.concat(e.participantType)}),[]),u=T(s),d=!u.length||[Bp,_p].includes(e.gender??"")||1===u.length&&u[0]===e.gender;if(e.gender&&!d)return Oi({context:{gender:e.gender,validGender:d},result:{error:xn},stack:i});const p=(c.includes(Du)&&[Du]||c.includes(Eu)&&[vu]||c.includes(Ou)&&[Tu]||[Tu,vu,Du]).includes(e.eventType??"");return e.eventType&&!p?Oi({context:{participantType:e.eventType,validEventType:p},result:{error:xn},stack:i}):(e.eventType&&(r.eventType=e.eventType),e.eventName&&(r.eventName=e.eventName),e.gender&&(r.gender=e.gender),{...L})},addEvent:qD,removeSeededParticipant:function({tournamentRecord:t,drawDefinition:e,participantId:n,structureId:r}){const i="removeSeededParticipant";if(!t)return{error:$};if(!e)return{error:Y};const a=(e.structures??[]).find((t=>t.structureId===r));if(!a)return Oi({result:{error:Dt},stack:i});if(!a.stage||![ki.Main,ki.Qualifying].includes(a.stage)||a.stage===ki.Main&&1!==a.stageSequence)return Oi({result:{error:Q},stack:i});const o=a.seedAssignments?.find((t=>t.participantId===n));return o?{...L}:Oi({info:"participant not seeded",result:{error:Gn},context:{participantId:n}})},removeScaleValues:KD,checkValidEntries:UD,addDrawEntries:tT,removeSeeding:function({tournamentRecord:t,drawDefinition:e,entryStatuses:n,scaleName:r,drawId:i,event:a,stage:o}){return t?a?(r=r||a.category?.categoryName||a.category?.ageCategoryCode,KD({tournamentRecord:t,scaleAttributes:{eventType:a.eventType,scaleType:ps,scaleName:r},drawDefinition:e,entryStatuses:n,drawId:i,event:a,stage:o})):{error:At}:{error:$}},autoSeeding:function({tournamentRecord:t,drawDefinition:e,policyDefinitions:n,scaleAttributes:r,scaleName:i,drawSize:a,drawId:o,event:s,stage:c,sortDescending:u,scaleSortMethod:d}){const p=dD({policyDefinitions:n,drawDefinition:e,drawSize:a,drawId:o,event:s,stage:c});if(p.error)return p;const{entries:l,seedsCount:m,stageEntries:f}=p;if(!f||!m)return{error:xn};const h=QD({tournamentRecord:t,scaleAttributes:r,scaleSortMethod:d,sortDescending:u,entries:l,stage:c}).scaledEntries??[],{scaleItemsWithParticipantIds:I}=YD({scaleAttributes:r,scaledEntries:h,stageEntries:f,seedsCount:m,scaleName:i});return{scaleItemsWithParticipantIds:I}},getAvailablePlayoffRounds:HD,getAvailablePlayoffProfiles:HD,getAssignedParticipantIds:Uh,deleteDrawDefinitions:gD,addPlayoffStructures:function(t){const e=t.tournamentRecord;if(!e)return{error:$};const n=Ew(t);if(n.error)return n;const{playoffStructureNameBase:r,playoffPositions:i,roundNumbers:a,structureId:o}=t;return pI({tournamentRecord:e,timeItem:{itemType:"addPlayoffStructures",itemValue:di({playoffStructureNameBase:r,playoffPositions:i,roundNumbers:a,structureId:o})}}),n},modifyDrawDefinition:function({tournamentRecord:t,drawDefinition:e,drawUpdates:n,drawId:r,event:i}){if(!si(n))return{error:xn};const a=_s({event:i}).flightProfile,o=n.drawName&&iN({drawName:n.drawName,tournamentRecord:t,drawDefinition:e,flightProfile:a,drawId:r,event:i});if(o?.error)return o?.error;const s=o?.flight||a?.flights?.find((t=>t.drawId===r));if(!s&&!e)return{error:Y};if(s){Ws({event:i,extension:{name:To,value:{...a,flights:a.flights}}})}return e&&(n.policyDefinitions&&xT({policyDefinitions:n.policyDefinitions,drawDefinition:e}),il({tournamentId:t?.tournamentId,drawDefinition:e})),{...L}},addDrawDefinition:Jg,removeStructure:kw,modifyDrawName:iN,generateAndPopulatePlayoffStructures:ww,generateSeedingScaleItems:YD,setSubOrder:hT,addEventEntries:rT,promoteAlternate:function(t){const{participantId:e}=t;return e&&"string"!=typeof e?{error:xn,participantId:e}:$D({...t,participantIds:[e].filter(Boolean)})},promoteAlternates:$D,destroyPairEntry:dT,destroyPairEntries:function(t){if(!t.tournamentRecord)return{error:$};const{participantIds:e,...n}=t;let r=0;const i=[];for(const a of e){const t=uT({participantId:a,...n});t.success&&(r+=1),t.error&&i.push(t.error)}return r?{destroyedCount:r,...L}:{error:i}},setEntryPosition:zD,setEntryPositions:function({tournamentRecord:t,entryPositions:e,drawDefinition:n,event:r}){if(!t)return{error:$};if(!Array.isArray(e))return{error:xn};for(const i of e){const{participantId:e,entryPosition:a}=i,o=zD({skipRefresh:!0,tournamentRecord:t,drawDefinition:n,participantId:e,entryPosition:a,event:r});if(o.error)return o}return r?.entries&&(r.entries=zw({entries:r.entries})),n?.entries&&(n.entries=zw({entries:n.entries})),{...L}},addEventEntryPairs:function({allowDuplicateParticipantIdPairs:t,entryStage:e=ki.Main,entryStatus:n=Kd,participantIdPairs:r=[],tournamentRecord:i,drawDefinition:a,event:o,uuids:s}){if(!i)return{error:$};if(!o)return{error:At};if(o.eventType!==Aa)return{error:Mt};const c=i.participants||[],u=c.filter((t=>t.participantType===Eu)).map((t=>t.participantId)),d=u.filter((t=>!u.includes(t)));if(d.length)return{error:Ce,invalidParticipantIds:d};const p=r.filter((t=>2!==t.length));if(p.length)return{error:Ce,invalidParticipantIdPairs:p};const l=c.filter((t=>t.participantType===Ou)).map((t=>t.individualParticipantIds)),m=r.map((t=>({participantId:s?.pop()||hi(),participantRole:TP,individualParticipantIds:t,participantType:Ou}))),f=t?m:m.filter((t=>!l.find((e=>2===O(e,t.individualParticipantIds).length))));let h,I=[];if(f){const e=Xg({allowDuplicateParticipantIdPairs:t,participants:f,returnParticipants:!0,tournamentRecord:i});if(e.error)return e;I=e.participants||[],h=e.info}const g=rT({participantIds:r.map((t=>{const e=I.find((e=>2===O(e.individualParticipantIds,t).length));if(e)return e;const{participant:n}=Vu({tournamentRecord:i,participantIds:t});return n})).map((t=>t.participantId)),tournamentRecord:i,drawDefinition:a,entryStatus:n,entryStage:e,event:o});return f.length&&dr({payload:{participants:f},topic:ic}),{...g,info:h,newParticipantIds:f.map(ml)}},removeEventEntries:nT,removeDrawEntries:function({autoEntryPositions:t=!0,participantIds:e,drawDefinition:n,drawId:r,stages:i,event:a}){if(!a)return{error:At};if(!r)return{error:lt};if(!e?.length)return{error:Ge};if(k(Uh({drawDefinition:n,stages:i}).assignedParticipantIds??[],e))return{error:ze};const o=t=>{const n=t.participantId;return!e.includes(n)},{flightProfile:s}=_s({event:a}),c=s?.flights?.find((t=>t.drawId===r));return c?.drawEntries&&(c.drawEntries=c.drawEntries.filter(o),t&&(c.drawEntries=zw({entries:c.drawEntries}))),n?.entries&&(n.entries=n.entries.filter(o),t&&(n.entries=zw({entries:n.entries}))),{...L}},modifyEventEntries:function({entryStatus:t=Qd,unpairedParticipantIds:e=[],participantIdPairs:n=[],entryStage:r=Hu,tournamentRecord:i,event:a}){if(!i)return{error:$};if(!a)return{error:At};const o=i.participants||[],s=o.filter((t=>t.participantType===Eu)).map((t=>t.participantId)),c=e.concat(...n).flat(1/0).filter((t=>!s.includes(t)));if(c.length)return{error:Ce,invalidParticipantIds:c};const u=n.filter((t=>2!==t.length));if(u.length)return{error:Ce,invalidParticipantIdPairs:u};const d=o.filter((t=>t.participantType===Ou)).map((t=>t.individualParticipantIds)),p=Xg({participants:n.filter((t=>!d.find((e=>2===O(e,t).length)))).map((t=>({participantType:Ou,participantRole:TP,individualParticipantIds:t}))),tournamentRecord:i});if(p.error)return p;const l=n.map((t=>{const{participant:e}=Vu({tournamentRecord:i,participantIds:t});return e})).map((e=>({participantId:e,entryStatus:t,entryStage:r}))),m=e.map((t=>({entryStatus:ap,participantId:t,entryStage:r})));return a.entries=(a.entries||[]).filter((t=>t.entryStage===r)),a.entries=a.entries.concat(...l,...m),{...L}},modifyEntriesStatus:Kw,modifySeedAssignment:function({tournamentRecord:t,drawDefinition:e,participantId:n,structureId:r,seedValue:i,event:a}){return t?(t.participants||[]).find((t=>t.participantId===n))?HT({tournamentRecord:t,drawDefinition:e,participantId:n,structureId:r,seedValue:i,event:a}):{error:Ee}:{error:$}},modifyPairAssignment:function({replacementIndividualParticipantId:t,existingIndividualParticipantId:e,tournamentRecord:n,drawDefinition:r,participantId:i,event:a,uuids:o}){if(!a)return{error:At};if(a?.eventType!==Tu)return{error:Mt};if(o&&!Array.isArray(o))return{error:xn};if(!n)return{error:$};if(![t,e,i].every((t=>"string"==typeof t)))return{error:Le};if(!(a?.entries?.filter((({entryStatus:t})=>[ap,op].includes(t))).map((({participantId:t})=>t))||[]).includes(t))return{error:Ee};const s=(n.participants||[]).find((t=>t.participantId===i));if(s?.participantType!==Ou)return{error:Ae,participant:s};const c=s.individualParticipantIds,u=[t,...c.filter((t=>t!==e))],{participant:d}=Vu({participantIds:u,tournamentRecord:n});let p;if(d)p=d.participantId;else{const t=Qg({participant:{participantId:o?.pop(),participantRole:TP,individualParticipantIds:u,participantType:Ou},returnParticipant:!0,tournamentRecord:n});if(t.error)return t;p=t.participant.participantId}const{flightProfile:l}=_s({event:a});if(r){const t=l?.flights?.find((({drawId:t})=>t===r.drawId));t&&(t.drawEntries=t.drawEntries.map((t=>t.participantId===i?{...t,participantId:p}:t))),r.entries=r.entries.map((t=>t.participantId===i?{...t,participantId:p}:t));for(const e of r.structures||[])if(e.positionAssignments)e.positionAssignments=e.positionAssignments.map((t=>t.participantId===i?{...t,participantId:p}:t));else if(e.structures)for(const t of e.structures)t.positionAssignments=t.positionAssignments.map((t=>t.participantId===i?{...t,participantId:p}:t))}a.entries=a.entries.map((n=>n.participantId===i&&{...n,participantId:p}||n.participantId===t&&{...n,participantId:e}||n));const m=n.events.some((({entries:t,eventId:e,drawDefinitions:n})=>a.eventId===e?n.some((({drawId:t,entries:e})=>t!==r?.drawId&&e?.find((t=>t.participantId===i)))):t?.find((t=>t.participantId===i))));if(!m){const t=sT({addIndividualParticipantsToEvents:!1,participantIds:[i],tournamentRecord:n});if(t.error)return t}return{...L,participantOtherEntries:m,newPairParticipantId:p}},resetVoluntaryConsolationStructure:function({tournamentRecord:t,drawDefinition:e,resetEntries:n,event:r}){if(!e)return{error:Y};const i=e.structures?.find((t=>t.stage===Ku));if(!i)return{error:Dt};const a=i.matchUps?.map((({matchUpId:t})=>t))||[];return i.positionAssignments=[],i.seedAssignments=[],i.matchUps=[],el({tournamentId:t?.tournamentId,action:"resetVoluntaryConsolationStructure",matchUpIds:a,drawDefinition:e}),n&&(e.entries=e.entries.filter((t=>t.entryStage!==Ku))),il({tournamentId:t?.tournamentId,eventId:r?.eventId,drawDefinition:e,structureIds:[i.structureId]}),{...L}},deleteFlightProfileAndFlightDraws:function({autoPublish:t=!0,tournamentRecord:e,auditData:n,event:r}){if(!e)return{error:$};if(!r)return{error:At};const{flightProfile:i}=_s({event:r});if(i){const a=i.flights?.map((({drawId:t})=>t)).filter(Boolean),o=gD({eventId:r.eventId,tournamentRecord:e,autoPublish:t,auditData:n,drawIds:a,event:r});return o.error?o:zs({event:r,name:To})}return{...L}},deleteFlightAndFlightDraw:function({autoPublish:t=!0,tournamentRecord:e,auditData:n,drawId:r,event:i}){if(!e)return{error:$};if(!r)return{error:lt};if(!i)return{error:At};const{flightProfile:a}=_s({event:i});if(a){const t=a.flights?.find((t=>t.drawId===r));if(t){const t=a.flights.filter((t=>t.drawId!==r));Ws({event:i,extension:{name:To,value:{...a,flights:t}}})}}const o=i.drawDefinitions?.find((t=>t.drawId===r));if(o){const a=gD({drawIds:[r],eventId:i.eventId,tournamentRecord:e,autoPublish:t,auditData:n,event:i});if(a.error)return a}return ZD({tournamentRecord:e,event:i})},generateFlightProfile:function(t){const{drawNameRoot:e="Flight",attachFlightProfile:n,tournamentRecord:r,scaleAttributes:i,scaleSortMethod:a,deleteExisting:o,sortDescending:s,drawNames:c=[],flightsCount:u,splitMethod:d,uuids:p=[],event:l,stage:m}=t;if(!l)return{error:At};const f=l.entries||[],{flightProfile:h}=_s({event:l});if(h&&n&&!o)return{error:Wn};const I=t.scaledEntries??QD({tournamentRecord:r,scaleAttributes:i,scaleSortMethod:a,sortDescending:s,event:l,stage:m}).scaledEntries,g=I.map(ml),U=P(f.filter((({participantId:t})=>!g.includes(t))).filter((t=>(!m||!t.entryStage||t.entryStage===m)&&(!t.entryStatus||pp.includes(t.entryStatus))))),y=I.concat(...U),S=y.length;let v=x(y,Math.ceil(S/u));d===eN?v=_(y,u):d===nN&&(v=_(y,u,!0));const w={scaleAttributes:i,splitMethod:d,flights:E(0,u).map((t=>{const n=t+1;return{flightNumber:n,drawId:p?.pop()||hi(),drawEntries:(r=v[t],(r||[]).map((({participantId:t,scaleValue:e})=>{const n=f.find((e=>e.participantId===t));return n?.scaleValue&&e&&(n.scaleValue=e),n})).sort(((t,e)=>t.scaleValue-e.scaleValue)).map(((t,e)=>(t.scaleValue&&(t.seedNumber=e+1),t)))),drawName:c?.length&&c[t]||`${e} ${n}`};var r}))};if(n){const t=tN({flightProfile:w,deleteExisting:o,event:l});return{splitEntries:ir()&&v||void 0,...t}}return{flightProfile:w,...L}},refreshEventDrawOrder:ZD,attachFlightProfile:tN,resetDrawDefinition:function({tournamentRecord:t,removeScheduling:e,drawDefinition:n}){if(!n)return{error:Y};const r=wp({drawDefinition:n}),i=t=>r?.drawMatchUps?.find((e=>e.matchUpId===t));for(const a of n.structures||[]){const{positionAssignments:o,stage:s,stageSequence:c}=a;!o||1===c&&[zu,Hu].includes(s)||(a.positionAssignments=o.map((t=>(delete t.participantId,t))),a.seedAssignments=[]);const{matchUps:u}=qp({afterRecoveryTimes:!1,inContext:!0,matchUpsMap:r,structure:a});for(const r of u){const{matchUpId:a,roundNumber:o,sides:s}=r,c=i(a);if(c){if(delete c.extensions,delete c.notes,c.matchUpStatus!==Ki&&Object.assign(c,Nl),o&&o>1&&c.drawPositions){const t=s?.map((({drawPosition:t,participantFed:e})=>!e&&t)).filter(Boolean),e=c.drawPositions.map((e=>t.includes(e)?void 0:e));c.drawPositions=e}e?delete c.timeItems:c.timeItems?.length&&(c.timeItems=c.timeItems.filter((t=>t.itemType&&![Bc,Vc,Lc,qc,Gc,$c].includes(t.itemType)))),nl({tournamentId:t?.tournamentId,context:"resetDrawDefiniton",drawDefinition:n,matchUp:c})}}}return il({drawDefinition:n,structureIds:(n.structures||[]).map((({structureId:t})=>t))}),{...L}},pruneDrawDefinition:function({matchPlayDrawPositions:t=!0,tournamentRecord:e,drawDefinition:n,drawId:r}){if(!e)return{error:$};if(!n)return{error:Y};let i=[];const{drawsAnalysis:a}=iD({tournamentRecord:e});if(a.canBePruned.includes(r)){const o=a.matchPlay.includes(r),s=a.drawAnalysis[r],{structures:[c]}=Yd({stageSequence:1,drawDefinition:n,stage:Hu}),u=s.structuresData.find((({structureId:t})=>c.structureId===t)),d=c.matchUps||[];i=d.sort(((t,e)=>t.roundPosition-e.roundPosition)).filter((({roundNumber:t})=>!u.inactiveRounds.includes(t)));const p=i.map(hl),l=d.map(hl).filter((t=>!p.includes(t)));if(o){const e=i.sort(((t,e)=>t.roundPosition-e.roundPosition)).filter((({roundNumber:t})=>!u.inactiveRounds.includes(t))).filter((({winningSide:t})=>t)),n=e.map(hl),r=p.filter((t=>!n.includes(t)));l.push(...r);const a=e.flatMap((t=>t.drawPositions||[])).filter(Boolean).flat(),o=Object.assign({},...a.map(((t,e)=>({[t]:e+1}))));if(e.forEach((e=>{t?e.drawPositions=e.drawPositions.map((t=>o[t])):delete e.drawPositions})),t){const t=c?.positionAssignments?.filter((t=>a.includes(t.drawPosition))).map((t=>(t.drawPosition=o[t.drawPosition],t)));c.positionAssignments=t}else c.positionAssignments=[];c.matchUps=e,i=e}el({tournamentId:e?.tournamentId,matchUpIds:l,drawDefinition:n}),il({drawDefinition:n})}return{...L,matchUps:i}},updateDrawIdsOrder:XD,getFlightProfile:_s,getScaledEntries:QD,generateLineUps:YP,addFlight:aN,generateAdHocMatchUps:function(t){return xw(t)},deleteAdHocMatchUps:function(t){return Cw(t)},addAdHocMatchUps:function(t){return _w(t)},drawMatic:function(t){const e=t.tournamentRecord?.participants;return Object.assign(t,{tournamentParticipants:e}),bT(t)},setOrderOfFinish:function(t){return FT(t)},setDelegatedOutcome:function(t){return AT(t)},removeDelegatedOutcome:function(t){return gT(t)},addVoluntaryConsolationStructure:Sv,addVoluntaryConsolationStage:function(t){return Tw(t)},generateVoluntaryConsolation:function(t){const{tournamentRecord:e}=t;return e?Pw({participants:e.participants,...t}):{error:$}},attachConsolationStructures:function(t){return oN({...t,itemType:"attachConsolationStructures"})},bulkMatchUpStatusUpdate:Yg,updateTieMatchUpScore:function(t){return t.tournamentRecord?bl(t):{error:$}},aggregateTieFormats:function({tournamentRecord:t}){if(!t)return{error:$};let e=0;for(const n of t.events??[]){const r=n.tieFormats??[],i=t=>{if(!t.tieFormat)return;let n;for(const e of r){hh({descendant:t.tieFormat,ancestor:e}).different||(n=e.tieFormatId)}if(n)t.tieFormatId=n,delete t.tieFormat;else{const n=ri(t.tieFormat,void 0,!0);n.tieFormatId||(n.tieFormatId=hi()),t.tieFormatId=n.tieFormatId,delete t.tieFormat,r.push(n),e+=1}};i(n);for(const t of n.drawDefinitions??[]){i(t);for(const e of t.structures??[])i(e)}const a=(e,r)=>{const i=s.eventMatchUps?.find((t=>t.matchUpId===e));i&&(i.tieFormatId=r,delete i.tieFormat,nl({tournamentId:t?.tournamentId,eventId:n.eventId,matchUp:i}))},o=t=>{const n=ri(t.tieFormat,void 0,!0);n.tieFormatId||(n.tieFormatId=hi()),r.push(n),e+=1,a(t.matchUpId,n.tieFormatId)},s=nh({matchUpFilters:{matchUpTypes:[Ea]},event:n}),c=s.matchUps??[];for(const t of c){let e;for(const n of r){t.tieFormat&&hh({descendant:t.tieFormat,ancestor:n}).different||(e=n.tieFormatId)}e?a(t.matchUpId,e):o(t)}r.length&&(n.tieFormats=r)}return{...L,addedCount:e}},setMatchUpFormat:function({tournamentRecord:t,drawDefinition:e,scheduledDates:n,stageSequences:r,matchUpFormat:i,structureIds:a,structureId:o,eventType:s,matchUpId:c,eventIds:u,eventId:d,drawIds:p,stages:l,drawId:m,event:f,force:h}){const I="setMatchUpFormat";if(!t)return{error:$};if(!i)return{error:zt};if(i&&!Ti(i))return Oi({result:{error:Gt,matchUpFormat:i},stack:I});if(n&&!Array.isArray(n))return Oi({result:{error:xn,scheduledDates:n},stack:I});if(s&&![vu,Tu].includes(s))return Oi({result:{error:Mt},stack:I});let g=0;if((o||a)&&!e)return Oi({result:{error:Y},stack:I});if(m&&c){const n=Wg({tournamentRecord:t,drawDefinition:e,matchUpFormat:i,structureIds:a,structureId:o,matchUpId:c});if(n.error)return n;g+=1}const U=e=>{const o=[];for(const s of e.structures||[]){if(Array.isArray(l)&&!l.includes(s.stage)||Array.isArray(r)&&!r.includes(s.stageSequence)||a.length&&!a.includes(s.structureId))continue;a.length&&s.matchUpFormat!==i&&(s.matchUpFormat=i,o.push(s.structureId),g+=1);const c=(h||n)&&qp({matchUpFilters:{matchUpStatuses:[Vi.ToBePlayed]},structure:s}),u=n&&qp({matchUpFilters:{matchUpStatuses:[Vi.ToBePlayed]},contextFilters:{scheduledDates:n},afterRecoveryTimes:!1,inContext:!0,structure:s});if(c?.length){const r=u?u.map(hl):c.map(hl);for(const a of c)r.includes(a.matchUpId)&&(a.matchUpFormat=n?.length?i:void 0,nl({tournamentId:t?.tournamentId,eventId:f?.eventId,context:I,drawDefinition:e,matchUp:a}))}}return o.length||e.matchUpFormat===i||(e.matchUpFormat=i,g+=1),o};a=a||[o].filter(Boolean),u=u||[d].filter(Boolean),p=p||[m].filter(Boolean);for(const y of t.events||[])if(!(u?.length&&!u.includes(y.eventId)||s&&s!==y.eventType||s===Du))if(Array.isArray(r)||Array.isArray(l)||a.length||p.length)for(const t of y.drawDefinitions||[]){if(Array.isArray(p)&&!p.includes(t.drawId))continue;il({structureIds:U(t),drawDefinition:t})}else y.matchUpFormat!==i&&(y.matchUpFormat=i,g+=1);return g?{...L,modificationsCount:g}:{...L,info:bn}},setMatchUpStatus:zg,assignDrawPosition:function({tournamentRecord:t,drawDefinition:e,participantId:n,drawPosition:r,structureId:i,qualifier:a,event:o,bye:s}){if(!e)return{error:Y};if(!r)return{error:st};if(!i)return{error:Pt};if(s){const n=YI({tournamentRecord:t,drawDefinition:e,drawPosition:r,structureId:i,event:o});if(n.error)return n}else{if(a)return{error:qn};{const a=Fg({tournamentRecord:t,drawDefinition:e,participantId:n,drawPosition:r,structureId:i,event:o});if(a.error)return a}}return{...L}},assignSeedPositions:function(t){const{provisionalPositioning:e,useExistingSeedLimit:n,tournamentRecord:r,drawDefinition:i,seedingProfile:a,structureId:o,assignments:s,drawId:c,event:u}=t;let d=0;if(!s?.length)return{error:kt};if(!r)return{error:$};if(!c)return{error:lt};const p=Sp({provisionalPositioning:e,drawDefinition:i,structureId:o});if(p.error)return p;const{seedAssignments:l,seedLimit:m}=p,f=Object.assign({},...(l||[]).filter((t=>t.seedNumber)).map((t=>({[t.seedNumber]:t}))));s.forEach((t=>{const{seedNumber:e}=t;m&&e<=m&&(!n||f[e])&&(f[e]=t)}));const h=Object.values(f),I=h.map((t=>t?.participantId)).filter(Boolean);if(I.length!==b(I).length)return{error:ft};for(const g of h){const t=Mg({...g,provisionalPositioning:e,tournamentRecord:r,drawDefinition:i,seedingProfile:a,structureId:o,event:u});if(t?.error)return t;t?.success&&d++}return d?{...L,modifications:d}:{error:bn}},assignDrawPositionBye:function({tournamentRecord:t,drawDefinition:e,drawPosition:n,structureId:r,event:i}){return YI({tournamentRecord:t,drawDefinition:e,drawPosition:n,structureId:r,event:i})},substituteParticipant:function(t){return function({substituteParticipantId:t,existingParticipantId:e,tournamentRecord:n,drawDefinition:r,sideNumber:i,matchUpId:a,event:o}){const s="substituteParticipant";if(!r)return{error:Y};if(!a)return{error:Jt};if(!e||!t)return Oi({result:{error:Le},stack:s});const{matchUp:c}=$p({drawDefinition:r,matchUpId:a,event:o});if(!c)return{error:Xt};if(!c.collectionId)return Oi({result:{error:ee},stack:s});const u=wp({drawDefinition:r}),{matchUps:d}=Pl({tournamentParticipants:n?.participants,inContext:!0,drawDefinition:r,matchUpsMap:u}),p=d?.find((t=>t.matchUpId===a)),l=d?.find((t=>t.matchUpId===p?.matchUpTieId)),m=l?.sides?.find((t=>t.participant.individualParticipants.some((({participantId:t})=>t===e))));if(!m||i&&m.sideNumber!==i)return{error:Ee};const f=m.participant?.individualParticipants?.map(ml).filter((t=>t!==e));return f.includes(t)?hD({newParticipantId:t,tieMatchUpId:a,existingParticipantId:e,substitution:!0,tournamentRecord:n,drawDefinition:r,event:o}):Oi({result:{error:Ee},stack:s})}(t)},removeRoundMatchUps:function({removeCompletedMatchUps:t,tournamentRecord:e,drawDefinition:n,structureId:r,roundNumber:i,event:a}){if(!e)return{error:$};if(!n)return{error:Y};if(!i)return Oi({result:{error:me},info:"roundNumber required"});const o=zd({drawDefinition:n,structureId:r});if(o.error)return o;const s=o.structure;return s?.structures?{error:Q}:Fp({drawDefinition:n,structure:s})?function({removeCompletedMatchUps:t,drawDefinition:e,tournamentId:n,roundNumber:r,structure:i,eventId:a}){const o=i?.matchUps??[],s=[];let c=!1;if(o.reduce(((t,e)=>{const n=e?.roundNumber;return n?t.includes(n)?t:t.concat(n):t}),[]).sort(l).includes(r)){const u=o.filter((e=>{const n=e.roundNumber===r&&(!fa.includes(e.matchUpStatus)||t);return n&&s.push(e.matchUpId),!n}));if(s.length){el({matchUpIds:s,drawDefinition:e,tournamentId:n,eventId:a});u.some((t=>t.roundNumber===r))||(u.forEach((t=>{t.roundNumber>r&&(t.roundNumber-=1,nl({drawDefinition:e,tournamentId:n,eventId:a,matchUp:t}))})),c=!0),i.matchUps=u}}return{deletedMatchUpsCount:s.length,roundRemoved:c,...L}}({tournamentId:e.tournamentId,removeCompletedMatchUps:t,eventId:a.eventId,drawDefinition:n,roundNumber:i,structure:s}):(console.log("not implemented"),{...L})},swapDrawPositionAssignments:function(t){return lT(t)},assignMatchUpSideParticipant:function({tournamentRecord:t,drawDefinition:e,participantId:n,sideNumber:r,matchUpId:i,event:a}){if(n&&"string"!=typeof n)return{error:Ee};if(!e)return{error:Y};if(!i)return{error:Jt};const o=void 0===r;if(o&&(r=1),![1,2].includes(r))return{error:xn,sideNumber:r};const{matchUp:s,structure:c}=$p({drawDefinition:e,matchUpId:i,event:a});if(!s)return{error:Xt};if(!!(c?.structures||e.drawType&&e.drawType!==hd||c?.matchUps?.find((({roundPosition:t})=>!!t))))return{error:ct};if(!n&&(s?.score?.scoreStringSide1||fa.includes(s?.matchUpstatus)||s?.matchUpStatus&&[ea,ta].includes(s.matchUpStatus)))return{error:be,info:"matchUp has completed status or score"};if(s){if(s.sides=[1,2].map((t=>{const e=s.sides?.find((e=>e.sideNumber===t))||{sideNumber:t};return r===t?{...e,participantId:n}:e})),o)for(const t of s.sides)t.sideNumber&&(t.sideNumber=3-t.sideNumber);nl({tournamentId:t?.tournamentId,context:"assignSideParticipant",drawDefinition:e,matchUp:s})}return{...L,sidesSwapped:o}},removeMatchUpSideParticipant:function({tournamentRecord:t,drawDefinition:e,sideNumber:n,matchUpId:r,event:i}){if(!t)return{error:$};if(!e)return{error:Y};if(!r)return{error:Jt};if(!n)return{error:me};if(![1,2].includes(n))return{error:xn,sideNumber:n};const{matchUp:a,structure:o}=$p({drawDefinition:e,matchUpId:r,event:i});return a?o?.structures||e.drawType&&e.drawType!==hd||o?.matchUps?.find((({roundPosition:t})=>!!t))?{error:ct}:(a.sides?.forEach((t=>{t.sideNumber===n&&delete t.participantId})),nl({tournamentId:t?.tournamentId,context:"assignSideParticipant",drawDefinition:e,matchUp:a}),{...L}):{error:Xt}},removeDrawPositionAssignment:pT,alternateDrawPositionAssignment:function(t){return Ww(t)},withdrawParticipantAtDrawPosition:function(t){return Object.assign(t,{entryStatus:cp}),pT(t)},setDrawParticipantRepresentativeIds:function({representativeParticipantIds:t,drawDefinition:e}){if(!e)return{error:J};if(!Array.isArray(t))return{error:xn};const n=ll(e?.entries||[]);return t.length&&O(t,n).length<t.length?{error:xn}:$s({drawDefinition:e,extension:{name:bo,value:t}})},getDrawParticipantRepresentativeIds:function({drawDefinition:t}){const e=Ss({name:"participantRepresentatives",drawDefinition:t});return e.error?e:{representativeParticipantIds:e.extension?.value||[]}},luckyLoserDrawPositionAssignment:function(t){return function({luckyLoserParticipantId:t,tournamentRecord:e,drawDefinition:n,drawPosition:r,structureId:i}){return $w({positionActionName:"luckyLoserDrawPositionAssignment",participantId:t,tournamentRecord:e,drawDefinition:n,drawPosition:r,structureId:i})}(t)},qualifierDrawPositionAssignment:function(t){return function({qualifyingParticipantId:t,tournamentRecord:e,drawDefinition:n,drawPosition:r,structureId:i}){return $w({positionActionName:"qualifierDrawPositionAssignment",participantId:t,isQualifierPosition:!0,tournamentRecord:e,drawDefinition:n,drawPosition:r,structureId:i})}(t)},setPositionAssignments:function(t){return Hw(t)},automatedPositioning:function({applyPositioning:t=!0,tournamentRecord:e,drawDefinition:n,seedingProfile:r,structureId:i,placeByes:a,seedsOnly:o,drawSize:s,event:c}){if(!c)return{error:Et};if(!n)return{error:J};const u=e?.participants;return Sw({tournamentRecord:e,applyPositioning:t,drawDefinition:n,seedingProfile:r,participants:u,structureId:i,placeByes:a,seedsOnly:o,drawSize:s})},automatedPlayoffPositioning:vw,checkInParticipant:function({tournamentRecord:t,participantId:e,matchUpId:n,matchUp:r,drawId:i}){r&&!i&&({drawId:i}=r),r&&!n&&({matchUpId:n}=r);const{drawDefinition:a}=Ls({tournamentRecord:t,drawId:i});if(!a)return{error:Et};{const r=$y({tournamentParticipants:t.participants,drawDefinition:a,participantId:e,matchUpId:n});if(r.error&&r.error!==We)return r}return{...L}},checkOutParticipant:function({tournamentRecord:t,participantId:e,matchUpId:n,matchUp:r,drawId:i}){r&&!i&&({drawId:i}=r),r&&!n&&({matchUpId:n}=r);const{drawDefinition:a}=Ls({tournamentRecord:t,drawId:i});if(!a)return{error:Et};{const r=Wy({tournamentParticipants:t.participants,drawDefinition:a,participantId:e,matchUpId:n});if(r.error)return r}return{...L}},toggleParticipantCheckInState:Hy,addDrawDefinitionTimeItem:EP,generateDrawTypeAndModifyDrawDefinition:function(t){return Qv(t)},generateDrawStructuresAndLinks:function(t){return Hv(t)},generateDrawMaticRound:RT,generateDrawDefinition:pN,applyLineUps:function({tournamentRecord:t,drawDefinition:e,matchUpId:n,lineUps:r,event:i}){if(!t)return{error:$};if(!e)return{error:J};if("string"!=typeof n)return{error:ee};if(!Array.isArray(r))return{error:xn,lineUps:r};const a=t.participants||[];let o=$p({tournamentParticipants:a,inContext:!0,drawDefinition:e,matchUpId:n});if(o.error)return o;if(!o.matchUp)return{error:Xt};const{matchUp:s,structure:c}=o,{drawPositions:u,matchUpType:d}=s;if(d!==Ca)return{error:ee};if(!u?.length)return{error:it};const p=Ri({matchUp:s,drawDefinition:e,structure:c,event:i})?.tieFormat,l={};for(const f of r){if(!Array.isArray(f))return{error:xn,lineUp:f};const e={},n=[];for(const t of f){if("object"!=typeof t)return{error:xn,lineUpAssignment:t};const{participantId:r,collectionAssignments:i=[]}=t;if(!Array.isArray(i))return{error:xn,collectionAssignments:i};const o=a.find((t=>t.participantId===r));if(!o)return{error:Be};if(o.participantType!==Eu)return{error:Fe};const c=s.sides?.find((t=>t.participant?.individualParticipantIds?.includes(r)))?.sideNumber;c&&n.push(c);for(const t of i){if("object"!=typeof t)return{error:xn,collectionAssignment:t};const{collectionId:n,collectionPosition:i}=t,a=p?.collectionDefinitions?.find((t=>t.collectionId===n));if(!a)return{error:xn,collectionId:n};const o=`${n}-${i}`;e[o]||(e[o]=[]);const s=e[o].length;if(a.matchUpType===ba&&s||a.matchUpType===Aa&&s>1)return{info:"Excessive collectionPosition assignments",error:xn};e[o].push(r)}}const r=Object.values(e);for(const s of r)if(2===s.length){const{participant:e}=Vu({tournamentParticipants:a,participantIds:s});if(!e){const e=Qg({participant:{participantType:Ou,participantRole:TP,individualParticipantIds:s},pairOverride:!0,tournamentRecord:t});if(e.error)return e}}const i=N(n),o=((i[1]||0)>(i[2]||0)?1:(i[2]||0)>(i[1]||0)&&2)||void 0,c=Object.keys(l).map((t=>parseInt(t)));o&&!c.includes(o)&&(l[o]=f)}if(!Object.keys(l).length)return{error:jn};if(o=$p({drawDefinition:e,matchUpId:n}),o.error)return o;if(!o.matchUp)return{error:Xt};const{matchUp:m}=o;m.sides||(m.sides=[]);for(const f of[1,2]){const t=m.sides.find((t=>t.sideNumber===f)),e=l[f];e&&(t?t.lineUp=e:m.sides.push({lineUp:e,sideNumber:f}))}return nl({tournamentId:t?.tournamentId,context:"applyLineUps",drawDefinition:e,matchUp:m}),{...L}},assignTieMatchUpParticipantId:qP,removeTieMatchUpParticipantId:function(t){const{tournamentRecord:e,drawDefinition:n,participantId:r,event:i}=t,a="removeTieMatchUpParticiapantId";if(!r)return Oi({result:{error:Le},stack:a});const o=GP(t);if(o.error)return o;const{appliedPolicies:s}=Vo({tournamentRecord:e,drawDefinition:n,event:i}),c=s?.[Xa]||gS[Xa],u=c?.processCodes?.substitution,{inContextDualMatchUp:d,inContextTieMatchUp:p,relevantAssignments:l,collectionPosition:m,teamParticipants:f,collectionId:h,matchUpType:I,dualMatchUp:g,tieMatchUp:U,tieFormat:y}=o;if(!g)return Oi({result:{error:te},stack:a});const S=p?.sides?.find((t=>t.participant?.participantId===r||t.participant?.individualParticipantIds?.includes(r)));if(!S)return Oi({result:{error:Be},stack:a});if(!S.substitutions?.length&&(Yp({score:p?.score})||p?.winningSide))return Oi({result:{error:Hn},stack:a});const v=d?.sides?.find((({sideNumber:t})=>t===S.sideNumber))?.participantId;if(!v)return Oi({result:{error:Be},stack:a});const w=sU({participantFilters:{participantIds:[r]},tournamentRecord:e})?.participants?.[0];if(!w)return Oi({result:{error:Be},stack:a});if(I===ba&&w.participantType===Ou)return Oi({result:{error:Ae},stack:a});const T=w.participantType===Eu?[r]:w.individualParticipantIds;if(!g?.sides?.length){const{extension:t}=gs({element:n,name:Do}),e=t?.value||{},r=({displaySideNumber:t,drawPosition:e,sideNumber:n})=>({drawPosition:e,sideNumber:n,displaySideNumber:t});g.sides=d?.sides?.map((t=>{const n=t.participantId;return{...r(t),lineUp:n&&e[n]||[]}}))}let P=g.sides?.find((({sideNumber:t})=>t===S.sideNumber));if(!P&&(g.sides?.filter((({lineUp:t})=>!t)).length||0)<2){const t=f?.map((({participantId:t})=>({drawPosition:l?.find((e=>e.participantId===t))?.drawPosition,teamParticipantId:t})));P=g.sides?.find((e=>t?.find((({drawPosition:t})=>t===e.drawPosition))?.teamParticipantId===v))}if(!P)return console.log({teamParticipantId:v,teamParticipants:f}),{error:Be,participantId:r};const{modifiedLineUp:D,previousParticipantIds:N}=jP({collectionPosition:m,teamParticipantId:v,dualMatchUpSide:P,participantIds:T,drawDefinition:n,collectionId:h});if(P.lineUp=D,v&&y&&Cg({participantId:v,lineUp:D,drawDefinition:n,tieFormat:y}),I===Aa&&w.participantType===Eu){const t=p?.sides?.find((t=>t.sideNumber===P?.sideNumber)),{participantId:n}=t||{},i=n&&sU({participantFilters:{participantIds:[n]},tournamentRecord:e,withDraws:!0})?.participants?.[0];if(!i)return Oi({result:{error:Be},stack:a});{const t=i?.individualParticipantIds?.filter((t=>t!==r))??[];if(N&&t.push(...N),t.length>2)return Oi({result:{error:Ce},stack:a});if(i.draws?.length){if(1===t.length){const{participant:n}=Vu({participantIds:t,tournamentRecord:e});if(!n){const n=Qg({participant:{participantRole:TP,individualParticipantIds:t,participantType:Ou},pairOverride:!0,tournamentRecord:e});if(n.error)return Oi({result:n,stack:a})}}}else if(t.length){i.individualParticipantIds=t;const n=AP({participant:i,pairOverride:!0,tournamentRecord:e});if(n.error)return Oi({result:n,stack:a})}else{const t=sT({participantIds:[n],tournamentRecord:e});t.error&&console.log("cleanup",{result:t})}}}if(1===S.substitutions?.length){const t=p?.sides?.find((t=>t.sideNumber!==S.sideNumber));if(!t?.substitutions?.length&&U?.processCodes?.length){for(const t of u||[]){const e=U.processCodes.lastIndexOf(t);U.processCodes.splice(e,1)}nl({tournamentId:e?.tournamentId,matchUp:U,context:a,drawDefinition:n})}}return nl({tournamentId:e?.tournamentId,matchUp:g,context:a,drawDefinition:n}),{...L,modifiedLineUp:D}},replaceTieMatchUpParticipantId:hD,resetMatchUpLineUps:function(t){return t.tournamentRecord?fT(t):{error:$}},updateTeamLineUp:Cg,validateLineUp:Eg,getTeamLineUp:ju};function mN({exclusionRule:t,valueAccessor:e,matchUpType:n,scaleName:r,sides:i}){const a=t?.range.sort(),o=e=>{const n=e?.[t?.valueAccessor];return{exclude:t&&n>=a[0]&&n<=a[1],exclusionValue:n}};return i.sort(((t,e)=>t.sideNumber-e.sideNumber)).map((({participant:t})=>{const i=[],a=t?.individualParticipants;if(a?.length){const s=[];let c=0;for(const t of a){const{scaleValue:a,value:u}=fN({valueAccessor:e,participant:t,matchUpType:n,scaleName:r}),{exclude:d,exclusionValue:p}=o(a);d&&i.push(p),s.push(a),u&&!isNaN(c)?c+=u:c=void 0}return{participantName:t.participantName,exclusionValues:i,scaleValues:s,value:c}}if(t){const{scaleValue:a,value:s}=fN({valueAccessor:e,matchUpType:n,participant:t,scaleName:r}),{exclude:c,exclusionValue:u}=o(a);return c&&i.push(u),{participantName:t.participantName,exclusionValues:i,scaleValue:a,value:s}}return{}}))}function fN({participant:t,valueAccessor:e,matchUpType:n,scaleName:r}){const i=t?.rankings?.[n]?.find((t=>t.scaleName===r)),a=t?.ratings?.[n]?.find((t=>t.scaleName===r)),o=(a||i)?.scaleValue;return{scaleValue:o,value:e?o?.[e]:o}}const hN={allTournamentMatchUps:th,tournamentMatchUps:rh,allEventMatchUps:nh,getRoundMatchUps:function(t){return Gu(t)},allDrawMatchUps:eh,eventMatchUps:ih,drawMatchUps:function({participants:t,tournamentAppliedPolicies:e,scheduleVisibilityFilters:n,participantsProfile:r,afterRecoveryTimes:i,policyDefinitions:a,useParticipantMap:o,tournamentRecord:s,contextFilters:c,contextProfile:u,contextContent:d,drawDefinition:p,matchUpFilters:l,participantMap:m,nextMatchUps:f,tournamentId:h,inContext:I,context:g,event:U}){const{eventId:y,eventName:S,endDate:v}=U??{},w={...g,...di({eventId:y,eventName:S,endDate:v??U?.endDate??s?.endDate,tournamentId:h??s?.tournamentId,indoorOutDoor:U?.indoorOutdoor??s?.indoorOutdoor,surfaceCategory:U?.surfaceCategory??s?.surfaceCategory})};return!t?.length&&s&&({participants:t,participantMap:m}=Zf({participantsProfile:r,policyDefinitions:a,useParticipantMap:o,tournamentRecord:s,contextProfile:u,inContext:I})),U&&u&&!d&&(d=Ko({policyDefinitions:a,tournamentRecord:s,contextProfile:u,drawDefinition:p,event:U})),Dl({context:w,tournamentAppliedPolicies:e,scheduleVisibilityFilters:n,tournamentParticipants:t,participantsProfile:r,afterRecoveryTimes:i,policyDefinitions:a,tournamentRecord:s,participantMap:m,drawDefinition:p,matchUpFilters:l,contextFilters:c,contextProfile:u,contextContent:d,nextMatchUps:f,inContext:I,event:U})},credits:hS,getTournamentStructures:function({withStageGrouping:t,tournamentRecord:e,stageSequences:n,stageSequence:r,roundTarget:i,stages:a,stage:o}){if(!e)return{error:$};const s={},c=[];for(const u of e.events||[]){const{structures:e,stageStructures:d}=ug({withStageGrouping:t,stageSequences:n,stageSequence:r,roundTarget:i,stages:a,event:u,stage:o});if(e&&c.push(...e),d)for(const t of Object.keys(d))s[t]||(s[t]=[]),s[t].push(...d[t])}return{structures:c,stageStructures:s}},getEventStructures:ug,getEvents:function({tournamentRecord:t,withScaleValues:e,scaleEventType:n,inContext:r,eventIds:i,drawIds:a,context:o}){if(!t)return{error:$};const{tournamentId:s}=t,c=(t.events??[]).filter((({eventId:t})=>!i||Array.isArray(i)&&i.includes(t))).map((t=>{const e=ri(t);return r&&Object.assign(e,{tournamentId:s}),o&&Object.assign(e,o),e})),u={};if(e){const e=sU({withScaleValues:!0,tournamentRecord:t}).participantMap,r=t=>t.reduce(((t,e)=>t+parseFloat(e)),0);for(const t of c){const i=n??t.eventType,o=t.eventId;u[o]||(u[o]={ratingsStats:{},ratings:{},ranking:{},draws:{}});const s=(t.entries??[]).filter((({entryStatus:t})=>lp.includes(t))).map(ui("participantId")),c=t=>{if(t?.ratings?.[i])for(const e of t?.ratings?.[i]??[]){const t=e.scaleName;u[o].ratings[t]||(u[o].ratings[t]=[]);const n=Bm[t]?.accessor;if(n){const r=parseFloat(e.scaleValue?.[n]);r&&u[o].ratings[t].push(r)}}};for(const t of s){const n=e?.[t]?.participant;if(n?.participantType!==Eu)for(const t of n?.individualParticipantIds??[]){const n=e?.[t]?.participant;c(n)}else c(n)}const d=u[o].ratings;for(const t of Object.keys(d))u[o].ratingsStats[t]={avg:r(d[t])/d[t].length,median:h(d[t]),max:Math.max(...d[t]),min:Math.min(...d[t])};const p=(t,n)=>{const r=e=>{if(e?.ratings?.[i])for(const n of e?.ratings?.[i]??[]){const e=n.scaleName;u[o].draws[t].ratings[e]||(u[o].draws[t].ratings[e]=[]);const r=Bm[e]?.accessor;if(r){const i=parseFloat(n.scaleValue?.[r]);i&&u[o].draws[t].ratings[e].push(i)}}};for(const i of n.filter(Boolean)){const t=e?.[i]?.participant;if(t?.participantType!==Eu)for(const n of t?.individualParticipantIds??[]){const t=e?.[n]?.participant;r(t)}else r(t)}},l=[],m=t=>a?.length&&a.includes(t)||l.includes(t);for(const e of t.drawDefinitions??[]){const t=e.drawId;if(m(t))continue;const n=Uh({drawDefinition:e}).assignedParticipantIds??[];u[o].draws[t]||(u[o].draws[t]={ratingsStats:{},ratings:{},ranking:{}}),l.push(t),p(t,n)}const f=_s({event:t}).flightProfile;for(const t of f?.flights??[]){const e=t.drawId;if(m(e))continue;p(e,t.drawEntries.map(ui("participantId")))}for(const t of l){const e=u[o].draws[t].ratings;for(const n of Object.keys(e))u[o].draws[t].ratingsStats[n]={avg:r(e[n])/e[n].length,max:Math.max(...e[n]),min:Math.min(...e[n]),median:h(e[n])}}}}return di({eventScaleValues:u,events:c,...L})},getEvent:function({tournamentRecord:t,drawDefinition:e,context:n,event:r}){if(!t)return{error:$};if(!r)return{error:At};const i=ri(r);return n&&Object.assign(i,n),di({drawDefinition:e&&i.drawDefinitions?.find((({drawId:t})=>e.drawId===t)),event:i})},findDrawDefinitionExtension:Ss,findParticipantExtension:function({tournamentRecord:t,participantId:e,name:n}){if(!t)return Oi({result:{error:$},stack:Is});if(!e)return Oi({result:{error:Le},stack:Is});const{participant:r}=hs({tournamentRecord:t,participantId:e});return gs({element:r,name:n})},findTournamentExtension:Us,findEventExtension:ys,findExtension:tc,getTieFormat:function({tournamentRecord:t,drawDefinition:e,structureId:n,matchUpId:r,structure:i,eventId:a,drawId:o,event:s}){if(!t)return{error:$};if(!(o||s||n||r))return Oi({result:{error:me},stack:"getTieFormat"});a&&!s&&(s=t.events?.find((t=>t.eventId===a)));const c=_U({tournamentRecord:t,drawDefinition:e,matchUpId:r,drawId:o,event:s});if(r&&c?.error)return c;if(!e&&c?.drawDefinition&&(e=c?.drawDefinition),!(i=i??c?.structure)&&n&&!r){if(!e)return{error:lt};const t=zd({drawDefinition:e,structureId:n});if(t.error)return t;i=t.structure}const u=(i?.tieFormat||i?.tieFormatId)&&Ri({structure:i,drawDefinition:e,event:s})?.tieFormat,d=(e?.tieFormat||e?.tieFormatId)&&Ri({drawDefinition:e,event:s})?.tieFormat,p=Ri({event:s})?.tieFormat,l=Ri({matchUp:c?.matchUp,drawDefinition:e,structure:i,event:s})?.tieFormat;return{...L,matchUp:c?.matchUp,structureDefaultTieFormat:zp(u),eventDefaultTieFormat:zp(p),drawDefaultTieFormat:zp(d),tieFormat:zp(l),structure:i}},getMatchUpFormat:function({tournamentRecord:t,drawDefinition:e,structureId:n,matchUpId:r,drawId:i,event:a}){if(!t)return{error:$};if(!(i||a||n||r))return Oi({result:{error:me},stack:"getMatchUpFormat"});const o=LU({tournamentRecord:t,drawDefinition:e,matchUpId:r,drawId:i,event:a});if(r&&o?.error)return o;!e&&o?.drawDefinition&&(e=o?.drawDefinition);let s=o?.structure;if(!s&&n&&!r){if(!e)return{error:lt};const t=zd({drawDefinition:e,structureId:n});if(t.error)return t;s=t.structure}const c=s?.matchUpFormat,u=e?.matchUpFormat,d=a?.matchUpFormat;return{structureDefaultMatchUpFormat:c,eventDefaultMatchUpFormat:d,drawDefaultMatchUpFormat:u,matchUpFormat:o?.matchUp?.matchUpFormat||c||u||d}},getDrawDefinition:function({tournamentRecord:t,drawDefinition:e}){return t?e?{drawDefinition:ri(e)}:{error:lt}:{error:$}},getEventProperties:function({tournamentRecord:t,event:e}){if(!t)return{error:$};if(!e)return{error:At};const n=e.entries||[],r=t.participants||[],i=e.category?.categoryName||e.category?.ageCategoryCode,{eventType:a}=e,o=n.map((t=>t.participantId));let s,c,u;return{entryScaleAttributes:r.filter((t=>o.includes(t.participantId))).map((t=>{const{participantId:e,participantName:n,name:r}=t;let o={scaleType:au,eventType:a,scaleName:i};const d=yh({participant:t,scaleAttributes:o})?.scaleItem?.scaleValue;o={scaleType:iu,eventType:a,scaleName:i};const p=yh({participant:t,scaleAttributes:o})?.scaleItem?.scaleValue;o={scaleType:ru,eventType:a,scaleName:i};const l=yh({participant:t,scaleAttributes:o})?.scaleItem?.scaleValue;return s=!(!s&&!d),c=!(!c&&!p),u=!(!u&&!l),{participantId:e,participantName:n||r,seed:d,ranking:p,rating:l}})),hasSeededParticipants:s,hasRankedParticipants:c,hasRatedParticipants:u}},getPositionAssignments:ID,isValidMatchUpFormat:Ti,getMaxEntryPosition:function(t){const{entries:e=[],entryStatus:n,stage:r}=t;return Math.max(...e.filter((t=>!(r&&r!==t.entryStage||n&&t.entryStatus!==n||isNaN(t.entryPosition)))).map((({entryPosition:t})=>m(t||0))),0)},getMatchUpCompetitiveProfile:rs,findVenue:Cc,getCourts:function({tournamentRecord:t,venueId:e,venueIds:n}){return t?{courts:(t.venues||[]).filter((t=>e?t.venueId===e:!n||n.includes(t.venueId))).map((t=>{const{venueId:e}=t,n=ri(t.courts||[]);return n.forEach((t=>Object.assign(t,{venueId:e}))),n})).flat()}:{error:$}},getVenuesAndCourts:Ec,findCourt:function(t){return ri(Oc(t),!1,!0)},getEventTimeItem:Wf,getTournamentTimeItem:Hf,getParticipantTimeItem:function({returnPreviousValues:t,tournamentRecord:e,participantId:n,itemSubTypes:r,itemType:i}){if(!e)return{error:$};if(!n)return{error:Le};const a=hs({tournamentRecord:e,participantId:n});if(a.error)return a;const{participant:o}=a;if(!o?.timeItems)return{info:Gn};const{timeItem:s,previousItems:c,info:u}=$f({element:a.participant,returnPreviousValues:t,itemSubTypes:r,itemType:i});return s&&{timeItem:s,previousItems:c}||{info:u}},getDrawDefinitionTimeItem:function({returnPreviousValues:t,drawDefinition:e,itemSubTypes:n,itemType:r}){if(!e)return{error:lt};if(!e.timeItems)return{info:Gn};const{timeItem:i,previousItems:a,info:o}=$f({element:e,returnPreviousValues:t,itemSubTypes:n,itemType:r});return i&&{timeItem:i,previousItems:a}||{info:o}},bulkUpdatePublishedEventIds:function({tournamentRecord:t,outcomes:e}){if(!t)return{error:$};if(!e?.length)return{error:me,info:"Missing outcomes"};const n=e.reduce(((t,e)=>{const{drawId:n,eventId:r}=e;return r&&n&&(t[r]?t[r].includes(n)||t[r].push(n):t[r]=[n]),t}),{}),r=Object.keys(n),i=t.events?.filter((t=>r.includes(t.eventId)));return{publishedEventIds:i.filter((t=>{const{timeItem:e}=Wf({itemType:`${ou}.${cu}`,event:t}),r=e?.itemValue,{eventId:i}=t;return n[i].filter((t=>r?.[su]?.drawIds?.includes(t))).length})).map((t=>t.eventId)),eventIdPublishedDrawIdsMap:n}},matchUpActions:qS,positionActions:function(t){const{tournamentRecord:e}=t;if(!e)return{error:$};const{participants:n}=sU({withIndividualParticipants:!0,tournamentRecord:e});return $T({tournamentParticipants:n,...t})},findMatchUp:_U,participantScheduledMatchUps:vP,getPredictiveAccuracy:function(t){let{matchUps:e}=t;const{tournamentRecord:n,drawDefinition:r,excludeMargin:i,exclusionRule:a,zoneDoubling:o,matchUpType:s,scaleName:c,eventId:u,zonePct:d,drawId:p,event:l}=t;if(!n&&!e)return{error:$};if(s&&![ba,Aa].includes(s))return{error:xn,info:{matchUpType:s}};if(e&&!Sa(e))return{error:xn,context:{matchUps:e}};const m=Bm[c],f=m?.ascending??t.ascending??!1,h=m?.accessor??t.valueAccessor,I=Array.isArray(m?.range)?Math.abs(m.range[0]-m.range[1]):0,g=v(d)&&I?(d||0)*I:t.zoneMargin||I,U={withScaleValues:!0,withCompetitiveness:!0},y={matchUpTypes:s?[s]:[ba,Aa]},S=n?.participants;e?.[0]?.hasContext?p?e=e.filter((t=>t.drawId===p)):u&&(e=e.filter((t=>t.eventId===u))):void 0===e&&(e=p&&!r&&[]||!p&&u&&!l&&[]||p&&eh({inContext:!0,drawDefinition:r,contextFilters:y,contextProfile:U,participants:S})?.matchUps||!p&&u&&nh({inContext:!0,contextFilters:y,contextProfile:U,participants:S,event:l})?.matchUps||th({tournamentRecord:n,contextFilters:y,contextProfile:U})?.matchUps||[]),s&&(e=e.filter((t=>t.matchUpType===s)));const w=e.filter((({winningSide:t,score:e,sides:n,matchUpStatus:r})=>![aa,Zi,ca,Xi,zi].includes(r||"")&&Yp({score:e})&&2===n?.length&&t)),T=function({excludeMargin:t,exclusionRule:e,valueAccessor:n,ascending:r,scaleName:i,matchUps:a}){const o={affirmative:[],negative:[],excluded:[]};for(const u of a){const{matchUpType:a,sides:s,score:c,winningSide:d}=u;if(!d)continue;if(e&&(!e.valueAccessor||!e.range))return{info:"exclusionRule requires valueAccessor and range",error:me};const p=d-1,l=mN({exclusionRule:e,valueAccessor:n,matchUpType:a,scaleName:i,sides:s});if(e){const t=l.map((({exclusionValues:t})=>t)).flat();if(t.length){o.excluded.push({scoreString:c?.scoreStringSide1,exclusionValues:t,winningSide:d,sideValues:l});continue}}if(l.filter((t=>![void 0,"",null].includes(t.value))).length<2){o.excluded.push({scoreString:c?.scoreStringSide1,missingValues:!0,winningSide:d,sideValues:l});continue}const m=l[p].value-l[1-p].value,f=parseFloat(t||0),h=f&&Math.abs(m)<f;if(h){o.excluded.push({scoreString:c?.scoreStringSide1,excludeMargin:t,winningSide:d,excludeGap:h,sideValues:l,valuesGap:m});continue}const I=r?m:-1*m,g=1===d?c?.scoreStringSide1:c?.scoreStringSide2;I>0?o.affirmative.push({winningScoreString:g,winningSide:d,sideValues:l,valuesGap:m,score:c}):o.negative.push({winningScoreString:g,winningSide:d,sideValues:l,valuesGap:m,score:c})}const s=o.affirmative.length+o.negative.length,c=s&&o.affirmative.length/s*100;return o.percent=c?Math.round(100*c)/100:0,o}({matchUps:w,excludeMargin:i,exclusionRule:a,valueAccessor:h,ascending:f,scaleName:c}),P=o&&s!==ba?2*(g||0):g,D=g?w.map((({competitiveProfile:t,matchUpType:e,score:n,sides:r})=>{const i=mN({valueAccessor:h,matchUpType:e,scaleName:c,sides:r}),a=Math.abs(i[0].value-i[1].value);return{competitiveness:t?.competitiveness,valuesGap:a,score:n}})).filter((({valuesGap:t})=>t<=P)):[],N=function({zoneData:t}){const e={[$o]:[],[Wo]:[],[Ho]:[]};for(const n of t){const{competitiveness:t,score:r,valuesGap:i}=n;e[t]&&e[t].push({score:r,valuesGap:i})}return e}({zoneData:D}),R=N&&[].concat(Object.values(N)).flat().length,b=R&&Object.assign({},...Object.keys(N).map((t=>({[t]:Math.round(1e4*N[t].length/R)/100})))),M=w.length-(D?.length||0);return{...L,relevantMatchUps:w,zoneDistribution:b,zoneData:D,accuracy:T,nonZone:M}},getMatchUpsStats:function({profileBands:t,tournamentRecord:e,matchUps:n}){if(!Sa(n))return{error:Zt};const r=!t&&ns({policyType:Ka,tournamentRecord:e}).policy,i=t||r?.profileBands||Yo[Ka].profileBands,a=n.filter((({winningSide:t})=>t)),o=es(a.map(Zo)).reduce(((t,e)=>((t,e)=>(t[Xo(e,i)]+=1,t))(t,e)),{[$o]:0,[Wo]:0,[Ho]:0,[Go]:0}),s=Object.keys(o).reduce(((t,e)=>(o[e]||0)+t),0),c=Object.keys(o).map((t=>({[t]:100*parseFloat((o[t]/s).toFixed(4))}))),u=a.filter((({matchUpStatus:t})=>t===qo)).length;return c.push({[qo]:100*parseFloat((u/s).toFixed(4))}),{competitiveBands:Object.assign({},...c),...L}},participantScaleItem:yh,getParticipantScaleItem:JD,getParticipantSignInStatus:function({tournamentRecord:t,participantId:e}){if(!t)return{error:$};if(!e)return{error:Le};const{participant:n}=hs({tournamentRecord:t,participantId:e});if(!n)return{error:Be};const{timeItem:r}=$f({itemType:Au,element:n});return r&&r.itemValue===xu&&xu},getPolicyDefinitions:jo,getMatchUpScheduleDetails:bu},IN={addVenue:Ac,deleteVenue:QS,deleteVenues:function({tournamentRecord:t,venueIds:e,force:n}){if(!t)return{error:$};if(!Array.isArray(e))return{error:xn};for(const r of t.venues||[]){const{venueId:i}=r;if(e.includes(i)){const{venueId:e}=r,i=QS({tournamentRecord:t,venueId:e,force:n});if(i.error)return i}}return{...L}},modifyVenue:lv,enableCourts:zS,enableVenues:YS,disableCourts:WS,disableVenues:HS,addCourt:dv,addCourts:pv,deleteCourt:ev,modifyCourt:cv,modifyCourtAvailability:ov,findVenue:function({convertExtensions:t,...e}){const{tournamentRecords:n,tournamentRecord:r,venueId:i}=e;return ri(Cc({tournamentRecords:n,tournamentRecord:r,venueId:i}),t,!0)}},gN=(()=>{const t={getState:t=>gP({convertExtensions:t?.convertExtensions,removeExtensions:t?.removeExtensions,tournamentId:Ir()}),newTournamentRecord:(t={})=>{const e=hP(t),n=e.tournamentId;return e.error?e:(yr(e),vr(n),{...L,tournamentId:n})},setTournamentId:t=>vr(t),version:()=>"1.8.14",reset:()=>e(wr(Ir())),setState:(t,n,r)=>{sr(n,r);return e(IP(t,n))},getDevContext:t=>ir(t),executionQueue:(e,r)=>function(e,r){if(!Array.isArray(e))return{error:xn};const i=Ir(),a=gr(i),o=r&&ri(a,!1,!0),s=[];for(const d of e){if("object"!=typeof d)return{error:xn};const{method:e,params:r}=d;if(!t[e]){const t={error:Jn,methodName:e},n=ir();return(n.result&&!Array.isArray(n.result)||Array.isArray(n.result)&&n.result?.includes(e))&&console.log("te:",t),t}const i=n(a,t[e],r,e);if(i?.error)return o&&IP(o),{...i,rolledBack:!!o};s.push({...i,methodName:e})}const c=ur(),u=Date.now();c&&rI({tournamentRecord:a,value:{version:"1.8.14",timeStamp:u}});iI({directives:e,mutationStatus:c,timeStamp:u,tournamentId:i}),mr();return{success:s.every((t=>t.success)),results:s}}(e,r),devContext:e=>(ar(e),t)};function e(e){return e?.error?(t.error=e.error,t.success=!1):(t.error=void 0,t.success=!0),t}return[hN,lN,IN,pD,fD,cD,VP,sD,kP].forEach((e=>{Object.keys(e).forEach((n=>{t[n]=t=>{if(ir())return r(e[n],t,n);try{return r(e[n],t,n)}catch(i){Pr({engineName:"tournamentEngine",methodName:n,params:t,err:i})}}}))})),t;function n(e,n,r,i){delete t.success,delete t.error;const a=Date.now(),o=n({...UP(e,r),tournamentRecord:e});return Uv({result:o,methodName:i,elapsed:Date.now()-a,params:r,engine:"te:"}),o}function r(t,e,r){const i=Ir(),a=e?.sandBoxRecord||e?.sandboxRecord||e?.sandboxTournament||gr(i),o=e?.rollbackOnError&&ri(a,!1,!0),s=n(a,t,e,r);s?.error&&o&&IP(o);const c=s?.success&&!0!==e?.delayNotify&&!0!==e?.doNotNotify,u=ur(),d=Date.now();return u&&(rI({tournamentRecord:a,value:{version:"1.8.14",timeStamp:d}}),s.modificationsApplied=!0),c&&iI({directives:[{method:t,params:e}],mutationStatus:u,tournamentId:i,timeStamp:d}),(c||!s?.success||e?.doNotNotify)&&mr(),s}})();function UN(t,e){if("object"!=typeof t)return{error:On};const n=t.unifiedTournamentId?.tournamentId||t.tournamentId;if(!n)return{error:H};const r=!1!==e?ri(t):t;return Sr({[n]:r}),vr(n),r}function yN(t){const{convertExtensions:e,removeExtensions:n,tournamentId:r}=t||{};if("string"!=typeof r)return{};return{tournamentRecord:ri(gr(r),e,!1,n)}}function SN(t,e){return t?(e?.someParam&&(e={...e}),e):e}function vN(t,e){return t&&e&&Array.isArray(e)&&e[t-1]||"object"==typeof e&&e[t]}function wN(t){const{participation:e={},awardProfiles:n,startDate:r,eventType:i,drawSize:a,drawType:o,category:s,endDate:c,level:u}=t,{participationOrder:d,flightNumber:p,rankingStage:l}=e,m=n.find((t=>(t=>!r&&!c||!t.dateRanges||t.dateRanges.some((t=>{const e=!r||!t.startDate||new Date(r)>new Date(t.startDate),n=!c||!t.endDate||new Date(c)<=new Date(t.endDate);return e&&n})))(t)&&(!t.maxFlightNumber||p<=t.maxFlightNumber)&&(!t.drawTypes?.length||t.drawTypes?.includes(o))&&(!t.drawSizes?.length||t.drawSizes.includes(a))&&(!t.stages?.length||t.stages.includes(l))&&(!t.levels?.length||t.levels.includes(u))&&(!t.maxDrawSize||a<=t.maxDrawSize)&&(!t.drawSize||t.drawSize===a)&&(!t.maxLevel||u<=t.maxLevel)&&(!p||!t.flights?.flightNumbers?.length||t.flights.flightNumbers.includes(p))&&(!t.participationOrder||t.participationOrder===d)&&(!t.category?.ageCategoryCodes||t.category.ageCategoryCodes.includes(s?.ageCategoryCode))&&(!t.eventTypes?.length||t.eventTypes?.includes(i))));return{awardProfile:m}}function TN({participantWon:t,flightNumber:e,valueObj:n,drawSize:r,flights:i,level:a}){const o=(t,e)=>{const n=t?.value||t?.v||(v(t)?t:0),r=vN(a,t?.level),i=((t,e)=>{if(t){if(Array.isArray(e)){const n=e.find((e=>e.flight===t||e.f===t));return n.value||n.v}if("object"==typeof e){const n=e.flights||e.f;if(Array.isArray(n))return n[t-1]}}})(e,r);return{value:i||v(r)&&r||n}};let s,c,u,d,p=0;const l=(t?"won":!1===t&&"lost")||void 0;if(Array.isArray(n)){let t=n.find((t=>t.drawSize===r||t.drawSizes?.includes(r))),i=n.find((t=>t.drawSize&&t.threshold&&r>t.drawSize)),a=n.find((t=>!t.drawSize&&!t.drawSizes?.length));void 0!==l&&(t=t?.[l],i=i?.[l],a=a?.[l]),c=o(t,e).value,u=o(i,e).value,d=o(a,e).value,p=c||u||d,s=c&&t.requireWin||u&&i.requireWin||a?.requireWin}else if("object"==typeof n){let t=n?.drawSizes?.[r],i=n;void 0!==l&&(t=t?.[l],i=i?.[l]),c=o(t,e).value,d=o(i,e).value,p=c||d,s=c?t.requireWin:i?.requireWin}else v(n)&&void 0===l&&(p=n);return e&&i?.pct?.[e]&&(p=Math.round(p*i.pct[e])),{awardPoints:p,requireWin:s}}const PN={getTournamentPoints:function({participantFilters:t,policyDefinitions:e,tournamentRecord:n,saveRankings:r,level:i}){if(!n)return{error:$};const{policyDefinitions:a}=jo({policyTypes:[Za],tournamentRecord:n}),o=e?.[Za]||a?.[Za];if(!o)return{error:re};const s=o.awardProfiles;let c=o.requireWinFirstRound;const u=o.requireWinForPoints,{participants:d,derivedEventInfo:p,derivedDrawInfo:l,mappedMatchUps:m}=sU({withRankingProfile:!0,participantFilters:t,tournamentRecord:n}),f=d?.filter((t=>t.draws?.length)),h={},I={},g={};for(const U of f||[]){const{participantType:t,participantId:e,person:r,draws:a}=U;for(const o of a){const{drawId:a,structureParticipation:d,eventId:f}=o,y=p[f],S=l[a],v=S?.drawType,{category:w,eventType:P}=y||{},D=o.startDate||y.startDate||n.startDate,N=o.endDate||y.endDate||n.endDate;if(P===Nu&&e!==ku)continue;let R;if(s){let n,o=u,p=0,l=0,f=0;for(const r of d){const{finishingPositionRange:a,participationOrder:u,participantWon:d,flightNumber:h,rankingStage:I,winCount:g}=r;p+=g||0;const y=S?.drawSize,{awardProfile:b}=wN({awardProfiles:s,participation:r,eventType:P,startDate:D,category:w,drawSize:y,drawType:v,endDate:N,level:i});if(b){if(!y)continue;const t=Array.isArray(a)&&Math.max(...a),e=T(a||[]).join("-"),r=t&&I!==zu&&a?.includes(y);void 0!==b.requireWinForPoints&&(o=b.requireWinForPoints),void 0!==b.requireWinFirstRound&&(c=b.requireWinFirstRound);const{finishingPositionPoints:s={},finishingPositionRanges:p,finishingRound:m,pointsPerWin:U,flights:S}=b,v=Array.isArray(b.perWinPoints)?b.perWinPoints?.find((t=>t.participationOrders?.includes(u))):b.perWinPoints,w=s.participationOrders;let P,D=0;if((!w||w.includes(u))&&p&&t){const e=p[t];e&&({awardPoints:D,requireWin:P}=TN({flightNumber:h,valueObj:e,drawSize:y,flights:S,level:i}))}if(!D&&m&&1===u&&t){const e=m[t];e&&({awardPoints:D,requireWin:P}=TN({participantWon:d,flightNumber:h,valueObj:e,drawSize:y,flights:S,level:i}))}if(r&&void 0!==c&&(o=c),void 0!==P&&(o=P),D>l&&(!o||g)&&(l=D,n=t),!D&&U&&g&&(f+=g*U,n=e),!D&&g&&v){const t=vN(i,v?.level);t?f+=g*t:v.value&&(f+=g*v.value)}}if(R=l+f,t===ku){const t=(U.matchUps||[]).filter((({structureId:t})=>t===r.structureId));for(const{matchUpId:n}of t){const t=m[n],r=t.sides.find((t=>t.participantId===e)).sideNumber;if(t.winningSice===r)for(const e of t.tieMatchUps)e.winningSide}}}if(f||l){const i={winCount:p,positionPoints:l,rangeAccessor:n,perWinPoints:f,eventType:P,drawId:a,points:R},o=r?.personId;o?(h[o]||(h[o]=[]),h[o].push(i)):t===Ou?(g[e]||(g[e]=[]),g[e].push(i)):t===ku&&(I[e]||(I[e]=[]),I[e].push(i))}}}}if(r){Bs({element:n,extension:{name:Ao,value:{personPoints:h,teamPoints:I,pairPoints:g}}})}return{participantsWithOutcomes:f,personPoints:h,pairPoints:g,teamPoints:I,...L}}};const DN={nSpread:400,diffThreshold:.125,kCalc:t=>250/Math.pow(t+5,.4),kMultiplier:function(t=3,e=2){const n=t/e;return isNaN(n)?DN.kDefault():n},kDefault:()=>1};function NN(t){let{winnerRating:e,loserRating:n,ratingRange:r}=t;const{ratings:i=Bm,winnerCountables:a=1,loserCountables:o=0,ratingType:s=km,maxCountables:c,countables:u}=t||{},d=i?.[s];if(!d)return{error:me};r=d.range||r,e=e||d.defaultInitialization,n=n||d.defaultInitialization;const p=r[0]>r[1],l=d.decimalsCount||0,m=p?r.slice().reverse():r,f=(t,e)=>parseFloat(e)>=Math.min(...t)&&parseFloat(e)<=Math.max(...t);f(r,e)&&f(r,n)||(f(r,e)||(e=d.defaultInitialization),f(r,n)||(n=d.defaultInitialization));const h=({value:t,sourceRange:e,targetRange:n})=>(t-e[0])*(n[1]-n[0])/(e[1]-e[0])+n[0],I=h({targetRange:Bm[km].range,sourceRange:m,value:p?r[0]-e:e}),g=h({targetRange:Bm[km].range,sourceRange:m,value:p?r[0]-n:n}),U=(t,e)=>1/(1+Math.pow(10,(e-t)/DN.nSpread)),y=U(I,g),S=U(g,I),v=DN.kCalc(a),w=DN.kCalc(o),T=DN.kMultiplier(c,u),P=I+T*v*(1-y),D=g+T*w*(0-S),N=h({sourceRange:Bm[km].range,value:P,targetRange:m}),R=h({sourceRange:Bm[km].range,value:D,targetRange:m}),b=p?r[0]-N:N;let M=parseFloat(parseFloat(b).toFixed(l));const A=p?r[0]-R:R;let E=parseFloat(parseFloat(A).toFixed(l));const C=Math.max(...r)?Math.abs(e-n)/Math.max(...r):0;return(N>R&&C>DN.diffThreshold||M<0||E<0)&&(M=e,E=n),{newWinnerRating:M,newLoserRating:E}}const RN={calculateNewRatings:NN,generateDynamicRatings:function({removePriorValues:t=!0,tournamentRecord:e,ratingType:n=km,considerGames:r,matchUpIds:i,asDynamic:a}){if(!e)return{error:$};if(!Array.isArray(i))return{error:Zt};if("string"!=typeof n)return{error:xn,ratingType:n};if(!Bm[n])return{error:xn};const o=Bm[n],{accessor:s}=o,c={},u=th({matchUpFilters:{matchUpIds:i,matchUpStatuses:fa},tournamentRecord:e,inContext:!0}).matchUps||[];for(const l of u.sort(dh)){const{endDate:i,matchUpFormat:o,score:u,sides:p,winningSide:m}=l,f=l.matchUpType,h={eventType:f,scaleName:n,scaleType:us},I=`${n}.${ss}`,g={scaleName:I,eventType:f,scaleType:us},U=Object.assign({},...(p||[]).map((t=>{const{sideNumber:e,participant:n}=t;return e&&{[e]:[n?.participantId,...n?.individualParticipantIds||[]].filter(Boolean).flat()}}))),y=a?I:n,S=Object.assign({},...Object.values(U).flat().map((t=>{const{scaleItem:n}=JD({scaleAttributes:g,tournamentRecord:e,participantId:t}),{scaleItem:r}=JD({tournamentRecord:e,scaleAttributes:h,participantId:t});return t&&{[t]:n??r??{scaleName:y,eventType:f,scaleDate:i,scaleType:us,scaleValue:s?{[s]:void 0}:void 0}}}))),v=o?Ii(o):{},w=v?.bestOf||1,T=r?w&(v?.setsTo||1):w,P=u?.sets&&(d=u.sets,d?.reduce(((t,e)=>(e.winningSide&&(t[e.winningSide-1]+=1),t)),[0,0])||[0,0])||1===m&&[1,0]||[0,1],D=m?U[m]:[],N=m?U[3-m]:[];for(const r of D){const i=S[r]?.scaleValue,a="object"==typeof i?i[s]:i;for(const o of N){const c=S[o]?.scaleValue,u="object"==typeof c?c[s]:c,d=m?P[m]:[0,0],p=m?P[3-m]:[0,0],{newWinnerRating:l,newLoserRating:f}=NN({winnerCountables:d,loserCountables:p,maxCountables:T,winnerRating:a,loserRating:u,ratingType:n}),h=s?{...i,[s]:l}:l,I=s?{...c,[s]:f}:f;S[r].scaleValue=h,S[o].scaleValue=I;let g=CP({participantId:r,removePriorValues:t,tournamentRecord:e,scaleItem:{...S[r],scaleName:y}});if(g.error)return g;if(g=CP({participantId:o,removePriorValues:t,tournamentRecord:e,scaleItem:{...S[o],scaleName:y}}),g.error)return g}}Object.assign(c,S)}var d;const p=u.map((({matchUpId:t})=>t));return{...L,modifiedScaleValues:c,processedMatchUpIds:p}}};(()=>{const t={getState:t=>yN({convertExtensions:t?.convertExtensions,removeExtensions:t?.removeExtensions,tournamentId:Ir()}),setTournamentId:t=>vr(t)};function e(e){return e?.error?(t.error=e.error,t.success=!1):(t.error=void 0,t.success=!0),t}return t.version=()=>"1.8.14",t.reset=()=>e(wr(Ir())),t.setState=(t,n,r)=>{sr(n,r);return e(UN(t,n))},[PN,RN].forEach((e=>{Object.keys(e).forEach((r=>{t[r]=t=>{if(ir())return n(e[r],t);try{return n(e[r],t)}catch(i){Pr({engineName:"scaleEngine",methodName:r,params:t,err:i})}}}))})),t;function n(e,n){const r=n?.sandBoxRecord||n?.sandboxRecord||n?.sandboxTournament||gr(Ir()),i=n?.rollbackOnError&&ri(r,!1,!0),a=function(e,n,r){return delete t.success,delete t.error,n({...SN(e,r),tournamentRecord:e})}(r,e,n);a?.error&&i&&UN(i);const o=a?.success&&!0!==n?.delayNotify&&!0!==n?.doNotNotify;return o&&iI(),(o||!a?.success||n?.doNotNotify)&&mr(),a}})();var bN={lastNames:["Abbey","Assange","Ahern","Ampleforth","Atreides","Austen","Banks","Barrington","Batty","Bauers","Beals","Beer","Bennett","Berry","Bonaparte","Brockovich","Bukowski","Cassidy","Catton","Calvino","Carson","Chip","Constant","Crane","Crowne","Cummings","Curie","Dallas","Diamond","Deckard","Dunbar","Earhart","Eisenstein","Eldritch","Elliot","Eyre","Faulkner","Fukuoka","Godel","Goldstein","Greer","Hedges","Herbert","Holmgren","Humperdinck","Huxley","Illich","Jeffers","Jensen","Jevons","Johnson","Johnstone","Jovovich","Kingsnorth","Langer","Fernwright","Fuller","Le Guin","Lem","Lovelace","Midgely","Mond","Montoya","Moore","Murry","Nagle","Nearing","Ogden","Ophuls","Parks","Paz","Peet","Perfect","Pendejo","Pevensie","Postman","Ripley","Rodda","Rumfoord","Runciter","Rugen","Sale","Schumacher","Shaftoe","Shelley","Shepard","Smith","Stratton","Stewart","Swift","Tillich","Turing","Tyrell","Twain","Yeats","Veblen","Yates","Vonnegut","Waterhouse","Watson","Wolin","Wirt","Wormwood"],firstFemale:["Ada","Amelia","Amelie","America","Anne","Antoina","Aravis","Astrid","Beatrice","Brienne","Buttercup","Caitlin","Cimorene","Cordelia","Desdemona","Ellen","Elizabeth","Emily","Emmie","Erin","Eva","Evelyn","Heather","Helen","Hermia","Hypatia","Imogen","Jane","Jasmine","Juliana","Juliet","Katniss","Leeloo","Lenina","Lilith","Linda","Lizzie","Louise","Lucy","Marie","Mary","Martha","Matilda","Milla","Miranda","Meg","Melba","Nicole","Ola","Portia","Pris","Rachael","Rachel","Rebecca","River","Rosa","Rosalind","Scout","Sharn","Susanne","Titania","Uhura","Ursula","Valentina","Viola","Virginia","Xena","Zoe"],firstMale:["Alan","Aldous","August","Axel","Barda","Bill","Bruce","Charles","Chris","Darwin","David","Derrick","Edward","Emmanuel","Ernst","Estlin","Fezzik","Filby","Frank","Frito","George","Glen","Helmholtz","Inigo","Italo","Ivan","James","Jared","Joe","Julian","John Michael","Jonathan","Korben","Kirkpatrick","Kurt","Lief","Malachi","Mark","Masanobu","Michael","Mustapha","Neil","Nikola","Octavio","Palmer","Paul","Pierre","Robinson","Rick","Rincewind","Roy","Shannon","Sheldon","Stafford","Stanislaw","Stanley","Syme","Thorstein","Thomas","Tyrone","Vizzini","Walton","Walker","Warren","Wendell","Westley","William","Winston","Zoran"]};function MN(t){const{count:e=100,sex:n}=t||{};if(!e||n&&![Lp,jp].includes(n))return{personData:[],error:xn};const r=Math.ceil(1.3*e),{lastNames:i,firstFemale:a,firstMale:o}=bN,s=Fm.map((({iso:t})=>t)).filter(Boolean),c=Math.ceil(r/i.length),u=Math.ceil(r/a.length),d=Math.ceil(r/o.length),p=E(0,c).flatMap((()=>{const t=ri(i,!1,!0);return E(0,i.length).map((()=>M(t)))})),l=E(0,u).flatMap((()=>{const t=ri(a,!1,!0);return E(0,a.length).map((()=>M(t)))})),m=E(0,d).flatMap((()=>{const t=ri(o,!1,!0);return E(0,o.length).map((()=>M(t)))})),f={};for(let h=0;h<r;h++){const t=p.pop(),e=n||A([Lp,jp]),r=e===Lp?m.pop():l.pop(),i=A(s);f[`${r}${t}`]={nationalityCode:i,sex:e,firstName:r,lastName:t}}return{personData:Object.values(f).slice(0,e)}}function AN(t){let e=t?.count||1;const{personExtensions:n,consideredDate:r,isMock:i=!0,gendersCount:a,personData:o,category:s,sex:c}=t||{};if(isNaN(e))return{error:xn};const u=a?.[Lp]||c===Lp&&e||0,d=a?.[jp]||c===jp&&e||0;e=Math.max(e,u+d);const p=e-(u+d),l=[...u&&MN({count:u,sex:Lp}).personData||[],...d&&MN({count:d,sex:jp}).personData||[],...p&&MN({count:p}).personData||[]];let f=l.filter((t=>!c||u&&d||t.sex===c));const h=[];if(Array.isArray(o)){const t=o.filter((t=>"string"==typeof t.firstName&&("string"==typeof t.lastName&&(!(t.sex&&![Lp,jp].includes(t.sex))&&(!(t.nationalityCode&&("string"!=typeof t.nationalityCode||t.nationalityCode.length>3||!Fm.find((({iso:e,ioc:n})=>[e,n].includes(t.nationalityCode)))))&&(t.nationalityCode&&h.push(t.nationalityCode),!0))))));if(!t.length)return{error:xn};f=t}const I=o?f:P(f);if(I.length<e){const{maleFirstNames:t,maleLastNames:n,femaleFirstNames:r,femaleLastNames:i,nationalityCodes:a}=l.reduce(((t,e)=>{const{firstName:n,lastName:r,nationalityCode:i}=e;return e.sex===Lp?(t.maleFirstNames.includes(n)||t.maleFirstNames.push(n),t.maleLastNames.includes(r)||t.maleLastNames.push(r)):(t.femaleFirstNames.includes(n)||t.femaleFirstNames.push(n),t.femaleLastNames.includes(r)||t.femaleLastNames.push(r)),t.nationalityCodes.includes(i)||t.nationalityCodes.push(i),t}),{maleFirstNames:[],maleLastNames:[],femaleFirstNames:[],femaleLastNames:[],nationalityCodes:[]});E(0,e-I.length).forEach((()=>{const e=c||A([Lp,jp]),o=A(a),s={firstName:A(e===Lp?t:r),lastName:A(e===Lp?n:i),sex:e,nationalityCode:o};I.push(s)}))}const{ageMinDate:g,ageMaxDate:U}=Ai({consideredDate:r,category:s}),y=m(g?.slice(0,4)||0)||m(U?.slice(0,4)||0)-3,S=m(U?.slice(0,4)||0)||m(g?.slice(0,4)||0)+3,v=(g||U)&&[y,S],w=I.slice(0,e).map(((t,e)=>{const[r,a]=v||[],o=v&&M(E(r,a)),s=M(E(0,365)),c=o&&function(t,e,n){const r=new Date(t,0);return Fr(new Date(r.setDate(e)),n)}(o,s);return Object.assign(di({extensions:n||[{name:"regionCode",value:e+1}],birthDate:c,isMock:i}),t)}));return{persons:w.length&&w||I[0],nationalityCodes:h}}function EN(t){const{cities:e,states:n,postalCodes:r,nationalityCode:i,participantIndex:a}=t;return{postalCode:r?.[a],state:n?.[a],city:e?.[a],countryCode:i}}var CN=["Ace Academy","Avengers","Ball Bouncers","Baseliners","Captivators","Civil Disobedients","Continentals","Court Royal","Court Sharks","Diamond Dogs","Danger Zone","Doubles Dominators","Double Faults","Tricksters","Eliminators","Court Crusaders","Fuzz Busters","Game Changers","Goal Gurus","Good Volley","Green Machine","Hawk Eyes","Inside Outers","Killer Instinct","Line Toers","Masters of Mayhem","Matter Catchers","Cheap Shot","Mean Machines","Mindspace Invaders","Net Centric","Net Positive","Smash Mullet","Over Your Head","Spin Meisters","Aggressors","Racket Machine","Slice Happy","Refs Nightmare","Sandeaters","Sun Seekers","Slicer Dicers","Sparkle Soul Tribe","Stacked Deck","Cross Stringers","The Emergence","Total Demolition","Touch and Go","Upside Downers","Vertically Challenged","Visual Spectacle"];function ON({nameRoot:t="TEAM",count:e=1}={}){const n=P(CN).slice(0,e);return n.length<e&&E(0,e-n.length).forEach((e=>n.push(`${t} ${e+1}`))),{names:n}}var FN=[{AA:"Annexia"},{BA:"Bacteria"},{BO:"Borduria"},{BM:"Bensalem"},{BS:"Basenji"},{BI:"Balnibarbi"},{BV:"Bartovia"},{BZ:"Berzerkistan"},{CA:"Caldonia"},{CC:"Concordia"},{CH:"Chula"},{DA:"Deltora"},{DW:"Discworld"},{EA:"Eastasia"},{EP:"Ecotopia"},{ER:"Erewhon"},{FA:"Freedonia"},{FN:"Florin"},{FG:"Fogg"},{FK:"Fourecks"},{GA:"Genovia"},{GL:"Gilead"},{GD:"Gilead"},{GL:"Gondal"},{GO:"Gondor"},{GR:"Gruzinia"},{GT:"Goritania"},{GU:"Guilder"},{HA:"Heldscalla"},{HO:"Hidalgo"},{IL:"Illyria"},{KA:"Kinakuta"},{KG:"Kangan"},{KN:"Kreplachistan"},{KS:"Kallipolis"},{LH:"Lugash"},{LI:"Listenbourg"},{LT:"Lilliput"},{LU:"Luggnagg"},{LV:"Lichtenslava"},{MR:"Moher"},{NA:"Narnia"},{NV:"Novaria"},{OA:"Oceania"},{OS:"Orsinia"},{OV:"Octavia"},{PA:"Palombia"},{PG:"Penguina"},{QA:"Qasha"},{PM:"Panem"},{SA:"Solymbria"},{SD:"Syldavia"},{SG:"San Glucose"},{SL:"San Lorenzo"},{SR:"Sontar"},{SY:"Sylvania"},{TF:"Tralfamadore"},{TH:"Themyscira"},{UA:"Utopia"},{VA:"Vespugia"},{WA:"Wakanda"},{WX:"Wessex"},{ZA:"Zamunda"},{ZK:"Zubrowka"}],kN=["Amber","Ansul","Atlantis","Braavos","Busytown","Castle Rock","Centralia","Coober Pedy","Chefchaouen","Chronopolis","Damanhur","Diaspar","Dictionopolis","Diomira","El Dorado","Elista","Ephesus","Gotham","Hadleyburg","Hallstatt","Hierusalem","Ilium","Inverness","Kowloon","Laputa","Longyearbyen","Lys","Matmata","Maycomb","Metropolis","Miyake-jima","Monowi","Nagoro","Navarre","New New York","Nimbin","Pemberley","Pseudopolis","Rivendell","Roswell","Shangri-La","Springfield","Supilinn","Thneedville","Trantor","Wobegon","Yonwood","Xanadu","Xylar","Zion"];function xN({count:t=1,participantsCount:e=32}={}){const n=P(kN),r=n.slice(0,t);return{cities:E(0,e).map((e=>e<Math.min(t,n.length)?r[e]:A(r)))}}function _N({count:t=1,participantsCount:e=32}={}){const n=P(FN),r=n.slice(0,t).map((t=>Object.keys(t))).flat();return{states:E(0,e).map((e=>e<Math.min(t,n.length)?r[e]:A(r)))}}function LN({count:t=1,participantsCount:e=32}={}){const n=E(0,t).map((()=>E(0,5).map((()=>S(0,9))).join("")));return{postalCodes:E(0,e).map((e=>e<t?n[e]:A(n)))}}function BN({matchUpStatusProfile:t,completeAllMatchUps:e,randomWinningSide:n,tournamentRecord:r,drawProfiles:i,event:a}){const o=_s({event:a}).flightProfile,{eventName:s,eventType:c,category:u}=a,{startDate:d}=r,p=[],l=u?.categoryName||u?.ageCategoryCode||u?.ratingType,m=a.drawDefinitions?.map((({drawId:t})=>t));if(Array.isArray(o?.flights))for(const[f,h]of o.flights.entries()){const{drawId:o,stage:u,drawName:I,drawEntries:g}=h;p.push(h.drawId);const U=i[f],{seedsCount:y,generate:S=!0}=U||{};if(S){const p=g.filter(sl).map(ml),h=l||s;if(r&&y&&y<=p.length){E(1,y+1).forEach(((t,e)=>{const n={scaleValue:t,scaleName:h,scaleType:ps,eventType:c,scaleDate:d},i=p[e];CP({tournamentRecord:r,participantId:i,scaleItem:n})}))}if(m?.includes(o))break;let S=pN({...U,matchUpType:c,seedingScaleName:h,tournamentRecord:r,isMock:!0,drawEntries:g,drawName:I,drawId:o,event:a,stage:u});if(S.error)return{error:S.error,drawIds:[]};const{drawDefinition:v}=S;if(!v)return{error:J};const w=i[f]?.drawExtensions;if(Array.isArray(w)&&w.filter(xs).forEach((t=>Bs({element:v,extension:t}))),S=Jg({suppressNotifications:!0,tournamentRecord:r,drawDefinition:v,event:a}),S.error)return{error:S.error,drawIds:[]};if(U?.withPlayoffs){const t=v.structures?.[0].structureId,e=Ew({idPrefix:U.idPrefix,...U.withPlayoffs,tournamentRecord:r,drawDefinition:v,isMock:!0,structureId:t,event:a});if(e?.error)return e}const T=U?.completionGoal;if(!(!1===U?.automated)&&(e||T)){const i=U?.matchUpFormat,o=ZP({completeAllMatchUps:!T&&e,matchUpStatusProfile:t,randomWinningSide:n,tournamentRecord:r,completionGoal:T,drawDefinition:v,matchUpFormat:i,event:a});if(o.error)return{error:o.error,drawIds:[]};const s=o.completedCount;if(U?.drawType===xd){const o=v.structures?.find((t=>t.stage===Hu));if(!o)return{error:Dt};let c=vw({structureId:o.structureId,tournamentRecord:r,drawDefinition:v,event:a});if(c.error)return{error:c.error,drawIds:[]};if(c=ZP({completeAllMatchUps:!T&&e,completionGoal:T?T?T-(s??0):void 0:void 0,matchUpStatusProfile:t,randomWinningSide:n,tournamentRecord:r,drawDefinition:v,matchUpFormat:i,event:a}),c.error)return{error:c.error,drawIds:[]}}}}}return{...L,drawIds:p}}function VN(t){let{rankingRange:e,scaledParticipantsCount:n}=t;const{ratingsParameters:r=Bm,valuesInstanceLimit:i,consideredDate:a,category:o,nationalityCodesCount:s,nationalityCodeType:c,nationalityCodes:u,participantsCount:d=32,participantType:p,personIds:l,idPrefix:m,uuids:f,personExtensions:h,addressProps:I,gendersCount:g,matchUpType:y,personData:v,sex:T,inContext:D,withISO2:N,withIOC:R,scaleAllParticipants:b}=t,M=p===Ou||y===Ma,A=p===Fu||y===Fu;!e||Array.isArray(e)&&e.every((t=>U(t)))&&2===e.length||(e=void 0),n=b?d:n;e=e||[1,n&&n>1e3?n:1e3],e[1]+=1;const C=d*(M?2:A?8:1),O=AN({count:C,personExtensions:h,consideredDate:a,gendersCount:g,personData:v,category:o,sex:T});if(O.error)return O;const{nationalityCodes:F,persons:k}=O;let x=[],_=[],L=[],B=[];if("object"==typeof o){const{categoryName:t,ageCategoryCode:i,ratingType:a}=o;if((t||i)&&!a){const[t,r]=e||[];if(_=P(E(t,r)).slice(0,n||S(20,30)),[Ou,Fu].includes(p)){const[t,r]=e||[];x=P(E(t,r)).slice(0,n||S(20,30))}}if(a&&r[a]){const{ratingMax:t,ratingMin:e,ratingAttributes:i}=o,s=Object.assign({},r[a],i||{}),{attributes:c={},decimalsCount:u,accessors:d,range:l,step:m}=s,f=t=>{const e={};for(const n of Object.keys(t)||{}){const r=t[n];if("object"==typeof r&&r.generator){const{range:t}=r,[i,a]=t.slice().sort();e[n]=S(i,a)}else e[n]=r}return e},h=l[0]>l[1]?2:.5,[I,g]=l.slice().sort(),U=()=>E(0,2e3).map((()=>w(I,g,h,m,u))).filter((n=>(!t||n<=t)&&(!e||n>=e))).slice(0,n||S(20,30)).map((t=>d?Object.assign({},...d.map((e=>({[e]:t}))),f(c)):t));L=U(),[Ou,Fu].includes(p)&&(B=U())}}const V=Fm.filter((t=>"IOC"===c&&t.ioc||t.iso));const{postalCodesProfile:j,postalCodesCount:G,statesProfile:q,citiesProfile:$,citiesCount:W,statesCount:H}=I||{},z=t=>Object.keys(t).map((t=>E(0,q[t]).map((()=>t)))).flat(),Y={cities:$&&z($)||I?.cities||xN({count:W||C,participantsCount:C}).cities,states:q&&z(q)||I?.states||_N({count:H||C,participantsCount:C}).states,postalCodes:j&&z(j)||I?.postalCodes||LN({count:G||C,participantsCount:C}).postalCodes},K=function(t){const e=Math.ceil(C/t);return i&&e>i?Math.ceil(C/i):t}(s),J=K?P(V).slice(0,s):u?V.filter((t=>u.includes(t.iso))):V,Q=P(E(0,Math.ceil(C/(K||1))).map((()=>J)).flat(1/0)),X=ON({count:d}).names;return{participants:E(0,d).map((t=>{const e=M?2:A?8:1,n=E(0,e).map((n=>function(t){const e=k[t],{nationalityCode:n,participantExtensions:r,participantTimeItems:i,extensions:a,firstName:s,birthDate:u,lastName:d,personId:p,sex:h}=e||{},I=s||"GivenName",g=d||"FamilyName",U=`${I} ${g}`,y=Q[t],S=F?.length&&n||y&&("IOC"===c?y.ioc||y.iso:y.iso||y.ioc)||n;!Q?.length||S||n||console.log("%c Invalid Nationality Code",{participantIndex:t,country:y});const v=EN({...Y,participantIndex:t,nationalityCode:S}),w=di({participantId:GN({participantType:Eu,index:t,idPrefix:m,uuids:f}),extensions:r,timeItems:i,participantRole:TP,participantType:Eu,participantName:U,person:{addresses:[v],personId:p||l?.length&&l[t]||hi(),standardFamilyName:g,standardGivenName:I,nationalityCode:S,extensions:a,birthDate:Cr(u)?u:void 0,sex:h}});if(R&&S){const t=Fm.find((({iso:t})=>t===S));t?.ioc&&(w.person.iocNationalityCode=t.ioc),t?.label&&(w.person.countryName=t.label)}if(N&&S){const t=Fm.find((({iso:t})=>t===S));t?.iso2&&(w.person.iso2NationalityCode=t.iso2),t?.label&&(w.person.countryName=t.label)}if(o){const e=_[t],n=x[t];jN({scaleValue:e,eventType:wu,scaleType:cs,participant:w,category:o}),jN({scaleValue:n,eventType:Pu,scaleType:cs,participant:w,category:o});const r=L[t],i=B[t];jN({scaleValue:r,eventType:wu,scaleType:us,participant:w,category:o}),jN({scaleValue:i,eventType:Pu,scaleType:us,participant:w,category:o})}return w}(t*e+n))),r=n.map((t=>t.participantId)),i=n.map((t=>t.person.standardFamilyName)).join("/"),a=M?Ou:Fu,s={participantId:GN({participantType:a,idPrefix:m,index:t,uuids:f}),participantRole:TP,participantName:M?i:X[t],individualParticipantIds:r,participantType:a};return D&&(s.individualParticipants=n),M||A?[s,...n]:n})).flat()}}function jN({scaleValue:t,participant:e,eventType:n,scaleType:r,category:i}){const a=i.categoryName||i.ratingType||i.ageCategoryCode,o={itemValue:t,itemType:[ds,r,n,a].join(".")};a&&t&&(e.timeItems||(e.timeItems=[]),e.timeItems.push(o))}function GN({idPrefix:t,participantType:e,index:n,uuids:r}){return t?`${t}-${e===Eu?"I":Ou?"P":Fu?"T":Cu?"G":"X"}-${n}`:r?.pop()||hi()}function qN({alternatesCount:t=0,tieFormatName:e,tieFormat:n,drawSize:r}){let i=0,a=0,o=0,s=0;const c={},u={[Lp]:0,[jp]:0,[Bp]:0,[Vp]:0,[_p]:0};n="object"==typeof n?n:GD({namedFormat:e}),n?.collectionDefinitions?.filter(Boolean).forEach((t=>{const{category:e,collectionId:n,matchUpType:r,matchUpCount:d,gender:p}=t;if([Lp,jp].includes(p)){const t=d*(r===Aa?2:1);u[p]<t&&(u[p]=t)}else p===Bp&&(u[Lp]<d&&(u[Lp]=d),u[jp]<d&&(u[jp]=d));if(e){const t=JSON.stringify(e);c[t]=e}if(n||(t.collectionId=hi()),r===Aa){const t=d;s+=d,i=Math.max(i,t)}if(r===ba){const t=d;o+=d,a=Math.max(a,t)}}));const d=Object.keys(c).length?Math.max(o,2*s):Math.max(a,2*i);return{maxDoublesDraw:i*(r+t),maxSinglesDraw:a*(r+t),teamSize:d,genders:u}}function $N({participantsProfile:t,tournamentRecord:e,eventProfiles:n,drawProfiles:r,startDate:i,uuids:a}){const{participantsCount:o,participantType:s,largestTeamDraw:c,largestTeamSize:u,gendersCount:d}=function({participantsProfile:t,eventProfiles:e,drawProfiles:n}){let{participantsCount:r,participantType:i=Eu}=t||{};const a=r||0,o={[jp]:0,[Bp]:0,[Vp]:0,[Lp]:0,[_p]:0};let s=0,c=0,u=0,d=0,p=0;const l=({alternatesCount:t=0,uniqueParticipants:e,tieFormatName:n,drawSize:r=0,eventType:i,tieFormat:a,category:l,gender:m,stage:f})=>{const h=i===Tu,I=i===Du,g=Boolean(e||f===zu||l||m);if(I){d=Math.max(d,r+t),a="object"==typeof a?a:GD({namedFormat:n});const{teamSize:e,maxDoublesDraw:i,maxSinglesDraw:p,genders:l}=qN({alternatesCount:t,tieFormatName:n,tieFormat:a,drawSize:r});u=Math.max(u,e),c=Math.max(c,p),g||(s=Math.max(s,i)),Object.keys(l).forEach((t=>o[t]+=l[t]))}else if(h)if(g){const e=2*(r+t);p+=e,m&&(o[m]+=e)}else r+t&&r+t>s&&(s=r+t);else if(g){const e=r+t;m&&(o[m]+=e),p+=e}else r&&r>c&&(c=r+t)};if(e?.forEach((t=>{const{tieFormatName:e,tieFormat:n,drawProfiles:r,eventType:i,category:a,gender:o}=t;if(r)for(const s of r){const{tieFormatName:t,tieFormat:r}=s;l({...s,tieFormatName:t||e,tieFormat:r||n,eventType:i,category:a,gender:o})}})),Array.isArray(n))for(const f of n)l(f);const m=Math.max(d*u,2*s,c);return s&&(i=Ou),(r||a)<m&&(r=m),r&&s&&[Ou,Du].includes(i)&&(c&&Math.floor(c/2)>s?r=Math.floor(c/2):(!c||2*s>=c)&&(r=Math.ceil(r/2))),void 0===r&&(r=e?.length||n?.length?0:32),r<a&&(r=a),{uniqueParticipantsCount:p,participantsCount:r,largestTeamDraw:d,largestTeamSize:u,participantType:i,gendersCount:o}}({participantsProfile:t,eventProfiles:n,drawProfiles:r}),p=t?.teamKey,l=VN({uuids:a,...t,consideredDate:i,participantsCount:o,participantType:s,gendersCount:d}).participants;let m=0,f=Xg({tournamentRecord:e,participants:l});if(f.error)return f;if(m+=f.addedCount,p){const t=RP({tournamentRecord:e,...p});if(t.error)return t}const h=l.filter((({participantType:t})=>t===Eu)).map(ml);return f=Xg({participants:E(0,c).map((t=>{const e=h.slice(t*u,(t+1)*u);return{participantName:`Team ${t+1}`,participantRole:TP,participantType:Fu,participantId:hi(),individualParticipantIds:e}})),tournamentRecord:e}),f.error?f:(m+=f.addedCount,{addedCount:m,...L})}function WN(t){const{participantsProfile:e={},uniqueParticipantsCount:n,ratingsParameters:r,tournamentRecord:i,eventProfile:a,eventIndex:o,event:s,uuids:c}=t,{category:u,gender:d,eventType:p}=s,l=p===vu&&Eu||p===Tu&&Ou||p,m=n[Hu]||0,f=n[zu]||0,h=a.drawProfiles?.length?m+f:a.participantsProfile?.participantsCount??0,I=[Lp,jp].includes(d)?d:void 0,g=e?.idPrefix?`E-${o}-${e?.idPrefix}`:void 0,{participants:U}=VN({uuids:a.uuids||c,...e,scaledParticipantsCount:a.scaledParticipantsCount,consideredDate:i?.startDate,rankingRange:a.rankingRange,participantType:l,participantsCount:h,ratingsParameters:r,category:u,idPrefix:g,sex:I}),y=Xg({tournamentRecord:i,participants:U});if(y.error)return y;const S=U?.filter((({participantType:t})=>t===l)),v=U?.map(ml);return{uniqueDrawParticipants:S,uniqueParticipantIds:v}}function HN({drawProfiles:t,category:e,gender:n}){const r={},i=t?.reduce(((t,i)=>{const{qualifyingPositions:a=0,participantsCount:o=0,uniqueParticipants:s,stage:c=Hu,drawSize:u=0}=i||{};Object.keys(t).includes(c)||(t[c]=0);const d=(o||u)-a;return s||n||e||c===zu?(Object.keys(r).includes(c)||(r[c]=0),r[c]+=d):t[c]=Math.max(t[c],d),t}),{}),a=Object.keys(r);return a.forEach((t=>i[t]+=r[t])),{stageParticipantsCount:i,uniqueParticipantsCount:r,uniqueParticipantStages:a}}function zN({allUniqueParticipantIds:t,stageParticipantsCount:e,eventParticipantType:n,targetParticipants:r}){const i=e[Hu]||0,a=e[zu]||0;return{stageParticipants:{QUALIFYING:r.filter((({participantType:t})=>t===n)).filter((({participantId:e})=>!t.includes(e))).slice(0,a),MAIN:r.filter((({participantType:t})=>t===n)).filter((({participantId:e})=>!t.includes(e))).slice(a,a+i)}}}function YN({autoEntryPositions:t,tournamentRecord:e,drawParticipants:n,drawProfile:r,event:i}){const{drawType:a=yd,qualifyingPositions:o=0,stage:s=Hu,drawSize:c=0,drawName:u,drawId:d}=r,p=c-o,l=n.slice(0,p).map(ml);if(l.length){const n=rT({participantIds:l,autoEntryPositions:t,tournamentRecord:e,stage:s,event:i});if(n.error)return n}const m=aN({drawName:u||a,qualifyingPositions:o,drawEntries:l.map((t=>({entryStatus:Qd,entryStage:s,participantId:t}))),drawId:d,event:i,stage:s});return m.error?m:{...L}}function KN({uniqueDrawParticipants:t,autoEntryPositions:e,stageParticipants:n,tournamentRecord:r,drawProfiles:i,category:a,gender:o,event:s}){let c=0;for(const u of i){const{qualifyingPositions:i=0,uniqueParticipants:d,stage:p=Hu,drawSize:l=0}=u,m=l-i,f=d||o||a||p===zu,h=f?t.slice(c,c+m):n[p||Hu]||[];f&&(c+=m);const I=YN({autoEntryPositions:e,drawParticipants:h,tournamentRecord:r,drawProfile:u,event:s});if(I.error)return I}return{...L}}function JN(t){const{allUniqueParticipantIds:e,matchUpStatusProfile:n,participantsProfile:r,completeAllMatchUps:i,autoEntryPositions:a,hydrateCollections:o,randomWinningSide:s,ratingsParameters:c,tournamentRecord:u,eventProfile:d,eventIndex:p,publish:l,uuids:m}=t;let f=d.gender,h=d.eventName;const{eventType:I=vu,policyDefinitions:g,drawProfiles:U=[],eventExtensions:y,surfaceCategory:S,tieFormatName:v,processCodes:w,discipline:T,eventLevel:P,timeItems:D,ballType:N,category:R}=d,b=d.eventId||hi(),M=d.tieFormat||(I===Du?GD({namedFormat:v,event:{eventId:b,category:R,gender:f},hydrateCollections:o}):void 0),A=u.participants;for(const $ of U)!f&&$.gender&&(f=$?.gender);const{stageParticipantsCount:E,uniqueParticipantsCount:C,uniqueParticipantStages:O}=HN({drawProfiles:U,category:R,gender:f}),F=I===vu&&Eu||I===Tu&&Ou||I,{uniqueDrawParticipants:k=[],uniqueParticipantIds:x=[]}=O?WN({event:{eventType:I,category:R,gender:f},uniqueParticipantsCount:C,participantsProfile:r,ratingsParameters:c,tournamentRecord:u,eventProfile:d,eventIndex:p,uuids:m}):{};let{eventAttributes:_}=d;"object"!=typeof _&&(_={});const L=R?.categoryName||R?.ageCategoryCode||R?.ratingType;h=h||L||"Generated Event";const B={..._,surfaceCategory:S,processCodes:w,discipline:T,eventLevel:P,eventName:h,eventType:I,tieFormat:M,ballType:N,category:R,eventId:b,gender:f};if(y?.length&&Array.isArray(y)){const t=y.filter(xs);t?.length&&Object.assign(B,{extensions:t})}if(Array.isArray(D)&&D.forEach((t=>lI({event:G,timeItem:t}))),"object"==typeof g)for(const $ of Object.keys(g))mS({policyDefinitions:{[$]:g[$]},event:B});let V;B.category&&(B.category.categoryName=L);const j=qD({suppressNotifications:!1,internalUse:!0,tournamentRecord:u,event:B});if(j.error)return j;const G=j?.event,{stageParticipants:q}=zN({allUniqueParticipantIds:e,stageParticipantsCount:E,eventParticipantType:F,targetParticipants:A});if(U?.length){const t=KN({uniqueDrawParticipants:k,autoEntryPositions:a,stageParticipants:q,tournamentRecord:u,drawProfiles:U,category:R,gender:f,event:G});if(t.error)return t;const e=BN({matchUpStatusProfile:n,completeAllMatchUps:i,randomWinningSide:s,tournamentRecord:u,drawProfiles:U,event:G});if(e.error)return e;V=e.drawIds}else if(d?.participantsProfile?.participantsCount){const t=k.map(ui("participantId"));if(t.length){const e=rT({participantIds:t,autoEntryPositions:a,tournamentRecord:u,stage:Hu,event:G});if(e.error)return e}}return l&&BP({tournamentRecord:u,event:G}),{drawIds:V,eventId:b,uniqueParticipantIds:x}}function QN(t){const{allUniqueParticipantIds:e=[],participantsProfile:n={},matchUpStatusProfile:r,completeAllMatchUps:i,autoEntryPositions:a,hydrateCollections:o,randomWinningSide:s,ratingsParameters:c,tournamentRecord:u,isMock:d=!0,drawProfile:p,startDate:l,drawIndex:m,uuids:f}=t,h=ri(p,!1,!0),{excessParticipantAlternates:g=!0,matchUpFormat:U=va,drawType:y=yd,tournamentAlternates:S=0,alternatesCount:v=0,qualifyingPositions:w,qualifyingProfiles:T,generate:P=!0,eventExtensions:D,drawExtensions:N,completionGoal:R,tieFormatName:b,seedsCount:M,timeItems:A,drawName:C,category:F,idPrefix:k,publish:x,gender:_,stage:B}=h,V=h.drawSize||(h.ignoreDefaults?void 0:32),j=h.eventId||hi(),G=p.eventType||p.matchUpType||vu,q=G===Tu?Ou:Eu,$="object"==typeof p.tieFormat&&p.tieFormat||G===Fu&&GD({namedFormat:b,event:{eventId:j,category:F,gender:_},hydrateCollections:o})||void 0,W=F?.categoryName||F?.ageCategoryCode||F?.ratingType,H=p.eventName||W||`Generated ${G}`;let z=u?.participants||[];const Y=(T?.map((t=>t.structureProfiles||[])).flat().reduce(((t,e)=>t+(!e.participantsCount||e.participantsCount>e.drawSize?e.drawSize:e.participantsCount||0)),0)||0)*(q===Ou?2:1),K=(!p.participantsCount||p.participantsCount>V?V:p.participantsCount)||0,Q={eventName:H,eventType:G,tieFormat:$,category:F,eventId:j,gender:_};Array.isArray(A)&&A.forEach((t=>lI({event:Q,timeItem:t})));let{eventAttributes:X}=p;if("object"!=typeof X&&(X={}),Object.assign(Q,X),D?.length&&Array.isArray(D)){const t=D.filter(xs);t?.length&&Object.assign(Q,{extensions:t})}const Z=[];if(Y||p.uniqueParticipants||!u||_||F){const t=(K||0)+v+Y;let e=t;const r={[Lp]:0,[jp]:0};let i,a;G===Fu&&(({teamSize:i,genders:a}=qN({alternatesCount:v,tieFormatName:b,tieFormat:$,drawSize:V})),Object.keys(a).forEach((t=>{[Lp,jp].includes(t)&&a[t]&&(r[t]=V*a[t])})),e=i*((V||0)+Y));const o=n?.idPrefix?`D-${m}-${n?.idPrefix}`:void 0,s=VN({...n,scaledParticipantsCount:p.scaledParticipantsCount||n.scaledParticipantsCount,participantsCount:e,consideredDate:u?.startDate,sex:_||n?.sex,rankingRange:p.rankingRange,uuids:p.uuids||f,ratingsParameters:c,participantType:q,gendersCount:r,idPrefix:o,category:F}).participants;if(Q.category&&(Q.category.categoryName=W),u){const t=Xg({participants:s,tournamentRecord:u});if(t.error)return t}if(s.forEach((({participantId:t})=>Z.push(t))),z=s,G===Fu){const e=a[Lp]?s.filter((({participantType:t,person:e})=>t===Eu&&e?.sex===Lp)).map(ml):[],n=a[jp]?s.filter((({participantType:t,person:e})=>t===Eu&&e?.sex===jp)).map(ml):[],r=s.filter((({participantType:t})=>t===Eu)).map(ml).filter((t=>!e.includes(t)&&!n.includes(t))),o=i-(a[Lp]+a[jp]);let c=0,d=0,p=0;const l=E(0,t).map((t=>{const i=n.slice(c,c+a[jp]),s=e.slice(d,d+a[Lp]),u=r.slice(p,p+o);return c+=a[jp],d+=a[Lp],p+=o,{individualParticipantIds:[...i,...s,...u],participantOtherName:`TM${t+1}`,participantName:`Team ${t+1}`,participantRole:TP,participantType:Fu,participantId:hi()}})),m=Xg({participants:l,tournamentRecord:u});if(!m.success)return m;z=l}}const tt=t=>{const{participantType:e}=t;return G===vu&&e===Eu||(G===Tu&&e===Ou||G===Fu&&e===Fu)},et=t=>!p.gender||(t.person?.sex===p.gender||t.individualParticipantIds?.some((t=>{const e=z.find((e=>e.participantId===t));return e&&et(e)}))),nt=z.filter(tt).filter(et).filter((({participantId:t})=>!e.includes(t))),rt=nt.slice(0,K).map((t=>t.participantId));if(d&&rt?.length){const t=rT({autoEntryPositions:a,entryStage:B,tournamentRecord:u,participantIds:rt,event:Q});if(t.error)return t}const it=Y?nt.slice(K,K+Y).map((t=>t.participantId)):0;if(d&&it?.length){let t=0,e=1;const n=(t,e)=>t.stageSequence-e.stageSequence,r=(t,e)=>t.roundTarget-e.roundTarget;for(const i of T.sort(r)){e=i.roundTarget||e;let r,o=1;for(const s of i.structureProfiles.sort(n)){const n=(s.drawSize||I(s.participantsCount))-(r||0),i=it.slice(t,t+n),c=rT({entryStage:zu,entryStageSequence:o,autoEntryPositions:a,tournamentRecord:u,participantIds:i,roundTarget:e,event:Q});if(c.error)return c;r=s.qualifyingPositions,t+=n,o+=1}e+=1}}const at=g&&u?.participants?.filter((({participantId:t})=>!rt.includes(t))).filter(tt).filter(et).slice(0,v||V-K||S).map((t=>t.participantId));if(d&&at?.length){const t=rT({participantIds:at,autoEntryPositions:!1,entryStatus:Kd,tournamentRecord:u,event:Q});if(t.error)return t.error}const ot=W||H;if(u&&M&&M<=rt.length){E(1,M+1).forEach(((t,e)=>{const n={scaleName:ot,scaleDate:l,scaleType:au,scaleValue:t,eventType:G},r=rt[e];CP({tournamentRecord:u,participantId:r,scaleItem:n})}))}const st=pN({...ri(p,!1,!0),tournamentRecord:u,seedingScaleName:ot,matchUpFormat:U,eventId:j,isMock:d,event:Q});if(st.error)return st;if(!st.drawDefinition)return{error:J};const{drawDefinition:ct}=st,ut=ct.drawId;if(Array.isArray(N)&&N.filter(xs).forEach((t=>Bs({element:ct,extension:t}))),P){if(Jg({drawDefinition:ct,event:Q,suppressNotifications:!0}),p.withPlayoffs){const t=ct.structures?.[0].structureId,e=Ew({...p.withPlayoffs,tournamentRecord:u,drawDefinition:ct,structureId:t,idPrefix:k,isMock:d,event:Q});if(e?.error)return e}const t=!1===p.automated;if(d&&!t){const t=t=>{const e=ZP({completeAllMatchUps:t.completeAllMatchUps,completionGoal:t.completionGoal,matchUpStatusProfile:r,randomWinningSide:s,tournamentRecord:u,drawDefinition:ct,matchUpFormat:U,event:Q});if(e.error)return e;const n=e.completedCount;if(y===xd){const t=ct.structures?.find((t=>t.stage===Hu));if(!t)return{error:Dt};vw({structureId:t.structureId,tournamentRecord:u,drawDefinition:ct,event:Q});const e=ZP({completionGoal:R?R?R-(n??0):void 0:void 0,matchUpStatusProfile:r,completeAllMatchUps:i,randomWinningSide:s,tournamentRecord:u,drawDefinition:ct,matchUpFormat:U,event:Q});if(e.error)return e}};if(R&&t({completionGoal:R}),p.outcomes){const{matchUps:t}=eh({inContext:!0,drawDefinition:ct,event:Q});for(const e of p.outcomes){const{matchUpStatus:n=Qi,matchUpStatusCodes:r,stageSequence:i=1,matchUpIndex:a=0,structureOrder:o,matchUpFormat:s,drawPositions:c,roundPosition:d,stage:p=Hu,roundNumber:l,winningSide:m,scoreString:f}=e,h=t?.reduce(((t,e)=>{const{structureId:n,matchUpId:r}=e;return t[n]?t[n].push(r):t[n]=[r],t}),{})??[],I=Object.assign({},...Object.keys(h).map(((t,e)=>({[t]:e+1})))),g=t?.filter((t=>!(p&&t.stage!==p||i&&t.stageSequence!==i||l&&t.roundNumber!==l||d&&t.roundPosition!==d||o&&I[t.structureId]!==o||c&&2!==O(c,t.drawPositions).length))),U=g?.[a],y=tD({matchUpStatusCodes:r,tournamentRecord:u,drawDefinition:ct,targetMatchUp:U,matchUpFormat:s,matchUpStatus:n,scoreString:f,winningSide:m});if(y?.error)return y}}i&&t({completeAllMatchUps:i})}x&&BP({tournamentRecord:u,event:Q})}else{const t=aN({drawEntries:ct.entries,drawName:C||y,qualifyingPositions:w,drawId:ut,event:Q,stage:B});if(t.error)return t}return{...L,event:di(Q),uniqueParticipantIds:Z,targetParticipants:z,drawDefinition:ct,eventId:j,drawId:ut}}function XN({tournamentRecord:t,venueProfiles:e,uuids:n}){const{startDate:r,endDate:i}=t,a=[];for(const[o,s]of e.entries()){const{venueAbbreviation:e,venueId:c=n?.pop()||hi(),dateAvailability:u,startTime:d="07:00",endTime:p="19:00",courtTimings:l,courtsCount:m,courtNames:f,venueName:h,idPrefix:I,courtIds:g}=s,U=Ac({tournamentRecord:t,venue:{venueName:h||`Venue ${o+1}`,venueAbbreviation:e,venueId:c}});if(U.error)return U;a.push(c);const y=_r(r,i),S=!Array.isArray(u)&&[{startTime:d,endTime:p}].concat(y.map((t=>({date:Fr(t),startTime:d,endTime:p})))),v=pv({dateAvailability:u||S,tournamentRecord:t,courtTimings:l,courtsCount:m,courtNames:f,startTime:d,idPrefix:I,courtIds:g,endTime:p,venueId:c,dates:y});if(v.error)return v}return a}const ZN={anonymizeTournamentRecord:function({keepExtensions:t=[],anonymizeParticipantNames:e=!0,tournamentRecord:n,tournamentName:r,personIds:i=[],tournamentId:a}){if(!n)return{error:$};const o=Array.isArray(t)?Bo.concat(...t):Bo,s=e=>Array.isArray(t)?e?.extensions?.filter((t=>o.includes(t.name))):e?.extensions,c={};n.extensions=s(n);const u=a||hi();c[n.tournamentId]=u,n.tournamentId=u,n.createdAt=(new Date).toISOString(),n.tournamentName=r||`Anonymized: ${Fr(new Date)}`,delete n.parentOrganisation;for(const C of n.participants||[]){const t=hi();c[C.participantId]=t,C.participantId=t}for(const C of n.participants||[])Array.isArray(C.individualParticipantIds)&&(C.individualParticipantIds=C.individualParticipantIds.map((t=>c[t])));let d=0;for(const C of n.venues||[]){C.extensions=s(C),C.venueName=`Venue #${d}`,C.venueAbbreviation=`V${d}`;const t=hi();c[C.venueId]=t,d+=1}let p=1;for(const C of n.events||[]){C.extensions=s(C);const t=hi();c[C.eventId]=t,C.eventId=t;const e=C.category?.categoryName||C.category?.ageCategoryCode||C.category?.ratingType||C.gender;if(C.eventName=`Event ${p} ${e}`,Array.isArray(C.entries))for(const r of C.entries)r.participantId=c[r.participantId];for(const r of C.drawDefinitions||[]){r.extensions=s(r);const t=hi();if(c[r.drawId]=t,r.drawId=t,Array.isArray(r.entries))for(const n of r.entries)n.participantId=c[n.participantId];const e=t=>{t.extensions=s(t);const e=hi();c[t.structureId]=e,t.structureId=e;for(const n of t.positionAssignments||[])n.participantId&&(n.participantId=c[n.participantId]);for(const n of t.seedAssignments||[])n.participantId&&(n.participantId=c[n.participantId]);for(const n of t.matchUps||[])for(const t of n.sides||[])t.lineUp&&(t.lineUp=t.lineUp.map((({participantId:t,collectionAssignments:e})=>({participantId:c[t],collectionAssignments:e}))))};for(const n of r.structures||[])if(e(n),Array.isArray(n.structures))for(const t of n.structures)e(t);for(const n of r.links||[])n.source.structureId=c[n.source.structureId],n.target.structureId=c[n.target.structureId]}const{extension:n}=ys({name:To,event:C});Array.isArray(n?.value?.flights)&&n?.value.flights?.forEach((t=>{if(t.drawId=c[t.drawId],Array.isArray(t.drawEntries))for(const e of t.drawEntries)e.participantId=c[e.participantId]})),p+=1}const l=n.startDate||Fr(new Date),m=(n.participants||[]).filter((({participantType:t})=>t===Eu)),f=m.reduce(((t,e)=>{const n=e.person?.sex;return[Lp,jp].includes(n)?t[n]+=1:t[Vp]+=1,t}),{[Lp]:0,[jp]:0,[Vp]:0}),h=Object.assign({},...Object.keys(f).map((t=>({[t]:AN({category:{ageCategoryCode:"O18"},count:f[t],addressProps:{citiesCount:10},personExtensions:[],consideredDate:l,sex:t})?.persons||[]})))),I={[Lp]:0,[jp]:0,[Vp]:0},g=m.length,U=m.reduce(((t,e)=>{const n=e.person?.addresses?.[0]||{},{city:r,state:i,postalCode:a}=n;return t.cities.includes(r)||t.cities.push(r),t.states.includes(i)||t.states.push(i),t.postalCodes.includes(a)||t.postalCodes.push(a),t}),{cities:[],postalCodes:[],states:[]}),y=U.postalCodes.length,S=U.cities.length,v=U.states.length,{cities:w}=xN({count:S||g,participantsCount:g}),{states:T}=_N({count:v||g,participantsCount:g}),{postalCodes:P}=LN({count:y||g,participantsCount:g}),D={cities:w,states:T,postalCodes:P};m.forEach(((t,n)=>{const r=t?.person,a=r?.sex||Vp,o=$r(r?.birthDate)?.split("-")[0],u=I[a],d=h[a][u];if(I[a]+=1,o){const[,t,e]=d?.birthDate?.split("-")||[],n=[o,t,e].join("-");d.birthDate=n}if(r?.addresses){const t=EN({...D,participantIndex:n,nationalityCode:d.nationalityCode});d.addresses=[t]}d.personId=i?.[n]||hi(),e?(d.standardFamilyName=d.lastName,d.standardGivenName=d.firstName,t.participantName=`${d.standardGivenName} ${d.standardFamilyName}`):(d.standardFamilyName=r?.standardFamilyName,d.standardGivenName=r?.standardGivenName),delete d.firstName,delete d.lastName,d.extensions=s(r),t.person=d,c[r?.personId]=d.personId})),(n.participants||[]).filter((({participantType:t})=>t===Ou)).forEach((t=>{const{individualParticipantIds:e}=t;t.participantName=function({individualParticipantIds:t,individualParticipants:e}){let n=e.filter((({participantId:e})=>t.includes(e))).map((({person:t})=>t?.standardFamilyName)).filter(Boolean).sort().join("/");1===t.length&&(n+="/Unknown");return n}({individualParticipantIds:e,individualParticipants:m})}));const N=(n.participants||[]).filter((({participantType:t})=>t===Fu)),R=ON({count:N.length}).names;N.forEach(((t,e)=>{t.participantName=R[e]}));const b=(n.participants||[]).filter((({participantType:t})=>t===Cu)),M=ON({count:b.length,nameRoot:"Group"}).names;b.forEach(((t,e)=>{t.participantName=M[e]}));const{extension:A}=Us({name:Fo,tournamentRecord:n});Array.isArray(A?.value)&&A?.value.forEach((t=>{t.tournamentId=c[t.tournamentId],t.structureId=c[t.structureId],t.eventId=c[t.eventId],t.drawId=c[t.drawId]}));const{extension:E}=Us({name:Mo,tournamentRecord:n});return Array.isArray(E?.value)&&E?.value.forEach((t=>{t.personId=c[t.personId]})),{...L}},modifyTournamentRecord:function(t){const{ratingsParameters:e=Bm,participantsProfile:n={},matchUpStatusProfile:r,completeAllMatchUps:i,autoEntryPositions:a,hydrateCollections:o,randomWinningSide:s,schedulingProfile:c,tournamentRecord:u,eventProfiles:d,venueProfiles:p,autoSchedule:l,drawProfiles:m,uuids:f}=t;if(!u)return{error:$};const h=[],I=[],g=[];d?.forEach((t=>{const e=u.events?.find(((e,n)=>void 0!==t.eventIndex&&n===t.eventIndex||t.eventName&&e.eventName===t.eventName||t.eventId&&e.eventId===t.eventId));e?.gender&&(t.gender=e.gender)}));const U=u.participants?.length||void 0;U&&n?.idPrefix&&(n.idPrefix=`${n.idPrefix}-${U}`);const y=$N({startDate:u.startDate,participantsProfile:n,tournamentRecord:u,eventProfiles:d,drawProfiles:m,uuids:f});if(!y.success)return y;if(d){let t=u.events?.length||0;for(const e of d){const{ratingsParameters:o}=e,c=u.events?.find(((t,n)=>void 0!==e.eventIndex&&n===e.eventIndex||e.eventName&&t.eventName===e.eventName||e.eventId&&t.eventId===e.eventId));if(c){const{gender:t,category:d,eventType:p}=c,{drawProfiles:l,publish:m}=e,I=p===vu&&Eu||p===Tu&&Ou||p;if(l){const{stageParticipantsCount:m,uniqueParticipantsCount:U,uniqueParticipantStages:y}=HN({drawProfiles:l,category:d,gender:t}),{uniqueDrawParticipants:S=[],uniqueParticipantIds:v=[]}=y?WN({event:{eventType:p,category:d,gender:t},uniqueParticipantsCount:U,participantsProfile:n,ratingsParameters:o,tournamentRecord:u,eventProfile:e,uuids:f}):{};h.push(...v);const{stageParticipants:w}=zN({targetParticipants:u.participants||[],allUniqueParticipantIds:h,stageParticipantsCount:m,eventParticipantType:I});let T=KN({uniqueDrawParticipants:S,autoEntryPositions:a,stageParticipants:w,tournamentRecord:u,drawProfiles:l,category:d,gender:t,event:c});if(T.error)return T;if(T=BN({matchUpStatusProfile:r,completeAllMatchUps:i,randomWinningSide:s,tournamentRecord:u,drawProfiles:l,event:c}),T.error)return T;g.push(...T.drawIds)}m&&BP({tournamentRecord:u,event:c})}else{const c=JN({startDate:u.startDate,allUniqueParticipantIds:h,matchUpStatusProfile:r,participantsProfile:n,completeAllMatchUps:i,autoEntryPositions:a,randomWinningSide:s,ratingsParameters:o,tournamentRecord:u,eventProfile:e,eventIndex:t,uuids:f});if(c.error)return c;const{eventId:d,drawIds:p,uniqueParticipantIds:l}=c;p&&g.push(...p),I.push(d),l?.length&&h.push(...l),t+=1}}}if(m){let t=(u.events||[]).map((t=>t.drawDefinitions?.map((()=>1))||[])).flat().reduce(((t,e)=>t+e),0);for(const c of m){let d=QN({startDate:u.startDate,allUniqueParticipantIds:h,matchUpStatusProfile:r,participantsProfile:n,completeAllMatchUps:i,autoEntryPositions:a,hydrateCollections:o,randomWinningSide:s,ratingsParameters:e,tournamentRecord:u,drawProfile:c,drawIndex:t,uuids:f});if(d.error)return d;const{drawId:p,eventId:l,event:m,uniqueParticipantIds:U}=d;if(d=qD({tournamentRecord:u,event:m,internalUse:!0}),d.error)return d;p&&g.push(p),I.push(l),U?.length&&h.push(...U),t+=1}}const S=p?.length?XN({tournamentRecord:u,venueProfiles:p}):[];let v={};if(c?.length){const t=iy({tournamentRecords:{[u.tournamentId]:u},schedulingProfile:c});if(t.error)return t;if(l){const{tournamentId:t}=u;v=Gy({tournamentRecords:{[t]:u}})}}return{totalParticipantsCount:u.participants.length,scheduledRounds:undefined,schedulerResult:v,...L,eventIds:I,venueIds:S,drawIds:g}}};const tR=["Mock Tournament","CourtHive Challenge","Racket Rally","Generated Tournament","Factory Follies","Open Competition"];const eR={generateOutcomeFromScoreString:KP,generateTournamentRecord:function(t){let{tournamentAttributes:e,startDate:n,endDate:r}=t;const{tournamentName:i=M(tR),ratingsParameters:a=Bm,scheduleCompletedMatchUps:o,tournamentExtensions:s,matchUpStatusProfile:c,completeAllMatchUps:u,participantsProfile:d,autoEntryPositions:p,hydrateCollections:l,randomWinningSide:m,policyDefinitions:f,schedulingProfile:h,autoSchedule:I,eventProfiles:g,venueProfiles:U,drawProfiles:y,uuids:S}=t;if(n&&!Cr(n)||r&&!Cr(r))return{error:ye};if(g&&!Array.isArray(g))return{error:xn};if(!n){const t=new Date;n=Fr(r??t),r=Fr(t.setDate(t.getDate()+7))}if(!r){const t=new Date(n);r=Fr(t.setDate(t.getDate()+7))}"object"!=typeof e&&(e={});const v=hP({...e,tournamentName:i,startDate:n,endDate:r});if(s?.length&&Array.isArray(s)){const t=s.filter((t=>xs({extension:t})));t?.length&&Object.assign(v,{extensions:t,isMock:!0})}if("object"==typeof f)for(const T of Object.keys(f))lS({policyDefinitions:{[T]:f[T]},tournamentRecord:v});const w=$N({participantsProfile:d,tournamentRecord:v,eventProfiles:g,drawProfiles:y,startDate:n,uuids:S});if(!w.success)return w;const P=[],D=[],N=[];if(Array.isArray(y)){let t=0;for(const e of y){let r=QN({allUniqueParticipantIds:P,matchUpStatusProfile:c,participantsProfile:d,completeAllMatchUps:u,autoEntryPositions:p,hydrateCollections:l,randomWinningSide:m,ratingsParameters:a,tournamentRecord:v,isMock:!0,drawProfile:e,startDate:n,drawIndex:t,uuids:S});if(r.error)return r;const{drawId:i,eventId:o,event:s,uniqueParticipantIds:f}=r;if(r=qD({suppressNotifications:!1,internalUse:!0,tournamentRecord:v,event:s}),r.error)return r;i&&N.push(i),D.push(o),f?.length&&P.push(...f),t+=1}}if(g){let t=0;for(const e of g){const r=JN({allUniqueParticipantIds:P,matchUpStatusProfile:c,participantsProfile:d,completeAllMatchUps:u,autoEntryPositions:p,hydrateCollections:l,randomWinningSide:m,ratingsParameters:a,tournamentRecord:v,eventProfile:e,eventIndex:t,startDate:n,uuids:S});if(r.error)return r;const{eventId:i,drawIds:o,uniqueParticipantIds:s}=r;o&&N.push(...o),D.push(i),s?.length&&P.push(...s),t+=1}}const R=U?.length?XN({tournamentRecord:v,venueProfiles:U,uuids:S}):[];let b,A={};if(h){const t=function({schedulingProfile:t,tournamentRecord:e}){if("object"!=typeof t)return{error:xn};const n=LI({tournamentRecord:e}).containedStructures,r=th({tournamentRecord:e}).matchUps||[],{tournamentId:i}=e,a=[];for(const o of t){const{scheduleDate:t,venues:s=[]}=o;for(const o of s){const{rounds:s,venueId:c}=o;for(const o of s){const{drawId:s,winnerFinishingPositionRange:u,roundSegment:d}=o,p=r.filter((t=>{const e=u?.indexOf("-")>0&&u.split("-").map((t=>+t)),n=t.finishingPositionRange?.winner;return!(t.drawId!==s||o.roundNumber&&t.roundNumber!==o.roundNumber||n&&e&&2!==O(n,e).length&&(T(n).length!==T(e).length||O(n,e).length!==T(n).length))}))[0];if(p){const{eventId:r,roundNumber:o,drawName:l,structureName:m,roundName:f}=p;let h=p.structureId;o&&!u&&(h=Object.keys(n).find((t=>n[t].includes(h)))||h);const I={tournamentId:i,structureId:h,roundNumber:o,roundSegment:d,eventId:r,drawId:s},g=ay({tournamentRecords:{[i]:e},round:I,scheduleDate:t,venueId:c});if(g.error)return g;a.push({structureName:m,roundName:f,drawName:l,...I})}}}}return{scheduledRounds:a}}({schedulingProfile:h,tournamentRecord:v});if(t.error)return t;if(b=t.scheduledRounds,I){const{tournamentId:t}=v;A=Gy({scheduleCompletedMatchUps:o,tournamentRecords:{[t]:v}})}}return ur(),di({...L,tournamentRecord:v,scheduledRounds:b,schedulerResult:A,eventIds:D,venueIds:R,drawIds:N})},generateEventWithDraw:QN,generateParticipants:VN,parseScoreString:Mh,generateOutcome:QP,credits:hS};let nR=!1;const rR=(()=>{const t={version:()=>"1.8.14",setDeepCopy:(e,n)=>(sr(e,n),t),devContext:e=>(ar(e),nR=!0,t)};return[ZN,eR].forEach((e=>{Object.keys(e).forEach((n=>{t[n]=t=>{try{return function(t,e){const n=t({...e});return n?.error||iI(),mr(),nR&&(ar(!1),nR=!1),n}(e[n],t)}catch(r){let e;"string"==typeof r?e=r.toUpperCase():r instanceof Error&&(e=r.message),console.log("ERROR",{params:JSON.stringify(t),method:n,error:e})}}}))})),t})(),iR={activeMatchUpStatuses:ha,auditConstants:Cy,completedMatchUpStatuses:fa,directingMatchUpStatuses:la,drawDefinitionConstants:$d,entryStatusConstants:hp,errorConditionConstants:Xn,eventConstants:Ru,extensionConstants:Lo,flightConstants:rN,genderConstants:Gp,keyValueConstants:ym,matchUpActionConstants:jS,matchUpStatusConstants:ga,matchUpTypes:Oa,nonDirectingMatchUpStatuses:ma,participantConstants:Bu,participantRoles:DP,particicipantsRequiredMatchUpStatuses:da,participantTypes:Lu,penaltyConstants:{COACHING:"Coaching",BALL_ABUSE:"Ball Abuse",RACKET_ABUSE:"Racket Abuse",VERBAL_ABUSE:"Verbal Abuse",PHYSICAL_ABUSE:"Physical Abuse",INELIGIBILITY:"INELIGIBILITY",UNSPORTSMANLIKE_CONDUCT:"Unsportmanlike Conduct",PROHIBITED_SUBSTANCE:"PROHIBITED_SUBSTANCE",DRESS_CODE_VIOLATION:"Dress Code Violation",EQUIMENT_VIOLATION:"Equipment Violation",LEAVING_THE_COURT:"Leaving the court",REFUSAL_TO_PLAY:"REFUSAL_TO_PLAY",FAILURE_TO_COMPLETE:"Failure to complete",NO_SHOW:"No Show",OTHER:"Other",PUNCTUALITY:"Puncuality",FAILUIRE_TO_SIGN_IN:"Failure to sign in"},policyConstants:po,positionActionConstants:Ef,ratingConstants:Lm,recoveryTimeRequiredMatchUpStatuses:ua,requestConstants:gy,resultConstants:B,scaleConstants:ls,scheduleConstants:Os,sortingConstants:zP,surfaceConstants:{CLAY:"CLAY",HARD:"HARD",GRASS:"GRASS",CARPET:"CARPET",ARTIFICIAL:"ARTIFICIAL"},tieFormatConstants:BD,timeItemConstants:uu,topicConstants:Mc,tournamentConstants:rD,upcomingMatchUpStatuses:Ia,validMatchUpStatuses:pa,venueConstants:{INDOOR:"INDOOR",OUTDOOR:"OUTDOOR"}},aR={addExtension:Bs,calculateWinCriteria:Gf,categoryCanContain:Ei,chunkArray:x,compareTieFormats:hh,countValues:function(t){return e=N(t),Object.keys(e).reduce(((t,n)=>{const r=e[n];return t[r]?t[r].push(n):t[r]=[n],t}),{});var e},createMap:ci,dateRange:_r,dateTime:ni,definedAttributes:di,dehydrateMatchUps:function({tournamentRecord:t}){if(!t)return{error:$};if("object"!=typeof t||!t.tournamentId)return{error:xn};const{matchUps:e}=th({tournamentRecord:t,inContext:!1});if(e?.length){const n=function({tournamentRecord:t}){const e={};for(const n of t.events||[]){n.matchUpFormat&&(e[n.eventId]=n.matchUpFormat);for(const t of n.drawDefinitions||[]){t.matchUpFormat&&(e[t.drawId]=t.matchUpFormat);for(const n of t.structures||[]){n.matchUpFormat&&(e[n.structureId]=n.matchUpFormat);for(const t of n.structures||[])t.matchUpFormat&&(e[t.structureId]=t.matchUpFormat)}}}return e}({tournamentRecord:t});!function(t,e={}){for(const n of t){const{structureId:t,drawId:r,eventId:i}=n,a=e[t]||e[r]||e[i],o=n.matchUpFormat===a?void 0:n.matchUpFormat;for(const e of Object.keys(n))gh.includes(e)||delete n[e];n.sides&&n.drawPositions&&!n.tieMatchUps&&delete n.sides,o&&(n.matchUpFormat=o)}}(e,n)}return{...L}},extractAttributes:ui,findExtension:gs,flattenJSON:fi,garman:bh,generateHashCode:function(t){if(null===t||"object"!=typeof t)return;const e=JSON.stringify(t),n=pi(t),r=e.split("").reduce(((t,e)=>t+e.charCodeAt(0)),0);return[e.length,n,r].map((t=>t.toString(36))).join("")},generateRange:E,generateScoreString:Ml,generateTimeCode:mi,getAssignedParticipantIds:Uh,getCategoryAgeDetails:Ai,getScaleValues:ms,getTimeItem:$f,hasAttributeValues:t=>e=>Object.keys(t).every((n=>e[n]===t[n])),instanceCount:N,intersection:O,isAdHoc:Fp,isConvertableInteger:v,isNumeric:U,isPowerOf2:f,JSON2CSV:function(t,e){if(e&&"object"!=typeof e)return xn;let{columnTransform:n={}}=e||{};const{includeTransformAccessors:r,includeHeaderRow:i=!0,returnTransformedJSON:a,removeEmptyColumns:o,onlyHeaderRow:s,columnAccessors:c=[],functionMap:u={},columnMap:d={},valuesMap:p={},context:l={},delimiter:m='"',columnJoiner:f=",",rowJoiner:h="\r\n",keyJoiner:I="."}=e||{};if(!Array.isArray(t)||!Array.isArray(c)||"object"!=typeof l||"object"!=typeof d||"object"!=typeof n||"object"!=typeof u||"object"!=typeof p||"string"!=typeof f||"string"!=typeof h||"string"!=typeof I||"string"!=typeof m)return xn;n=Object.assign({},...Object.keys(n).reverse().map((t=>({[t]:Array.isArray(n[t])?n[t]:["string"==typeof n[t]&&n[t]].filter(Boolean)}))));const g=t.filter(Boolean).map((t=>fi(t,I))),y=Object.values(n).flat();r&&c.push(...y);const S=g.reduce(((t,e)=>Object.keys(e).every((e=>!t.includes(e)&&t.push(e)||!0))&&t),[]).filter((t=>!c?.length||c.includes(t))),v=Object.assign({},...Object.keys(n).reverse().map((t=>n[t].map((e=>({[e]:t}))).flat())).flat()),w=S.reduce(((t,e)=>{const n=v[e];return n?t.includes(n)||t.push(n):t.push(e),t}),[]).sort(((t,n)=>e?.sortOrder?e.sortOrder.includes(t)&&e.sortOrder.includes(n)&&e.sortOrder.indexOf(t)-e.sortOrder.indexOf(n)||!e.sortOrder.includes(n)&&-1:0));Object.keys(d).forEach((t=>!w.includes(t)&&w.unshift(t))),Object.keys(n).forEach((t=>!w.includes(t)&&w.unshift(t))),"object"==typeof l&&Object.keys(l).forEach((t=>!w.includes(t)&&w.unshift(t)));let T=w.map((t=>d[t]||t));if(s)return[T];const P=t=>`${m}${t}${m}`,D=[];let N=g.map((t=>Object.values(w.reduce(((e,r,i)=>{const a=n[r],o=(a?.length?t[a.find((e=>t[e]))]:t[r])||l?.[r]||"",s=p[r]?.[o]||o,c="function"==typeof u[r]?u[r](s):s;return e[r]=P(c),c&&(D[i]=(D[i]||0)+1),e}),{}))));const R=o&&[...D].map(((t,e)=>!t&&e)).filter(U).reverse();if(R){const t=t=>t.filter(((t,e)=>!R.includes(e)));N=N.map(t),T=t(T)}const b=N.map((t=>t.join(f)));return a?b.map((t=>{const e=t.split(f);return Object.assign({},...e.map(((t,e)=>({[T[e]]:t}))))})):i?[T.map(P).join(f),...b].join(h):b.join(h)},makeDeepCopy:ri,matchUpSort:dh,nearestPowerOf2:g,nextPowerOf2:y,numericSort:l,overlap:k,parseScoreString:Mh,participantScaleItem:yh,proConflicts:lh,randomMember:A,randomPop:M,roundRobinGroups:Oh,scoreHasValue:Yp,shuffleArray:P,structureSort:Wd,tidyScore:function(t){const{score:e,sheetName:n,identifier:r,fileName:i,stepLog:a,fullLog:o,profile:s}=t,c=[];let u,d,p,l=[],m=e;const f=t=>{t.forEach((t=>{p=Xh[t]({profile:s,identifier:r,matchUpStatus:u,attributes:d,applied:l,score:m});const e=p.score!==m;e&&c.push({method:t,score:p.score}),a&&(o||e||p.matchUpStatus!==u)&&(u?console.log({score:p.score,matchUpStatus:u},t):console.log({score:p.score},t)),p.matchUpStatus&&(u=p.matchUpStatus),p.attributes&&(d=p.attributes),p.applied&&(l=p.applied),m=p.score}))};f(tI);let h=jh(m);return h||(m=e.toString().replace(/\D/g,""),d?.removed&&(d.removed=void 0),f(eI),h=jh(m),h||(m="")),l.forEach((t=>{Zh[t]||(Zh[t]=0),Zh[t]+=1})),{matchUpStatus:u?.toUpperCase(),modifications:c,attributes:d,isValid:h,score:m}},unique:T,UUID:hi,UUIDS:function(t=1){return E(0,t).map(hi)},validateTieFormat:$i,visualizeScheduledMatchUps:function({scheduledMatchUps:t,showGlobalLog:e}){Bf.length=0;const n=t?.reduce(((t,{structureId:e})=>t.includes(e)?t:t.concat(e)),[]),r=Object.assign({},...(n||[]).map((e=>{const{structureName:n,matchUpType:r}=t.find((t=>t.structureId===e));return{[e]:`${n} ${r}`}})));n?.forEach((e=>{Vf({color:"blue",method:"draw",structure:r[e],keyColors:{structure:"magenta"}},!0);const n=t.filter((t=>t.structureId===e)),i=Gu({matchUps:n})?.roundMatchUps||[];Object.keys(i).forEach((t=>{Vf({roundNumber:t,keyColors:{roundNumber:"brightcyan"}},!0),i[t].forEach((({matchUpId:t,schedule:e})=>{Vf({matchUpId:t,time:qr(e.scheduledTime),date:e.scheduledDate,venue:e.venueId,keyColors:{time:"brightcyan",date:"brightcyan",matchUpId:"yellow",venue:"magenta"}},!0)}))}))})),e&&jf()}}}}]);