"use strict";(globalThis.webpackChunkdocumentation=globalThis.webpackChunkdocumentation||[]).push([[1474],{4562(e,t,r){r.d(t,{A:()=>a});r(758);var i=r(3443),n=r(6070);function a({children:e,fallback:t}){return(0,i.A)()?(0,n.jsx)(n.Fragment,{children:e?.()}):t??null}},8322(e,t,r){r.d(t,{R:()=>o,x:()=>s});var i=r(758);const n={},a=i.createContext(n);function o(e){const t=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:o(e.components),i.createElement(a.Provider,{value:t},e.children)}},1758(e,t,r){r.d(t,{Yl:()=>WO,gm:()=>vk,o3:()=>yk});var i=Object.defineProperty,n=(e,t)=>{for(var r in t)i(e,r,{get:t[r],enumerable:!0})};var a={};n(a,{competitionGovernor:()=>o,drawsGovernor:()=>ad,entriesGovernor:()=>yM,eventGovernor:()=>OM,generationGovernor:()=>SR,matchUpFormatGovernor:()=>WR,matchUpGovernor:()=>HR,mocksGovernor:()=>oA,participantGovernor:()=>ME,policyGovernor:()=>ID,publishingGovernor:()=>rC,queryGovernor:()=>bD,reportGovernor:()=>hC,scheduleGovernor:()=>wC,scoreGovernor:()=>Uw,tieFormatGovernor:()=>LC,tournamentGovernor:()=>oO,venueGovernor:()=>wO});var o={};n(o,{getLinkedTournamentIds:()=>nd,getTournamentIds:()=>Mu,linkTournaments:()=>ed,mutate:()=>s,query:()=>id,unlinkTournament:()=>rd,unlinkTournaments:()=>td});var s={};n(s,{linkTournaments:()=>ed,unlinkTournament:()=>rd,unlinkTournaments:()=>td});var c="SINGLES",u="SINGLES",d="DOUBLES",l="DOUBLES",p="TEAM",m="TEAM",f={SINGLES_MATCHUP:c,SINGLES:u,DOUBLES_MATCHUP:d,DOUBLES:l,TEAM_MATCHUP:p,TEAM:m},h={[u]:[u,"S"],[l]:[l,"D"],[m]:[m,"T"],S:[u,"S"],D:[l,"D"],T:[m,"T"]};function g(e,t){return(e??0)-(t??0)}function I(e){return"number"==typeof e?parseInt(e.toString()):"string"==typeof e?parseInt(e):0}function U(e){return"function"==typeof e}function S(e){return"string"==typeof e}function v(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}function y(e,t){if(!v(e)||!v(t))return!1;let r=Object.keys(e),i=Object.keys(t);if(r.length!==i.length)return!1;for(let n of r)if(e[n]!==t[n])return!1;return!0}function w(e,t){return Array.isArray(e)?Object.assign({},...(e??[]).filter(v).map(e=>e[t]&&{[e[t]]:e}).filter(Boolean)):{}}var P=e=>t=>Object.keys(e).every(r=>t[r]===e[r]);function T(e,t){if(void 0===e)return null;if(!v(e)||null===e)return e;let r=Object.keys(e),i=e=>void 0===e?null:e;return Object.assign({},...r.map(r=>Array.isArray(e[r])?{[r]:t?e[r]:e[r].map(e=>T(e))}:{[r]:t?i(e[r]):T(e[r])}))}function D(e){return Array.isArray(e)?e.length+e.map(D).reduce((e,t)=>e+t,0):v(e)&&null!==e?Object.keys(e).length+Object.keys(e).map(t=>D(e[t])).reduce((e,t)=>e+t,0):0}function b(e){if(null===e||"object"!=typeof e)return;let t=JSON.stringify(e),r=D(e),i=t.split("").reduce((e,t)=>e+t.charCodeAt(0),0);return[t.length,r,i].map(e=>e.toString(36)).join("")}function M(e){return!Number.isNaN(Number(e))&&(e>0&&!(e&e-1))}function R(e){if(!e.length)return;let t=[...e].sort(g),r=Math.floor(t.length/2);return t.length%2?t[r]:(t[r-1]+t[r])/2}function N(e){return Number.isNaN(Number(e))?0:e%2&&e+1||e}function A(e){return Math.pow(2,Math.round(Math.log(e)/Math.log(2)))}function E(e){return!Number.isNaN(Number.parseFloat(e))}function C(e){let t=I(e);if(!Number.isNaN(t))return 0!==t&&1===(t&-t)}function O(e){if(Number.isNaN(Number(e)))return!1;for(;!M(e);)e++;return e}function k(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e}function F(e){return!(S(e)&&!e.trim().length)&&Number.isSafeInteger("string"==typeof e?+e:e)}function x(e,t,r,i,n=2){let a=1-Math.random(),o=1-Math.random(),s=Math.sqrt(-2*Math.log(a))*Math.cos(2*Math.PI*o);return s=s/10+.5,s>1||s<0?s=x(e,t,r):(s=Math.pow(s,r),s*=t-e,s+=e),i&&(s=function(e,t){t||(t=1);let r=1/t;return Math.round(e*r)/r}(s,i)),Number.parseFloat(s.toFixed(n))}function _(e,t=2){return Number.parseFloat(Number(Math.round(1e3*e)/1e3).toFixed(t))}function L(e){return Array.isArray(e)?e?.filter((e,t,r)=>r.lastIndexOf(e)===t):[]}function B(e){return Array.isArray(e)?e?.map(e=>null===e?void 0:e):e}function V(e){return Array.isArray(e)?e.map(e=>[Math.random(),e]).sort((e,t)=>e[0]-t[0]).map(e=>e[1]):[]}function G(e){return F(e)?e:1/0}function j(e){return Array.isArray(e)?e.reduce((e,t)=>(e[t]||(e[t]=0),e[t]++,e),{}):{}}function $(e){return q(j(e))}function q(e){return Object.keys(e).reduce((t,r)=>{let i=e[r];return t[i]?t[i].push(r):t[i]=[r],t},{})}function W(e,t,r){return r.indexOf(e)===t}function H(e){return e.filter(W)}function Y(e){return Array.isArray(e)&&e.length?e.splice(Math.floor(Math.random()*e.length),1)[0]:void 0}function z(e){return e[Math.floor(Math.random()*e.length)]}function K(e,t){return Array.from({length:t-e},(t,r)=>r+e)}function J(e,t){return t.reduce((t,r,i)=>(r===e&&t.push(i),t),[])}function Q(e,t){return Array.isArray(e)&&Array.isArray(t)?e.filter(e=>-1!==t.indexOf(e)).filter((e,t,r)=>r.indexOf(e)===t):[]}function X(e,t){return Array.isArray(e)&&Array.isArray(t)?e.filter(e=>!t.includes(e)):[]}function Z(e,t){return!(!Array.isArray(e)||!Array.isArray(t))&&e.some(e=>t.includes(e))}function ee(e,t){return Array.isArray(t)&&t.reduce((e,t)=>(e[t]=1+e[t]||1,e),{})[e]||0}function te(e,t,r,i){return Array.isArray(e)?[].concat(...e.slice(0,t),...e.slice(t,t+r).sort(i),...e.slice(t+r,e.length)):[]}function re(e,t){return Array.isArray(e)?e.reduce((e,r,i)=>{let n=Math.floor(i/t);return e[n]=[].concat(e[n]||[],r),e},[]):[]}function ie(e,[t,...r]){return e.length?[e.slice(0,t),...ie(e.slice(t),[...r,t])]:[]}function ne(e){return!!Array.isArray(e)&&e.reduce((e,t)=>!isNaN(parseInt(t))&&e,!0)}function ae(e){return!!Array.isArray(e)&&e.reduce((e,t)=>isNaN(parseInt(t))&&e,!0)}function oe(e,t,r){return Array.isArray(e)?e.reduce((e,i,n)=>{let a=!!r&&!!(Math.floor(n/t)%2),o=n%t,s=a?t-1-o:o;return e[s]||(e[s]=[]),e[s].push(i),e},[]):[]}function se(e,t){return!(!Array.isArray(e)||!S(t))&&Q(e,h[t]).length}var ce={success:!0},ue="error",de={SUCCESS:ce,ERROR:ue};function le({collectionValueProfiles:e,matchUpCount:t}){let r=[];if(!Array.isArray(e))return r.push(`collectionValueProfiles is not an array: ${e}`),{errors:r};if(e.length&&e.length!==t)return r.push("collectionValueProfiles do not align with matchUpsCount"),{errors:r};for(let n of e){if("object"!=typeof n)return r.push(`valueProfile is not type object: ${n}`),{errors:r};let{matchUpValue:e,collectionPosition:i}=n;if("number"!=typeof e||"number"!=typeof i||i>t||i<1)return r.push("Invalid value profile: value and collectionPosition must be numeric. collectionPosition cannot be greater than matchUpCount"),{errors:r}}let i=e.map(e=>e.collectionPosition);return i.length!==L(i).length?(r.push("collectionPositions are not unique"),{errors:r}):{...ce}}n({},{addNotice:()=>rn,callListener:()=>dn,createInstanceState:()=>ji,cycleMutationStatus:()=>tn,deepCopyEnabled:()=>Ji,deleteNotice:()=>on,deleteNotices:()=>sn,disableNotifications:()=>Yi,enableNotifications:()=>zi,getDevContext:()=>$i,getMethods:()=>nn,getNotices:()=>an,getProvider:()=>Un,getTopics:()=>cn,getTournamentId:()=>ln,getTournamentRecord:()=>pn,getTournamentRecords:()=>mn,globalLog:()=>vn,handleCaughtError:()=>Sn,hasTopic:()=>un,removeTournamentRecord:()=>In,setDeepCopy:()=>Ki,setDevContext:()=>Hi,setGlobalLog:()=>Wi,setGlobalMethods:()=>Zi,setGlobalSubscriptions:()=>Qi,setMethods:()=>en,setStateMethods:()=>yn,setStateProvider:()=>Gi,setSubscriptions:()=>Xi,setTournamentId:()=>gn,setTournamentRecord:()=>fn,setTournamentRecords:()=>hn,timeKeeper:()=>qi});var pe={message:"Chronological error; time violation.",code:"ANACHRONISM"},me={message:"Duplicate entry",code:"DUPLICATE_ENTRY"},fe={message:"Cannot remove main structure",code:"ERR_CANNOT_REMOVE_MAIN_STRUCTURE"},he={message:"records must be an object with tournamentId keys",code:"ERR_INVALID_TOURNAMENTS"},ge={message:"Missing tournamentRecords",code:"ERR_MISSING_TOURNAMENTS"},Ie={message:"Missing tournamentRecord",code:"ERR_MISSING_TOURNAMENT"},Ue={message:"Invalid tournamentRecord",code:"ERR_INVALID_TOURNAMENT"},Se={message:"Missing tournamentId",code:"ERR_MISSING_TOURNAMENT_ID"},ve={message:"Invalid drawDefinition",code:"ERR_INVALID_DRAWDEF"},ye={message:"Missing drawDefinition",code:"ERR_MISSING_DRAWDEF"},we={message:"Existing drawDefinition(s)",code:"ERR_EXISTING_DRAWDEFS"},Pe={message:"drawDefinition not found",code:"ERR_NOT_FOUND_DRAWDEF"},Te={message:"Invalid structure",code:"ERR_INVALID_STRUCTURE"},De={message:"Incomplete source structure",code:"ERR_INCOMPLETE_STRUCTURE"},be={message:"Invalid drawPosition for seedAssignment",code:"ERR_INVALID_SEEDING_POSITION"},Me={message:"drawPosition already assigned",code:"ERR_EXISTING_POSITION_ASSIGNMENT"},Re={message:"Schedule not cleared",code:"ERR_UNCHANGED_SCHEDULE_NOT_CLEARED"},Ne={message:"Schedule conflict: court slot already occupied",code:"ERR_SCHEDULE_CONFLICT_DOUBLE_BOOKING"},Ae={message:"drawPosition not cleared",code:"ERR_FAILURE_POSITION_NOT_CLEARED"},Ee={message:"Unrecognized drawType",code:"ERR_UNRECOGNIZED_DRAW_TYPE"},Ce={message:"Missing drawPositions",code:"ERR_MISSING_DRAW_POSITIONS"},Oe={message:"drawPosition is active",code:"ERR_ACTIVE_DRAW_POSITION"},ke={message:"drawPosition is occupied",code:"ERR_OCCUPIED_DRAW_POSITION"},Fe={message:"Invlid drawPosition",code:"ERR_INVALID_DRAW_POSITION"},xe={message:"Missing drawPosition",code:"ERR_MISSING_DRAW_POSITION"},_e={message:"Invalid drawType",code:"ERR_INVALID_DRAW_TYPE"},Le={message:"Invalid drawSize",code:"ERR_INVALID_DRAW_SIZE"},Be={message:"Cannot set drawSize to be less than existing entries",code:"ERR_INVALID_DRAW_SIZE_MISMATCH"},Ve={message:"Missing drawSize",code:"ERR_MISSING_DRAW_SIZE"},Ge={message:"Missing drawId",code:"ERR_MISSING_DRAW_ID"},je={message:"drawId exists",code:"ERR_EXISTING_DRAW_ID"},$e={message:"participantId cannot be assigned to multiple seedNumbers",code:"INVALID_PARTICIPANT_SEEDING"},qe={message:"seedsCount greater than drawSize",code:"ERR_INVALID_SEED_COUNT"},We={message:"Missing seedCountThresholds",code:"ERR_MISSING_SEED_COUNT_THRESHOLD"},He={message:"Invalid action",code:"ERR_INVALID_ACTION"},Ye={message:"Invalid assignment",code:"ERR_INVALID_ASSIGNMENT"},ze={message:"Missing seedAssignments",code:"ERR_MISSING_SEED_ASSIGNMENTS"},Ke={message:"Invalid seedNumber",code:"ERR_INVALID_SEED_NUMBER"},Je={message:"Invalid seedPosition",code:"ERR_INVALID_SEED_POSITION"},Qe={message:"Missing targetLink",code:"ERR_MISSING_LINK_TARGET"},Xe={message:"Existing round",code:"ERR_EXISTING_ROUND"},Ze={message:"Missing structureId",code:"ERR_MISSING_STRUCTURE_ID"},et={message:"structure not found",code:"ERR_NOT_FOUND_STRUCTURE"},tt={message:"Missing structures",code:"ERR_MISSING_STRUCTURES"},rt={message:"Missing structure",code:"ERR_MISSING_STRUCTURE"},it={message:"Missing MAIN structure",code:"ERR_MISSING_MAIN_STRUCTURE"},nt={message:"drawDefinition contains unlinked structures",code:"ERR_MISSING_STRUCTURE_LINKS"},at={message:"Invalid eventType",code:"ERR_INVALID_EVENT_TYPE"},ot={message:"Missing event / eventId",code:"ERR_MISSING_EVENT_ID"},st={message:"Event not found",code:"ERR_NOT_FOUND_EVENT"},ct={message:"Event exists",code:"ERR_EXISTING_EVENT"},ut={message:"Missing entries",code:"ERR_MISSING_ENTRIES"},dt={message:"Invalid entries",code:"ERR_INVALID_ENTRIES"},lt={message:"Missing assignments",code:"ERR_MISSING_ASSIGNMENTS"},pt={message:"Missing stage",code:"ERR_MISSING_STAGE"},mt={message:"Invalid stage",code:"ERR_INVALID_STAGE"},ft={message:"stageSequence limit",code:"ERR_LIMIT_STAGE_SEQUENCE"},ht={message:"Missing positionAssignments",code:"ERR_MISSING_POSITION_ASSIGNMENTS"},gt={message:"Cannot Assign BYE status if no assignment: { bye: true }",code:"ERR_UNCHANGED_CANNOT_ASSIGN_BYE"},It={message:"Unrecognized matchUpStatus",code:"ERR_UNRECOGNIZED_MATCHUP_STATUS"},Ut={message:"Unrecognized matchUpFormat",code:"ERR_UNRECOGNIZED_MATCHUP_FORMAT"},St={message:"Incompatible matchUpStatus",code:"ERR_INCOMPATIBLE_MATCHUP_STATUS"},vt={message:"Propagated exits downstream",code:"ERR_PROPAGATED_EXITS_DOWNSTREAM"},yt={message:"Invalid matchUpStatus",code:"ERR_INVALID_MATCHUP_STATUS"},wt={message:"Invalid tieFormat",code:"ERR_INVALID_TIE_FORMAT"},Pt={message:"Invalid matchUpFormat",code:"ERR_INVALID_MATCHUP_FORMAT"},Tt={message:"Missing matchUpFormat",code:"ERR_MISSING_MATCHUP_FORMAT"},Dt={message:"Missing collectionDefinition",code:"ERR_MISSING_COLLECTION_DEFINITION"},bt={message:"Missing tieFormat",code:"ERR_MISSING_TIE_FORMAT"},Mt={message:"Missing matchUpId",code:"ERR_MISSING_MATCHUP_ID"},Rt={message:"Missing matchUpIds",code:"ERR_MISSING_MATCHUP_IDS"},Nt={message:"matchUp not found",code:"ERR_NOT_FOUND_MATCHUP"},At={message:"Missing matchUps",code:"ERR_MISSING_MATCHUPS"},Et={message:"Missing matchUp",code:"ERR_MISSING_MATCHUP"},Ct={message:"Invalid matchUp",code:"ERR_INVALID_MATCHUP"},Ot={message:"Missing policyType",code:"ERR_MISSING_POLICY_TYPE"},kt={message:"Missing policyDefinitions",code:"ERR_MISSING_POLICY_DEFINITIONS"},Ft={message:"Missing avoidance policy",code:"ERR_MISSING_POLICY_AVOIDANCE"},xt={message:"Missing policy attributes",code:"ERR_MISSING_POLICY_ATTRIBUTES"},_t={message:"Invalid policyDefinitions",code:"ERR_INVALID_POLICY_DEFINITIONS"},Lt={message:"existing policyType",code:"ERR_EXISTING_POLICY_TYPE"},Bt={message:"Policy not found",code:"ERR_NOT_FOUND_POLICY"},Vt={message:"Invalid sideNumber",code:"ERR_INVALID_SIDE_NUMBER"},Gt={message:"Missing setObject",code:"ERR_MISSING_SET_ATTRIBUTE"},jt={message:"Missing courtId",code:"ERR_MISSING_COURT_ID"},$t={message:"Missing value",code:"ERR_MISSING_VALUE"},qt={message:"Missing birthdate",code:"ERR_MISSING_BIRTH_DATE"},Wt={message:"Missing date",code:"ERR_MISSING_DATE"},Ht={message:"No valid dates",code:"ERR_NO_VALID_DATES"},Yt={message:"Invalid bookings",code:"ERR_INVALID_BOOKINGS"},zt={message:"Invalid dateAvailability",code:"ERR_INVALID_DATE_AVAILABILITY"},Kt={message:"Missing dateAvailability",code:"ERR_MISSING_DATE_AVAILABILITY"},Jt={message:"Invalid Date",code:"ERR_INVALID_DATE"},Qt={message:"Invalid time",code:"ERR_INVALID_TIME"},Xt={message:"Invalid tournament dates",code:"ERR_INVALID_DATES_TOURNAMENT"},Zt={message:"Missing date range",info:"Event or tournament must have start and end dates",code:"ERR_MISSING_DATE_RANGE"},er={message:"Invalid game scores",code:"ERR_INVALID_SCORES_GAME"},tr={message:"Invalid score",code:"ERR_INVALID_SCORE"},rr={message:"Invalid winningSide",code:"ERR_INVALID_WINNING_SIDE"},ir={message:"No participants generated",code:"ERR_NO_PARTICIPANTS_GENERATED"},nr={message:"Cannot modify tieFormat",code:"ERR_UNCHANGED_CANNOT_MODIFY_TIEFORMAT"},ar={message:"Cannot modify participantType",code:"ERR_UNCHANGED_CANNOT_MODIFY_PARTICIPANT_TYPE"},or={message:"Cannot remove participants",code:"ERR_UNCHANGED_CANNOT_REMOVE_PARTICIPANTS"},sr={message:"Participant category mismatch",code:"ERR_CATEGORY_MISMATCH"},cr={message:"Cannot change winningSide",code:"ERR_UNCHANGED_CANNOT_CHANGE_WINNING_SIDE"},ur={message:"Invalid participant",code:"ERR_INVALID_PARTICIPANT"},dr={message:"Invalid participantId",code:"ERR_INVALID_PARTICIPANT_ID"},lr={message:"Invalid participantIds",code:"ERR_INVALID_PARTICIPANT_IDS"},pr={message:"Invalid participantRole",code:"ERR_INVALID_PARTICIPANT_ROLE"},mr={message:"Invalid participantType",code:"ERR_INVALID_PARTICIPANT_TYPE"},fr={message:"Missing participantRole",code:"ERR_MISSING_PARTICIPANT_ROLE"},hr={message:"Missing participant",code:"ERR_MISSING_PARTICIPANT"},gr={message:"Missing participants",code:"ERR_MISSING_PARTICIPANTS"},Ir={message:"Missing participantId",code:"ERR_MISSING_PARTICIPANT_ID"},Ur={message:"Missing qualified participants",code:"ERR_MISSING_QUALIFIED_PARTICIPANTS"},Sr={message:"Participant Not Found",code:"ERR_NOT_FOUND_PARTICIPANT"},vr={message:"participantId exists",code:"ERR_EXISTING_PARTICIPANT_ID"},yr={message:"No participant removed",code:"ERR_UNCHANGED_NO_PARTICIPANT_REMOVED"},wr={message:"Missing participantIds",code:"ERR_MISSING_PARTICIPANT_IDS"},Pr={message:"Missing participantsCount",code:"ERR_MISSING_PARTICIPANT_COUNT"},Tr={message:"Participant not checked in",code:"ERR_UNCHANGED_PARTICIPANT_NOT_CHECKED_IN"},Dr={message:"Missing person details",code:"ERR_MISSING_PERSON_DETAILS"},br={message:"Existing participant drawPosition assignment",code:"ERR_EXISTING_PARTICIPANT_DRAW_POSITION_ASSIGNMENT"},Mr={message:"Existing participant",code:"ERR_EXISTING_PARTICIPANT"},Rr={message:"participantsCount exceeds drawSize",code:"ERR_INVALID_PARTICIPANT_COUNT"},Nr={message:"Invalid entry status",code:"ERR_INVALID_ENTRY_STATUS"},Ar={message:"Participant Entry Not Found",code:"ERR_NOT_FOUND_PARTICIPANT_ENTRY"},Er={message:"Participant not entered in stage",code:"ERR_UNCHANGED_PARTICIPANT_NOT_ENTERED"},Cr={message:"Participant not found in stageSequence",code:"ERR_NOT_FOUND_PARTICIPANT_IN_STAGE"},Or={message:"entryStatus not allowed in stage",code:"ERR_INVALID_ENTRY_STATUS_IN_STAGE"},kr={message:"entryStatus not allowed for event",code:"ERR_INVALID_ENTRY_STATUS_IN_EVENT"},Fr={message:"No stage space available for entryStatus",code:"ERR_UNCHANGED_NO_AVAILABLE_STAGE_SPACE"},xr={message:"Insufficient drawPositions to accommodate qualifiers",code:"ERR_UNCHANGED_NO_DRAW_POSITIONS_FOR_QUALIFIERS"},_r={message:"Insufficient drawPositions to accommodate entries",code:"ERR_INSUFFICIENT_DRAW_POSITIONS"},Lr={message:"Missing penaltyType",code:"ERR_MISSING_PENALTY_TYPE"},Br={message:"Missing penaltyId",code:"ERR_MISSING_PENALTY_ID"},Vr={message:"Penalty not found",code:"ERR_NOT_FOUND_PENALTY"},Gr={message:"Missing courtsCount/courtNames",code:"ERR_MISSING_COURTS_INFO"},jr={message:"Court not found",code:"ERR_NOT_FOUND_COURT"},$r={message:"Court exists",code:"ERR_EXISTING_COURT"},qr={message:"Booking not found",code:"ERR_NOT_FOUND_BOOKING"},Wr={message:"Existing matchUps conflict with booking",code:"ERR_EXISTING_MATCHUPS"},Hr={message:"Venue exists",code:"ERR_EXISTING_VENUE"},Yr={message:"Venue not found",code:"ERR_NOT_FOUND_VENUE"},zr={message:"Missing venueId",code:"ERR_MISSING_VENUE_ID"},Kr={message:"Invalid endTime",code:"ERR_INVALID_END_TIME"},Jr={message:"Existing endTime",code:"ERR_EXISTING_END_TIME"},Qr={message:"Invalid stopTime",code:"ERR_INVALID_STOP_TIME"},Xr={message:"Invalid startTime",code:"ERR_INVALID_START_TIME"},Zr={message:"Invalid resumeTime",code:"ERR_INVALID_RESUME_TIME"},ei={message:"Invalid timeItem",code:"ERR_INVALID_TIME_ITEMS"},ti={message:"Missing async state provider",code:"ERR_MISSING_ASYNC_STATE_PROVIDER"},ri={message:"Missing timeItem",code:"ERR_MISSING_TIME_ITEM"},ii={message:"Missing timeItems",code:"ERR_MISSING_TIME_ITEMS"},ni={message:"Missing context",code:"ERR_MISSING_CONTEXT"},ai={message:"Missing schedule",code:"ERR_MISSING_SCHEDULE"},oi={message:"Invalid scaleItem",code:"ERR_INVALID_SCALE_ITEM"},si={message:"Modifications failed",code:"ERR_FAILURE_MODIFICATIONS"},ci={message:"No modifications applied",code:"ERR_UNCHANGED_NO_MODIFICATIONS_APPLIED"},ui={message:"Unable to assign court",code:"ERR_UNCHANGED_COURT_NOT_ASSIGNED"},di={message:"No Candidates",code:"ERR_UNCHANGED_NO_CANDIDATES"},li={message:"Invalid configuration",code:"ERR_INVALID_CONFIG"},pi={message:"Invalid collectionDefinition",code:"ERR_INVALID_COLLECTION_DEFINITION"},mi={message:"Invalid object",code:"ERR_INVALID_OBJECT"},fi={message:"Invalid gender",code:"ERR_INVALID_GENDER"},hi={message:"Invalid category",code:"ERR_INVALID_CATEGORY"},gi={message:"Invalid values",code:"ERR_INVALID_VALUES"},Ii={message:"Duplicate value",code:"ERR_DUPLICATE_VALUE"},Ui={message:"Team not found",code:"ERR_NOT_FOUND_TEAM"},Si={message:"No valid actions",code:"ERR_NO_VALID_ACTIONS"},vi={message:"No valid attributes",code:"ERR_NO_VALID_ATTRIBUTES"},yi={message:"Value unchanged",code:"ABORT_UNCHANGED"},wi={message:"Not found",code:"ERR_NOT_FOUND"},Pi={message:"Not implemented",code:"ERR_NOT_IMPLEMENTED"},Ti={message:"Existing flight",code:"ERR_EXISTING_FLIGHT"},Di={message:"Existing flight profile",code:"ERR_EXISTING_FLIGHT_PROFILE"},bi={message:"Existing outcome",code:"ERR_EXISTING_OUTCOME"},Mi={message:"Existing matchUpId",code:"ERR_EXISTING_MATCHUP_ID"},Ri={message:"Existing stage",code:"ERR_EXISTING_STAGE"},Ni={message:"Existing structure",code:"ERR_EXISTING_STRUCTURE"},Ai={message:"Method not found",code:"ERR_NOT_FOUND_METHOD"},Ei={message:"Scheduled matchUps",code:"ERR_SCHEDULED_MATCHUPS"},Ci={message:"Scores present",code:"ERR_SCORES_PRESENT"},Oi={ANACHRONISM:pe,BOOKING_NOT_FOUND:qr,CANNOT_CHANGE_WINNING_SIDE:cr,CANNOT_MODIFY_TIEFORMAT:nr,CANNOT_MODIFY_PARTICIPANT_TYPE:ar,CANNOT_REMOVE_MAIN_STRUCTURE:fe,CANNOT_REMOVE_PARTICIPANTS:or,CATEGORY_MISMATCH:sr,COURT_EXISTS:$r,COURT_NOT_FOUND:jr,EXISTING_MATCHUPS:Wr,DRAW_DEFINITION_NOT_FOUND:Pe,DRAW_ID_EXISTS:je,DRAW_POSITION_ACTIVE:Oe,DRAW_POSITION_ASSIGNED:Me,DRAW_POSITION_NOT_CLEARED:Ae,DRAW_POSITION_NOT_FOUND:{message:"drawPosition not found",code:"ERR_NOT_FOUND_DRAW_POSITION"},DRAW_SIZE_MISMATCH:Be,DUPLICATE_ENTRY:me,DUPLICATE_VALUE:Ii,ENTRY_STATUS_NOT_ALLOWED_FOR_EVENT:kr,ENTRY_STATUS_NOT_ALLOWED_IN_STAGE:Or,EVENT_EXISTS:ct,EVENT_NOT_FOUND:st,EXISTING_DRAW_DEFINITIONS:we,EXISTING_END_TIME:Jr,EXISTING_FLIGHT:Ti,EXISTING_MATCHUP_ID:Mi,EXISTING_OUTCOME:bi,EXISTING_PARTICIPANT_DRAW_POSITION_ASSIGNMENT:br,EXISTING_PARTICIPANT:Mr,EXISTING_POLICY_TYPE:Lt,EXISTING_PROFILE:Di,EXISTING_ROUND:Xe,EXISTING_STAGE:Ri,EXISTING_STRUCTURE:Ni,INCOMPATIBLE_MATCHUP_STATUS:St,INCOMPLETE_SOURCE_STRUCTURE:De,INSUFFICIENT_DRAW_POSITIONS:_r,INVALID_ACTION:He,INVALID_ASSIGNMENT:Ye,INVALID_BOOKINGS:Yt,INVALID_CATEGORY:hi,INVALID_COLLECTION_DEFINITION:pi,INVALID_CONFIGURATION:li,INVALID_DATE_AVAILABILITY:zt,INVALID_DATE:Jt,INVALID_DRAW_DEFINITION:ve,INVALID_DRAW_POSITION_FOR_SEEDING:be,INVALID_DRAW_POSITION:Fe,INVALID_DRAW_SIZE:Le,INVALID_END_TIME:Kr,INVALID_ENTRIES:dt,INVALID_EVENT_TYPE:at,INVALID_GAME_SCORES:er,INVALID_GENDER:fi,INVALID_MATCHUP_FORMAT:Pt,INVALID_MATCHUP_STATUS:yt,INVALID_MATCHUP_STATUS_BYE:gt,INVALID_MATCHUP:Ct,INVALID_OBJECT:mi,INVALID_PARTICIPANT_ID:dr,INVALID_PARTICIPANT_IDS:lr,INVALID_PARTICIPANT_ROLE:pr,INVALID_PARTICIPANT_SEEDING:$e,INVALID_PARTICIPANT_TYPE:mr,INVALID_PARTICIPANT:ur,INVALID_POLICY_DEFINITION:_t,INVALID_RECORDS:he,INVALID_SCALE_ITEM:oi,INVALID_SEED_NUMBER:Ke,INVALID_SEED_POSITION:Je,INVALID_SET_NUMBER:{message:"Invalid setNumber",code:"ERR_INVALID_SET_NUMBER"},INVALID_SIDE_NUMBER:Vt,INVALID_SCORE:tr,INVALID_STAGE:mt,INVALID_START_TIME:Xr,INVALID_STRUCTURE:Te,INVALID_STOP_TIME:Qr,INVALID_TIE_FORMAT:wt,INVALID_TIME:Qt,INVALID_TIME_ITEM:ei,INVALID_TOURNAMENT_DATES:Xt,INVALID_TOURNAMENT_RECORD:Ue,INVALID_VALUES:gi,INVALID_WINNING_SIDE:rr,MATCHUP_NOT_FOUND:Nt,METHOD_NOT_FOUND:Ai,MISSING_ASSIGNMENTS:lt,MISSING_ASYNC_STATE_PROVIDER:ti,MISSING_AVOIDANCE_POLICY:Ft,MISSING_BIRTH_DATE:qt,MISSING_COLLECTION_DEFINITION:Dt,MISSING_COURT_ID:jt,MISSING_COURTS_INFO:Gr,MISSING_DATE_AVAILABILITY:Kt,MISSING_DATE:Wt,MISSING_DRAW_DEFINITION:ye,MISSING_DRAW_ID:Ge,MISSING_DRAW_POSITION:xe,MISSING_DRAW_POSITIONS:Ce,MISSING_DRAW_SIZE:Ve,MISSING_ENTRIES:ut,MISSING_EVENT:ot,MISSING_QUALIFIED_PARTICIPANTS:Ur,MISSING_MATCHUP_FORMAT:Tt,MISSING_MATCHUP_ID:Mt,MISSING_MATCHUP_IDS:Rt,MISSING_MATCHUP:Et,MISSING_MATCHUPS:At,MISSING_PARTICIPANT_COUNT:Pr,MISSING_PARTICIPANT_ID:Ir,MISSING_PARTICIPANT_IDS:wr,MISSING_PARTICIPANT_ROLE:fr,MISSING_PARTICIPANT:hr,MISSING_PARTICIPANTS:gr,MISSING_PENALTY_ID:Br,MISSING_PENALTY_TYPE:Lr,MISSING_PERSON_DETAILS:Dr,MISSING_POLICY_ATTRIBUTES:xt,MISSING_POLICY_DEFINITION:kt,MISSING_POLICY_TYPE:Ot,MISSING_POSITION_ASSIGNMENTS:ht,MISSING_ROUND_NUMBER:{message:"Missing roundNumber",code:"ERR_MISSING_ROUND_NUMBER"},MISSING_SCHEDULE:ai,MISSING_SCORING_POLICY:{message:"Missing scoring policy / matchUpFormats",code:"ERR_MISSING_POLICY_SCORING_MATCHUP_FORMATS"},MISSING_SEED_ASSIGNMENTS:ze,MISSING_SEEDCOUNT_THRESHOLDS:We,MISSING_SEEDING_POLICY:{message:"Missing seeding policy",code:"ERR_MISSING_POLICY_SEEDING"},MISSING_SET_NUMBER:{message:"Missing setNumber",code:"ERR_MISSING_SET_NUMBER"},MISSING_SET_OBJECT:Gt,MISSING_SIDE_NUMBER:{message:"Missing sideNumber",code:"ERR_MISSING_SIDE_NUMBER"},MISSING_STAGE:pt,MISSING_STRUCTURE_ID:Ze,MISSING_STRUCTURE:rt,MISSING_MAIN_STRUCTURE:it,MISSING_STRUCTURES:tt,MISSING_TARGET_LINK:Qe,MISSING_TIE_FORMAT:bt,MISSING_TIME_ITEM:ri,MISSING_TIME_ITEMS:ii,MISSING_TOURNAMENT_ID:Se,MISSING_TOURNAMENT_RECORD:Ie,MISSING_TOURNAMENT_RECORDS:ge,MISSING_VALUE:$t,MISSING_VENUE_ID:zr,MODIFICATIONS_FAILED:si,NO_CANDIDATES:di,NO_DRAW_POSITIONS_AVAILABLE_FOR_QUALIFIERS:xr,NO_MODIFICATIONS_APPLIED:ci,NO_STAGE_SPACE_AVAILABLE_FOR_ENTRY_STATUS:Fr,NO_PARTICIPANT_REMOVED:yr,NO_VALID_ACTIONS:Si,NO_VALID_ATTRIBUTES:vi,NO_VALID_DATES:Ht,NOT_FOUND:wi,NOT_IMPLEMENTED:Pi,PARTICIPANT_COUNT_EXCEEDS_DRAW_SIZE:Rr,PARTICIPANT_ID_EXISTS:vr,PARTICIPANT_NOT_CHECKED_IN:Tr,PARTICIPANT_NOT_FOUND:Sr,PARTICIPANT_PAIR_EXISTS:{message:"participant pair exists",code:"ERR_EXISTING_PARTICIPANT_PAIR"},PENALTY_NOT_FOUND:Vr,POLICY_NOT_ATTACHED:{message:"Policy not attached",code:"ERR_FAILURE_POLICY_NOT_ATTACHED"},POLICY_NOT_FOUND:Bt,SCHEDULE_NOT_CLEARED:Re,SCHEDULE_CONFLICT_DOUBLE_BOOKING:Ne,SCHEDULED_MATCHUPS:Ei,SCORES_PRESENT:Ci,SEEDSCOUNT_GREATER_THAN_DRAW_SIZE:qe,STAGE_SEQUENCE_LIMIT:ft,STRUCTURE_NOT_FOUND:et,TEAM_NOT_FOUND:Ui,UNABLE_TO_ASSIGN_COURT:ui,UNLINKED_STRUCTURES:nt,UNRECOGNIZED_DRAW_TYPE:Ee,UNRECOGNIZED_MATCHUP_FORMAT:Ut,UNRECOGNIZED_MATCHUP_STATUS:It,VALUE_UNCHANGED:yi,VENUE_EXISTS:Hr},ki={disableNotifications:!1,tournamentId:void 0,tournamentRecords:{},subscriptions:{},modified:!1,methods:{},notices:[]},Fi={addNotice:function({topic:e,payload:t,key:r},i){if("string"==typeof e&&"object"==typeof t&&(ki.disableNotifications||(ki.modified=!0),!ki.disableNotifications&&(ki.subscriptions[e]||i)))return r&&(ki.notices=ki.notices.filter(t=>!(t.topic===e&&t.key===r))),ki.notices.push({topic:e,payload:t,key:r}),{...ce}},callListener:function({topic:e,notices:t},r){let i=ki.subscriptions[e];i&&"function"==typeof i&&i(t);let n=r?.[e];n&&"function"==typeof n&&n(t)},cycleMutationStatus:function(){let e=ki.modified;return ki.modified=!1,e},deleteNotice:function({topic:e,key:t}){ki.notices=ki.notices.filter(r=>(!e||r.topic===e)&&r.key!==t)},deleteNotices:function(){ki.notices=[]},disableNotifications:function(){ki.disableNotifications=!0},enableNotifications:function(){ki.disableNotifications=!1},getMethods:_i,getNotices:function({topic:e}){return ki.notices.filter(t=>t.topic===e).map(e=>e.payload)},getTopics:function(){return{topics:Object.keys(ki.subscriptions)}},getTournamentId:xi,getTournamentRecord:function(e){return ki.tournamentRecords[e]},getTournamentRecords:function(){return ki.tournamentRecords},removeTournamentRecord:function(e){if("string"!=typeof e)return{error:gi};if(!ki.tournamentRecords[e])return{error:wi};delete ki.tournamentRecords[e];let t=Object.keys(ki.tournamentRecords);return 1===t.length?ki.tournamentId=t[0]:t.length||(ki.tournamentId=void 0),{success:!0}},setMethods:function(e){return"object"!=typeof e?{error:gi}:(Object.keys(e).forEach(t=>{"function"==typeof e[t]&&(ki.methods[t]=e[t])}),{...ce})},setSubscriptions:function(e){return null===e.subscriptions||0===Object.keys(e.subscriptions).length?(ki.subscriptions={},{...ce}):"object"!=typeof e.subscriptions?{error:gi}:(Object.keys(e.subscriptions).forEach(t=>{"function"==typeof e.subscriptions[t]?ki.subscriptions[t]=e.subscriptions[t]:delete ki.subscriptions[t]}),{...ce})},setTournamentId:function(e){return e?ki.tournamentRecords[e]?(ki.tournamentId=e,{success:!0}):{error:Ie}:(ki.tournamentId=void 0,{success:!0})},setTournamentRecord:function(e){let t=e?.tournamentId;return t?(ki.tournamentRecords[t]=e,{success:!0}):{error:Ue}},setTournamentRecords:function(e){ki.tournamentRecords=e;let t=Object.keys(e);1===t.length?ki.tournamentId=t[0]:t.length||(ki.tournamentId=void 0)},handleCaughtError:function({engineName:e,methodName:t,params:r,err:i}){let n;return"string"==typeof i?n=i.toUpperCase():i instanceof Error&&(n=i.message),console.log("ERROR",{tournamentId:xi(),params:JSON.stringify(r),engine:e,methodName:t,error:n}),{error:n}}};function xi(){return ki.tournamentId}function _i(){return ki.methods??{}}var Li={timers:{default:{elapsedTime:0}},globalSubscriptions:{},deepCopyAttributes:{stringify:[],ignore:[],toJSON:[]},globalMethods:[],deepCopy:!0},Bi=Fi,Vi=["addNotice","callListener","cycleMutationStatus","deleteNotice","deleteNotices","disableNotifications","enableNotifications","getMethods","getNotices","getTopics","getTournamentId","getTournamentRecord","getTournamentRecords","removeTournamentRecord","setSubscriptions","setTournamentId","setTournamentRecord","setTournamentRecords"];function Gi(e){if("object"!=typeof e)throw new Error("Global state provider can not be undefined or null");if(Q(Object.keys(e),Vi).length!==Vi.length)throw new Error("Global state provider is missing required methods");return Bi=e,{success:!0}}function ji(){if(Bi.createInstanceState){try{Bi.createInstanceState()}catch(e){return{error:e}}return{success:!0}}return{error:ti}}function $i(e){return e&&"object"==typeof e?"object"==typeof Li.devContext&&(Object.keys(e).every(t=>Li.devContext?.[t]===e[t])&&Li.devContext):Li.devContext??!1}function qi(e="reset",t="default"){let r=Date.now();if("report"===e){if("allTimers"===t)return Object.keys(Li.timers).filter(e=>"default"!==e||Li.timers[e].startTime).map(e=>{let t=Li.timers[e],i="stopped"===t.state?0:(r-(t?.startTime??0))/1e3,n=t.elapsedTime+i;return{state:Li.timers[e].state,elapsedTime:n.toFixed(2),timer:e}});{let e="stopped"===Li.timers[t].state?0:(r-(Li.timers[t]?.startTime??0))/1e3,i=Li.timers[t].elapsedTime+e;return{state:Li.timers[t].state,elapsedTime:i.toFixed(2),timer:t}}}if(!Li.timers[t]||"reset"===e){if("allTimers"===t)return Li.timers={default:{elapsedTime:0}},!0;Li.timers[t]={startTime:r,state:"active",elapsedTime:0}}return Li.timers[t].elapsedTime||(Li.timers[t].elapsedTime=0),"stop"===e&&"stopped"!==Li.timers[t].state&&(Li.timers[t].state="stopped")&&(Li.timers[t].elapsedTime+=(r-(Li.timers[t]?.startTime??0))/1e3),"start"===e&&(Li.timers[t].startTime=r)&&(Li.timers[t].state="active"),Li.timers[t]}function Wi(e){U(e)?Li.globalLog=e:delete Li.globalLog}function Hi(e){Li.devContext=e}function Yi(){Bi.disableNotifications()}function zi(){Bi.enableNotifications()}function Ki(e,t){"boolean"==typeof e&&(Li.deepCopy=e),"object"==typeof t&&(Array.isArray(t.ignore)&&(Li.deepCopyAttributes.ignore=t.ignore),Array.isArray(t.toJSON)&&(Li.deepCopyAttributes.toJSON=t.toJSON),Array.isArray(t.stringify)&&(Li.deepCopyAttributes.stringify=t.stringify),t.threshold&&(Li.deepCopyAttributes.threshold=t.threshold))}function Ji(){return{enabled:Li.deepCopy,...Li.deepCopyAttributes}}function Qi(e){return e?.subscriptions?(Object.keys(e.subscriptions).forEach(t=>{Li.globalSubscriptions[t]=e.subscriptions[t]}),{...ce}):{error:$t,info:"missing subscriptions"}}function Xi(e){return e?.subscriptions?Bi.setSubscriptions({subscriptions:e.subscriptions}):{error:$t,info:"missing subscriptions"}}function Zi(e){return e?"object"!=typeof e?{error:gi}:(Object.keys(e).forEach(t=>{U(e[t])&&(Li.globalMethods[t]=e[t])}),{...ce}):{error:$t,info:"missing method declarations"}}function en(e){return e?"object"!=typeof e?{error:gi}:Bi.setMethods(e):{error:$t,info:"missing method declarations"}}function tn(){return Bi.cycleMutationStatus()}function rn(e){if("string"!=typeof e?.topic)return;let t=Li.globalSubscriptions[e.topic];return Bi.addNotice(e,t)}function nn(){return{...Li.globalMethods,...Bi.getMethods()}}function an(e){return Bi.getNotices(e)}function on({key:e,topic:t}){return Bi.deleteNotice({key:e,topic:t})}function sn(){return Bi.deleteNotices()}function cn(){return Bi.getTopics()}function un(e){return cn()?.topics?.includes(e)}async function dn(e){return Bi.callListener(e,Li.globalSubscriptions)}function ln(){return Bi.getTournamentId()}function pn(e){return Bi.getTournamentRecord(e)}function mn(){return Bi.getTournamentRecords()}function fn(e){return Bi.setTournamentRecord(e)}function hn(e){return Bi.setTournamentRecords(e)}function gn(e){return Bi.setTournamentId(e)}function In(e){return Bi.removeTournamentRecord(e)}function Un(){return Bi}function Sn({engineName:e,methodName:t,params:r,err:i}){let n=U(Bi.handleCaughtError)&&Bi.handleCaughtError||Fi.handleCaughtError,{tournamentRecord:a,...o}=r;return n({params:o,engineName:e,methodName:t,err:i})}function vn(e,t){if(Li.globalLog)try{Li.globalLog({log:e,engine:t})}catch(r){console.log("globalLog error",r),console.log(t,e),Wi()}else console.log(t,e)}function yn(e,t,r,i){if(!v(e))return{error:gi};E||(r=1);let n=Array.isArray(t)?t:[],a={},o=(e,i=0)=>{Object.keys(e).forEach(s=>{U(e[s])?a[s]=e[s]:v(e[s])&&(!0===t||n?.includes(s))&&(void 0===r||i<r)&&o(e[s],i+1)})};return o(e),i?Zi(a):en(a),{methods:a}}function wn(e,t,r,i){if("object"!=typeof e||null===e)return e;Ji()?.enabled||(i=!0);let n=["",void 0,null];t&&n.push(!1);let a=function(e,t,r){return Object.keys(e).filter(i=>!t.includes(e[i])&&(!r||!Array.isArray(e[i])||e[i].length))}(e,n,r);return Object.assign({},...a.map(t=>Array.isArray(e[t])?{[t]:i?e[t]:e[t].map(e=>wn(e))}:{[t]:i?e[t]:wn(e[t])}))}function Pn({context:e,result:t,stack:r,info:i}){return t&&!Array.isArray(t?.stack)&&(t.stack=[]),t&&Array.isArray(t?.stack)&&"string"==typeof r&&t.stack.push(r),t&&i&&(t.info=i),t&&"object"==typeof e&&Object.keys(e).length&&(t.context||(t.context={}),Object.assign(t.context,wn(e))),t&&!t?.error&&!t?.success&&Object.assign(t,{...ce}),t??{success:!0}}var Tn="FEMALE",Dn="OTHER",bn="MIXED",Mn="MALE",Rn={FEMALE_ABBR:"F",OTHER_ABBR:"O",MIXED_ABBR:"X",MALE_ABBR:"M",ANY_ABBR:"A",FEMALE:Tn,MIXED:bn,OTHER:Dn,MALE:Mn,ANY:"ANY"};function Nn(e){return[Tn,"F"].includes(e)}function An(e){return[Mn,"M"].includes(e)}function En(e){return[bn,"X"].includes(e)}function Cn(e){return["ANY","A"].includes(e)}function On(e){if(e){if(Nn(e))return Tn;if(En(e))return bn;if(An(e))return Mn;if(Cn(e))return"ANY"}return Dn}function kn(e){return Nn(e)||An(e)}function Fn(e){let t="tieFormatGenderValidityCheck",{referenceGender:r,matchUpType:i,gender:n}=e;return r&&n&&kn(r)&&On(r)!==On(n)?Pn({result:{valid:!1,error:fi},context:{gender:n},stack:t}):En(r)&&(Cn(n)||En(n)&&i!==l)?Pn({result:{error:fi,valid:!1},info:"MIXED events can not contain mixed singles or { gender: ANY } collections",stack:t}):Cn(r)&&En(n)&&i!==l?Pn({result:{error:fi,valid:!1},info:"events with { gender: ANY } can not contain MIXED singles collections",stack:t}):{valid:!0}}var xn="timed",_n="NOAD",Ln=["SET","HAL","QTR","PER","INN","RND","FRM","MAP","MAT"],Bn="CONSECUTIVE",Vn="TRADITIONAL",Gn={S:"normal",F:"final",G:"game"};function jn(e,t){if(v(e)&&(e?.bestOf||e?.exactly)&&e?.setFormat)return function(e,t){let r=$n(e.bestOf)||void 0,i=$n(e.exactly)||void 0,n=r||i;if(e.setFormat?.timed&&e.simplified&&1===n)return qn(e.setFormat);let a=e.matchRoot||"SET",o=i&&1!==i?"X":"",s=e.aggregate?"A":"",c=n&&`${a}${n}${o}${s}`||"",u=Wn(e.setFormat,t),d=u&&`S:${u}`||"",l=Wn(e.finalSetFormat,t),p=n&&n>1&&l&&u!==l&&`F:${l}`||"",m=e.gameFormat?`G:${function(e){let t=e?.deuceAfter?`${e.deuceAfter}D`:"";if(e?.type===Vn)return`TN${t}`;if(e?.type===Bn&&Number.isInteger(e.count))return`${e.count}C${t}`}(e.gameFormat)}`:"";if(c&&u)return[c,d,m,p].filter(Boolean).join("-")}(e,t)}function $n(e){return!Number.isNaN(Number(e))&&Number(e)}function qn(e){let t=`T${e.minutes}`;return"P"===e.based&&(t+="P"),e.tiebreakFormat?.tiebreakTo&&(t+=`/TB${e.tiebreakFormat.tiebreakTo}`),e.modifier&&(t+=`@${e.modifier}`),t}function Wn(e,t){if("object"==typeof e&&Object.keys(e).length){if(e.timed)return qn(e);if(e.tiebreakSet)return Hn(e.tiebreakSet);let r=$n(e.setTo);if(r){let i=e.NoAD&&_n||"",n=Hn(e.tiebreakFormat),a=n&&`/${n}`||"",o=$n(e.tiebreakAt);if(!1!==n)return`${r}${i}${a}${o&&(o!==r||t)&&`@${o}`||""}`}}}function Hn(e){if(e){if("object"==typeof e&&!e.tiebreakTo)return"";if("object"==typeof e&&$n(e.tiebreakTo)){let t=`TB${e.tiebreakTo}${e.NoAD?_n:""}`;return e.modifier&&(t+=`@${e.modifier}`),t}return!1}}function Yn(e){if(S(e)){let t=e.startsWith("T")&&xn||Ln.some(t=>e.startsWith(t))&&"SET"||"";if(t===xn){let t=Xn(e);if(t)return{simplified:!0,setFormat:t,bestOf:1}}if("SET"===t)return function(e){let t=e.split("-"),r=function(e){let t=Ln.find(t=>e.startsWith(t));if(!t)return;let r=e.slice(t.length),i=/^(\d+)([A-Z]*)$/.exec(r);if(!i)return;let n=ea(i[1]);if(!n)return;let a=i[2],o=!1,s=!1,c=[];for(let u of a)"X"===u?o=!0:"A"===u?s=!0:c.push(u);return{matchRoot:t,count:n,exactly:o,aggregate:s,matchMods:c}}(t[0]);if(!r)return;let i,n,a,{matchRoot:o,count:s,exactly:c,aggregate:u,matchMods:d}=r,l=c&&1!==s?void 0:s,p=c&&1!==s?s:void 0,m=0,f=0,h=0;for(let U=1;U<t.length;U++){let e=t[U].indexOf(":");if(e<0)return;let r=t[U].slice(0,e),o=t[U].slice(e+1);if(!(r in Gn))return;if("S"===r){if(m++,m>1)return;i=Kn(t[U],o)}else if("F"===r){if(f++,f>1)return;n=Kn(t[U],o)}else if("G"===r&&(h++,h>1||(a=zn(o),!a)))return}let g=i&&i.timed||n&&n.timed;if("SET"===o&&!(l&&l<6||g&&p)||!i||n&&!n)return;let I=wn({setFormat:i,exactly:p,bestOf:l});return"SET"!==o&&(I.matchRoot=o),u&&(I.aggregate=!0),d.length>0&&(I.matchMods=d),n&&(I.finalSetFormat=n),a&&(I.gameFormat=a),I}(e)}}function zn(e){let t=/^(.+?)(\d+D)$/.exec(e),r=t?t[1]:e,i=t?Number(t[2].slice(0,-1)):void 0;if(void 0!==i&&(i<1||!Number.isInteger(i)))return;if("TN"===r){let e={type:Vn};return i&&(e.deuceAfter=i),e}let n=/^([1-9]\d*)C$/.exec(r);if(n){let e={type:Bn,count:Number(n[1])};return i&&(e.deuceAfter=i),e}}function Kn(e,t){return t.startsWith("TB")?function(e){let t=Qn(e);return!1!==t&&("object"==typeof t?{tiebreakSet:t}:void 0)}(t):t.startsWith("T")?Xn(t):function(e,t){let r=/^[FS]:(\d+)([A-Za-z]*)/.exec(e),i=r&&Zn(r[2])||!1,n=!r?.[2]||i,a=r?ea(r[1]):void 0,o=Jn(t),s=!1!==o,c=s&&o||a,u=Qn(t.split("/")[1]);return!!(a&&n&&!1!==u&&s)&&function(e,t,r,i){let n={setTo:e};return t&&(n.NoAD=!0),r?(n.tiebreakFormat=r,n.tiebreakAt=i):n.noTiebreak=!0,n}(a,i,u,c)}(e,t)}function Jn(e,t=!0){let r=e?.indexOf("@")>0&&e.split("@");if(r)return(t?ea(r[1]):r[1])||!1}function Qn(e){if(e)return!!e.startsWith("TB")&&function(e){let t=Jn(e,!1),r=/^TB(\d+)([A-Za-z]*)/.exec(e),i=r?.[1],n=r&&Zn(r[2]),a=!r?.[2]||n,o=ea(i);if(!o||!a)return!1;let s={tiebreakTo:o};return t&&"string"==typeof t&&!F(t)&&(s.modifier=t),n&&(s.NoAD=!0),s}(e)}function Xn(e){let t=e.slice(1),r=/^(\d+)([PG])?(?:\/TB(\d+))?(@[A-Za-z]+)?$/.exec(t),i=ea(r?.[1]);if(!i)return;let n={timed:!0,minutes:i},a=r?.[2];"P"===a?n.based="P":"G"===a&&(n.based="G");let o=r?.[3];if(o){let e=ea(o);e&&(n.tiebreakFormat={tiebreakTo:e})}let s=r?.[4],c=[void 0,"P","G",""].includes(s);if(s&&!c){let e=/^(\d+)([PGA])?(?:\/TB\d+)?(@)([A-Za-z]+)$/.exec(t)?.[4];return e?(n.modifier=e,n):void 0}return s&&(n.based=s),n}function Zn(e){return e?.includes(_n)}function ea(e){let t=Number(e);return Number.isNaN(t)?0:t}function ta({matchUpFormat:e}){if(!S(e)||""===e)return!1;let t=Yn(e),r=/-S:(\d+)\/TB(\d{1,2})@?(\d?)/.exec(e),i=r?.[1],n=r?.[2],a=r?.[3],o=/-F:(\d+)\/TB(\d{1,2})@?(\d?)/.exec(e),s=o?.[1],c=o?.[2],u=o?.[3];return jn(t,!!(r&&n&&i===a||o&&c&&s===u))===function(e){return e.replaceAll(/T(\d+)G(?=\/TB|@|-|$)/g,"T$1")}(e)}var ra=/^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2]\d|3[0-1])$/,ia=/^((0\d|1\d|2[0-3]):[0-5]\d(:[0-5]\d)?)([.,]\d{3})?$/,na=/^(\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2]\d|3[0-1]))([ T](0\d|1\d|2[0-3]):[0-5]\d(:[0-5]\d)?)?([.,]\d{3})?Z?$/,aa=/^(\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2]\d|3[0-1]))?([ T]?(0\d|1\d|2[0-3]):[0-5]\d(:[0-5]\d)?)?([.,]\d{3})?Z?$/;function oa(e){let{scheduledDate:t}=e;if(!t&&e.scheduledTime&&(t=ya(e.scheduledTime)),!t)return;let r=va(e.scheduledTime),i=ya(t);return i&&r&&(i+=`T${r}`),i}function sa(e){return"object"==typeof e&&!Array.isArray(e)&&"[object Date]"===Object.prototype.toString.call(e)}function ca(e){let t="string"==typeof e?e?.split(" "):[];if(e&&t?.length>1&&!["AM","PM"].includes(t[1].toUpperCase()))return!1;let r=Ta(e,!0,!0);return!!(!e||r&&aa.test(r))}function ua(e){return ga(e)||ra.test(e)}var da=e=>{let t=ma(e)||ga(e)?new Date(e):new Date,r=t.getUTCMonth()+1,i=r<10?`0${r}`:`${r}`;return`${t.getUTCFullYear()}-${Ea(i)}-${Ea(t.getUTCDate())}`};function la(e,t="-",r="YMD"){if(!e)return"";"string"==typeof e&&!e.includes("T")&&(e+="T00:00");let i=new Date(e),n=""+(i.getMonth()+1),a=""+i.getDate(),o=i.getFullYear();return n.length<2&&(n="0"+n),a.length<2&&(a="0"+a),"DMY"===r?[a,n,o].join(t):"MDY"===r?[n,a,o].join(t):"YDM"===r?[o,a,n].join(t):"DYM"===r?[a,o,n].join(t):"MYD"===r?[n,o,a].join(t):[o,n,a].join(t)}function pa(e){let t=e?new Date(e):new Date,r=t.getTimezoneOffset();return new Date(t.getTime()-60*r*1e3)}function ma(e){if("boolean"==typeof e)return!1;let t=e instanceof Date&&e||!Number.isNaN(Number(e))&&new Date(e)||!1;return t&&!Number.isNaN(Number(t.valueOf()))}function fa(e,t){if(!ua(e)||!ua(t))return[];let r=ya(e)+"T00:00",i=ya(t)+"T00:00",n=new Date(r),a=new Date(i),o=ma(a)&&ma(n)&&function(e,t){return e<=t}(n,a),s=[],c=0;if(o){let e=n,t=e.getTime();for(;t<=a.getTime()&&c<300;)c+=1,s.push(new Date(e)),t=e.setDate(e.getDate()+1)}return s.map(e=>la(e))}var ha=/^([+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24:?00)([.,]\d+(?!:))?)?(\17[0-5]\d([.,]\d+)?)?([zZ]|([+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/;function ga(e){return"string"==typeof e&&ha.test(e)}function Ia(e){if("string"!=typeof e)return!1;let t=e.split("Z")[0].split(":"),r=t.every(e=>!Number.isNaN(Number.parseInt(e)));return!(t.length<2||!r||Number.parseInt(t[0])>23||Number.parseInt(t[1])>60)}function Ua(e){let t=va(e);if(!t)return 0;let[r,i]=t.split(":").map(e=>Number.parseInt(e));return 60*r+i}function Sa(e){return Ia(e)?e.split(":").slice(0,2).map(Ea).join(":"):void 0}function va(e){return ga(e)&&e.indexOf("T")>0?Sa(e.split("T").reverse()[0]):Sa(e)}function ya(e){return ga(e)||na.test(e)?e.split("T")[0]:""}function wa(e,t){let r=new Date(e);return r.setDate(r.getDate()+t),ya(r.toISOString())}function Pa(e){e="string"==typeof e?e:"00:00";let t={},r={};return({0:t.time,1:t.ampm}=e.split(" ")||[]),({0:r.hours,1:r.minutes}=t.time.split(":")||[]),r.ampm=t.ampm,Number.isNaN(Number.parseInt(r.hours))||Number.isNaN(Number.parseInt(r.minutes))||r.ampm&&!["AM","PM"].includes(r.ampm.toUpperCase())?{}:r}function Ta(e,t,r){let i=ya(e),n=va(e),a=i?n:e;return e?t&&(i&&r&&e||function(e){let t=Pa(e);return t.ampm&&t.hours&&("pm"===t.ampm.toLowerCase()&&Number.parseInt(t.hours)<12&&(t.hours=(t.hours&&Number.parseInt(t.hours)||0)+12),"am"===t.ampm.toLowerCase()&&"12"===t.hours&&(t.hours="00")),`${t.hours||"12"}:${t.minutes||"00"}`.split(":").map(Ea).join(":")}(a))||function(e){let t=Pa(e);if("object"!=typeof t||Object.keys(t).length)return t.ampm?e:(t.hours>12?(t.hours-=12,t.ampm="PM"):"12"===t.hours?t.ampm="PM":("00"===t.hours&&(t.hours="12"),t.ampm="AM"),"0"===t.hours?.[0]&&(t.hours=t.hours.slice(1)),`${t.hours||"12"}:${t.minutes||"00"} ${t.ampm}`)}(a):void 0}function Da(e,t){let r=Pa(e),i=Pa(t);if(Number.parseInt(r.hours)<Number.parseInt(i.hours))return-1;if(Number.parseInt(r.hours)>Number.parseInt(i.hours))return 1;if(r.hours===i.hours){if(Number.parseInt(r.minutes)<Number.parseInt(i.minutes))return-1;if(Number.parseInt(r.minutes)>Number.parseInt(i.minutes))return 1}return 0}function ba(e,t=7){let r=ya(e)+"T00:00",i=new Date(r);return la(new Date(i.setDate(i.getDate()+t)))}function Ma(e,t=void 0){let[r,i]=(e||"00:00").split(":").map(Ea),n=pa(t).setHours(r,i,0,0);return pa(n)}function Ra(e,t,r=!0){let i=new Date(e),n=(new Date(t).getTime()-i.getTime())/1e3/60;return r?Math.abs(Math.round(n)):Math.round(n)}function Na(e,t){let r=va(e);if(!r)return"00:00";let i=Number.isNaN(t)?0:t;return va(Aa(Ma(r),i).toISOString())||"00:00"}function Aa(e,t){let r=new Date(e);return new Date(r.getTime()+6e4*t)}function Ea(e){return e.toString()[1]?e:"0"+e}function Ca(e,t){let r=new Date(e),i=new Date(t);return r.getFullYear()===i.getFullYear()&&r.getMonth()===i.getMonth()&&r.getDate()===i.getDate()}var Oa={addDays:ba,addWeek:function(e){return ba(e)},addMinutesToTimeString:Na,convertTime:Ta,getIsoDateString:oa,getUTCdateString:da,DateHHMM:function(e){let t=new Date(e);return function(e,t){let r=Number.parseInt(e,10),i=Math.floor(r/3600),n=Math.floor((r-3600*i)/60),a=r-3600*i-60*n;return(!t||t?.displaySeconds?i+":"+n+":"+a:i+":"+n).split(":").map(Ea).join(":")}(t.getSeconds()+60*t.getMinutes()+3600*t.getHours(),{displaySeconds:!1})},extractDate:ya,extractTime:va,formatDate:la,getDateByWeek:function(e,t,r,i=!1){let n=new Date(t,0,1+7*(e-1)),a=i?0:1;return n.setDate(n.getDate()+(a-n.getDay())),la(n,r)},isISODateString:ga,isDate:ma,isTimeString:Ia,offsetDate:pa,offsetTime:function(e){return pa(e).getTime()},sameDay:Ca,timeStringMinutes:Ua,timeToDate:Ma,timeUTC:function(e){let t=ma(e)||ga(e)?new Date(e):new Date;return Date.UTC(t.getFullYear(),t.getMonth(),t.getDate())},validTimeValue:ca,validDateString:ra,timeValidation:aa,dateValidation:na};function ka(e,t){return`${e}-${t}`}function Fa(e){let t=e.category;if("object"!=typeof t||!t)return{error:hi};let r,{ageCategoryCode:i,ageMaxDate:n,ageMinDate:a,ageMax:o,ageMin:s}=t,c=t.categoryName;if(!(((e,t)=>e.filter(Boolean).every(e=>typeof e===t))([i,n,a,c],"string")&&(e=>e.filter(Boolean).every(E))([o,s])&&[n,a].filter(Boolean).every(ua)))return{error:hi};let u=e.consideredDate??ya((new Date).toLocaleDateString("sv"));if(!u||!ua(u))return{error:Jt};let[d]=u.split("-").slice(0,3).map(e=>Number.parseInt(e)),l=wa(u,-1);if(!l)return{error:Jt};let[p,m]=l.split("-").slice(1,3).map(e=>Number.parseInt(e)),f=`${Ea(p)}-${Ea(m)}`,h=wa(u,1);if(!h)return{error:Jt};let[g,I]=h.split("-").slice(1,3).map(e=>Number.parseInt(e)),U=`${Ea(g)}-${Ea(I)}`,S=s&&wa(u,-365*s),v=o&&wa(u,-365*o),y=[],w=e=>!y.includes(e)&&y.push(e);i=i??c;let P=/^([UO]?)(\d{1,2})([UO]?)$/,T=/^C(\d{1,2})-(\d{1,2})$/,D=i?.includes("-"),b=D&&i?.match(T),M=i?.match(P);function R(e){let r=ka(d-e-1,U);t.ageMin&&t.ageMin>e&&w(`Invalid submitted ageMin: ${s}`),t.ageMax&&t.ageMax>e&&w(`Invalid submitted ageMax: ${o}`),t.ageMinDate&&t.ageMinDate!==r&&w(`Invalid submitted ageMinDate: ${a}`),a=r,i&&(t.ageMax&&t.ageMax!==e&&(w(`Invalid submitted ageMax: ${o}`),S=void 0),o=e)}function N(e){let r=ka(d-e,f);t.ageMaxDate&&t.ageMaxDate!==r&&w(`Invalid submitted ageMaxDate: ${n}`),n=r,i&&(t.ageMin&&t.ageMin!==e+1&&(w(`Invalid submitted ageMin: ${s}`),S=void 0),s=e+1)}function A(e){let r=P.exec(e)||[],[c,u,l]=r.slice(1),p=Number.parseInt(u);"U"===c?(t.ageMaxDate&&t.ageMaxDate!==n&&w(`Invalid submitted ageMaxDate: ${t.ageMaxDate}`),function(e){let r=ka(d-e,U);t.ageMinDate&&t.ageMinDate!==r&&w(`Invalid submitted ageMinDate: ${a}`),a=r,i&&(t.ageMax&&t.ageMax!==e-1&&(w(`Invalid submitted ageMax: ${o}`),v=void 0),o=e-1)}(p)):"O"===c&&N(p),"U"===l?(t.ageMaxDate&&t.ageMaxDate!==n&&w(`Invalid submitted ageMaxDate: ${t.ageMaxDate}`),R(p)):"O"===l&&function(e){let r=ka(d-e-1,f);t.ageMaxDate&&t.ageMaxDate!==r&&w(`Invalid submitted ageMaxDate: ${n}`),n=r,i&&(t.ageMin&&t.ageMin!==e&&(w(`Invalid submitted ageMin: ${s}`),S=void 0),s=e)}(p),n=(n??S)||void 0,a=(a??v)||void 0}b?function(){if(n=void 0,a=void 0,o=void 0,s=void 0,t.ageMin){let e=d-t.ageMin;n=ka(e,f)}if(t.ageMax){let e=d-t.ageMax-1;a=ka(e,U)}let[e,c]=(i?.match(T)??[]).slice(1).map(e=>Number.parseInt(e));e<=c?(s=e,o=c,r=!0):w(`Invalid combined age range ${i}`)}():D?i?.split("-").forEach(A):M&&i?A(i):(s&&N(s),o&&R(o)),o&&t?.ageMin&&t?.ageMin>o&&(w(`Invalid submitted ageMin: ${t?.ageMin}`),s=void 0);let C=wn({consideredDate:u,combinedAge:r,ageMaxDate:n,ageMinDate:a,ageMax:o,ageMin:s});return y.length&&(C.errors=y),C}function xa({category:e}){if(!v(e))return{error:gi};let t=Fa({category:e});if(t.error)return{error:t};let{ratingMax:r,ratingMin:i}=e;return r&&!E(r)?Pn({result:{error:gi},context:{ratingMax:r}}):i&&!E(i)?Pn({result:{error:gi},context:{ratingMin:i}}):{...t}}function _a({childCategory:e,withDetails:t,category:r}){let i=xa({category:r}),n=xa({category:e}),a=n.ageMin&&(i.ageMin&&n.ageMin<i.ageMin||i.ageMax&&n.ageMin>i.ageMax),o=n.ageMax&&(i.ageMax&&n.ageMax>i.ageMax||i.ageMin&&n.ageMax<i.ageMin),s=n.ageMinDate&&i.ageMaxDate&&new Date(n.ageMinDate)>new Date(i.ageMaxDate),c=n.ageMaxDate&&i.ageMinDate&&new Date(n.ageMaxDate)<new Date(i.ageMinDate),u=r?.ratingType&&e?.ratingType&&r.ratingType===e.ratingType&&(r.ratingMin&&e.ratingMin&&e.ratingMin<r.ratingMin||r.ratingMax&&e.ratingMax&&e.ratingMax>r.ratingMax||r.ratingMin&&e.ratingMax&&e.ratingMax<r.ratingMin||r.ratingMax&&e.ratingMin&&e.ratingMin>r.ratingMax),d=r?.ballType&&e?.ballType&&r.ballType!==e.ballType,l=wn({invalidRatingRange:u,invalidAgeMinDate:s,invalidAgeMaxDate:c,invalidBallType:d,invalidAgeMax:o,invalidAgeMin:a,valid:!(u||s||c||d||o||a)},!0);return t&&Object.assign(l,{categoryDetails:i,childCategoryDetails:n}),l}function La({checkCategory:e=!0,collectionDefinition:t,checkCollectionIds:r,checkGender:i=!0,referenceCategory:n,referenceGender:a,event:o}){a=a??o?.gender;let s="validateCollectionDefinition",c=[];if("object"!=typeof t)return c.push(`collectionDefinition must be an object: ${t}`),Pn({result:{errors:c,error:mi},stack:s});let{collectionValueProfiles:d,collectionGroupNumber:p,collectionValue:m,collectionId:f,matchUpCount:h,matchUpFormat:g,matchUpValue:I,matchUpType:U,scoreValue:S,setValue:v,category:y,gender:w}=t;if(r&&"string"!=typeof f&&c.push(`collectionId is not type string: ${f}`),"number"!=typeof h&&c.push(`matchUpCount is not type number: ${h}`),U&&!se([u,l],U)&&c.push(`matchUpType must be SINGLES or DOUBLES: ${U}`),1!==[!!d?.length].concat([I,m,S,v].map(F)).filter(Boolean).length&&c.push("Missing value definition for matchUps: matchUpValue, collectionValue, or collectionValueProfiles"),I&&"number"!=typeof I&&c.push(`matchUpValue is not type number: ${I}`),m&&"number"!=typeof m&&c.push(`collectionValue is not type number: ${m}`),d&&h){let e=le({collectionValueProfiles:d,matchUpCount:h});e.errors&&c.push(...e.errors)}if(p&&"number"!=typeof p&&c.push(`collectionGroupNumber is not type number: ${m}`),g&&!ta({matchUpFormat:g})&&c.push(`Invalid matchUpFormat: ${g}`),i){let e=Fn({referenceGender:a,matchUpType:U,gender:w});if(e.error)return Pn({context:{referenceGender:a,gender:w},result:e,stack:s})}if(e&&n&&y){let e=_a({category:n,childCategory:y});if(!e.valid)return Pn({result:{error:hi},context:e,stack:s})}return c.length?Pn({result:{errors:c,error:pi},stack:s}):{valid:!0}}function Ba(e){let t=!(!1===e?.enforceCategory||!e?.category),r=!(!1===e?.enforceGender||!e?.gender),i=e?.checkCollectionIds,n=e?.tieFormat,a=e?.event,o="validateTieFormat",s=[],c=function(e){let{tieFormat:t,stack:r}=e;return e&&t&&v(t)?v(t.winCriteria)?Array.isArray(t.collectionDefinitions)?{...ce}:Pn({result:{error:wt},context:{tieFormat:t,message:"collectionDefinitions must be an array"},stack:r}):Pn({result:{error:wt},context:{tieFormat:t,message:"tieformat.winCritiera must be an object"},stack:r}):Pn({result:{error:wt},context:{tieFormat:t,message:"tieformat must be an object"},stack:r})}({...e,stack:o});if(c?.error)return c;let u,d=n.collectionDefinitions.every(n=>{let{setValue:o,scoreValue:c,collectionValue:d}=n;(o||c)&&!d&&(u=!0);let{valid:l,errors:p}=La({referenceCategory:e.category,referenceGender:e.gender,collectionDefinition:n,checkCollectionIds:i,checkCategory:t,checkGender:r,event:a});return!!l||(Array.isArray(p)&&s.push(...p),!1)}),l="number"==typeof n.winCriteria?.valueGoal&&n.winCriteria?.valueGoal>0&&!u||n.winCriteria?.aggregateValue;if(!l&&!n.winCriteria?.aggregateValue)return u?s.push("aggregateValue is required"):s.push("Either non-zero valueGoal, or { aggregateValue: true } must be specified in winCriteria"),Pn({context:{tieFormat:n,errors:s,aggregateValueImperative:u},result:{error:wt},stack:o});let p=n.collectionDefinitions.map(({collectionId:e})=>e),m=!i||p.length===L(p).length,f=d&&l&&m;return f?{valid:f,errors:s}:Pn({result:{error:wt},context:{tieFormat:n,errors:s},stack:o})}var Va="resourceSubType",Ga="resourceType",ja="identifier",$a="name",qa={RESOURCE_SUB_TYPE:Va,RESOURCE_TYPE:Ga,IDENTIFIER:ja,NAME:$a};function Wa(e,t,r,i,n=0){if(Un().makeDeepCopy)return Un().makeDeepCopy(e,t,r,i);let a=Ji(),{stringify:o,toJSON:s,ignore:c,modulate:u}=a||{};if(!a?.enabled&&!r||"object"!=typeof e||U(e)||null===e||"number"==typeof a?.threshold&&n>=a.threshold)return e;let d=Array.isArray(e)?[]:{},l=Object.keys(e).filter(e=>!r||!c||Array.isArray(c)&&!c.includes(e)||U(c)&&!c(e)),p=(e,t)=>{d[e]=U(t?.toString)?t.toString():JSON.stringify(t)};for(let m of l){let a=e[m],c=U(u)?u(a):void 0;if(void 0!==c)d[m]=c;else if(t&&"extensions"===m&&Array.isArray(a)){let e=Ha(a);Object.assign(d,...e)}else i&&"extensions"===m?d[m]=[]:Array.isArray(o)&&o.includes(m)?p(m,a):Array.isArray(s)&&s.includes(m)&&U(a?.toJSON)?d[m]=a.toJSON():null===a?d[m]=void 0:sa(a)?d[m]=new Date(a).toISOString():d[m]=Wa(a,t,r,i,n+1)}return d}function Ha(e){return e?.map(e=>{let{name:t,value:r}=e;return t&&r&&{[`_${t}`]:r}}).filter(Boolean)}function Ya(e=1,t){return K(0,e).map(()=>za(t))}function za(e){let t=[];for(let s=0;s<256;s++)t[s]=(s<16?"0":"")+s.toString(16);let r=Math.trunc(4294967295*Math.random()),i=Math.trunc(4294967295*Math.random()),n=Math.trunc(4294967295*Math.random()),a=Math.trunc(4294967295*Math.random()),o=t[255&r]+t[r>>8&255]+t[r>>16&255]+t[r>>24&255]+"-"+t[255&i]+t[i>>8&255]+"-"+t[i>>16&15|64]+t[i>>24&255]+"-"+t[63&n|128]+t[n>>8&255]+"-"+t[n>>16&255]+t[n>>24&255]+t[255&a]+t[a>>8&255]+t[a>>16&255]+t[a>>24&255];return"string"==typeof e?`${e}_${o.replaceAll("-","")}`:o}var Ka={collectionDefinitions:[{collectionName:"Male Singles",matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpCount:4,matchUpValue:1,gender:"MALE"},{collectionName:"Female Singles",matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",gender:"FEMALE",matchUpCount:4,matchUpValue:1},{collectionName:"Male Doubles",matchUpFormat:"SET1-S:8/TB7@7",matchUpType:"DOUBLES",matchUpCount:2,matchUpValue:1,gender:"MALE"},{collectionName:"Female Doubles",matchUpFormat:"SET1-S:8/TB7@7",matchUpType:"DOUBLES",gender:"FEMALE",matchUpCount:2,matchUpValue:1},{collectionName:"Mixed Doubles",matchUpFormat:"SET1-S:8/TB7@7",matchUpType:"DOUBLES",matchUpCount:4,matchUpValue:1,gender:"MIXED"}],tieFormatName:"USTA_GOLD_TEAM_CHALLENGE",winCriteria:{valueGoal:9}},Ja={collectionDefinitions:[{collectionName:"Round 1",matchUpCount:3,matchUpFormat:"SET1-S:T20",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Round 2",matchUpCount:3,matchUpFormat:"SET1-S:T20",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Round 3",matchUpCount:3,matchUpFormat:"SET1-S:T20",matchUpType:"DOUBLES",scoreValue:1}],tieFormatName:"Doubles Shuffle",unrestrictedSelections:!0,winCriteria:{aggregateValue:!0}},Qa={collectionDefinitions:[{collectionName:"Male Singles",gender:"MALE",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Female Singles",gender:"FEMALE",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Mixed Doubles",gender:"MIXED",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1}],tieFormatName:"USTA_SOUTHERN_LEVEL_5",winCriteria:{valueGoal:8}},Xa={collectionDefinitions:[{category:{ageCategoryCode:"16U"},collectionName:"16U Singles",matchUpCount:4,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1},{category:{ageCategoryCode:"18U"},collectionName:"18U Singles",matchUpCount:4,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1},{category:{ageCategoryCode:"16U"},collectionName:"16U Doubles",matchUpCount:2,matchUpFormat:"SET1-S:6/TB7",matchUpType:"DOUBLES",matchUpValue:1},{category:{ageCategoryCode:"18U"},collectionName:"18U Doubles",matchUpCount:2,matchUpFormat:"SET1-S:6/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Tiebreak Doubles",matchUpCount:1,matchUpFormat:"SET1-S:TB10",matchUpType:"DOUBLES",matchUpValue:1,processCodes:["RANKING.IGNORE"]}],tieFormatName:"USTA_SECTION_BATTLE",winCriteria:{valueGoal:9}},Za={collectionDefinitions:[{collectionName:"Male Singles",gender:"MALE",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Female Singles",gender:"FEMALE",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Male Doubles",gender:"MALE",matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Female Doubles",gender:"FEMALE",matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Mixed Doubles",gender:"MIXED",matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1}],tieFormatName:"USTA_INTERSECTIONAL",winCriteria:{valueGoal:8}},eo={collectionDefinitions:[{scoreValue:1,matchUpType:"SINGLES",collectionName:"Men's Singles",matchUpFormat:"SET1-S:T60",gender:"MALE",matchUpCount:1},{scoreValue:1,matchUpType:"SINGLES",collectionName:"Women's Singles",matchUpFormat:"SET1-S:T60",gender:"FEMALE",matchUpCount:1},{matchUpValue:1,matchUpType:"DOUBLES",collectionName:"Mixed Doubles",matchUpFormat:"SET1-S:T60",gender:"MIXED",matchUpCount:1}],tieFormatName:"Time Tennis Pro Circuit",winCriteria:{aggregateValue:!0}},to={collectionDefinitions:[{collectionName:"Mixed Doubles",gender:"MIXED",matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Male Singles",matchUpCount:1,gender:"MALE",matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Female Singles",gender:"FEMALE",matchUpCount:1,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1}],tieFormatName:"DOMINANT_DUO_MIXED",winCriteria:{valueGoal:2}},ro={collectionDefinitions:[{scoreValue:1,matchUpType:"SINGLES",collectionName:"Men's Singles",matchUpFormat:"SET1-S:T60",gender:"MALE",matchUpCount:3},{scoreValue:1,matchUpType:"SINGLES",collectionName:"Women's Singles",matchUpFormat:"SET1-S:T60",gender:"FEMALE",matchUpCount:3},{scoreValue:1,matchUpType:"DOUBLES",collectionName:"Men's Doubles",matchUpFormat:"SET1-S:T60",gender:"MALE",matchUpCount:1},{matchUpValue:1,matchUpType:"DOUBLES",collectionName:"Women's Doubles",matchUpFormat:"SET1-S:T60",gender:"FEMALE",matchUpCount:1},{matchUpValue:1,matchUpType:"DOUBLES",collectionName:"Mixed Doubles",matchUpFormat:"SET1-S:T60",gender:"MIXED",matchUpCount:1}],tieFormatName:"Time Tennis Dual",winCriteria:{aggregateValue:!0}},io={collectionDefinitions:[{category:{ageCategoryCode:"14U"},collectionName:"14U Singles",matchUpCount:2,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{category:{ageCategoryCode:"16U"},collectionName:"16U Singles",matchUpCount:2,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{category:{ageCategoryCode:"18U"},collectionName:"18U Singles",matchUpCount:2,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{category:{ageCategoryCode:"14U"},collectionName:"14U Doubles",collectionGroupNumber:1,matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{category:{ageCategoryCode:"16U"},collectionName:"16U Doubles",collectionGroupNumber:1,matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{category:{ageCategoryCode:"18U"},collectionName:"18U Doubles",collectionGroupNumber:1,matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1}],collectionGroups:[{groupNumber:1,groupName:"Doubles",groupValue:1,winCriteria:{valueGoal:2}}],tieFormatName:"USTA_BREWER_CUP",winCriteria:{valueGoal:4}},no={winCriteria:{valueGoal:23},tieFormatName:"USTA_OZAKI_CUP",collectionDefinitions:[{category:{ageCategoryCode:"18U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"18U Boys Singles",matchUpType:"SINGLES",matchUpCount:3,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"18U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"18U Girls Singles",matchUpType:"SINGLES",gender:"FEMALE",matchUpCount:3,matchUpValue:1},{category:{ageCategoryCode:"18U"},collectionName:"18U Boys Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",matchUpCount:1,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"18U"},collectionName:"18U Girls Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"FEMALE",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"18U"},collectionName:"18U Mixed Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"MIXED",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"16U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"16U Boys Singles",matchUpType:"SINGLES",matchUpCount:3,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"16U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"16U Girls Singles",matchUpType:"SINGLES",gender:"FEMALE",matchUpCount:3,matchUpValue:1},{category:{ageCategoryCode:"16U"},collectionName:"16U Boys Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",matchUpCount:1,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"16U"},collectionName:"16U Girls Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"FEMALE",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"16U"},collectionName:"16U Mixed Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"MIXED",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"14U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"14U Boys Singles",matchUpType:"SINGLES",matchUpCount:3,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"14U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"14U Girls Singles",matchUpType:"SINGLES",gender:"FEMALE",matchUpCount:3,matchUpValue:1},{category:{ageCategoryCode:"14U"},collectionName:"14U Boys Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",matchUpCount:1,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"14U"},collectionName:"14U Girls Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"FEMALE",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"14U"},collectionName:"14U Mixed Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"MIXED",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"12U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"12U Boys Singles",matchUpType:"SINGLES",matchUpCount:3,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"12U"},matchUpFormat:"SET3-S:6/TB7-F:TB10",collectionName:"12U Girls Singles",matchUpType:"SINGLES",gender:"FEMALE",matchUpCount:3,matchUpValue:1},{category:{ageCategoryCode:"12U"},collectionName:"12U Boys Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",matchUpCount:1,matchUpValue:1,gender:"MALE"},{category:{ageCategoryCode:"12U"},collectionName:"12U Girls Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"FEMALE",matchUpCount:1,matchUpValue:1},{category:{ageCategoryCode:"12U"},collectionName:"12U Mixed Doubles",matchUpFormat:"SET1-S:8/TB8",matchUpType:"DOUBLES",gender:"MIXED",matchUpCount:1,matchUpValue:1}]},ao="SET3-S:6/TB7",oo="SET3-S:6/TB7-F:TB10",so={collectionDefinitions:[{collectionName:"Doubles",matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Singles",matchUpCount:2,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1}],tieFormatName:"DOMINANT_DUO",winCriteria:{valueGoal:2}},co={collectionDefinitions:[{collectionName:"Doubles",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7@7",matchUpType:"DOUBLES",collectionValue:1},{collectionName:"Singles",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1}],tieFormatName:"USTA_COLLEGE",winCriteria:{valueGoal:4}},uo={collectionDefinitions:[{collectionName:"Male Singles",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Female Singles",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Male Doubles",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Female Doubles",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1}],tieFormatName:"USTA_LEVEL_1",winCriteria:{valueGoal:10}},lo={collectionDefinitions:[{collectionName:"Female Doubles",gender:"FEMALE",matchUpCount:1,matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Male Doubles",gender:"MALE",matchUpCount:1,matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Female Singles",gender:"FEMALE",matchUpCount:1,matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"SINGLES",scoreValue:1},{collectionName:"Male Singles",matchUpCount:1,gender:"MALE",matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"SINGLES",scoreValue:1},{collectionName:"Mixed Doubles",matchUpCount:1,gender:"MIXED",matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Mixed Doubles",matchUpCount:1,gender:"MIXED",matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Overtime",matchUpCount:1,gender:"MIXED",matchUpFormat:"SET1-S:T20",matchUpType:"DOUBLES",scoreValue:1}],tieFormatName:"USTA_WTT_ITT",winCriteria:{aggregateValue:!0}},po={collectionDefinitions:[{collectionName:"Male Singles",gender:"MALE",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Female Singles",gender:"FEMALE",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpType:"SINGLES",matchUpValue:1},{collectionName:"Male Doubles",gender:"MALE",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Female Doubles",gender:"FEMALE",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Mixed Doubles",gender:"MIXED",matchUpCount:1,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1}],tieFormatName:"USTA_ZONAL",winCriteria:{valueGoal:10}},mo={collectionDefinitions:[{collectionGroupNumber:1,matchUpType:"DOUBLES",matchUpCount:1,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpValue:1},{collectionGroupNumber:1,matchUpType:"SINGLES",matchUpCount:3,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpValue:1},{collectionGroupNumber:2,matchUpType:"DOUBLES",matchUpCount:1,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpValue:2},{collectionGroupNumber:2,matchUpType:"SINGLES",matchUpCount:3,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpValue:2},{collectionGroupNumber:3,matchUpType:"DOUBLES",matchUpCount:1,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpValue:3},{collectionGroupNumber:3,matchUpType:"SINGLES",matchUpCount:3,matchUpFormat:"SET3-S:6/TB7-F:TB10",matchUpValue:3}],collectionGroups:[{groupNumber:1,groupName:"Day 1"},{groupNumber:2,groupName:"Day 2"},{groupNumber:3,groupName:"Day 3"}],tieFormatName:"LAVER_CUP",winCriteria:{valueGoal:13}},fo={collectionDefinitions:[{collectionName:"Female Doubles",gender:"FEMALE",matchUpCount:1,matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Male Doubles",gender:"MALE",matchUpCount:1,matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Female Singles",gender:"FEMALE",matchUpCount:1,matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"SINGLES",scoreValue:1},{collectionName:"Male Singles",matchUpCount:1,gender:"MALE",matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"SINGLES",scoreValue:1},{collectionName:"Mixed Doubles",matchUpCount:1,gender:"MIXED",matchUpFormat:"SET1-S:6/TB5NOAD@5",matchUpType:"DOUBLES",scoreValue:1},{collectionName:"Overtime",matchUpCount:1,gender:"MIXED",matchUpFormat:"SET1-S:T20",matchUpType:"DOUBLES",scoreValue:1}],tieFormatName:"USTA_TOC",winCriteria:{aggregateValue:!0}},ho="COLLEGE_DEFAULT",go="COLLEGE_JUCO",Io="COLLEGE_D3",Uo="DOMINANT_DUO",So="DOMINANT_DUO_MIXED",vo="LAVER_CUP",yo="TEAM_DOUBLES_3_AGGREGATION",wo="TIME_TENNIS_DUAL",Po="TIME_TENNIS_PRO_CIRCUIT",To="USTA_BREWER_CUP",Do="USTA_OZAKI_CUP",bo="USTA_COLLEGE",Mo="USTA_GOLD_TEAM_CHALLENGE",Ro="USTA_LEVEL_1",No="USTA_INTERSECTIONAL",Ao="USTA_SECTION_BATTLE",Eo="USTA_SOUTHERN_LEVEL_5",Co="USTA_TOC",Oo="USTA_WTT_ITT",ko="USTA_ZONAL",Fo={COLLEGE_D3:Io,COLLEGE_DEFAULT:ho,COLLEGE_JUCO:go,DOMINANT_DUO:Uo,DOMINANT_DUO_MIXED:So,LAVER_CUP:vo,TEAM_DOUBLES_3_AGGREGATION:yo,TIME_TENNIS_DUAL:wo,TIME_TENNIS_PRO_CIRCUIT:Po,USTA_BREWER_CUP:To,USTA_OZAKI_CUP:Do,USTA_COLLEGE:bo,USTA_GOLD_TEAM_CHALLENGE:Mo,USTA_INTERSECTIONAL:No,USTA_LEVEL_1:Ro,USTA_SECTION_BATTLE:Ao,USTA_SOUTHERN_LEVEL_5:Eo,USTA_TOC:Co,USTA_WTT_ITT:Oo,USTA_ZONAL:ko},xo="STANDARD",_o={[xo]:{hydrate:!0,doubles:{matchUpCount:3,matchUpValue:1},singles:{matchUpCount:6,matchUpValue:1},valueGoal:5},[Io]:{hydrate:!0,doubles:{matchUpFormat:"SET1-S:8/TB7@7",matchUpCount:3,matchUpValue:1},singles:{matchUpFormat:ao,matchUpCount:6,matchUpValue:1},tieFormatName:Io,valueGoal:5},[ho]:{hydrate:!0,doubles:{matchUpFormat:"SET1-S:6/TB7",collectionValue:1,matchUpCount:3},singles:{matchUpFormat:ao,matchUpCount:6,matchUpValue:1},tieFormatName:ho,valueGoal:4},[go]:{hydrate:!0,doubles:{matchUpFormat:"SET1-S:8/TB7",matchUpCount:3,matchUpValue:1},singles:{matchUpFormat:ao,matchUpCount:6,matchUpValue:1},tieFormatName:go,valueGoal:5},[vo]:mo,[Uo]:so,[So]:to,[yo]:Ja,[wo]:ro,[Po]:eo,[To]:io,[Do]:no,[bo]:co,[Mo]:Ka,[No]:Za,[Ro]:uo,[Ao]:Xa,[Eo]:Qa,[Oo]:lo,[Co]:fo,[ko]:po},Lo=e=>{let t,r=e?.namedFormat&&Object.keys(_o).includes(e.namedFormat)?e.namedFormat:xo,i=Array.isArray(e?.uuids)?e?.uuids:[],{category:n,gender:a}=e?.event??{},o=Wa(_o[r],!1,!0),s=t=>{if(!e?.isMock&&!e?.event?.isMock||!e.event)return i?.pop()??za();let r=e?.event?.eventId;return i.pop()??`${r}-COL-${t+1}`};return o.hydrate?(t={winCriteria:{valueGoal:o.valueGoal},collectionDefinitions:[{collectionId:s(0),matchUpFormat:oo,collectionName:"Doubles",matchUpType:l,...o.doubles},{collectionId:s(1),matchUpFormat:ao,collectionName:"Singles",matchUpType:u,...o.singles}]},o.tieFormatName&&(t.tieFormatName=o.tieFormatName)):(o.collectionDefinitions.forEach((e,t)=>e.collectionId=s(t)),t=o),e?.hydrateCollections&&t.collectionDefinitions.forEach(e=>{n&&!e.category&&(e.category=n),a&&!e.gender&&(e.gender=a)}),t},Bo="SINGLES",Vo="SINGLES",Go="DOUBLES",jo="DOUBLES",$o="TEAM",qo="TEAM",Wo={AGE:"AGE",BOTH:"BOTH",DOUBLES:Go,DOUBLES_EVENT:jo,RATING:"RATING",SINGLES:Bo,SINGLES_EVENT:Vo,TEAM_EVENT:qo,TEAM:$o},Ho="MAIN",Yo="QUALIFYING",zo="CONSOLATION",Ko="VOLUNTARY_CONSOLATION",Jo="PLAY_OFF",Qo=[Ho,Yo,zo,Jo,Ko],Xo={[Yo]:1,[Ho]:2,[Jo]:3,[zo]:3,[Ko]:4},Zo="finishingPositions",es="aggregateEventStructures",ts={[Ho]:1,[Jo]:2,[zo]:3,[Yo]:4,[Ko]:5},rs={[Jo]:1,[Ho]:2,[zo]:3,[Yo]:4,[Ko]:5},is="CLUSTER",ns="ADJACENT",as="SEPARATE",os="WATERFALL",ss="ITEM",cs="CONTAINER",us="DRAW",ds="RANDOM",ls="TOP_DOWN",ps="BOTTOM_UP",ms="POSITION",fs="WINNER",hs="LOSER",gs="FIRST_MATCHUP",Is="AD_HOC",Us="FEED_IN",Ss="COMPASS",vs="OLYMPIC",ys="SINGLE_ELIMINATION",ws="DOUBLE_ELIMINATION",Ps="FIRST_MATCH_LOSER_CONSOLATION",Ts="FIRST_ROUND_LOSER_CONSOLATION",Ds="LUCKY_DRAW",bs="CURTIS_CONSOLATION",Ms="CURTIS_CONSOLATION",Rs="FEED_IN_CHAMPIONSHIP_TO_SF",Ns="FEED_IN_CHAMPIONSHIP_TO_SF",As="FEED_IN_CHAMPIONSHIP_TO_QF",Es="FEED_IN_CHAMPIONSHIP_TO_QF",Cs="FEED_IN_CHAMPIONSHIP_TO_R16",Os="FEED_IN_CHAMPIONSHIP_TO_R16",ks="MODIFIED_FEED_IN_CHAMPIONSHIP",Fs="MODIFIED_FEED_IN_CHAMPIONSHIP",xs="FEED_IN_CHAMPIONSHIP",_s="ROUND_ROBIN",Ls="ROUND_ROBIN_WITH_PLAYOFF",Bs="DECIDER",Vs="BACKDRAW",Gs={0:{name:"East",abbreviation:"E"},"0-1":{name:"West",abbreviation:"W"},"0-2":{name:"North",abbreviation:"N"},"0-3":{name:"Northeast",abbreviation:"NE"},"0-1-1":{name:"South",abbreviation:"S"},"0-1-2":{name:"Southwest",abbreviation:"SW"},"0-2-1":{name:"Northwest",abbreviation:"NW"},"0-1-1-1":{name:"Southeast",abbreviation:"SE"}},js={0:{name:"East",abbreviation:"E"},"0-1":{name:"West",abbreviation:"W"},"0-2":{name:"North",abbreviation:"N"},"0-1-1":{name:"South",abbreviation:"S"}},$s="WIN_RATIO",qs="ROUND_OUTCOME",Ws=[Ss,bs,Es,Os,Ns,xs,As,Cs,Rs,Ps,Ts,Ds,Fs,vs,Jo,Ls],Hs={MAIN:Ho,QUALIFYING:Yo,CONSOLATION:zo,ITEM:ss,CONTAINER:cs,FIRST_MATCHUP:gs,WINNER:fs,LOSER:hs,AD_HOC:Is,FEED_IN:Us,FLEX_ROUNDS:"AD_HOC",COMPASS:Ss,PLAY_OFF:Jo,OLYMPIC:vs,KNOCKOUT:"SINGLE_ELIMINATION",SINGLE_ELIMINATION:ys,DOUBLE_ELIMINATION:ws,CURTIS:bs,FICSF:Rs,FICQF:As,FICR16:Cs,MFIC:ks,VOLUNTARY_CONSOLATION:Ko,FIRST_MATCH_LOSER_CONSOLATION:Ps,FIRST_ROUND_LOSER_CONSOLATION:Ts,MODIFIED_FEED_IN_CHAMPIONSHIP:Fs,FEED_IN_CHAMPIONSHIP_TO_R16:Os,FEED_IN_CHAMPIONSHIP_TO_QF:Es,FEED_IN_CHAMPIONSHIP_TO_SF:Ns,FEED_IN_CHAMPIONSHIP:xs,LUCKY_DRAW:Ds,ROUND_ROBIN_WITH_PLAYOFF:Ls,ROUND_ROBIN:_s,DECIDER:Bs,BACKDRAW:Vs,COMPASS_ATTRIBUTES:Gs,OLYMPIC_ATTRIBUTES:js,DRAW:us,RANDOM:ds,TOP_DOWN:ls,BOTTOM_UP:ps,CLUSTER:is,ADJACENT:ns,SEPARATE:as,WATERFALL:os,WIN_RATIO:$s,ROUND_OUTCOME:qs,MULTI_STRUCTURE_DRAWS:Ws,generatedDrawTypes:[Is,Ss,bs,ws,Es,Os,Ns,xs,Us,Ps,Ts,Ds,Fs,vs,Jo,_s,Ls,ys],stageOrder:Xo,finishOrder:ts,AGGREGATE_EVENT_STRUCTURES:es,FINISHING_POSITIONS:Zo},Ys=Hs,zs="tournamentRecords",Ks="policyDefinitions",Js="tournamentRecord",Qs="onlineResource",Xs="drawDefinition",Zs="tieFormatName",ec="matchUpFormat",tc="participantId",rc="scheduleDates",ic="tournamentId",nc="scheduleDate",ac="roundNumber",oc="structureId",sc="participant",cc="matchUpIds",uc="entryStage",dc="policyType",lc="structures",pc="eventType",mc="matchUpId",fc="tieFormat",hc="inContext",gc="structure",Ic="courtIds",Uc="personId",Sc="venueIds",vc="matchUps",yc="courtId",wc="eventId",Pc="matchUp",Tc="drawId",Dc="error",bc="event",Mc="param",Rc="uuids",Nc="averageMatchUpMinutes",Ac="recoveryMinutes",Ec="periodLength",Cc="object",Oc="array",kc="_validate",Fc="_message",xc="_invalid",_c="_ofType",Lc="_anyOf",Bc="_oneOf",Vc={[Qs]:e=>3===Q(Object.keys(e),[Va,Ga,ja]).length,[Zs]:e=>e&&Lo({namedFormat:e}),[Rc]:e=>!e||Array.isArray(e)&&e.every(S),[fc]:e=>!Ba({tieFormat:e}).error,[pc]:e=>[Bo,Go,$o].includes(e),[uc]:e=>Qo.includes(e)},Gc={[zs]:ge,[Js]:Ie,[Ks]:kt,[Xs]:ye,[tc]:Ir,[ec]:Tt,[ic]:Se,[oc]:Ze,[cc]:Rt,[sc]:hr,[Qs]:mi,[pc]:at,[lc]:tt,[mc]:Mt,[fc]:wt,[gc]:rt,[yc]:jt,[vc]:At,[wc]:st,[Pc]:Et,[Ic]:$t,[Sc]:$t,[Tc]:Ge,[bc]:ot},jc={[zs]:Cc,[Ks]:Cc,[Js]:Cc,[Xs]:Cc,[Qs]:Cc,[rc]:Oc,[sc]:Cc,[cc]:Oc,[lc]:Oc,[fc]:Cc,[gc]:Cc,[Ic]:Oc,[Sc]:Oc,[vc]:Oc,[Pc]:Cc,[bc]:Cc,[Rc]:Oc};function $c(e,t,r){if(!e&&!v(e))return{error:gi};if(!t?.length||e?._bypassParamCheck)return{valid:!0};if(!Array.isArray(t))return{error:gi};let{paramError:i,errorParam:n}=function(e,t){let r,i;return{paramError:t.find(({_ofType:t,_oneOf:n,_anyOf:a,_validate:o,_info:s,...c})=>{let u=n&&function(e,t){if(!t)return;let r=qc(e,t);return 1!==r.length?{error:gi}:r.reduce((e,t)=>({...e,[t]:!0}),{})}(e,n);if(u?.error)return u.error;u&&Object.assign(c,u);let d=a&&function(e,t){if(!t)return;let r=qc(e,t).filter(t=>e[t]);return r.length<1?{error:gi}:r.reduce((e,t)=>({...e,[t]:!0}),{})}(e,a);if(d?.error)return d.error;d&&Object.assign(c,d);let l=Object.keys(c).filter(e=>"boolean"==typeof c[e]),p=l.find(n=>{let a=o&&!U(o),u=void 0!==e[n]&&!o&&function(e,t,r){return r=r||jc[t]||"string","array"===r?!Array.isArray(e[t]):typeof e[t]!==r}(e,n,t),d=c[n]&&[void 0,null].includes(e[n]),l=a||u||d||o&&void 0!==e[n]&&!function(e,t){return!U(t)||t(e)}(e[n],o)||Vc[n]&&!Vc[n](e[n]);return l&&(r=n,i=s),l});return!l.length||p}),errorParam:r,paramInfo:i}}(e,t);if(!i)return{valid:!0};let a=i[kc]&&(i[Dc]||i[xc])||void 0===e?.[n]&&(i[Dc]||i[xc]||Gc[n]||gi)||gi;return Pn({info:{param:n??(i[Bc]&&Object.keys(i[Bc]).join(", ")),message:i[Fc]},result:{error:a},stack:r})}function qc(e,t){return Q(Object.keys(e),Object.keys(t))}var Wc="DYNAMIC",Hc="RANKING",Yc="RATING",zc="SCALE",Kc="SEEDING",Jc={RANKING:Hc,RATING:Yc,SCALE:zc,SEEDING:Kc};function Qc(e){let t=$c(e,[{[sc]:!0}]);if(t.error)return t;let r=e.participant.timeItems?.filter(({itemType:e})=>e?.startsWith(zc)&&[Hc,Yc,Kc].includes(e.split(".")[1])),i={ratings:{},rankings:{},seedings:{}};if(r?.length){let e=e=>r.filter(t=>t?.itemType===e).sort((e,t)=>new Date(e.createdAt||void 0).getTime()-new Date(t.createdAt||void 0).getTime()).pop(),t=L(r.map(({itemType:e})=>e));for(let r of t){let t=e(r);if(t){let[,e,r,n,a]=t.itemType.split("."),o=a?`${n}.${a}`:n,s=(e===Kc?"seedings":e===Hc&&"rankings")||"ratings";i[s][r]||(i[s][r]=[]),i[s][r].push({scaleValue:t.itemValue,scaleDate:t.itemDate,scaleName:o})}}}return{...ce,...i}}function Xc(e){if(null===e)return{};let{source:t,template:r}=e||{};if(!r)return t;let i={};return function e(t,r,i){if(!t||!r)return;let n=Object.keys(t),a=Object.keys(r),o=Object.assign({},...a.filter(e=>e.indexOf("||")).map(e=>e.split("||").map(t=>({[t]:e}))).flat()),s=a.concat(...Object.keys(o)),c=s.includes("*");for(let u of n)if(s.indexOf(u)>=0||c){let n=r[o[u]||u]||c,a=t[u];if("object"!=typeof n||"function"==typeof a||Array.isArray(n)){let e=t[u];if(Array.isArray(n)&&!n.includes(e))return!1;(r[u]||c&&!1!==r[u])&&(i[u]=e)}else if(Array.isArray(a)){let t=a.map(t=>{let r={};return!1!==e(t,n,r)?r:void 0}).filter(Boolean);i[u]=t}else a&&(i[u]={},e(a,n,i[u]))}}(t,r,i),i}var Zc="voluntaryConsolation",eu="competitiveBands",tu="roundRobinTally",ru="positionActions",iu="matchUpActions",nu="rankingPoints",au="roundNaming",ou="participant",su="progression",cu="scheduling",uu="avoidance",du="scoring",lu="seeding",pu="feedIn",mu="draws",fu={POLICY_TYPE_VOLUNTARY_CONSOLATION:Zc,POLICY_TYPE_COMPETITIVE_BANDS:eu,POLICY_TYPE_ROUND_ROBIN_TALLY:tu,POLICY_TYPE_POSITION_ACTIONS:ru,POLICY_TYPE_MATCHUP_ACTIONS:iu,POLICY_TYPE_RANKING_POINTS:nu,POLICY_TYPE_ROUND_NAMING:au,POLICY_TYPE_PARTICIPANT:ou,POLICY_TYPE_PROGRESSION:su,POLICY_TYPE_SCHEDULING:cu,POLICY_TYPE_AVOIDANCE:uu,POLICY_TYPE_DISPLAY:"display",POLICY_TYPE_PRIVACY:"participant",POLICY_TYPE_FEED_IN:pu,POLICY_TYPE_SCORING:du,POLICY_TYPE_SEEDING:lu,POLICY_TYPE_AUDIT:"audit",POLICY_TYPE_DRAWS:mu};function hu({tournamentParticipants:e=[],policyDefinitions:t={},contextProfile:r,participantId:i,internalUse:n,personId:a}){let o=Wa(e.find(e=>i&&e.participantId===i||a&&e.person&&e.person.personId===a),!1,n);if(o){let e=t?.[ou];if(r?.withScaleValues){let{ratings:e,rankings:t}=Qc({participant:o});o.rankings=t,o.ratings=e}if(e?.participant)return Xc({template:e.participant,source:o})}return o}function gu(e){if(!e||"object"!=typeof e)return{error:$t};if(e.element&&"object"!=typeof e?.element)return{error:gi};if(!e?.name)return{error:$t,info:"missing name"};if(!e?.element){if(e.discover&&e.tournamentRecords){for(let t of Object.keys(e.tournamentRecords)){let r=gu({element:e.tournamentRecords[t],name:e.name});if(r.error)return Pn({result:r,stack:"removeExtension"})}return{...ce}}return{error:$t,info:"element required"}}return e?.element.extensions?(e.element.extensions=e.element.extensions.filter(t=>t?.name!==e.name),{...ce}):{...ce,info:wi}}function Iu({requiredAttributes:e=["name","value"],extension:t}){if(!t||"object"!=typeof t||"string"!=typeof t.name)return!1;let r=Object.keys(t);return e.filter(e=>r.includes(e)).length===e.length}function Uu(e){if("object"!=typeof e)return{error:$t};let t="addExtension";if(e?.element&&"object"!=typeof e.element)return Pn({result:{error:gi},stack:t});if(!Iu({extension:e.extension}))return Pn({result:{error:gi,info:"invalid extension"},stack:t});if(!e.element){if(e.discover&&!e.tournamentId&&e.tournamentRecords){for(let r of Object.values(e.tournamentRecords)){let i=Uu({extension:e.extension,element:r});if(i.error)return Pn({result:i,stack:t})}return{...ce}}return Pn({result:{error:$t},stack:t})}if(e.element.extensions||(e.element.extensions=[]),e?.creationTime??1){let t=(new Date).toISOString();Object.assign(e.extension,{createdAt:t})}let r=e.element.extensions.find(({name:t})=>t===e.extension.name);return r?r.value=e.extension.value:e.extension.value&&e.element.extensions.push(e.extension),{...ce}}function Su(e){return e&&"object"==typeof e?e.tournamentRecord?Uu({creationTime:e.creationTime,element:e.tournamentRecord,extension:e.extension}):{error:Ie}:{error:$t}}function vu(e){return e&&"object"==typeof e?e.drawDefinition?Uu({creationTime:e.creationTime,element:e.drawDefinition,extension:e.extension}):{error:Pe}:{error:$t}}function yu(e){return e&&"object"==typeof e?e.event?Uu({creationTime:e.creationTime,extension:e.extension,element:e.event}):{error:st}:{error:$t}}function wu(e){if(!e||"object"!=typeof e)return{error:$t};if(!e.participantId)return{error:Ir};let t=e.tournamentRecord?.participants||[],r=hu({participantId:e.participantId,tournamentParticipants:t});return r?Uu({creationTime:e.creationTime,extension:e.extension,element:r}):{error:Sr}}function Pu(e){return e&&"object"==typeof e?e.tournamentRecord?gu({element:e.tournamentRecord,name:e.name}):{error:Ie}:{error:$t}}function Tu(e){return e&&"object"==typeof e?e.drawDefinition?gu({element:e.drawDefinition,name:e.name}):{error:Pe}:{error:$t}}function Du(e){return e&&"object"==typeof e?e?.event?gu({element:e.event,name:e.name}):{error:st}:{error:$t}}function bu(e){if(!e||"object"!=typeof e)return{error:$t};if(!e.participantId)return{error:Ir};let t=e.tournamentRecord?.participants||[],r=hu({participantId:e.participantId,tournamentParticipants:t});return r?gu({element:r,name:e.name}):{error:Sr}}function Mu({tournamentRecords:e}){return{tournamentIds:v(e)?Object.keys(e):[],...ce}}function Ru({discover:e,element:t,name:r,...i}){if(!t||!r){if(e&&i){let t=Object.keys(i).filter(t=>"boolean"==typeof e||Array.isArray(e)&&e.includes(t)).find(e=>!!Array.isArray(i[e]?.extensions)&&i[e].extensions.find(e=>e?.name===r)),n=t&&i[t];!n&&i.tournamentRecords&&(n=Object.values(i.tournamentRecords).find(e=>e.extensions?.length));let a=n?.extensions?.find(e=>e?.name===r);return{extension:a,info:a?void 0:wi}}return Pn({result:{error:$t},stack:"extensionQueries"})}if(!Array.isArray(t.extensions))return{info:"no extensions"};let n=t.extensions.find(e=>e?.name===r);return{extension:n,info:n?void 0:wi}}var Nu="appliedPolicies",Au="context",Eu="delegatedOutcome",Cu="disabled",Ou="disableAutoCalc",ku="disableLinks",Fu="display",xu="drawDeletions",_u="entryProfile",Lu="flightProfile",Bu="groupingAttribute",Vu="lineUps",Gu="linkedTournamentsIds",ju="participantRepresentatives",$u="personRequests",qu="positionActions",Wu="roundTarget",Hu="scheduleLimits",Yu="scheduleTiming",zu="schedulingProfile",Ku="subOrder",Ju="tally",Qu="tieFormatModification",Xu={ACTIVE_SUSPENSION:"activeSuspension",APPLIED_POLICIES:Nu,CONTEXT:Au,DELEGATED_OUTCOME:Eu,DISABLED:Cu,DISABLE_LINKS:ku,DISABLE_AUTO_CALC:Ou,DISPLAY:Fu,DRAW_DELETIONS:xu,DRAW_PROFILE:"drawProfile",ENTRY_PROFILE:_u,EVENT_PROFILE:"eventProfile",EVENT_WITHDRAWAL_REQUESTS:"eventWithdrawalRequests",FLIGHT_PROFILE:Lu,GROUPING_ATTRIBUTE:Bu,LINEUPS:Vu,LINKED_TOURNAMENTS:Gu,PARTICIPANT_REPRESENTATIVES:ju,PERSON_REQUESTS:$u,POSITION_ACTIONS:qu,RANKING_POINTS:"rankingPoints",REGISTRATION:"registration",ROUND_TARGET:Wu,SCHEDULE_LIMITS:Hu,SCHEDULE_TIMING:Yu,SCHEDULING_PROFILE:zu,STATUS_DETAIL:"statusDetail",SUB_ORDER:Ku,TALLY:Ju,TIE_FORMAT_MODIFICATIONS:Qu,FACTORY:"factory"},Zu=[Eu,Cu,Ou,ku,Lu,Vu,Gu,ju,$u,Wu,Hu,Yu,zu,Ku,Ju,Qu];function ed({tournamentRecords:e}){if("object"!=typeof e||!Object.keys(e).length)return{error:ge};let t=Mu({tournamentRecords:e}),{tournamentIds:r}=t;return r?.length>1?Uu({tournamentRecords:e,discover:!0,extension:{name:Gu,value:{tournamentIds:r}}}):{...ce}}function td({tournamentRecords:e}){if("object"!=typeof e||!Object.keys(e).length)return{error:ge};return Pn({result:gu({name:Gu,tournamentRecords:e,discover:!0}),stack:"unlinkTournaments"})}function rd({tournamentRecords:e,tournamentId:t}){if("object"!=typeof e)return{error:gi};if(!t)return{error:Se};let r,i=Mu({tournamentRecords:e}),{tournamentIds:n}=i;return n.includes(t)?(n.every(i=>{let n=e[i],{extension:a}=Ru({element:n,name:Gu});if(!a)return!0;let o=a?.value?.tournamentIds||[];if(!o?.length||1===o.length&&o.includes(t)||i===t){let e=Pu({name:Gu,tournamentRecord:n});return e.error&&(r=e.error),e.success}let s=o.filter(e=>e!==t);a.value={tournamentIds:s};let c=Su({tournamentRecord:n,extension:a});return c.error&&(r=c.error),c.success}),r?{error:r}:{...ce}):{error:Se}}var id={};function nd({tournamentRecords:e}){return"object"==typeof e&&Object.keys(e).length?{linkedTournamentIds:Object.assign({},...Object.keys(e).map(t=>{let r=e[t],i=r?.tournamentId,{extension:n}=Ru({element:r,name:Gu}),a=(n?.value?.tournamentIds||[]).filter(e=>e!==i);return{[t]:a}}))}:{error:ge}}n(id,{getLinkedTournamentIds:()=>nd,getTournamentIds:()=>Mu});var ad={};n(ad,{adHocPositionSwap:()=>RS,addAdHocMatchUps:()=>Ev,addDrawDefinitionTimeItem:()=>WU,addFinishingRounds:()=>ah,addGoesTo:()=>oh,addPlayoffStructures:()=>Uv,addQualifyingStructure:()=>MS,addVoluntaryConsolationStage:()=>XU,addVoluntaryConsolationStructure:()=>UI,allPlayoffPositionsFilled:()=>cU,alternateDrawPositionAssignment:()=>iU,assignDrawPosition:()=>Mv,assignDrawPositionBye:()=>vh,attachConsolationStructures:()=>hv,attachPlayoffStructures:()=>gv,attachQualifyingStructure:()=>$U,attachStructures:()=>Iv,autoSeeding:()=>vM,automatedPlayoffPositioning:()=>FU,automatedPositioning:()=>kU,buildDrawHierarchy:()=>gM,checkValidEntries:()=>$y,deleteAdHocMatchUps:()=>Nv,drawMatic:()=>uD,findDrawDefinition:()=>ry,generateAdHocMatchUps:()=>sw,generateAdHocRounds:()=>sD,generateAndPopulatePlayoffStructures:()=>uv,generateDrawDefinition:()=>hM,generateDrawMaticRound:()=>gw,generateDrawStructuresAndLinks:()=>Jy,generateDrawTypeAndModifyDrawDefinition:()=>Qy,generateQualifyingStructure:()=>bS,generateVoluntaryConsolation:()=>Iw,getAssignedParticipantIds:()=>Nh,getAvailableMatchUpsCount:()=>Fv,getAvailablePlayoffProfiles:()=>LS,getDrawDefinitionTimeItem:()=>Xl,getDrawParticipantRepresentativeIds:()=>xv,getDrawStructures:()=>Gd,getDrawTypeCoercion:()=>Ly,getEligibleVoluntaryConsolationParticipants:()=>kv,getMatchUpsMap:()=>Kp,getParticipantIdFinishingPositions:()=>ey,getPositionAssignments:()=>_v,getPositionsPlayedOff:()=>xS,getRandomQualifierList:()=>By,getSeedingThresholds:()=>RI,getSeedsCount:()=>jy,getStructureSeedAssignments:()=>Wp,getTeamLineUp:()=>kf,getValidGroupSizes:()=>DI,isAdHoc:()=>nm,isCompletedStructure:()=>sU,isValidForQualifying:()=>Vy,luckyLoserDrawPositionAssignment:()=>QI,modifyDrawDefinition:()=>wv,modifyDrawName:()=>yv,modifySeedAssignment:()=>xU,mutate:()=>od,positionActions:()=>_y,pruneDrawDefinition:()=>Dv,qualifierDrawPositionAssignment:()=>_U,qualifierProgression:()=>BU,query:()=>Ov,removeDrawPositionAssignment:()=>pI,removeRoundMatchUps:()=>Av,removeSeededParticipant:()=>SS,removeStructure:()=>HU,renameStructures:()=>qU,resetDrawDefinition:()=>Pv,resetQualifyingStructure:()=>ZU,resetVoluntaryConsolationStructure:()=>Al,setDrawParticipantRepresentativeIds:()=>md,setPositionAssignments:()=>tU,setStructureOrder:()=>VU,setSubOrder:()=>Cv,shiftAdHocRounds:()=>eU,swapAdHocRounds:()=>rU,swapDrawPositionAssignments:()=>IS,updateTeamLineUp:()=>YI,withdrawParticipantAtDrawPosition:()=>mI});var od={};n(od,{adHocPositionSwap:()=>RS,addAdHocMatchUps:()=>Ev,addDrawDefinitionTimeItem:()=>WU,addPlayoffStructures:()=>Uv,addQualifyingStructure:()=>MS,addVoluntaryConsolationStage:()=>XU,addVoluntaryConsolationStructure:()=>UI,alternateDrawPositionAssignment:()=>iU,assignDrawPosition:()=>Mv,assignDrawPositionBye:()=>vh,attachConsolationStructures:()=>hv,attachPlayoffStructures:()=>gv,attachQualifyingStructure:()=>$U,attachStructures:()=>Iv,automatedPlayoffPositioning:()=>FU,automatedPositioning:()=>kU,deleteAdHocMatchUps:()=>Nv,luckyLoserDrawPositionAssignment:()=>QI,modifyDrawDefinition:()=>wv,modifyDrawName:()=>yv,modifySeedAssignment:()=>xU,pruneDrawDefinition:()=>Dv,qualifierDrawPositionAssignment:()=>_U,qualifierProgression:()=>BU,removeDrawPositionAssignment:()=>pI,removeRoundMatchUps:()=>Av,removeSeededParticipant:()=>SS,removeStructure:()=>HU,renameStructures:()=>qU,resetDrawDefinition:()=>Pv,resetQualifyingStructure:()=>ZU,resetVoluntaryConsolationStructure:()=>Al,setDrawParticipantRepresentativeIds:()=>md,setPositionAssignments:()=>tU,setStructureOrder:()=>VU,setSubOrder:()=>Cv,shiftAdHocRounds:()=>eU,swapAdHocRounds:()=>rU,swapDrawPositionAssignments:()=>IS,updateTeamLineUp:()=>YI,withdrawParticipantAtDrawPosition:()=>mI});var sd=e=>t=>e[t],cd=(e=[])=>e.map(ld).filter(Boolean),ud=(e=[])=>e.map(dd).filter(Boolean),dd=(e={})=>sd(e)("participantId"),ld=(e={})=>sd(e)("matchUpId"),pd=(e={})=>sd(e)("drawId");function md({representativeParticipantIds:e,drawDefinition:t}){if(!t)return{error:Pe};if(!Array.isArray(e))return{error:gi};let r=ud(t?.entries||[]);return e.length&&Q(e,r).length<e.length?{error:gi}:vu({drawDefinition:t,extension:{name:ju,value:e}})}var fd="ABANDONED",hd="AWAITING_RESULT",gd="CANCELLED",Id="COMPLETED",Ud="DEAD_RUBBER",Sd="DEFAULTED",vd="DOUBLE_DEFAULT",yd="DOUBLE_WALKOVER",wd="IN_PROGRESS",Pd="INCOMPLETE",Td="NOT_PLAYED",Dd="RETIRED",bd="SUSPENDED",Md="TO_BE_PLAYED",Rd="WALKOVER",Nd=[hd,Id,Sd,wd,Pd,Dd,bd],Ad=[hd,Id,Sd,yd,vd,wd,Pd,Dd,bd,Rd],Ed=[fd,hd,"BYE",gd,Id,Ud,Sd,yd,vd,wd,Pd,Td,Dd,bd,Md,Rd],Cd=["BYE",yd,vd,Id,Sd,Dd,Rd],Od=[fd,hd,gd,Ud,wd,Pd,Td,bd,Md,void 0],kd=[gd,fd,Id,Ud,Sd,yd,vd,Dd,Rd],Fd=[fd,Id,Sd,yd,vd,wd,Dd,Rd],xd=[wd,Pd,bd,Md],_d={ABANDONED:fd,AWAITING_RESULT:hd,BYE:"BYE",CANCELLED:gd,COMPLETED:Id,DEAD_RUBBER:Ud,DEFAULTED:Sd,DOUBLE_WALKOVER:yd,DOUBLE_DEFAULT:vd,IN_PROGRESS:wd,INCOMPLETE:Pd,NOT_PLAYED:Td,RETIRED:Dd,SUSPENDED:bd,TO_BE_PLAYED:Md,WALKOVER:Rd};function Ld(e,t,r){let i=e=>Ru({element:e,name:Wu})?.extension?.value,n=r?.deprioritizeCompleted,a=r?.mode===es&&rs,o=r?.mode===Zo&&ts,s=o||a||Xo,c=e=>(e=>e?.stage===Ho&&1===e?.stageSequence)(e)?-1:s[e?.stage],u=e=>e?.matchUps.every(({matchUpStatus:e})=>kd.includes(e)?1:-1);return n&&u(e)-u(t)||a&&c(e)-c(t)||(e?.stage&&s[e.stage]||0)-(t?.stage&&s[t.stage]||0)||(i(e)||0)-(i(t)||0)||!o&&!a&&(t?.positionAssignments?.length??1/0)-(e?.positionAssignments?.length??1/0)||(e?.stageSequence??0)-(t?.stageSequence??0)||(Bd(e)||0)-(Bd(t)||0)}function Bd(e){return(e?.matchUps||[]).reduce((e,t)=>{let r=(t.finishingPositionRange?.winner||[]).reduce((e,t)=>e+t,0);return!e||r<e?r:e},void 0)}function Vd(e){let t=$c(e,[{[Xs]:!0,[oc]:!0}]);if(t.error)return t;let{drawDefinition:r,structureId:i}=e,{structures:n}=Gd({drawDefinition:r}),a=n?.flatMap(e=>e.structures?[...e.structures].concat(e):e),o=a?.find(e=>e.structureId===i);return o?{structure:o,containingStructure:o.structureType===ss?a?.find(e=>e.structures?.some(e=>e.structureId===i)):void 0}:{error:et}}function Gd({withStageGrouping:e,drawDefinition:t,stageSequences:r,stageSequence:i,roundTarget:n,sortConfig:a,stages:o,stage:s}){let c=!t&&ye||!t?.structures&&tt||void 0;if(c)return{error:c,structures:[],stageStructures:{}};let u=t?.structures?.filter(function(e){return!s&&!Array.isArray(o)||s&&e.stage===s||Array.isArray(o)&&o.includes(e.stage)}).filter(function(e){return!i&&!Array.isArray(r)||i&&e.stageSequence===i||Array.isArray(r)&&r.includes(e.stageSequence)}).filter(e=>{let t=Ru({element:e,name:Wu})?.extension?.value;return!n||n===t}).sort((e,t)=>Ld(e,t,a))??[],d=e?Object.assign({},...Qo.map(e=>{let t=u?.filter(t=>t.stage===e);return t?.length&&{[e]:t}}).filter(Boolean)):{};return{structures:u,stageStructures:d}}function jd({drawDefinition:e}){if(!e)return{error:ye};let t={};return{allPositionedParticipantIds:(e.structures||[]).map(e=>{let r=e.stage;t[r]||(t[r]=[]);let{positionAssignments:i}=$d({structure:e}),n=i?.map(dd).filter(Boolean)??[];return t[r].push(...n),n}).flat(),stagePositionedParticipantIds:t}}function $d({drawDefinition:e,structureId:t,structure:r}){let i,n=[];if(!r){if(!e)return{positionAssignments:n,error:ye};if(({structure:r,error:i}=Vd({drawDefinition:e,structureId:t})),i)return{positionAssignments:n,error:i}}return r.structures?n=[].concat(...r.structures.map(e=>$d({structure:e}).positionAssignments)):r.positionAssignments?n=r.positionAssignments:i=ht,{positionAssignments:n,error:i}}function qd({drawDefinition:e,structureId:t,structure:r}){let i=$d({drawDefinition:e,structureId:t,structure:r})?.positionAssignments||[],n=i?.filter(e=>e.participantId??e.bye??e.qualifier),a=i&&i?.length===n?.length,o=i?.filter(e=>!e.participantId&&!e.bye&&!e.qualifier),s=i?.filter(e=>!e.participantId&&e.bye),c=i?.filter(e=>!e.participantId&&e.qualifier);return{allPositionsAssigned:a,positionAssignments:i,unassignedPositions:o,assignedPositions:n,qualifierPositions:c,byePositions:s}}var Wd="addDrawDefinition",Hd="addMatchUps",Yd="addParticipants",zd="addScaleItems",Kd="addEvent",Jd="addVenue",Qd="audit",Xd="dataIssue",Zd="deleteParticipants",el="deleteVenue",tl="deletedDrawIds",rl="deletedMatchUpIds",il="modifyDrawDefinition",nl="modifyDrawEntries",al="modifyEventEntries",ol="modifyMatchUp",sl="modifyParticipants",cl="modifyPositionAssignments",ul="modifySeedAssignments",dl="modifyTournamentDetail",ll="modifyVenue",pl="mutations",ml="publishEvent",fl="publishEventSeeding",hl="publishOrderOfPlay",gl="publishParticipants",Il="unPublishEvent",Ul="unPublishEventSeeding",Sl="unPublishOrderOfPlay",vl="updateInContextMatchUp",yl={ADD_DRAW_DEFINITION:Wd,ADD_MATCHUPS:Hd,ADD_PARTICIPANTS:Yd,ADD_SCALE_ITEMS:zd,ADD_EVENT:Kd,ADD_VENUE:Jd,AUDIT:Qd,DATA_ISSUE:Xd,DELETE_PARTICIPANTS:Zd,DELETE_VENUE:el,DELETED_DRAW_IDS:tl,DELETED_MATCHUP_IDS:rl,MODIFY_DRAW_DEFINITION:il,MODIFY_DRAW_ENTRIES:nl,MODIFY_EVENT_ENTRIES:al,MODIFY_MATCHUP:ol,MODIFY_PARTICIPANTS:sl,MODIFY_POSITION_ASSIGNMENTS:cl,MODIFY_SEED_ASSIGNMENTS:ul,MODIFY_TOURNAMENT_DETAIL:dl,MODIFY_VENUE:ll,MUTATIONS:pl,PUBLISH_EVENT_SEEDING:fl,PUBLISH_EVENT:ml,PUBLISH_ORDER_OF_PLAY:hl,PUBLISH_PARTICIPANTS:gl,UNPUBLISH_EVENT_SEEDING:Ul,UNPUBLISH_EVENT:Il,UNPUBLISH_ORDER_OF_PLAY:Sl,UPDATE_INCONTEXT_MATCHUP:vl};function wl(e,t){if(!e)return{error:ye};let r=Date.now();e.updatedAt&&r===new Date(e.updatedAt).getTime()&&(r+=1);let i=new Date(r).toISOString(),n=t?.filter(Boolean);return e.updatedAt=i,e.structures?.filter(Boolean).forEach(e=>{(!n?.length||n?.includes(e.structureId))&&(e.updatedAt=i)}),{...ce}}function Pl({drawDefinition:e,tournamentId:t,matchUps:r,eventId:i}){return e&&wl(e),rn({payload:{matchUps:r,tournamentId:t,eventId:i},topic:Hd}),{...ce}}function Tl({drawDefinition:e,tournamentId:t,matchUpIds:r,eventId:i,action:n}){e&&wl(e),rn({topic:rl,payload:{tournamentId:t,matchUpIds:r,eventId:i,action:n}});for(let a of r)on({key:a});return{...ce}}function Dl({drawDefinition:e,tournamentId:t,structureId:r,context:i,eventId:n,matchUp:a}){return a?(e&&Ml({drawDefinition:e,structureIds:r?[r]:void 0,tournamentId:t,eventId:n}),rn({topic:ol,payload:{matchUp:a,tournamentId:t,context:i},key:a.matchUpId}),{...ce}):(console.log(Et),{error:Et})}function bl({tournamentId:e,eventId:t,drawDefinition:r}){return r?(wl(r),rn({payload:{drawDefinition:r,tournamentId:e,eventId:t},topic:Wd,key:r.drawId}),{...ce}):(console.log(ye),{error:ye})}function Ml({drawDefinition:e,tournamentId:t,structureIds:r,eventId:i}){return e?(wl(e,r),rn({payload:{tournamentId:t,eventId:i,drawDefinition:e},topic:il,key:e.drawId}),{...ce}):{error:ye}}function Rl({drawDefinition:e,tournamentId:t,structure:r,eventId:i}){if(!e)return{error:ye};if(!r)return{error:rt};let n=r.seedAssignments,a=r.structureId;return rn({payload:{tournamentId:t,eventId:i,drawId:e.drawId,structureId:a,seedAssignments:n},topic:ul,key:e.drawId}),Ml({structureIds:[a],drawDefinition:e,tournamentId:t,eventId:i}),{...ce}}function Nl({drawDefinition:e,tournamentId:t,structure:r,event:i}){if(!e)return{error:ye};if(!r)return{error:rt};let n=$d({structure:r}),a=r.structureId,o=e.drawId,s=i?.eventId;return rn({topic:cl,payload:{positionAssignments:n,tournamentId:t,structureId:a,eventId:s,drawId:o},key:a}),Ml({structureIds:[a],drawDefinition:e,tournamentId:t,eventId:s}),{...ce}}function Al({tournamentRecord:e,drawDefinition:t,resetEntries:r,event:i}){if(!t)return{error:ye};let n=t.structures?.find(e=>e.stage===Ko);if(!n)return{error:et};let a=n.matchUps?.map(({matchUpId:e})=>e)||[];return n.positionAssignments=[],n.seedAssignments=[],n.matchUps=[],Tl({tournamentId:e?.tournamentId,action:"resetVoluntaryConsolationStructure",matchUpIds:a,drawDefinition:t}),r&&(t.entries=t.entries.filter(e=>e.entryStage!==Ko)),Ml({tournamentId:e?.tournamentId,eventId:i?.eventId,drawDefinition:t,structureIds:[n.structureId]}),{...ce}}function El({drawPositions:e,structure:t}){if([Yo,Ho].includes(t.stage)&&1===t.stageSequence)return;let{positionAssignments:r}=$d({structure:t});r?.filter(({drawPosition:t})=>e?.includes(t))?.forEach(e=>{Uu({element:e,extension:{name:ku,value:!0}})})}function Cl(e){let{appliedPolicies:t,positionAction:r,drawDefinition:i}=e;if(!1===t?.audit?.[qu])return;let{extension:n}=Ru({name:qu,element:i}),a=Array.isArray(n?.value)?n?.value??[]:[];if(!a?.length){let e=i.structures.find(e=>e.stage===Ho);if(e){let t=$d({structure:e}).positionAssignments?.map(({drawPosition:e,participantId:t,bye:r,qualifier:i})=>({drawPosition:e,participantId:t,qualifier:i,bye:r}));a.push({name:"initialMainAssignments",initialAssignments:t})}}Uu({element:i,extension:{value:a.concat(r),name:qu}})}function Ol({tournamentRecord:e,drawDefinition:t,event:r}){let i=(e?.events||r&&[r])?.map(e=>e?.drawDefinitions).flat().filter(Boolean)||t&&[t]||[],n={},a={},o=i.map(e=>e?.structures?.filter(e=>e?.structures)).flat().filter(Boolean);for(let s of o){let{structures:e,structureId:t}=s??{};e&&t&&(n[t]=e?.map(e=>e.structureId))&&e.forEach(e=>a[e.structureId]=s?.structureId)}return{containedStructures:n,containerStructures:a}}function kl(e){let{sides:t,matchUpType:r}=e||{},i=e.potentialParticipants?.length?e.potentialParticipants.flat().map(e=>r===l?e?.individualParticipantIds||[]:e.participantId).flat():[],n=(t||[]).map(e=>r===l&&(e?.participant?.individualParticipantIds||[])||e?.participantId&&[e.participantId]||[]).flat();return{individualParticipantIds:n.concat(i).flat(),enteredIndividualParticipantIds:n,potentialIndividualParticipantIds:i}}function Fl(e){return e?.tournamentRecords??(e?.tournamentRecord&&{[e.tournamentRecord.tournamentId]:e.tournamentRecord})??{}}var xl="SIGN_IN_STATUS",_l="SIGNED_OUT",Ll="SIGNED_IN",Bl="TEAM",Vl="INDIVIDUAL",Gl="GROUP",jl="PAIR",$l="TEAM",ql={TEAM_PARTICIPANT:Bl,INDIVIDUAL:Vl,GROUP:Gl,TEAM:$l,PAIR:jl},Wl={INDIVIDUAL:Vl,GROUP:Gl,PAIR:jl,TEAM:$l,SIGN_IN_STATUS:xl,SIGNED_OUT:_l,SIGNED_IN:Ll};function Hl({participantsProfile:e,participants:t=[],deepCopy:r}){let i=new Map,n=!1!==r?Wa(t,e?.convertExtensions,!0):t,a=n.filter(e=>e.participantType===$l),o=n.filter(e=>e.participantType===Gl),s=n.filter(e=>e.participantType===jl);return n.forEach(e=>{if(e.participantType===Vl){let{participantId:t}=e;e.groupParticipantIds=[],e.teamParticipantIds=[],e.pairParticipantIds=[],e.groups=[],e.teams=[],a.forEach(r=>{(r?.individualParticipantIds||[]).forEach(n=>{n===t&&!e.teamParticipantIds?.includes(r.participantId)&&(e.teamParticipantIds.push(r.participantId),i.get(r.participantId)||i.set(r.participantId,{participantName:r.participantName,participantId:r.participantId}),e.teams.push({participantRoleResponsibilities:r.participantRoleResponsibilities,participantOtherName:r.participantOtherName,participantName:r.participantName,participantId:r.participantId,teamId:r.teamId}))})}),s.forEach(r=>{(r?.individualParticipantIds||[]).forEach(i=>{i===t&&!e.pairParticipantIds.includes(r.participantId)&&e.pairParticipantIds.push(r.participantId)})}),o.forEach(r=>{(r?.individualParticipantIds||[]).forEach(i=>{i===t&&!e.groupParticipantIds.includes(r.participantId)&&(e.groupParticipantIds.push(r.participantId),e.groups.push({participantRoleResponsibilities:r.participantRoleResponsibilities,participantOtherName:r.participantOtherName,participantName:r.participantName,participantId:r.participantId}))})})}}),{participantsWithGroupings:n,groupInfo:Object.fromEntries(i)}}var Yl=[{ioc:"",iso2:"",iso:"",label:"NONE",phone:""},{ioc:"AND",iso2:"AD",iso:"AND",label:"Andorra",phone:"376"},{ioc:"UAE",iso2:"AE",iso:"ARE",label:"United Arab Emirates",phone:"971"},{ioc:"AFG",iso2:"AF",iso:"AFG",label:"Afghanistan",phone:"93"},{ioc:"ANT",iso2:"AG",iso:"ATG",label:"Antigua and Barbuda",phone:"1-268"},{ioc:"AIA",iso2:"AI",iso:"AIA",label:"Anguilla",phone:"1-264"},{ioc:"ALB",iso2:"AL",iso:"ALB",label:"Albania",phone:"355"},{ioc:"ARM",iso2:"AM",iso:"ARM",label:"Armenia",phone:"374"},{ioc:"ANG",iso2:"AO",iso:"AGO",label:"Angola",phone:"244"},{ioc:"",iso2:"AQ",iso:"ATA",label:"Antarctica",phone:"672"},{ioc:"ARG",iso2:"AR",iso:"ARG",label:"Argentina",phone:"54"},{ioc:"ASA",iso2:"AS",iso:"ASM",label:"American Samoa",phone:"1-684"},{ioc:"AUT",iso2:"AT",iso:"AUT",label:"Austria",phone:"43"},{ioc:"AUS",iso2:"AU",iso:"AUS",label:"Australia",phone:"61",suggested:!0},{ioc:"ARU",iso2:"AW",iso:"ABW",label:"Aruba",phone:"297"},{ioc:"AZE",iso2:"AZ",iso:"AZE",label:"Azerbaijan",phone:"994"},{ioc:"BIH",iso2:"BA",iso:"BIH",label:"Bosnia and Herzegovina",phone:"387"},{ioc:"BAR",iso2:"BB",iso:"BRB",label:"Barbados",phone:"1-246"},{ioc:"BAN",iso2:"BD",iso:"BGD",label:"Bangladesh",phone:"880"},{ioc:"BEL",iso2:"BE",iso:"BEL",label:"Belgium",phone:"32"},{ioc:"BUR",iso2:"BF",iso:"BFA",label:"Burkina Faso",phone:"226"},{ioc:"BUL",iso2:"BG",iso:"BGR",label:"Bulgaria",phone:"359"},{ioc:"BRN",iso2:"BH",iso:"BHR",label:"Bahrain",phone:"973"},{ioc:"BDI",iso2:"BI",iso:"BDI",label:"Burundi",phone:"257"},{ioc:"BEN",iso2:"BJ",iso:"BEN",label:"Benin",phone:"229"},{ioc:"",iso2:"BL",iso:"BLM",label:"Saint Barthelemy",phone:"590"},{ioc:"BER",iso2:"BM",iso:"BMU",label:"Bermuda",phone:"1-441"},{ioc:"BRU",iso2:"BN",iso:"BRN",label:"Brunei Darussalam",phone:"673"},{ioc:"BOL",iso2:"BO",iso:"BOL",label:"Bolivia",phone:"591"},{ioc:"BRA",iso2:"BR",iso:"BRA",label:"Brazil",phone:"55"},{ioc:"BAH",iso2:"BS",iso:"BHS",label:"Bahamas",phone:"1-242"},{ioc:"BHU",iso2:"BT",iso:"BTN",label:"Bhutan",phone:"975"},{ioc:"",iso2:"BV",iso:"BVT",label:"Bouvet Island",phone:"47"},{ioc:"BOT",iso2:"BW",iso:"BWA",label:"Botswana",phone:"267"},{ioc:"BLR",iso2:"BY",iso:"BLR",label:"Belarus",phone:"375"},{ioc:"BIZ",iso2:"BZ",iso:"BLZ",label:"Belize",phone:"501"},{ioc:"CAN",iso2:"CA",iso:"CAN",label:"Canada",phone:"1",suggested:!0},{ioc:"",iso2:"CC",iso:"CCK",label:"Cocos (Keeling) Islands",phone:"61"},{ioc:"CGO",iso2:"CD",iso:"COG",label:"Congo, Republic of the",phone:"242"},{ioc:"CAF",iso2:"CF",iso:"CAF",label:"Central African Republic",phone:"236"},{ioc:"COD",iso2:"CG",iso:"CGD",label:"Congo, Democratic Republic of the",phone:"243"},{ioc:"SUI",iso2:"CH",iso:"CHE",label:"Switzerland",phone:"41"},{ioc:"CIV",iso2:"CI",iso:"CIV",label:"Cote d'Ivoire",phone:"225"},{ioc:"COK",iso2:"CK",iso:"COK",label:"Cook Islands",phone:"682"},{ioc:"CHI",iso2:"CL",iso:"CHL",label:"Chile",phone:"56"},{ioc:"CMR",iso2:"CM",iso:"CMR",label:"Cameroon",phone:"237"},{ioc:"CHN",iso2:"CN",iso:"CHN",label:"China",phone:"86"},{ioc:"COL",iso2:"CO",iso:"COL",label:"Colombia",phone:"57"},{ioc:"CRC",iso2:"CR",iso:"CRI",label:"Costa Rica",phone:"506"},{ioc:"CUB",iso2:"CU",iso:"CUB",label:"Cuba",phone:"53"},{ioc:"CPV",iso2:"CV",iso:"CPV",label:"Cape Verde",phone:"238"},{ioc:"CUW",iso2:"CW",iso:"CUW",label:"Curacao",phone:"599"},{ioc:"CXR",iso2:"CX",iso:"CXR",label:"Christmas Island",phone:"61"},{ioc:"CYP",iso2:"CY",iso:"CYP",label:"Cyprus",phone:"357"},{ioc:"CZE",iso2:"CZ",iso:"CZE",label:"Czech Republic",phone:"420"},{ioc:"GER",iso2:"DE",iso:"DEU",label:"Germany",phone:"49",suggested:!0},{ioc:"DJI",iso2:"DJ",iso:"DJI",label:"Djibouti",phone:"253"},{ioc:"DEN",iso2:"DK",iso:"DNK",label:"Denmark",phone:"45"},{ioc:"DMA",iso2:"DM",iso:"DMA",label:"Dominica",phone:"1-767"},{ioc:"DOM",iso2:"DO",iso:"DOM",label:"Dominican Republic",phone:"1-809"},{ioc:"ALG",iso2:"DZ",iso:"DZA",label:"Algeria",phone:"213"},{ioc:"ECU",iso2:"EC",iso:"ECU",label:"Ecuador",phone:"593"},{ioc:"EST",iso2:"EE",iso:"ESE",label:"Estonia",phone:"372"},{ioc:"EGY",iso2:"EG",iso:"EGY",label:"Egypt",phone:"20"},{ioc:"",iso2:"EH",iso:"ESH",label:"Western Sahara",phone:"212"},{ioc:"ERI",iso2:"ER",iso:"ERI",label:"Eritrea",phone:"291"},{ioc:"ESP",iso2:"ES",iso:"ESP",label:"Spain",phone:"34"},{ioc:"ETH",iso2:"ET",iso:"ETH",label:"Ethiopia",phone:"251"},{ioc:"FIN",iso2:"FI",iso:"FIN",label:"Finland",phone:"358"},{ioc:"FIJ",iso2:"FJ",iso:"FJI",label:"Fiji",phone:"679"},{ioc:"FLK",iso2:"FK",iso:"FLK",label:"Falkland Islands (Malvinas)",phone:"500"},{ioc:"FSM",iso2:"FM",iso:"FSM",label:"Micronesia, Federated States of",phone:"691"},{ioc:"FAR",iso2:"FO",iso:"FRO",label:"Faroe Islands",phone:"298"},{ioc:"FRA",iso2:"FR",iso:"FRA",label:"France",phone:"33",suggested:!0},{ioc:"GAB",iso2:"GA",iso:"GAB",label:"Gabon",phone:"241"},{ioc:"GBR",iso2:"GB",iso:"GBR",label:"United Kingdom",phone:"44"},{ioc:"GRN",iso2:"GD",iso:"GRD",label:"Grenada",phone:"1-473"},{ioc:"GEO",iso2:"GE",iso:"GEO",label:"Georgia",phone:"995"},{ioc:"FGU",iso2:"GF",iso:"GUF",label:"French Guiana",phone:"594"},{ioc:"",iso2:"GG",iso:"GGY",label:"Guernsey",phone:"44"},{ioc:"",iso2:"GH",iso:"GHA",label:"Ghana",phone:"233"},{ioc:"GIB",iso2:"GI",iso:"GIB",label:"Gibraltar",phone:"350"},{ioc:"GRL",iso2:"GL",iso:"GRL",label:"Greenland",phone:"299"},{ioc:"GAM",iso2:"GM",iso:"GMB",label:"Gambia",phone:"220"},{ioc:"GUI",iso2:"GN",iso:"GIN",label:"Guinea",phone:"224"},{ioc:"GUD",iso2:"GP",iso:"GLP",label:"Guadeloupe",phone:"590"},{ioc:"GEQ",iso2:"GQ",iso:"GNQ",label:"Equatorial Guinea",phone:"240"},{ioc:"GRE",iso2:"GR",iso:"GRC",label:"Greece",phone:"30"},{ioc:"",iso2:"GS",iso:"SGS",label:"South Georgia and the South Sandwich Islands",phone:"500"},{ioc:"GUA",iso2:"GT",iso:"GTM",label:"Guatemala",phone:"502"},{ioc:"GUM",iso2:"GU",iso:"GUM",label:"Guam",phone:"1-671"},{ioc:"GBS",iso2:"GW",iso:"GNB",label:"Guinea-Bissau",phone:"245"},{ioc:"GUY",iso2:"GY",iso:"GUY",label:"Guyana",phone:"592"},{ioc:"HKG",iso2:"HK",iso:"HKG",label:"Hong Kong",phone:"852"},{ioc:"",iso2:"HM",iso:"HMD",label:"Heard Island and McDonald Islands",phone:"672"},{ioc:"HON",iso2:"HN",iso:"HND",label:"Honduras",phone:"504"},{ioc:"CRO",iso2:"HR",iso:"HRV",label:"Croatia",phone:"385"},{ioc:"HAI",iso2:"HT",iso:"HTI",label:"Haiti",phone:"509"},{ioc:"HUN",iso2:"HU",iso:"HUN",label:"Hungary",phone:"36"},{ioc:"INA",iso2:"ID",iso:"IDN",label:"Indonesia",phone:"62"},{ioc:"IRL",iso2:"IE",iso:"IRL",label:"Ireland",phone:"353"},{ioc:"ISR",iso2:"IL",iso:"ISR",label:"Israel",phone:"972"},{ioc:"",iso2:"IM",iso:"IMN",label:"Isle of Man",phone:"44"},{ioc:"IND",iso2:"IN",iso:"IND",label:"India",phone:"91"},{ioc:"",iso2:"IO",iso:"IOT",label:"British Indian Ocean Territory",phone:"246"},{ioc:"IRQ",iso2:"IQ",iso:"IRQ",label:"Iraq",phone:"964"},{ioc:"IRI",iso2:"IR",iso:"IRN",label:"Iran, Islamic Republic of",phone:"98"},{ioc:"ISL",iso2:"IS",iso:"ISL",label:"Iceland",phone:"354"},{ioc:"ITA",iso2:"IT",iso:"ITA",label:"Italy",phone:"39"},{ioc:"",iso2:"JE",iso:"JEY",label:"Jersey",phone:"44"},{ioc:"JAM",iso2:"JM",iso:"JAM",label:"Jamaica",phone:"1-876"},{ioc:"JOR",iso2:"JO",iso:"JOR",label:"Jordan",phone:"962"},{ioc:"JPN",iso2:"JP",iso:"JPN",label:"Japan",phone:"81",suggested:!0},{ioc:"KEN",iso2:"KE",iso:"KEN",label:"Kenya",phone:"254"},{ioc:"KGZ",iso2:"KG",iso:"KGZ",label:"Kyrgyzstan",phone:"996"},{ioc:"CAM",iso2:"KH",iso:"KHM",label:"Cambodia",phone:"855"},{ioc:"KIR",iso2:"KI",iso:"KIR",label:"Kiribati",phone:"686"},{ioc:"COM",iso2:"KM",iso:"COM",label:"Comoros",phone:"269"},{ioc:"SKN",iso2:"KN",iso:"KNA",label:"Saint Kitts and Nevis",phone:"1-869"},{ioc:"KOR",iso2:"KP",iso:"KOR",label:"Korea, Democratic People's Republic of",phone:"850"},{ioc:"PRK",iso2:"KR",iso:"PRK",label:"Korea, Republic of",phone:"82"},{ioc:"KUW",iso2:"KW",iso:"KWT",label:"Kuwait",phone:"965"},{ioc:"CAY",iso2:"KY",iso:"CYM",label:"Cayman Islands",phone:"1-345"},{ioc:"KAZ",iso2:"KZ",iso:"KAZ",label:"Kazakhstan",phone:"7"},{ioc:"LAO",iso2:"LA",iso:"LAO",label:"Lao People's Democratic Republic",phone:"856"},{ioc:"LIB",iso2:"LB",iso:"LBN",label:"Lebanon",phone:"961"},{ioc:"LCA",iso2:"LC",iso:"LCA",label:"Saint Lucia",phone:"1-758"},{ioc:"LIE",iso2:"LI",iso:"LIE",label:"Liechtenstein",phone:"423"},{ioc:"SRI",iso2:"LK",iso:"LKA",label:"Sri Lanka",phone:"94"},{ioc:"LBR",iso2:"LR",iso:"LBR",label:"Liberia",phone:"231"},{ioc:"LES",iso2:"LS",iso:"LSO",label:"Lesotho",phone:"266"},{ioc:"LTU",iso2:"LT",iso:"LTU",label:"Lithuania",phone:"370"},{ioc:"LUX",iso2:"LU",iso:"LUX",label:"Luxembourg",phone:"352"},{ioc:"LAT",iso2:"LV",iso:"LVA",label:"Latvia",phone:"371"},{ioc:"LBA",iso2:"LY",iso:"LBY",label:"Libya",phone:"218"},{ioc:"MAR",iso2:"MA",iso:"MAR",label:"Morocco",phone:"212"},{ioc:"MON",iso2:"MC",iso:"MCO",label:"Monaco",phone:"377"},{ioc:"MDA",iso2:"MD",iso:"MDA",label:"Moldova, Republic of",phone:"373"},{ioc:"MNE",iso2:"ME",iso:"MNE",label:"Montenegro",phone:"382"},{ioc:"",iso2:"MF",iso:"MAF",label:"Saint Martin (French part)",phone:"590"},{ioc:"MAD",iso2:"MG",iso:"MDG",label:"Madagascar",phone:"261"},{ioc:"MSH",iso2:"MH",iso:"MHL",label:"Marshall Islands",phone:"692"},{ioc:"MKD",iso2:"MK",iso:"MKD",label:"Macedonia, the Former Yugoslav Republic of",phone:"389"},{ioc:"MLI",iso2:"ML",iso:"MLI",label:"Mali",phone:"223"},{ioc:"MYA",iso2:"MM",iso:"MMR",label:"Myanmar",phone:"95"},{ioc:"MGL",iso2:"MN",iso:"MNG",label:"Mongolia",phone:"976"},{ioc:"MAC",iso2:"MO",iso:"MAC",label:"Macao",phone:"853"},{ioc:"NMA",iso2:"MP",iso:"NMP",label:"Northern Mariana Islands",phone:"1-670"},{ioc:"MRT",iso2:"MQ",iso:"MTQ",label:"Martinique",phone:"596"},{ioc:"MTN",iso2:"MR",iso:"MRT",label:"Mauritania",phone:"222"},{ioc:"MNT",iso2:"MS",iso:"MSR",label:"Montserrat",phone:"1-664"},{ioc:"MLT",iso2:"MT",iso:"MLT",label:"Malta",phone:"356"},{ioc:"MRI",iso2:"MU",iso:"MUS",label:"Mauritius",phone:"230"},{ioc:"MDV",iso2:"MV",iso:"MDV",label:"Maldives",phone:"960"},{ioc:"MAW",iso2:"MW",iso:"MWI",label:"Malawi",phone:"265"},{ioc:"MEX",iso2:"MX",iso:"MEX",label:"Mexico",phone:"52"},{ioc:"MAS",iso2:"MY",iso:"MYS",label:"Malaysia",phone:"60"},{ioc:"MOZ",iso2:"MZ",iso:"MOZ",label:"Mozambique",phone:"258"},{ioc:"NAM",iso2:"NA",iso:"NAM",label:"Namibia",phone:"264"},{ioc:"NCL",iso2:"NC",iso:"NCL",label:"New Caledonia",phone:"687"},{ioc:"NIG",iso2:"NE",iso:"NER",label:"Niger",phone:"227"},{ioc:"NFI",iso2:"NF",iso:"NFK",label:"Norfolk Island",phone:"672"},{ioc:"NGR",iso2:"NG",iso:"NGA",label:"Nigeria",phone:"234"},{ioc:"NCA",iso2:"NI",iso:"NIC",label:"Nicaragua",phone:"505"},{ioc:"NED",iso2:"NL",iso:"NLD",label:"Netherlands",phone:"31"},{ioc:"NOR",iso2:"NO",iso:"NOR",label:"Norway",phone:"47"},{ioc:"NEP",iso2:"NP",iso:"NPL",label:"Nepal",phone:"977"},{ioc:"NRU",iso2:"NR",iso:"NRU",label:"Nauru",phone:"674"},{ioc:"NIU",iso2:"NU",iso:"NIU",label:"Niue",phone:"683"},{ioc:"NZL",iso2:"NZ",iso:"NZL",label:"New Zealand",phone:"64"},{ioc:"OMA",iso2:"OM",iso:"OMN",label:"Oman",phone:"968"},{ioc:"PAN",iso2:"PA",iso:"PAN",label:"Panama",phone:"507"},{ioc:"PER",iso2:"PE",iso:"PER",label:"Peru",phone:"51"},{ioc:"FPO",iso2:"PF",iso:"PYF",label:"French Polynesia",phone:"689"},{ioc:"PNG",iso2:"PG",iso:"PNG",label:"Papua New Guinea",phone:"675"},{ioc:"PHI",iso2:"PH",iso:"PHL",label:"Philippines",phone:"63"},{ioc:"PAK",iso2:"PK",iso:"PAK",label:"Pakistan",phone:"92"},{ioc:"POL",iso2:"PL",iso:"POL",label:"Poland",phone:"48"},{ioc:"SPM",iso2:"PM",iso:"SPM",label:"Saint Pierre and Miquelon",phone:"508"},{ioc:"",iso2:"PN",iso:"PCN",label:"Pitcairn",phone:"870"},{ioc:"PUR",iso2:"PR",iso:"PRI",label:"Puerto Rico",phone:"1"},{ioc:"PLE",iso2:"PS",iso:"PSE",label:"Palestine, State of",phone:"970"},{ioc:"POR",iso2:"PT",iso:"PRT",label:"Portugal",phone:"351"},{ioc:"PLW",iso2:"PW",iso:"PLW",label:"Palau",phone:"680"},{ioc:"PAR",iso2:"PY",iso:"PRY",label:"Paraguay",phone:"595"},{ioc:"QAT",iso2:"QA",iso:"QAT",label:"Qatar",phone:"974"},{ioc:"REU",iso2:"RE",iso:"REU",label:"Reunion",phone:"262"},{ioc:"ROU",iso2:"RO",iso:"ROU",label:"Romania",phone:"40"},{ioc:"SRB",iso2:"RS",iso:"SRB",label:"Serbia",phone:"381"},{ioc:"RUS",iso2:"RU",iso:"RUS",label:"Russia",phone:"7"},{ioc:"RWA",iso2:"RW",iso:"RWA",label:"Rwanda",phone:"250"},{ioc:"KSA",iso2:"SA",iso:"SAU",label:"Saudi Arabia",phone:"966"},{ioc:"SOL",iso2:"SB",iso:"SLB",label:"Solomon Islands",phone:"677"},{ioc:"SEY",iso2:"SC",iso:"SYC",label:"Seychelles",phone:"248"},{ioc:"SUD",iso2:"SD",iso:"SDN",label:"Sudan",phone:"249"},{ioc:"SWE",iso2:"SE",iso:"SWE",label:"Sweden",phone:"46"},{ioc:"SIN",iso2:"SG",iso:"SGP",label:"Singapore",phone:"65"},{ioc:"HEL",iso2:"SH",iso:"SHN",label:"Saint Helena",phone:"290"},{ioc:"SLO",iso2:"SI",iso:"SVN",label:"Slovenia",phone:"386"},{ioc:"",iso2:"SJ",iso:"SJM",label:"Svalbard and Jan Mayen",phone:"47"},{ioc:"SVK",iso2:"SK",iso:"SVK",label:"Slovakia",phone:"421"},{ioc:"SLE",iso2:"SL",iso:"SLE",label:"Sierra Leone",phone:"232"},{ioc:"SMR",iso2:"SM",iso:"SMR",label:"San Marino",phone:"378"},{ioc:"SEN",iso2:"SN",iso:"SEN",label:"Senegal",phone:"221"},{ioc:"SOM",iso2:"SO",iso:"SOM",label:"Somalia",phone:"252"},{ioc:"SUR",iso2:"SR",iso:"SUR",label:"Suriname",phone:"597"},{ioc:"",iso2:"SS",iso:"SSD",label:"South Sudan",phone:"211"},{ioc:"STP",iso2:"ST",iso:"STP",label:"Sao Tome and Principe",phone:"239"},{ioc:"ESA",iso2:"SV",iso:"SLV",label:"El Salvador",phone:"503"},{ioc:"",iso2:"SX",iso:"SMX",label:"Sint Maarten",phone:"1-721"},{ioc:"SYR",iso2:"SY",iso:"SYR",label:"Syria",phone:"963"},{ioc:"",iso2:"SZ",iso:"SWZ",label:"Swaziland",phone:"268"},{ioc:"TKS",iso2:"TC",iso:"TCA",label:"Turks and Caicos Islands",phone:"1-649"},{ioc:"CHA",iso2:"TD",iso:"TCD",label:"Chad",phone:"235"},{ioc:"",iso2:"TF",iso:"ATF",label:"French Southern Territories",phone:"262"},{ioc:"TOG",iso2:"TG",iso:"TGO",label:"Togo",phone:"228"},{ioc:"THA",iso2:"TH",iso:"THA",label:"Thailand",phone:"66"},{ioc:"TJK",iso2:"TJ",iso:"TJK",label:"Tajikistan",phone:"992"},{ioc:"",iso2:"TK",iso:"TKL",label:"Tokelau",phone:"690"},{ioc:"TLS",iso2:"TL",iso:"TLS",label:"Timor-Leste",phone:"670"},{ioc:"TKM",iso2:"TM",iso:"TKM",label:"Turkmenistan",phone:"993"},{ioc:"TUN",iso2:"TN",iso:"TUN",label:"Tunisia",phone:"216"},{ioc:"TGA",iso2:"TO",iso:"TON",label:"Tonga",phone:"676"},{ioc:"TUR",iso2:"TR",iso:"TUR",label:"Turkey",phone:"90"},{ioc:"TTO",iso2:"TT",iso:"TTO",label:"Trinidad and Tobago",phone:"1-868"},{ioc:"TUV",iso2:"TV",iso:"TUV",label:"Tuvalu",phone:"688"},{ioc:"TPE",iso2:"TW",iso:"TWN",label:"Taiwan",phone:"886"},{ioc:"TAN",iso2:"TZ",iso:"TZA",label:"United Republic of Tanzania",phone:"255"},{ioc:"UKR",iso2:"UA",iso:"UKR",label:"Ukraine",phone:"380"},{ioc:"UGA",iso2:"UG",iso:"UGA",label:"Uganda",phone:"256"},{ioc:"USA",iso2:"US",label:"United States",phone:"1",suggested:!0,iso:"USA"},{ioc:"URU",iso2:"UY",iso:"URY",label:"Uruguay",phone:"598"},{ioc:"UZB",iso2:"UZ",iso:"UZB",label:"Uzbekistan",phone:"998"},{ioc:"",iso2:"VA",iso:"VAT",label:"Holy See (Vatican City State)",phone:"379"},{ioc:"VIN",iso2:"VC",iso:"VCT",label:"Saint Vincent and the Grenadines",phone:"1-784"},{ioc:"VEN",iso2:"VE",iso:"VEN",label:"Venezuela",phone:"58"},{ioc:"IVB",iso2:"VG",iso:"VGB",label:"British Virgin Islands",phone:"1-284"},{ioc:"ISV",iso2:"VI",iso:"VIR",label:"US Virgin Islands",phone:"1-340"},{ioc:"VIE",iso2:"VN",iso:"VNM",label:"Vietnam",phone:"84"},{ioc:"VAN",iso2:"VU",iso:"VUT",label:"Vanuatu",phone:"678"},{ioc:"WAF",iso2:"WF",iso:"WLF",label:"Wallis and Futuna",phone:"681"},{ioc:"SAM",iso2:"WS",iso:"WSM",label:"Samoa",phone:"685"},{ioc:"KOS",iso2:"XK",iso:"KOS",label:"Kosovo",phone:"383"},{ioc:"YEM",iso2:"YE",iso:"YEM",label:"Yemen",phone:"967"},{ioc:"MAY",iso2:"YT",iso:"MYT",label:"Mayotte",phone:"262"},{ioc:"RSA",iso2:"ZA",iso:"ZAF",label:"South Africa",phone:"27"},{ioc:"ZAM",iso2:"ZM",iso:"ZMB",label:"Zambia",phone:"260"},{ioc:"ZIM",iso2:"ZW",iso:"ZWE",label:"Zimbabwe",phone:"263"}];function zl({participant:e,withISO2:t,withIOC:r}){let{person:i,individualParticipants:n}=e;[i,n?.map(({person:e})=>e)].flat().filter(Boolean).forEach(function(e){let{nationalityCode:i}=e||{};if(i){let n=Yl.find(({iso:e})=>e===i);r&&n?.ioc&&!e.iocNationalityCode&&(e.iocNationalityCode=n.ioc),t&&n?.iso2&&!e.iso2NationalityCode&&(e.iso2NationalityCode=n.iso2),n?.label&&!e.countryName&&(e.countryName=n.label)}})}function Kl(e){let{tournamentRecord:t,participantId:r}=e,i=e.tournamentRecords||t&&{[t.tournamentId]:t}||{};for(let n of Object.values(i)){let e=n.participants?.find(e=>e.participantId===r);if(e)return{participant:e,tournamentId:n.tournamentId}}return{error:Sr}}function Jl(e){let{tournamentRecord:t,participantId:r}=e;if(r){let e=Kl({tournamentRecord:t,participantId:r});return e.participant??e}return e.element||e.drawDefinition||e.event||e.tournamentRecord||{error:$t}}function Ql(e){let{returnPreviousValues:t,itemSubTypes:r,itemType:i}=e,n=Jl(e);if(n.error)return n;if(r&&!Array.isArray(r))return{error:gi,context:{itemSubTypes:r}};if(!Array.isArray(n.timeItems))return{error:ii};let a=n.timeItems.filter(e=>e?.itemType===i).filter(e=>!r?.length||r.some(t=>e?.itemSubTypes?.includes(t))).sort((e,t)=>new Date(e.createdAt||void 0).getTime()-new Date(t.createdAt||void 0).getTime()),o=Wa(a.pop(),!1,!0);if(o){let e={timeItem:o,...ce};return t&&Object.assign(e,{previousItems:a}),e}return{info:wi}}function Xl({returnPreviousValues:e,drawDefinition:t,itemSubTypes:r,itemType:i}){if(!t)return{error:Ge};if(!t.timeItems)return{info:wi};let{timeItem:n,previousItems:a,info:o}=Ql({element:t,returnPreviousValues:e,itemSubTypes:r,itemType:i});return n&&{timeItem:n,previousItems:a}||{info:o}}function Zl({returnPreviousValues:e,itemSubTypes:t,itemType:r,event:i}){if(!i)return{error:ot};if(!i.timeItems)return{info:wi};let{timeItem:n,previousItems:a,info:o}=Ql({returnPreviousValues:e,element:i,itemSubTypes:t,itemType:r});return n&&{timeItem:n,previousItems:a}||{info:o}}function ep({returnPreviousValues:e,tournamentRecord:t,itemSubTypes:r,itemType:i}){if(!t)return{error:Ie};if(!t.timeItems)return{info:wi};let{timeItem:n,previousItems:a,info:o}=Ql({element:t,returnPreviousValues:e,itemSubTypes:r,itemType:i});return n&&{timeItem:n,previousItems:a}||{info:o}}function tp({returnPreviousValues:e,tournamentRecord:t,participantId:r,itemSubTypes:i,itemType:n}){if(!t)return{error:Ie};if(!r)return{error:Ir};let a=Kl({tournamentRecord:t,participantId:r});if(a.error)return a;let{participant:o}=a;if(!o?.timeItems)return{info:wi};let{timeItem:s,previousItems:c,info:u}=Ql({element:a.participant,returnPreviousValues:e,itemSubTypes:i,itemType:n});return s&&{timeItem:s,previousItems:c}||{info:u}}var rp={[Gl]:"groupParticipantIds",[jl]:"pairParticipantIds",[$l]:"teamParticipantIds"},ip={[Gl]:"groups",[$l]:"teams"};function np({withIndividualParticipants:e,convertExtensions:t,tournamentRecord:r,withSignInStatus:i,withScaleValues:n,withGroupings:a,internalUse:o,withISO2:s,withIOC:c}){let u,d=[],l={};for(let p of r.participants??[]){let e=p?.participantId;e&&sp({participantMap:l,participantId:e})}for(let p of r.participants??[]){let e=Wa(p,t,o),{participantId:r,individualParticipantIds:a,participantType:u}=e;if(l[r]){if(Object.assign(l[r].participant,e),a){let t=op({individualParticipantIds:a,participantCopy:e,participantMap:l,participantType:u,participantId:r});t.missingParticipantIds.length&&d.push(...t.missingParticipantIds)}if(i&&(l[r].participant.signedIn=ap(e)),n){let{ratings:t,rankings:i,seedings:n}=Qc({participant:e});l[r].participant.seedings=n,l[r].participant.rankings=i,l[r].participant.ratings=t}(c||s)&&zl({participant:l[r].participant,withISO2:s,withIOC:c})}else d.push(r)}if(e){!function({participantMap:e,template:t}){let r=Object.values(e);for(let i of r){let r=i.participant;if(r.individualParticipantIds?.length){r.individualParticipants=[];for(let i of r.individualParticipantIds){let n=e[i].participant;r.individualParticipants.push(t?Xc({template:t,source:n}):n)}}}}({participantMap:l,template:v(e)?e:void 0})}return a&&(u=Hl({participants:Object.values(l).map(({participant:e})=>e),participantsProfile:{convertExtensions:t},deepCopy:!1}).groupInfo),{missingParticipantIds:d,participantMap:l,groupInfo:u}}function ap(e){let{timeItem:t}=Ql({itemType:xl,element:e});return t?.itemValue===Ll}function op({individualParticipantIds:e,participantCopy:t,participantMap:r,participantType:i,participantId:n}){let a=[];for(let o of e){let s=r[o]?.participant;if(s){if(s[rp[i]].push(n),[$l,Gl].includes(i)){let{participantRoleResponsibilities:e,participantOtherName:r,participantName:n,participantId:a,teamId:o}=t;s[ip[i]].push({participantRoleResponsibilities:e,participantOtherName:r,participantName:n,participantId:a,teamId:o})}if(i===jl){let t=e.find(e=>e!==o);r[o].pairIdMap[n]=t,r[o].pairIdMap[t]=n}}else a.push(o)}return{missingParticipantIds:a}}function sp({participantMap:e,participantId:t}){if(e[t])return;let r={walkoverWins:0,defaultWins:0,walkovers:0,defaults:0,losses:0,wins:0};e[t]={structureParticipation:{},potentialMatchUps:{},scheduleConflicts:{},scheduleItems:[],participant:{groupParticipantIds:[],pairParticipantIds:[],teamParticipantIds:[],seedings:{},rankings:{},ratings:{},groups:[],teams:[]},statistics:{},opponents:{},pairIdMap:{},matchUps:{},events:{},draws:{},counters:{[u]:{...r},[l]:{...r},[$l]:{...r},...r}}}function cp({participantsProfile:e,useParticipantMap:t,tournamentRecord:r,contextProfile:i,inContext:n}){if(t)return np({...e,...i,tournamentRecord:r});let a,o=Wa(r.participants,!1,!0)||[];if((e?.withIOC||e?.withISO2)&&o.forEach(t=>zl({participant:t,...e})),(n||e?.withGroupings)&&o?.length&&({participantsWithGroupings:o,groupInfo:a}=Hl({participantsProfile:e,deepCopy:!1,participants:o})),e?.withScaleValues&&o?.length)for(let s of o){let{ratings:e,rankings:t}=Qc({participant:s});s.rankings=t,s.ratings=e}return{participants:o,groupInfo:a}}function up({onlySpecifiedPolicyTypes:e=!1,policyTypes:t=[],tournamentRecord:r,drawDefinition:i,structure:n,event:a}){if(!Array.isArray(t))return{error:Ot};let o={};return r&&s(r),a&&s(a),i&&s(i),n&&s(n),{appliedPolicies:o,...ce};function s(r){let i=r?.extensions?.find(e=>e.name===Nu)?.value;if(i)for(let n of Object.keys(i))(e?t.includes(n):!t.length||t.includes(n))&&(o[n]=Wa(i[n],!1,!0))}}function dp({policyTypes:e=[],tournamentRecord:t,drawDefinition:r,structure:i,event:n}){if(!Array.isArray(e))return{error:Ot};let{appliedPolicies:a}=up({tournamentRecord:t,drawDefinition:r,structure:i,event:n}),o={};for(let s of e){let e=a?.[s];e&&(o[s]=e)}return Object.keys(o).length?{policyDefinitions:o}:{info:Bt.message}}var lp="WALKOVER",pp="RETIRED",mp="COMPETITIVE",fp="ROUTINE",hp="DECISIVE",gp="winRatio",Ip={[eu]:{policyName:"Competitive Bands Default",profileBands:{[hp]:20,[fp]:50}}};function Up({policyDefinitions:e,tournamentRecord:t,contextProfile:r,drawDefinition:i,event:n}){let a={policies:{}};if(!r)return a;let o=dp({tournamentRecord:t,drawDefinition:i,event:n}).policyDefinitions;if(r.withCompetitiveness){let t=e?.[eu]??o?.[eu]??Ip[eu];a.policies[eu]=t}return a}function Sp({tournamentRecord:e,drawDefinition:t,policyType:r,structure:i,event:n}){if(!e)return{error:Ie};let{appliedPolicies:a}=up({tournamentRecord:e,drawDefinition:t,structure:i,event:n});return a?.[r]?{policy:a[r]}:{info:Bt?.message}}function vp({tournamentRecord:e,categoryName:t,categoryType:r,event:i}){t=t??i?.category?.categoryName??i?.category?.ageCategoryCode,r=r??i?.category?.categoryType??i?.category?.subType;let{policy:n}=Sp({policyType:cu,tournamentRecord:e,event:i}),a=(e?Ru({element:e,name:Yu}).extension:void 0)?.value,o=(i&&Ru({name:Yu,element:i}).extension)?.value;return{scheduleTiming:{tournamentScheduling:a,eventScheduling:o,categoryName:t,categoryType:r,policy:n}}}function yp({drawDefinition:e,attributes:t}){let{extension:r}=Ru({element:e,name:_u}),i=r?.value||{};return t.forEach(e=>{Object.keys(e).forEach(t=>{i[t]?Object.assign(i[t],e[t]):i[t]=e[t]})}),r={name:_u,value:i},vu({drawDefinition:e,extension:r}),{entryProfile:i}}function wp({drawDefinition:e}){let{extension:t}=Ru({element:e,name:_u});return{entryProfile:t?.value||{}}}var Pp="ALTERNATE",Tp="CONFIRMED",Dp="DIRECT_ACCEPTANCE",bp="FEED_IN",Mp="JUNIOR_EXEMPT",Rp="LUCKY_LOSER",Np="ORGANISER_ACCEPTANCE",Ap="QUALIFIER",Ep="SPECIAL_EXEMPT",Cp="UNGROUPED",Op="UNPAIRED",kp="WILDCARD",Fp="WITHDRAWN",xp=[Tp,Dp,Mp,Np,Ep],_p=[bp,Rp,Ap],Lp=[Tp,Dp,bp,Mp,Np,Ep,kp],Bp=[Tp,Dp,Mp,Rp,Ap,Np,Ep,kp],Vp=[Pp,Tp,Dp,bp,Mp,Rp,Np,Ap,"REGISTERED",Ep,Cp,Op,kp,Fp],Gp={ALTERNATE:Pp,CONFIRMED:Tp,DIRECT_ACCEPTANCE:Dp,DIRECT_ENTRY_STATUSES:Lp,DRAW_SPECIFIC_STATUSES:_p,EQUIVALENT_ACCEPTANCE_STATUSES:xp,FEED_IN:bp,JUNIOR_EXEMPT:Mp,LUCKY_LOSER:Rp,ORGANISER_ACCEPTANCE:Np,QUALIFIER:Ap,SPECIAL_EXEMPT:Ep,STRUCTURE_SELECTED_STATUSES:Bp,UNGROUPED:Cp,UNPAIRED:Op,VALID_ENTRY_STATUSES:Vp,WILDCARD:kp,WITHDRAWN:Fp};function jp({stage:e,drawDefinition:t}){let{entryProfile:r}=wp({drawDefinition:t}),i=Object.keys(r).includes(e);if(!i&&Qo.includes(e)){return yp({drawDefinition:t,attributes:[{[e]:{drawSize:void 0,alternates:!0}}]}),!0}return i}function $p({stage:e,drawDefinition:t,entryStatus:r}){return t.entries.reduce((t,i)=>i.entryStage===e&&i.entryStatus===r?t+1:t,0)}function qp({provisionalPositioning:e,placementGroup:t,drawDefinition:r,stageSequence:i,entryStatuses:n,structureId:a,roundTarget:o,stages:s,stage:c}){let u=r.entries?.reduce((e,t)=>{let r=Ru({name:Wu,element:t})?.extension?.value,a=c&&t.entryStage===c||s?.length&&t.entryStage&&s.includes(t.entryStage),u=!n||t.entryStatus&&n.includes(t.entryStatus),d=t.entryStageSequence??1;return!a||i&&d!==i||!u||o&&r&&o!==r?e:e.concat(t)},[])??[];if(a&&c===Jo){let{playoffEntries:i,error:n}=function({provisionalPositioning:e,drawDefinition:t,structureId:r}){let i=[],n=(t.links??[]).find(e=>e.linkType===ms&&e.target.structureId===r);if(n){let{finishingPositions:r,structureId:a}=n.source,{structure:o}=Vd({drawDefinition:t,structureId:a});o?.structureType===cs&&(o.structures??[]).forEach(t=>{let n=t.positionAssignments??[],{structureId:a}=t,o=a,s=Object.assign({},...n.map(e=>{let{participantId:t}=e,r=Ru({element:e,name:Ju}).extension?.value;return r&&t?{[t]:r}:void 0}).filter(Boolean)),c=Object.keys(s).reduce((t,r)=>{let i=s[r],n=i.groupOrder||e&&i.provisionalOrder;return t.includes(n)||t.push(n),t},[]).length===Object.keys(s).length,u=Object.keys(s).filter(t=>{let i=s[t],n=i.groupOrder||e&&i.provisionalOrder;return r?.includes(n)});(!e||c)&&u.forEach(t=>{let n=s[t],{groupOrder:a,provisionalOrder:c,GEMscore:u}=n,d=a||e&&c,l=[...r??[]].sort(g).indexOf(d)+1;i.push({entryStage:Jo,entryStatus:bp,placementGroup:l,groupingValue:o,participantId:t,GEMscore:u})})})}return{playoffEntries:i}}({provisionalPositioning:e,drawDefinition:r,structureId:a});return n&&console.log("playoff entries error"),(i?.length?i:u).filter(e=>!t||e.placementGroup===t)}return u}function Wp({provisionalPositioning:e,returnAllProxies:t,drawDefinition:r,structureId:i,structure:n}){let a,o=[];n||({structure:n,error:a}=Vd({drawDefinition:r,structureId:i}));let s=$d({structure:n}).positionAssignments;if(a||!n)return{seedAssignments:[],error:et};i||(i=n.structureId);let{stage:c,stageSequence:u}=n,d=c===Jo&&r&&qp({provisionalPositioning:e,drawDefinition:r,stageSequence:u,structureId:i,stage:c}),l=d?d.filter(e=>1===e.placementGroup).sort((e,t)=>(e.GEMscore<t.GEMscore?1:e.GEMscore>t.GEMscore&&-1)||0).map((e,t)=>{let r=t+1;return{participantId:e.participantId,seedValue:r,seedProxy:!0,seedNumber:r}}):[],p=l?.slice(0,t?l.length:s.length/2);return p.length?o=p:n.seedAssignments?o=n.seedAssignments:a=ze,{seedAssignments:o,stageSequence:u,seedLimit:n.seedLimit??n?.positionAssignments?.length,stage:c,error:a}}function Hp(e){if(!e)return;let{tieFormatId:t,tieFormats:r}=e;return e.tieFormat?e.tieFormat:t&&Array.isArray(r)?r.find(e=>e.tieFormatId===t):void 0}function Yp({item:e,drawDefinition:t,structure:r,event:i}){if(e){if(e.tieFormat)return e.tieFormat;if(e.tieFormatId){if(t.tieFormat)return t.tieFormat;let r=t.tieFormats?.find(t=>e.tieFormatId===t.tieFormatId);return r||(i.tieFormat?i.tieFormat:i.tieFormats?.find(t=>e.tieFormatId===t.tieFormatId))}if(r?.tieFormat)return r.tieFormat;if(r?.tieFormatId){let e=t.tieFormats?.find(e=>r.tieFormatId===e.tieFormatId);if(e)return e}}}function zp({drawDefinition:e,structure:t,matchUp:r,event:i}){return{tieFormat:Yp({item:r,drawDefinition:e,structure:t,event:i})||Yp({item:t,drawDefinition:e,structure:t,event:i})||Hp(e)||Hp(i)}}function Kp({drawDefinition:e,structure:t}){let r={},i=[];return(e?.structures??[t]).filter(e=>e&&"object"==typeof e).forEach(e=>{if(!e)return;let{structureId:t,matchUps:n,structures:a}=e,o=Array.isArray(a);if(o)o&&a.forEach(e=>{let{structureName:n}=e,a=e.matchUps;r[e.structureId]={matchUps:a,itemStructureIds:[],structureName:n},a&&(i.push(...a),a.forEach(e=>{e.tieMatchUps&&i.push(...e.tieMatchUps)})),r[t]||(r[t]={itemStructureIds:[],matchUps:[]}),r[t].itemStructureIds||(r[t].itemStructureIds=[]),r[t].itemStructureIds.push(e.structureId)});else{let e=n;r[t]={matchUps:e,itemStructureIds:[]},e?.forEach(e=>{i.push(e),e.tieMatchUps&&i.push(...e.tieMatchUps)})}}),{mappedMatchUps:r,drawMatchUps:i}}function Jp({mappedMatchUps:e,matchUpsMap:t,structureId:r,inContext:i}){let n=(e=t?.mappedMatchUps??e)[r],a=(n?.itemStructureIds||[]).map(t=>{let{matchUps:n,structureName:a}=e[t];return i?n.map(e=>Object.assign(Wa(e,!0,!0),{containerStructureId:r,structureId:t,structureName:a})):n}).flat();return(n?.matchUps||[]).concat(...a)}function Qp({groupedOrder:e,roundPositionsCount:t}){if(!e||e?.length<=t)return e;let r=re(e,e.length/t).map(e=>e.reduce((e,t)=>e+t)),i=r.slice().sort(g);return r.map(e=>i.indexOf(e)+1)}function Xp(e){if(!v(e))return!1;let{matchUpId:t,drawPositions:r}=e,i="string"==typeof t,n=!r||Array.isArray(r)&&r.length<=2&&r.every(e=>F(e)||null==e);return i&&n}function Zp(e){return!!Array.isArray(e)&&e.every(Xp)}function em({matchUps:e=[],interpolate:t}){if(!Zp(e))return{roundMatchUps:[],error:gi};let r=e.reduce((e,t)=>{let r="string"==typeof t.roundNumber?I(t.roundNumber):t.roundNumber;return!t.roundNumber||e.includes(r)?e:e.concat(r)},[]).sort(g).map(t=>{let r=e.filter(e=>e.roundNumber===t),i=r.find(({matchUpType:e})=>e===m)?r.filter(({matchUpType:e})=>e===m):r;return{[t]:(n=i,n.sort((e,t)=>g(e.roundPosition,t.roundPosition)))};var n}),i=e.reduce((e,t)=>{let r="string"==typeof t.roundNumber?I(t.roundNumber):t.roundNumber;return e[r]||(e[r]=wn({abbreviatedRoundName:t.abbreviatedRoundName,finishingRound:t.finishingRound,roundName:t.roundName})),e},{}),n=Object.assign({},...r);if(t){let e=Math.max(...Object.keys(n).map(e=>I(e)).filter(e=>!Number.isNaN(e))),t=n[e]?.length;if(t>1&&M(t)){let r=e+1;K(r,r+t/2).forEach((e,r)=>{n[e]=K(0,t/(2+2*r)).map(()=>({}))})}}let a=0,o=Object.assign({},...Object.keys(n).map(e=>{let t=n[e]?.length,r=n[e]?.filter(e=>!kd.includes(e.matchUpStatus)&&!e.score?.scoreStringSide1)?.length,i=t&&t===r;return a=Math.max(a,t),{[e]:{matchUpsCount:t,inactiveCount:r,inactiveRound:i}}})),s=0,c=0,u=Object.keys(n).map(e=>I(e)).filter(e=>!Number.isNaN(e));u.forEach(e=>{let t=n[e].sort((e,t)=>e.roundPosition-t.roundPosition),r=t.flatMap(e=>e?.drawPositions||[]);if(o[e].roundNumber=e,o[e].roundFactor=o[e].matchUpsCount?a/o[e].matchUpsCount:1,o[e].finishingRound=i[e]?.finishingRound,o[e].roundName=i[e]?.roundName,o[e].abbreviatedRoundName=i[e]?.abbreviatedRoundName,o[e].finishingPositionRange=n[e]?.[0]?.finishingPositionRange,1!==e&&o[e-1]){let r=o[e-1],i=r.drawPositions,n=r.matchUpsCount/o[e].matchUpsCount,a=re(i,n),s=t.map(t=>{let{roundPosition:r}=t,n=[...t.drawPositions||[],void 0,void 0].slice(0,2);if(!r)return n;let o=n?.filter(Boolean)||[];if(!o?.length)return[void 0,void 0];if(e<3&&2===o?.length)return n?.slice().sort(g);let s=Q(i,o).length!==o?.length;if(o?.length&&s)return 1===o?.length?[o[0],void 0]:n?.slice().sort(g);let c=2*(r-1);return a.slice(c,c+2).map(e=>function(e,t){return t?.find(t=>e.includes(t))}(e,o))});o[e].drawPositions=s?.flat(),o[e].pairedDrawPositions=s}else{let t=r.sort(g),i=re(t,2);o[e].drawPositions=t,o[e].pairedDrawPositions=i}o[e+1]?.matchUpsCount===o[e].matchUpsCount&&(o[e+1].feedRound=!0,o[e+1].feedRoundIndex=c,o[e].preFeedRound=!0,c+=1),o[e]&&!o[e].feedRound&&(o[e].roundIndex=s,s+=1)});let d=!!Object.values(o).some(({matchUpsCount:e})=>!M(e));return{hasNoRoundPositions:e.some(e=>!e.roundPosition),roundsNotPowerOf2:d,maxMatchUpsCount:a,roundMatchUps:n,roundNumbers:u,roundProfile:o,...ce}}function tm(e){if(!Array.isArray(e))return"";let t=e.filter(E);return t.length?L([Math.min(...t),Math.max(...t)]).join("-"):""}function rm({drawDefinition:e}){if("object"!=typeof e)return{error:ve};let t={},{structures:r=[],links:i=[]}=e||{},n=r.reduce((e,t)=>{let{stage:r}=t;return e[r]?e[r].push(t):e[r]=[t],e},{});for(let o of Object.keys(n)){let e=n[o].find(({stageSequence:e})=>1===e);if(!e)continue;let{structureId:r}=e;a({aggregator:{},targetRound:0,exitProfiles:t,exitProfile:"0",structureId:r,stage:o})}return{exitProfiles:t};function a({exitProfiles:e,exitProfile:t,structureId:n,targetRound:o,aggregator:s,stage:c}){e[n]||(e[n]=[]),"0"===t&&[zo,Jo].includes(c)||e[n].push(t);let u=i.filter(e=>e.source.structureId===n&&e.source.roundNumber>=o);for(let i of u){let n=i.source.roundNumber,o=i.target.roundNumber,c=i.target.structureId,u=r.find(e=>e.structureId===c).stage,d=[u,c,o,n].join("|");if(s[d])return;s[d]=!0,a({exitProfile:`${t}-${n}`,structureId:c,exitProfiles:e,targetRound:o,aggregator:s,stage:u})}}}function im({roundsNotPowerOf2:e,drawDefinition:t,structure:r,matchUps:i}){if(!r)return!1;i=i??r.matchUps??[],e=e??em({matchUps:i}).roundsNotPowerOf2;let n=!!r.positionAssignments?.find(({drawPosition:e})=>e)||!!i?.find(({drawPositions:e})=>e?.length);return(!t?.drawType||t.drawType!==Ds)&&!r?.structures&&e&&n}function nm({structure:e}){if(!e)return!1;let t=e.matchUps||e.roundMatchUps&&Object.values(e.roundMatchUps).flat(),r=!!t?.find(e=>e?.roundPosition),i=!!t?.find(e=>e?.drawPositions?.length);return!(e?.structures||e?.stage===Ko||t.length&&(r||i))}var am={[au]:{policyName:"Round Naming Default",namingConventions:{round:"Round",pre:"Pre"},qualifyingFinishMap:{1:"Final"},abbreviatedRoundNamingMap:{1:"F",2:"SF",4:"QF"},roundNamingMap:{1:"Final",2:"Semifinal",4:"Quarterfinal"},affixes:{roundNumber:"R",preFeedRound:"Q",preQualifying:"P"},stageConstants:{[Ho]:"",[Jo]:"P",[Yo]:"Q",[zo]:"C"}}},om=am;function sm({roundNamingPolicy:e,drawDefinition:t,structure:r,matchUps:i}){let{roundProfile:n,roundMatchUps:a}=em({matchUps:i}),{structureAbbreviation:o,stage:s}=r,c=nm({structure:r}),u=im({structure:r}),d=r.structures,l={},p=am[au],m=r.stage===Yo,f=m?Math.max(...(t?.structures??[]).filter(e=>e.stage===Yo).map(({stageSequence:e})=>e??1),0):0,h=(r.stageSequence??1)<f?r.stageSequence??1:"",g=h&&(e?.affixes?.preQualifying||p.affixes.preQualifying)||"",I=e?.roundNamingMap||p.roundNamingMap||{},U=e?.abbreviatedRoundNamingMap||p.abbreviatedRoundNamingMap||{},S=e?.affixes?.preFeedRound||p.affixes.preFeedRound,v=e?.affixes?.roundNumber||p.affixes.roundNumber,y=(e?.namingConventions||p.namingConventions).round,w=s&&s!==Ho?s[0]:"",P=e?.stageConstants||p.stageConstants,T=`${g}${s&&P?.[s]||w}${h}`,D=n?Object.keys(n):[],b=m&&P?.[Yo]?`${P?.[Yo]}-`:"";if(d||c||u)Object.assign(l,...D.map(e=>{let t=`${b}${y} ${e}`,r=`${v}${e}`;return{[e]:{roundName:t,abbreviatedRoundName:r}}}));else{let t=m&&(e?.qualifyingFinishMap||p?.qualifyingFinishMap||{});Object.assign(l,...D.map(e=>{if(!n?.[e])return;let{matchUpsCount:r,preFeedRound:i}=n[e],a=2*r,s=t?.[n?.[e].finishingRound]||t&&`${v}${a}`||I[r]||`${v}${a}`,c=i?`-${S}`:"",u=[T,o,`${s}${c}`].filter(Boolean).join("-"),d=`${U[r]||`${v}${a}`}${c}`,l=[T,o,d].filter(Boolean).join("-");return{[e]:{abbreviatedRoundName:l,roundName:u}}}))}return{roundNamingProfile:l,roundProfile:n,roundMatchUps:a}}var cm=(e,t)=>(e||0)+(t||0);function um(e,t){let r=Array.isArray(e)?e[0]:e;return Number.isNaN(r)&&lp||r<=t[hp]&&hp||r<=t[fp]&&fp||mp}function dm({score:e}){let t=e?.sets||[],r=t.reduce((e,t)=>(e[0]+=t.side1Score||0,e[1]+=t.side2Score||0,e),[0,0]),i=t.reduce((e,t)=>(e[0]+=t.side1TiebreakScore||0,e[1]+=t.side2TiebreakScore||0,e),[0,0]);return i.reduce(cm)&&(r[i[0]>i[1]?0:1]+=1),{sets:t,games:r,score:e}}function lm(e){let t=Math.min(...e.games),r=Math.max(...e.games);return Math.round(t/r*100)}function pm(e){return e.map(lm).sort().map(e=>parseFloat(e.toFixed(2)))}function mm({tournamentRecord:e,profileBands:t,matchUp:r}){if(!r)return{error:Et};let{score:i,winningSide:n}=r;if(!n)return{error:gi};let a=!t&&e&&Sp({policyType:eu,tournamentRecord:e}).policy,o=t||a?.profileBands||Ip[eu].profileBands,s=pm([dm({score:i})]),c=um(s,o),u=Array.isArray(s)?s[0]:s;return{...ce,competitiveness:c,pctSpread:u}}function fm({matchUp:e}){if(!e)return{error:Et};if(e&&!e.sides)return{error:Ct};if(e&&!e.hasContext)return{error:ni};let t=(e.sides??[])?.map(e=>e?.participantId).filter(Boolean),r=e.sides?.filter(e=>e.participant?.participantType===Vl).map(e=>e.participantId).filter(Boolean)??[],i=((e.sides??[])?.map(e=>e.participant?.individualParticipants).filter(Boolean)??[]).map(e=>(e??[]).map(e=>e?.participantId).filter(Boolean)),n=[...r,...i.flat()].filter(Boolean)??[];return{nestedIndividualParticipantIds:i,allRelevantParticipantIds:L(n.concat(t)).filter(Boolean)??[],individualParticipantIds:n,sideParticipantIds:t,...ce}}var hm="CHECK_IN",gm="CHECK_OUT",Im="SCHEDULE.ASSIGNMENT.VENUE",Um="SCHEDULE.ALLOCATION.COURTS",Sm="SCHEDULE.ASSIGNMENT.COURT",vm="SCHEDULE.COURT.ORDER",ym="SCHEDULE.DATE",wm="HOME_PARTICIPANT_ID",Pm="SCHEDULE.ASSIGN.OFFICIAL",Tm="SCHEDULE.TIME.SCHEDULED",Dm="SCHEDULE.TIME.START",bm="SCHEDULE.TIME.STOP",Mm="SCHEDULE.TIME.RESUME",Rm="SCHEDULE.TIME.END",Nm="SCHEDULE.TIME.MODIFIERS",Am="TO_BE_ANNOUNCED",Em="NEXT_AVAILABLE",Cm="FOLLOWED_BY",Om="AFTER_REST",km="RAIN_DELAY",Fm=[Am,Em,Cm,Om,km],xm="SCALE",_m="RATING",Lm="RANKING",Bm="SEEDING",Vm="PUBLISH",Gm="PUBLIC",jm="STATUS",$m={MUTUALLY_EXCLUSIVE_TIME_MODIFIERS:Fm,AFTER_REST:Om,ALLOCATE_COURTS:Um,ASSIGN_COURT:Sm,ASSIGN_OFFICIAL:Pm,ASSIGN_VENUE:Im,CHECK_IN:hm,CHECK_OUT:gm,COMPLETED_DATE:"COMPLETED.DATE",COURT_ORDER:vm,ELIGIBILITY:"ELIGIBILITY",END_TIME:Rm,FOLLOWED_BY:Cm,MEDICAL:"MEDICAL",MODIFICATION:"MODIFICATION",NEXT_AVAILABLE:Em,NOT_BEFORE:"NOT_BEFORE",OTHER:"other",PENALTY:"PENALTY",PUBLIC:Gm,PUBLISH:Vm,RANKING:Lm,RATING:_m,RAIN_DELAY:km,REGISTRATION:"REGISTRATION",RESUME_TIME:Mm,RETRIEVAL:"RETRIEVAL",SCALE:xm,SCHEDULE:"SCHEDULE",SCHEDULED_DATE:ym,SCHEDULED_TIME:Tm,SEEDING:Bm,START_TIME:Dm,STATUS:jm,STOP_TIME:bm,SUSPENSION:"SUSPENSION",TIME_MODIFIERS:Nm,TO_BE_ANNOUNCED:Am};function qm({matchUp:e}){if(!e)return{error:Et};if(!e.hasContext)return{error:ni};if(!e.sides||2!==e?.sides.filter(Boolean).length)return{error:Ct};let{nestedIndividualParticipantIds:t,allRelevantParticipantIds:r,sideParticipantIds:i}=fm({matchUp:e}),n=(e.timeItems??[]).filter(e=>e?.itemType&&[hm,gm].includes(e.itemType)).sort((e,t)=>(e.createdAt?new Date(e.createdAt).getTime():0)-(t.createdAt?new Date(t.createdAt).getTime():0)),a=n.map(e=>e.itemValue).filter(e=>n.filter(t=>t?.itemValue===e).reverse()[0].itemType===hm);t?.forEach((e,t)=>{let r=i?.[t],n=e?.length&&e.every(e=>a.includes(e));r&&n&&!a.includes(r)&&a.push(r)}),i?.forEach((e,r)=>{a.includes(e)&&(t?.[r]??[]).forEach(e=>{e&&!a.includes(e)&&a.push(e)})});let o=i?.reduce((e,t)=>a.includes(t)&&e,!0);return{allRelevantParticipantIds:r,allParticipantsCheckedIn:o,checkedInParticipantIds:a,...ce}}var Wm=e=>t=>{let r=v(t)&&t?.matchUpType||S(t)&&t;return r&&h[e].includes(r)};function Hm(e){let{matchUpAverageTimes:t,matchUpFormat:r}=e||{},i=t?.map(({matchUpFormatCodes:e})=>e?.filter(e=>e===r)).flat().filter(Boolean).sort((e,t)=>(e?.length||0)-(t?.length||0))||[],n=i.includes(r)?r:i[0];return t?.find(({matchUpFormatCodes:e,averageTimes:t})=>e?.find(e=>n===e)&&t)?.averageTimes}function Ym(e){let{matchUpRecoveryTimes:t,averageMinutes:r,matchUpFormat:i}=e||{};return t?.find(({matchUpFormatCodes:e,averageTimes:t,recoveryTimes:n})=>{if(t&&r){let{greaterThan:e=0,lessThan:i=360}=t;if(r>e&&r<i)return!0}return e?.find(e=>e===i)&&n})?.recoveryTimes}function zm({timesBlockArray:e,categoryName:t,categoryType:r}){return e.filter(e=>Array.isArray(e)).map(e=>e.sort((e,t)=>(t.categoryNames?.length||0)-(e.categoryNames?.length||0)).find(({categoryTypes:e,categoryNames:i})=>!i?.length&&!e?.length||i?.includes(t)||e?.includes(r))).find(Boolean)}var Km="DOUBLES_SINGLES",Jm="SINGLES_DOUBLES",Qm="total",Xm="participantConflict",Zm="matchUpConflict",ef="courtDoubleBooking",tf="ISSUE_IDS",rf="CONFLICT",nf="WARNING",af="ERROR",of="ISSUE",sf="STATE",cf={SINGLES_DOUBLES:Jm,DOUBLES_SINGLES:Km,TOTAL:Qm,CONFLICT_MATCHUP_ORDER:Zm,CONFLICT_PARTICIPANTS:Xm,CONFLICT_COURT_DOUBLE_BOOKING:ef,SCHEDULE_ISSUE_IDS:tf,SCHEDULE_CONFLICT:rf,SCHEDULE_WARNING:nf,SCHEDULE_ERROR:af,SCHEDULE_ISSUE:of,SCHEDULE_STATE:sf,BLOCKED:"BLOCKED",PRACTICE:"PRACTICE",MAINTENANCE:"MAINTENANCE"};function uf({defaultAverageMinutes:e=90,defaultRecoveryMinutes:t=0,tournamentRecord:r,matchUpFormat:i,categoryName:n,categoryType:a,eventType:o,event:s}){if(!r)return{error:Ie};o=o??s?.eventType??Vo;let c={averageTimes:[{minutes:{default:e}}],recoveryTimes:[{minutes:{default:t}}]},{scheduleTiming:u}=vp({tournamentRecord:r,categoryName:n,categoryType:a,event:s});return df({eventType:o,timingDetails:{...u,matchUpFormat:i,categoryType:a,defaultTiming:c}})}function df({timingDetails:e,eventType:t}){let r=function({matchUpFormat:e,categoryName:t,categoryType:r,defaultTiming:i,tournamentScheduling:n,eventScheduling:a,policy:o}){return zm({categoryName:t,categoryType:r,timesBlockArray:[a?.matchUpAverageTimes&&Hm({...a,matchUpFormat:e}),n?.matchUpAverageTimes&&Hm({...n,matchUpFormat:e}),o?.matchUpAverageTimes&&Hm({...o,matchUpFormat:e}),o?.defaultTimes?.averageTimes,i?.averageTimes]})}(e),i=Object.keys(r?.minutes||{}),n=r?.minutes&&(i?.includes(t)&&r.minutes[t]||r.minutes.default),a=function({tournamentScheduling:e,eventScheduling:t,averageMinutes:r,defaultTiming:i,matchUpFormat:n,categoryName:a,categoryType:o,policy:s}){return zm({categoryName:a,categoryType:o,timesBlockArray:[t?.matchUpRecoveryTimes&&Ym({...t,averageMinutes:r,matchUpFormat:n}),e?.matchUpRecoveryTimes&&Ym({...e,averageMinutes:r,matchUpFormat:n}),s?.matchUpRecoveryTimes&&Ym({...s,averageMinutes:r,matchUpFormat:n}),s?.defaultTimes?.recoveryTimes,i?.recoveryTimes]})}({...e,averageMinutes:n}),o=Object.keys(a?.minutes||{}),s=a?.minutes&&(o?.includes(t)&&a.minutes[t]||a.minutes.default),c=Wm(Vo)(t)?Jm:Km;return{averageMinutes:n,recoveryMinutes:s,typeChangeRecoveryMinutes:a?.minutes&&(o?.includes(c)&&a.minutes[c]||s)}}function lf(e){return e.createdAt?new Date(e.createdAt).getTime():0}function pf({timeItems:e,itemType:t}){let r=e.filter(e=>e&&e.itemType===t).sort((e,t)=>lf(e)-lf(t)).pop(),i=r&&lf(r);return{itemValue:r?.itemValue,timeStamp:i}}function mf({timeStamp:e,schedule:t,matchUp:r}){let{itemValue:i,timeStamp:n}=pf({timeItems:r?.timeItems||[],itemType:Tm});return!t||n&&e&&new Date(n).getTime()>new Date(e).getTime()?{scheduledTime:i}:t}function ff({timeStamp:e,schedule:t,matchUp:r}){let{itemValue:i,timeStamp:n}=pf({timeItems:r?.timeItems||[],itemType:ym});return!t||n&&e&&new Date(n).getTime()>new Date(e).getTime()?{scheduledDate:i}:t}function hf(e){if(ia.test(e)){let t=da();return new Date(`${t}T${e}`)}return new Date(e)}function gf(e){let t=(e,t=2)=>("00"+e).slice(-t);return t(e/36e5|0)+":"+t(e%36e5/6e4|0)+":"+t(e%6e4/1e3|0)}function If(e){return parseInt(e)}function Uf({startTime:e="",endTime:t=""}={}){if(!(e&&t&&aa.test(e)&&aa.test(t)))return!1;let[r,i]=e.split(":").map(If),[n,a]=t.split(":").map(If);return!(n<r)&&!(r===n&&a<i)}function Sf(e,t){let[r,i]=e.startTime.split(":").map(If),[n,a]=t.startTime.split(":").map(If);return r<n?-1:r>n?1:i<a?-1:i>a?1:0}function vf({dateAvailability:e}){if(!e)return{error:Kt};if(!Array.isArray(e))return{error:zt};let t="Times must be 24 hour => 00:00";for(let r of e){if("object"!=typeof r)return{error:zt};let{date:e,startTime:i,endTime:n,bookings:a=[]}=r;if(!i||!n)return{error:zt};if(e&&!na.test(e))return{error:Jt,dateAvailability:{date:e},info:"Dates must be formated => YYYY-MM-DD"};if(!aa.test(i))return{error:Qt,dateAvailability:{startTime:i},info:t};if(!aa.test(n))return{error:Qt,dateAvailability:{endTime:n},info:t};if(i===n)return{error:Qt,dateAvailability:{startTime:i,endTime:n},info:"startTime and endTime are equivalent"};if(!Uf({startTime:i,endTime:n}))return{error:Qt,dateAvailability:{startTime:i,endTime:n},info:"endTime must be after startTime"};if(a){if(!Array.isArray(a))return{error:Yt};for(let e of a){if("object"!=typeof e)return{error:Yt};let{startTime:r,endTime:i}=e;if(!aa.test(r))return{error:Qt,booking:{startTime:r},info:t};if(!aa.test(i))return{error:Qt,booking:{endTime:i},info:t};if(r===i)return{error:Qt,dateAvailability:{startTime:r,endTime:i},info:"startTime and endTime are equivalent"};if(!Uf({startTime:r,endTime:i}))return{error:Qt,dateAvailability:{startTime:r,endTime:i},info:"endTime must be after startTime"}}}}return{valid:!0}}function yf(e){let{disableNotice:t,venue:r,context:i}=e;if("object"!=typeof r)return{error:gi};let n,a=Fl(e);r.venueId||(r.venueId=za());for(let o of Object.values(a)){let e=wf({disableNotice:!0,tournamentRecord:o,context:i,venue:r});if(e?.error)return e;n=e.venue}return t||rn({topic:Jd,payload:{venue:r}}),wn({...ce,venue:n})}function wf({tournamentRecord:e,disableNotice:t,context:r,venue:i}){if(!e)return{error:Ie};if(!i)return{error:$t,info:"missing venue"};if(e.venues||(e.venues=[]),i.venueId||(i.venueId=za()),e.venues.reduce((e,t)=>e||t.venueId===i.venueId,void 0))return{error:Hr};if(i.dateAvailability?.length){let e=vf({dateAvailability:i.dateAvailability});if(e.error)return e}if(i.defaultStartTime||i.defaultEndTime){if(!i.defaultStartTime||!i.defaultEndTime)return{error:gi,info:"both defaultStartTime and defaultEndTime are required"};if(!Uf({startTime:i.defaultStartTime,endTime:i.defaultEndTime}))return{error:gi,info:"defaultEndTime must be after defaultStartTime"}}return r&&Uu({element:i,extension:{value:r,name:Au}}),e.venues.push(i),t||rn({payload:{venue:i,tournamentId:e.tournamentId},topic:Jd}),{...ce,venue:Wa(i)}}function Pf({tournamentRecords:e,tournamentRecord:t,venueId:r}){if(!t)return{error:Ie};if(!r)return{error:zr};let i=(t.venues??[]).reduce((e,t)=>t.venueId===r?t:e,void 0);if(!i&&e){let n=(nd({tournamentRecords:e}).linkedTournamentIds??[])[t.tournamentId];for(let a of n){let n=Pf({tournamentRecord:e[a],venueId:r});if(n.success&&n.venue)return yf({tournamentRecord:t,venue:n.venue}),{...ce,venue:i}}}return i?{...ce,venue:i}:{error:Yr}}function Tf({convertExtensions:e,...t}){let{tournamentRecords:r,tournamentRecord:i,venueId:n}=t;return Wa(Pf({tournamentRecords:r,tournamentRecord:i,venueId:n}),e,!0)}function Df({tournamentRecords:e,tournamentRecord:t,courtId:r}){if(!t)return{error:Ie};if(!r)return{error:jt};let i,n;if((t.venues??[]).forEach(e=>{(e.courts??[]).forEach(t=>{t.courtId===r&&(i=t,n=e)})}),i)return{...ce,court:i,venue:n};if(e){let a=(nd({tournamentRecords:e}).linkedTournamentIds??[])[t.tournamentId];for(let o of a){let a=Df({tournamentRecord:e[o],courtId:r});if(a.success)return a.venue&&yf({tournamentRecord:t,venue:a.venue}),{...ce,court:i,venue:n}}}return Pn({result:{error:jr},stack:"findCourt"})}function bf(e){return Wa(Df(e),!1,!0)}function Mf({tournamentRecord:e,internalUse:t,courtId:r}){if(!e)return{error:Ie};if(!r)return{error:jt};let i=Df({tournamentRecord:e,courtId:r});if(i.error)return i;let n=i.court&&(({altitude:e,courtId:t,courtName:r,courtDimensions:i,latitude:n,longitude:a,surfaceCategory:o,surfaceType:s,surfacedDate:c,pace:u,notes:d})=>({altitude:e,courtId:t,courtName:r,courtDimensions:i,latitude:n,longitude:a,surfaceCategory:o,surfaceType:s,surfacedDate:c,pace:u,notes:d}))(i.court);return{...ce,courtInfo:Wa(n,!1,t)}}function Rf(e){let t=$c(e,[{[Js]:!0},{venueId:!0,[Dc]:zr}]);if(t.error)return t;let{tournamentRecord:r,venueId:i}=e,n=Pf({tournamentRecord:r,venueId:i});if(n.error)return n;let a=(n.venue?.courts??[]).map(e=>(({courtInfo:e})=>({...e}))(Mf({courtId:e.courtId,internalUse:!0,tournamentRecord:r}))),o=n.venue&&(({venueId:e,venueName:t,venueAbbreviation:r})=>({venueAbbreviation:r,venueName:t,venueId:e}))(n.venue),s=o&&{...o,courtsInfo:a};return{...ce,venueData:Wa(s,!1,!0)}}function Nf({event:e,eventId:t}){if(!e)return{error:ot};let r=Ru({name:Lu,element:e})?.extension,i=t?Wa(r?.value,!1,!0):r?.value;return t&&e.drawDefinitions?.forEach(e=>{i?.flights?.forEach(t=>{t.drawId===e.drawId&&Object.assign(t,{drawDefinition:e})})}),{flightProfile:i}}function Af(e){let t,{tournamentRecord:r,eventId:i,drawId:n}=e,a="findEvent",o={},s=e.tournamentRecords??(r&&{[r.tournamentId]:r})??{},c=Object.values(s).map(({events:e,tournamentId:t})=>(e&&e.forEach(e=>{o[e.eventId]={tournamentId:t}}),e??[])).flat();if(n){let e,r=c.find(r=>{let i=(r?.drawDefinitions??[]).find(e=>e.drawId===n);if(i)e=i,t=o[r.eventId].tournamentId;else{let e=(r&&Nf({event:r})?.flightProfile)?.flights?.find(e=>e.drawId===n);if(e)return t=o[r.eventId].tournamentId,{entries:e.drawEntries,drawName:e.drawName,tournamentId:t,drawId:n}}return i});if(r)return{event:r,drawDefinition:e,tournamentId:t}}if(i){let e=c.find(e=>e?.eventId===i);return e?(t=o[e.eventId].tournamentId,{event:e,drawDefinition:void 0,tournamentId:t}):{event:void 0,drawDefinition:void 0,...Pn({result:{error:st},stack:a})}}return{event:void 0,drawDefinition:void 0,...Pn({result:{error:Pe},context:{drawId:n,eventId:i},stack:a})}}function Ef(e){let t=e.event,r=e.matchUpType,{scheduleVisibilityFilters:i,afterRecoveryTimes:n,tournamentRecord:a,usePublishState:o,scheduleTiming:s,matchUpFormat:c,publishStatus:u,matchUp:d}=e;if(!d)return{error:Et};if(n&&!d.matchUpType&&!e.matchUpType&&(t||a)&&d.drawId){let i=e.drawDefinition||t?.drawDefinitions?.find(e=>e.drawId===d.drawId);!i&&a&&({drawDefinition:i,event:t}=Af({drawId:d.drawId,tournamentRecord:a}));let n=d.structureId&&i?.structures?.find(({structureId:e})=>e===d.structureId);r=e.matchUpType||n?.matchUpType||i?.matchUpType||t?.eventType!==$o&&t?.eventType}let l,{milliseconds:p,time:m}=function({matchUp:e}){if(!e)return{error:Et};if(!e.timeItems)return{error:ii};let t=e.timeItems.filter(e=>[Dm,bm,Mm,Rm].includes(e?.itemType)).sort((e,t)=>hf(e.itemValue).getTime()-hf(t.itemValue).getTime()),r=t.reduce((e,t)=>{let r,i=t?.itemType?.split("."),n=`SCHEDULE.TIME.${t?.itemType?.startsWith("SCHEDULE.TIME")&&i[2]}`;switch(n){case Dm:r=0;break;case Rm:if(e.lastValue&&[Dm,Mm].includes(e.lastType)){let i=hf(t.itemValue).getTime()-hf(e.lastValue).getTime();r=e.milliseconds+i}else r=e.milliseconds;break;case bm:if([Dm,"SCHECULE.TIME.RESUME"].includes(e.lastType)){let i=hf(t.itemValue).getTime()-hf(e.lastValue).getTime();r=e.milliseconds+i}else r=e.milliseconds;break;default:r=e.milliseconds}return{milliseconds:r,lastType:n,lastValue:t.itemValue}},{milliseconds:0,lastType:void 0,lastValue:void 0});if([Dm,Mm].includes(r.lastType)){let e=(new Date).getTime()-hf(r.lastValue).getTime();r.milliseconds+=e}return{milliseconds:r.milliseconds,time:gf(r.milliseconds),relevantTimeItems:t}}({matchUp:d}),{startTime:f}=function({matchUp:e}){let t=e?.timeItems||[],r=e=>e.createdAt?new Date(e.createdAt).getTime():0;return{startTime:t.reduce((e,t)=>{let i=t.itemType===Dm&&t;return i&&(!e||r(i)<r(e))?i:e},void 0)?.itemValue}}({matchUp:d}),{endTime:h}=function({matchUp:e}){let t=e?.timeItems||[],r=e=>e.createdAt?new Date(e.createdAt).getTime():0;return{endTime:t.reduce((e,t)=>{let i=t.itemType===Rm&&t;return i&&(!e||r(i)>r(e))?i:e},void 0)?.itemValue}}({matchUp:d}),{eventIds:g,drawIds:I}=i??{};if(g&&!g.includes(d.eventId)||I&&!I.includes(d.drawId))l=wn({milliseconds:p,startTime:f,endTime:h,time:m});else{let e=e=>e.createdAt?new Date(e.createdAt).getTime():0,t=new Map,i=d.timeItems?.toSorted((t,r)=>e(t)-e(r))??[];for(let r of i)t.set(r.itemType,r.itemValue);let o,u,g,I,U,S=t.get(wm),v=t.get(Um),y=t.get(Tm),w=t.get(Nm),P=t.get(ym),T=t.get(Pm),D=t.get(vm),b=t.get(Im),M=t.get(Sm),R=d.matchUpType??r;if(s&&y&&n&&R){let e={matchUpFormat:d.matchUpFormat??c,...s};({averageMinutes:u=0,recoveryMinutes:g=0,typeChangeRecoveryMinutes:I=0}=df({timingDetails:e,eventType:R})),(u||g)&&(o=h?Na(va(h),g):Na(y,u+g)),I&&(U=h?Na(va(h),I):Na(y,u+I))}!P&&y&&(P=ya(y));let N=oa({scheduledDate:P,scheduledTime:y}),A={},E=(a&&b&&Rf({tournamentRecord:a,venueId:b}))?.venueData||{};b&&(A[b]=E);let{venueName:C,venueAbbreviation:O,courtsInfo:k}=E,F=(M&&k?.find(e=>e.courtId===M))?.courtName;for(let r of v||[]){if(!a)break;r.venueId&&!A[r.venueid]&&(A[r.venueId]=Rf({venueId:r.venueId,tournamentRecord:a})?.venueData);let e=A[r.venueId];r.venueName=e?.venueName;let t=e?.courtsInfo?.find(e=>e.courtId===r.courtId);r.courtName=t?.courtName}l=wn({typeChangeTimeAfterRecovery:U,timeAfterRecovery:o,scheduledDate:P,scheduledTime:y,isoDateString:N,homeParticipantId:S,venueAbbreviation:O,allocatedCourts:v,timeModifiers:w,venueName:C,venueId:b,courtOrder:D,courtName:F,courtId:M,official:T,typeChangeRecoveryMinutes:I,recoveryMinutes:g,averageMinutes:u,milliseconds:p,startTime:f,endTime:h,time:m})}let{scheduledDate:U}=ff({matchUp:d}),{scheduledTime:S}=mf({matchUp:d});if(o&&u?.displaySettings?.draws){let e=u.displaySettings.draws,t=(e?.[d.drawId]??e?.default)?.scheduleDetails;if(t){let e=(t.find(e=>U&&e.dates?.includes(U))??t.find(e=>!e.dates?.length))?.attributes;if(e){l=Xc({source:l,template:Object.assign({},...Object.keys(l).map(e=>({[e]:!0})),e)})}}}return{schedule:l,endDate:d.matchUpStatus&&kd.includes(d.matchUpStatus)&&(ya(h)||ya(U)||ya(S))||void 0}}function Cf({collectionPosition:e,collectionId:t,lineUp:r}){let i=[],n=[];if(r){let a=e=>void 0===e?-1:e,o=r.map(r=>{let{collectionAssignments:i,participantId:n}=r,a=i?.find(r=>r.collectionPosition===e&&r.collectionId===t);return a&&{participantId:n,...a}}).filter(Boolean).sort((e,t)=>a(e.substitutionOrder)-a(t.substitutionOrder));for(let e of o){let{participantId:t,previousParticipantId:r,substitutionOrder:a}=e;i.includes(t)||(r&&n.push({previousParticipantId:r,substitutionOrder:a,participantId:t}),i=i.filter(e=>e!==r),i.push(t))}}return{assignedParticipantIds:i,substitutions:n}}function Of({tournamentParticipants:e,tournamentRecord:t,participantIds:r}){let i="getPairedParticipant";if(!e&&!t)return{error:Ie};if(!Array.isArray(r)||r.length>2)return{error:lr};if(!r.length)return Pn({result:{error:wr},stack:i});let n=(e=e??t?.participants??[]).filter(e=>e.participantType===jl&&Q(r,e.individualParticipantIds).length===r.length&&e.individualParticipantIds.length===r.length),a=n[0];if(!a)return Pn({result:{error:Sr},stack:i});let o=Wa(n.slice(1),!1,!0);return{participant:Wa(a),duplicatedPairParticipants:o,...ce}}function kf({drawDefinition:e,participantId:t}){if("object"!=typeof e)return{error:ye};if("string"!=typeof t)return{error:Ir};let{extension:r}=Ru({element:e,name:Vu});return{lineUp:(r?.value||{})[t]}}function Ff(e){let t=$c(e,[{[Pc]:!0}]);if(t.error)return t;let r=e?.matchUp,i=r?.matchUpType;if(!i&&r?.sides?.length){let e=r.sides.find(({participant:e})=>e)?.participant?.participantType;i=e===Vl&&u||e===jl&&l||e===$l&&$l||void 0}return{matchUpType:i}}function xf({drawPositionCollectionAssignment:e,sideNumberCollectionAssignment:t,positionAssignments:r,displaySideNumber:i,seedAssignments:n,drawPosition:a,isFeedRound:o,sideNumber:s}){let c=r.find(e=>e.drawPosition&&e.drawPosition===a),u=a&&e,d=s&&t,l=u?u[a]?.participantId:c?.participantId,p=c?function({displaySideNumber:e,seedAssignments:t,participantId:r,assignment:i,sideNumber:n}){let a={drawPosition:i.drawPosition,displaySideNumber:e,sideNumber:n};if(r){let e=function({seedAssignments:e,participantId:t}){return e?.find(e=>!e.seedProxy&&e.participantId===t)}({seedAssignments:t,participantId:r});Object.assign(a,e,{participantId:r}),e?.seedNumber&&""===e?.seedValue&&(a.seedValue="~")}else i.bye&&Object.assign(a,{bye:!0});return i.qualifier&&Object.assign(a,{qualifier:!0}),a}({displaySideNumber:i,seedAssignments:n,participantId:l,assignment:c,sideNumber:s}):{...d?.[s]};if(o&&(1===s?Object.assign(p,{participantFed:!0}):Object.assign(p,{participantAdvanced:!0})),a&&u){let e=u[a]?.teamParticipant,t=u[a]?.participant,r=u[a]?.substitutions;t&&(p.participant=t),r&&(p.substitutions=r),e&&(p.teamParticipant=e)}return p}function _f({scheduleVisibilityFilters:e,sourceDrawPositionRanges:t,tournamentParticipants:r,positionAssignments:i,drawPositionsRanges:n,hydrateParticipants:a,afterRecoveryTimes:o,initialRoundOfPlay:s,additionalContext:c,roundNamingProfile:d,tournamentRecord:p,tieDrawPositions:m,appliedPolicies:f,isCollectionBye:h,seedAssignments:U,usePublishState:S,participantMap:v,contextContent:y,scheduleTiming:w,contextProfile:P,drawDefinition:T,publishStatus:D,scoringActive:b,matchUpTieId:M,isRoundRobin:R,roundProfile:N,sideLineUps:A,structure:E,context:C,matchUp:O,event:k}){c=c??{};let x=zp({drawDefinition:T,structure:E,matchUp:O,event:k})?.tieFormat,{roundOffset:_,structureId:B,structureName:V,stage:G,stageSequence:j}=E,{drawId:$,drawName:q,drawType:W}=T??{},H=x?.collectionDefinitions,Y=O.collectionId&&H?.find(e=>e.collectionId===O.collectionId),z=O.collectionId?Y?.matchUpFormat:O.matchUpFormat??E?.matchUpFormat??T?.matchUpFormat??k?.matchUpFormat,K=O.matchUpType||Y?.matchUpType||E?.matchUpType||T?.matchUpType||!Wm($o)(k?.eventType)&&k?.eventType,J=h?"BYE":O.matchUpStatus,{schedule:Q,endDate:X}=Ef({scheduleVisibilityFilters:e,afterRecoveryTimes:o,tournamentRecord:p,usePublishState:S,scheduleTiming:w,drawDefinition:T,matchUpFormat:z,publishStatus:D,matchUpType:K,matchUp:O,event:k}),ee=m??O.drawPositions??[],{collectionPosition:te,collectionId:re,roundPosition:ie}=O,oe=O.roundNumber??c.roundNumber,se=re?function({tournamentParticipants:e,positionAssignments:t,collectionPosition:r,drawPositions:i=[],participantMap:n,drawDefinition:a,collectionId:o,sideLineUps:s,matchUpType:c}){if(!o||!r)return{};let u=({attribute:t,lineUp:i,teamParticipant:a})=>{let{assignedParticipantIds:s,substitutions:u}=Cf({collectionPosition:r,collectionId:o,lineUp:i});if(c!==l){let e=s?.[0];return e&&{[t]:{participantId:e,teamParticipant:a,substitutions:u}}}if(s?.length<=2){let r=n?.[s[0]]?.pairIdMap?.[s[1]],i=(r&&n[r]?.participant||Of({participantIds:s,tournamentParticipants:e}).participant)?.participantId;return{[t]:{participantId:i,teamParticipant:a,substitutions:u}}}if(s?.length>2)return{[t]:{teamParticipant:a,substitutions:u}}};if(!i?.length){let e=s?.map(e=>{let{teamParticipant:t,sideNumber:r}=e,i=e.lineUp||kf({participantId:t.teamParticipantId,drawDefinition:a})?.lineUp;return u({attribute:r,lineUp:i,teamParticipant:t})}).filter(Boolean)||{};return{sideNumberCollectionAssignment:Object.assign({},...e)}}let d=i?.map(r=>{let i=t.find(e=>e.drawPosition===r)?.participantId,o=s?.find(e=>e?.drawPosition===r),c=o?.teamParticipant||i&&n?.[i]?.participant||e?.find(({participantId:e})=>e===i),d=o?.lineUp||kf({participantId:i,drawDefinition:a})?.lineUp;return u({attribute:r,lineUp:d,teamParticipant:c})}).filter(Boolean)||{};return{drawPositionCollectionAssignment:Object.assign({},...d)}}({tournamentParticipants:r,positionAssignments:i,collectionPosition:te,participantMap:v,drawDefinition:T,drawPositions:ee,collectionId:re,sideLineUps:A,matchUpType:K}):void 0,ce=d?.[oe]?.roundName||c.roundName,ue=d?.[oe]?.abbreviatedRoundName||c.abbreviatedRoundName,de=N?.[oe]?.feedRound,le=N?.[oe]?.preFeedRound,pe=N?.[oe]?.roundFactor,me=n?.[oe],fe=ie?me?.[ie]:void 0,he=t?.[oe],ge=Y?.category?{...C?.category,...Y.category}:C?.category??k?.category,Ie=O.processCodes?.length&&O.processCodes||Y?.processCodes?.length&&Y?.processCodes||E?.processCodes?.length&&E?.processCodes||T?.processCodes?.length&&T?.processCodes||k?.processCodes?.length&&k?.processCodes||p?.processCodes,Ue=P?.withCompetitiveness&&mm({...y,matchUp:O}),Se=O.finishingPositionRange??c.finishingPositionRange,ve=G!==Yo&&F(s)&&s+(oe||0),ye=e=>wn(e,void 0,!0),we={...ye(C),...ye({matchUpFormat:K===$o?void 0:z,tieFormat:K===$o?x:void 0,gender:Y?.gender??k?.gender,endDate:O.endDate??X,discipline:k?.discipline,category:ge,finishingPositionRange:Se,abbreviatedRoundName:ue,drawPositionsRange:fe,competitiveProfile:Ue,structureName:V,stageSequence:j,drawPositions:ee,matchUpStatus:J,processCodes:Ie,isRoundRobin:R,matchUpTieId:M,preFeedRound:le,matchUpType:K,roundFactor:pe,roundOffset:_,structureId:B,roundNumber:oe,roundOfPlay:ve,feedRound:de,roundName:ce,drawName:q,drawType:W,schedule:Q,drawId:$,stage:G}),...Wa(ye(O),!0,!0)};if(z&&O.score?.scoreStringSide1){let e=Yn(z),{bestOf:t,finalSetFormat:r,setFormat:i}=e??{};(r?.tiebreakSet||i?.tiebreakSet||i?.timed)&&(we.score.sets=we.score.sets.sort((e,t)=>e.setNumber-t.setNumber).map((e,n)=>{let a=n+1===t&&r?r:i,o=a?.tiebreakSet&&!a?.timed,s=a?.timed;return o?(e.tiebreakSet=!0,[1,2].includes(e.winningSide)&&(e.side1Score=1===e.winningSide?1:0,e.side2Score=2===e.winningSide?1:0)):s&&(e.timed=!0),e}))}if(Array.isArray(ee)){let{orderedDrawPositions:e,displayOrder:t}=function({drawPositions:e,roundProfile:t,roundNumber:r}){let i=[void 0,void 0];if(ae(e))return{orderedDrawPositions:i,displayOrder:i};let n=t?.[r],a=n?.pairedDrawPositions?.find(t=>Z(t||[],e.filter(Boolean)))??i,o=n?.feedRound;if(ne(e)){let t=[...e].sort(g);return{orderedDrawPositions:2===t.length?t:a,displayOrder:o?t:a}}if(o){let t=[e.find(e=>!isNaN(I(e))),void 0];return{orderedDrawPositions:t,displayOrder:t}}return{orderedDrawPositions:a,displayOrder:a}}({drawPositions:ee,roundProfile:N,roundNumber:oe}),r=N?.[oe]?.feedRound,n=t[0]!==e[0],a=e.concat(void 0,void 0).slice(0,2).map((e,t)=>{let a=t+1,o=xf({...se,positionAssignments:i,displaySideNumber:n?3-a:a,seedAssignments:U,drawPosition:e,isFeedRound:r,sideNumber:a}),s=O.sides?.find(e=>e.sideNumber===a),c=ie?2*(ie-1)+t+1:void 0;return ye({sourceDrawPositionRange:c?he?.[c]:void 0,...s,...o})});Object.assign(we,Wa({sides:a},!0,!0))}if(r&&we.sides){let e=f?.[ou],t=t=>{let r=v?.[t]?.participant;return r&&Xc({template:e?.participant,source:r})};if(we.sides.filter(Boolean).forEach(e=>{if(e.participantId){let i=Wa(t(e.participantId)||(r?hu({policyDefinitions:f,participantId:e.participantId,tournamentParticipants:r,internalUse:!0,contextProfile:P}):void 0),void 0,!0);if(i){let t,r;if(T?.entries){let n=T.entries.find(t=>t.participantId===e.participantId),a=k?.entries?.find(t=>t.participantId===e.participantId);t=n?.entryStatus||a?.entryStatus,i.entryStatus=t,n?.entryStage&&(r=n.entryStage,i.entryStage=r)}!1===a?Object.assign(e,{participant:{entryStage:r,entryStatus:t}}):Object.assign(e,{participant:i})}}if(e?.participant?.individualParticipantIds?.length&&!e.participant.individualParticipants?.length){let i=e.participant.individualParticipantIds.map(e=>t(e)||(r?hu({policyDefinitions:f,tournamentParticipants:r,internalUse:!0,contextProfile:P,participantId:e}):void 0));!1!==a&&Object.assign(e.participant,{individualParticipants:i})}}),!we.matchUpType){let{matchUpType:e}=Ff({matchUp:we});e&&Object.assign(we,{matchUpType:e})}if(P?.inferGender&&(!we.gender||we.gender===bn)&&2===we.sides?.length&&we.matchUpType!==$o){let e=we.sides.map(e=>{if(Wm(u)(we.matchUpType))return e.participant?.person?.sex;if(2===e.participant?.individualParticipants?.length){let t=L(e.participant.individualParticipants.map(e=>e.person?.sex)).filter(Boolean);if(1===t.length)return t[0]}});if(2===e.filter(Boolean).length&&1===L(e).length){let t=e[0];we.inferredGender=t}}}if(we.tieMatchUps){let a="BYE"===we.matchUpStatus,o=we.sides?.map(({participant:e,drawPosition:t,sideNumber:r,lineUp:i})=>{let n=e?.participantType===$o&&e;return{teamParticipant:n&&wn({participantRoleResponsibilities:n.participantRoleResponsibilities,participantOtherName:n.participanOthertName,participantName:n.participantName,participantId:n.participantId,teamId:n.teamId}),drawPosition:t,sideNumber:r,lineUp:i}});we.tieMatchUps=we.tieMatchUps.map(c=>{let u=we.matchUpId,l={finishingPositionRange:we.finishingPositionRange,abbreviatedRoundName:ue,roundNumber:oe,roundName:ce};return _f({tieDrawPositions:ee,scheduleVisibilityFilters:e,sourceDrawPositionRanges:t,sideLineUps:o,drawPositionsRanges:n,initialRoundOfPlay:s,roundNamingProfile:d,additionalContext:l,appliedPolicies:f,isCollectionBye:a,usePublishState:S,publishStatus:D,matchUpTieId:u,isRoundRobin:R,roundProfile:N,matchUp:c,event:k,tournamentParticipants:r,positionAssignments:i,tournamentRecord:p,seedAssignments:U,participantMap:v,contextContent:y,scheduleTiming:w,contextProfile:P,drawDefinition:T,scoringActive:b,structure:E,context:C})})}let Pe=2===we.sides?.filter(e=>e?.participantId).length,Te=!we.winningSide;if(Object.assign(we,{readyToScore:b&&Pe&&Te,hasContext:!0}),Pe){let{allParticipantsCheckedIn:e,checkedInParticipantIds:t}=qm({matchUp:we});Object.assign(we,{allParticipantsCheckedIn:e,checkedInParticipantIds:t})}return Array.isArray(P?.exclude)&&P?.exclude.forEach(e=>delete we[e]),we}function Lf(e){if(!Array.isArray(e.matchUps))return[];let{matchUps:t,excludeMatchUpStatuses:r,hasParticipantsCount:i,isCollectionMatchUp:n,matchUpStatuses:a,hasWinningSide:o,matchUpFormats:s,roundPositions:c,matchUpFormat:u,collectionIds:d,isMatchUpTie:l,roundNumbers:m,matchUpIds:f,roundNames:h,filterMatchUpTypes:g=!0,filterMatchUpIds:I=!0,stageSequences:U,scheduledDates:S,scheduledDate:v,participantIds:y,processContext:w,tournamentIds:P,matchUpTypes:T,structureIds:D,readyToScore:b,courtIds:M,eventIds:R,venueIds:N,drawIds:A,stages:E}=e,C=Array.isArray(y)?y.filter(Boolean):[],O=Array.isArray(a)?a.filter(Boolean):[],k=Array.isArray(r)?r.filter(Boolean):[],F=Array.isArray(E)?E.filter(Boolean):[],x=Array.isArray(U)?U.filter(Boolean):[],_=Array.isArray(d)?d.filter(Boolean):[],L=Array.isArray(h)?h.filter(Boolean):[],B=Array.isArray(m)?m.filter(Boolean):[],V=Array.isArray(c)?c.filter(Boolean):[],G=Array.isArray(f)&&I?f.filter(Boolean):[],j=Array.isArray(T)&&g?T.filter(Boolean):[],$=Array.isArray(M)?M.filter(Boolean):[],q=Array.isArray(N)?N.filter(Boolean):[],W=Array.isArray(s)&&s.filter(Boolean)||"string"==typeof u&&[u]||[],H=Array.isArray(S)&&S.filter(Boolean)||"string"==typeof v&&v.length&&[v]||[],Y=Array.isArray(P)?P.filter(Boolean):[],z=Array.isArray(R)?R.filter(Boolean):[],K=Array.isArray(A)?A.filter(Boolean):[],J=Array.isArray(D)?D.filter(Boolean):[];return t.filter(e=>{if(b&&!Wm(p)(e)&&!e.readyToScore||e.winningSide&&o&&![1,2].includes(e.winningSide)||void 0!==l&&(l&&!e.tieMatchUps||!l&&e.tieMatchUps)||void 0!==n&&(n&&!e.collectionId||!n&&e.collectionId)||F.length&&!F.includes(e.stage)||x.length&&!x.includes(e.stageSequence)||_.length&&(!e.collectionId||!_.includes(e.collectionId))||L.length&&(!e.roundName||!L.includes(e.roundName))||B.length&&(!e.roundNumber||!B.includes(e.roundNumber))||V.length&&(!e.roundPosition||!V.includes(e.roundPosition))||O.length&&(!e.matchUpStatus||!O.includes(e.matchUpStatus))||k.length&&e.matchUpStatus&&k.includes(e.matchUpStatus)||G.length&&!G.includes(e.matchUpId)||j.length&&(!e.matchUpType||!se(j,e.matchUpType))||W.length&&(!e.matchUpFormat||!W.includes(e.matchUpFormat)))return!1;if(H?.length){let{scheduledTime:t}=mf({matchUp:e}),{scheduledDate:r}=ff({matchUp:e}),i=ya(t)||r;if(!H.some(e=>Ca(e,i)))return!1}if($.length){let{courtId:t}=function({timeStamp:e,schedule:t,matchUp:r}){let{itemValue:i,timeStamp:n}=pf({timeItems:r?.timeItems||[],itemType:Sm});return!t||n&&e&&new Date(n).getTime()>new Date(e).getTime()?{courtId:i}:t}({matchUp:e}),{allocatedCourts:r}=function({timeStamp:e,schedule:t,matchUp:r}){let{itemValue:i,timeStamp:n}=pf({timeItems:r?.timeItems||[],itemType:Um});return!t||n&&e&&new Date(n).getTime()>new Date(e).getTime()?{allocatedCourts:Wa(i,!1,!0)}:t}({matchUp:e}),i=r?.map(({courtId:e})=>e);if(!$.filter(Boolean).includes(t)||i?.includes(t))return!1}if(q.length){let{venueId:t}=function({timeStamp:e,schedule:t,matchUp:r}){let{itemValue:i,timeStamp:n}=pf({timeItems:r?.timeItems||[],itemType:Im});return!t||n&&e&&new Date(n).getTime()>new Date(e).getTime()?{venueId:i}:t}({matchUp:e});if(!q.filter(Boolean).includes(t))return!1}if(w){if(Y.length&&!Y.includes(e.tournamentId)||z.length&&!z.includes(e.eventId)||K.length&&!K.includes(e.drawId)||J.length&&!J.includes(e.structureId))return!1;let t=e.sides?.map(({participantId:e})=>e).filter(Boolean)??[];if(i&&t.length<i||C.length&&!C.some(e=>t.includes(e)))return!1}return!0})}function Bf(e){let{provisionalPositioning:t,tournamentRecord:r,contextFilters:i,matchUpFilters:n,contextProfile:a,drawDefinition:o,context:s={},structure:c,inContext:u,event:d}=e,{seedAssignments:l,contextContent:p,exitProfiles:m,matchUpsMap:f}=e,h={},I={};if(!c)return{collectionPositionMatchUps:h,error:rt,roundMatchUps:I,matchUps:[]};let U=Array.isArray(n?.eventIds)?n?.eventIds.filter(Boolean):[],S=Array.isArray(n?.structureIds)?n?.structureIds.filter(Boolean):[],v=Array.isArray(n?.drawIds)?n?.drawIds.filter(Boolean):[],y=!s?.eventId||!U?.length&&!i?.eventIds?.filter(Boolean).length||U?.includes(s.eventId)||i?.eventIds?.includes(s.eventId),w=!S?.length||S.includes(c.structureId),P=!o||!v?.length||v.includes(o.drawId);if(!y||!w||!P)return{collectionPositionMatchUps:h,roundMatchUps:I,matchUps:[]};a&&!p&&(p=Up({tournamentRecord:r,contextProfile:a,drawDefinition:o}));let{appliedPolicies:T}=up({drawDefinition:o}),D={...e.tournamentAppliedPolicies,...T,...e.policyDefinitions},b=D?.scoring?.structures,M=c.stage&&b?.stage?.[c.stage],R=c.stageSequence&&M?.stageSequence?.[c.stageSequence],N=D?.scoring?.requireAllPositionsAssigned||M?.requireAllPositionsAssigned||R?.requireAllPositionsAssigned;f||(f=Kp({drawDefinition:o,structure:c}));let{positionAssignments:A,allPositionsAssigned:E}=qd({structure:c}),C=!N||E,{seedAssignments:O}=Wp({provisionalPositioning:t,drawDefinition:o,structure:c});l=l??O;let{structureId:k}=c;m=m||o&&rm({drawDefinition:o}).exitProfiles;let F=m?.[k],x=F?.length&&(F[0].split("-").map(e=>parseInt(e)).reduce((e,t)=>e+t)||0),_=!!c.structures,B=Jp({matchUpsMap:f,structureId:k,inContext:u}),V=D?.[au],G=sm({roundNamingPolicy:V,drawDefinition:o,structure:c,matchUps:B}),{roundNamingProfile:j,roundProfile:$}=G;if(I=G?.roundMatchUps??[],n&&(B=Lf({matchUps:B,...n,filterMatchUpTypes:!1,filterMatchUpIds:!1})),u){let{sourceDrawPositionRanges:t}=function({drawDefinition:e,structureId:t,matchUpsMap:r}){if(!e)return{error:ye};if(!t)return{error:Ze};let{structure:i}=Vd({drawDefinition:e,structureId:t});if(i?.stage!==zo)return{error:mt,info:"Structure is not CONSOLATION stage"};let{links:n}=e,a=n?.filter(e=>e.target.structureId===t)||[],o=a?.reduce((e,t)=>{let{structureId:r}=t.source;return e.includes(r)?e:e.concat(r)},[])||[],s=Object.assign({},...o.map(e=>{let t=em({matchUps:Jp({structureId:e,matchUpsMap:r})}).roundProfile;return{[e]:t}})),c=Jp({matchUpsMap:r,structureId:t}),{roundProfile:u}=em({matchUps:c}),d={};return a?.forEach(e=>{let{structureId:t,roundNumber:r}=e.source,{feedProfile:i,groupedOrder:n,positionInterleave:a,roundNumber:o}=e.target,c=s[t],l=c[1]?.drawPositions,p=c[r]?.matchUpsCount;if(!p)return;let m=p?l.length/p:0,f=l.length/m,h=l.slice(),g=Qp({roundPositionsCount:f,groupedOrder:n}),I=g?.length||1;if(I<=f){let e=re(h,l.length/I);i===ps&&e.forEach(e=>e.reverse()),h=g?.length&&g?.map(t=>e[t-1]).flat()||e.flat()}let U=re(h,m);if(a){let e=K(0,a.interleave).map(()=>{}),t=K(0,a.offset).map(()=>{});U=U.map(t=>[t,...e]),U.unshift(t),U=U.flat(1);let r=U.length-a.offset;U=U.slice(0,r)}d[o]||(d[o]={});let S=u?.[o]?.feedRound?2:1;U.forEach((e,t)=>{let r=1+t*S;d[o][r]||(d[o][r]=tm(e))})}),{sourceDrawPositionRanges:d}}({drawDefinition:o,matchUpsMap:f,structureId:k}),n=o?function({drawDefinition:e,roundProfile:t,structureId:r,matchUpsMap:i}){if(!e)return{error:ye};if(!r)return{error:Ze};if(!t){let e=Jp({matchUpsMap:i,structureId:r});if(({roundProfile:t}=em({matchUps:e})),!t)return{error:$t}}let n=(Math.min(...t?.[1]?.drawPositions??[])||1)-1,a=Object.keys(t);return{drawPositionsRanges:Object.assign({},...(a||[]).map(e=>{let r=t?.[e]?.matchUpsCount,i=t?.[1]?.drawPositions??[],o=re(i,i.length/r),s=o.map(tm),c=o.map(e=>e.map(e=>e-n)).map(tm),u=a.map(i=>{if(i>e)return;let n=t?.[i]?.drawPositions??[];return re(n,n.length/r)}).filter(Boolean),d=K(0,r).map(e=>u.map(t=>t[e]).flat().filter(Boolean).sort(g)).map(e=>L(e)),l=d.map(e=>function(e){return e.reduce((e,t)=>{let r=e[e.length-1];return(!r||r[r.length-1]!==t-1)&&e.push([]),e[e.length-1].push(t),e},[])}(e).map(tm).join(", ")),p=Object.assign({},...K(0,r).map(e=>({[e+1]:{firstRoundDrawPositionsRange:s[e],firstRoundOffsetDrawPositionsRange:c[e],possibleDrawPositions:d[e],drawPositionsRange:l[e]}})));return{[e]:p}}))}}({drawDefinition:o,roundProfile:$,matchUpsMap:f,structureId:k}).drawPositionsRanges:void 0,m=e.tournamentParticipants,h=e.participantMap;!m?.length&&!h&&r&&({participants:m=[],participantMap:h}=cp({participantsProfile:e.participantsProfile,useParticipantMap:e.useParticipantMap,policyDefinitions:e.policyDefinitions,tournamentRecord:r,contextProfile:a,inContext:u})),B=B.map(i=>_f({scheduleVisibilityFilters:e.scheduleVisibilityFilters,hydrateParticipants:e.hydrateParticipants,afterRecoveryTimes:e.afterRecoveryTimes,usePublishState:e.usePublishState,scheduleTiming:e.scheduleTiming,publishStatus:e.publishStatus,sourceDrawPositionRanges:t,tournamentParticipants:m,positionAssignments:A,drawPositionsRanges:n,initialRoundOfPlay:x,roundNamingProfile:j,tournamentRecord:r,appliedPolicies:D,seedAssignments:l,contextContent:p,participantMap:h,contextProfile:a,drawDefinition:o,scoringActive:C,isRoundRobin:_,roundProfile:$,structure:c,context:s,matchUp:i,event:d})),(B?.filter(e=>Array.isArray(e.tieMatchUps))).forEach(e=>{let t=e.tieMatchUps;B=B.concat(...t)}),i&&(B=Lf({processContext:!0,...i,matchUps:B}))}else(B?.filter(e=>Array.isArray(e.tieMatchUps))).forEach(e=>{let t=e.tieMatchUps;B=B.concat(...t)});return n&&(B=Lf({matchUps:B,...n,filterMatchUpTypes:!1,filterMatchUpIds:!1})),(n?.matchUpTypes||n?.matchUpIds)&&(B=Lf({matchUpTypes:n.matchUpTypes,matchUpIds:n.matchUpIds,matchUps:B})),(n?.matchUpTypes||n?.matchUpIds||u)&&(I=em({matchUps:B}).roundMatchUps??[]),zp({drawDefinition:o,structure:c,event:d})?.tieFormat&&({collectionPositionMatchUps:h}=function({matchUps:e}){let t=e.reduce((e,t)=>!t.collectionPosition||e.includes(t.collectionPosition)?e:e.concat(t.collectionPosition),[]).map(t=>({[t]:e.filter(e=>e.collectionPosition===t)}));return{collectionPositionMatchUps:Object.assign({},...t)}}({matchUps:B})),{collectionPositionMatchUps:h,roundMatchUps:I,isRoundRobin:_,roundProfile:$,matchUpsMap:f,matchUps:B}}function Vf({matchUp:e}){return!!e&&(kd.includes(e?.matchUpStatus)||e?.winningSide)}function Gf({requireParticipants:e=!0,scheduleVisibilityFilters:t,tournamentAppliedPolicies:r,tournamentParticipants:i,hydrateParticipants:n,afterRecoveryTimes:a,policyDefinitions:o,tournamentRecord:s,usePublishState:c,matchUpFilters:u,contextFilters:d,contextContent:l,participantMap:p,scheduleTiming:f,publishStatus:h,contextProfile:g,drawDefinition:I,exitProfiles:U,matchUpsMap:S,structureId:v,inContext:y,structure:w,context:P,event:T}){!w&&v&&({structure:w}=Vd({drawDefinition:I,structureId:v}));let D=Bf({tournamentAppliedPolicies:r,scheduleVisibilityFilters:t,tournamentParticipants:i,hydrateParticipants:n,afterRecoveryTimes:a,policyDefinitions:o,tournamentRecord:s,usePublishState:c,matchUpFilters:u,contextFilters:d,contextContent:l,participantMap:p,scheduleTiming:f,publishStatus:h,contextProfile:g,drawDefinition:I,exitProfiles:U,matchUpsMap:S,structure:w,inContext:y,context:P,event:T}),b=[],M=[],R=[],N=[],A=[];if(D.error)return D;let E,{matchUps:C}=D,{assignedPositions:O}=qd({structure:w}),k=O?.filter(e=>e.participantId).map(e=>e.drawPosition);return C.filter(e=>{let t=1===u?.matchUpTypes?.length&&u.matchUpTypes[0]===m;return!(e.matchUpType!==m&&t)}).forEach(t=>{if(t.matchUpStatus===fd)return void b.push(t);t.matchUpType===m&&(E=!0);let r=!!t.collectionId,i=r&&t.sides?.every(e=>e.participantId),n=!r&&2===t.drawPositions?.filter(Boolean).length,a=!r&&t.drawPositions?.every(e=>k?.includes(e)),o=O?.filter(e=>e.bye).map(e=>e.drawPosition),s=!r&&t.drawPositions?.find(e=>o?.includes(e)),c=xd.includes(t.matchUpStatus)&&(i||n&&(!e||a));return s?A.push(t):Vf({matchUp:t})?M.push(t):c?R.push(t):N.push(t)}),{includesTeamMatchUps:E,abandonedMatchUps:b,completedMatchUps:M,upcomingMatchUps:R,pendingMatchUps:N,byeMatchUps:A,structure:w}}function jf({finishingPositions:e,linkCondition:t,linkType:r,source:i}){let n=i.find(i=>{let n=!i.source?.finishingPositions||!e||Z(e,i.source?.finishingPositions);return t===i.linkCondition&&n&&i.linkType===r});return[fs,hs].includes(n?.linkType)&&!n?.source?.roundNumber?Pn({result:{error:gi},stack:"getTargetLink",context:n}):n}function $f({drawDefinition:e,structureId:t,roundNumber:r}){return e?t?{links:(e.links||[]).filter(Boolean).reduce((e,i)=>(i.source?.structureId===t&&(!r||i.source.roundNumber===r)&&(e.source=e.source.concat(i)),i.target?.structureId===t&&(!r||i.target.roundNumber===r)&&(e.target=e.target.concat(i)),e),{source:[],target:[]})}:{error:Ze}:{error:ye}}function qf({sourceRoundMatchUpCount:e,inContextDrawMatchUps:t,sourceRoundPosition:r,drawDefinition:i,targetLink:n}){if(!n)return{error:Qe};let{target:{structureId:a,feedProfile:o,groupedOrder:s,roundNumber:c,positionInterleave:u}}=n,{structure:d}=Vd({drawDefinition:i,structureId:a}),{positionAssignments:l}=$d({structure:d}),p=(t?.filter(e=>e.structureId===d?.structureId)).filter(e=>e.roundNumber===c&&!e.matchUpTieId),m=p.length,f=K(1,m+1),h=m/e,g=Math.ceil(h*r),I=1-r%2;if(u?.interleave&&.5!==h){let e=r+(u.offset+(r-1)*u.interleave);g=Math.ceil(e/2),I=1-e%2}let U=f,S=f[g-1],v=Qp({roundPositionsCount:f.length,groupedOrder:s}),y=v?.length||1;if(y<=f.length){let e=re(f,m/y);o===ps&&e.forEach(e=>e.reverse()),U=v?.length&&v?.map(t=>e[t-1]).flat()||U}o===ls?S=U[g-1]:o===ps?((!v?.length||y>f.length)&&(g=p.length+1-g),S=U[g-1]):o===ds&&$i()&&console.log(Pi,{feedProfile:o});let w,P=S&&p.reduce((e,t)=>t.roundPosition===S?t:e,void 0);P?.feedRound?(I=0,w=Math.min(...(P.drawPositions||[]).filter(Boolean))):w=2===P?.drawPositions?.length&&P?.drawPositions[I];let T=l?.find(({drawPosition:e})=>e===w);if(T){let{extension:e}=Ru({element:T,name:ku});if(e?.value)return{disabledDrawPosition:w}}return{matchUp:P,targetDrawPosition:w,matchUpDrawPositionIndex:I}}function Wf({inContextDrawMatchUps:e=[],useTargetMatchUpIds:t,inContextMatchUp:r,drawDefinition:i,matchUpId:n}){let a=r;e.length&&!a&&(a=e.find(e=>e.matchUpId===n));let{structure:o}=Vd({structureId:a?.structureId,drawDefinition:i});return o?.finishingPosition===qs?function({inContextDrawMatchUps:e,useTargetMatchUpIds:t,drawDefinition:r,structure:i,matchUp:n}){let{winnerMatchUpId:a,loserMatchUpId:o}=n,{links:s}=function({drawDefinition:e,roundNumber:t,structureId:r}){if(!e)return{error:ye};if(!r)return{error:Ze};let{links:i}=$f({drawDefinition:e,structureId:r});return{links:{source:i.source.reduce((e,r)=>r.source.roundNumber&&r.source.roundNumber!==t?e:e.concat(r),[]),target:i.target.reduce((e,r)=>r.target.roundNumber&&r.target.roundNumber!==t?e:e.concat(r),[])}}}({roundNumber:n.roundNumber,structureId:i.structureId,drawDefinition:r}),c=s?.source,u=jf({source:c,linkType:fs}),d=jf({linkCondition:gs,linkType:hs,source:c}),l=jf({source:c,linkType:hs}),p=d&&l;l||(l=d);let m,f,h,g,I,U,S,v,y,w,P=u?.target?.feedProfile,T=l?.target?.feedProfile,D=d?.target?.feedProfile;if(t&&(a||o)&&(S=a&&P!==us&&e.find(({matchUpId:e})=>e===a),g=o&&T!==us&&e.find(({matchUpId:e})=>e===o),S||g))return{matchUp:n,targetLinks:{loserTargetLink:l,winnerTargetLink:u},targetMatchUps:{loserMatchUp:g,winnerMatchUp:S}};let{roundPosition:b}=n;w=w||e.filter(e=>e.structureId===i.structureId);let M=w.reduce((e,t)=>t.roundNumber!==n.roundNumber||t.matchUpTieId?e:e+1,0);return l&&!g&&T!==us&&({matchUpDrawPositionIndex:U,targetDrawPosition:I,matchUp:g}=qf({targetLink:l,sourceRoundMatchUpCount:M,inContextDrawMatchUps:e,sourceRoundPosition:b,drawDefinition:r})),p&&D!==us&&({matchUpDrawPositionIndex:h,targetDrawPosition:f,matchUp:m}=qf({targetLink:d,sourceRoundMatchUpCount:M,inContextDrawMatchUps:e,sourceRoundPosition:b,drawDefinition:r})),u&&!S&&P!==us&&({matchUpDrawPositionIndex:y,targetDrawPosition:v,matchUp:S}=qf({targetLink:u,sourceRoundMatchUpCount:M,inContextDrawMatchUps:e,sourceRoundPosition:b,drawDefinition:r})),S||(w=w||e.filter(e=>e.structureId===i.structureId),({matchUp:S}=function({structureMatchUps:e,matchUp:t}){let{roundNumber:r,roundPosition:i}=t,n=e.filter(e=>e.roundNumber===r&&!e.matchUpTieId),a=e.filter(e=>e.roundNumber===r+1&&!e.matchUpTieId);if(a.length){let e;return a.length===n.length?e=a.find(e=>e.roundPosition===i):a.length===n.length/2&&(e=a.find(e=>e.roundPosition===Math.ceil(i/2))),{matchUp:e}}return{message:"no progression found"}}({structureMatchUps:w,matchUp:n}))),wn({matchUp:n,targetLinks:{loserTargetLink:l,winnerTargetLink:u,byeTargetLink:d},targetMatchUps:{winnerMatchUpDrawPositionIndex:y,loserMatchUpDrawPositionIndex:U,byeMatchUpDrawPositionIndex:h,winnerTargetDrawPosition:v,loserTargetDrawPosition:I,byeTargetDrawPosition:f,winnerMatchUp:S,loserMatchUp:g,byeMatchUp:m},targetMatchUpIds:!(!a&&!o)})}({inContextDrawMatchUps:e,useTargetMatchUpIds:t,drawDefinition:i,structure:o,matchUp:a}):function({matchUp:e}){return{targetLinks:{loserTargetLink:void 0,winnerTargetLink:void 0},targetMatchUps:{loserMatchUp:void 0,winnerMatchUp:void 0},matchUp:e}}({matchUp:a})}function Hf({drawDefinition:e,inContextDrawMatchUps:t}){let r={};return t.forEach(i=>{let{matchUpId:n,structureId:a,drawPositions:o=[]}=i,{structure:s}=Vd({drawDefinition:e,structureId:a});if(s?.finishingPosition===$s){let{roundNumber:e}=i,t=e&&I(e)+1,r=s.matchUps??[],{roundMatchUps:n}=em({matchUps:r});if(t&&n?.[t]){let e=[...o].sort(g).map((e,r)=>{let i=n[t].find(t=>t.drawPositions?.includes(e));return{matchUpId:i?.matchUpId,roundNumber:t,schedule:i?.schedule,sideNumber:r+1,structureName:s.structureName}});Object.assign(i,{sidesTo:e})}}else{let a=Wf({useTargetMatchUpIds:!0,inContextDrawMatchUps:t,inContextMatchUp:i,drawDefinition:e,matchUpId:n}),{winnerMatchUp:o}=a.targetMatchUps,{loserMatchUp:s}=a.targetMatchUps;!i.winnerMatchUpId&&o&&(i.winnerMatchUpId=o.matchUpId),!i.loserMatchUpId&&s&&(i.loserMatchUpId=s.matchUpId);let c=zf({upcomingMatchUp:o}),u=zf({upcomingMatchUp:s});if("BYE"!==i.matchUpStatus&&"BYE"===s?.matchUpStatus){let{matchUp:r}=Yf({matchUp:s,drawDefinition:e,inContextDrawMatchUps:t})||{};u=r&&zf({upcomingMatchUp:r})||u}let d=i.schedule?.timeAfterRecovery;if(d&&(c?.schedule?.scheduledTime&&Ua(c.schedule.scheduledTime)<Ua(d)&&(r[c.matchUpId]=i.matchUpId,c.schedule.scheduleConflict=i.matchUpId),u?.schedule?.scheduledTime&&Ua(u.schedule.scheduledTime)<Ua(d)&&(r[u.matchUpId]=i.matchUpId,u.schedule.scheduleConflict=i.matchUpId)),Object.assign(i,{winnerTo:c,loserTo:u}),i.drawPositions?.filter(Boolean).length){let e=a.targetLinks?.loserTargetLink?.linkCondition===gs,r=function(e){return e?.sides?.map(({participant:e,participantId:t,qualifier:r})=>e||t&&{participantId:t}||r&&{qualifier:r}).filter(Boolean)||[]}(i);if(r.length){let i=ud(o?.sides),n=ud(s?.sides),c=r.find(({participantId:e})=>i.includes(e))?[]:r,u=r.find(({participantId:e})=>n.includes(e))?[]:r;s&&e&&u.length<2&&u.push({bye:!0,tbd:!0}),c?.length&&o&&(!a.targetMatchUpIds&&o&&(o=t.find(({matchUpId:e})=>e===o.matchUpId)),o.potentialParticipants||(o.potentialParticipants=[]),o.potentialParticipants.push(c)),u?.length&&s&&(a.targetMatchUpIds||(o=t.find(({matchUpId:e})=>e===s.matchUpId)),s.potentialParticipants||(s.potentialParticipants=[]),s.potentialParticipants.push(u))}}}}),Object.keys(r).length&&t.forEach(e=>{Object.keys(r).includes(e.matchUpId)&&(e.schedule.scheduleConflict=r[e.matchUpId])}),{scheduleConflictMatchUpIds:r}}function Yf({matchUp:e,drawDefinition:t,inContextDrawMatchUps:r}){let{matchUpId:i,matchUpStatus:n,structureId:a}=e||{};if(!e||!a||e?.matchUpStatus===Md)return{matchUp:e};if("BYE"===n){let n;return e.winnerMatchUpId?n=r.find(({matchUpId:t})=>t===e.winnerMatchUpId):({winnerMatchUp:n}=Wf({inContextDrawMatchUps:r,drawDefinition:t,matchUpId:i})?.targetMatchUps||{}),Yf({matchUp:n,drawDefinition:t,inContextDrawMatchUps:r})}return{matchUp:void 0}}function zf(e){if(e?.upcomingMatchUp)return(({matchUpId:e,structureId:t,schedule:r,roundNumber:i,roundPosition:n,structureName:a})=>({matchUpId:e,structureId:t,schedule:r,roundNumber:i,roundPosition:n,structureName:a}))(e.upcomingMatchUp)}function Kf(e){Object.assign(e,{requireParticipants:!1});let t=Jf(e);if(t.error)return Pn({result:t,stack:"getAllDrawMatchUps"});let{abandonedMatchUps:r,completedMatchUps:i,upcomingMatchUps:n,pendingMatchUps:a,byeMatchUps:o,matchUpsMap:s}=t;return{matchUps:(r??[]).concat(...i??[],...n??[],...a??[],...o??[]),matchUpsMap:s}}function Jf(e){if(!e?.drawDefinition)return{error:ye};let t,{tournamentParticipants:r,contextContent:i,matchUpsMap:n}=e,{scheduleVisibilityFilters:a,tournamentAppliedPolicies:o,requireParticipants:s,participantsProfile:c,afterRecoveryTimes:u,policyDefinitions:d,tournamentRecord:l,usePublishState:p,contextFilters:m,matchUpFilters:f,scheduleTiming:h,participantMap:g,publishStatus:I,contextProfile:U,drawDefinition:S,nextMatchUps:v,inContext:y,context:w,event:P}=e,T=[],D=[],b=[],M=[],R=[];U&&!i&&(i=Up({policyDefinitions:d,tournamentRecord:l,contextProfile:U,event:P})),!r?.length&&l&&(r=l?.participants,(y||c?.withGroupings)&&r?.length&&({participantsWithGroupings:r,groupInfo:t}=Hl({participants:r,participantsProfile:c})));let{structures:N}=Gd({drawDefinition:S});if(!N)return{error:et};n||(n=Kp({drawDefinition:S}));let A=S&&rm({drawDefinition:S}).exitProfiles;N.forEach(t=>{let{byeMatchUps:c=[],pendingMatchUps:N=[],upcomingMatchUps:E=[],completedMatchUps:C=[],abandonedMatchUps:O=[]}=Gf({matchUpFilters:v?void 0:f,contextFilters:v?void 0:m,inContext:y||v||m,hydrateParticipants:e.hydrateParticipants,tournamentAppliedPolicies:o,scheduleVisibilityFilters:a,tournamentParticipants:r,requireParticipants:s,afterRecoveryTimes:u,policyDefinitions:d,tournamentRecord:l,usePublishState:p,contextContent:i,participantMap:g,scheduleTiming:h,publishStatus:I,contextProfile:U,drawDefinition:S,exitProfiles:A,matchUpsMap:n,structure:t,context:w,event:P});T=T.concat(...O),D=D.concat(...C),b=b.concat(...E),M=M.concat(...N),R=R.concat(...c)});let E=e=>(!f&&!v&&!m||(f&&(e=Lf({matchUps:e,...f})),m&&(e=Lf({matchUps:e,...m,processContext:!0}))),e),C={abandonedMatchUps:E(T),completedMatchUps:E(D),upcomingMatchUps:E(b),pendingMatchUps:E(M),byeMatchUps:E(R),matchUpsMap:n,...ce,groupInfo:t};if(v){let e="object"==typeof v||{abandoned:!0,completed:!0,upcoming:!0,pending:!0,bye:!0},{abandoned:t,completed:r,upcoming:i,pending:n,bye:a}=e;Hf({inContextDrawMatchUps:[].concat(...t&&T||[],...r&&D||[],...i&&b||[],...n&&M||[],...a&&R||[]),drawDefinition:S})}return C}function Qf(e){let{participants:t=[],contextContent:r,participantMap:i}=e,{scheduleVisibilityFilters:n,tournamentAppliedPolicies:a,participantsProfile:o,afterRecoveryTimes:s,policyDefinitions:c,useParticipantMap:u,tournamentRecord:d,usePublishState:l,contextFilters:p,matchUpFilters:m,contextProfile:f,nextMatchUps:h,inContext:g,context:I,event:U}=e;if(!U)return{error:ot};let S,{eventId:v,eventName:y,endDate:w,eventType:P,category:T,gender:D,matchUpFormat:b}=U??{},M={...I,...wn({indoorOutDoor:U.indoorOutdoor??d?.indoorOutdoor,surfaceCategory:U.surfaceCategory??d?.surfaceCategory,endDate:U.endDate??d?.endDate,tournamentId:d?.tournamentId,matchUpFormat:b,eventName:y,eventType:P,category:T,eventId:v,gender:D})};if(w&&(M.endDate=w),f&&!r&&(r=Up({policyDefinitions:c,tournamentRecord:d,contextProfile:f,event:U})),!t?.length&&!i&&d){let e=cp({participantsProfile:o,useParticipantMap:u,policyDefinitions:c,tournamentRecord:d,contextProfile:f,inContext:g});i=e.participantMap,t=e.participants??[],S=e.groupInfo}let R=U.drawDefinitions??[],N=vp({tournamentRecord:d,event:U}).scheduleTiming;return{matchUps:R.flatMap(e=>{let{matchUps:u}=Kf({tournamentParticipants:t,tournamentAppliedPolicies:a,scheduleVisibilityFilters:n,context:M,participantsProfile:o,afterRecoveryTimes:s,policyDefinitions:c,tournamentRecord:d,usePublishState:l,contextFilters:p,contextProfile:f,drawDefinition:e,contextContent:r,matchUpFilters:m,participantMap:i,scheduleTiming:N,nextMatchUps:h,inContext:g,event:U});return u??[]}),groupInfo:S}}function Xf(e){let t=$c(e,[{tournamentRecord:!0}]);if(t.error)return t;if(!e?.tournamentRecord)return{error:Ie};let{participantMap:r,participants:i}=e,{scheduleVisibilityFilters:n,participantsProfile:a,afterRecoveryTimes:o,useParticipantMap:s,policyDefinitions:c,tournamentRecord:u,inContext:d=!0,usePublishState:l,contextProfile:p,matchUpFilters:m,contextFilters:f,nextMatchUps:h,context:g}=e,I=e.tournamentId??u.tournamentId,U=u?.events??[];i||({participants:i,participantMap:r}=cp({participantsProfile:a,useParticipantMap:s,policyDefinitions:c,tournamentRecord:u,contextProfile:p,inContext:d}));let{appliedPolicies:S}=up({tournamentRecord:u}),v={...g,tournamentId:I,indoorOutDoor:u.indoorOutdoor,surfaceCategory:u.surfaceCategory,endDate:u.endDate},y=Up({policyDefinitions:c,tournamentRecord:u,contextProfile:p});return{matchUps:U.flatMap(e=>(v.eventDrawsCount=e.drawDefinitions?.length??0,Qf({context:v,scheduleVisibilityFilters:n,tournamentAppliedPolicies:S,participantsProfile:a,afterRecoveryTimes:o,policyDefinitions:c,tournamentRecord:u,usePublishState:l,contextContent:y,contextFilters:f,contextProfile:p,matchUpFilters:m,participantMap:r,nextMatchUps:h,participants:i,inContext:d,event:e}).matchUps??[])).concat(...u.matchUps??[])}}function Zf({scheduleVisibilityFilters:e,afterRecoveryTimes:t,participantsProfile:r,tournamentRecords:i,policyDefinitions:n,usePublishState:a,matchUpFilters:o,contextFilters:s,nextMatchUps:c,inContext:u}){if("object"!=typeof i||!Object.keys(i).length)return{error:ge};let d=Object.keys(i).map(d=>{let l=i[d];return Xf({scheduleVisibilityFilters:e,afterRecoveryTimes:t,participantsProfile:r,policyDefinitions:n,tournamentRecord:l,usePublishState:a,matchUpFilters:o,contextFilters:s,nextMatchUps:c,inContext:u}).matchUps??[]}).flat();return{...ce,matchUps:d}}function eh(e,t){return function(e,t){return(Xo[e?.stage]||0)-(Xo[t?.stage]||0)}(e,t)||(e?.stageSequence||0)-(t?.stageSequence||0)||e?.roundNumber&&t.roundNumber&&e?.roundNumber-t?.roundNumber||(e?.roundPosition??0)-(t?.roundPosition??0)}function th(e){let t,{participants:r,participantMap:i,contextContent:n}=e,{scheduleVisibilityFilters:a,tournamentAppliedPolicies:o,participantsProfile:s,afterRecoveryTimes:c,policyDefinitions:u,useParticipantMap:d,tournamentRecord:l,matchUpFilters:p,contextFilters:m,contextProfile:f,drawDefinition:h,nextMatchUps:g,inContext:I,context:U,event:S}=e,{eventId:v,eventName:y,endDate:w,eventType:P,category:T,gender:D,matchUpFormat:b}=S??{},M={...U,surfaceCategory:S?.surfaceCategory??l?.surfaceCategory,indoorOutDoor:S?.indoorOutdoor??l?.indoorOutdoor,matchUpFormat:b,eventType:P,eventName:y,category:T,eventId:v,endDate:w,gender:D};return!r?.length&&!i&&l&&({participants:r=[],participantMap:i,groupInfo:t}=cp({participantsProfile:s,useParticipantMap:d,policyDefinitions:u,tournamentRecord:l,contextProfile:f,inContext:I})),f&&!n&&(n=Up({policyDefinitions:u,tournamentRecord:l,contextProfile:f,drawDefinition:h,event:S})),{...Kf({context:M,tournamentAppliedPolicies:o,scheduleVisibilityFilters:a,tournamentParticipants:r,participantsProfile:s,afterRecoveryTimes:c,policyDefinitions:u,tournamentRecord:l,drawDefinition:h,contextContent:n,contextFilters:m,contextProfile:f,matchUpFilters:p,participantMap:i,nextMatchUps:g,inContext:I,event:S}),groupInfo:t}}function rh({element:e,accessor:t}){if("string"!=typeof t)return{values:[]};let r,i=Wa(e),n=t.split("."),a=[];!function e({targetElement:t,attributes:i=[],significantCharacters:n}){for(let[s,c]of i.entries())if(t?.[c]){let n=i.slice(s+1);n.length?Array.isArray(t[c])?t[c].forEach(t=>e({targetElement:t,attributes:n})):o({targetElement:t=t[c],index:s}):(r||(r=t[c]),a.includes(t[c])||a.push(t[c]))}function o({targetElement:e,index:t}){if(e&&t===i.length-1&&["string","number"].includes(typeof e)){let t=n?e.slice(0,n):e;r?a.includes(t)||a.push(t):(r=t,a.push(t))}}}({targetElement:i,attributes:n});let o={value:r};return a.length&&(o.values=a),o}var ih=e=>t=>e&&"object"==typeof t?Array.isArray(e)&&e.map(e=>({[e]:rh({element:t,accessor:e})?.value}))||"object"==typeof e&&Object.keys(e).map(e=>({[e]:rh({element:t,accessor:e})?.value}))||("string"==typeof e&&rh({element:t,accessor:e}))?.value:void 0,nh=ih;function ah({finishingPositionOffset:e=0,finishingPositionLimit:t,positionsFed:r,roundsCount:i,roundLimit:n,matchUps:a,lucky:o,fmlc:s}){if(!Zp(a))return[];let{roundProfile:c,roundNumbers:u=[]}=em({interpolate:!0,matchUps:a});i=i??Math.max(...u,0);let d=n?i-n:0,l=d&&c?.[i-d]?.matchUpsCount,p=c&&Object.values(c).map(nh("matchUpsCount")),m=(e,r)=>{let i=Math.min(...e);l&&r&&1===i&&(i=l);let n=Math.max(...e);return t&&n>t&&(n=t),[i,n]},f=c&&Object.assign({},...u.map(t=>{let n=(i??0)+1-t-d,a=c[t].matchUpsCount,u={finishingPositionRange:{},finishingRound:n},l=p?.slice(t-1).reduce((e,t)=>e+(t||0),0),f=1+e+(s&&1!==t?r??0:0),h=K(f,o?f+2*a:l+f+1),g=l+1-a,I=m(h.slice(g)),U=m(h.slice(0,g),!0);return u.finishingPositionRange={loser:I,winner:U},{[t]:u}})),h=$i({finishingRound:!0});return a.filter(Boolean).forEach(e=>{let t=e.roundNumber&&f[e.roundNumber];h&&!t&&console.log({roundFinishingData:f,matchUp:e}),e.finishingRound=t?.finishingRound,e.finishingPositionRange=t?.finishingPositionRange}),a}function oh({inContextDrawMatchUps:e,drawDefinition:t,matchUpsMap:r}){if(!t)return{error:ye};let i={loserMatchUpIds:{},winnerMatchUpIds:{}};if(e||({matchUps:e,matchUpsMap:r}=Kf({inContext:!0,drawDefinition:t,matchUpsMap:r})),!r?.drawMatchUps.some(e=>e.finishingPositionRange)&&1===t?.structures?.length&&!t?.structures[0].structures){ah({matchUps:r?.drawMatchUps??[]})}return(e??[]).filter(({collectionId:e})=>!e).forEach(n=>{let{matchUpId:a,structureId:o}=n,s=Wf({inContextDrawMatchUps:e,drawDefinition:t,matchUpId:a}),{winnerMatchUp:c,loserMatchUp:u}=s.targetMatchUps,d=c?.matchUpId,l=u?.matchUpId,p=Jp({matchUpsMap:r,structureId:o}).find(e=>e.matchUpId===a);if(p&&(d&&(i.winnerMatchUpIds[p.matchUpId]=d,Object.assign(p,{winnerMatchUpId:d}),Object.assign(n,{winnerMatchUpId:d})),l&&(i.loserMatchUpIds[p.matchUpId]=l,n.loserMatchUpId=l,p.loserMatchUpId=l,n.finishingPositionRange))){let e=u.finishingPositionRange&&[...n.finishingPositionRange.loser,...u.finishingPositionRange.loser],t=e&&[Math.min(...e),Math.max(...e)];n.finishingPositionRange.loser=t,p.finishingPositionRange.loser=t}}),{inContextDrawMatchUps:e,goesToMap:i}}function sh(e){let t=Fl(e),r=e.matchUps??[],i=e.drawIds??[],{includeParticipantDependencies:n,tournamentRecord:a,drawDefinition:o}=e;if(!Array.isArray(r))return{error:At};if(!Array.isArray(i))return{error:Ge};let s=e.matchUpIds?.length?e.matchUpIds:r.map(e=>e.matchUpId);if(!Array.isArray(s))return{error:Rt};let c={},u={},d={},l={};a&&!Object.keys(t).length&&(t={[a.tournamentId]:a});let p=Object.values(t),m=p.reduce((e,t)=>e.concat(t.events??[]).map(e=>(e.drawDefinitions||[]).map(e=>e.links||[])).flat(1/0),[]).filter(({linkType:e})=>e===ms),f=r;if(m.length){f=Zf({nextMatchUps:!0,tournamentRecords:t}).matchUps;let e=m.reduce((e,t)=>{let r=t.source?.structureId,i=t.target?.structureId;return r&&i&&(d[i]=r),r&&!e.includes(r)&&e.push(r),e},[]);for(let t of e)c[t]=[];for(let t of f??[]){let r=t.containerStructureId||t.structureId;e.includes(r)&&c[r].push(t.matchUpId)}}let h=e=>{u[e]||(u[e]={dependentMatchUpIds:[],participantIds:[],matchUpIds:[],sources:[]},l[e]=[])},g=(e,t)=>{u[e].matchUpIds.forEach(e=>{u[t].matchUpIds.push(e)}),u[t].matchUpIds.push(e),u[e].dependentMatchUpIds.push(t),n&&u[e].participantIds.forEach(e=>u[t].participantIds.push(e))},I=e=>{let t=Object.keys(c).length;for(let r of e||[]){let{matchUpId:e,winnerMatchUpId:i,loserMatchUpId:a}=r;if(!s.length||s.includes(e)){if(h(e),n){let{individualParticipantIds:t}=kl(r);u[e].participantIds=t}i&&(h(i),g(e,i),l[i].push(e)),a&&(h(a),g(e,a),l[a].push(e)),u[e].sources.push(l[e]);let o=l[e].map(e=>u[e].sources[0]).flat(),s=l[e].map(e=>u[e].sources[1]).flat();if(u[e].sources.push(o,s),t){let t=r.containerStructureId||r.structureId,i=d[t];if(c[i])for(let r of c[i])h(r),g(r,e),l[r].push(e)}}}};if(o)oh({drawDefinition:o}),f?.length||(f=th({drawDefinition:o}).matchUps),I(f);else{if(f?.length||(f=Zf({nextMatchUps:!0,tournamentRecords:t}).matchUps),!i.length){let e=p?.length?p.map(({events:e=[]})=>e.map(({drawDefinitions:e=[]})=>e.map(({drawId:e})=>e))).flat(1/0):[];e&&(i=e)}for(let e of i){let r=f?.filter(t=>t.drawId===e).sort(eh);if(!r?.find(({roundPosition:e})=>!e)){let i=r?.find(({tournamentId:e})=>e),{drawDefinition:n}=Af({tournamentRecord:t[i?.tournamentId],drawId:e});n&&oh({drawDefinition:n})}I(r)}}return{positionDependencies:c,matchUpDependencies:u,sourceMatchUpIds:l,matchUps:f,...ce}}function ch(e){let t=e?.matchUp,r=e?.score||t?.score,i=r?.sets?.[0],{side1Score:n,side2Score:a,side1TiebreakScore:o,side2TiebreakScore:s,side1PointScore:c,side2PointScore:u}=i||{},d=n||a||o||s||c||u;return!!(r?.sets?.length>1||d)}function uh({matchUpStatus:e}){return Cd.includes(e)}function dh({matchUpStatus:e}){return Od.includes(e)}function lh({matchUpStatus:e,winningSide:t,tieMatchUps:r,sides:i,score:n}){let a=i?.find(({participantId:e})=>e),o=r?.filter(lh)?.length;return ch({score:n})||o||t&&a||e&&function({matchUpStatus:e}){return Fd.includes(e)}({matchUpStatus:e})&&![Sd,Rd,wd].includes(e)}function ph(e){let{drawDefinition:t,findContainer:r,structureId:i,event:n}=e,a=e.structure,{containedStructures:o}=Ol({drawDefinition:t}),s=i&&o[i]||[];if(!a){let e=Vd({drawDefinition:t,structureId:i});if(e.error)return e;a=r?e.containingStructure??e.structure:e.structure}if(nm({structure:a}))return{structure:a,isAdHoc:!0,error:Fe};let{matchUps:c}=Kf({inContext:!0,matchUpFilters:{isCollectionMatchUp:!1},drawDefinition:t,event:n}),u=c?.filter(e=>e.structureId===i||s.includes(e.structureId)),{matchUpDependencies:d}=sh({drawIds:[t.drawId],matchUps:c,drawDefinition:t}),l=[],p=[],m={},f=[];for(let g of c??[]){if(g.structureId===i||s.includes(g.structureId)){p.push(...g.drawPositions??[]);let e=g.roundNumber;for(let t of(g.drawPositions??[]).filter(Boolean))(!m[t]||e&&m[t]>e)&&(m[t]=e)}lh(g)&&(f.push(g),l.push(g.matchUpId,...d?.[g?.matchUpId]?.matchUpIds||[]))}let h=L(p.filter(Boolean)).sort(g),I=L(l),U=L(u?.map(({matchUpId:e,drawPositions:t})=>I.includes(e)?t:[]).flat().filter(Boolean)).sort(g),{positionAssignments:S}=$d({drawDefinition:t,structure:a}),v=S?.filter(e=>e.bye).map(e=>e.drawPosition),y=S?.filter(e=>e.qualifier).map(e=>e.drawPosition),w=h?.filter(e=>!U.includes(e))||[];return{allDrawPositions:h,inContextStructureMatchUps:u,drawPositionInitialRounds:m,activeDependentMatchUpIds:I,qualifyingDrawPositions:y,inactiveDrawPositions:w,positionAssignments:S,activeDrawPositions:U,byeDrawPositions:v,activeMatchUps:f,structure:a}}function mh({drawPosition:e,matchUps:t=[]}){return{initialRoundNumber:t.filter(({drawPositions:t})=>e&&t?.includes(e)).map(({roundNumber:e})=>e).sort(g)[0]}}var fh={reset:"\x1b[0m",bright:"\x1b[1m",dim:"\x1b[2m",red:"\x1b[31m",brightred:"\x1b[91m",green:"\x1b[32m",brightgreen:"\x1b[92m",yellow:"\x1b[33m",brightyellow:"\x1b[93m",blue:"\x1b[34m",brightblue:"\x1b[94m",lightblue:"\x1b[105m",magenta:"\x1b[35m",brightmagenta:"\x1b[95m",cyan:"\x1b[36m",brightcyan:"\x1b[96m",white:"\x1b[37m",brightwhite:"\x1b[97m"},hh=[];function gh(e,t){S(e)&&(e={method:e}),(t||$i())&&hh.push(e)}function Ih(e){let t=function(e){let t=hh.slice();return e&&(hh.length=0),t}(e).map(e=>{let{color:t,keyColors:r,method:i,newline:n}=e,a=Object.keys(fh).includes(t)?fh[t]:fh.cyan,o=Object.keys(e).filter(e=>!["color","keyColors","method","newline"].includes(e)).map(t=>{let i=r&&Object.keys(r).includes(t)&&fh[r[t]]?fh[r[t]]:fh.brightwhite;return`${fh.white}${t}: ${i}${e[t]}`}).join(", ");return[n?"\n":"",a,i,i?.length<15?"\t\t":"\t",fh.white,o,fh.reset,"\n"].join("")});t?.length&&console.log(...t)}function Uh(e){let t=e.bye,r=e.qualifier,i=e.participantId;return{containsBye:t,containsQualifier:r,containsParticipant:i,filled:t||r||i}}function Sh(e){return[Sd,Rd,Dd].includes(e)}function vh({provisionalPositioning:e,isPositionAction:t,tournamentRecord:r,drawDefinition:i,drawPosition:n,loserMatchUp:a,matchUpsMap:o,structureId:s,structure:c,event:u}){if(!i)return{error:ye};if(c||({structure:c}=Vd({drawDefinition:i,structureId:s})),!c)return{error:et};s||({structureId:s}=c);let d="assignDrawPositionBye";gh({method:d,color:"cyan",drawPosition:n}),o??=Kp({drawDefinition:i});let{positionAssignments:l}=$d({structure:c}),{activeDrawPositions:p}=ph({drawDefinition:i,structureId:s});if(l?.find(e=>e.drawPosition===n)?.bye)return{...ce};let m=!(!a||!o.drawMatchUps.some(e=>e.loserMatchUpId===a?.matchUpId&&Sh(e.matchUpStatus)));if(p?.includes(n)&&!m)return{error:Oe};let f=l?.find(e=>e.drawPosition===n);if(!f)return{error:Fe};let{filled:h,containsBye:g,containsParticipant:I}=Uh(f);if(g)return{...ce};if(h&&!g&&!m)return Pn({result:{error:Me},stack:d});let U=up({tournamentRecord:r,drawDefinition:i,event:u}).appliedPolicies??{},S=Kf({inContext:!0,drawDefinition:i,matchUpsMap:o}).matchUps??[],{matchUps:v}=Bf({provisionalPositioning:e,drawDefinition:i,matchUpFilters:{isCollectionMatchUp:!1},matchUpsMap:o,structure:c});if(l?.forEach(e=>{e.drawPosition===n&&(e.bye=!0,m&&(e.participantId=void 0))}),c.structureType===cs)return function({tournamentRecord:e,drawDefinition:t,drawPosition:r,matchUps:i,event:n}){i.forEach(i=>{i.drawPositions?.includes(r)&&wh({eventId:n?.eventId,tournamentRecord:e,drawDefinition:t,matchUp:i})})}({tournamentRecord:r,drawDefinition:i,drawPosition:n,matchUps:v}),Nl({tournamentId:r?.tournamentId,drawDefinition:i,structure:c,event:u}),yh({assignedParticipantId:I,isPositionAction:t,appliedPolicies:U,drawDefinition:i,drawPosition:n,structureId:s,stack:d});let{roundProfile:y,roundMatchUps:w}=em({matchUps:v}),P=(y&&Object.keys(y).map(e=>Number.parseInt(e)).reverse())?.find(e=>y?.[e].drawPositions?.includes(n)),T=P?w?.[P].find(({drawPositions:e})=>e?.includes(n)):void 0;T&&wh({tournamentRecord:r,drawDefinition:i,matchUp:T,event:u});let D=T?.drawPositions?.find(e=>e!==n);if(T&&D){let e=Ph({sourceDrawPositions:T.drawPositions,matchUpId:T.matchUpId,inContextDrawMatchUps:S,drawPositionToAdvance:D,tournamentRecord:r,drawDefinition:i,matchUpsMap:o});if(e.error)return e}return Nl({tournamentId:r?.tournamentId,drawDefinition:i,structure:c,event:u}),yh({assignedParticipantId:I,isPositionAction:t,appliedPolicies:U,drawDefinition:i,drawPosition:n,structureId:s,stack:d})}function yh({assignedParticipantId:e,isPositionAction:t,appliedPolicies:r,drawDefinition:i,drawPosition:n,structureId:a,stack:o}){return t&&Cl({appliedPolicies:r,drawDefinition:i,positionAction:{removedParticipantId:e,drawPosition:n,structureId:a,name:o}}),Pn({result:{...ce},stack:o})}function wh({tournamentRecord:e,drawDefinition:t,eventId:r,matchUp:i,event:n}){Object.assign(i,{matchUpStatus:"BYE",score:void 0,winningSide:void 0}),Dl({tournamentId:e?.tournamentId,eventId:r??n?.eventId,context:"setMatchUpStatusBye",drawDefinition:t,matchUp:i})}function Ph({drawPositionToAdvance:e,inContextDrawMatchUps:t,sourceDrawPositions:r,tournamentRecord:i,drawDefinition:n,matchUpsMap:a,matchUpId:o,event:s}){gh({method:"advanceDrawPosition",color:"cyan",drawPositionToAdvance:e});let c=a.drawMatchUps.find(e=>e.matchUpId===o),u=t.find(e=>e.matchUpId===o)?.structureId,{structure:d}=Vd({drawDefinition:n,structureId:u}),{positionAssignments:l}=$d({structure:d}),p=l?.filter(e=>e.bye).map(e=>e.drawPosition),m=c?.drawPositions?.find(t=>t!==e),f=m&&p?.includes(m),{targetLinks:{loserTargetLink:h},targetMatchUps:{loserMatchUp:I,winnerMatchUp:U,loserTargetDrawPosition:S}}=Wf({inContextDrawMatchUps:t,drawDefinition:n,matchUpId:o});if(U&&U.structureId===d?.structureId&&function({drawPositionToAdvance:e,inContextDrawMatchUps:t,sourceDrawPositions:r,tournamentRecord:i,drawDefinition:n,winnerMatchUp:a,matchUpsMap:o,event:s}){let c="advanceWinner",u=o.drawMatchUps.find(e=>e.matchUpId===a.matchUpId),d=t.find(e=>e.matchUpId===a.matchUpId)?.structureId,{structure:l}=Vd({drawDefinition:n,structureId:d}),{positionAssignments:p}=$d({structure:l}),m=p?.find(({drawPosition:t})=>t===e)?.bye,f=u.drawPositions?.filter(Boolean),h=p?.filter(e=>f?.includes(e.drawPosition)),I=p?.find(({drawPosition:t})=>t===e),U=r?.find(t=>t!==e),S=(U&&h?.find(({drawPosition:e})=>e===U))?.bye,v=m&&S;if(v&&console.log({isByeAdvancedBye:v}),f?.length>1&&m&&!S)return Pn({result:{error:Me},stack:c});let y=f?.find(t=>t!==e),w=v,P=[...(u.drawPositions||[]).filter(Boolean),void 0,void 0].slice(0,2),T=P.map(t=>!t&&!w||t===e?(w=!0,e):t).sort(g);if(!w)return console.log("@@@@@@@",{advancingAssignmentIsBye:I,drawPositionToAdvance:e,existingAssignments:h}),Pn({result:{error:Me},stack:c});let D=p?.find(({drawPosition:e})=>e===y)?.bye,b=p?.find(({drawPosition:t})=>t===e)?.bye;Object.assign(u,{matchUpStatus:b||D?"BYE":Md,score:void 0,winningSide:void 0,drawPositions:T});let M=u.drawPositions.find(e=>!P.includes(e));gh({method:c,color:"brightyellow",changedDrawPosition:M,pairedDrawPositionIsBye:D,drawPositionIsBye:b}),Dl({tournamentId:i?.tournamentId,matchUp:u,eventId:s?.eventId,context:c,drawDefinition:n});let{targetLinks:{loserTargetLink:R},targetMatchUps:{loserMatchUp:N,loserTargetDrawPosition:A}}=Wf({matchUpId:a.matchUpId,inContextDrawMatchUps:t,drawDefinition:n});if(D||b){let r=D?e:y;if(r)Ph({drawPositionToAdvance:r,matchUpId:a.matchUpId,inContextDrawMatchUps:t,tournamentRecord:i,drawDefinition:n,matchUpsMap:o});else if(b&&R&&N)if(N.feedRound)Th({loserTargetDrawPosition:A,tournamentRecord:i,loserTargetLink:R,drawDefinition:n,loserMatchUp:N,matchUpsMap:o});else{let e=1-a.roundPosition%2,t=N.drawPositions[e],r=vh({structureId:R.target.structureId,drawPosition:t,tournamentRecord:i,drawDefinition:n,event:s});if(r.error);}}}({drawPositionToAdvance:e,inContextDrawMatchUps:t,sourceDrawPositions:r,tournamentRecord:i,drawDefinition:n,winnerMatchUp:U,matchUpsMap:a,event:s}),I&&f&&I.structureId!==d?.structureId){let{roundNumber:e}=I;if(1===e){let e=vh({structureId:h.target.structureId,drawPosition:S,tournamentRecord:i,drawDefinition:n,event:s});if(e.error)return e}else Th({loserTargetDrawPosition:S,tournamentRecord:i,loserTargetLink:h,drawDefinition:n,loserMatchUp:I,matchUpsMap:a,event:s})}return{...ce}}function Th({loserTargetDrawPosition:e,tournamentRecord:t,loserTargetLink:r,drawDefinition:i,loserMatchUp:n,matchUpsMap:a,event:o}){let{roundNumber:s}=n;gh({method:"assignFedDrawPositionBye",color:"cyan",loserTargetDrawPosition:e});let c=(a?.mappedMatchUps||{})[n.structureId].matchUps,{initialRoundNumber:u}=mh({drawPosition:e,matchUps:c});if(u===s){let n=vh({structureId:r.target.structureId,drawPosition:e,tournamentRecord:t,drawDefinition:i,event:o});if(n.error)return n}}function Dh({positionAssignments:e,tournamentRecord:t,drawDefinition:r,matchUpsMap:i,structure:n,event:a}){let{matchUps:o}=Bf({drawDefinition:r,matchUpsMap:i,structure:n,event:a});o.forEach(i=>{let n=e.filter(({drawPosition:e})=>i.drawPositions?.includes(e)).filter(e=>e.bye).length;i.winningSide||(Object.assign(i,{matchUpStatus:n?"BYE":Md}),Dl({tournamentId:t?.tournamentId,context:"modifyRoundRobinMatchUpsStatus",eventId:a?.eventId,drawDefinition:r,matchUp:i}))})}function bh(e){let{inContextDrawMatchUps:t,participantId:r,drawPosition:i}=e,{tournamentRecord:n,drawDefinition:a,structureId:o,matchUpsMap:s,event:c}=e,{structure:u}=Vd({drawDefinition:a,structureId:o}),d=(qd({drawDefinition:a,structure:u}).positionAssignments||[]).find(e=>r&&e.participantId===r||i&&e.drawPosition===i);if(d&&r&&!i&&(i=d?.drawPosition),!i)return{error:xe};r||(r=d?.participantId);let{activeDrawPositions:l}=ph({drawDefinition:a,structureId:o});return l.includes(i)?{error:Oe}:(t||({matchUps:t}=Kf({inContext:!0,drawDefinition:a,matchUpsMap:s})),Mh({inContextDrawMatchUps:t,tournamentRecord:n,drawDefinition:a,structureId:o,drawPosition:i,matchUpsMap:s,event:c}).drawPositionCleared?(Nl({tournamentId:n?.tournamentId,drawDefinition:a,structure:u,event:c}),{...ce,participantId:r}):{error:Ae})}function Mh({inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,drawPosition:i,matchUpsMap:n,structureId:a,event:o}){let{structure:s}=Vd({drawDefinition:r,structureId:a});if(!s)return{error:et};let c=qd({drawDefinition:r,structure:s}).positionAssignments||[],u=c.some(e=>{if(e.drawPosition===i)return delete e.participantId,delete e.qualifier,delete e.bye,!0});if(s.structureType===cs)return Dh({positionAssignments:c,tournamentRecord:t,drawDefinition:r,matchUpsMap:n,structure:s}),{drawPositionCleared:u,...ce};let{matchUps:d}=Bf({drawDefinition:r,matchUpFilters:{isCollectionMatchUp:!1},matchUpsMap:n,structure:s,event:o}),{roundProfile:l,roundMatchUps:p}=em({matchUps:d}),m=(l&&Object.keys(l))?.map(e=>I(e)),f=i,h=m?.map(e=>{let t=l?.[e]?.pairedDrawPositions?.find(e=>e.includes(f)),r=t?.find(e=>e!==f),i=c.find(e=>e.drawPosition===r),n=l?.[e+1],a=i?.bye,o=n?.pairedDrawPositions?.find(e=>e.includes(r)),s=a&&o&&n&&n.drawPositions?.includes(r),u=t&&{pairedDrawPositionByeAdvancedPair:!s&&o,pairedDrawPosition:r,targetDrawPosition:f,relevantPair:t,roundNumber:e};return s&&(f=r),u}).filter(e=>e?.targetDrawPosition)?.reduce((e,t)=>{let{roundNumber:r,relevantPair:i,targetDrawPosition:n,pairedDrawPosition:a,pairedDrawPositionByeAdvancedPair:o}=t,s=[{roundNumber:r,targetDrawPosition:n,relevantPair:i},o&&{roundNumber:r+1,targetDrawPosition:a,relevantPair:o,subsequentRoundRemoval:!0}].filter(Boolean);return e.concat(...s)},[]);return h?.forEach(({roundNumber:u,targetDrawPosition:d,relevantPair:l})=>{let m=p?.[u].find(e=>Z(e.drawPositions?.filter(Boolean),l.filter(Boolean)));m&&(function({inContextDrawMatchUps:e,targetDrawPosition:t,tournamentRecord:r,drawDefinition:i,matchUpsMap:n,roundNumber:a,structureId:o}){let{structure:s}=Vd({drawDefinition:i,structureId:o});if(!s)return{error:et};if(s.structureType===cs)return;n=n||Kp({drawDefinition:i});let c=(n?.mappedMatchUps||{})[o].matchUps,{initialRoundNumber:u}=mh({drawPosition:t,matchUps:c}),d=c?.filter(e=>e.roundNumber>=a&&e.roundNumber!==u&&e.drawPositions?.includes(t)),l=$d({drawDefinition:i,structureId:o}).positionAssignments??[];d?.forEach(a=>Rh({drawPosition:t,targetMatchUp:a,inContextDrawMatchUps:e,positionAssignments:l,tournamentRecord:r,drawDefinition:i,matchUpsMap:n,structure:s}))}({inContextDrawMatchUps:e,targetDrawPosition:d,tournamentRecord:t,drawDefinition:r,structureId:a,roundNumber:u,matchUpsMap:n}),Rh({inContextDrawMatchUps:e,positionAssignments:c,tournamentRecord:t,drawDefinition:r,targetMatchUp:m,drawPosition:i,matchUpsMap:n,structure:s,event:o}))}),{tasks:h,drawPositionCleared:u,positionAssignments:c}}function Rh({inContextDrawMatchUps:e,positionAssignments:t,tournamentRecord:r,drawDefinition:i,targetMatchUp:n,drawPosition:a,matchUpsMap:o,structure:s,event:c}){let u="removeDrawPosition",d=n.drawPositions?.slice(),l=n.matchUpStatus,p=n.winningSide,f=(o=o??Kp({drawDefinition:i})).mappedMatchUps[s.structureId].matchUps,{initialRoundNumber:h}=mh({drawPosition:a,matchUps:f});if(n.roundNumber&&h&&n.roundNumber>h){let e=(n.drawPositions??[]).map(e=>e===a?void 0:e);n.drawPositions=e}if(n.matchUpType===m){let t=(e?.find(e=>e.matchUpId===n.matchUpId)?.sides??[]).reduce((e,t,r)=>t.drawPosition===a?r:e,void 0);void 0!==t&&n.sides?.[t]?.lineUp&&(delete n.sides?.[t].lineUp,Dl({tournamentId:r?.tournamentId,context:`${u}-TEAM`,eventId:c?.eventId,matchUp:n,drawDefinition:i}))}let g=Wf({matchUpId:n.matchUpId,inContextDrawMatchUps:e,drawDefinition:i}),{targetLinks:{winnerTargetLink:I},targetMatchUps:{loserMatchUp:U,winnerMatchUp:S,loserMatchUpDrawPositionIndex:v}}=g,y=t.filter(({drawPosition:e})=>n.drawPositions?.includes(e)).filter(e=>e.bye).length,w=(y?"BYE":n.matchUpStatus&&Sh(n.matchUpStatus)&&n.matcHUpStatus)||Md;n.matchUpStatus=w,n.matchUpStatus&&Sh(n.matchUpStatus)&&(n.winningSide=void 0);let P=d?.find(e=>!n.drawPositions?.includes(e));if(d?.includes(a)&&l===n.matchUpStatus&&p===n.winningSide||(P&&gh({method:u,color:"brightyellow",removedDrawPosition:P}),Dl({tournamentId:r?.tournamentId,context:`${u}-${a}`,eventId:c?.eventId,matchUp:n,drawDefinition:i})),U&&U.structureId!==g.matchUp.structureId&&!y){let{drawPositions:t,roundNumber:n}=U;if(1===n){let n=t[v];Mh({structureId:U.structureId,drawPosition:n,inContextDrawMatchUps:e,tournamentRecord:r,drawDefinition:i,matchUpsMap:o})}else{let n=Math.min(...t.filter(Boolean)),a=function({loserMatchUpDrawPosition:e,inContextDrawMatchUps:t,tournamentRecord:r,drawDefinition:i,loserMatchUp:n,matchUpsMap:a,event:o}){let{structure:s}=Vd({structureId:n.structureId,drawDefinition:i}),{positionAssignments:c}=$d({structure:s});if(c?.find(t=>t.drawPosition===e)?.bye){let s=bh({drawPosition:e,structureId:n.structureId,inContextDrawMatchUps:t,tournamentRecord:r,drawDefinition:i,matchUpsMap:a,event:o});if(s.error)return s}return{...ce}}({loserMatchUpDrawPosition:n,inContextDrawMatchUps:e,tournamentRecord:r,drawDefinition:i,loserMatchUp:U,matchUpsMap:o,event:c});if(a.error)return Pn({result:a,stack:u});let s=(o?.mappedMatchUps||{})[U.structureId].matchUps,{initialRoundNumber:d}=mh({drawPosition:n,matchUps:s});1===d&&(gh({method:u,color:"brightyellow",loserMatchUpDrawPosition:n}),Mh({structureId:U.structureId,drawPosition:n,inContextDrawMatchUps:e,tournamentRecord:r,drawDefinition:i,matchUpsMap:o}))}}return S&&S.structureId!==g.matchUp.structureId&&I.target.feedProfile,{...ce}}function Nh({drawDefinition:e,stages:t}){if(!e)return{error:ye};let r=L((e?.structures??[]).filter(e=>!t?.length||e.stage&&t.includes(e.stage)).map(e=>{let{positionAssignments:t}=$d({structure:e});return t?t.map(dd):[]}).flat().filter(Boolean));return{...ce,assignedParticipantIds:r}}function Ah(e){let t=(e?.entries??[]).filter(Boolean).reduce((e,t)=>{let{entryStage:r,entryStatus:i}=t,n=`_${r||Ho}${i||""}`;return e[n]||(e[n]=[]),e[n].push(t),e},{}),r=e=>isNaN(e)?1/0:e;return Object.keys(t).map(e=>t[e].sort((e,t)=>r(e.entryPosition)-r(t.entryPosition)).map((e,t)=>({...e,entryPosition:t+1}))).flat()}function Eh(e){return[Op,Cp].includes(e)}function Ch({autoEntryPositions:e=!0,ignoreAssignment:t,tournamentRecord:r,drawDefinition:i,participantIds:n,entryStatus:a,entryStage:o,extension:s,eventSync:c,drawId:u,stage:d,event:l}){if(!n||!Array.isArray(n))return{error:dr,method:"modifyEntriesStatus",participantIds:n};if(!i&&!l)return{error:ot};if(a&&!Vp.includes(a))return{error:Nr};if(o&&!Qo.includes(o))return{error:mt};let p="modifyEntriesStatus",m=[];if(!a&&!s)return Pn({result:{error:$t},info:"Missing entryStatus",stack:p});if(s&&!Iu({extension:s,requiredAttributes:["name"]}))return Pn({result:{error:gi},info:"Invalid extension",context:{extension:s},stack:p});let f=[];l?.drawDefinitions?.forEach(e=>{let t=Nh({stages:d&&[d],drawDefinition:e}).assignedParticipantIds??[];f.push(...t)});let h=r?.participants??[];if(!n.every(e=>{let t=hu({tournamentParticipants:h,participantId:e})?.participantType;return!(t&&[jl,Bl].includes(t)&&Eh(a)||a&&l?.eventType&&t===Vl&&[Go,qo].includes(l.eventType)&&[Pp,...xp].includes(a))}))return{error:Nr};let g=l&&Nf({event:l}).flightProfile,I=g?.flights?.find(e=>e.drawId===u),U=e=>{let r=(e||[]).filter(e=>!d||!e.entryStage||d===e.entryStage).filter(({participantId:e})=>n.includes(e));return r.every(e=>!((e=>a&&f.includes(e.participantId)&&!(xp.includes(e.entryStatus)&&xp.includes(a)))(e)&&!t)&&(a&&(e.entryStatus=a,delete e.entryPosition),o&&(e.entryStage=o,delete e.entryPosition),s&&(s.value?Uu({element:e,extension:s}):gu({element:e,name:s.name})),!0))?{...ce}:{error:br}},S=({flight:e,drawDefinition:t})=>{l&&(l.entries=Ah({entries:l.entries??[]})),e&&(e.drawEntries=Ah({entries:e.drawEntries})),t&&(t.entries=Ah({entries:t.entries}))},v=e=>{let{flight:t,drawDefinition:r}=e,i="updateDrawEntries";if(t){let e=U(t.drawEntries);if(e.error)return Pn({result:e,stack:i})}if(r){let e=U(r.entries);if(e.error)return Pn({result:e,stack:i});m.includes(r.drawId)||m.push(r.drawId)}return{...ce}},y=l?.entries?.find(({entryPosition:e})=>e)??(I?.drawEntries?.find(({entryPosition:e})=>e)||i?.entries?.find(({entryPosition:e})=>e));if(e&&!y&&S({flight:I,drawDefinition:i}),I||i){let e=v({flight:I,drawDefinition:i});if(e.error)return Pn({result:e,stack:p})}let w=l?.drawDefinitions?.map(({drawId:e})=>e)??[],P=g?.flights?.filter(e=>!w.includes(e.drawId))||[];for(let D of P){let e=D&&v({flight:D});if(e?.error)return Pn({result:e,stack:p})}let T=1===g?.flights?.length&&(l?.drawDefinitions?.length??0)<=g?.flights?.length;if(!I&&!i&&a&&_p.includes(a))return{error:kr};if(!I&&!i||a===Fp||c&&T){let e,t=U(l?.entries);if(t?.error)return Pn({result:t,stack:p});if(a===Fp&&(g?.flights?.every(t=>{let r=U(t.drawEntries);return r.error?(e=r.error,!1):(t.drawEntries=t.drawEntries.filter(({participantId:e})=>!n.includes(e)),!0)}),l?.drawDefinitions?.every(t=>{let r=U(t.entries);return r.error?(e=r.error,!1):(t.entries=t.entries?.filter(({participantId:e})=>!n.includes(e)),!0)})),e)return Pn({result:{error:e},stack:p})}e&&S({flight:I,drawDefinition:i});for(let D of l?.drawDefinitions??[])m.length&&!m.includes(D.drawId)||Ml({tournamentId:r.tournamentId,eventId:l?.eventId,drawDefinition:D});return{...ce}}function Oh({value:e,sourceRange:t,targetRange:r}){if(!Array.isArray(t)||2!==t.length)return 0;let i=Math.min(...t),n=Math.max(...t),a=Math.min(...r);return(e-i)*(Math.max(...r)-a)/(n-i)+a}var kh="NTRP",Fh="DUPR",xh="UTR_P",_h="UTPR",Lh="SQUASH_LEVELS",Bh="US_SQUASH",Vh="USATT",Gh="ITTF",jh="USAR",$h={ELO:"ELO",NTRP:kh,TRN:"TRN",UTR:"UTR",WTN:"WTN",DUPR:Fh,UTR_P:xh,UTPR:_h,PSA:"PSA",SQUASH_LEVELS:Lh,US_SQUASH:Bh,USATT:Vh,ITTF:Gh,USAR:jh,BWF:"BWF"},qh={ELO:{defaultInitialization:1500,decimalsCount:0,range:[0,3e3],ascending:!1},[kh]:{accessors:["ntrpRating","dntrpRatingHundredths"],attributes:{ustaRatingType:""},accessor:"dntrpRatingHundredths",defaultInitialization:3,decimalsCount:1,ascending:!1,range:[1,7]},UTR:{defaultInitialization:6,accessors:["utrRating"],accessor:"utrRating",decimalsCount:2,ascending:!1,range:[1,16]},WTN:{attributes:{confidence:{generator:!0,range:[60,100]}},accessors:["wtnRating","confidence"],defaultInitialization:23,accessor:"wtnRating",ascending:!0,decimalsCount:2,range:[40,1]},[Fh]:{defaultInitialization:3.5,accessors:["duprRating","reliabilityScore"],accessor:"duprRating",attributes:{reliabilityScore:{generator:!0,range:[0,100]}},decimalsCount:3,ascending:!1,range:[2,8]},[xh]:{defaultInitialization:5,accessors:["utrpRating","verified"],accessor:"utrpRating",attributes:{verified:{type:"boolean"},provisional:{type:"string"}},decimalsCount:1,ascending:!1,range:[1,10]},[_h]:{defaultInitialization:3.5,accessor:"utprRating",decimalsCount:1,ascending:!1,range:[2,5],deprecated:!0},PSA:{defaultInitialization:500,accessor:"psaPoints",decimalsCount:0,ascending:!1,range:[0,3e3],attributes:{tournaments:{generator:!0,range:[1,20]},divisor:{generator:!0,range:[10,20]}}},[Lh]:{defaultInitialization:2e3,accessor:"squashLevel",decimalsCount:0,ascending:!1,range:[0,7e3]},[Bh]:{defaultInitialization:3.5,accessor:"usSquashRating",decimalsCount:1,ascending:!1,range:[2,6]},[Vh]:{defaultInitialization:1e3,accessor:"usattRating",decimalsCount:0,ascending:!1,range:[200,3e3]},[Gh]:{defaultInitialization:500,accessor:"ittfPoints",decimalsCount:0,ascending:!1,range:[0,2e4]},[jh]:{defaultInitialization:1e4,accessor:"usarRanking",decimalsCount:0,ascending:!0,range:[1,25e3]},BWF:{defaultInitialization:5e3,accessor:"bwfPoints",decimalsCount:0,ascending:!0,range:[0,15e4],attributes:{tournaments:{generator:!0,range:[1,10]}}}};function Wh(e){let t=$c(e,[{ratings:!0,[_c]:Cc}]);if(t.error)return t;let r=e.matchUpType&&[u,l].includes(e.matchUpType)?e.matchUpType:u,i=Object.keys(qh),n=e.targetRatingType&&i.includes(e.targetRatingType)?e.targetRatingType:"ELO",a=e.ratings[r]?e.ratings[r].reduce((e,t)=>e.includes(t.scaleName)?e:e.concat(t.scaleName),[]):[];if(!a)return{error:wi};let o=e.ratings[r]?.find(e=>e.scaleName===n)??e.ratings[r]?.[0];if(a[0]===n)return o;let s=o?.scaleName,c=qh[o?.scaleName]?.accessor,d=c&&o.scaleValue[c]||o?.scaleValue,p=function({sourceRatingType:e,sourceRating:t}){let r=qh[e]?.range,i=r?.[0]>r?.[1],n=qh.ELO.range;return Oh({value:i?r[0]-t:t,sourceRange:r,targetRange:n})}({sourceRatingType:s,sourceRating:d}),m=function({targetRatingType:e,sourceRating:t}){let r=qh[e]?.decimalsCount||0,i=qh[e]?.range,n=i?.[0]>i?.[1],a=Math.max(...i),o=qh.ELO?.range,s=Oh({targetRange:i,sourceRange:o,value:t}),c=Number.parseFloat(s?.toFixed(r))||0;return n?a-c:c}({targetRatingType:n,sourceRating:p});return m?{convertedRating:m,sourceRating:d}:{error:gi}}function Hh({participantResults:e,sides:t,score:r}){let i=t?.find(({sideNumber:e})=>1===e),n=t?.find(({sideNumber:e})=>2===e),a=i?.participant?.ratings,o=n?.participant?.ratings;if(a?.[u]&&o?.[u]){let t="ELO",{convertedRating:s}=Wh({ratings:a,targetRatingType:t}),{convertedRating:c}=Wh({ratings:o,targetRatingType:t}),{side1pressure:u,side2pressure:d}=function({side1ConvertedRating:e,side2ConvertedRating:t,score:r}){let i=Math.max(e,t),n=Math.min(e,t),a=Math.abs(e-t),o=qh.ELO.range,s=Math.max(...o),c=0*(s-i),u=(i+c)/s*a,d=r?.sets?.reduce((e,t)=>e+(t?.side1Score??0),0),l=r?.sets?.reduce((e,t)=>e+(t.side2Score??0),0),p=e>t?2:1,m=(d||0)*(n+(1===p?u:0)),f=(l||0)*(n+(2===p?u:0)),h=m+f,g=h?_(m/h):0,I=h?_(f/h):0;return{side1pressure:g,side2pressure:I}}({side1ConvertedRating:s,side2ConvertedRating:c,score:r});u&&e[i?.participantId].pressureScores.push(u),d&&e[n?.participantId].pressureScores.push(d);let l=Math.max(...qh.ELO.range),p=_((c-s)/l),m=_((s-c)/l);e[i?.participantId].ratingVariation.push(p),e[n?.participantId].ratingVariation.push(m)}}function Yh({winningSide:e,matchUpFormat:t=ao,matchUpStatus:r,tallyPolicy:i,score:n}){let a=[0,0],o=n?.sets,s="number"==typeof e&&e-1,c=Yn(t),u=Jh(c?.bestOf??1);if("number"==typeof s&&(r===Sd&&i?.setsCreditForDefaults||r===Rd&&i?.setsCreditForWalkovers))a[s]=u;else for(let d of o||[]){let{winningSide:e}=d;e&&(a[e-1]+=1)}return"number"==typeof s&&r===Dd&&(+a[1-s]===u&&(a[1-s]-=1),i?.setsCreditForRetirements&&(a[s]=u)),a}function zh({matchUpFormat:e=ao,winningSide:t,matchUpStatus:r,tallyPolicy:i,score:n}){let{sets:a}=n||{};if(!a)return[0,0];let o="number"==typeof t&&t-1,s=Yn(e),c=Jh(s?.bestOf??1),u=s?.setFormat?.tiebreakAt||0,d=[[],[]];if("number"==typeof o&&(r===Sd&&i?.gamesCreditForDefaults||r===Rd&&i?.gamesCreditForWalkovers)){let e=c*(s?.setFormat?.setTo||0);d[o].push(e)}else a.forEach((e,t)=>{let r=(e.setNumber||t+1)>c&&s?.finalSetFormat?"finalSetFormat":"setFormat",n=s?.[r]?.based,a=s?.[r].tiebreakSet,{side1Score:o,side2Score:u}=e;Xh(n)&&!a&&(d[0].push(I(o||0)),d[1].push(I(u||0))),a&&e.winningSide&&!1!==i?.gamesCreditForTiebreakSets&&d[e.winningSide-1].push(1)});if(r===Dd&&"number"==typeof o){let n=a.length>c&&s?.finalSetFormat?"finalSetFormat":"setFormat",l=s?.[n];if(Xh(l.based)){let n=l?.setTo||0,p=e=>{if(s&&""!==e)return+e===u-1||+e===u?I(u||0)+1:+e<u?n:u},m=Yh({winningSide:t,score:{sets:a},matchUpStatus:r,matchUpFormat:e,tallyPolicy:i});if(d.map(e=>e[o]<=e[1-o]).reduce((e,t)=>e+(t?1:0),0)>m[1-o]){let e=d[o].length,t=p(d[1-o][e-1]);t&&(d[o][e-1]=t)}c>d[o].length&&i?.gamesCreditForRetirements&&d[o].push(n)}}return[d[0].reduce((e,t)=>e+t,0),d[1].reduce((e,t)=>e+t,0)]}function Kh({matchUpFormat:e,score:t}){let r=e?Yn(e):void 0,i=Jh(r?.bestOf??1),n=[0,0],a=[0,0];return t?.sets?.forEach((e,t)=>{let o=(e.setNumber||t+1)>i&&r?.finalSetFormat?"finalSetFormat":"setFormat",s=r?.[o]?.based;if(Qh(s)){let{side1Score:t,side2Score:r}=e;t&&(a[0]+=I(t||0)),r&&(a[1]+=I(r||0))}else e.side1TiebreakScore&&(a[0]+=I(e.side1TiebreakScore||0)),e.side2TiebreakScore&&(a[1]+=I(e.side2TiebreakScore||0)),(e.side1TiebreakScore||e.side2TiebreakScore)&&e.winningSide&&(n[e.winningSide-1]+=1)}),{pointsTally:a,tiebreaksTally:n}}function Jh(e){return e&&Math.ceil(e/2)||1}function Qh(e){return"P"===e}function Xh(e){return!Qh(e)}function Zh({participantIds:e,pressureRating:t,groupingTotal:r,matchUpFormat:i,tallyPolicy:n,perPlayer:a,matchUps:o}){let s={},c=n?.excludeMatchUpStatuses||[],d=o?.filter(t=>(t.tieMatchUps||!c.includes(t.matchUpStatus))&&(!e?.length||2===Q(e,[rg(t,0),rg(t,1)]).length)),p=d?.flatMap(({score:e,tieMatchUps:t})=>t?t.filter(({matchUpStatus:e})=>!c.includes(e)).flatMap(({score:e})=>e?.sets?.length??0):e?.sets?.length??0)?.reduce((e,t)=>e+t,0),m=e=>e?.sets?.reduce((e,t)=>e+(t?.side1Score??0)+(t?.side2Score??0),0)??0,f=d?.flatMap(({score:e,tieMatchUps:t})=>t?t.filter(({matchUpStatus:e})=>!c.includes(e)).flatMap(({score:e})=>m(e)):m(e))?.reduce((e,t)=>e+t,0);for(let h of d??[]){let{matchUpStatus:e,tieMatchUps:r,tieFormat:o,score:c,winningSide:d,sides:p}=h,m=o&&h._disableAutoCalc&&o.collectionDefinitions.every(({scoreValue:e})=>e),f=d&&eg(h),g=d&&tg(h);if(f||g)if(ig(s,f),ig(s,g),r?.length){a=0;for(let e of r){let{matchUpType:r}=e,i=Wm(l)(r),a=Wm(u)(r);e.winningSide&&(e.winningSide===d?(f&&(s[f].tieMatchUpsWon+=1,a&&(s[f].tieSinglesWon+=1),i&&(s[f].tieDoublesWon+=1)),g&&(s[g].tieMatchUpsLost+=1,a&&(s[g].tieSinglesLost+=1),i&&(s[g].tieDoublesLost+=1))):e.winningSide!==d&&(g&&(s[g].tieMatchUpsWon+=1,a&&(s[g].tieSinglesWon+=1),i&&(s[g].tieDoublesWon+=1)),f&&(s[f].tieMatchUpsLost+=1,a&&(s[f].tieSinglesLost+=1),i&&(s[f].tieDoublesLost+=1)))),ag({matchUpFormat:e.matchUpFormat,matchUpStatus:e.matchUpStatus,matchUpType:e.matchUpType,score:e.score,sides:e.sides,winningParticipantId:f,losingParticipantId:g,manualGamesOverride:m,participantResults:s,isTieMatchUp:!0,pressureRating:t,tallyPolicy:n,winningSide:d})}og({winningParticipantId:f,losingParticipantId:g,participantResults:s,matchUpStatus:e})}else ag({matchUpFormat:h.matchUpFormat??i,matchUpType:h.matchUpType,isTieMatchUp:void 0,winningParticipantId:f,manualGamesOverride:m,losingParticipantId:g,participantResults:s,pressureRating:t,matchUpStatus:e,tallyPolicy:n,winningSide:d,score:c,sides:p});else if(e&&kd.includes(e)){let e=rg(h,0),t=rg(h,1);e&&(ig(s,e),s[e].matchUpsCancelled+=1),t&&(ig(s,t),s[t].matchUpsCancelled+=1)}else if(r?.length){a=0;for(let e of r){if(e.winningSide){let t=p?.find(({sideNumber:t})=>t===e.winningSide)?.participantId,r=p?.find(({sideNumber:t})=>t===e.winningSide)?.participantId;t&&r&&(ig(s,t),ig(s,r),s[t].tieMatchUpsWon+=1,s[r].tieMatchUpsLost+=1,Wm(u)(e.matchUpType)?(s[t].tieSinglesWon+=1,s[r].tieSinglesLost+=1):Wm(l)(e.matchUpType)&&(s[t].tieDoublesWon+=1,s[r].tieDoublesLost+=1))}ng({score:e.score,manualGamesOverride:m,participantResults:s,sides:p})}}else ng({manualGamesOverride:m,participantResults:s,score:c,sides:p});if(m){let e=c?.sets?.reduce((e,t)=>e+(t?.side1Score??0),0),t=c?.sets?.reduce((e,t)=>e+(t.side2Score??0),0),r=p?.find(({sideNumber:e})=>1===e)?.participantId,i=p?.find(({sideNumber:e})=>2===e)?.participantId;ig(s,r),ig(s,i),r&&(s[r].gamesWon+=e,s[r].gamesLost+=t),i&&(s[i].gamesWon+=t,s[i].gamesLost+=e)}}return function({participantResults:e,groupingTotal:t,matchUpFormat:r,tallyPolicy:i,totalGames:n,perPlayer:a,totalSets:o}){let s=r&&Yn(r)||{},c=s.bestOf,u=c&&Math.ceil(c/2)||1,d=s.setFormat?.setTo,l=Math.pow(10,i?.precision||3);Object.keys(e).forEach(r=>{let s=e[r].setsWon,c=e[r].setsLost,p=i?.groupTotalSetsPlayed||"setsPct"===t?o:a*(u||0)||s+c,m=Math.round(s/p*l)/l;(m===1/0||Number.isNaN(m))&&(m=p);let f=e[r].tieMatchUpsWon,h=f+e[r].tieMatchUpsLost,g=Math.round(f/h*l)/l;(g===1/0||Number.isNaN(g))&&(g=f);let I=e[r].matchUpsWon,U=I+e[r].matchUpsLost,S=Math.round(I/U*l)/l;(S===1/0||Number.isNaN(S))&&(S=I);let v=e[r].gamesWon||0,y=e[r].gamesLost||0,w=(a||0)*(u||0)*(d||0),P=i?.groupTotalGamesPlayed||"gamesPct"===t?n:Math.max(w,v+y),T=Math.round(v/P*l)/l;(T===1/0||Number.isNaN(T))&&(T=0);let D=e[r].pointsWon+e[r].pointsLost,b=Math.round(e[r].pointsWon/D*l)/l;(b===1/0||Number.isNaN(b))&&(b=0),e[r].setsWon=s,e[r].setsLost=c,e[r].setsPct=m,e[r].tieMatchUpsWon=f,e[r].tieMatchUpsPct=g,e[r].matchUpsPct=S,e[r].gamesWon=v,e[r].gamesLost=y,e[r].gamesPct=T,e[r].pointsPct=b,e[r].result=`${e[r].matchUpsWon}/${e[r].matchUpsLost}`})}({participantResults:s,groupingTotal:r,matchUpFormat:i,tallyPolicy:n,totalGames:f,perPlayer:a,totalSets:p}),{participantResults:s}}function eg(e){return rg(e,e.winningSide-1)}function tg(e){return rg(e,1-(e.winningSide-1))}function rg(e,t){if(!e?.sides)return console.log("no sides:",{matchUp:e}),"foo";let r=e.sides[t];return r?r.participantId:(console.log("No Side",{matchUp:e,index:t}),"foo")}function ig(e,t){t&&!e[t]&&(e[t]={allDefaults:0,defaults:0,defeats:[],gamesLost:0,gamesWon:0,matchUpsCancelled:0,matchUpsLost:0,matchUpsWon:0,pointsLost:0,pointsWon:0,pressureScores:[],ratingVariation:[],retirements:0,setsLost:0,setsWon:0,tieSinglesWon:0,tieSinglesLost:0,tieDoublesWon:0,tieDoublesLost:0,tieMatchUpsLost:0,tieMatchUpsWon:0,victories:[],walkovers:0})}function ng({manualGamesOverride:e,participantResults:t,score:r,sides:i}){let{sets:n}=r||{},a=[[],[]],o=[0,0];for(let c of n||[]){let{winningSide:e,side1Score:t,side2Score:r}=c;e&&(o[e-1]+=1),a[0].push(I(t||0)),a[1].push(I(r||0))}let s=[a[0].reduce((e,t)=>e+t,0),a[1].reduce((e,t)=>e+t,0)];i.forEach((r,i)=>{let{participantId:n}=r;n&&(ig(t,n),t[n].setsWon+=o[i],t[n].setsLost+=o[1-i],e||(t[n].gamesWon+=s[i],t[n].gamesLost+=s[1-i]))})}function ag({winningParticipantId:e,manualGamesOverride:t,losingParticipantId:r,participantResults:i,pressureRating:n,matchUpFormat:a,matchUpStatus:o,isTieMatchUp:s,matchUpType:c,tallyPolicy:d,winningSide:l,score:p,sides:m}){let f=l&&l-1,h=1-f;n&&c===u&&Hh({participantResults:i,sides:m,score:p}),s||og({winningParticipantId:e,losingParticipantId:r,participantResults:i,matchUpStatus:o});let g=Yh({matchUpStatus:o,matchUpFormat:a,tallyPolicy:d,winningSide:l,score:p}),I=zh({matchUpStatus:o,matchUpFormat:a,tallyPolicy:d,winningSide:l,score:p}),{pointsTally:U}=Kh({score:p,matchUpFormat:a});e&&(i[e].setsWon+=g[f],i[e].setsLost+=g[h],t||(i[e].gamesWon+=I[f],i[e].gamesLost+=I[h]),i[e].pointsWon+=U[f],i[e].pointsLost+=U[h]),r&&(i[r].setsWon+=g[h],i[r].setsLost+=g[f],t||(i[r].gamesWon+=I[h],i[r].gamesLost+=I[f]),i[r].pointsWon+=U[h],i[r].pointsLost+=U[f])}function og({winningParticipantId:e,losingParticipantId:t,participantResults:r,matchUpStatus:i}){t&&(i===Rd&&(r[t].walkovers+=1),i===Sd&&(r[t].defaults+=1),i===Dd&&(r[t].retirements+=1),Sh(i)&&(r[t].allDefaults+=1),r[t].matchUpsLost+=1),e&&(r[e].matchUpsWon+=1),t&&e&&(r[t].defeats.push(e),r[e].victories.push(t))}function sg(e,t,r,i){if(e.excludedDirectives?.length){let t=e.excludedDirectives.map(({attribute:e})=>e).join(", "),r=`${t.length} directives were excluded due to participants limit}`;i.push(r);let n=`Excluded: ${t}`;i.push(n)}else{let n=(t,r)=>Number.parseFloat(e.reversed?t:r)-Number.parseFloat(e.reversed?r:t),a=e.groups?Object.values(e.groups).flat(1/0).length:e.participantIds?.length??0,o=e.reversed?" in reverse order":"",s=`Step ${t+1}: ${a} particiants were ${e.groups?"grouped":"separated"}${o} by ${e.attribute}`;if(i.push(s),e.idsFilter){let t=`${e.attribute} was calculated considering ONLY TIED PARTICIPANTS`;i.push(t)}!function(e,t,r,i){e.groups&&Object.keys(e.groups).sort(i).forEach(i=>{let n=e.groups[i].map(e=>t[e]).join(", "),a=`${i} ${e.attribute}: ${n}`;r.push(a)})}(e,r,i,n)}i.push("----------------------")}function cg({participantResults:e,participantIds:t,attribute:r}){return ug({participantResults:e,participantIds:t}).reduce((e,t)=>{let{participantId:i,results:n}=t,a=n?.[r];return!isNaN(a)&&i&&(e[a]?e[a].push(i):e[a]=[i]),e},{})}function ug(e){return(e.participantIds||Object.keys(e.participantResults)).reduce((t,r,i)=>(t.push({participantId:r,i:i,results:e.participantResults[r]}),t),[])}var dg=[{attribute:"matchUpsPct",idsFilter:!1},{attribute:"allDefaults",reversed:!0,idsFilter:!1},{attribute:"defaults",reversed:!0,idsFilter:!1},{attribute:"walkovers",reversed:!0,idsFilter:!1},{attribute:"retirements",reversed:!0,idsFilter:!1},{attribute:"setsPct",idsFilter:!1},{attribute:"gamesPct",idsFilter:!1},{attribute:"pointsPct",idsFilter:!1},{attribute:"matchUpsPct",idsFilter:!0},{attribute:"setsPct",idsFilter:!0},{attribute:"gamesPct",idsFilter:!0},{attribute:"pointsPct",idsFilter:!0}],lg={matchUpsPct:20,tieMatchUpsPct:16,pointsPct:4,gamesPct:8,setsPct:12};function pg(e){let{requireCompletion:t=!0,participantResults:r,subOrderMap:i,tallyPolicy:n}=e,a=[];if(t&&!function({participantResults:e,participantsCount:t}){let r=ug({participantResults:e}).filter(e=>t-1===e.results.matchUpsWon+e.results.matchUpsLost+e.results.matchUpsCancelled);return t===r.length}(e))return{};let o=["tieMatchUpsWon","tieSinglesWon","tieDoublesWon","matchUpsWon","pointsWon","gamesWon","setsWon","gamesPct","setsPct","pointsPct","matchUpsPct"].includes(n?.groupOrderKey)?n.groupOrderKey:"matchUpsWon",s=cg({participantResults:r,attribute:o});a.push({attribute:o,groups:s});let c,u,d=Object.keys(s).map(e=>Number.parseFloat(e)).sort((e,t)=>t-e).map(e=>s[e]).map(t=>{let r=mg({participantIds:t,...e});return a.push(...r.report??[]),r.order}).flatMap((e,t)=>e.map(e=>e.resolved?e:{...e,subGroup:[t].concat(...e.subGroup??[])})),l=0,p=1;d.forEach((e,t)=>{t&&(e.resolved||u&&!e.resolved)&&(p+=1),u=e.resolved;let r=Number.parseInt(e.subGroup?.join("")||0);e.resolved?(e.position=t+1,p=e.position):(c&&r>c&&(p+=l,l=0),e.position=p,l+=1),c=r});let m=j(d.map(({position:e})=>e));return d.forEach(e=>{let{participantId:t,position:a}=e||{},o=r[t];e.GEMscore=function(e){return(Array.isArray(n?.GEMscore)?Object.keys(lg).filter(e=>n.GEMscore.includes(e)):Object.keys(lg)).map(t=>(e[t]||0)*Math.pow(10,lg[t].toFixed(3))).reduce((e,t)=>e+t,0)}(o);let s=m[a];void 0!==e?.position&&(s>1&&(e.ties=s,i&&(e.subOrder=i[t])),e.rankOrder=a,e.groupOrder=a+(e.subOrder||1)-1)}),{groupOrder:d,report:a.flat(1/0).filter(Boolean)}}function mg({participantResults:e,disableHeadToHead:t,participantIds:r,matchUpFormat:i,tallyPolicy:n,matchUps:a}){let o,s=[],c=[];if(1===r?.length)return{order:[{resolved:!0,participantId:r[0]}]};if(2===r?.length&&(!n?.headToHead||!n.headToHead.disabled&&!t)){let t=function({participantIds:e,participantResults:t}){if(e){if(t[e[0]].victories.includes(e[1]))return e.map(e=>({resolved:!0,participantId:e}));if(t[e[1]].victories.includes(e[0]))return e.reverse().map(e=>({resolved:!0,participantId:e}))}}({participantIds:r,participantResults:e});if(t){let e=t[0].participantId;return c.push({attribute:"head2Head",participantIds:r,headToHeadWinner:e}),{order:t,headToHeadWinner:e,report:c}}}let u=(n?.tallyDirectives||dg).filter(e=>{let t=!(E(e.maxParticipants)&&r?.length>e.maxParticipants);return t||s.push(e),t});return s.length&&c.push({excludedDirectives:s,participantIds:r}),u.every(({attribute:e,reversed:t,idsFilter:s,groupTotals:u,disableHeadToHead:d})=>(o=function({disableHeadToHead:e,participantIds:t,matchUpFormat:r,groupTotals:i,tallyPolicy:n,attribute:a,idsFilter:o,matchUps:s,reversed:c}){let u,{participantResults:d}=Zh({participantIds:o&&t,groupingTotal:i&&a,matchUpFormat:r,tallyPolicy:n,matchUps:s}),l=cg({participantResults:d,participantIds:t,attribute:a}),p=[{attribute:a,reversed:c,groups:l,idsFilter:o,groupTotals:i}];return Object.keys(l).length>1&&t.length&&(u=Object.keys(l).map(e=>Number.parseFloat(e)).sort((e,t)=>c?e-t:t-e).map(e=>l[e]).map(t=>{let i=mg({participantResults:d,disableHeadToHead:e,participantIds:t,matchUpFormat:r,tallyPolicy:n,matchUps:s});return p.push(...i.report??[]),i.order}).flatMap((e,t)=>e.map(e=>e.resolved?e:{...e,subGroup:[t].concat(...e.subGroup??[])}))),{order:u,report:p}}({disableHeadToHead:d,participantIds:r,matchUpFormat:i,groupTotals:u,tallyPolicy:n,attribute:e,idsFilter:s,matchUps:a,reversed:t}),c.push(o.report),!o.order)),o.order?{order:o.order,report:c}:{order:r?.map(e=>({participantId:e})),report:c}}function fg({policyDefinitions:e,generateReport:t,pressureRating:r,matchUpFormat:i,matchUps:n=[],subOrderMap:a,perPlayer:o}){if(!n?.length||!Zp(n))return{error:At};let s=L(n.map(({structureId:e})=>e));if(1!==s.length)return Pn({result:{error:gi,info:"Maximum one structureId"},stack:"tallyParticipantResults",context:{structureIds:s}});let c=n.filter(e=>e&&"BYE"!==e.matchUpStatus),u=c.length&&L(c.flatMap(({drawPositions:e})=>e)).length,d=c.filter(e=>Vf({matchUp:e})).length===c.length;d||(o=0);let l,p,f=n.every(({matchUpType:e,tieMatchUps:t})=>e===m&&t?.every(e=>Vf({matchUp:e}))),h=e?.[tu],g=n.filter(e=>Vf({matchUp:e})??e.matchUpType===m),{participantResults:I}=Zh({matchUps:g,pressureRating:r,matchUpFormat:i,tallyPolicy:h,perPlayer:o}),{groupOrder:U,report:S}=pg({matchUps:g,participantResults:I,participantsCount:u,matchUpFormat:i,subOrderMap:a,tallyPolicy:h});if(r&&function({participantResults:e}){let t=e=>e.reduce((e,t)=>e+parseFloat(t),0),r=e=>parseFloat((t(e)/e.length).toFixed(2)),i=Object.keys(e).map(t=>{let i=e[t],{pressureScores:n}=i;return{participantId:t,averagePressure:n?.length?r(n):0}}).sort((e,t)=>(t.averagePressure||0)-(e.averagePressure||0)).map((e,t)=>({...e,order:t+1}));for(let n of i)e[n.participantId].pressureOrder=n.order}({participantResults:I}),d&&U)l=S,p=U,U.forEach(e=>{let{participantId:t,groupOrder:r,rankOrder:i,subOrder:n,ties:a,GEMscore:o}=e,s=I[t];Object.assign(s,{groupOrder:r,rankOrder:i,GEMscore:o,subOrder:n,ties:a})});else{let{groupOrder:e,report:t}=pg({requireCompletion:!1,participantResults:I,participantsCount:u,matchUpFormat:i,tallyPolicy:h,subOrderMap:a,matchUps:n});l=t,p=e,e&&e.forEach(e=>{let{participantId:t,groupOrder:r,GEMscore:i}=e,n=I[t];Object.assign(n,{provisionalOrder:r,GEMscore:i})})}let v={completedTieMatchUps:f,readableReport:"",participantResults:I,bracketComplete:d,order:[],report:l};if((d||f)&&(v.order=p),t||$i({tally:!0})){let e=function({matchUps:e,order:t,report:r}){let i={};e.forEach(({sides:e})=>{e.forEach(e=>{e.participantId&&e.participant&&(i[e.participantId]=e.participant.participantName)})});let n=[];return Array.isArray(r)&&r.forEach((e,t)=>{sg(e,t,i,n)}),n.push("Final Order:"),t.forEach(e=>{let{participantId:t,resolved:r}=e,a=e.groupOrder||e.provisionalOrder;n.push(`${a}: ${i[t]} => resolved: ${!!r}`)}),n.join("\r\n")}({matchUps:n,report:l,order:p});$i({tally:!0})&&console.log(e),v.readableReport=e}return v}function hg({requireTimeStamp:e,scaleAttributes:t,participant:r}){if(!r)return{error:hr};if(!v(t))return{error:gi};if(r.timeItems??=[],Array.isArray(r.timeItems)){let{accessor:i,scaleType:n,eventType:a,scaleName:o}=t,s=[zc,n,a,o].join("."),c=r.timeItems.filter(e=>e?.itemType===s).filter(t=>!e||t?.itemDate).sort((e,t)=>(e.createdAt?new Date(e.createdAt).getTime():0)-(t.createdAt?new Date(t.createdAt).getTime():0)).pop();if(c){let[e,t,r,n]=c.itemType?.split(".")??[];if(e!==zc)return{error:oi};let a=i&&rh({element:c.itemValue,accessor:i}),o=a?.value||c.itemValue,s={rawValue:a&&c.itemValue,eventType:r,scaleDate:c.itemDate,scaleValue:o,scaleName:n,scaleType:t};return{...ce,scaleItem:s}}}return{...ce,scaleItem:void 0}}function gg({publishedSeeding:e,usePublishState:t,withSeeding:r,participant:i,event:n}){let a={},o=e=>[zc,Kc,n.eventType,e].join("."),s=Object.assign({},...(i.timeItems||[]).filter(({itemType:e})=>e.split(".")[1]===Kc).map(({itemType:e,itemValue:t})=>({[e]:t}))),c=(e?.stageSeedingScaleNames&&Object.values(e?.stageSeedingScaleNames)||Array.isArray(e?.seedingScaleNames)&&e.seedingScaleNames||[]).map(o),u=Q(Object.keys(s),c);if(t&&(Object.keys(s).length||e?.drawIds?.length)&&!u.length||!u.length)if(t||"object"!=typeof r){let r,{categoryName:o,ageCategoryCode:s}=n.category||{},c=[s,n.eventId,o].filter(Boolean);for(let e of c){let t=hg({scaleAttributes:{eventType:n.eventType,scaleType:Kc,scaleName:e},participant:i});if(t.scaleItem){r=t.scaleItem;break}}if(r&&(!t||e?.published&&!e?.published?.drawIds?.length)){let e=r.scaleValue;a.seedValue=e}}else{let e=Object.keys(r).map(e=>{let t=o(r[e]);return[e,s[t]]}).filter(e=>e[1]).map(e=>({[e[0]]:{seedValue:e[1]}})),t=Object.assign({},...e);a.seedAssignments=t}else if(e?.stageSeedingScaleNames){let t=Object.keys(e.stageSeedingScaleNames).map(t=>{let r=o(e.stageSeedingScaleNames[t]);return[t,s[r]]}).filter(e=>e[1]).map(e=>({[e[0]]:{seedValue:e[1]}})),r=Object.assign({},...t);a.seedAssignments=r}else if(u){let e=u.map(e=>s[e]);a.seedValue=e.pop()}return a}function Ig({positionAssignments:e}){let t=(e||[]).filter(nh(tc)).map(e=>{let{extension:t}=Ru({element:e,name:Ku}),r=I(t?.value),i=!isNaN(r)&&r;return i&&{participantId:e.participantId,subOrder:i}}).filter(Boolean),r=j(t.map(({subOrder:e})=>e));return{subOrderMap:Object.assign({},...t.filter(({subOrder:e})=>1===r[e]).map(({participantId:e,subOrder:t})=>({[e]:t})))}}function Ug({convertExtensions:e,seedAssignments:t,participant:r,withSeeding:i,seedValue:n,eventId:a,ranking:o,entry:s}){let{entryStatus:c,entryStage:u,entryPosition:d,extensions:l}=s,p=l?.length&&e?Object.assign({},...Ha(l??[])):{},m=Object.assign(p,{entryPosition:d,entryStatus:c,entryStage:u,ranking:o,eventId:a});r.events[a]=wn(m,!1,!1,!0),i&&(t&&(r.events[a].seedAssignments=t),n&&(r.events[a].seedValue=n))}function Sg(e){let t=$c(e,[{[Js]:!0}]);if(t.error)return t;let{tournamentRecord:r,status:i=Gm}=e,n=`${Vm}.${jm}`;return Wa(ep({tournamentRecord:r,itemType:n})?.timeItem?.itemValue?.[i],!1,!0)}function vg({event:e,status:t=Gm}){let r=`${Vm}.${jm}`;return Zl({itemType:r,event:e})?.timeItem?.itemValue?.[t]}function yg({drawDetails:e,drawId:t}){return e?.[t]?.publishingDetail?.published}function wg(e){let{tournamentRecord:t,drawDefinition:r,eventIds:i,eventId:n,drawIds:a,drawId:o,event:s}=e??{};if(t&&!function(e){let{tournamentId:t}=e??{};return!!t}(t))return{error:gi};if(n&&!s)return{error:st};if(Array.isArray(i)&&i?.length){let e={};for(let r of i){if(!S(r))return{error:gi};let i=Af({tournamentRecord:t,eventId:r})?.event;if(!i)return{error:st};let n=Pg({event:i});e[r]=n}return{...ce,publishState:e}}if(s){let e=Pg({event:s}),t={};if(o)return r?{publishState:{status:{published:!!e.status.publishedDrawIds?.includes(o),drawDetail:e.status.drawDetails?.[o]},...ce}}:{error:Pe};if(Array.isArray(a)&&a?.length){let r=s.drawDefinitions?.map(pd)??[];for(let i of a){if(!S(i))return{error:gi};if(!r.includes(i))return{error:Pe};t[i]={status:{published:!!e.status.publishedDrawIds.includes(i),drawDetail:e.status.drawDetails?.[i]}}}}else t=e;return{...ce,publishState:t}}let c=[],u=!1,d={};for(let l of t?.events??[]){let e=Pg({event:l});d[l.eventId]=e,e.status.published&&(c.push(l.eventId),u=!0);for(let{drawId:t}of l.drawDefinitions??[]){let r=e.status?.publishedDrawIds?.includes(t);r&&(d[t]={status:{published:r}})}}if(t){let e=Sg({tournamentRecord:t});d.tournament=e??{},(e?.orderOfPlay?.published||e?.participants?.published)&&(u=!0),d.tournament.status={published:u,publishedEventIds:c}}return{...ce,publishState:d}}function Pg({event:e}){let t=vg({event:e});if(!t)return{status:{published:!1}};let r={published:void 0,seedingScaleNames:[],drawIds:[]};t.seeding&&Object.assign(r,t.seeding);let i=t.drawDetails??{};for(let o of e.drawDefinitions?.map(pd)||[])i[o]||(i[o]={publishingDetail:{published:!1}});let n=i&&Object.keys(i).length&&Object.keys(i).filter(e=>yg({drawDetails:i,drawId:e})),a=n?.length?n:t.drawIds??[];if(a?.length&&!n?.length)for(let o of a)i[o]={publishingDetail:{published:!0}};return{status:{publishedDrawIds:a,publishedSeeding:r,drawDetails:i,published:a?.length>0}}}function Tg(e){let{participantMap:t,participantId:r,matchUpStatus:i,roundPosition:n,structureId:a,matchUpType:o,roundNumber:s,matchUpId:c,potential:u,schedule:d,drawId:l,score:p}=e;d&&Object.keys(d).length&&("BYE"===i||t[r].scheduleItems.push({...d,scheduledDate:ya(d?.scheduledDate),scheduledTime:va(d?.scheduledTime),checkScoreHasValue:ch({score:p}),matchUpStatus:i,roundPosition:n,structureId:a,matchUpType:o,roundNumber:s,matchUpId:c,potential:u,drawId:l}))}function Dg({finishingPositionRange:e={winner:[],loser:[]},participantMap:t,finishingRound:r,participantWon:i,matchUpStatus:n,participantId:a,stageSequence:o,roundNumber:s,structureId:c,matchUpId:u,drawId:d,stage:l}){let p=t[a],m=e=>Math.abs(e[0]-e[1]);p.structureParticipation[c]||(p.structureParticipation[c]={rankingStage:l,walkoverWinCount:0,defaultWinCount:0,stageSequence:o,winCount:0,structureId:c,drawId:d});let f=p.structureParticipation[c],{winner:h,loser:g}=e,I=i?h:g;i&&(f.winCount+=1,n===Rd&&(f.walkoverWinCount+=1),n===Sd&&(f.defaultWinCount+=1)),I&&(!f.finishingPositionRange||m(I)<m(f.finishingPositionRange))&&(f.finishingPositionRange=I),r&&((!f.finishingRound||r<f.finishingRound)&&(f.finishingMatchUpId=u,f.finishingRound=r,f.roundNumber=s),1===r&&(f.participantWon=i))}function bg(e){let{withScheduleItems:t,scheduleAnalysis:r,withTeamMatchUps:i,participantMap:n,withOpponents:a,withMatchUps:o,withEvents:s,withDraws:c,finishingPositionRange:u,finishingRound:d,matchUpStatus:l,stageSequence:p,roundNumber:f,structureId:h,score:g,stage:I,withRankingProfile:U,tieWinningSide:S,roundPosition:v,matchUpTieId:y,matchUpSides:w,collectionId:P,matchUpType:T,winningSide:D,matchUpId:b,schedule:M,eventId:R,drawId:N,sides:A}=e,E=a&&2===A?.length&&Object.assign({},...A.map(({sideNumber:e},t)=>{let r=A[1-t].participantId;return e&&{[e]:r}}).filter(Boolean));for(let C of A){let{participantId:e,sideNumber:A,bye:O}=C;if(O)continue;let k=D===A,F=e=>{let t=n[e]?.participant,r=t?.participantType,i=[{participantId:e,participantType:r}];if(r!==Bl)for(let a of t?.individualParticipantIds||[]){let e=n[a]?.participant;i.push({participantType:e?.participantType,participantId:a})}return i},x=(e,i)=>{if(o){if(n[e].matchUps[b]={participantWon:k,matchUpType:T,structureId:h,sideNumber:A,matchUpId:b,eventId:R,drawId:N,stage:I},a){let t=F(i);n[e].matchUps[b].opponentParticipantInfo=t}P&&(n[e].matchUps[b].collectionId=P)}a&&i&&(n[e].opponents[i]={participantId:i,matchUpId:b,eventId:R,drawId:N}),U&&Dg({finishingPositionRange:u,participantMap:n,participantWon:k,finishingRound:d,matchUpStatus:l,participantId:e,stageSequence:p,roundNumber:f,structureId:h,matchUpId:b,drawId:N,stage:I}),(r||t)&&Tg({participantMap:n,participantId:e,matchUpStatus:l,roundPosition:v,matchUpType:T,roundNumber:f,structureId:h,matchUpId:b,schedule:M,drawId:N,score:g})},_=({participant:e,partnerParticipantId:t})=>{let r=(e,t)=>{e&&(e.partnerParticipantIds||(e.partnerParticipantIds=[]),e.partnerParticipantIds.includes(t)||e.partnerParticipantIds.push(t))};c&&r(e?.draws?.[N],t),s&&r(e?.events?.[R],t),o&&r(e?.matchUps?.[b],t)};if(e&&n[e]){let t=E?.[A];x(e,t);let r=n[e]?.participant.participantType===jl,a=n[e]?.participant.individualParticipantIds||[];if(y){if(i){let t=e=>n[e].matchUps[y]={participantWon:S===A,matchUpId:y,matchUpType:m,sideNumber:A};t(e),a.forEach(t)}if(c&&!n[e].draws[N]){let t=w.find(e=>e.sideNumber===A)?.participant?.participantId,r=n[t]?.draws?.[N]?.entryStatus,i=e=>n[e].draws[N]={entryStatus:r,eventId:R,drawId:N};i(e),a.forEach(i)}}if(r&&(a.forEach(e=>n[e]&&x(e,t)),a.forEach((e,t)=>{let r=a[1-t],i=n[e];i&&_({participant:i,partnerParticipantId:r})}),s&&w)){let t=w.find(e=>e.sideNumber===A)?.participant?.participantId;if(t){let r=n[t]?.events[R];r?(n[e].events[R]={...r},a.forEach(e=>n[e].events[R]={...r})):console.log("Missing teamEntry",{eventId:R,teamParticipantId:t})}}if(D){let t=e=>{k?(n[e].counters[T].wins+=1,n[e].counters.wins+=1,l===Rd&&(n[e].counters[T].walkoverWins+=1,n[e].counters.walkoverWins+=1),l===Sd&&(n[e].counters[T].defaultWins+=1,n[e].counters.defaultWins+=1)):(n[e].counters[T].losses+=1,n[e].counters.losses+=1,l===Rd&&(n[e].counters[T].walkovers+=1,n[e].counters.walkovers+=1),l===Sd&&(n[e].counters[T].defaults+=1,n[e].counters.defaults+=1))};t(e),a.forEach(t)}}}}function Mg(e,t){return(e||"").localeCompare(t||"")}function Rg({participantFilters:e={},tournamentRecord:t,participants:r=[]}){if(!Object.keys(e).length)return r;let{accessorValues:i,drawEntryStatuses:n,positionedParticipants:a,eventEntryStatuses:o,participantRoles:s,participantRoleResponsibilities:c,participantTypes:u,participantIds:d,signInStatus:l,enableOrFiltering:p,eventIds:m,genders:f}=e,h=Ng(m)&&t?.events?.filter(e=>m?.includes(e.eventId))||t?.events||[],g=n&&function({drawEntryStatuses:e,tournamentEvents:t}){let r=({entryStatus:t})=>!Array.isArray(e)||e.includes(t);return L(t.reduce((e,t)=>{let{flightProfile:i}=Nf({event:t}),n=i?.flights?.flatMap(({drawEntries:e})=>Array.isArray(e)?e.filter(r).map(dd):[])||[],a=t.drawDefinitions?.map(({entries:e})=>e?e.filter(r).map(dd):[])||[];return e.concat(...n,...a)},[]))}({drawEntryStatuses:n,tournamentEvents:h}),I=o&&function({eventEntryStatuses:e,tournamentEvents:t}){return L(t.reduce((t,r)=>{let i=(r.entries||[]).filter(({entryStatus:t})=>!Array.isArray(e)||e.includes(t)).map(dd);return t.concat(...i)},[]))}({eventEntryStatuses:o,tournamentEvents:h}),U=void 0!==a&&[!0,!1].includes(a)&&h.reduce((e,t)=>e.concat(...(t.drawDefinitions||[]).map(e=>jd({drawDefinition:e}).allPositionedParticipantIds).filter(Boolean)),[]),S=e=>i?.reduce((t,r)=>{let{accessor:i,value:n}=r,{values:a}=rh({element:e,accessor:i});return t&&a?.includes(n)},!0);if(r=r?.filter(e=>{let t=Ql({element:e,itemType:xl})?.timeItem?.itemValue,{participantRoleResponsibilities:r,participantType:n,participantRole:o,participantId:m,person:h}=e,v=Array.isArray(f)&&f?.length&&h?.sex&&f.includes(h.sex);return p?f&&v||a&&U.includes(m)||!1===a&&!U.includes(m)||g?.includes(m)||I?.includes(m)||d?.includes(m)||l&&t===l||u&&n&&Ng(u)&&u.includes(n)||s&&o&&Ng(s)&&s.includes(o)||c&&Ng(r)&&Ng(c)&&c.find(e=>r?.includes(e))||i?.length&&Ng(i)&&S(e):(!f||v)&&(void 0===a||a&&U.includes(m)||!1===a&&!U.includes(m))&&(!g||g.includes(m))&&(!I||I.includes(m))&&(!d||d.includes(m))&&(!l||t===l)&&(!u||n&&Ng(u)&&u.includes(n))&&(!s||o&&Ng(s)&&s.includes(o))&&(!c||Ng(r)&&Ng(c)&&c.find(e=>r?.includes(e)))&&(!i?.length||Ng(i)&&S(e))}),h.length&&m){let e=new Set(h.filter(e=>m.includes(e.eventId)).flatMap(e=>{let r=(e.entries||[]).map(e=>e.participantId);if(Wm(Bo)(e.eventType))return r;let i=(t?.participants??[]).filter(e=>r.includes(e.participantId)).flatMap(e=>e.individualParticipantIds);return r.concat(...i)}));r=r?.filter(t=>e.has(t.participantId))}return r}function Ng(e){return e&&Array.isArray(e)&&e.length}function Ag(e){let{withIndividualParticipants:t,participantFilters:r={},withPotentialMatchUps:i,withRankingProfile:n,convertExtensions:a,policyDefinitions:o,withScheduleItems:s,tournamentRecord:c,scheduleAnalysis:d,withSignInStatus:p,withTeamMatchUps:m,withScaleValues:f,usePublishState:h,withStatistics:g,contextFilters:I,matchUpFilters:U,contextProfile:S,withOpponents:y,withMatchUps:w,internalUse:P,withSeeding:T,withEvents:D,withDraws:b,withISO2:M,withIOC:R}=e;if(!c)return Pn({stack:"getParticipants",result:{error:Ie}});(w||n)&&sh({tournamentRecord:c});let N=np({convertExtensions:a,tournamentRecord:c,withSignInStatus:p,withScaleValues:f,internalUse:P,withISO2:M,withIOC:R}),{participantMap:A}=N,E=function(e){let{participantFilters:t,convertExtensions:r,policyDefinitions:i,tournamentRecord:n,usePublishState:a,contextFilters:o,matchUpFilters:s,participantMap:c,contextProfile:d,withPotentialMatchUps:p,withRankingProfile:m,withScheduleItems:f,scheduleAnalysis:h,withTeamMatchUps:g,withStatistics:I,withOpponents:U,withMatchUps:S,withSeeding:y,withEvents:w,withDraws:P}=e,T=t?.participantIds,D=e=>{let t=[e];return c[e]?.participant.individualParticipantIds?.forEach(e=>t.push(e)),t.some(e=>!T?.length||T.includes(e))?t:[]},b={withMatchUps:S||m,withEvents:w||m,withDraws:P||m,withPotentialMatchUps:p,withRankingProfile:m,withScheduleItems:f,scheduleAnalysis:h,withTeamMatchUps:g,withStatistics:I,participantMap:c,withOpponents:U,withSeeding:y},M=[],R={},N=[],A={},E={},C={},O={},k={},F=({eventType:e,scaleNames:t,participantId:r})=>c[r]?.participant?.rankings?.[e]?.find(e=>t.includes(e.scaleName))?.scaleValue;for(let u of n?.events||[]){if(t?.eventIds&&!t.eventIds.includes(u.eventId))continue;let{drawDefinitions:e=[],extensions:l=[],eventType:v,eventName:T,category:M,entries:x,eventId:_,gender:B}=u,{flightProfile:V}=Nf({event:u}),G=V?.flights??[],j=wg({event:u}).publishState;j&&(A[_]=j);let $=j?.status?.publishedSeeding;if(w||y||m){let e=r?Object.assign({},...Ha(l??[])):{};E[_]={...e,eventName:T,eventType:v,category:M,eventId:_,gender:B};let t=[M?.categoryName,M?.ageCategoryCode].filter(Boolean);for(let i of x){let{participantId:e}=i;if(!e||!c[e])continue;let n,o,s=F({eventType:v,scaleNames:t,participantId:e});if(y){let t=c[e].participant;({seedAssignments:n,seedValue:o}=gg({publishedSeeding:$,usePublishState:a,withSeeding:y,participant:t,event:u}))}let d=e=>{if(c[e]?.events?.[_])return;let t=c[e];Ug({convertExtensions:r,seedAssignments:n,participant:t,withSeeding:y,seedValue:o,eventId:_,ranking:s,entry:i})};d(e),(c[e].participant.individualParticipantIds||[]).forEach(d)}}let q=A?.[_]?.publishedSeeding;if(P||m||y){let t=e=>e?Object.assign({},...e.map(({participantId:e,seedValue:t,seedNumber:r})=>({[e]:{seedValue:t,seedNumber:r}}))):void 0,r=L([...e.map(pd),...G.map(pd)]);for(let i of r){let r,n,o,s,u=e.find(e=>e.drawId===i),d=[M?.categoryName,M?.ageCategoryCode].filter(Boolean),{structures:l=[],drawOrder:p,drawName:f,drawType:h}=u??{},g=G?.find(e=>e.drawId===i),I=u?.entries||g?.drawEntries,U=g?.flightNumber,S=(u?.structures||[]).sort((e,t)=>Ld(e,t)).map(({structureId:e,structures:t})=>[e,...(t||[]).map(({structureId:e})=>e)]).flat(1/0),w=0,T=new Set(l.filter(({stage:e,stageSequence:t})=>e===Ho&&1===t||e===Yo).flatMap(e=>{let{positionAssignments:t}=$d({structure:e}),{seedAssignments:i,stageSequence:a,stage:c}=e;return c===Ho?(w=t?.length??0,o=t,s=i):1===a&&(r=t,n=i),t}).map(({participantId:e})=>e).filter(Boolean)),D=t(s),b=t(n),R=u?I.filter(({participantId:e})=>T.has(e)):I,N=!a||q?.published&&(0===q?.drawIds?.length||q?.drawIds?.includes(i));for(let e of R){if(!c[e.participantId])continue;let{entryStatus:t,entryStage:r,entryPosition:n,participantId:a}=e,o=F({participantId:a,scaleNames:d,eventType:v}),s=e=>{if(!c[e]||c[e].draws?.[i])return;let s=y&&N,u=s?{}:void 0,d=s?D?.[a]?.seedValue||D?.[a]?.seedNumber:void 0,l=d?D?.[a]:void 0,p=s?b?.[a]?.seedValue||b?.[a]?.seedNumber:void 0,f=p?b?.[a]:void 0;u&&d&&(u[Ho]=l),u&&p&&(u[Yo]=f);let h=d||p;h&&(c[e].participant.seedings[v]||(c[e].participant.seedings[v]=[]),l&&c[e].participant.seedings[v].push({...l,scaleName:i}),f&&c[e].participant.seedings[v].push({...f,scaleName:i}),u&&(c[e].events[_].seedAssignments||(c[e].events[_].seedAssignments={}),Object.keys(u).forEach(t=>c[e].events[_].seedAssignments[t]=u[t]))),(P||m)&&(c[e].draws[i]=wn({seedAssignments:u,entryPosition:n,entryStatus:t,entryStage:r,seedValue:h,eventId:_,ranking:o,drawId:i},!1,!1,!0))};[Cp,Op].includes(t)||(s(a),(c[a].participant.individualParticipantIds||[])?.forEach(s))}let A=(u?.structures??[]).reduce((e,t)=>(e.includes(t.stage)||e.push(t.stage),e),[]),E=(u?.links??[]).length;C[i]={qualifyingPositionAssignments:r,qualifyingSeedAssignments:n,mainPositionAssignments:o,qualifyingSeedingMap:b,mainSeedAssignments:s,orderedStructureIds:S,mainSeedingMap:D,flightNumber:U,linksCount:E,drawOrder:p,drawName:f,drawType:h,drawSize:w,drawId:i,stages:A}}}if(m||h||g||I||U||S||P){let t=!!h||p,r=Qf({afterRecoveryTimes:!!h,policyDefinitions:i,tournamentRecord:n,inContext:!0,participantMap:c,contextFilters:o,matchUpFilters:s,contextProfile:d,nextMatchUps:t,event:u})?.matchUps??[];for(let i of r){let{finishingPositionRange:r,potentialParticipants:a,tieMatchUps:o=[],sides:s=[],winningSide:u,matchUpType:d,matchUpId:l,eventId:p,drawId:g,collectionId:I,containerStructureId:U,stageSequence:S,finishingRound:v,matchUpStatus:y,roundPosition:w,roundNumber:P,structureId:T,schedule:M,score:N,stage:A}=i;if(R[l]=i,m&&U&&T&&g&&(O[T]||(O[T]=[]),O[T].push(i),!k[U])){let t=e.find(e=>e.drawId===g);t&&(k[U]={drawDefinition:t,drawId:g})}let E={finishingPositionRange:r,containerStructureId:U,finishingRound:v,stageSequence:S,roundPosition:w,collectionId:I,roundNumber:P,structureId:T,schedule:M,eventId:p,drawId:g,score:N,stage:A};bg({tournamentRecord:n,drawDefinitions:e,...E,...b,matchUpStatus:y,winningSide:u,matchUpType:d,matchUpId:l,sides:s});for(let e of o){let{winningSide:t,sides:r=[],matchUpId:i,matchUpStatus:n,matchUpType:a}=e;bg({...E,...b,winningSide:t,tieWinningSide:u,matchUpTieId:l,matchUpId:i,sides:r,matchUpSides:s,matchUpStatus:n,matchUpType:a})}Array.isArray(a)&&(t||h||f)&&a.flat().map(dd).filter(Boolean)?.forEach(e=>{D(e)?.forEach(e=>{c[e]&&(c[e].potentialMatchUps[l]=wn({tournamentId:n?.tournamentId,matchUpId:l,eventId:p,drawId:g}))}),(h||f)&&Tg({potential:!0,participantMap:c,participantId:e,matchUpStatus:y,roundPosition:w,structureId:T,matchUpType:d,roundNumber:P,matchUpId:l,schedule:M,drawId:g,score:N})})}N.push(...r)}}let x={};if(m)for(let[u,l]of Object.entries(k)){let{drawDefinition:e,drawId:t}=l,r=e.structures?.find(e=>e.structureType===cs&&e.stage===Ho&&1===e.stageSequence);if(!r?.structures)continue;let i=r.structures,n=i.length,a=i.reduce((e,t)=>e+(t.positionAssignments?.length||0),0),o=e.structures?.find(e=>e.stage===Jo);x[t]||(x[t]={});for(let s of i){let r=O[s.structureId];if(!r?.length)continue;let i=s.positionAssignments?.length,{subOrderMap:c}=Ig({positionAssignments:s.positionAssignments}),d=fg({matchUps:r,subOrderMap:c});if(d?.participantResults)for(let[s,l]of Object.entries(d.participantResults)){let r,{groupOrder:c,provisionalOrder:d}=l,p=c||d;if(p){if(a===i&&p)r=[p,p];else if(n>1&&p&&!o)r=[1,n];else if(n>1&&p&&o){let t=e.links?.find(e=>e.source.structureId===u)?.source?.finishingPositions;if(t){let e=t.length*n;r=t.includes(p)?[1,e]:[e+1,a-(i-p)*n]}}r&&(x[t][s]=r)}}}}if(I||m||h){let e=Object.values(c);for(let t of e){let{wins:e,losses:r,[u]:{wins:i,losses:n},[l]:{wins:a,losses:o}}=t.counters,s=(e,r,i)=>{let n=r+i,a=r,o=n&&a/n;t.statistics[e]={denominator:n,numerator:a,statValue:o,statCode:e}};if(I&&(s(gp,e,r),s(`${gp}.${u}`,i,n),s(`${gp}.${l}`,a,o)),m){let e=(e=[])=>Math.abs(e[0]-e[1]);for(let r of Object.keys(t.draws)){let{orderedStructureIds:i=[],flightNumber:n}=C[r]||{};if(t.structureParticipation&&i.length){let a,o=0,s=i.map(r=>{let i=t.structureParticipation[r];if(!i)return;a||(a=i?.finishingPositionRange),e(a)>e(i?.finishingPositionRange)&&(a=i?.finishingPositionRange);let s=i.stage!==Yo;return s&&(o+=1),wn({...i,participationOrder:s?o:void 0,flightNumber:n})}).filter(Boolean);if(t.draws[r]){let e=t.participant.participantId,i=x[r]?.[e];i&&(a=i),t.draws[r].finishingPositionRange=a,t.draws[r].structureParticipation=s}}}}if(h){let e=v(h)?h.scheduledMinutesDifference:0,r=t.scheduleItems||[],i=t.potentialMatchUps||{},n=r.reduce((e,t)=>{let{scheduledDate:r,scheduledTime:i}=t;return e[r]||(e[r]=[]),i&&e[r].push(t),e},{});Object.values(n).forEach(e=>e.sort(Da));for(let o of r){let{typeChangeTimeAfterRecovery:r,timeAfterRecovery:a,scheduledDate:s,scheduledTime:c}=o,u=n[s],d=Ua(c);for(let n of u){if(n.matchUpId===o.matchUpId||Sh(n.matchUpStatus)&&!n.checkScoreHasValue)continue;let s=o.matchUpType!==n.matchUpType&&r||a,c=o.drawId===n.drawId,u=i[o.matchUpId]&&i[n.matchUpId],l=Ua(n.scheduledTime),p=Math.abs(l-d),m=l>=d;if((e&&!Number.isNaN(e)?p<=e:m&&Ua(n.scheduledTime)<Ua(s))&&(!u||!c)&&m){let e=[o.matchUpId,n.matchUpId].sort(Mg).join("|");t.scheduleConflicts[e]={priorScheduledMatchUpId:o.matchUpId,matchUpIdWithConflict:n.matchUpId}}}}let a=t.participant.participantId;Object.keys(t.scheduleConflicts).length&&M.push(a),c[a].scheduleConflicts=t.scheduleConflicts}}}return{participantIdsWithConflicts:M,eventsPublishStatuses:A,derivedEventInfo:E,derivedDrawInfo:C,mappedMatchUps:R,participantMap:c,matchUps:N}}({withMatchUps:w??n,withEvents:D??n,withDraws:b??n,withPotentialMatchUps:i,participantFilters:r,withRankingProfile:n,convertExtensions:a,withScheduleItems:s,policyDefinitions:o,tournamentRecord:c,scheduleAnalysis:d,withTeamMatchUps:m,usePublishState:h,withStatistics:g,contextFilters:I,matchUpFilters:U,participantMap:A,withOpponents:y,contextProfile:S,withSeeding:T}),{participantIdsWithConflicts:C,eventsPublishStatuses:O,derivedEventInfo:k,derivedDrawInfo:F,mappedMatchUps:x}=E,_=E.matchUps;A=E.participantMap;let B=d??i,V=({potentialMatchUps:e,scheduleConflicts:t,scheduleItems:r,participant:i,statistics:a,opponents:o,matchUps:c,events:u,draws:l})=>{let p=Object.values(l),m=Object.values(o);return y&&p?.forEach(e=>{e.opponents=m.filter(t=>t.drawId===e.drawId)}),wn({...i,scheduleConflicts:d?Object.values(t):void 0,draws:b||n?p:void 0,events:D||n?Object.values(u):void 0,matchUps:w||n?Object.values(c):void 0,opponents:y?m:void 0,potentialMatchUps:B?Object.values(e):void 0,statistics:g?Object.values(a):void 0,scheduleItems:s?r:void 0},!1,!1,!0)},G=new Map;for(let u of Object.keys(A))G.set(u,V(A[u]));let j=[...G.values()],$=o?.[ou]?.participant,q=Rg({participants:j,participantFilters:r,tournamentRecord:c});if(t){let e=v(t)?t:void 0;for(let t of q)for(let r of t.individualParticipantIds??[]){t.individualParticipants??=[];let i=G.get(r),n=e?Xc({template:e,source:i}):i;t.individualParticipants.push(n)}}let W=$?q.map(e=>Xc({source:e,template:$})):q;return{participantMap:!1!==e.returnParticipantMap?A:void 0,mappedMatchUps:!1!==e.returnMatchUps?x:void 0,matchUps:!1!==e.returnMatchUps?_:void 0,missingParticipantIds:N.missingParticipantIds,participantIdsWithConflicts:C,eventsPublishStatuses:O,derivedEventInfo:k,derivedDrawInfo:F,participants:W,...ce}}function Eg(e){let{tournamentRecord:t,scaleAttributes:r,participantId:i}=e,n=e.tournamentRecords||t&&{[t.tournamentId]:t}||{};if(!i)return{error:Ir};let{participant:a,tournamentId:o}=Kl({tournamentRecords:n,tournamentRecord:t,participantId:i});return a?{...hg({participant:a,scaleAttributes:r}),tournamentId:o}:{error:Sr}}function Cg(e,t){let r=new Date(ya(e)),i=new Date(ya(t)),n=i.getFullYear()-r.getFullYear(),a=i.getMonth()-r.getMonth();return(a<0||0===a&&i.getDate()<r.getDate())&&n--,n}function Og(e,t,r){return!(void 0!==t&&e<t||void 0!==r&&e>r)}function kg(e){let t=e.person;return t&&[t.standardGivenName||t.passportGivenName,t.standardFamilyName||t.passportFamilyName].filter(Boolean).join(" ")||"Unknown"}function Fg(e,t,r,i,n,a){let o=function(e,t,r,i){if(function(e){return/^C\d{1,2}-\d{1,2}$/.test(e.ageCategoryCode||"")}(t))return{valid:!0};let n=t.ageMin,a=t.ageMax;if(t.ageCategoryCode&&!n&&!a){let e=Fa({consideredDate:r,category:t});e.error||(n=e.ageMin,a=e.ageMax)}if(!n&&!a)return{valid:!0};let o=e.person?.birthDate;if(!o)return{valid:!1,reason:"Missing birthDate",details:{requiredMin:n,requiredMax:a}};let s=Cg(o,r),c=Cg(o,i),u=Og(s,n,a),d=Og(c,n,a);if(!u)return{valid:!1,reason:`Age ${s} at event start (${r}) outside range [${[void 0===n?null:`min: ${n}`,void 0===a?null:`max: ${a}`].filter(Boolean).join(", ")}]`,details:{birthDate:o,ageAtStart:s,ageAtEnd:c,requiredMin:n,requiredMax:a}};if(!d)return{valid:!1,reason:`Age ${c} at event end (${i}) outside range [${[void 0===n?null:`min: ${n}`,void 0===a?null:`max: ${a}`].filter(Boolean).join(", ")}]`,details:{birthDate:o,ageAtStart:s,ageAtEnd:c,requiredMin:n,requiredMax:a}};return{valid:!0}}(e,t,i,n),s=function(e,t,r,i){if(!t.ratingMin&&!t.ratingMax)return{valid:!0};if(!t.ratingType)return{valid:!0};let n,a={scaleType:"RATING",scaleName:t.ratingType,eventType:r.eventType},{scaleItem:o}=Eg({tournamentRecord:i,participantId:e.participantId,scaleAttributes:a});if(!o?.scaleValue)return{valid:!1,reason:`Missing ${t.ratingType} rating`,details:{ratingType:t.ratingType,requiredMin:t.ratingMin,requiredMax:t.ratingMax}};if("object"==typeof o.scaleValue){let e=rh({element:o.scaleValue,accessor:o.scaleValue?.accessor});if(void 0===e)return{valid:!1,reason:`Cannot extract rating value from ${t.ratingType} scale item`,details:{ratingType:t.ratingType,requiredMin:t.ratingMin,requiredMax:t.ratingMax}};n=e}else n=o.scaleValue;return void 0!==t.ratingMin&&n<t.ratingMin?{valid:!1,reason:`${t.ratingType} rating ${n} below minimum ${t.ratingMin}`,details:{ratingType:t.ratingType,ratingValue:n,requiredMin:t.ratingMin,requiredMax:t.ratingMax}}:void 0!==t.ratingMax&&n>t.ratingMax?{valid:!1,reason:`${t.ratingType} rating ${n} above maximum ${t.ratingMax}`,details:{ratingType:t.ratingType,ratingValue:n,requiredMin:t.ratingMin,requiredMax:t.ratingMax}}:{valid:!0}}(e,t,r,a);if(!o.valid||!s.valid){let t={participantId:e.participantId,participantName:kg(e),rejectionReasons:[]};return o.valid||t.rejectionReasons.push({type:"age",reason:o.reason,details:o.details||{}}),s.valid||t.rejectionReasons.push({type:"rating",reason:s.reason,details:s.details||{}}),t}return null}function xg({participantId:e,drawDefinition:t,entryStatus:r,entryStage:i}){if(!t)return{error:ye};let n=t.entries?.find(t=>!(t.participantId!==e||r&&r!==t.entryStatus||i&&i!==t.entryStage));return e&&n}function _g(e){let{provisionalPositioning:t,drawDefinition:r,stageSequence:i,structureId:n,stage:a}=e;if(!r)return{error:ye};let{entryProfile:o}=wp({drawDefinition:r}),s=a&&i&&o?.[a]?.stageSequence?.[i]?.qualifiersCount||a&&o?.[a]?.qualifiersCount||0,c={};if(!n)return{qualifiersCount:s,roundQualifiersCounts:c};let{structure:u}=Vd({drawDefinition:r,structureId:n}),d=r.links?.filter(e=>e?.target?.structureId===u?.structureId),l=0;d?.length&&(l=function({relevantLinks:e,drawDefinition:t,provisionalPositioning:r,roundQualifiersCounts:i}){let n=0;for(let a of e){let e=Vd({structureId:a.source.structureId,drawDefinition:t})?.structure;if(e?.stage===Yo){let t,o=a.source.roundNumber,s=a.target.roundNumber;t=e.structureType===cs?(e.structures?.length??0)*(a.source.finishingPositions?.length??0):Bf({matchUpFilters:{roundNumbers:[o]},structure:e,afterRecoveryTimes:!1,provisionalPositioning:r,inContext:!1}).matchUps?.length||0,i[s]||(i[s]=0),i[s]+=t,n+=t}}return n}({relevantLinks:d,drawDefinition:r,provisionalPositioning:t,roundQualifiersCounts:c}));let p=Object.keys(c);if(p.length<=1){let e=p[0]||1;c[e]=Math.max(c[e]||0,s)}return l=Math.max(l,s),{qualifiersCount:l,roundQualifiersCounts:c}}function Lg({stage:e,drawDefinition:t}){let{entryProfile:r}=wp({drawDefinition:t});return r?.[e]?.drawSize||0}function Bg({stage:e,drawDefinition:t}){return!!(e===Ko||jp({stage:e,drawDefinition:t})&&Lg({stage:e,drawDefinition:t}))}function Vg({entryStatus:e=Dp,drawDefinition:t,stageSequence:r,stage:i}){if(e===Pp)return function({stage:e,drawDefinition:t}){let{entryProfile:r}=wp({drawDefinition:t});return r[e]?.alternates||0}({stage:i,drawDefinition:t})?{positionsAvailable:1/0,...ce}:{error:Or};let n=function(e){let{provisionalPositioning:t,drawDefinition:r,stageSequence:i,stage:n}=e,a=Lg({stage:n,drawDefinition:r}),{qualifiersCount:o}=_g({provisionalPositioning:t,drawDefinition:r,stageSequence:i,stage:n});return a&&a-o}({drawDefinition:t,stageSequence:r,stage:i}),a=function({stage:e,drawDefinition:t}){let{entryProfile:r}=wp({drawDefinition:t});return r[e]?.wildcardsCount||0}({drawDefinition:t,stage:i}),o=$p({entryStatus:kp,drawDefinition:t,stage:i}),s=o+$p({entryStatus:Dp,drawDefinition:t,stage:i}),c=n-s;return i!==Ko&&s>=n?{error:Fr}:e===kp?o<a?{...ce}:{error:Fr}:{positionsAvailable:c,...ce}}function Gg(e){let t=$c(e,[{[Xs]:!0,[uc]:!0}]);if(t.error)return t;let{suppressDuplicateEntries:r=!0,entryStatus:i=Dp,entryStageSequence:n,entryStage:a=Ho,ignoreStageSpace:o,drawDefinition:s,entryPosition:c,participant:u,roundTarget:d,extensions:l,extension:p,drawType:m,event:f}=e,h="addDrawEntry";if(m!==Is&&!Bg({stage:a,drawDefinition:s}))return Pn({result:{error:mt},stack:h});let g=Vg({stageSequence:n,stage:a,drawDefinition:s,entryStatus:i});if(!(o||g.success||m&&m===Is))return{error:g.error};if(p&&!Iu({extension:p}))return Pn({result:{error:gi},info:"Invalid extension",context:{extension:p},stack:h});let I=e.participantId||u?.participantId;if(!I)return Pn({result:{error:Ir},stack:h});let U=i===Rp&&xg({participantId:I,drawDefinition:s,entryStatus:i}),S=a===Ko&&xg({participantId:I,drawDefinition:s,entryStage:a}),v=xg({participantId:I,drawDefinition:s}),y=i!==Rp&&a!==Ko&&v;if(y)return r?(rn({payload:{drawId:s.drawId,eventId:f?.eventId,error:me,participantId:I},topic:Xd}),{...ce}):Pn({result:{error:me},context:{participantId:I},stack:h});if(U||S)return Pn({context:{invalidEntry:y,invalidLuckyLoser:U,invalidVoluntaryConsolation:S},result:{error:Mr},stack:h});let w=wn({entryStageSequence:n,participantId:I,entryPosition:c,entryStatus:i,entryStage:a,extensions:l});return p&&Uu({element:w,extension:p}),d&&Uu({extension:{name:"roundEntry",value:d},element:w}),s.entries??=[],s.entries.push(w),Ml({drawDefinition:s}),{...ce}}function jg({suppressDuplicateEntries:e=!0,autoEntryPositions:t=!0,entryStageSequence:r,ignoreStageSpace:i,participantIds:n,drawDefinition:a,entryStatus:o,roundTarget:s,entryStage:c,extension:u,drawId:d,event:l}){if(!n?.length)return{error:wr};if(!l)return{error:st};if(!d)return{error:Ge};let p=(l.entries||[]).map(dd);if(n.filter(e=>!p.includes(e)).length)return{error:ut};if(a){let d=function(e){let t="addDrawEntries",{suppressDuplicateEntries:r=!0,entryStatus:i=Dp,autoEntryPositions:n=!0,ignoreStageSpace:a,participantIds:o,drawDefinition:s,stageSequence:c,stage:u=Ho,roundTarget:d,extension:l,event:p}=e,m=s.drawType===Is;if(!u)return{error:pt};if(!s)return{error:ye};if(!Array.isArray(o))return{error:lr};if(!m&&!Bg({stage:u,drawDefinition:s}))return{error:mt};if(l&&!Iu({extension:l}))return Pn({result:{error:gi},info:"Invalid extension",context:{extension:l},stack:t});let f=Vg({drawDefinition:s,stageSequence:c,entryStatus:i,stage:u});if(!a&&!f.success&&!m)return{error:f.error};let h=f.positionsAvailable??0;if(!a&&!m&&u!==Ko&&h<o.length)return{error:Rr};let g=[],I=s.drawId,U=p?.eventId,S=o.reduce((e,t)=>{let n=i===Rp&&xg({participantId:t,drawDefinition:s,entryStatus:i}),a=u===Ko&&xg({entryStage:u,drawDefinition:s,participantId:t}),o=xg({participantId:t,drawDefinition:s});return i!==Rp&&u!==Ko&&o&&(g.push(t),r&&rn({payload:{error:me,participantId:t,eventId:U,drawId:I},topic:Xd})),n||a?e.concat(t):e},[]);return g.length&&!r?Pn({context:{eventId:U,drawId:I,duplicateEntries:g},result:{error:me},stack:t}):(o.filter(e=>e&&!S.includes(e)).forEach(e=>{let t={entryStageSequence:c,entryStage:u,participantId:e,entryStatus:i};l&&Uu({element:t,extension:l}),d&&Uu({extension:{name:Wu,value:d},element:t}),s.entries??=[],s.entries.push(t)}),n&&(s.entries=Ah({entries:s.entries})),Ml({drawDefinition:s}),S?.length||g?.length?{info:"some participantIds could not be added",participantIdsNotAdded:S,duplicateEntries:g,...ce}:{...ce})}({stageSequence:r,suppressDuplicateEntries:e,autoEntryPositions:t,stage:c,ignoreStageSpace:i,participantIds:n,drawDefinition:a,entryStatus:o,roundTarget:s,extension:u});if(d.error)return d}let{flightProfile:m}=Nf({event:l}),f=m?.flights.find(e=>e.drawId===d);return f?.drawEntries&&(n.forEach(e=>{let t=o===Rp&&$g({participantId:e,entryStatus:o,flight:f}),r=c===Ko&&$g({participantId:e,entryStage:c,flight:f});(o===Rp||c===Ko||!$g({flight:f,participantId:e}))&&!t&&!r&&f.drawEntries.push({participantId:e,entryStatus:o,entryStage:c})}),t&&(f.drawEntries=Ah({entries:f.drawEntries}))),{...ce}}function $g({participantId:e,entryStatus:t,entryStage:r,flight:i}){let n=i.drawEntries?.find(i=>!(i.participantId!==e||t&&t!==i.entryStatus||r&&r!==i.entryStage));return e&&n}function qg({autoEntryPositions:e=!0,participantIds:t=[],entryStatuses:r,stage:i,event:n}){let a="removeEventEntries";if(!n?.eventId)return{error:ot};if(!Array.isArray(t)||t.some(e=>!S(e)))return Pn({result:{error:dr},stack:a});let o=(n.drawDefinitions??[]).flatMap(e=>Nh({drawDefinition:e}).assignedParticipantIds??[]),s=(r?.length&&n.entries?.filter(e=>e.entryStatus&&r.includes(e.entryStatus))||[]).map(dd).filter(e=>!o.includes(e)),c=(i&&n.entries?.filter(e=>e.entryStage&&e.entryStage===i)||[]).map(dd).filter(e=>!o.includes(e));if(t.length?t=t.filter(e=>(!r?.length||s.includes(e))&&(!i||c.includes(e))):s.length&&c.length?t=Q(s,c):s.length?t=s:c.length&&(t=c),t?.length&&o.some(e=>t.includes(e)))return Pn({result:{error:br},stack:a});if(!t?.length)return{...ce,participantIdsRemoved:[]};let u=[];n.entries=(n.entries??[]).filter(e=>{let r=!t.includes(e?.participantId);return r||u.push(e.participantId),r}),e&&(n.entries=Ah({entries:n.entries}));let{flightProfile:d}=Nf({event:n});return d?.flights?.forEach(e=>{e.drawEntries=(e.drawEntries||[]).filter(e=>!t.includes(e.participantId))}),n.drawDefinitions?.forEach(e=>{e.entries=(e.entries??[]).filter(e=>!t.includes(e.participantId))}),{...ce,participantIdsRemoved:u}}var Wg={[iu]:{policyName:"matchUpActionsDefault",enabledStructures:[{stages:[],stageSequences:[],enabledActions:[],disabledActions:[]}],participants:{enforceCategory:!0,enforceGender:!0},processCodes:{substitution:["RANKING.IGNORE","RATING.IGNORE"]},substituteAfterCompleted:!1,substituteWithoutScore:!1}},Hg=Wg;function Yg({tournamentRecord:e,participantIds:t,event:r,entryStatus:i,genderEnforced:n,mismatchedGender:a}){function o(e,t,r){return Wm(u)(t.eventType)&&e.participantType===Vl&&!Eh(r)}return e?.participants?.filter(e=>!!t.includes(e.participantId)&&(!!(o(e,r,i)&&(!r.gender||!n||En(r.gender)||Cn(r.gender)||On(r.gender)===On(e.person?.sex))||function(e,t,r){return t.eventType===l&&e.participantType===jl&&!Eh(r)}(e,r,i)||function(e,t,r,i,n){return!(t.eventType!==l||e.participantType!==Vl||!Eh(r)||t.gender&&i&&!En(t.gender)&&!Cn(t.gender)&&On(t.gender)!==On(e.person?.sex)&&(n.push({participantId:e.participantId,sex:e.person?.sex}),1))}(e,r,i,n,a))||!(o(e,r,i)&&!function(e,t,r,i){return!(t.gender&&r&&!En(t.gender)&&!Cn(t.gender)&&On(t.gender)!==On(e.person?.sex)&&(i.push({participantId:e.participantId,sex:e.person?.sex}),1))}(e,r,n,a))&&function(e,t,r){return t.eventType===$l&&(e.participantType===$l||Eh(r)&&e.participantType===Vl)}(e,r,i))).map(e=>e.participantId)??[]}function zg({enforceCategory:e,event:t,tournamentRecord:r,typedParticipantIds:i,categoryRejections:n}){if(e&&t.category&&r){let e=function(e,t){let r=e.startDate||t?.startDate,i=e.endDate||t?.endDate;return r&&i?ua(r)&&ua(i)?{startDate:r,endDate:i}:{error:Jt}:{error:Zt}}(t,r);if(!("error"in e)){let{startDate:a,endDate:o}=e;return function({typedParticipantIds:e,categoryRejections:t,tournamentRecord:r,startDate:i,endDate:n,event:a}){let o=[];for(let s of e){let e=r.participants?.find(e=>e.participantId===s);if(e)if(a.category){let c=Fg(e,a.category,a,i,n,r);c?t.push(c):o.push(s)}else o.push(s)}return o}({typedParticipantIds:i,tournamentRecord:r,event:t,startDate:a,endDate:o,categoryRejections:n})}}return i}function Kg(e){let{suppressDuplicateEntries:t=!0,entryStatus:r=Dp,autoEntryPositions:i=!0,enforceCategory:n=!1,enforceGender:a=!0,entryStageSequence:o,policyDefinitions:s,entryStage:c=Ho,tournamentRecord:u,ignoreStageSpace:d,drawDefinition:l,roundTarget:p,extensions:m,extension:f,drawId:h,event:g}=e,I="addEventEntries",U=function(e,t){if(!Array.isArray(e.participantIds))return Pn({result:{error:lr},stack:t});let r=L(e.participantIds??[]);return e.event?r?.length?e.event?.eventId?{participantIds:r}:{error:st}:Pn({result:{error:wr},stack:t}):{error:ot}}(e,I);if("error"in U)return U;let S="participantIds"in U?U.participantIds:[],v=function(e,t,r){return e&&(!Array.isArray(e)||!e.every(e=>Iu({extension:e})))||t&&!Iu({extension:t})?Pn({context:wn({extension:t,extensions:e}),result:{error:gi},info:"Invalid extension(s)",stack:r}):null}(m,f,I);if(v)return v;let y,{genderEnforced:w}=function({policyDefinitions:e,tournamentRecord:t,event:r,enforceGender:i}){let n=up({tournamentRecord:t,event:r}).appliedPolicies??{},a=e?.[iu]??n?.[iu]??Hg[iu];return{matchUpActionsPolicy:a,genderEnforced:!1!==(i??a?.participants?.enforceGender)}}({policyDefinitions:s,tournamentRecord:u,event:g,enforceGender:a}),P=[],T=[],D=!!u,b=[],M=Yg({tournamentRecord:u,participantIds:S,event:g,entryStatus:r,genderEnforced:w,mismatchedGender:b}),R=[];M=zg({enforceCategory:n,event:g,tournamentRecord:u,typedParticipantIds:M,categoryRejections:R});let N=function({participantIds:e,typedParticipantIds:t,checkTypedParticipants:r}){return e.filter(e=>!r||t.includes(e))}({participantIds:S,typedParticipantIds:M,checkTypedParticipants:D});if(g.entries??=[],function({validParticipantIds:e,existingIds:t,entryStatus:r,entryStage:i,extensions:n,extension:a,roundTarget:o,entryStageSequence:s,addedParticipantIdEntries:c,event:u}){e.forEach(e=>{if(!t.has(e)){let t=wn({participantId:e,entryStatus:r,entryStage:i,extensions:n});a&&Uu({element:t,extension:a}),o&&Uu({extension:{name:Wu,value:o},element:t}),s&&(t.entryStageSequence=s),c.push(t.participantId),u.entries?.push(t)}})}({validParticipantIds:N,existingIds:new Set(g.entries.map(e=>e.participantId||e.participant?.participantId)),entryStatus:r,entryStage:c,extensions:m,extension:f,roundTarget:p,entryStageSequence:o,addedParticipantIdEntries:P,event:g}),h&&!Eh(c)){let e=jg({participantIds:N,suppressDuplicateEntries:t,autoEntryPositions:i,entryStageSequence:o,ignoreStageSpace:d,drawDefinition:l,entryStatus:r,roundTarget:p,entryStage:c,extension:f,drawId:h,event:g});e.error&&(y=e.error)}if(function({tournamentRecord:e,removedEntries:t,event:r}){if(r.eventType&&[jo,qo].includes(r.eventType)){let i=new Set((r.entries||[]).map(e=>e.participantId)),n=(r.entries||[]).filter(e=>Eh(e.entryStatus)).map(e=>e.participantId),a=new Set((e?.participants??[]).filter(e=>i.has(e.participantId)&&e.participantType&&[jl,$l].includes(e.participantType)).map(e=>e.individualParticipantIds).flat(1/0)),o=n.filter(e=>a.has(e));o.length&&(t.push(...o),qg({participantIds:o,autoEntryPositions:!1,event:r}))}}({event:g,tournamentRecord:u,removedEntries:T}),N.length!==S.length)return Pn({context:wn({categoryRejections:R.length?R:void 0,mismatchedGender:b.length?b:void 0,gender:g.gender}),result:{error:lr},stack:I});i&&(g.entries=Ah({entries:g.entries||[]}));let A=P.length,E=T.length;return Pn({result:{...ce,addedEntriesCount:A,removedEntriesCount:E,...R.length&&{context:wn({categoryRejections:R})}},stack:I,info:y})}var Jg="ADMINISTRATION",Qg="COMPETITOR",Xg="MEDIA",Zg="MEDICAL",eI="OFFICIAL",tI="OTHER",rI="SECURITY",iI={ADMINISTRATION:Jg,CAPTAIN:"CAPTAIN",COACH:"COACH",COMPETITOR:Qg,MEDIA:Xg,MEDICAL:Zg,OFFICIAL:eI,OTHER:tI,SECURITY:rI};function nI({addIndividualParticipantsToEvents:e,individualParticipantIds:t,groupingParticipantId:r,tournamentRecord:i,suppressErrors:n}){let a="removeIndividualParticipantIds";if(!i)return Pn({result:{error:Ie},stack:a});if(!r||!t)return Pn({result:{error:$t},stack:a});let o=(i.participants??[]).find(e=>e.participantId===r);if(!o)return Pn({result:{error:Sr},stack:a});if(![$l,Gl].includes(o.participantType))return Pn({result:{participantType:o.participantType,error:mr},stack:a});let s=aI({individualParticipantIds:t,groupingParticipant:o,tournamentRecord:i,suppressErrors:n}),{removed:c,error:u}=s;if(u)return Pn({result:s,stack:a});if(e)for(let d of i.events??[]){let e=(d.entries??[]).map(({participantId:e})=>e).filter(Boolean);if(e.includes(r)){let t=c?.filter(t=>!e.includes(t));Kg({participantIds:t,entryStatus:Cp,tournamentRecord:i,event:d})}}return c&&rn({topic:sl,payload:{tournamentId:i.tournamentId,participants:[o]}}),{...ce,...s}}function aI({individualParticipantIds:e=[],groupingParticipant:t,tournamentRecord:r,suppressErrors:i,mappedMatchUps:n,participants:a}){let o=[];if(!t)return{removed:o};let s=[],c=[];a||({participants:a,mappedMatchUps:n}=Ag({withMatchUps:!0,tournamentRecord:r,withEvents:!0}));let u=a?.find(({participantId:e})=>e===t.participantId)?.events?.map(({eventId:e})=>e),d=(t.individualParticipantIds??[]).filter(i=>{let d=e?.includes(i),l=d&&a?.find(e=>e.participantId===i)?.matchUps.filter(({eventId:e})=>u.includes(e)).map(({matchUpId:e})=>n?.[e]).filter(({winningSide:e,score:t})=>e||ch({score:t})),p=d&&!l?.length;if(d&&!p&&c.push(i),p){o.push(i);for(let e of r.events??[])for(let n of e.drawDefinitions??[]){let{extension:e}=Ru({element:n,name:Vu}),a=e?.value[t.participantId];e&&a&&(e.value[t.participantId]=a.filter(e=>e.participantId!==i),Uu({element:n,extension:e}),bl({drawDefinition:n}));let o=th({drawDefinition:n,inContext:!1}).matchUps??[];for(let t of o){let e=t.sides??[];for(let a of e){let e=a.lineUp??[];e.find(e=>e.participantId===i)&&(a.lineUp=e.filter(e=>e.participantId!==i),Dl({tournamentId:r?.tournamentId,drawDefinition:n,matchUp:t}))}}}}else s.push(i);return!p});t.individualParticipantIds=d;let l={groupingParticipantId:t.participantId,cannotRemove:c,notRemoved:s,removed:o};return c.length&&!i&&{...l,cannotRemove:c,error:or}||l}function oI({participantRole:e=Qg,individualParticipantIds:t=[],groupingTypes:r=[Bl,Gl],tournamentRecord:i}){if(!i)return{error:Ie};let n=i.participants??[],{participants:a,mappedMatchUps:o}=Ag({withMatchUps:!0,tournamentRecord:i,withEvents:!0}),s=0;return n.filter(t=>(t.participantRole===e||!t.participantRole)&&t.participantType&&r.includes(t.participantType)).forEach(e=>{let{removed:r}=aI({groupingParticipant:e,individualParticipantIds:t,tournamentRecord:i,mappedMatchUps:o,participants:a});r&&s++}),s?ce:{error:yr}}function sI(e){let t=$c(e,[{[Js]:!0},{participantIds:!0,[_c]:Oc,[Dc]:wr}]);if(t.error)return t;let{addIndividualParticipantsToEvents:r,tournamentRecord:i,participantIds:n}=e,a=i.participants?.length||0;if(!a)return{...ce};let o=(i.events||[])?.filter(({eventType:e})=>e===$o).map(e=>e?.drawDefinitions?.map(({drawId:e})=>e)).flat(1/0),s=Ag({participantFilters:{participantIds:n},tournamentRecord:i,withDraws:!0}).participants??[],c=o?.length?Q((Xf({matchUpFilters:{drawIds:o,matchUpTypes:[l]},tournamentRecord:i}).matchUps??[]).flatMap(({sides:e})=>e?.map(({participantId:e})=>e||[])).filter(Boolean),n):[],u=s.filter(e=>e.draws?.filter(e=>(!o?.length||!o?.includes(e.drawId))&&e.positionAssignments).length);if(c?.length||u.length)return{error:br};let d={},p={};for(let l of i.events||[]){let e=qg({participantIds:n,event:l});if(e.error)return e;d[l.eventId]=e.participantIdsRemoved}i.participants=(i.participants??[]).filter(e=>{let t=n.includes(e.participantId)||e.participantType===jl&&e.individualParticipantIds?.some(e=>n.includes(e));if(!t&&e.participantType===$o&&e.individualParticipantIds?.some(e=>n.includes(e))&&(e.individualParticipantIds=e.individualParticipantIds.filter(e=>!n.includes(e))),t&&r&&e.participantType&&[jl,$l].includes(e.participantType))for(let r of e.individualParticipantIds||[])n.includes(r)||(p[e.participantId]||(p[e.participantId]=[]),p[e.participantId].push(r));return!t});let m=a-i.participants.length;if(oI({individualParticipantIds:n,tournamentRecord:i}),r)for(let l of i.events||[]){Kg({participantIds:d[l.eventId].map(e=>p[e]||[]).flat(),entryStatus:Cp,tournamentRecord:i,event:l})}return m&&rn({payload:{participantIds:n,tournamentId:i.tournamentId},topic:Zd}),m?{...ce,participantsRemovedCount:m}:{error:or}}function cI({selected:e=!0,drawDefinition:t,entryStatuses:r,drawId:i,event:n,stage:a}){let o=n.entries??[];if(i){let{flightProfile:e}=Nf({event:n}),r=e?.flights?.find(e=>e.drawId===i);r?o=r.drawEntries:t.entries&&(o=t?.entries)}let s=o.filter(t=>(!r?.length||!t.entryStatus||r.includes(t.entryStatus))&&(!a||!t.entryStage||t.entryStage===a)&&(!e||t.entryStatus&&Bp.includes(t.entryStatus)));return{entries:o,stageEntries:s}}function uI({removeGroupParticipant:e,tournamentRecord:t,drawDefinition:r,participantId:i,drawId:n,stage:a,event:o}){let s="destroyGroupEntry";if(!t)return{error:Ie};if(!i)return Pn({result:{error:Ir},stack:s});if(!o)return{error:ot};if(!o.eventType||![jo,qo].includes(o.eventType))return Pn({result:{error:at},stack:s});let c=t.participants??[],u=c.find(e=>e.participantId===i);if(!u)return Pn({result:{error:Sr},stack:s});if(!u.participantType||![jl,Bl].includes(u.participantType)||u.participantType===Bl&&o.eventType!==qo||u.participantType===jl&&o.eventType!==jo)return{error:mr};let d=(o.entries??[]).find(e=>e.participantId===i);if(!d)return{error:Ar};let l,{stageEntries:p}=cI({selected:!1,drawDefinition:r,drawId:n,event:o,stage:a}),m=p.map(dd),f=c.filter(({participantId:e})=>m.includes(e)).map(({individualParticipantIds:e})=>e).flat().filter(Boolean),h=u.individualParticipantIds?.filter(e=>1===J(e,f).length),g=qg({participantIds:[i],event:o});return g.error||h?.length&&(g=Kg({participantIds:h,entryStatus:Cp,entryStage:d.entryStage,tournamentRecord:t,drawDefinition:r,drawId:n,event:o}),g.error)?g:(e&&sI({participantIds:[i],tournamentRecord:t}).success&&(l=!0),{...ce,participantRemoved:l})}function dI({removeGroupParticipant:e,tournamentRecord:t,drawDefinition:r,participantId:i,drawId:n,event:a}){return uI({removeGroupParticipant:e,tournamentRecord:t,drawDefinition:r,participantId:i,drawId:n,event:a})}function lI(e){if(!e.tournamentRecord)return{error:Ie};let{participantIds:t,...r}=e,i=0,n=[];for(let a of t){let e=uI({participantId:a,...r});e.success&&(i+=1),e.error&&n.push(e.error)}return i?{destroyedCount:i,...ce}:{error:n}}function pI(e){let{tournamentRecord:t,replaceWithBye:r,drawDefinition:i,destroyPair:n,entryStatus:a,matchUpsMap:o,drawId:s}=e,c="removeDrawPositionAssignment",u=bh(e);if(u.error)return Pn({result:u,stack:c});let{participantId:d}=u,{drawPosition:l,event:p,structureId:m}=e,f=up({tournamentRecord:t,drawDefinition:i,event:p}).appliedPolicies??{};if([Pp,Fp].includes(a)&&d){let{tournamentRecord:t}=e,{participant:r}=Kl({tournamentRecord:t,participantId:d}),{participantType:o,individualParticipantIds:u}=r??{};if(n&&o===jl){let e=dI({tournamentRecord:t,drawDefinition:i,participantId:d,event:p});if(e.error)return Pn({result:e,stack:c});u&&Ch({participantIds:u,tournamentRecord:t,drawDefinition:i,entryStatus:a,drawId:s,event:p})}else Ch({participantIds:[d],tournamentRecord:t,drawDefinition:i,entryStatus:a,drawId:s,event:p})}if(r){let e=vh({tournamentRecord:t,drawDefinition:i,drawPosition:l,structureId:m,matchUpsMap:o,event:p});if(e.error)return Pn({result:e,stack:c})}let{structure:h}=Vd({drawDefinition:i,structureId:m});return El({structure:h,drawPositions:[l]}),Cl({appliedPolicies:f,drawDefinition:i,positionAction:{name:"removeDrawPositionAssignment",replaceWithBye:r,drawPosition:l,entryStatus:a,structureId:m}}),u}function mI(e){return Object.assign(e,{entryStatus:Fp}),pI(e)}var fI=({finishingPosition:e=qs,hasExistingDrawDefinition:t,qualifyingRoundNumber:r,structureAbbreviation:i,seedAssignments:n=[],stageSequence:a=1,qualifyingOnly:o,structureOrder:s,seedingProfile:c,matchUpFormat:u,structureType:d,structureName:l,matchUps:p=[],matchUpType:m,structureId:f,roundOffset:h,roundLimit:g,stageOrder:I,structures:U,tieFormat:S,stage:v})=>{let y={structureId:f??za(),structureAbbreviation:i,finishingPosition:e,seedAssignments:n,matchUpFormat:u,stageSequence:a,structureName:l};(o||t&&S)&&(y.tieFormat=S),s&&(y.structureOrder=s),d&&(y.structureType=d),c&&("string"==typeof c?y.seedingProfile=c:"object"==typeof c&&"string"==typeof c.positioning&&(y.seedingProfile=c.positioning)),m&&(y.matchUpType=m),h&&(y.roundOffset=h),I&&(y.stageOrder=I),g&&(y.roundLimit=g),v&&(y.stage=v),r&&(y.qualifyingRoundNumber=r);let w=p.flatMap(({drawPositions:e})=>e).filter(Boolean);return U?y.structures=U:(y.matchUps=p,y.positionAssignments=L(w).sort((e,t)=>e-t).map(e=>({drawPosition:e}))),y},hI=fI;function gI(e){return S(e)?e.split(" ").map(e=>e.split("").map((e,t)=>t?e.toLowerCase():e.toUpperCase()).join("")).join(" "):e}function II(e){return S(e)?gI(e.replace(/_/g," ")):""}function UI({structureName:e=II(Ko),structureAbbreviation:t,drawDefinition:r,matchUpType:i,structureId:n}){if(!r)return{error:ye};let a=hI({stage:Ko,structureAbbreviation:t,structureName:e,matchUps:[],structureId:n,matchUpType:i});return r.structures||(r.structures=[]),r.structures.push(a),Ml({drawDefinition:r,structureIds:[a.structureId]}),{...ce}}function SI({positioning:e,size:t}){let r=function({size:e}){let t=[e],r=e;for(;r/2===Math.floor(r/2);)r/=2,t.push(r);return t.includes(1)||t.push(1),t.sort(g),t.reverse(),t}({size:t}),i=[],n=[],a=e=>e[0],o=(t,r)=>(e&&[is,ns,os].includes(e)&&r%2?(e=>e[e.length-1])(t):a(t))||a(t),s=(e,t)=>{if(e.every(e=>!n.includes(e))){let r=o(e,t);return n.push(r),r}},c=e=>{let t=e.filter(e=>!n.includes(e));if(t.length)return n.push(...t),t},u=(e,t)=>{let r=o(e,t);if(!n.includes(r))return n.push(r),r},d=K(1,t+1);for(let l of r)if(1===l){let e=re(d,2),t=e.map(s).filter(Boolean);t.length&&i.push(t);let r=e.flatMap(c).filter(Boolean);r.length&&i.push(r)}else{let e=re(d,l).map(u).filter(Boolean);e.length&&i.push(e)}return{divisions:r,divisionGroupings:i}}function vI({drawPositions:e}){if(!e?.length)return{error:Ce};let t=[].concat(...(e??[]).map(t=>e.filter(e=>e!==t).map(e=>[t,e]))),r=L(t.map(yI)).map(e=>e.split("|").map(e=>+e));return{groupMatchUps:t,uniqueMatchUpGroupings:r}}function yI(e=[]){return Array.isArray(e)&&e.length?[...e].sort(g).join("|"):""}function wI({groupSize:e,drawPositionOffset:t}){if(!e)return[];let r=e=>[...Array(e)].map((e,t)=>t),i=r(2*Math.round(e/2)+1).slice(1),n=r(i.length-1).map(()=>[]),a=i.slice(0,i.length/2),o=i.slice(i.length/2);i.slice(1).forEach((e,t)=>{a.forEach((e,r)=>{n[t].push([a[r],o[r]])});let r=a.shift(),i=a.pop(),s=o.shift();a=[r,s,...a].filter(Boolean),o=[...o,i].filter(Boolean)});let s=a.shift(),c=a.pop(),u=o.shift();a=[s,u,...a].filter(Boolean),o=[...o,c].filter(Boolean);let d=e=>e[0].reduce((e,t)=>e+t);return[...n].reverse().sort((e,t)=>d(e)-d(t)).map(r=>r.filter(t=>t.every(t=>t<=e)).map(e=>yI(e.map(e=>e+t))))}var PI={getRoundRobinGroupMatchUps:vI,determineRoundNumber:function({rounds:e,hash:t}){return e?.length?e?.reduce((e,r,i)=>r.includes(t)?i+1:e,void 0):{error:$t}},drawPositionsHash:yI,groupRounds:wI};function TI(e){let t,{hasExistingDrawDefinition:r,groupNameBase:i="Group",playoffAttributes:n,stageSequence:a=1,structureOptions:o,appliedPolicies:s,qualifyingOnly:c,seedingProfile:u,stage:d=Ho,matchUpType:l,roundTarget:p,structureId:m,groupNames:f,tieFormat:h,drawSize:g,idPrefix:I,isMock:U,uuids:S}=e,v=e.structureName??n?.[0]?.name??II(Ho),{groupCount:y,groupSize:w}=function({appliedPolicies:e,structureOptions:t,drawSize:r}){let i=t?.groupSize,n=t?.groupSizeLimit||8,{validGroupSizes:a}=DI({groupSizeLimit:n,drawSize:r}),o=a&&Math.max(...a);i&&a?.includes(i)||(i=i&&i>4||!a?.includes(4)?o:4);let s=Math.ceil(r/i);return{groupSize:i,groupCount:s}}({structureOptions:o,appliedPolicies:s,drawSize:g}),P=$s,T=K(1,y+1).map(e=>{let n=function({structureOrder:e,matchUpType:t,groupSize:r,drawSize:i,idPrefix:n,isMock:a,uuids:o}){let s=(e-1)*r,c=K(1+s,r+1+s),u=vI({drawPositions:c}).uniqueMatchUpGroupings??[],d=wI({groupSize:r,drawPositionOffset:s});return u.map(p).sort((e,t)=>(e.roundNumber??1/0)-(t.roundNumber??1/0));function l(e){return d.reduce((t,r,i)=>r.includes(e)?i+1:t,void 0)}function p(r){let s=l(yI(r)),c=[1,i],u=function({structureOrder:e,drawPositions:t,roundNumber:r,idPrefix:i,uuids:n}){return i?`${i}-${e}-${r}-DP-${t.join("-")}`:n?.pop()||za()}({structureOrder:e,drawPositions:r,roundNumber:s,idPrefix:n,uuids:o}),d={matchUpStatus:s?Md:"BYE",matchUpType:t,finishingPositionRange:{winner:c,loser:c},drawPositions:r,roundNumber:s,matchUpId:u};return a&&(d.isMock=!0),d}}({groupSize:w,structureOrder:e,matchUpType:l,drawSize:g,idPrefix:I,isMock:U});t=Array.isArray(n)?Math.max(...n.map(({roundNumber:e})=>e??0)):0;let a=f?.[e-1]??`${i} ${e}`;return fI({structureId:S?.pop(),hasExistingDrawDefinition:r,structureType:ss,finishingPosition:P,qualifyingOnly:c,structureOrder:e,structureName:a,tieFormat:h,matchUps:n})}),D=fI({structureId:m??S?.pop(),hasExistingDrawDefinition:r,structureType:cs,finishingPosition:P,seedingProfile:u,structureName:v,stageSequence:a,structures:T,tieFormat:h,stage:d});return p&&Uu({extension:{name:Wu,value:p},element:D}),{structures:[D],maxRoundNumber:t,groupCount:y,links:[],groupSize:w,...ce}}function DI(e){let{groupSizeLimit:t=10,drawSize:r=0}=e??{},i=K(3,t+1).filter(e=>{let t=Math.ceil(r/e),i=t*e-r,n=Math.ceil(r/t),a=Math.ceil(i/t);return(!i||i<e)&&n===e&&n>=3&&a<2});return{...ce,validGroupSizes:i}}function bI(e){let{roundRobinGroupsCount:t,participantsCount:r,cluster:i}=e;if(!F(r))return{seedBlocks:void 0,...Pn({result:{error:gi},context:{participantsCount:r},stack:"getSeedBlocks"})};let n=O(r);if(t){let e=Math.min(t,n),r=[],i=1;for(K(0,e).forEach(()=>{r.push([i]),i++});i<n;){let t=K(i,i+e);i+=e,r.push(t)}return{...ce,seedBlocks:r}}let a=K(1,n+1),o=[],s=n/2;for(;s>1;){let e=re(a,s),t=e.length;e.forEach((e,r)=>{let n,a=r<t/2,s=r%2==0,c=e[0],u=e[e.length-1];n=i&&t>4?8===t?a?u:c:s?c:u:a?c:u,Z(e,o)||o.push(n)}),s/=2}let c=a.filter(e=>!o.includes(e));for(;c.length;)c.length%2==0?o.push(c.pop()):o.push(c.shift());let u=K(0,20).map(e=>Math.pow(2,e));u.unshift(1);let d=u.indexOf(n),l=0,p=[];return K(0,d).forEach(e=>{p.push(o.slice(l,l+u[e])),l+=u[e]}),{...ce,seedBlocks:p}}function MI({roundRobinGroupsCount:e,drawSize:t}){let r="getSeedGroups";if(!F(t))return{seedGroups:void 0,...Pn({result:{error:gi},context:{drawSize:t},stack:r})};if(e){if(!F(e))return{seedGroups:void 0,...Pn({context:{roundRobinGroupsCount:e},result:{error:gi},stack:r})};let i=1;return{seedGroups:K(0,Math.floor(t/e)).map(()=>{let t=K(i,i+e);return i+=e,t})}}{let{seedBlocks:r}=bI({participantsCount:t,roundRobinGroupsCount:e}),i=0;return{seedGroups:(r||[]).map(e=>(e||[]).map(()=>(i+=1,i)))}}}function RI({roundRobinGroupsCount:e,participantsCount:t}){if(e){let{validGroupSizes:r}=DI({drawSize:t});if(!r?.map(e=>Math.ceil(t/e))?.includes(e))return Pn({context:{roundRobinGroupsCount:e},result:{error:gi}})}let{seedGroups:r}=MI({drawSize:t,roundRobinGroupsCount:e}),i=r?.map(e=>Math.min(...e))||[];return{...ce,seedingThresholds:i}}function NI(e){if(!e)return 1/0;if(F(e))return I(e);let t=e.split("-")[0];return F(t)?I(t):1/0}function AI({provisionalPositioning:e,returnAllProxies:t,appliedPolicies:r,seedingProfile:i,drawDefinition:n,allPositions:a,structure:o}){let s=[];if(!o)return{error:rt};let{matchUps:c,roundMatchUps:u}=Bf({matchUpFilters:{roundNumbers:[1]},provisionalPositioning:e,structure:o}),{seedAssignments:d}=Wp({provisionalPositioning:e,returnAllProxies:t,drawDefinition:n,structure:o}),{positionAssignments:l}=qd({structure:o}),p=l?.length,m=d?.length??0,f=[],h=Object.keys(u).map(e=>Number.parseInt(e)).sort((e,t)=>e-t).map(e=>{let t=u[e].map(e=>e.drawPositions).flat(1/0).filter(Boolean),r=t.filter(e=>!f.includes(e));return f=f.concat(...t),r}).filter(e=>e.length).reverse(),g=h.pop()??[],I=g&&Math.min(...g)-1||0;i=i??r?.seeding?.seedingProfile;let U=g?.length||0,S=h.filter(e=>e.filter(e=>e<=m).length),{stage:v,structureType:y,roundLimit:w}=o,P=y===cs,T=!P&&h?.length,D=!P&&v===Yo&&w,b=S.flat(1/0),M=T?b?.length:0,R=a?p:m,N=im({drawDefinition:n,structure:o,matchUps:c}),A=N?0:!T&&R||R&&b.length<R&&R-b.length||0;if(D){let e=o?.matchUps?o.matchUps.filter(({roundNumber:e})=>e===o.roundLimit).length:0,t=g.length/e;if(!T){let e=FI(i),r=re(g,t),n=1,a=K(0,r[0].length).map(()=>{let e=K(n,n+r.length);return n+=r.length,e});({validSeedBlocks:s}=EI({drawPositionBlocks:r,nonRandom:i?.nonRandom,positioning:e,seedGroups:a}))}}else P?({validSeedBlocks:s}=function({seedingProfile:e,structure:t,nonRandom:r}){let i=t.structures||[],n=i.length,a=$d({structure:t})?.positionAssignments,o=FI(e),s=a?.length??0,{seedGroups:c}=MI({roundRobinGroupsCount:n,drawSize:s}),u=i.map(e=>$d({structure:e}).positionAssignments?.map(e=>e.drawPosition));return EI({drawPositionBlocks:u,positioning:o,seedGroups:c,nonRandom:r})}({nonRandom:i?.nonRandom,seedingProfile:i,structure:o})):T?s=S.map(e=>({seedNumbers:e,drawPositions:e})):N&&re(g,2).map((e,t)=>({drawPositions:[e[0]],seedNumbers:[t+1]})).forEach(e=>s.push(e));if(!P&&!N&&!D){let{blocks:e}=function(e){let t,{drawPositionOffset:r=0,roundRobinGroupsCount:i,seedNumberOffset:n=0,seedingProfile:a,seedCountGoal:o,baseDrawSize:s}=e,c=[],{seedBlocks:u}=bI({cluster:[is,ns].includes(FI(a)),participantsCount:s,roundRobinGroupsCount:i});t=0;for(let d of u){if(t+1>o)break;let e=d.map(e=>e+r),i=CI(t+1,d.length).map(e=>+e+n);t+=d.length,c.push({drawPositions:e,seedNumbers:i})}return{blocks:c}}({drawPositionOffset:I,seedNumberOffset:M,seedCountGoal:A,seedingProfile:i,baseDrawSize:U});e.forEach(e=>s.push(e))}let E=s.flatMap(e=>e.drawPositions).reduce((e,t)=>g?.includes(t)&&e,!0);return N||T||P||E?{isLuckyStructure:N,validSeedBlocks:s,isContainer:P,isFeedIn:T}:{error:Je,validSeedBlocks:[],isContainer:P,isFeedIn:T}}function EI({drawPositionBlocks:e,positioning:t,seedGroups:r,nonRandom:i}){let n=[],{divisionGroupings:a}=SI({size:r.length,positioning:t}),o=[];return r.forEach((r,s)=>{let c=function({blockPattern:e,index:t}){let r=0;for(let i of e){if(r===t)return i;let e=0;for(;e<i.length;){if(r===t)return i;r+=1,e++}}}({blockPattern:a,index:s});r.forEach((r,a)=>{let u=s%2?e.length-a-1:a,d=e[u].slice().filter((e,t)=>c.includes(t+1)&&e);t!==os?d=i?d:V(d):s%2&&d.reverse();let l=d.find(e=>!o.includes(e));l&&(o.push(l),n.push({drawPositions:[l],seedNumbers:[r]}))})}),{validSeedBlocks:n}}function CI(e,t){return Array.from(new Array(t),(t,r)=>r+e)}function OI({appliedPolicies:e,drawDefinition:t,seedBlockInfo:r,drawPosition:i,structureId:n,seedNumber:a}){let{structure:o}=Vd({drawDefinition:t,structureId:n});e??=up({drawDefinition:t}).appliedPolicies;let s=r?.validSeedBlocks;return!s&&o&&(s=AI({appliedPolicies:e,drawDefinition:t,structure:o})?.validSeedBlocks),!!e?.seeding?.validSeedPositions?.ignore||(e?.seeding?.validSeedPositions?.strict?(s.find(e=>e.seedNumbers.includes(a))?.drawPositions||[]).includes(i):s.flatMap(e=>e.drawPositions).includes(i))}function kI(e){let{provisionalPositioning:t,drawDefinition:r,seedingProfile:i,seedBlockInfo:n,structureId:a,randomize:o}=e,{structure:s}=Vd({drawDefinition:r,structureId:a}),{seedAssignments:c}=Wp({returnAllProxies:e.returnAllProxies,provisionalPositioning:t,drawDefinition:r,structure:s}),{positionAssignments:u}=qd({structure:s}),d=u?.filter(e=>e.participantId??e.bye??e.qualifier)?.map(e=>e.drawPosition).filter(Boolean),{appliedPolicies:l}=up({drawDefinition:r}),p=(n?.validSeedBlocks||s&&AI({returnAllProxies:e.returnAllProxies,provisionalPositioning:t,appliedPolicies:l,drawDefinition:r,seedingProfile:i,structure:s})?.validSeedBlocks||[]).find(e=>e.drawPositions.filter(e=>!d?.includes(e)).length),m=c?.map(e=>e.participantId).filter(Boolean),f=u?.map(e=>e.participantId).filter(Boolean),h=m?.filter(e=>f?.includes(e)),g=m?.filter(e=>!f?.includes(e)),I=c?.filter(e=>g?.includes(e.participantId)),U=c?.filter(e=>!e.participantId),S=(I?.length&&I.length>0?I.length:U?.length??0)&&p?.drawPositions.filter(e=>!d?.includes(e))||[],v=o?V(S):S,y=[],w=v.map(()=>{let e=function(e,t){let r=e.filter(e=>!t.includes(e.participantId)),i=Math.min(...r.map(e=>NI(e.seedValue)));return V(r.filter(e=>NI(e.seedValue)===i)).pop()}(I,y)?.participantId;return e&&y.push(e),e}).filter(Boolean),P=c?.filter(e=>h?.includes(e.participantId)).map(e=>e.seedNumber),T=(p?.seedNumbers||[]).filter(e=>!P?.includes(e)),D=c?.filter(e=>T.includes(e.seedNumber)).map(e=>e.participantId),b=l?.seeding?.duplicateSeedNumbers;return{nextSeedBlock:p,unplacedSeedParticipantIds:"boolean"!=typeof b||b?w:D,unplacedSeedNumbers:T,unfilledPositions:v,unplacedSeedAssignments:I}}function FI(e){return"string"==typeof e?e:"object"==typeof e?e.positioning:void 0}function xI({provisionalPositioning:e,tournamentRecord:t,drawDefinition:r,seedingProfile:i,participantId:n,seedBlockInfo:a,structureId:o,seedNumber:s,seedValue:c,eventId:u,event:d}){let l="assignSeed",{structure:p}=Vd({drawDefinition:r,structureId:o}),{positionAssignments:m}=qd({structure:p}),f=Wp({provisionalPositioning:e,drawDefinition:r,structure:p}).seedAssignments,h=f.map(e=>e.seedNumber),g=xg({drawDefinition:r,participantId:n});if(n&&!g)return Pn({result:{error:dr},context:{participantId:n},stack:l});let I,U=d?Nf({event:d}).flightProfile?.flights?.length:0,S=U&&U>1,v=m?.find(e=>e.participantId===n)?.drawPosition;return v&&!OI({drawPosition:v,drawDefinition:r,seedBlockInfo:a,structureId:o,seedNumber:s})?Pn({result:{error:be},context:{assignedDrawPosition:v},info:"invalid seed position",stack:l}):(h.includes(s)||f.push({seedNumber:s,seedValue:c}),f.forEach(e=>{e.participantId===n&&e.seedNumber!==s&&(e.participantId=void 0),e.seedNumber===s&&(e.participantId=n,!i?.groupSeedingThreshold&&!S&&(e.seedValue=c??s),I=!0)}),I?(Rl({tournamentId:t?.tournamentId,drawDefinition:r,structure:p,eventId:u}),{...ce}):Pn({result:{error:Ke},stack:l}))}function _I({inContextTargetMatchUp:e,drawPositionSideIndex:t,teamParticipantId:r,tournamentRecord:i,drawDefinition:n,matchUp:a,event:o}){let s=e?.sides?.[t]?.sideNumber,c=s&&a.sides?.find(e=>e.sideNumber===s),{extension:u}=Ru({element:n,name:Vu}),d=Wa((u?.value||{})[r],!1,!0);if(c)a?.sides?.forEach(e=>{e.sideNumber===s&&(e.lineUp=d)});else{a.sides=[1,2].map(e=>({...a.sides?.find(t=>t.sideNumber===e)??{},sideNumber:e}));let e=a.sides.find(e=>e.sideNumber===s);e&&(e.lineUp=d)}Dl({tournamentId:i?.tournamentId,context:"updateSidLineUp",eventId:o?.eventId,drawDefinition:n,matchUp:a})}function LI(e){let{sourceMatchUp:t}=e,{targetMatchUp:r,structure:i,matchUpsMap:n,drawPosition:a}=e,o=r.roundNumber>1&&r.roundNumber-1,s=Jp({structureId:i.structureId,matchUpsMap:n});gh({method:"getPairedPreviousMatchUpIsDoubleExit",color:"brightcyan",keyColors:{structureId:"brightyellow",sourceMatchUpId:"brightmagenta"},structureId:i.structureId?.slice(0,8),targetMatchUpId:r.matchUpId,targetRound:[r.roundNumber,r.roundPosition],previousRoundNumber:o,sourceMatchUpId:t?.matchUpId,sourceStructureId:t?.structureId?.slice(0,8),sourceRound:t?[t.roundNumber,t.roundPosition]:void 0,drawPosition:a,structureMatchUpCount:s?.length}),t&&t.structureId!==i.structureId&&a?(gh({method:"getPairedPreviousMatchUpIsDoubleExit",color:"cyan",info:"cross_structure_sourceMatchUp_resolving_in_target",originalSourceId:t?.matchUpId,originalSourceStructure:t?.structureId?.slice(0,8),targetStructure:i.structureId?.slice(0,8)}),t=s.find(({drawPositions:e,roundNumber:t})=>t===o&&e?.includes(a)),gh({method:"getPairedPreviousMatchUpIsDoubleExit",color:"cyan",info:"resolved_cross_structure_sourceMatchUp",resolvedMatchUpId:t?.matchUpId,resolvedRound:t?[t.roundNumber,t.roundPosition]:void 0,resolvedStatus:t?.matchUpStatus})):!t&&a&&(t=s.find(({drawPositions:e,roundNumber:t})=>t===o&&e?.includes(a)),gh({method:"getPairedPreviousMatchUpIsDoubleExit",color:"cyan",info:"resolved_sourceMatchUp_from_drawPosition",resolvedMatchUpId:t?.matchUpId,resolvedRound:t?[t.roundNumber,t.roundPosition]:void 0,resolvedStatus:t?.matchUpStatus}));let c=t?.roundPosition,u=c%2?1:-1,d=c+u,l=o&&s.find(({roundNumber:e,roundPosition:t})=>e===o&&t===d),p=l?.matchUpStatus,m=[yd,vd].includes(p);return gh({method:"getPairedPreviousMatchUpIsDoubleExit",color:m?"brightred":"brightgreen",keyColors:{pairedMatchUpId:"brightcyan",isDoubleExit:m?"brightred":"brightgreen"},sourceRoundPosition:c,offset:u,pairedRoundPosition:d,pairedMatchUpId:l?.matchUpId,pairedRound:l?[l.roundNumber,l.roundPosition]:void 0,pairedStatus:p,isDoubleExit:m}),{pairedPreviousMatchUp:l,pairedPreviousMatchUpIsDoubleExit:m}}function BI({structureId:e,matchUpsMap:t,matchUp:r}){let i=r?.roundPosition,n=i+(i%2?1:-1);return{pairedPreviousMatchUp:Jp({matchUpsMap:t,structureId:e}).find(({roundNumber:e,roundPosition:t})=>e===r?.roundNumber&&t===n)}}function VI({inContextDrawMatchUps:e,sourceMatchUpStatus:t,sourceMatchUpId:r,matchUpsMap:i,matchUp:n}){let a=e.find(e=>e.matchUpId===r),{pairedPreviousMatchUp:o}=BI({structureId:a?.structureId,matchUp:a,matchUpsMap:i});if(a&&o){let r=o?.matchUpId,i=e.find(e=>e.matchUpId===r),s=a?.structureId===i?.structureId?a?.roundPosition<i?.roundPosition?1:2:a.structureId===i?.structureId?2:1;n.matchUpStatusCodes=(n.matchUpStatusCodes??[]).map(e=>{let r=S(e)||!isNaN(e)?{code:e}:e;return r.sideNumber===s?{...r,previousMatchUpStatus:t}:r})}}function GI({inContextDrawMatchUps:e,drawPosition:t,matchUpId:r}){let i=e.filter(({winnerMatchUpId:e,loserMatchUpId:t})=>t===r||e===r).sort((e,t)=>e.roundPosition-t.roundPosition);return e.find(e=>e.matchUpId===r).feedRound?1:i.reduce((e,r,i)=>r.drawPositions?.includes(t)?i+1:e,void 0)}function jI({inContextDrawMatchUps:e,sourceMatchUpStatus:t,tournamentRecord:r,sourceMatchUpId:i,drawDefinition:n,matchUpStatus:a,drawPosition:o,matchUpsMap:s,matchUpId:c,event:u}){let d="assignMatchUpDrawPosition";s||(s=Kp({drawDefinition:n})),e||(e=Kf({inContext:!0,drawDefinition:n,matchUpsMap:s}).matchUps??[]);let l=e.find(e=>e.matchUpId===c),p=l?.structureId,f=n?.structures?.find(e=>e.structureId===p);if(!f)return{error:et};let h=s?.drawMatchUps?.find(e=>e.matchUpId===c),I=h?.drawPositions??[],{positionAdded:U,positionAssigned:S,updatedDrawPositions:v}=function({drawPosition:e,drawPositions:t}){let r=!1,i=!!t?.includes(e);return{updatedDrawPositions:i?t||[]:[...t,void 0,void 0].slice(0,2).map(t=>t||i?t:(i=!0,r=!0,e)).sort(g).filter(Boolean),positionAdded:r,positionAssigned:i}}({drawPositions:I,drawPosition:o}),{positionAssignments:y}=$d({drawDefinition:n,structure:f}),w=y?.filter(e=>v.includes(e.drawPosition))?.find(({bye:e})=>e),P=h?.matchUpStatus&&Sh(h.matchUpStatus)&&v.filter(Boolean).length<2;a=(w?"BYE":a)||P&&h.matchUpStatus||h?.matchUpStatus&&[yd,vd].includes(h.matchUpStatus)&&h.matchUpStatus||Md;let T=!(!Sh(h?.matchUpStatus)||!h?.winningSide);if(h&&U){e=Kf({inContext:!0,drawDefinition:n,matchUpsMap:s}).matchUps??[];let u=P&&GI({inContextDrawMatchUps:e,drawPosition:o,matchUpId:c})||T&&h.winningSide||void 0;h?.matchUpStatusCodes&&VI({inContextDrawMatchUps:e,sourceMatchUpStatus:t,sourceMatchUpId:i,matchUpsMap:s,matchUp:h}),Object.assign(h,{drawPositions:v,winningSide:u,matchUpStatus:T?h?.matchUpStatus:a}),Dl({tournamentId:r?.tournamentId,eventId:l?.eventId,context:d,drawDefinition:n,matchUp:h})}let D=Wf({inContextDrawMatchUps:e,inContextMatchUp:l,drawDefinition:n,matchUpId:c}),{targetMatchUps:{winnerMatchUp:b,loserMatchUp:M,loserTargetDrawPosition:R},targetLinks:{loserTargetLink:N}}=D,A=Jp({structureId:f.structureId,matchUpsMap:s});if(S&&w){if(b)if(["BYE",yd,vd].includes(a)){let t=jI({matchUpId:b.matchUpId,inContextDrawMatchUps:e,tournamentRecord:r,drawDefinition:n,drawPosition:o,matchUpsMap:s});if(t.error)return t}else{let{structureId:e}=b;e!==f.structureId&&console.log("winnerMatchUp in different structure... participant is in different targetDrawPosition")}}else if(S&&T){if(b){let t=jI({matchUpId:b.matchUpId,inContextDrawMatchUps:e,tournamentRecord:r,drawDefinition:n,drawPosition:o,matchUpsMap:s});if(t.error)return t}}else if(b&&l&&!l.feedRound){let{pairedPreviousMatchUpIsDoubleExit:t}=LI({targetMatchUp:h,drawPosition:o,matchUpsMap:s,structure:f});if(t){let t=jI({matchUpId:b.matchUpId,inContextDrawMatchUps:e,tournamentRecord:r,drawDefinition:n,drawPosition:o,matchUpsMap:s});if(t.error)return t}}if(h?.matchUpType===m){let t=e?.find(({matchUpId:e})=>e===h.matchUpId),i=(t?.sides??[]).reduce((e,t,r)=>t.drawPosition===o?r:e,void 0),a=y?.find(e=>e.drawPosition===o)?.participantId;a&&void 0!==i&&_I({inContextTargetMatchUp:t,drawPositionSideIndex:i,teamParticipantId:a,tournamentRecord:r,drawDefinition:n,matchUp:h})}if(N?.linkCondition===gs&&2===v.filter(Boolean).length&&!w&&A.filter(({drawPositions:e,roundNumber:t})=>1===t&&Z(e,v)).every(({matchUpStatus:e})=>[Id,Dd].includes(e))&&M){let{structureId:e}=M,t=vh({drawPosition:R,tournamentRecord:r,drawDefinition:n,structureId:e,matchUpsMap:s,event:u});if(t.error)return t}return S?{...ce}:Pn({result:{error:Me},context:{drawPosition:o},stack:d})}function $I({inContextDrawMatchUps:e,drawDefinition:t,assignments:r,matchUpsMap:i,structure:n}){let a=Ol({drawDefinition:t})?.containedStructures?.[n.structureId]?.map(({structureId:e})=>e)||[];a.push(n?.structureId);let o=r?.map(({drawPosition:e})=>e)||[],s=e?.filter(e=>a.includes(e.structureId)&&Q(e.drawPositions??[],o).length)??[],c=s.map(({matchUpId:e})=>e),u=i?.drawMatchUps?.filter(e=>c.includes(e.matchUpId))??[];return{drawPositions:o,matchUps:u,targetMatchUps:s}}function qI({lineUp:e}){if(!Array.isArray(e))return;let t={};return L(e.flatMap(({collectionAssignments:e})=>e?.map(({collectionId:e,collectionPosition:t})=>[e,t].join("|"))).filter(Boolean)).forEach(r=>{let[i,n]=r.split("|"),a=parseInt(n),{assignedParticipantIds:o}=Cf({collectionPosition:a,collectionId:i,lineUp:e});o.forEach(e=>{t[e]||(t[e]=[]),t[e].push({collectionId:i,collectionPosition:a})})}),Object.keys(t).map(e=>({participantId:e,collectionAssignments:t[e]}))}function WI(e){return`${e} must be an array`}function HI({lineUp:e,tieFormat:t}){let r=[];if(!Array.isArray(e))return r.push(WI("lineUp")),{valid:!1,errors:r,error:gi};let i=e.every(e=>{if("object"!=typeof e)return r.push("lineUp entries must be objects"),!1;let{participantId:t,collectionAssignments:i}=e;return t?"string"!=typeof t?(r.push("participantIds must be strings"),!1):Array.isArray(i)?i.every(e=>{if("object"!=typeof e)return r.push("collectionAssignments must be objects"),!1;let{collectionPosition:t}=e;return"number"==typeof t||(r.push("collectionPosition must be a number"),!1)}):(r.push(WI("collectionAssignments")),!1):(r.push("Missing participantId"),!1)}),n=L(e.map(dd)).length===e.length;return n||r.push("Duplicated participantId(s)"),{valid:i&&n,errors:r,error:r.length?gi:void 0}}function YI({drawDefinition:e,participantId:t,tieFormat:r,lineUp:i}){if("object"!=typeof e)return{error:ye};if("string"!=typeof t)return{error:Ir};let n=HI({lineUp:i,tieFormat:r});if(!n.valid)return n;let{extension:a}=Ru({element:e,name:Vu}),o=a?.value||{};return o[t]=qI({lineUp:i}),Uu({element:e,extension:{name:Vu,value:o}}),bl({drawDefinition:e}),{...ce}}function zI({inContextDrawMatchUps:e,inheritance:t=!0,tournamentRecord:r,drawDefinition:i,matchUpsMap:n,assignments:a,structure:o,event:s}){if(!i)return{error:ye};let{drawPositions:c,matchUps:u,targetMatchUps:d}=$I({inContextDrawMatchUps:e,matchUpsMap:n,assignments:a,structure:o});for(let l of d)l.matchUpType===p&&(l.sides??[]).forEach((e,n)=>{if(e?.drawPosition&&c?.includes(e.drawPosition)){let a=u.find(({matchUpId:e})=>e===l.matchUpId);if(a?.sides?.[n]){if(delete a.sides[n].lineUp,!1===t){let t=l.tieFormat,r=e.participantId;t&&r&&YI({drawDefinition:i,participantId:r,lineUp:[],tieFormat:t})}Dl({tournamentId:r?.tournamentId,context:"resetLineUps",eventId:s?.eventId,drawDefinition:i,matchUp:a})}}});return{...ce}}function KI({provisionalPositioning:e,inContextDrawMatchUps:t,isQualifierPosition:r,sourceMatchUpStatus:i,tournamentRecord:n,drawDefinition:a,seedingProfile:o,participantId:s,seedBlockInfo:c,drawPosition:u,matchUpsMap:d,structureId:l,event:p}){let f="assignDrawPosition";if(!s&&!r)return Pn({result:{error:Ir},stack:f});d=d??Kp({drawDefinition:a}),t||({matchUps:t}=Kf({inContext:!0,drawDefinition:a,matchUpsMap:d}));let h=Vd({drawDefinition:a,structureId:l});if(h.error)return Pn({result:h,stack:f});let{structure:g}=h;if(!g)return{error:et};if(nm({structure:g}))return Pn({result:{error:Ct},stack:f});let{seedAssignments:I}=Wp({provisionalPositioning:e,drawDefinition:a,structure:g}),U=I?.find(e=>e.participantId===s)?.seedNumber,{appliedPolicies:S}=up({tournamentRecord:n,drawDefinition:a,structure:g,event:p});if(U&&!OI({seedNumber:U,appliedPolicies:S,drawDefinition:a,seedBlockInfo:c,drawPosition:u,structureId:l}))return Pn({result:{error:be},context:{drawPosition:u},stack:f});let v=qd({structure:g}).positionAssignments||[],y=v?.find(e=>e.drawPosition===u);if(!y)return Pn({result:{error:Fe},context:{drawPosition:u},stack:f});if(v?.map(dd).includes(s))return Pn({result:{error:br},context:{drawPosition:u},stack:f});let{containsParticipant:w,containsBye:P}=Uh(y);if(P){let e=bh({inContextDrawMatchUps:t,tournamentRecord:n,drawDefinition:a,drawPosition:u,structureId:l,matchUpsMap:d,event:p});if(e.error)return Pn({result:e,stack:f})}if(w&&y.participantId!==s){let{activeDrawPositions:e}=ph({drawDefinition:a,structureId:l});if(e.includes(u))return Pn({result:{error:Oe},stack:f});zI({assignments:[y],inContextDrawMatchUps:t,tournamentRecord:n,drawDefinition:a,matchUpsMap:d,structure:g})}if(y.participantId=s,r&&(y.qualifier=!0),g.stage===Ho&&(!g.stageSequence||g.stageSequence>1)||g.stage&&[zo,Jo].includes(g.stage)){let t=g.stage===Yo?Yo:Ho,r=(a.structures?.find(e=>e?.stage===t&&1===e?.stageSequence)?.seedAssignments??[]).find(e=>e.participantId===s);if(r?.participantId){let{participantId:t,seedNumber:i,seedValue:s}=r;xI({eventId:p?.eventId,provisionalPositioning:e,tournamentRecord:n,drawDefinition:a,seedingProfile:o,participantId:t,seedNumber:i,seedValue:s,structureId:l,event:p})}}if(g.structureType===cs){Dh({positionAssignments:v,tournamentRecord:n,drawDefinition:a,matchUpsMap:d,structure:g});let{drawPositions:e,matchUps:r,targetMatchUps:i}=$I({assignments:[y],inContextDrawMatchUps:t,drawDefinition:a,matchUpsMap:d,structure:g});if(e&&1===r?.length&&r[0].matchUpType===m){let t=(i?.[0].sides??[]).reduce((t,r,i)=>e?.includes(r.drawPosition)?i:t,void 0);_I({inContextTargetMatchUp:i[0],teamParticipantId:s,matchUp:r[0],drawPositionSideIndex:t,tournamentRecord:n,drawDefinition:a})}}else!function({provisionalPositioning:e,inContextDrawMatchUps:t,sourceMatchUpStatus:r,tournamentRecord:i,drawDefinition:n,drawPosition:a,matchUpsMap:o,structure:s,event:c}){let u={isCollectionMatchUp:!1},{matchUps:d}=Bf({provisionalPositioning:e,matchUpFilters:u,drawDefinition:n,matchUpsMap:o,structure:s,event:c}),{roundMatchUps:l}=em({matchUps:d}),{initialRoundNumber:p}=mh({drawPosition:a,matchUps:d}),m=p&&l?.[p].find(e=>e.drawPositions?.includes(a));if(m){let e=jI({matchUpId:m.matchUpId,inContextDrawMatchUps:t,sourceMatchUpStatus:r,tournamentRecord:i,drawDefinition:n,drawPosition:a,matchUpsMap:o});if(e.error)return Pn({stack:"assignDrawPositionToMatchUps",context:{drawPosition:a},result:e})}}({provisionalPositioning:e,inContextDrawMatchUps:t,sourceMatchUpStatus:i,tournamentRecord:n,drawDefinition:a,drawPosition:u,matchUpsMap:d,structure:g,event:p});let T=a.entries?.find(e=>e.participantId===s),D=p?.entries?.find(e=>e.participantId===s);return!T&&D&&Gg({entryStatus:D.entryStatus,entryStage:g.stage,ignoreStageSpace:!0,drawDefinition:a,participantId:s,event:p}),Nl({tournamentId:n?.tournamentId,drawDefinition:a,structure:g,event:p}),{positionAssignments:v,...ce}}function JI(e){let{participantIdAttributeName:t="participantId",isQualifierPosition:r,positionActionName:i,tournamentRecord:n,drawDefinition:a,participantId:o,drawPosition:s,structureId:c,event:u}=e,d="positionParticipantAction";if(!a)return{error:ye};let l=up({tournamentRecord:n,drawDefinition:a,event:u}).appliedPolicies??{},{inContextDrawMatchUps:p,matchUpsMap:m}=e;m||(m=Kp({drawDefinition:a}),Object.assign(e,{matchUpsMap:m})),p||(({matchUps:p}=Kf({inContext:!0,drawDefinition:a,matchUpsMap:m})),Object.assign(e,{inContextDrawMatchUps:p}));let{positionAssignments:f}=$d({drawDefinition:a,structureId:c}),h=f?.find(e=>e.drawPosition===s);if(h?.participantId){let e=h.participantId,t=KI({inContextDrawMatchUps:p,tournamentRecord:n,drawDefinition:a,participantId:o,drawPosition:s,structureId:c,matchUpsMap:m,event:u});return t.success?S({appliedPolicies:l,removedParticipantId:e}):Pn({result:t,stack:d})}let g=bh({inContextDrawMatchUps:p,tournamentRecord:n,drawDefinition:a,drawPosition:s,structureId:c,matchUpsMap:m,event:u});if(g.error)return Pn({result:g,stack:d});let I=g.participantId,U=KI({inContextDrawMatchUps:p,isQualifierPosition:r,tournamentRecord:n,drawDefinition:a,participantId:o,drawPosition:s,structureId:c,matchUpsMap:m,event:u});return U.success?S({appliedPolicies:l,removedParticipantId:I}):Pn({result:U,stack:d});function S({appliedPolicies:e,removedParticipantId:r}){let{structure:n}=Vd({drawDefinition:a,structureId:c});return El({drawPositions:[s],structure:n}),Cl({appliedPolicies:e,drawDefinition:a,positionAction:{[t]:o,name:i,drawPosition:s,structureId:c}}),Pn({context:{removedParticipantId:r},result:{...ce},stack:d})}}function QI(e){return function({luckyLoserParticipantId:e,tournamentRecord:t,drawDefinition:r,drawPosition:i,structureId:n}){return JI({positionActionName:"luckyLoserDrawPositionAssignment",participantId:e,tournamentRecord:t,drawDefinition:r,drawPosition:i,structureId:n})}(e)}function XI({params:e,modMap:t,structure:r}){let{tournamentRecord:i,drawDefinition:n,event:a}=e;for(let o of r.matchUps)t[o.matchUpId]&&(o.roundNumber=t[o.matchUpId],Dl({tournamentId:i?.tournamentId,eventId:a?.eventId,drawDefinition:n,matchUp:o}))}function ZI(e,t){let r=[{drawDefinition:!0,structureId:!0}];Array.isArray(t)&&r.push(...t);let i=$c(e,r);if(i.error)return i;let n=Vd(e);if(n.error)return n;let a=n.structure;if(!nm({structure:a}))return Pn({result:{error:Te,message:"structure must be adHoc"}});let{roundMatchUps:o=[],roundNumbers:s}=em({matchUps:a?.matchUps});return s?.length?{valid:!0,structure:a,roundMatchUps:o,roundNumbers:s}:{error:At}}function eU(e){let t=ZI(e,[{targetRoundNumber:!0,roundNumber:!0,[_c]:"number"}]);if(t.error)return t;let{structure:r,roundMatchUps:i,roundNumbers:n}=t,{targetRoundNumber:a,roundNumber:o}=e;if(!n?.includes(o)||!n?.includes(a))return Pn({result:{error:gi},info:"roundNumbers must be valid rounds"});let s=a>o,c=s?K(o+1,a+1):K(a,o),u={};return c.forEach(e=>(i?.[e]??[]).forEach(({matchUpId:t})=>{u[t]=e-(s?1:-1)})),i?.[o]?.forEach(({matchUpId:e})=>u[e]=a),XI({params:e,modMap:u,structure:r}),{...ce}}function tU({structurePositionAssignments:e,provisionalPositioning:t,tournamentRecord:r,drawDefinition:i,event:n}){if(!i)return{error:ye};if(!Array.isArray(e))return{error:gi};for(let o of e){let{structureId:e,positionAssignments:a}=o;if(!a)continue;let s=Vd({drawDefinition:i,structureId:e});if(s.error)return s;let c=s.structure;if(!c)return{error:et};let u=$d({structure:c}).positionAssignments?.map(({drawPosition:e})=>e),d=a?.map(({drawPosition:e})=>e);if(Q(u,d).length!==u?.length)return Pn({result:{error:gi},info:"drawPositions do not match",stack:"setPositionAssignments"});let l=Kp({drawDefinition:i}),{matchUps:p}=Kf({inContext:!0,drawDefinition:i,matchUpsMap:l});for(let o of a||[]){let{drawPosition:s,participantId:u,bye:d,qualifier:m}=o;if(d){let t=vh({tournamentRecord:r,drawDefinition:i,drawPosition:s,matchUpsMap:l,structureId:e,structure:c,event:n});if(t?.error)return t}else if(m)a.forEach(e=>{e.drawPosition===s&&(e.qualifier=!0,delete e.participantId,delete e.bye)});else if(u){let a=KI({provisionalPositioning:t,inContextDrawMatchUps:p,tournamentRecord:r,drawDefinition:i,participantId:u,drawPosition:s,matchUpsMap:l,structureId:e,event:n});if(a?.error)return a}}Nl({tournamentId:r?.tournamentId,drawDefinition:i,structure:c,event:n})}let a=e.map(({structureId:e})=>e);return Ml({tournamentId:r?.tournamentId,eventId:n?.eventId,drawDefinition:i,structureIds:a}),{...ce}}function rU(e){let t=ZI(e,[{roundNumbers:!0,[_c]:Oc,[kc]:e=>2===e.length&&e.every(E)}]);if(t.error)return t;let{structure:r,roundMatchUps:i,roundNumbers:n}=t;if(!e.roundNumbers.every(e=>n?.includes(e)))return Pn({result:{error:gi,message:"roundNumbers must be valid rounds"}});let a={};return e.roundNumbers.forEach((t,r)=>(i?.[t]??[]).forEach(({matchUpId:t})=>{a[t]=e.roundNumbers[1-r]})),XI({params:e,modMap:a,structure:r}),{...ce}}function iU({alternateParticipantId:e,tournamentRecord:t,drawDefinition:r,drawPosition:i,structureId:n,event:a}){return JI({positionActionName:"alternateDrawPositionAssignment",participantIdAttributeName:"alternateParticipantid",participantId:e,tournamentRecord:t,drawDefinition:r,drawPosition:i,structureId:n,event:a})}function nU({drawDefinition:e,structureId:t}){if(!e)return{error:ye};let{structure:r}=Vd({drawDefinition:e,structureId:t}),i=(e?.links||[]).filter(e=>e.source?.structureId===t).map(e=>e.target?.structureId);return{playoffStructures:(e?.structures||[]).filter(e=>i.includes(e.structureId)),structure:r}}function aU({withStageGrouping:e,stageSequences:t,stageSequence:r,roundTarget:i,stages:n,event:a,stage:o}){if(!a)return{error:ot};let s={},c=[];for(let u of a.drawDefinitions||[]){let{structures:a,stageStructures:d}=Gd({withStageGrouping:e,stageSequences:t,drawDefinition:u,stageSequence:r,roundTarget:i,stages:n,stage:o});if(c.push(...a),d)for(let e of Object.keys(d))s[e]||(s[e]=[]),s[e].push(...d[e])}return{structures:c,stageStructures:s}}function oU({withStageGrouping:e,tournamentRecord:t,stageSequences:r,stageSequence:i,roundTarget:n,stages:a,stage:o}){if(!t)return{error:Ie};let s={},c=[];for(let u of t.events||[]){let{structures:t,stageStructures:d}=aU({withStageGrouping:e,stageSequences:r,stageSequence:i,roundTarget:n,stages:a,event:u,stage:o});if(t&&c.push(...t),d)for(let e of Object.keys(d))s[e]||(s[e]=[]),s[e].push(...d[e])}return{structures:c,stageStructures:s}}function sU(e){if(!e?.drawDefinition)return!1;let t=Gf(e),r=t?.includesTeamMatchUps,{completedMatchUps:i,pendingMatchUps:n,upcomingMatchUps:a}=t||{};return r&&(i=i?.filter(({matchUpType:e})=>e===m),n=n?.filter(({matchUpType:e})=>e===m),a=a?.filter(({matchUpType:e})=>e===m)),!(!i?.length||n?.length||a?.length)}function cU(e){let{drawDefinition:t,structureId:r}=e;if(!t)return{error:ye};let{playoffStructures:i}=nU({drawDefinition:t,structureId:r});if(!i?.length)return!1;let n=t?.entries?.filter(e=>e?.entryStatus&&Bp.includes(e.entryStatus))?.length??0,a=0;return(i||[]).reduce((e,t)=>!(!($d({structure:t}).positionAssignments??[])?.filter(e=>(e.participantId&&a++,e?.bye??e?.participantId)).length||!e),!!i.length)||a===n}function uU({significantCharacters:e,accessors:t=[],value:r}){let i=[],n=t[0];if(r?.[n]){let a=t.slice(1);if(Array.isArray(r[n]))r[n].forEach(t=>{let r=uU({accessors:a,significantCharacters:e,value:t});i.push(...r)});else if(r=r[n],a.length){let t=uU({accessors:a,significantCharacters:e,value:r});i.push(...t)}else!function({value:t}){if(t&&["string","number"].includes(typeof t)){let r=e?t.slice(0,e):t;i.push(r)}}({value:r})}return i}function dU({policyAttributes:e,idCollections:t,participants:r,participant:i}){if(!Array.isArray(e))return{error:xt};if(!i)return{error:hr};let n=[];return e.forEach(e=>{let{directive:a,groupings:o,key:s,significantCharacters:c}=e||{};if(s){let e=s.split(".");n.push(...uU({significantCharacters:c,value:i,accessors:e}))}else if(a){let o=e?.includeIds,s=(t?.[a]||[]).filter(e=>!o||o.includes(e));s?.length&&r?.length&&s.forEach(e=>{let t=r.find(t=>t.participantId===e);if(t?.individualParticipantIds?.includes(i.participantId)){let e=t?.participantId;n.push(e)}})}else o&&Object.keys(o).forEach(e=>{o[e].includes(i.participantId)&&n.push(e)})}),{values:L(n)}}function lU({candidatePositionAssignments:e,participantsWithGroupings:t,policyAttributes:r,idCollections:i}){let n=Object.assign({},...t.map(e=>({[e.participantId]:e})));return e.map(e=>{let a=n[e.participantId],{values:o}=dU({participants:t,policyAttributes:r,idCollections:i,participant:a});return{...e,values:o}})}function pU({participantIdGroups:e,positionAssignments:t,groupsToAvoid:r}){return Object.assign({},...t.filter(e=>e?.participantId).map(t=>{let{drawPosition:i,participantId:n}=t,a=e&&e[n]||[],o=!!r.some(e=>a.includes(e));return{[i]:{participantGroups:a,includesGroupsToAvoid:o}}}))}function mU(e){let{unfilledPositions:t,chunkedDrawPositions:r}=e,i=pU(e);return r.map(e=>{let r=t.filter(t=>e.includes(t)),n=function(e){return e.filter(e=>!t(e));function t(t){let r=fU(t);return!e.includes(r)}}(r),a=r.filter(e=>!n.includes(e)).filter(e=>{let t=fU(e);return!i[t]?.includesGroupsToAvoid});return{unassigned:r,unpaired:n,pairedNoConflict:a}})}function fU(e){return Number(e%2?e+1:e-1)}function hU({selectedParticipantGroups:e,participantIdGroups:t,positionAssignments:r,drawPositionChunks:i,unfilledPositions:n,isRoundRobin:a}){let o=i.map(i=>a?function(e){let{unfilledPositions:t,chunkedDrawPositions:r}=e,i=pU(e);return r.map(e=>{let r=t.filter(t=>e.includes(t)),n=r.length===e.length?r:[],a=e.filter(e=>i[e]?.includesGroupsToAvoid).length;return{unassigned:r,unpaired:n,pairedNoConflict:a?[]:r,conflictsCount:a}})}({groupsToAvoid:e,chunkedDrawPositions:i,participantIdGroups:t,positionAssignments:r,unfilledPositions:n}):mU({groupsToAvoid:e,chunkedDrawPositions:i,participantIdGroups:t,positionAssignments:r,unfilledPositions:n}));if(a){return{unassigned:o.map(e=>e.map(e=>e.unassigned).filter(e=>e?.length)).filter(e=>e?.length).sort((e,t)=>(t.length||0)-(e.length||0)),unpaired:o.map(e=>e.map(e=>e.unpaired).filter(e=>e?.length)).filter(e=>e?.length),pairedNoConflict:o.map(e=>e.map(e=>e.pairedNoConflict).filter(e=>e?.length)).filter(e=>e?.length).sort((e,t)=>(t.length||0)-(e.length||0))}}return{unassigned:o.map(e=>e.map(e=>e.unassigned).filter(e=>e?.length)).filter(e=>e?.length),unpaired:o.map(e=>e.map(e=>e.unpaired).filter(e=>e?.length)).filter(e=>e?.length),pairedNoConflict:o.map(e=>e.map(e=>e.pairedNoConflict).filter(e=>e?.length)).filter(e=>e?.length)}}function gU({positionAssignments:e,participantIds:t}){let r=e.map(e=>e.participantId);return t.filter(e=>!r.includes(e))}function IU({candidatePositionAssignments:e,unseededParticipantIds:t,participantIdGroups:r,drawPositionChunks:i,drawPositionGroups:n,pairedPriority:a,allGroups:o,groupKey:s}){let c,u=n.reduce((e,t)=>t.length>e?t.length:e,0)<=2,d=gU({positionAssignments:e,participantIds:t}),l=function({drawPositionGroups:e,positionAssignments:t}){let r=Object.assign({},...t.map(e=>({[e.drawPosition]:e})));return e.map(e=>e.filter(Boolean).map(e=>r[e]).filter(Boolean).filter(e=>!e.participantId&&!e.bye).map(e=>e.drawPosition)).flat().filter(Boolean)}({positionAssignments:e,drawPositionGroups:n}),{participantId:p,groupKey:m}=function({useSpecifiedGroupKey:e=!1,targetParticipantIds:t,largestFirst:r=!0,allGroups:i,groupKey:n}){let a=Object.assign({},...Object.keys(i).map(e=>[e,i[e].filter(e=>t.includes(e))]).filter(e=>e[1].length).map(([e,t])=>({[e]:t}))),o=Object.keys(a).reduce((e,t)=>a[t].length>e?a[t].length:e,0),s=Object.keys(a).filter(e=>a[e].length===o),c=z(r?s:Object.keys(a));return{participantId:(n=e&&a[n]?.length?n:c)&&a[n]?z(a[n]):z(t),groupKey:n}}({targetParticipantIds:d,useSpecifiedGroupKey:u,allGroups:o,groupKey:s}),f=function({allGroups:e,participantId:t}){return Object.keys(e).filter(r=>e[r].includes(t))}({participantId:p,allGroups:o}),h=hU({positionAssignments:e,isRoundRobin:u,selectedParticipantGroups:f,participantIdGroups:r,drawPositionChunks:i,unfilledPositions:l}),{unassigned:g,unpaired:I,pairedNoConflict:U}=h,S=U?.length&&U[0],v=I?.length&&I[0],y=a&&S?S:v,w=a?v:S,P=y?.length&&y||w?.length&&w;if(P?.length){let e=Y(P);c=Y(e)}else{let e=Y(g[0]);c=Y(e)}return{newGroupKey:m,selectedParticipantId:p,targetDrawPosition:c}}function UU({isRoundRobin:e,groupedParticipants:t}){let r=[];return e?t.forEach(e=>{let t=vI({drawPositions:e.map(e=>e.drawPosition)}).uniqueMatchUpGroupings??[],i=Object.assign({},...e.map(e=>({[e.drawPosition]:e})));t.forEach(t=>{Z(i[t[0]].values||[],i[t[1]].values||[])&&(r.push(t),e.conflict=!0)})}):t.forEach(e=>{Z(e[0]?.values||[],e[1]?.values||[])&&(r.push(e),e.conflict=!0)}),r}function SU(e,t){return e.find(e=>e.drawPosition===t)}function vU({positionedParticipants:e,potentialDrawPositions:t,drawPositionGroups:r,avoidanceConflicts:i,isRoundRobin:n}){return i.flatMap(i=>{let a=i.map(e=>e.drawPosition);return i.filter(e=>t.includes(e.drawPosition)).map(i=>{let o=t.filter(e=>!a?.includes(e)).filter(t=>function({moveableParticipant:e,possibleDrawPosition:t,positionedParticipants:r,drawPositionGroups:i,isRoundRobin:n,getAvoidanceConflicts:a}){let o=function(e,t){let r=e.find(e=>e.includes(t));if(r)return r.find(e=>e!==t)}(i,t),s=SU(r,o),c=a({isRoundRobin:n,groupedParticipants:[[e,s]]}),u=a({isRoundRobin:n,groupedParticipants:[[SU(r,t),s]]});return!c.length&&!u.length}({moveableParticipant:i,possibleDrawPosition:t,positionedParticipants:e,drawPositionGroups:r,isRoundRobin:n,getAvoidanceConflicts:UU}));if(o.length)return{drawPosition:i.drawPosition,possibleDrawPositions:o}}).filter(Boolean)})}function yU(e){let t,{initialPositionAssignments:r,participantsWithGroupings:i,opponentsToPlaceCount:n,unseededByePositions:a,drawPositionGroups:o,policyAttributes:s,idCollections:c,allGroups:u}=e,d=[],l=Math.min(...(o||[]).map(e=>e?.length).filter(Boolean)),p=l>2,m=Wa(r,!1,!0).filter(e=>!e.qualifier),f=r.filter(e=>!e.participantId&&(!e.bye||a?.includes(e.drawPosition))).map(e=>e.drawPosition);K(0,n).forEach(()=>{let{newGroupKey:r,selectedParticipantId:i,targetDrawPosition:n}=IU({...e,candidatePositionAssignments:m,allGroups:u,groupKey:t});t=r,m.forEach(e=>{e.drawPosition===n&&(e.participantId=i)})});let h=lU({candidatePositionAssignments:m,participantsWithGroupings:i,policyAttributes:s,idCollections:c}),g=re(h,l),I=UU({groupedParticipants:g,isRoundRobin:p}),U=0;for(;U<20&&I.length;){let e=vU({positionedParticipants:h,potentialDrawPositions:f,avoidanceConflicts:I,drawPositionGroups:o,isRoundRobin:p});if(e.length){let t=wU({candidatePositionAssignments:m,swapOptions:e});t.error&&console.log({result:t}),h=lU({candidatePositionAssignments:m,participantsWithGroupings:i,policyAttributes:s,idCollections:c}),g=re(h,l),I=UU({groupedParticipants:g,isRoundRobin:p}),U++}else U=20}return m.forEach(e=>{if(e.bye&&e.participantId){let e=Ye;d.push(e)}if(e.qualifier&&e.participantId){let e=Ye;d.push(e)}}),{positionAssignments:m,conflicts:I.length,groupedParticipants:g,errors:d}}function wU({candidatePositionAssignments:e,swapOptions:t}){let r=Y(t);if(!r)return{error:{message:"No swap options"}};let i=r.drawPosition,n=Y(r.possibleDrawPositions),a=e.find(e=>e.drawPosition===i),o=e.find(e=>e.drawPosition===n)??{},s={participantId:o?.participantId,qualifier:o?.qualifier,bye:o?.bye},c={participantId:a.participantId,qualifier:a.qualifier,bye:a.bye};return Object.assign(a,s),Object.assign(o,c),{...ce}}function PU({provisionalPositioning:e,unseededParticipantIds:t,inContextDrawMatchUps:r,unseededByePositions:i,tournamentRecord:n,drawDefinition:a,seedBlockInfo:o,participants:s,matchUpsMap:c,structureId:u,avoidance:d,drawSize:l,event:p}){if(!d)return{error:Ft};let{candidatesCount:m=1,policyAttributes:f,targetDivisions:h}=d,{roundsToSeparate:I}=d,U="randomUnseededSeparation",{structure:S}=Vd({drawDefinition:a,structureId:u}),{matchUps:v}=Bf({provisionalPositioning:e,matchUpsMap:c,structure:S,event:p});if(h&&M(h)&&!I){let e=function(e){if(1===e||Number.isNaN(Number(e))||!M(e))return!1;let t=e,r=1;for(;2!==t;)r+=1,t/=2;return r}(h)||0,t=v.reduce((e,t)=>t.roundNumber>e?t.roundNumber:e,0);I=t<e?1:t-e+1}let{positionAssignments:y}=qd({structure:S}),w=Hl({participantsProfile:{convertExtensions:!0},deepCopy:!1,participants:s}).participantsWithGroupings,P=y?.filter(e=>!e.participantId),T=y?.map(e=>e.drawPosition),D=S?.structureType===cs,b=D?{structure:S,matchUps:v,allDrawPositions:T,roundsToSeparate:I}:{matchUps:v,allDrawPositions:T,roundsToSeparate:I},{drawPositionGroups:R,drawPositionChunks:N}=D?function(e){let{structure:{structures:t}}=e,r=t.map(e=>e.positionAssignments.map(e=>e.drawPosition));return{drawPositionGroups:r,drawPositionChunks:[r]}}(b):function({allDrawPositions:e,roundsToSeparate:t,matchUps:r}){let i=r.filter(e=>1===e.roundNumber).map(e=>e.drawPositions),n=i.flat().sort(g),a=Math.max(...n),o=e.filter(e=>e>a),s=n.length,c=K(2===s?1:2,s).filter(e=>e===A(e)),u=c.slice(0,t||c.length).reverse().map(e=>re(n,e));return o.length&&console.log({fedDrawPositions:o}),{drawPositionGroups:i,drawPositionChunks:u}}(b),E={groupParticipants:s.filter(e=>e.participantType===Gl).map(e=>e.participantId),teamParticipants:s.filter(e=>e.participantType===$l).map(e=>e.participantId),pairParticipants:s.filter(e=>e.participantType===jl).map(e=>e.participantId)},C=function({targetParticipantIds:e,policyAttributes:t,idCollections:r,participants:i}){if(!Array.isArray(t))return{error:xt};if(!Array.isArray(i))return{error:gr};let n={};return e.forEach(e=>{let a=i.find(t=>t.participantId===e),{values:o}=dU({policyAttributes:t,idCollections:r,participants:i,participant:a});o&&o.forEach(t=>{n[t]||(n[t]=[]),n[t].includes(e)||n[t].push(e)})}),n}({targetParticipantIds:t,policyAttributes:f,idCollections:E,participants:s});if(C.error)return Pn({result:C,stack:U});let O=Object.assign({},...t.map(e=>{let t=Object.keys(C).filter(t=>(C[t]??[]).includes(e));return{[e]:t}})),k=gU({participantIds:t,positionAssignments:y});if(k.length>(P?.length||0))return{error:_r};let F,x=k.length,_=K(0,m).map(()=>yU({initialPositionAssignments:y,participantsWithGroupings:w,unseededParticipantIds:t,opponentsToPlaceCount:x,pairedPriority:!1,unseededByePositions:i,participantIdGroups:O,drawPositionChunks:N,drawPositionGroups:R,policyAttributes:f,idCollections:E,allGroups:C,drawSize:l}));if(F=_.reduce((e,t)=>!e||(t.conflicts||0)<(e.conflicts||0)?t:e,void 0),!F||F.conflicts){let e=K(0,m).map(()=>yU({initialPositionAssignments:y,participantsWithGroupings:w,unseededParticipantIds:t,opponentsToPlaceCount:x,pairedPriority:!0,unseededByePositions:i,participantIdGroups:O,drawPositionChunks:N,drawPositionGroups:R,policyAttributes:f,idCollections:E,allGroups:C,drawSize:l}));F=_.concat(...e).filter(e=>!e.errors?.length).reduce((e,t)=>!e||(t.conflicts||0)<(e.conflicts||0)?t:e,void 0)}if(!F)return{error:di};let L=($d({structure:S})?.positionAssignments??[]).filter(e=>e.participantId).map(e=>e.participantId),B=F.positionAssignments.filter(e=>!L.includes(e.participantId));for(let g of B)if(g.bye){let e=vh({tournamentRecord:n,drawDefinition:a,seedBlockInfo:o,structureId:u,matchUpsMap:c,event:p,...g});if(e.error)return Pn({result:e,stack:U})}else if(g.participantId){let e=KI({automaticPlacement:!0,inContextDrawMatchUps:r,tournamentRecord:n,drawDefinition:a,seedBlockInfo:o,structureId:u,matchUpsMap:c,event:p,...g});if(e.error)return Pn({result:e,stack:U,context:{assignment:g}})}return{...ce}}function TU({provisionalPositioning:e,inContextDrawMatchUps:t,unseededByePositions:r,multipleStructures:i,tournamentRecord:n,drawDefinition:a,seedBlockInfo:o,participants:s,matchUpsMap:c,structureId:u,structure:d,drawSize:l,event:p}){d||({structure:d}=Vd({drawDefinition:a,structureId:u})),u||({structureId:u}=d);let{positionAssignments:m}=qd({structure:d}),{seedAssignments:f}=Wp({provisionalPositioning:e,drawDefinition:a,structure:d}),h=f?.map(e=>e.participantId).filter(Boolean),{stage:g,stageSequence:I}=d,U=g===Yo?Ru({element:d,name:Wu})?.extension?.value:void 0,S=qp({provisionalPositioning:e,drawDefinition:a,stageSequence:I,entryStatuses:Lp,structureId:u,roundTarget:U,stage:g}),v=S.filter(e=>!h?.includes(e.participantId)).map(e=>e.participantId),y=m?.filter(e=>!e.participantId&&!e.bye&&!e.qualifier).map(e=>e.drawPosition);if(!i&&v.length>(y?.length||0))return Pn({result:{error:_r},context:{unseededParticipantsCount:v.length,unfilledDrawPositionsCount:y?.length},stack:"positionUnseededParticipants"});let{appliedPolicies:w}=up({tournamentRecord:n,drawDefinition:a,event:p}),P=w?.[uu];if(d.stage===Jo){let e=S.reduce((e,t)=>(e[t.groupingValue]||(e[t.groupingValue]=[]),e[t.groupingValue].push(t.participantId),e),{});Object.keys(e).length&&(P||(P={policyName:"Playoff Avoidance"}),P.policyAttributes||(P.policyAttributes=[]),P.policyAttributes.push({groupings:e}))}return P&&s?PU({provisionalPositioning:e,unseededParticipantIds:v,inContextDrawMatchUps:t,unseededByePositions:r,tournamentRecord:n,drawDefinition:a,seedBlockInfo:o,participants:s,matchUpsMap:c,structureId:u,avoidance:P,drawSize:l,entries:S}):function({provisionalPositioning:e,unseededParticipantIds:t,inContextDrawMatchUps:r,unfilledDrawPositions:i,multipleStructures:n,tournamentRecord:a,drawDefinition:o,seedBlockInfo:s,matchUpsMap:c,structureId:u,drawSize:d,event:l}){let p=d>2?V(i):i.reverse();for(let m of t){let t=p.pop();if(!n||t){let i=KI({provisionalPositioning:e,inContextDrawMatchUps:r,tournamentRecord:a,drawDefinition:o,seedBlockInfo:s,participantId:m,drawPosition:t,matchUpsMap:c,structureId:u,event:l});if(i?.error&&console.log("!!!!!",{result:i}),i?.error)return Pn({result:i,stack:"randomUnseededDistribution"})}}return{...ce}}({provisionalPositioning:e,unseededParticipantIds:v,inContextDrawMatchUps:t,unfilledDrawPositions:y,multipleStructures:i,tournamentRecord:n,drawDefinition:a,seedBlockInfo:o,structureId:u,matchUpsMap:c,drawSize:l,event:p})}function DU(e){let t=e.structure??Vd(e).structure,r="positionQualifiers",i=[];if(t.stage===zo)return Pn({result:{error:mt},stack:r});let{unplacedRoundQualifierCounts:n,positionAssignments:a,roundDrawPositions:o}=function({drawDefinition:e,structure:t,structureId:r}){t||({structure:t}=Vd({drawDefinition:e,structureId:r})),r||({structureId:r}=t);let{positionAssignments:i}=qd({structure:t}),{stage:n,stageSequence:a}=t,{qualifiersCount:o,roundQualifiersCounts:s}=_g({drawDefinition:e,stageSequence:a,structureId:r,stage:n}),c=(s?Object.keys(s):[]).map(e=>I(e)),{matchUps:u}=Bf({structure:t}),{roundProfile:d}=em({matchUps:u}),l=Object.assign({},...c.filter(e=>d?.[e]).map(e=>({[e]:d?.[e]?.drawPositions?.filter(Boolean)??[]}))),p=i?.filter(e=>e.qualifier).map(e=>e.drawPosition),m=o-(p?.length??0),f=p?.length;return{unplacedRoundQualifierCounts:Object.assign({},...c.map(e=>{let t=i?.filter(t=>t.qualifier&&l[e]?.drawPositions?.includes(t.drawPosition)).map(e=>e.drawPosition);return{[e]:(s?.[e]??0)-(t?.length??0)}})),unplacedQualifiersCount:m,placedQualifiersCount:f,roundQualifiersCounts:s,positionAssignments:i,roundDrawPositions:l,qualifiersCount:o}}(e);for(let s of Object.keys(n)){let e=a?.filter(e=>o[s].includes(e.drawPosition)&&!e.participantId&&!e.qualifier&&!e.bye).map(e=>e.drawPosition);if(n[s]>(e||0))return Pn({result:{error:xr},context:{unfilledDrawPositions:e},stack:r});K(0,n[s]).forEach(()=>{let t=Y(e);i.push(t),a?.forEach(e=>{e.drawPosition===t&&(e.qualifier=!0,delete e.participantId,delete e.bye)})})}return{...ce,qualifierDrawPositions:i}}function bU({provisionalPositioning:e,inContextDrawMatchUps:t,tournamentRecord:r,appliedPolicies:i,validSeedBlocks:n,drawDefinition:a,seedingProfile:o,seedBlockInfo:s,participants:c,groupsCount:u,structureId:d,matchUpsMap:l,structure:p,event:m}){let f=[],h=[],g=0;if(p||({structure:p}=Vd({drawDefinition:a,structureId:d})),d||(d=p?.structureId),i||(i=up({drawDefinition:a}).appliedPolicies),!n){let t=p&&AI({provisionalPositioning:e,appliedPolicies:i,drawDefinition:a,seedingProfile:o,structure:p});t?.error&&h.push(t.error),n=t?.validSeedBlocks}return K(0,u=u??n?.length??0).forEach(()=>{if(g<(u||0)){let i=function({provisionalPositioning:e,inContextDrawMatchUps:t,tournamentRecord:r,drawDefinition:i,seedingProfile:n,seedBlockInfo:a,participants:o,structureId:s,matchUpsMap:c,event:u}){let{unplacedSeedParticipantIds:d,unfilledPositions:l}=kI({provisionalPositioning:e,randomize:!0,drawDefinition:i,seedingProfile:n,seedBlockInfo:a,structureId:s,event:u}),{appliedPolicies:p}=up({drawDefinition:i}),{avoidance:m}=p??{};let f=[];for(let h of d){let o=l.pop();if(!o)return{error:xe};f.push(o);let d=KI({provisionalPositioning:e,inContextDrawMatchUps:t,tournamentRecord:r,drawDefinition:i,seedingProfile:n,participantId:h,seedBlockInfo:a,drawPosition:o,matchUpsMap:c,structureId:s,event:u});if(!d.success)return d}return{...ce,seedPositions:f}}({provisionalPositioning:e,inContextDrawMatchUps:t,tournamentRecord:r,drawDefinition:a,seedingProfile:o,seedBlockInfo:s,participants:c,structureId:d,matchUpsMap:l,event:m});i?.success&&(g++,f.push(...i.seedPositions??[])),i.error&&h.push({seedPositionError:i.error})}}),h.length?{error:h}:{...ce,seedPositions:f}}function MU({orderedSortedFirstRoundSeededDrawPositions:e,validSeedBlocks:t,byesToPlace:r}){let i=[];t.forEach(t=>function(e,t,r,i){if(t-r.length>e.drawPositions.length)r.push(...e.drawPositions);else{!function(e,t,r){let i,n=r[t.length];for(;i=RU(e,n);)t.push(i),n=r[t.length]}(NU(re(e.drawPositions,2)),r,i)}}(t,r,i,e));let n=i.map(e=>Array.isArray(e)?V(e):e).flat(1/0);return C(r)&&t.map(e=>e.seedNumbers[0]).includes(r)?e:n}function RU(e,t){return Array.isArray(e)&&2!==e.length?e.pop():Array.isArray(e[0])?function(e,t){let r=e[0].flat(1/0).length,i=e[1].flat(1/0).length;if(r===i){let r=e[0].flat(1/0).includes(t)?e[0]:e[1];return RU(t?r:e[Math.round(Math.random())],t)}return RU(r<i?e[1]:e[0],t)}(e,t):function(e,t){return e.includes(t)?e.indexOf(t)?e.pop():e.shift():Math.round(Math.random())?e.pop():e.shift()}(e,t)}function NU(e){let t=Math.floor(e.length/2);return e.length>2?[NU(e.slice(0,t)),NU(e.slice(t))]:e}function AU({provisionalPositioning:e,relevantMatchUps:t,appliedPolicies:r,drawDefinition:i,seedingProfile:n,seedBlockInfo:a,byesToPlace:o,structure:s}){a||(a=AI({provisionalPositioning:e,appliedPolicies:r,drawDefinition:i,seedingProfile:n,structure:s}));let{isFeedIn:c,isLuckyStructure:u,isContainer:d}=a,{validSeedBlocks:l}=a;r?.seeding?.containerByesIgnoreSeeding&&(l=[]);let p=function({provisionalPositioning:e,drawDefinition:t,structure:r}){let{positionAssignments:i}=qd({structure:r}),{seedAssignments:n}=Wp({provisionalPositioning:e,drawDefinition:t,structure:r}),a=Object.assign({},...(n||[]).filter(e=>e.participantId).map(e=>({[e.participantId]:e})));return i?.map(e=>a[e.participantId]?{...e,seedNumber:a[e.participantId].seedNumber,seedValue:a[e.participantId].seedValue}:"").filter(Boolean)}({provisionalPositioning:e,drawDefinition:i,structure:s})??[],m=L([].concat(...t.map(e=>e.drawPositions))),f=p.filter(e=>m.includes(e.drawPosition)),h=(e,t)=>NI(e.seedValue)-NI(t.seedValue),g=l.reduce((e,t)=>{let r=f.filter(e=>t.drawPositions?.includes(e.drawPosition)).sort(h);return e.concat(...r)},[]).map(e=>e.drawPosition),I=MU({orderedSortedFirstRoundSeededDrawPositions:g,validSeedBlocks:l,byesToPlace:o});return{strictSeedOrderByePositions:EU({orderedSeedDrawPositions:g,relevantMatchUps:t}).slice(0,o),blockSeedOrderByePositions:EU({orderedSeedDrawPositions:I,relevantMatchUps:t}).slice(0,o),isLuckyStructure:u,positionedSeeds:p,isContainer:d,isFeedIn:c}}function EU({orderedSeedDrawPositions:e,relevantMatchUps:t}){let r=t.map(e=>e.drawPositions).map(e=>e?.sort((e,t)=>e-t)).filter(e=>e?.[0]+1===e?.[1]);return e.map(e=>r.find(t=>t?.includes(e))).filter(Boolean).map(t=>t?.reduce((t,r)=>e.includes(r)?t:r,void 0)).filter(Boolean)}function CU({provisionalPositioning:e,tournamentRecord:t,appliedPolicies:r,drawDefinition:i,seedBlockInfo:n,seedingProfile:a,matchUpsMap:o,structureId:s,structure:c,seedLimit:u,seedsOnly:d,event:l}){c||({structure:c}=Vd({drawDefinition:i,structureId:s})),s||(s=c?.structureId);let p=!(c?.structures??c?.stage===Yo),{byesCount:m,placedByes:f,relevantMatchUps:h}=function({provisionalPositioning:e,drawDefinition:t,matchUpsMap:r,structure:i,event:n}){let{matchUps:a,roundMatchUps:o}=Bf({afterRecoveryTimes:!1,provisionalPositioning:e,drawDefinition:t,matchUpFilters:{isCollectionMatchUp:!1},matchUpsMap:r,structure:i,event:n}),s=o?.[1]||[],c=i?.structureType===cs,u=c?a:s,d=c?i?.structures?.length||0:a.length,{structureId:l,stage:p,stageSequence:m}=i,f=qp({entryStatuses:Bp,provisionalPositioning:e,drawDefinition:t,stageSequence:m,structureId:l,stage:p}),{qualifiersCount:h}=_g({provisionalPositioning:e,drawDefinition:t,stageSequence:m,structureId:l,stage:p}),g=f.length+h,{positionAssignments:I,unassignedPositions:U}=qd({structure:i}),S=U?.map(e=>e.drawPosition),v=I?.filter(e=>e.bye).length,y=I?.filter(e=>e.bye).map(e=>e.drawPosition),w=u.map(e=>e.drawPositions).filter(e=>e?.reduce((e,t)=>!y?.includes(t)&&e,!0)).flat(1/0).filter(e=>S?.includes(e)),P=I?.length,T=P?P-g:0;return T>d&&1===i.stageSequence&&i.stage!==zo&&(T=d),{placedByes:v,byesCount:T,relevantMatchUps:u,placedByePositions:y,roundMatchUps:o,positionsToAvoidDoubleBye:w}}({provisionalPositioning:e,drawDefinition:i,matchUpsMap:o,structure:c,event:l}),I=m-(f||0);if(I<=0)return{...ce};let{strictSeedOrderByePositions:U,blockSeedOrderByePositions:S,isLuckyStructure:v,isFeedIn:y}=AU({provisionalPositioning:e,relevantMatchUps:h,appliedPolicies:r,drawDefinition:i,seedingProfile:a,seedBlockInfo:n,byesToPlace:I,structure:c}),w=c?.structureType&&[cs,ss].includes(c.structureType)&&r?.seeding?.containerByesIgnoreSeeding,P=p&&S?.length?S:U,{unseededByePositions:T}=function({provisionalPositioning:e,seedOrderByePositions:t,isLuckyStructure:r,appliedPolicies:i,drawDefinition:n,seedLimit:a,structure:o,isFeedIn:s}){let c,u=i?.seeding?.seedingProfile,d=o.stage===Yo,{positionAssignments:l}=qd({structure:o}),p=l?.filter(e=>e.participantId).map(e=>e.drawPosition),{matchUps:m,roundMatchUps:f}=Bf({provisionalPositioning:e,matchUpFilters:{isCollectionMatchUp:!1},structure:o}),h=f?.[1]||[],I=o.structureType===cs?m:h,U=L([].concat(...I.map(e=>e.drawPositions))),S=Math.min(...U)-1,v=p?.filter(e=>U.includes(e)),y=e=>{let t=Math.ceil(e.length/2),r=[e.slice(0,t),e.slice(t)],i=r.map(e=>[].concat(...e.flat(1/0)).length),n=Math.min(...i.flat(1/0)),a=Math.max(...i.flat(1/0)),o=i.indexOf(a),s=n!==a,c=V(r),[u,d]=!n||s?[r[o],r[1-o]]:[c[0],c[1]];return{greaterHalf:u,lesserHalf:d}},w=e=>{let{greaterHalf:t,lesserHalf:r}=y(e),{greaterHalf:i,lesserHalf:n}=y(t),a=V(i.flat(1/0)).pop();return{newlyFilteredChunks:[...r,...n,i.flat().filter(e=>e!==a)],drawPosition:a}},P=e=>!v?.includes(e),T=e=>{let t=re(e.sort(g),Math.ceil(e.length/4)).map(e=>e.filter(P)),r=[].concat(...t.flat(1/0)).length,i=[];for(let n=0;n<r;n++){let{newlyFilteredChunks:e,drawPosition:r}=w(t);i.push(r),t=e}return i},{validSeedBlocks:D}=AI({provisionalPositioning:e,allPositions:!0,appliedPolicies:i,drawDefinition:n,structure:o}),b=D?.map(e=>e.drawPositions?.map(e=>e+S));if(s){let e=U.length,{seedBlocks:t}=bI({cluster:[is,ns].includes(FI(u)),participantsCount:e});c=t.map(e=>e.map(e=>e+S)).map(T).filter(e=>e.length)}else c=d?b?.map(e=>e.filter(P)):b?.map(T).filter(e=>e.length);let M=I.map(e=>e.drawPositions).map(e=>e?.sort((e,t)=>e-t)).filter(e=>e?.[0]+1===e?.[1]),R=e=>M.reduce((t,r)=>r.includes(e)?r.reduce((t,r)=>r!==e?r:t,void 0):t,void 0),N=c.map(e=>e.map(R)).flat(1/0).filter(P).filter(e=>!t.includes(e)).filter(Boolean);if(d&&!o.structures){let e=a%4,t=N.slice(0,e),r=f[o.roundLimit]?.length,i=re(N.slice(e),r).map(V).flat();N=t.concat(i)}return{unseededByePositions:N}}({provisionalPositioning:e,seedOrderByePositions:P,isLuckyStructure:v,appliedPolicies:r,drawDefinition:i,seedLimit:u,structure:c,isFeedIn:y}),D=(e,t)=>(e||[]).every(e=>(e=>e%2)(e)?t!==e+1:t!==e-1),b=[].concat(...P);if(!d)for(;T.length;){let e=T.find(e=>D(b,e));e?(b.push(e),T=T.filter(t=>t!==e)):(b.push(...T),T=[])}w&&(b=V(b),$i({ignoreSeededByes:w})&&console.log({byePositions:b}));let M=b.slice(0,I);for(let g of M){let r=vh({provisionalPositioning:e,tournamentRecord:t,drawDefinition:i,drawPosition:g,matchUpsMap:o,structureId:s,structure:c,event:l});if(r?.error)return r}return{...ce,unseededByePositions:T,byeDrawPositions:M}}function OU(e,t){return t||zi(),Pn({result:e,stack:"automatedPositioning"})}function kU(e){let{drawDefinition:t}=e,{applyPositioning:r=!0,provisionalPositioning:i,multipleStructures:n,placeByes:a=!0,tournamentRecord:o,seedingProfile:s,structureId:c,seedLimit:u,seedsOnly:d,drawType:l,drawSize:p,event:m}=e,f=[];r||(Yi(),t=Wa(t,!1,!0));let{structure:h,appliedPolicies:g,qualifiersCount:I,entries:U,error:S}=function(e,t,r,i){let n=Vd({drawDefinition:t,structureId:r});if(n.error)return{error:n.error};let a=n.structure;if(!a)return{error:et};let o=e.appliedPolicies||up({drawDefinition:t,structure:a,event:i})?.appliedPolicies,{qualifiersCount:s}=_g({stageSequence:a.stageSequence,provisionalPositioning:e.provisionalPositioning,stage:a.stage,drawDefinition:t,structureId:r}),c=Lp;return{structure:a,appliedPolicies:o,qualifiersCount:s,entries:qp({stageSequence:a.stageSequence,provisionalPositioning:e.provisionalPositioning,stage:a.stage,placementGroup:e.placementGroup,drawDefinition:t,entryStatuses:c,structureId:r})}}(e,t,c,m);if(S)return OU(S,r);if(!U?.length&&!I)return function(e,t){return t||zi(),e}({...ce},r);let v=e.matchUpsMap??Kp({drawDefinition:t}),y=e.inContextDrawMatchUps??Kf({inContext:!0,drawDefinition:t,matchUpsMap:v})?.matchUps,w=AI({provisionalPositioning:i,appliedPolicies:g,drawDefinition:t,seedingProfile:s,structure:h});if(w.error)return OU(w,r);let{validSeedBlocks:P}=w;f.push({validSeedBlocks:P});let T,D=e.participants||(o?Ag({withIndividualParticipants:!0,convertExtensions:!0,tournamentRecord:o})?.participants:[]);if(FI(h.seedingProfile||s)===os){let e=function({placeByes:e,provisionalPositioning:t,tournamentRecord:r,appliedPolicies:i,drawDefinition:n,seedBlockInfo:a,matchUpsMap:o,structure:s,seedLimit:c,seedsOnly:u,event:d,structureSeedingProfile:l,seedingProfile:p,inContextDrawMatchUps:m,participants:f,positioningReport:h}){let g=e?CU({provisionalPositioning:t,tournamentRecord:r,appliedPolicies:i,drawDefinition:n,seedBlockInfo:a,matchUpsMap:o,structure:s,seedLimit:c,seedsOnly:u,event:d}):void 0;if(g?.error)return{error:g.error};let I=g?.unseededByePositions;return h.push({action:"positionByes",unseededByePositions:I}),g=bU({seedingProfile:l?{positioning:l}:p,provisionalPositioning:t,inContextDrawMatchUps:m,tournamentRecord:r,appliedPolicies:i,validSeedBlocks:a.validSeedBlocks,drawDefinition:n,seedBlockInfo:a,participants:f,matchUpsMap:o,structure:s,event:d}),g.error?{error:g.error}:(h.push({seedPositions:g.seedPositions,action:"positionSeedBlocks"}),{unseededByePositions:I})}({placeByes:a,provisionalPositioning:i,tournamentRecord:o,appliedPolicies:g,drawDefinition:t,seedBlockInfo:w,matchUpsMap:v,structure:h,seedLimit:u,seedsOnly:d,event:m,structureSeedingProfile:h.seedingProfile,seedingProfile:s,inContextDrawMatchUps:y,participants:D,positioningReport:f});if(e?.error)return OU(e.error,r);T=e.unseededByePositions}else{let e=function({drawType:e,LUCKY_DRAW:t,structureSeedingProfile:r,seedingProfile:i,provisionalPositioning:n,inContextDrawMatchUps:a,tournamentRecord:o,appliedPolicies:s,validSeedBlocks:c,drawDefinition:u,seedBlockInfo:d,participants:l,matchUpsMap:p,structure:m,event:f,placeByes:h,seedLimit:g,seedsOnly:I,positioningReport:U}){let S;if(e!==t){let e=bU({seedingProfile:r?{positioning:r}:i,provisionalPositioning:n,inContextDrawMatchUps:a,tournamentRecord:o,appliedPolicies:s,validSeedBlocks:c,drawDefinition:u,seedBlockInfo:d,participants:l,matchUpsMap:p,structure:m,event:f});if(e.error)return{error:e.error};U.push({action:"positionSeedBlocks",seedPositions:e.seedPositions})}let v=h?CU({provisionalPositioning:n,tournamentRecord:o,appliedPolicies:s,drawDefinition:u,seedBlockInfo:d,matchUpsMap:p,structure:m,seedLimit:g,seedsOnly:I,event:f}):void 0;return v?.error?{error:v.error}:(S=v?.unseededByePositions,U.push({action:"positionByes",byeDrawPositions:v?.byeDrawPositions,unseededByePositions:S}),{unseededByePositions:S})}({drawType:l,LUCKY_DRAW:Ds,structureSeedingProfile:h.seedingProfile,seedingProfile:s,provisionalPositioning:i,inContextDrawMatchUps:y,tournamentRecord:o,appliedPolicies:g,validSeedBlocks:P,drawDefinition:t,seedBlockInfo:w,participants:D,matchUpsMap:v,structure:h,event:m,placeByes:a,seedLimit:u,seedsOnly:d,positioningReport:f});if(e?.error)return OU(e.error,r);T=e.unseededByePositions}let b={},M=function({seedsOnly:e,inContextDrawMatchUps:t,tournamentRecord:r,appliedPolicies:i,validSeedBlocks:n,drawDefinition:a,seedBlockInfo:o,participants:s,matchUpsMap:c,structure:u,positionQualifiers:d,positionUnseededParticipants:l,provisionalPositioning:p,unseededByePositions:m,multipleStructures:f,structureId:h,drawSize:g,event:I,positioningReport:U,conflicts:S}){if(e)return{};let v=d({inContextDrawMatchUps:t,tournamentRecord:r,appliedPolicies:i,validSeedBlocks:n,drawDefinition:a,seedBlockInfo:o,participants:s,matchUpsMap:c,structure:u});return v.error?{error:v.error}:(v.conflicts&&(S.qualifierConflicts=v.conflicts),U.push({action:"positionQualifiers",qualifierDrawPositions:v.qualifierDrawPositions}),v=l({provisionalPositioning:p,inContextDrawMatchUps:t,unseededByePositions:m,multipleStructures:f,tournamentRecord:r,drawDefinition:a,seedBlockInfo:o,participants:s,matchUpsMap:c,structureId:h,structure:u,drawSize:g,event:I}),v.error?{error:v.error}:(v.conflicts&&(S.unseededConflicts=v.conflicts),U.push({action:"positionUnseededParticipants"}),{}))}({seedsOnly:d,inContextDrawMatchUps:y,tournamentRecord:o,appliedPolicies:g,validSeedBlocks:P,drawDefinition:t,seedBlockInfo:w,participants:D,matchUpsMap:v,structure:h,positionQualifiers:DU,positionUnseededParticipants:TU,provisionalPositioning:i,unseededByePositions:T,multipleStructures:n,structureId:c,drawSize:p,event:m,positioningReport:f,conflicts:b});if(M?.error)return OU(M.error,r);let{positionAssignments:R}=$d({drawDefinition:t,structure:h});return Ml({drawDefinition:t,structureIds:[c]}),r||zi(),{positionAssignments:R,conflicts:b,...ce,positioningReport:f}}function FU(e){let{applyPositioning:t=!0,provisionalPositioning:r,tournamentRecord:i,drawDefinition:n,seedingProfile:a,structureId:o,placeByes:s,seedsOnly:c}=e;if(!n)return{error:Pe};if(!sU({drawDefinition:n,structureId:o})&&!r)return{error:De};let u=nU({drawDefinition:n,structureId:o}).playoffStructures?.sort((e,t)=>Bd(e)-Bd(t)),d=[],l=[];if(u)for(let p of u){let{structureId:e}=p,o=kU({structureId:e,provisionalPositioning:r,applyPositioning:t,tournamentRecord:i,drawDefinition:n,seedingProfile:a,placeByes:s,seedsOnly:c});if(o.error)return o;o.positionAssignments&&d.push({positionAssignments:o.positionAssignments,structureId:e}),o.positioningReport&&l.push(o.positioningReport)}return{...ce,structurePositionAssignments:d,positioningReports:l}}function xU({validation:e=!0,tournamentRecord:t,drawDefinition:r,participantId:i,structureId:n,seedValue:a,event:o}){if(!r)return{error:ye};if(!n)return{error:Ze};let s=(t?.participants??[]).find(e=>e.participantId===i);if(t&&!s)return{error:dr};let{structure:c}=Vd({drawDefinition:r,structureId:n});if(!c)return{error:et};if(!(!e||E(a)||void 0===a||""===a||"string"==typeof a&&a.split("-").every(e=>E(e)&&I(e)>0)))return{error:gi};let{seedAssignments:u}=Wp({drawDefinition:r,structure:c}),d=u?.map(e=>e.seedNumber),l=u?.find(e=>e.participantId===i);if(l){let e="string"==typeof a?a.includes("-")&&a.split("-").map(e=>parseInt(e)).join("-")||parseInt(a)>0&&parseInt(a)||"":a&&a>0&&a||"";l.seedValue=e}else{let e={seedNumber:Math.max(0,...d||[])+1,participantId:i};a&&(e.seedValue=a),c.seedAssignments||(c.seedAssignments=[]),c.seedAssignments.push(e)}return Rl({tournamentId:t?.tournamentId,eventId:o?.eventId,drawDefinition:r,structure:c}),{...ce}}function _U({qualifyingParticipantId:e,tournamentRecord:t,drawDefinition:r,drawPosition:i,structureId:n}){return JI({positionActionName:"qualifierDrawPositionAssignment",participantId:e,isQualifierPosition:!0,tournamentRecord:t,drawDefinition:r,drawPosition:i,structureId:n})}function LU({targetRoundNumber:e,finishingPosition:t,drawDefinition:r,structureId:i,linkType:n}){let{links:a}=$f({drawDefinition:r,structureId:i})||{},o=(a?.target||[]).filter(({linkType:e})=>e===n).filter(({target:t})=>!e||e===t.roundNumber).map(e=>{let i=e.source.structureId,{structure:n}=Vd({structureId:i,drawDefinition:r});if(!t||n?.finishingPosition===t)return e}).filter(Boolean);return{sourceStructureIds:o.map(({source:e})=>e.structureId),relevantLinks:o}}function BU({targetRoundNumber:e=1,tournamentRecord:t,drawDefinition:r,event:i,randomList:n}){let a=$c({drawDefinition:r,event:i,tournamentRecord:t},[{[Xs]:!0,[bc]:!0,[Js]:!0}]);if(a.error)return a;let o=[],s=[],c=r.structures?.find(e=>e.stage===Ho&&1===e.stageSequence);if(!c)return Pn({result:{error:it}});let u=(up({tournamentRecord:t,drawDefinition:r,structure:c,event:i}).appliedPolicies??{})[ru]?.requireCompletedStructures,{qualifierPositions:d,positionAssignments:l}=qd({structure:c});if(!d.length)return Pn({result:{error:xr}});let p=K(0,d.length);n&&(p=((e,t)=>{let r=[...new Set(t.slice(0,e.length))],i=[...r].sort((e,t)=>e-t),n=new Set,a=[];r.forEach(t=>{let r=e.indexOf(t);if(-1===r||n.has(r)){let r=i.indexOf(t),o=e.findIndex((e,t)=>!n.has(t));for(;n.has(o)&&-1===o&&n.size<e.length;)o=e.findIndex((e,t)=>!n.has(t)&&t>o);a.push(r),n.add(r)}else a.push(r),n.add(r)});let o=e.filter((e,t)=>!n.has(t));return[...a,...o]})(p,n));let m=l.map(e=>e.participantId).filter(Boolean),{relevantLinks:f}=LU({structureId:c.structureId,targetRoundNumber:e,linkType:fs,drawDefinition:r})||{},{relevantLinks:h}=LU({structureId:c.structureId,targetRoundNumber:e,linkType:ms,drawDefinition:r})||{};for(let g of f){let e=r.structures?.find(e=>e.structureId===g.source.structureId);if(e?.stage!==Yo)continue;let t=sU({structureId:g.source.structureId,drawDefinition:r});if(!u||t){let t=e.qualifyingRoundNumber,{matchUps:r}=Bf({matchUpFilters:{...t&&{roundNumbers:[t]},isCollectionMatchUp:!1,hasWinningSide:!0},afterRecoveryTimes:!1,inContext:!0,structure:e});for(let e of r){let t="BYE"===e.matchUpStatus&&e.sides?.find(({participantId:e})=>e),r=e.sides.find(t=>t?.sideNumber===e.winningSide);if(r||t){let{participantId:e}=r||t||{};e&&!m.includes(e)&&s.push(e)}}}}for(let g of h){let e=r?.structures?.find(e=>e.structureId===g.source.structureId);if(e?.stage===Yo&&sU({structureId:g.source.structureId,drawDefinition:r})){let{positionAssignments:t}=$d({structure:e}),r=t?.map(e=>{let t=e.participantId,r=Ru({element:e,name:Ju}).extension?.value;return r?{participantId:t,groupOrder:r?.groupOrder}:{}}).filter(({groupOrder:e,participantId:t})=>1===e&&!m.includes(t)).map(({participantId:e})=>e)??[];r&&s.push(...r)}}return s.length?(p.forEach((e,i)=>{let n=s[i],a=d[e].drawPosition;n&&_U({qualifyingParticipantId:n,structureId:c.structureId,drawPosition:a,tournamentRecord:t,drawDefinition:r})?.success&&o.push({participantId:n,drawPosition:a})}),Pn({result:wn({...ce,assignedParticipants:o})})):Pn({result:{error:Ur}})}function VU({drawDefinition:e,orderMap:t}){return e?(("object"!=typeof t||!Object.values(t).every(e=>F(e)))&&Pn({result:{error:gi},context:{orderMap:t}}),e.structures||(e.structures=[]),e.structures.forEach(e=>{let r=t[e.structureId];r&&(e.structureOrder=r)}),e.structures.sort((e,t)=>G(e.structureOrder)-G(t.structureOrder)),{...ce}):{error:ye}}function GU({drawDefinition:e}){let t=e.structures??[],r=e.links??[],i=new Map,n=e=>{let r=i.get(e)||i.set(e,{drawSources:[],drawTargets:[],progeny:[],sources:[],targets:[]})&&i.get(e);if(r&&!r?.stage){let i=t.find(t=>t.structureId===e);r.stage=i?.stage}return r},a={},o={},s=r.map(e=>{let t=e.source.structureId,r=e.target.structureId,i=n(t),s=n(r);return[ps,ls,ds,os].includes(e.target.feedProfile)?(i?.targets.push(r),s?.sources.push(t)):e.target.feedProfile===us&&(s?.drawSources.push(t),i?.drawTargets.push(r)),o[r]=o[r]||e.target.feedProfile===us,a[r]=L([...a[r]||[],t]).filter(Boolean),[e.source.structureId,e.target.structureId]});for(let h of i.keys()){let e=i.get(h);if(e){let t=e.targets??[];for(;t.length;){let r=t.pop(),n=r&&i[r];n?.targets?.length?t.push(...n.targets):n&&(e.rootStage=n.stage)}if(e.rootStage||(e.rootStage=e.stage),!e.targets?.length){let t=e.sources??[];for(;t.length;){let r=t.pop(),n=r&&i[r];if(n?.sources?.length){for(let t of n.sources)e.progeny?.includes(t)||e.progeny?.push(t);t.push(...n.sources)}}}}}let c=0;for(let h of i.keys()){let e=i.get(h);if(e&&e.rootStage===Yo){let t=[e.drawTargets?.[0]],r=0;for(;t.length;){r+=1;let e=t.pop(),n=e?i.get(e):void 0;n?.drawTargets?.length&&t.push(n.drawTargets[0])}e.distanceFromMain=r,r>c&&(c=r)}}let u=s.length;K(0,Math.ceil(u/2)).forEach(()=>{s=K(0,u).map(e=>{let t=s[e],r=s.reduce((e,r)=>Z(t,r)?e.concat(...r):e,[])||[];return L(t.concat(...r))})});let d=s[0],l=s.slice(1).reduce((e,t)=>e&&((e,t)=>Q(e,t).length===e.length)(t,d),!0),p=[d].filter(Boolean),m=[d].filter(Boolean);t.forEach(e=>{let{structureId:t,stage:r}=e;p.find(e=>e.includes(t))||(p.push([t]),r!==Ko&&m.push([t]))});let f=l&&1===m.length;return!r?.length&&1===t.length&&n(t[0].structureId),{structureProfiles:Object.fromEntries(i),allStructuresLinked:f,maxQualifyingDepth:c,sourceStructureIds:a,hasDrawFeedProfile:o,structureGroups:p}}function jU({drawDefinition:e}){let{maxQualifyingDepth:t,structureProfiles:r}=GU({drawDefinition:e});for(let i of e.structures){let e=r[i.structureId];e.distanceFromMain&&(i.stageSequence=t+1-e.distanceFromMain)}return{...ce}}function $U(e){let t=$c(e,[{[Js]:!0,[Xs]:!0}]);if(t.error)return t;let{tournamentRecord:r,drawDefinition:i,structure:n,link:a}=e;return function(e){let t=$c(e,[{[Xs]:!0,[gc]:!0},{link:!0,[_c]:Cc,[ue]:Qe}]);if(t.error)return t;let{drawDefinition:r,tournamentId:i,structure:n,eventId:a,link:o}=e,s=o.target.structureId,c=Vd({drawDefinition:r,structureId:s});if(c.error)return Pn({stack:"attachQualifyingStructure",context:{targetStructureId:s},result:c});r.structures||(r.structures=[]),r.links||(r.links=[]),r.structures.push(n),r.links.push(o),jU({drawDefinition:r});let u=Bf({structure:n})?.matchUps||[];return Pl({drawDefinition:r,tournamentId:i,matchUps:u,eventId:a}),Ml({drawDefinition:r,structureIds:[n.structureId]}),{...ce}}({tournamentId:r.tournamentId,drawDefinition:i,structure:n,link:a})}function qU({drawDefinition:e,structureDetails:t}){if(!Array.isArray(t))return{error:gi};if(!e)return{error:ye};let r=Object.assign({},...t.map(e=>{if(!v(e))return;let{structureId:t,structureName:r}=e||{};return t&&r?{[t]:r}:void 0}).filter(Boolean));if(!Object.values(r).length)return{error:$t};for(let i of e.structures||[]){let e=r[i.structureId];if(e&&(i.structureName=e),i.structures)for(let t of i.structures){let e=r[t.structureId];e&&(t.structureName=e)}}return{...ce}}function WU({drawDefinition:e,timeItem:t}){if(!e)return{error:Pe};if(!t)return{error:ri};let r=t&&Object.keys(t),i=["itemType","itemValue"];if(i.filter(e=>r.includes(e)).length!==i.length)return{error:ei};e.timeItems||(e.timeItems=[]);let n=(new Date).toISOString();return Object.assign(t,{createdAt:n}),e.timeItems.push(t),bl({drawDefinition:e}),{...ce}}function HU(e){let{tournamentRecord:t,drawDefinition:r,structureId:i,event:n}=e,a=$c(e,[{drawDefinition:!0,structureId:!0}]);if(a.error)return a;let o=r.structures??[],s=o.find(e=>e.structureId===i);if(!s)return{error:et};let c=o.find(({stage:e,stageSequence:t})=>e===Ho&&1===t),u=i===c?.structureId,d=o.filter(({stage:e})=>e===Yo).map(nh("structureId"));if(u&&!d.length)return{error:fe};let l=d.includes(i),p=function({isQualifyingStructure:e,tournamentRecord:t,drawDefinition:r,structureId:i,structure:n,event:a,force:o}){let s=[i];if(e){let e=e=>r.links?.find(t=>t.target.structureId===e),t=e(i)?.source.structureId;for(;t;)s.push(t),t=e(t)?.source.structureId}if(Kf({matchUpFilters:{structureIds:s},drawDefinition:r}).matchUps?.some(({score:e})=>ch({score:e}))){let e=up({tournamentRecord:t,drawDefinition:r,structure:n,event:a})?.appliedPolicies;if(!(o??e?.[du]?.allowDeletionWithScoresPresent?.structures))return{error:Ci}}return{...ce}}({isQualifyingStructure:l,structure:s,...e});if(p?.error)return p;let{structureIdsToRemove:m,relatedStructureIdsMap:f}=function({qualifyingStructureIds:e,isQualifyingStructure:t,isMainStageSequence1:r,mainStageSequence1:i,drawDefinition:n,structureId:a}){let o=(n.structures??[]).map(nh("structureId")),s=e=>n.links?.map(t=>t.source.structureId===e&&t.target.structureId!==i?.structureId&&t.target.structureId).filter(Boolean)??[],c=t=>n.links?.map(r=>e.includes(r.source.structureId)&&r.target.structureId===t&&r.source.structureId).filter(Boolean)??[],u=new Map;return o.forEach(e=>u.set(e,t?c(e):s(e))),{structureIdsToRemove:r?u.get(a):[a],relatedStructureIdsMap:u}}({qualifyingStructureIds:d,isQualifyingStructure:l,isMainStageSequence1:u,mainStageSequence1:c,drawDefinition:r,structureId:i}),{removedMatchUpIds:h,removedStructureIds:g}=function({relatedStructureIdsMap:e,qualifyingStructureIds:t,isMainStageSequence1:r,mainStageSequence1:i,drawDefinition:n,structureIdsToRemove:a,structureId:o}){let s=[],c=[];for(;a?.length;){let u=a.pop();c.push(...KU({idBeingRemoved:u,drawDefinition:n}));let d=zU({qualifyingStructureIds:t,isMainStageSequence1:r,idBeingRemoved:u,drawDefinition:n,structureId:o});s.push(...d.removedStructureIds);let l=YU({relatedStructureIdsMap:e,mainStageSequence1:i,idBeingRemoved:u,structureId:o});l?.length&&a.push(...l)}return{removedMatchUpIds:c,removedStructureIds:s}}({relatedStructureIdsMap:f,qualifyingStructureIds:d,isMainStageSequence1:u,mainStageSequence1:c,drawDefinition:r,structureIdsToRemove:m,structureId:i});if(function({removedMatchUpIds:e,drawDefinition:t}){let{matchUps:r}=Kf({drawDefinition:t});r?.forEach(t=>{t.winnerMatchUpId&&e.includes(t.winnerMatchUpId)&&delete t.winnerMatchUpId,t.loserMatchUpId&&e.includes(t.loserMatchUpId)&&delete t.loserMatchUpId})}({removedMatchUpIds:h,drawDefinition:r}),u){let e=(c.matchUps??[])?.map(nh("matchUpId"));h.push(...e),c.positionAssignments=[],c.seedAssignments=[],c.matchUps=[],c.extensions&&(c.extensions=[])}return l&&jU({drawDefinition:r}),Tl({tournamentId:t?.tournamentId,matchUpIds:h,action:"removeStructure",eventId:n?.eventId,drawDefinition:r}),Ml({drawDefinition:r,eventId:n?.eventId}),{...ce,removedMatchUpIds:h,removedStructureIds:g}}function YU({idBeingRemoved:e,relatedStructureIdsMap:t,mainStageSequence1:r,structureId:i}){return e&&t.get(e)?.filter(e=>e!==r?.structureId||i===r.structureId)}function zU({qualifyingStructureIds:e,isMainStageSequence1:t,idBeingRemoved:r,drawDefinition:i,structureId:n}){let a=[];return i.links=i.links?.filter(e=>e.source.structureId!==r&&e.target.structureId!==r)??[],(!t||t&&e.length||r!==n)&&(i.structures=(i.structures??[]).filter(e=>(r&&r===e.structureId&&a.push(r),e.structureId!==r))),{removedStructureIds:a}}function KU({idBeingRemoved:e,drawDefinition:t}){let{structure:r}=Vd({structureId:e,drawDefinition:t}),i=Bf({structure:r}).matchUps;return cd(i)}function JU({stageSequence:e=1,drawDefinition:t,drawSize:r,stage:i}){if(!t)return{error:ye};if(!jp({drawDefinition:t,stage:i}))return{error:mt};let n=function({stage:e,drawDefinition:t}){return Lp.reduce((r,i)=>($p({drawDefinition:t,entryStatus:i,stage:e})||0)+r,0)}({drawDefinition:t,stage:i}),{qualifiersCount:a}=_g({drawDefinition:t,stageSequence:e,stage:i});if(r<n+a)return{error:Be};let{entryProfile:o}=yp({attributes:[{[i]:{drawSize:r}}],drawDefinition:t});return Ml({drawDefinition:t}),{...ce,entryProfile:o}}function QU({qualifiersCount:e=0,drawDefinition:t,stage:r}){return t?jp({drawDefinition:t,stage:r})?r!==Ho?{error:Be,info:"qualifiersCount can only be set for main stage"}:(yp({attributes:[{[r]:{qualifiersCount:e}}],drawDefinition:t}),Ml({drawDefinition:t}),{...ce}):{error:mt}:{error:ye}}function XU(e){return function({drawDefinition:e,drawSize:t}){if(!e)return{error:ye};let r=JU({stage:Ko,stageSequence:1,drawDefinition:e,drawSize:t});return r.error?r:(Ml({drawDefinition:e}),{...ce})}(e)}function ZU({tournamentRecord:e,drawDefinition:t,event:r,structureId:i}){if(!t)return{error:ye};let n=t.structures?.find(e=>e.stage===Yo&&e.structureId===i);if(!n)return{error:et};if(n.matchUps?.some(({matchUpStatus:e,score:t})=>ch({score:t})??kd.includes(e)))return{error:Ci};let a=n.matchUps?.map(({matchUpId:e})=>e)||[];return n.positionAssignments=[],n.seedAssignments=[],n.matchUps=[],Tl({tournamentId:e?.tournamentId,action:"resetVoluntaryConsolationStructure",matchUpIds:a,drawDefinition:t}),Ml({tournamentId:e?.tournamentId,eventId:r?.eventId,drawDefinition:t,structureIds:[n.structureId]}),{...ce}}var eS="removeDrawPositionAssignment",tS="swapDrawPositionAssignments",rS="assignDrawPosition",iS="addPenalty",nS="MODIFY_PAIR",aS="QUALIFIER",oS="ALTERNATE",sS="WITHDRAW",cS="ASSIGN",uS="REMOVE",dS="LUCKY",lS="REMOVE_SEED",pS="SWAP",mS="NICKNAME",fS="SEED_VALUE",hS="PENALTY",gS={MODIFY_PAIR_ASSIGNMENT:nS,QUALIFYING_PARTICIPANT:aS,ALTERNATE_PARTICIPANT:oS,WITHDRAW_PARTICIPANT:sS,ASSIGN_PARTICIPANT:cS,LUCKY_PARTICIPANT:dS,REMOVE_ASSIGNMENT:uS,SWAP_PARTICIPANTS:pS,ADD_NICKNAME:mS,REMOVE_SEED:lS,ADD_PENALTY:hS,ASSIGN_BYE:"BYE",SEED_VALUE:fS};function IS({tournamentRecord:e,drawDefinition:t,drawPositions:r,structureId:i,event:n}){if(!t)return{error:ye};if(!i)return{error:Ze};if(2!==r?.length)return{error:gi,drawPositions:r};let a=Kp({drawDefinition:t}),{matchUps:o}=Kf({inContext:!0,drawDefinition:t,matchUpsMap:a}),{structure:s}=Vd({drawDefinition:t,structureId:i});if(!s)return{error:et};let c,u=up({tournamentRecord:e,drawDefinition:t,event:n}).appliedPolicies??{};if(c=s.structureType===cs?function({inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,drawPositions:i,matchUpsMap:n,structure:a,event:o}){let s=a.structures?.reduce((e,t)=>{let r=t?.positionAssignments.filter(e=>i?.includes(e.drawPosition));return r&&e.push(...r),e},[]);if(2===s.filter(({bye:e})=>e).length)return{...ce};if(2===s.filter(({qualifier:e})=>e).length)return{...ce};zI({inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,matchUpsMap:n,assignments:s,structure:a,event:o});let c=s.some(({qualifier:e})=>e);if(s.some(({bye:e})=>e)&&!c)US({inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,assignments:s,matchUpsMap:n,structure:a,event:o});else{let e=Wa(s,!1,!0);s.forEach((t,r)=>{let i=e[1-r].participantId;t.qualifier=e[1-r].qualifier,t.participantId=i})}return{...ce}}({inContextDrawMatchUps:o,tournamentRecord:e,drawDefinition:t,drawPositions:r,matchUpsMap:a,structure:s,event:n}):function({inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,drawPositions:i,matchUpsMap:n,structure:a,event:o}){let s=a?.positionAssignments.filter(e=>i?.includes(e.drawPosition));if(!s)return{error:gi,structure:a,info:"Missing positionAssignments"};if(2===s.filter(({bye:e})=>e).length)return{...ce};if(2===s.filter(({qualifier:e})=>e).length)return{...ce};let c=s.some(({qualifier:e})=>e);return s.some(({bye:e})=>e)&&!c?US({inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,assignments:s,matchUpsMap:n,structure:a,event:o}):function({inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,assignments:i,matchUpsMap:n,structure:a,event:o}){let s=Object.assign({},...i.map((e,t)=>{let{drawPosition:r}=e,n={...i[1-t],drawPosition:r};return{[r]:n}}));return a.positionAssignments=a.positionAssignments.map(e=>s[e.drawPosition]||e),zI({inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,matchUpsMap:n,assignments:i,structure:a,event:o}),{...ce}}({inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,assignments:s,matchUpsMap:n,structure:a,event:o})}({inContextDrawMatchUps:o,tournamentRecord:e,drawDefinition:t,drawPositions:r,matchUpsMap:a,structure:s,event:n}),c.error)return c;if(El({structure:s,drawPositions:r}),Cl({appliedPolicies:u,drawDefinition:t,positionAction:{name:tS,drawPositions:r,structureId:i}}),Nl({tournamentId:e?.tournamentId,drawDefinition:t,structure:s,event:n}),n.eventType===qo){let i=Bf({matchUpFilters:{matchUpTypes:[p]},inContext:!0,structure:s}).matchUps.filter(e=>e.drawPositions?.some(e=>r.includes(e))),a=Bf({matchUpFilters:{matchUpTypes:[p]},structure:s}).matchUps;i.forEach(i=>{(i.sides||[]).forEach(o=>{let s=o?.drawPosition;if(r.includes(s)){let r=o.participantId,c=a.find(({matchUpId:e})=>e===i.matchUpId),u=i?.sides?.reduce((e,t,r)=>t.drawPosition===s?r:e,void 0);_I({inContextTargetMatchUp:i,drawPositionSideIndex:u,teamParticipantId:r,tournamentRecord:e,drawDefinition:t,matchUp:c,event:n})}})})}return Ml({drawDefinition:t,structureIds:[i]}),{...ce}}function US({inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,assignments:i,matchUpsMap:n,structure:a,event:o}){let s=i.find(({bye:e})=>e),c=i.find(({participantId:e})=>e),u=s.drawPosition,{participantId:d,drawPosition:l}=c,{structureId:p}=a,m=pI({drawPosition:u,inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,structureId:p,matchUpsMap:n});return m.error||(m=pI({drawPosition:l,inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,structureId:p,matchUpsMap:n}),m.error)||(vh({drawPosition:l,tournamentRecord:t,drawDefinition:r,structureId:p,matchUpsMap:n,event:o}),m=KI({drawPosition:u,inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,structureId:p,participantId:d,matchUpsMap:n,event:o}),m.error)?m:{...ce}}function SS({tournamentRecord:e,drawDefinition:t,participantId:r,structureId:i}){let n="removeSeededParticipant";if(!e)return{error:Ie};if(!t)return{error:ye};let a=(t.structures??[]).find(e=>e.structureId===i);return a?!a.stage||![Ho,Yo].includes(a.stage)||a.stage===Ho&&1!==a.stageSequence?Pn({result:{error:Te},stack:n}):a.seedAssignments?.find(e=>e.participantId===r)?{...ce}:Pn({info:"participant not seeded",result:{error:wi},context:{participantId:r}}):Pn({result:{error:et},stack:n})}function vS({targetEntryRound:e=1,finishingPositions:t,sourceRoundNumber:r,sourceStructureId:i,targetStructureId:n,linkType:a=fs}){return i&&n?{link:wn({linkType:a,source:{roundNumber:r,structureId:i,finishingPositions:t},target:{feedProfile:us,roundNumber:e,structureId:n}})}:{error:Ze}}function yS({matchUp:e,tieFormat:t,isMock:r,uuids:i}){let{collectionDefinitions:n}=t??{};return{tieMatchUps:(n??[]).map(t=>wS({matchUp:e,collectionDefinition:t,uuids:i,isMock:r})).filter(Boolean).flat()}}function wS({collectionPositionOffset:e=0,collectionDefinition:t,matchUpsLimit:r,matchUp:i,isMock:n,uuids:a}){let{matchUpCount:o,matchUpType:s,collectionId:c,processCodes:u}=t||{},d=e=>{if(!n&&!i?.isMock)return a?.pop()??za();let r=t?.collectionId;return a?.pop()??`${i?.matchUpId}-${r}-TMU-${e+1}`};return K(0,r??o??0).map(t=>{let r=e+t+1;return{sides:[{sideNumber:1},{sideNumber:2}],matchUpId:d(t),matchUpStatus:Md,collectionPosition:r,collectionId:c,processCodes:u,matchUpType:s,isMock:n}})}function PS({roundPosition:e,roundNumber:t,idPrefix:r,uuids:i}){return r?`${r}-${t}-${e}`:i?.pop()||za()}function TS({includeMatchUpType:e,matchUpType:t,roundNumber:r,matchUps:i,idPrefix:n,isMock:a,uuids:o,nodes:s}){let c=0,u=[],d=1,l=r-1,p=s?.length;for(;c<(p||0);){let p=s?.[c],m=s?.[c+1];l&&(p.roundNumber=l),m&&l&&(m.roundNumber=l);let f={roundPosition:d,children:[p,m],matchUpId:PS({roundPosition:d,roundNumber:r,idPrefix:n,uuids:o})};u.push(f);let h={drawPositions:f.children.map(e=>e?.drawPosition).filter(Boolean),matchUpStatus:Md,matchUpId:f.matchUpId,roundPosition:d,roundNumber:r};e&&t&&(h.matchUpType=t),a&&(h.isMock=!0),i.push(h),d++,c+=2}return{roundNodes:u,matchUps:i}}function DS({finishingPositionOffset:e,finishingPositionLimit:t,qualifyingRoundNumber:r,qualifyingPositions:i,matchUpType:n,roundLimit:a,idPrefix:o,drawSize:s,isMock:c,uuids:u}){if(isNaN(s)||s<2||i&&s<=i)return{matchUps:[],roundsCount:0};if(i&&(!M(s)||s%i)){let e=i;for(;e<s;)e*=2;s=e}let d=i&&!(s%2)&&(!isNaN(i)||r&&!isNaN(r))&&(s/i===Math.round(s/i)||r&&s/r===Math.round(s/r));if(!M(s)&&!d)return{matchUps:[],roundsCount:0};let l,p=K(1,s+1).map(e=>({drawPosition:e})),m=[],f=1;for(({roundNodes:l,matchUps:m}=TS({matchUpType:n,roundNumber:f,idPrefix:o,matchUps:m,isMock:c,nodes:p,uuids:u})),f++,a=a??r;l.length>1;)i&&l.length===i&&(a=f-1),({roundNodes:l,matchUps:m}=TS({nodes:l,matchUpType:n,roundNumber:f,idPrefix:o,matchUps:m,isMock:c,uuids:u})),f++;let h=f-1;return m=ah({finishingPositionOffset:e,finishingPositionLimit:t,roundsCount:h,roundLimit:a,matchUps:m}),a?m=m.filter(e=>a&&(e.roundNumber??0)<=a):a=f-1,{drawSize:s,matchUps:m,roundsCount:h,roundLimit:a}}function bS(e){let t="generateQualifyingStructure",r=function(e,t){return e.drawDefinition?e.drawSize&&!F(e.drawSize)||e.participantsCount&&!F(e.participantsCount)||e.qualifyingPositions&&!F(e.qualifyingPositions)?Pn({result:{error:gi},stack:t}):e.drawSize?e.qualifyingPositions&&e.qualifyingPositions>=e.drawSize?Pn({result:{error:gi},context:{drawSize:e.drawSize,qualifyingPositions:e.qualifyingPositions},stack:t}):null:Pn({result:{error:Ve},context:{drawSize:e.drawSize},stack:t}):Pn({result:{error:ye},stack:t})}(e,t);if(r)return r;let i=e.drawSize??N(e.participantsCount),{hasExistingDrawDefinition:n,qualifyingRoundNumber:a,qualifyingPositions:o,targetStructureId:s,structureOptions:c,appliedPolicies:u,qualifyingOnly:d,drawDefinition:l,matchUpFormat:p,structureName:m,structureId:f,roundTarget:h,tieFormat:g,drawType:I,idPrefix:U,isMock:S,uuids:v}=e,y=function(e,t,r){let{structureProfiles:i}=GU({drawDefinition:e});return i[t]||Pn({result:{error:et},context:{targetStructureId:t},stack:r})}(l,s,t);if(y?.error)return y;let w,P,T,D,b,M=l.matchUpType,R=h?`${h}-`:"",A="object"==typeof y&&"stage"in y&&y.stage===Yo,E=u?.[au]?.namingConventions?.pre??om[au]?.namingConventions?.pre,C=A&&E?`${E}-`:"",O=m??(R?`${C}${II(Yo)} ${R}`:`${C}${II(Yo)}`);if(I===_s){let e=function(e){let{maxRoundNumber:t,structures:r,groupCount:i}=TI(e);return{qualifiersCount:i,roundLimit:t,structure:r[0],finishingPositions:[1]}}({structureName:m??O,structureId:f??v?.pop(),hasExistingDrawDefinition:n,stage:Yo,structureOptions:c,appliedPolicies:u,qualifyingOnly:d,stageSequence:1,matchUpType:M,roundTarget:h,tieFormat:g,idPrefix:U,drawSize:i,isMock:S,uuids:v});D=e.qualifiersCount,T=e.roundLimit,w=e.structure,b=e.finishingPositions}else{let e=function(e){let{drawSize:t,matchUps:r,roundLimit:i,roundsCount:n}=DS(e);i||(i=n);let a=hI({structureName:e.structureName,structureId:e.structureId,qualifyingRoundNumber:i,stage:Yo,matchUpFormat:e.matchUpFormat,stageSequence:e.stageSequence,matchUpType:e.matchUpType,roundLimit:i,matchUps:r});e.roundTarget&&Uu({extension:{name:Wu,value:e.roundTarget},element:a});let o=r?.filter(e=>e.roundNumber===i)?.length??0;return{drawSize:t,structure:a,matchUps:r,roundLimit:i,qualifiersCount:o}}({qualifyingRoundNumber:a,qualifyingPositions:o,matchUpType:M,idPrefix:U,drawSize:i,isMock:S,uuids:v,structureName:m??O,structureId:f??v?.pop(),matchUpFormat:p,stageSequence:1,roundTarget:h});i=e.drawSize,w=e.structure,T=e.roundLimit,D=e.qualifiersCount}let k=I===_s?ms:fs,x=w&&T&&vS({sourceStructureId:w.structureId,sourceRoundNumber:T,targetStructureId:s,finishingPositions:b,linkType:k})?.link;return g&&(P=Bf({structure:w})?.matchUps||[],P?.forEach(e=>{let{tieMatchUps:t}=yS({tieFormat:g,matchUp:e,isMock:S});Object.assign(e,{tieMatchUps:t,matchUpType:M})})),{qualifyingDrawPositionsCount:i,qualifiersCount:D,...ce,structure:w,link:x}}function MS(e){if(!e.tournamentRecord)return{error:Ie};let t=function(e){if(!e.drawDefinition)return{error:ye};if(!e.targetStructureId)return{error:Ze};let t=bS(e);if(t.error)return t;let{structure:r,link:i}=t;return r&&i?$U({tournamentRecord:e.tournamentRecord,drawDefinition:e.drawDefinition,structure:r,link:i}):{error:gi}}(e);return t.error,t}function RS(e){let t=$c(e,[{[Xs]:!0,[oc]:!0,[mc]:!0},{[ac]:!0,[kc]:e=>Number.isInteger(e)&&e>0},{[kc]:e=>Array.isArray(e)&&2===e.length&&e.every(S),[xc]:lr,participantIds:!0}]);if(t.error)return t;let{drawDefinition:r,structureId:i,tournamentRecord:n,event:a}=e,{structure:o}=Vd({drawDefinition:r,structureId:i});if(!o)return{error:et};if(!nm({structure:o}))return{error:Te};let s=(o?.matchUps??[]).filter(t=>t.roundNumber===e.roundNumber).filter(e=>!ch(e)).filter(t=>t.sides?.map(e=>e.participantId).some(t=>e.participantIds.includes(t)));if(2!==s.length)return{error:lr};for(let c of s){let t=c?.sides?.find(t=>e.participantIds.includes(t?.participantId));if(t){let i=e.participantIds.find(e=>e!==t?.participantId);t.participantId=i,Dl({tournamentId:n?.tournamentId,eventId:a?.eventId,drawDefinition:r,matchUp:c})}}return Ml({drawDefinition:r,structureIds:[i]}),{...ce}}function NS({includeMatchUpType:e,drawPosition:t,roundNumber:r,matchUpType:i,idPrefix:n,matchUps:a,isMock:o,uuids:s,nodes:c,fed:u}){let d=c.length,l=t?t-d:void 0,p=K(0,d).map(e=>l?l+e:void 0),m=[];for(let f=0;f<d;f++){let t=p.shift(),d={drawPosition:t,fed:u+1,feed:!0},l=c[f];l.roundNumber=r-1;let h=PS({roundPosition:l.roundPosition,roundNumber:r,idPrefix:n,uuids:s}),g={roundPosition:l.roundPosition,drawPositions:[t],matchUpStatus:Md,roundNumber:r,matchUpId:h};e&&(g.matchUpType=i),o&&(g.isMock=!0),a.push(g);let I={children:[l,d]};m.push(I)}return{roundNodes:m,matchUps:a,drawPosition:t?t-d:void 0}}function AS(e){let t=e.drawSize,{feedRoundsProfile:r,feedRounds:i=0,skipRounds:n=0,baseDrawSize:a}=e,{linkFedFinishingRoundNumbers:o,finishingPositionOffset:s,linkFedRoundNumbers:c,feedsFromFinal:u,isConsolation:d,matchUpType:l,idPrefix:p,isMock:m,uuids:f,fmlc:h}=e;a=a??function(e){let t=A(e);return t>e?t/2:t}(t);let g=function({drawSize:e}){let t=Math.ceil(Math.log(e)/Math.log(2));return K(0,t).reverse().map(e=>Math.pow(2,e))}({drawSize:a}),I=g.length,U=0;if(r?.length)U=r.reduce((e,t)=>e+t,0);else if(t){let e=t-a;r=g.filter(t=>t<=e&&(e-=t,!0)),U=r.reduce((e,t)=>e+t,0),i=r.length}else n>=I?i=0:u&&(i=I-u,n=0),r=g.filter((e,t)=>u&&!i||i&&t>=n+i||t<n?0:e),U=r.reduce((e,t)=>e+t,0),i=r.length;let S=[...g,...r].sort((e,t)=>t-e),v=S.length,y=[...(c??[]).map(e=>e-1),...(o??[]).map(e=>v-e)].map(e=>S[e]).reduce((e,t)=>e+t,0);U-=y;let w,P=0,T=[],D=1,b=K(0,a).map((e,t)=>({drawPosition:t+1+U})),M=U+1;for(let N of g){if(({roundNodes:w,matchUps:T}=TS({matchUpType:l,roundNumber:D,idPrefix:p,matchUps:T,isMock:m,nodes:b,uuids:f})),D++,r.includes(N)){let e=K(0,j(r)[N]),t=v+1-D,i=o?.includes(t)??c?.includes(D);e.forEach(()=>{({roundNodes:w,matchUps:T,drawPosition:M}=NS({drawPosition:!i&&M||void 0,nodes:w,matchUpType:l,roundNumber:D,idPrefix:p,matchUps:T,isMock:m,uuids:f,fed:P})),D++,P+=1})}b=w}v!==D-1&&console.log("ERROR"),T=ah({finishingPositionOffset:d?a-U:s,positionsFed:U,roundsCount:v,matchUps:T,fmlc:h});let R=w?.length?w[0]:w;return R&&(R.roundNumber=D-1,R.matchUps=T),{draw:R,matchUps:T,roundsCount:v}}function ES(e){let{finishingPositionOffset:t=0,addNameBaseToAttributeName:r,playoffStructureNameBase:i,finishingPositionNaming:n,finishingPositionLimit:a,playoffAttributes:o,stageSequence:s=1,exitProfile:c="0",exitProfileLimit:u,roundOffsetLimit:d,roundOffset:l=0,drawDefinition:p,staggeredEntry:m,sequenceLimit:f,stage:h=Ho,drawSize:g,idPrefix:I,isMock:U,uuids:S}=e;if(o&&u&&!o?.[c]||g<2||f&&s>f)return{};let v=[],y=[],w=[],P=e.matchUpType??p?.matchUpType,T=t+1,D=`${T}-${t+g}`,b=o?.[c],M=i&&`${i} `||"",R=o?.[D]??n?.[D],N=e.structureName||R?.name||b?.name&&(r?`${M}${b?.name}`:b.name)||`${M}${D}`,A=R?.abbreviation??b?.abbreviation,E=e.structureId??b?.structureId??S?.pop(),C={idPrefix:I&&`${I}-${N}-RP`,finishingPositionOffset:t,matchUpType:P,drawSize:g,isMock:U,uuids:S},{matchUps:O}=m?AS(C):DS(C),k=hI({structureAbbreviation:A,stageSequence:s,structureName:N,matchUpType:P,roundOffset:l,structureId:E,matchUps:O,stage:h});v.push(...O),y.push(k);let F=Math.ceil(Math.log(g)/Math.log(2)),x=d?Math.min(d-l,F):(!a||T<a)&&F||0;return g>2&&K(1,x+1).forEach(e=>function(e){let m=g/Math.pow(2,e);if(m<2)return;let U=g/Math.pow(2,e)+t;if(a&&U+1>a)return;let{structures:T,structureId:D,matchUps:b,links:M}=ES({finishingPositionOffset:U,exitProfile:`${c}-${e}`,roundOffset:l+e,stageSequence:s+1,drawSize:m,addNameBaseToAttributeName:r,playoffStructureNameBase:i,finishingPositionNaming:n,finishingPositionLimit:a,playoffAttributes:o,exitProfileLimit:u,roundOffsetLimit:d,drawDefinition:p,sequenceLimit:f,matchUpType:P,idPrefix:I,uuids:S,stage:h});if(k.structureId&&D){let t={linkType:hs,source:{roundNumber:e,structureId:k.structureId},target:{roundNumber:1,feedProfile:ls,structureId:D}};M&&k&&M.push(t),M?.length&&w.push(...M)}return T?.length&&y.push(...T),b?.length&&v.push(...b),{structureId:D,childLinks:M,structures:y}}(e)),{structureId:k.structureId,matchUps:v,structureName:N,structures:y,links:w,...ce}}function CS({drawDefinition:e,matchUpsMap:t,structureId:r}){let i=Vd({drawDefinition:e,structureId:r});if(i.error)return Pn({result:i});let{matchUps:n}=Bf({structure:i.structure,matchUpsMap:t});return{...em({matchUps:n}),matchUps:n,matchUpsMap:t}}function OS({finishingPositions:e,drawDefinition:t,structureId:r}){let{roundProfile:i}=CS({drawDefinition:t,structureId:r});return(i&&Object.keys(i))?.reduce((t,r)=>(kS(i?.[r]).forEach(i=>{e.forEach(e=>{(function({position:e,rangeDefinition:t}){if(!Array.isArray(t)||t.reduce((e,t)=>e||isNaN(t),!1))return!1;let[r,i]=t;return K(r,(i||r)+1).includes(e)})({position:e,rangeDefinition:i})&&(t[e]={roundNumber:r})})}),t),{})}function kS(e){return[L(e?.finishingPositionRange?.loser||[]),L(e?.finishingPositionRange?.winner||[])]}function FS(e){return kS(e).map(e=>K(e[0],e[1]&&e[1]+1||e[0]+1))}function xS({drawDefinition:e,structureIds:t,matchUpsMap:r}){if(t&&!Array.isArray(t))return{error:gi,context:{structureIds:t}};if(!e)return{error:ye};let i=(t=t??(e.structures??[]).filter(e=>e.stage!==Yo).map(({structureId:e})=>e)).map(t=>{let{roundProfile:i}=CS({drawDefinition:e,matchUpsMap:r,structureId:t});return(i&&Object.values(i))?.map(FS).flat()}).flat(),n=i.filter(e=>1===e?.length).sort(g).flat();return{positionsNotPlayedOff:L(i.flat()).filter(e=>!n.includes(e)),positionsPlayedOff:n}}function _S({excludeRoundNumbers:e=[],playoffPositions:t=[],drawDefinition:r,structureId:i}){if(!r)return{error:ye};if(!i)return{error:Ze};if(!t)return{error:$t,info:"missing playoffPositions"};let n=xS({drawDefinition:r});if(n.error)return n;let a=n.positionsPlayedOff,o=OS({finishingPositions:t.filter(e=>!a.includes(e)),drawDefinition:r,structureId:i}),s=Object.values(o).reduce((e,t)=>e.includes(t.roundNumber)?e:e.concat(t.roundNumber),[]).map(e=>I(e)).filter(t=>!e.includes(t)),c=OS({finishingPositions:a,drawDefinition:r,structureId:i}),u=c?Object.values(c):[],d=c?u.reduce((e,t)=>e.includes(t.roundNumber)?e:e.concat(t.roundNumber),[]).map(e=>I(e)):[],l=s.filter(e=>!d.includes(e)).sort(g),{roundProfile:p}=CS({drawDefinition:r,structureId:i}),m=l.map(e=>{let t=p?.[e].finishingPositionRange.loser,[r,i]=t??[0,0];return K(r,(i||r)+1)}).flat().sort(g),{playoffRoundsRanges:f}=function({playoffSourceRounds:e,roundProfile:t}){return{playoffRoundsRanges:e.map(e=>{let r=t[e].finishingPositionRange.loser,[i,n]=r,a=K(i,(n||i)+1);return{finishingPositionRange:r.join("-"),finishingPositions:a,roundNumber:e}})}}({playoffSourceRounds:l,roundProfile:p}),h=[...l,...d];return{playoffPositionsReturned:m,playedOffSourceRounds:d,playoffRoundsRanges:f,playoffSourceRounds:l,sourceRounds:h,roundProfile:p}}function LS({drawDefinition:e,structureId:t}){if(!e)return{error:ye};let{matchUps:r,matchUpsMap:i}=th({inContext:!0,drawDefinition:e}),{positionsNotPlayedOff:n,positionsPlayedOff:a}=xS({drawDefinition:e,matchUpsMap:i}),{structures:o}=Gd({drawDefinition:e}),s=o.filter(e=>!t&&e.stage!==Ko||e.structureId===t),c={};for(let u of s){let t=u?.structureId,i=BS({playoffPositions:n,drawDefinition:e,structure:u,matchUps:r}),{error:a,...o}=i;if(a)return i;c[t]={structureId:t,...o}}return t?{positionsPlayedOff:a,...c[t]}:{availablePlayoffProfiles:Object.values(c),availablePlayoffRounds:Object.values(c),positionsPlayedOff:a}}function BS({playoffPositions:e,drawDefinition:t,structure:r,matchUps:i}){let n=r?.structureId,{links:a}=$f({drawDefinition:t,structureId:n});if(r.structureType===cs||r.structures){let e=$d({structure:r})?.positionAssignments?.length,o=r.structures.length,s=(e??0)/o,c=a.source?.flatMap(({source:e})=>e?.finishingPositions||[])||[],u=K(1,s+1).filter(e=>!c.includes(e)),d=i.find(e=>e.containerStructureId===n&&e.finishingPositionRange)?.finishingPositionRange?.winner||[0,1],l=a?.source.map(({target:e})=>e.structureId),{positionsPlayedOff:p=[],positionsNotPlayedOff:m=[]}=xS({structureIds:l,drawDefinition:t}),f=new Set([...p,...m]),h=K(d[0],d[1]+1).filter(e=>!f.has(e)),g=re(h,h.length/u.length);return{positionsNotPlayedOff:h,playoffFinishingPositionRanges:u.map((e,t)=>{let r=g[t];return{finishingPosition:e,finishingPositions:r,finishingPositionRange:[Math.min(...r||[]),Math.max(...r||[])].join("-")}}),finishingPositionsAvailable:u,finishingPositionsPlayedOff:c,positionsPlayedOff:p,groupCount:o,groupSize:s}}let o=a?.source?.filter(e=>e.linkCondition!==gs).map(e=>e.source?.roundNumber)||[],s=a?.source?.filter(e=>e.linkCondition===gs).map(e=>e.source?.roundNumber)||[],c=_S({excludeRoundNumbers:o,playoffPositions:e,drawDefinition:t,structureId:n}),u=c?.playoffSourceRounds?[...c?.playoffSourceRounds||[]]:void 0,d=[...c?.playoffRoundsRanges||[]],{roundProfile:l,error:p}=c;for(let m of s){let e=a?.source.find(e=>e.source.roundNumber===m),t=e?.target.roundNumber,r=e?.target.structureId,n=i.filter(({roundNumber:e,structureId:i})=>i===r&&e===t),o=n.filter(({sides:e})=>e.find(e=>e.participantFed&&!e.participantId)).length;if(u&&o===n.length){u.push(m);let e=l?.[m]?.finishingPositionRange?.loser;if(e){let t=Math.min(...e),r=t+o,i=K(t,r),n={finishingPositionRange:[t,r-1].join("-"),finishingPositions:i,roundNumber:m};d.push(n)}}}return u&&u.sort(g),d.sort((e,t)=>e.roundNumber-t.roundNumber),{playoffRounds:u,playoffRoundsRanges:d,error:p}}function VS(e){let{finishingPositionOffset:t=0,playoffAttributes:r,stageSequence:i=1,staggeredEntry:n,structureName:a,stage:o=Ho,matchUpType:s,structureId:c,idPrefix:u,drawSize:d,isMock:l,uuids:p}=e,m={finishingPositionOffset:t,matchUpType:s,drawSize:d,idPrefix:u,isMock:l,uuids:p},{matchUps:f}=n?AS(m):DS(m),h=hI({structureName:a||r?.[0]?.name||II(Ho),structureId:c||p?.pop(),stageSequence:i,matchUpType:s,matchUps:f,stage:o}),g=[h],I=[];if(d>2){let i=d/2,{matchUps:n}=DS({finishingPositionOffset:t+i,idPrefix:u&&`${u}-c`,drawSize:i,matchUpType:s,isMock:l}),o=II(zo),c=r?.["0-1"]?.name??e.consolationStructureName??(a?`${a} ${o}`:o),m=hI({structureName:c,matchUps:n,structureId:p?.pop(),stage:zo,stageSequence:1,matchUpType:s});g.push(m);let f={linkType:hs,source:{roundNumber:1,structureId:h.structureId},target:{roundNumber:1,feedProfile:ls,structureId:m.structureId}};I.push(f)}return{...ce,structures:g,links:I}}function GS({consolationStructure:e,roundOffset:t=0,mainStructure:r,roundsCount:i,feedPolicy:n,fmlc:a}){let o=e.matchUps.reduce((e,t)=>(t.drawPositions||[]).filter(Boolean).length&&!e.includes(t.roundNumber)?e.concat(t.roundNumber):e,[]),s=n?.roundGroupedOrder||[],c=n?.roundFeedProfiles;return K(1+t,i+1+t).map(i=>{let n=c?.[i-1]?c[i-1]:i%2&&ls||ps,u=i-t<=2?i-t:2*(i-t-2)+2,d={linkType:hs,source:{roundNumber:i,structureId:r.structureId},target:{feedProfile:n,roundNumber:u,structureId:e.structureId}},l=s[i-1];return l&&(d.target.groupedOrder=l),$i()&&(d.source.structureName=r.structureName,d.target.structureName=e.structureName),2===i&&a&&(d.linkCondition=gs,d.target.feedProfile=ls),o.includes(u)?d:void 0}).filter(Boolean)}function jS(e){let{playoffStructureNameBase:t,finishingPositionOffset:r,stageSequence:i=1,playoffAttributes:n,structureNameMap:a,staggeredEntry:o,stage:s=Ho,matchUpType:c,structureId:u,drawSize:d,idPrefix:l,isMock:p,uuids:m}=e,f={finishingPositionOffset:r,matchUpType:c,drawSize:d,idPrefix:l,isMock:p,uuids:m},{matchUps:h,roundsCount:g}=o?AS(f):DS(f),I=e.structureName??n?.[0]?.name??II(Ho),U=fI({structureId:u||m?.pop(),structureName:I,stageSequence:i,matchUpType:c,matchUps:h,stage:s}),S=[U],v=[];if(d>2){let e=[0,2].slice(0,d/16).map((e,r)=>{let i=r+1,{consolationStructure:o}=function({playoffStructureNameBase:e,stageSequence:t=1,playoffAttributes:r,structureNameMap:i,roundOffset:n=0,matchUpType:a,structureId:o,idPrefix:s,drawSize:c,isMock:u,index:d,uuids:l}){let p=c/(2*Math.pow(2,n)),{matchUps:m,roundsCount:f}=AS({finishingPositionOffset:p,baseDrawSize:p,isConsolation:!0,feedRounds:1,matchUpType:a,idPrefix:s,isMock:u,uuids:l}),h=0===d&&r?.["0-1"]?.name||1===d&&r?.["0-3"]?.name||`${II(zo)} ${d+1}`,g=i?.[h]||h,I=e?`${e} ${g}`:g;return{consolationStructure:fI({matchUps:m,stage:zo,structureName:I,stageSequence:t,matchUpType:a,structureId:o}),consolationRoundsCount:f}}({idPrefix:l&&`${l}-c${r}`,structureId:m?.pop(),playoffStructureNameBase:t,playoffAttributes:n,structureNameMap:a,stageSequence:i,roundOffset:e,matchUpType:c,drawSize:d,isMock:p,index:r,uuids:m});return S.push(o),{consolationStructure:o,links:GS({consolationStructure:o,roundsCount:2,mainStructure:U,roundOffset:e})}}).map(e=>e.links).flat();if(v.push(...e),d>=4&&d<=16||d>32){let{matchUps:e}=DS({idPrefix:l&&`${l}-p3t4`,finishingPositionOffset:2,drawSize:2,matchUpType:c,isMock:p}),r=n?.["3-4"]?.name??II(Jo),i=a?.[r]||r,o=t?`${t} ${i}`:i,s=fI({structureId:m?.pop(),matchUps:e,stageSequence:2,stage:Jo,structureName:o,matchUpType:c}),u={linkType:hs,source:{roundNumber:g-1,structureId:U.structureId},target:{structureId:s.structureId,feedProfile:ls,roundNumber:1}};S.push(s),v.push(u)}}return{structures:S,links:v,...ce}}function $S(e){let{finishingPositionOffset:t,stageSequence:r=1,playoffAttributes:i,feedsFromFinal:n,staggeredEntry:a,structureName:o,stage:s=Ho,structureId:c,matchUpType:u,skipRounds:d,feedRounds:l,idPrefix:p,drawSize:m,isMock:f,uuids:h,fmlc:g}=e,I=e.feedPolicy||e.policyDefinitions?.[pu]||e.appliedPolicies?.[pu],U={finishingPositionOffset:t,matchUpType:u,skipRounds:d,drawSize:m,idPrefix:p,isMock:f,uuids:h},{matchUps:S}=a?AS(U):DS(U),v=hI({structureName:o||i?.[0]?.name||II(Ho),structureId:c||h?.pop(),stageSequence:r,matchUpType:u,matchUps:S,stage:s}),y=[v],w=[],P=m/2,{matchUps:T,roundsCount:D}=AS({finishingPositionOffset:P,idPrefix:p&&`${p}-c`,isConsolation:!0,feedsFromFinal:n,baseDrawSize:P,matchUpType:u,feedRounds:l,skipRounds:d,isMock:f,uuids:h,fmlc:g});if(m>2){let t=i?.["0-1"]?.name??II(zo),r=e.playoffStructureNameBase?`${e.playoffStructureNameBase} ${t}`:t,n=hI({matchUps:T,structureId:h?.pop(),stage:zo,stageSequence:1,structureName:r,matchUpType:u});y.push(n);let a=GS({consolationStructure:n,mainStructure:v,roundsCount:D,feedPolicy:I,fmlc:g});w.push(...a)}return{...ce,structures:y,links:w}}function qS({requireSequential:e=!0,playoffMatchUpFormat:t,playoffAttributes:r,sourceStructureId:i,policyDefinitions:n,stageSequence:a,drawDefinition:o,playoffGroups:s,matchUpType:c,feedPolicy:u,groupCount:d,idPrefix:l,isMock:p,uuids:m}){u=u||n?.[pu];let f="processPlayoffGroups",h=0,I=[],U=[],v=[],{error:y,positionRangeMap:w}=function({playoffGroups:e,drawDefinition:t,structureId:r}){if(!t)return{error:ye};if(!S(r)||!Array.isArray(e))return{error:gi};let i=e.map(({finishingPositions:e})=>e).flat();return{positionRangeMap:LS({drawDefinition:t,structureId:r}).playoffFinishingPositionRanges?.filter(e=>i.includes(e.finishingPosition))?.reduce((e,t)=>(e[t.finishingPosition]=t,e),{})}}({structureId:i,drawDefinition:o,playoffGroups:s});if(y)return Pn({result:{error:y},stack:f});if(w&&!s?.every(t=>{let{finishingPositions:r=[]}=t;if(!r.length)return!1;let i=[...r].sort(g).map((e,t)=>(r[t+1]||e)-e).every(e=>e<2);return(!e||i)&&r.every(e=>w[e])}))return Pn({context:{validFinishingPositions:Object.values(w)},result:{error:gi},stack:f});for(let g of s){let e=g.finishingPositions,o=w&&e.flatMap(e=>w[e]?.finishingPositions??[]),s=d*e.length,f=O(s),S=2===f&&ys||g.drawType||ys;o&&(h=Math.min(...o)-1);let y=o&&`${Math.min(...o)}-${Math.max(...o)}`,P=g.structureName||y&&g.playoffAttributes?.[y]?.name||g.playoffAttributes?.[0]?.name,T={addNameBaseToAttributeName:g.addNameBaseToAttributeName,playoffStructureNameBase:g.playoffStructureNameBase,finishingPositionNaming:g.finishingPositionNaming,finishingPositionLimit:g.finishingPositionLimit,structureId:g.structureId??m?.pop(),playoffAttributes:g.playoffAttributes,structureNameMap:g.structureNameMap,sequenceLimit:g.sequenceLimit,structureName:P,idPrefix:l&&`${l}-po`,appliedPolicies:n,finishingPositionOffset:h,stage:Jo,stageSequence:a,matchUpType:c,drawSize:f,isMock:p,uuids:m},D=({playoffStructures:t,playoffLinks:r})=>{let[n]=t,a=WS({playoffStructureId:n.structureId,finishingPositions:e,sourceStructureId:i});v.push(a,...r),U.push(...t),I.push({structureId:n.structureId,finishingPositions:e}),h+=s};if(S===ys){let{matchUps:r}=DS({finishingPositionLimit:h+s,idPrefix:l&&`${l}-po`,finishingPositionOffset:h,matchUpType:c,drawSize:f,isMock:p,uuids:m}),n=hI({structureId:g.structureId??m?.pop(),matchUpFormat:t,stage:Jo,structureName:P,stageSequence:a,matchUps:r});U.push(n);let o=WS({playoffStructureId:n.structureId,finishingPositions:e,sourceStructureId:i});v.push(o),h+=s,I.push({structureId:n.structureId,finishingPositions:e})}else if([Ss,vs,Jo].includes(S)){let t={playoffAttributes:g.playoffAttributes??r,playoffStructureNameBase:g.playoffStructureNameBase,structureId:g.structureId??m?.pop(),structureName:g.structureName,idPrefix:l&&`${l}-po`,addNameBaseToAttributeName:!0,finishingPositionOffset:h,stage:Jo,roundOffset:0,stageSequence:a,drawSize:f,isMock:p,uuids:m};S===Ss?Object.assign(t,{playoffAttributes:g?.playoffAttributes??r??Gs,roundOffsetLimit:3}):S===vs&&Object.assign(t,{playoffAttributes:g?.playoffAttributes??r??js,roundOffsetLimit:2});let n=ES(t);if(n.error)return n;if(n.links?.length&&v.push(...n.links),n.structures?.length&&U.push(...n.structures),U.sort(Ld),n.structureId){let t=WS({playoffStructureId:n.structureId,finishingPositions:e,sourceStructureId:i});v.push(t),I.push({structureId:n.structureId,finishingPositions:e})}h+=s}else if([Ps,xs,Os,Es,Ns,Fs].includes(S)){let t=[m?.pop(),m?.pop()],r={playoffStructureNameBase:g.playoffStructureNameBase,structureId:g.structureId??m?.pop(),playoffAttributes:g.playoffAttributes,idPrefix:l&&`${l}-po`,finishingPositionOffset:h,uuids:t,stage:Jo,structureName:P,matchUpType:c,feedPolicy:u,drawSize:f,isMock:p},n={[Ps]:{fmlc:!0,feedRounds:1},[Fs]:{feedRounds:1},[Os]:{feedsFromFinal:3},[Es]:{feedsFromFinal:2},[Ns]:{feedsFromFinal:1}};Object.assign(r,n[S]||{});let{structures:a,links:o}=$S(r),[d]=a,y=WS({playoffStructureId:d.structureId,finishingPositions:e,sourceStructureId:i});v.push(y,...o),U.push(...a),I.push({structureId:d.structureId,finishingPositions:e}),h+=s}else if([_s].includes(S)){let{structures:e,links:t}=TI({...T,structureOptions:g.structureOptions||{groupSize:4}});D({playoffStructures:e,playoffLinks:t})}else if([Ts].includes(S)){let{structures:e,links:t}=VS(T);D({playoffStructures:e,playoffLinks:t})}else if([Ms].includes(S)){let{structures:e,links:t}=jS(T);D({playoffStructures:e,playoffLinks:t})}else if([Is].includes(S)){D({playoffStructures:[hI({structureId:g.structureId??m?.pop(),structureName:g.structureName,finishingPosition:gp,stage:Jo,stageSequence:a,matchUps:[]})],playoffLinks:[]})}}return{finishingPositionTargets:I,positionRangeMap:w,structures:U,links:v}}function WS({playoffStructureId:e,finishingPositions:t,sourceStructureId:r}){return{linkType:ms,source:{structureId:r,finishingPositions:t},target:{structureId:e,feedProfile:us,roundNumber:1}}}function HS({positionAssignments:e,tournamentRecord:t,drawDefinition:r,matchUpFormat:i,matchUps:n,event:a}){if(!Zp(n))return{error:gi};if(!e)return{error:gi};let{policyDefinitions:o}=dp({policyTypes:[tu],tournamentRecord:t,drawDefinition:r,event:a}),{subOrderMap:s}=Ig({positionAssignments:e}),c=n.length?fg({policyDefinitions:o,matchUpFormat:i,subOrderMap:s,matchUps:n}):void 0;if(c?.error)return c;let{participantResults:u={},bracketComplete:d,report:l}=c??{},p=Object.keys(u);return e.forEach(e=>{let{participantId:t}=e;if(p.includes(t)){Uu({element:e,extension:{value:u[t],name:Ju}}),u[t].ties||gu({element:e,name:Ku})}else gu({element:e,name:Ju}),gu({element:e,name:Ku})}),Ml({drawDefinition:r}),{...ce,participantResults:u,bracketComplete:d,report:l}}function YS({matchUps:e,matchUpId:t}){return{matchUp:(e||[]).find(e=>e.matchUpId===t)}}function zS(e){let t=$c(e,[{[Xs]:!0,[mc]:!0}]);if(t.error)return t;let{tournamentParticipants:r,afterRecoveryTimes:i,contextProfile:n,drawDefinition:a,matchUpsMap:o,matchUpId:s,inContext:c,context:u,event:d}=e,{structures:l=[]}=Gd({drawDefinition:a}),p=e.contextContent||n&&Up({contextProfile:n,drawDefinition:a});for(let m of l){let{matchUps:e}=Bf({tournamentParticipants:r,afterRecoveryTimes:i,contextContent:p,drawDefinition:a,contextProfile:n,matchUpsMap:o,inContext:c,structure:m,context:u,event:d}),{matchUp:t}=YS({matchUps:e,matchUpId:s});if(t)return{matchUp:t,structure:m}}return{error:Nt}}function KS(e){return v(e)&&e.notes?v(e.element)&&(S(e.notes)||e.notes?.testing)?(Object.assign(e.element,{notes:e.notes}),{...ce}):{error:gi}:{error:$t}}function JS(e){return v(e)?v(e.element)?(e.element.notes&&delete e.element.notes,{...ce}):{error:gi}:{error:$t}}var QS={matchUpStatus:Md,matchUpStatusCodes:[],score:{scoreStringSide1:"",scoreStringSide2:"",sets:void 0},matchUpFormat:void 0,winningSide:void 0};function XS(e){let t,r="modifyMatchUpScore",i=e.matchUpFormat,n=e.matchUp,{matchUpStatusCodes:a,tournamentRecord:o,drawDefinition:s,matchUpStatus:c,removeScore:u,winningSide:d,matchUpId:l,event:p,notes:f,score:h}=e,g=e.appliedPolicies&&Object.keys(e.appliedPolicies).length?e.appliedPolicies:up({policyTypes:[du],tournamentRecord:o,drawDefinition:s,structure:t,event:p})?.appliedPolicies,I=n.matchUpType===m;if(I&&s){if(l&&n.matchUpId!==l){let e=zS({drawDefinition:s,matchUpId:l,event:p});if(!e.matchUp)return{error:Nt};({matchUp:n,structure:t}=e)}}else n.matchUpId!==l&&console.log("!!!!!");c&&[Rd,yd].includes(c)||u?Object.assign(n,{...QS}):h&&(n.score=h);let U,S=c&&n?.matchUpStatus===Sd&&c!==Sd;if(c&&(n.matchUpStatus=c),i&&(n.matchUpFormat=i),a&&(n.matchUpStatusCodes=a),d&&(n.winningSide=d),e.removeWinningSide&&(n.winningSide=void 0),!t&&s&&({structure:t}=zS({drawDefinition:s,matchUpId:l,event:p})),c&&!n.winningSide&&ch(n)&&!kd.includes(c)&&![hd,bd,Pd].includes(c)&&(n.matchUpStatus=wd),(S&&n?.processCodes?.length||c===Sd)&&(U=g?.[du]?.processCodes?.incompleteAssignmentsOnDefault),!n.collectionId){let e=t?.structureType===cs,a=nm({structure:t});if(im({drawDefinition:s,structure:t})||a||e){let c=(e=>{i=I?"SET1-S:T100":i??n.matchUpFormat??e?.matchUpFormat??s?.matchUpFormat??p?.matchUpFormat;let t=I?{matchUpTypes:[m]}:void 0,{matchUps:r}=Bf({afterRecoveryTimes:!1,tournamentRecord:o,inContext:!0,matchUpFilters:t,drawDefinition:s,structure:e,event:p});return a&&(e.positionAssignments=L(r.flatMap(e=>(e.sides??[]).map(e=>e.participantId)).filter(Boolean)).map(e=>({participantId:e}))),HS({positionAssignments:e.positionAssignments,tournamentRecord:o,drawDefinition:s,matchUpFormat:i,matchUps:r,event:p})})(e&&t.structures.find(e=>e?.matchUps.find(e=>e.matchUpId===l))||t);if(c.error)return Pn({result:c,stack:r})}}if(f){let e=KS({element:n,notes:f});if(e.error)return Pn({result:e,stack:r})}let v=o?.tournamentId,y=cn().topics.includes(vl),w=(y||U)&&Kp({drawDefinition:s}),P=w&&Kf({matchUpFilters:{matchUpIds:[l]},nextMatchUps:!0,tournamentRecord:o,inContext:!0,drawDefinition:s,matchUpsMap:w}).matchUps?.[0];if(y&&P&&function({tournamentId:e,inContextMatchUp:t}){t&&rn({payload:{inContextMatchUp:t,tournamentId:e},topic:vl,key:t.matchUpId})}({tournamentId:v,inContextMatchUp:P}),Array.isArray(U)&&P&&!P.sides?.every(({participantId:e})=>e))if(c===Sd)n.processCodes=L([...n.processCodes??[],...U]);else for(let m of U||[]){let e=m&&n?.processCodes?.lastIndexOf(m);n?.processCodes?.splice(e,1)}return Dl({eventId:p?.eventId,context:r,drawDefinition:s,tournamentId:v,matchUp:n}),{...ce}}function ZS(e){let{propagateExitStatus:t,matchUpStatusCodes:r,autoCalcDisabled:i,inContextMatchUp:n,matchUpStatus:a,dualMatchUp:o,structure:s,matchUp:c}=e,u=uh({matchUpStatus:a})||[gd,fd].includes(a)&&o||i,d=c?.sides?.map(e=>e.participantId).filter(Boolean).length||n?.sides?.map(e=>e.participantId).filter(Boolean).length,l="attemptToModifyScore";if(!(nm({structure:s})&&1===d||a===Sd&&d||function({structure:e,matchUp:t,inContextMatchUp:r}){let{drawPositions:i}=t,{positionAssignments:n}=qd({structure:e}),a=n?.filter(e=>i?.includes(e.drawPosition)&&e.participantId),o=r?.sides?.every(e=>e.participantId);return 2===a?.length||o}({structure:s,matchUp:c,inContextMatchUp:n})||!1===e.appliedPolicies?.[du]?.requireParticipantsForScoring||Sh(a)&&1===d&&t))return Pn({result:{error:lt},stack:l});let p=[Rd].includes(a),m=u?a:e.winningSide&&Id||Pd;return Pn({result:XS({...e,winningSide:e.winningSide,matchUpStatusCodes:u&&r||[],matchUpStatus:m,context:l,removeScore:p}),stack:l})}function ev({collectionGroups:e=[]}){let t=Object.assign({},...e.filter(e=>F(e?.groupValue)&&e?.groupNumber).map(e=>({[e.groupNumber]:{...e,allGroupMatchUpsCompleted:!0,matchUpsCount:0,sideWins:[0,0],values:[0,0]}})));return{groupValueGroups:t,groupValueNumbers:Object.keys(t).map(e=>I(e))}}function tv({collectionDefinition:e,groupValueNumbers:t,groupValueGroups:r,sideTieValues:i,tieMatchUps:n}){let a=n.filter(t=>t.collectionId===e.collectionId),o=[0,0],s=[0,0],c=a.every(e=>kd.includes(e.matchUpStatus)),{collectionValueProfiles:u,collectionGroupNumber:d,collectionValue:l,matchUpValue:p,winCriteria:m,scoreValue:f,setValue:h}=e,g=d&&t.includes(d),I=[0,0];if(a.forEach(e=>{e.winningSide&&(I[e.winningSide-1]+=1)}),F(p)?a.forEach(e=>{e.winningSide&&(o[e.winningSide-1]+=p)}):F(h)?a.forEach(e=>{e.score?.sets?.forEach(e=>{e.winningSide&&(o[e.winningSide-1]+=h)})}):F(f)?a.forEach(e=>{e.score?.sets?.forEach(t=>{let{side1TiebreakScore:r=0,side2TiebreakScore:i=0,side1Score:n=0,side2Score:a=0}=t;(e.matchUpStatus===Id||e.winningSide||t.winningSide)&&(n||a?(o[0]+=n,o[1]+=a):(r||i)&&t.winningSide&&(o[t.winningSide-1]+=1))})}):Array.isArray(u)&&a.forEach(t=>{if(t.winningSide){let r=t.collectionPosition,i=function({collectionDefinition:e,collectionPosition:t}){return(e.collectionValueProfiles||[])?.find(e=>e.collectionPosition===t)?.matchUpValue}({collectionDefinition:e,collectionPosition:r});F(i)&&(o[t.winningSide-1]+=i)}}),F(l)){let t;if(m?.aggregateValue)c&&(F(p||h||f)&&o[0]!==o[1]?t=o[0]>o[1]?1:2:I[0]!==I[1]&&(t=I[0]>I[1]?1:2));else if(m?.valueGoal)t=o.reduce((e,t,r)=>t>=m.valueGoal?r+1:e,0);else{let r=Math.floor(e.matchUpCount/2)+1;t=I.reduce((e,t,i)=>t>=r?i+1:e,0)}t&&(g?r[d].values[t-1]+=l:s[t-1]+=l)}else g?(r[d].values[0]+=o[0]||0,r[d].values[1]+=o[1]||0):s=o;g?(r[d].sideWins[0]+=I[0]||0,r[d].sideWins[1]+=I[1]||0,r[d].allGroupMatchUpsCompleted=r[d].allGroupMatchUpsCompleted&&c,r[d].matchUpsCount+=a.length):s.forEach((e,t)=>i[t]+=e||0)}function rv(e){let{sideAdjustments:t=[0,0],separator:r="-",drawDefinition:i,matchUpsMap:n,structure:a,matchUp:o,event:s}=e;if(!Array.isArray(t)||2!==t.length||Number.isNaN(t.reduce((e,t)=>e+t)))return{error:gi};if(!o)return{error:Et};let c=zp({matchUp:o,drawDefinition:i,structure:a,event:s})?.tieFormat||e?.tieFormat;if(!c)return{error:bt};let u=Ba({tieFormat:c});if(u.error)return u;let d=c?.collectionDefinitions||[],l=o?.tieMatchUps??[],p=[0,0],{groupValueGroups:m,groupValueNumbers:f}=ev(c);for(let v of d)tv({collectionDefinition:v,groupValueNumbers:f,groupValueGroups:m,sideTieValues:p,tieMatchUps:l});for(let v of f){let e,t=m[v],{allGroupMatchUpsCompleted:r,matchUpCount:i,winCriteria:n,groupValue:a,sideWins:o,values:s}=t;if(n?.aggregateValue)r&&s[0]!==s[1]&&(e=s[0]>s[1]?1:2);else if(n?.valueGoal)e=s.reduce((e,t,r)=>t>=n.valueGoal?r+1:e,void 0);else{let t=Math.floor(i/2)+1;e=o.reduce((e,r,i)=>r>=t?i+1:e,void 0)}e&&(p[e-1]+=a||0)}let h,g=p.map((e,r)=>(e||0)+t[r]),I={side1Score:g[0],side2Score:g[1],winningSide:void 0},U=g.join(r),S=g.slice().reverse().join(r);if(c?.winCriteria){let{valueGoal:e,aggregateValue:t,tallyDirectives:r}=c.winCriteria;if(e?h=g.map((e,t)=>({sideNumber:t+1,points:e})).find(({points:t})=>t>=e)?.sideNumber:t&&l.every(e=>e.matchUpStatus&&kd.includes(e.matchUpStatus)||e.winningSide)&&g[0]!==g[1]&&(h=g[0]>g[1]?1:2),!h&&r){let e=o.matchUpId,t=o.hasContext?o:n?.drawMatchUps?.[e]||i&&zS({inContext:!0,drawDefinition:i,matchUpId:e})?.matchUp;if(t){let{completedTieMatchUps:e,order:r}=fg({matchUps:[t]});if(e&&r?.length){let e=r[0].participantId;h=t.sides.find(({participantId:t})=>t===e)?.sideNumber}}}}return h&&(I.winningSide=h),{scoreStringSide1:U,scoreStringSide2:S,winningSide:h,set:I}}function iv({inContextDualMatchUp:e,drawDefinition:t,tournamentId:r,dualMatchUp:i,eventId:n}){if(i){e||(e=zS({matchUpId:i.matchUpId,inContext:!0,drawDefinition:t})?.matchUp);let{extension:a}=Ru({element:t,name:Vu}),o=Wa(a?.value||{},!1,!0),s=({displaySideNumber:e,drawPosition:t,sideNumber:r})=>({drawPosition:t,sideNumber:r,displaySideNumber:e});i.sides=e?.sides?.map(e=>{let t=e.participantId,r=t&&o[t]||void 0,{lineUp:n,...a}=i.sides?.find(({sideNumber:t})=>t===e.sideNumber)??{},c=n?.length?n:r;return{...s(e),...a,lineUp:c}}),Dl({context:"ensureSidLineUps",matchUp:i,drawDefinition:t,tournamentId:r,eventId:n})}}function nv(e){if(e)return Wa(e,!1,!0)}function av(e){let t=$c(e,[{[zs]:!0}]);return t.error?t:Object.keys(e.tournamentRecords).reduce((t,r)=>{t.tournamentIdMap[r]=[];let i=e.tournamentRecords[r].events??[],n=i.map(({eventId:e})=>e),a=i.map(e=>(e.drawDefinitions??[]).map(({drawId:e})=>e)).flat();return t.tournamentIdMap[r].push(...n,...a),t.eventIds.push(...n),t.drawIds.push(...a),t},{eventIds:[],drawIds:[],tournamentIdMap:{}})}function ov({tournamentRecords:e,eventId:t,drawId:r}){let{tournamentIdMap:i}=av({tournamentRecords:e});return(i?Object.keys(i):[]).find(e=>t&&i?.[e].includes(t)||r&&i?.[e].includes(r))}function sv(e){let{exitWhenNoValues:t,drawDefinition:r,matchUpStatus:i,removeScore:n,matchUpsMap:a,matchUpId:o,event:s}=e,c=e.tournamentRecords||e.tournamentRecord&&{[e.tournamentRecord?.tournamentId]:e.tournamentRecord}||{},u=e.tournamentId||e.tournamentRecord?.tournamentId;c&&ov({tournamentRecords:c,...e});let d=u&&c[u];if(!d)return{error:Ie};let l=zS({drawDefinition:r,event:s,matchUpId:o});if(l.error)return l;if(!l.matchUp)return{error:Nt};let{matchUp:p,structure:m}=l;if(!p.tieMatchUps)return{error:Ct};iv({tournamentId:d?.tournamentId,eventId:s?.eventId,dualMatchUp:p,drawDefinition:r});let{extension:f}=Ru({name:Ou,element:p});if(f?.value){if(!n)return{...ce,score:p.score};gu({element:p,name:Ou})}let h=zp({drawDefinition:r,structure:m,matchUp:p,event:s})?.tieFormat;p.tieFormat=nv(h);let g=rv({drawDefinition:r,matchUpsMap:a,structure:m,matchUp:p,event:s}),{winningSide:I,set:U,scoreStringSide1:S,scoreStringSide2:v}=g,y=U?.side1Score||U?.side2Score;if(t&&!p.score&&!y)return{...ce};let w,P={scoreStringSide1:S,scoreStringSide2:v,sets:U?[U]:[]},T=I&&[1,2].includes(I),D=T&&Id||lh({matchUpStatus:i??p.matchUpStatus,tieMatchUps:p.tieMatchUps,winningSide:p.winningSide,score:P})&&wd||Md,b=!(!p.winningSide||T),M=p.tieMatchUps.find(({score:e,winningSide:t,matchUpStatus:r})=>e?.sets?.length&&(e.sets[0].side1Score||e.sets[0].side2Score)||r&&kd.includes(r)||t);if(p.tieFormat&&!T&&!M){let e=zp({drawDefinition:r,structure:m,event:s})?.tieFormat;e&&JSON.stringify(h)===JSON.stringify(e)&&(p.tieFormatId=void 0,p.tieFormat=void 0,w=!0)}return XS({appliedPolicies:e.appliedPolicies,matchUpStatus:D,score:P,removeWinningSide:b,tournamentRecord:d,drawDefinition:r,removeScore:n,winningSide:I,matchUpId:o,matchUp:p,event:s}),{...ce,score:P,removeWinningSide:b,tieFormatRemoved:w,winningSide:I}}function cv(e){let t="directParticipants",r=ZS(e);if(r.error)return Pn({result:r,stack:t});let i,n=uh({matchUpStatus:e.matchUpStatus}),{dualWinningSideChange:a,inContextDrawMatchUps:o,projectedWinningSide:s,propagateExitStatus:c,matchUpStatusCodes:u,tournamentRecord:d,drawDefinition:l,matchUpStatus:p,dualMatchUp:m,matchUpsMap:f,winningSide:h,targetData:I,matchUpId:U,structure:S,matchUp:v,event:y}=e,w=!!v.collectionId,P=nm({structure:S}),T=v.drawPositions;if(w){let{matchUpTieId:r,matchUpsMap:n}=e,s=sv({appliedPolicies:e.appliedPolicies,matchUpId:r,tournamentRecord:d,drawDefinition:l,matchUpsMap:n,event:y});if(i=s&&{tieMatchUpResult:s},T=o.find(({matchUpId:e})=>e===r)?.drawPositions,!a)return Pn({result:{...ce,...i},stack:t})}if(P)return Pn({result:{...ce,...i},stack:t});if(T){let e=s?s-1:h-1,r=1-e,a=T[e],S=T[r],v={},{targetLinks:{loserTargetLink:w,winnerTargetLink:P,byeTargetLink:D},targetMatchUps:{winnerMatchUpDrawPositionIndex:b,loserMatchUpDrawPositionIndex:M,winnerMatchUp:R,loserMatchUp:N,byeMatchUp:A}}=I;if(R){let e=function({winnerMatchUpDrawPositionIndex:e,inContextDrawMatchUps:t,projectedWinningSide:r,sourceMatchUpStatus:i,winningDrawPosition:n,tournamentRecord:a,winnerTargetLink:o,sourceMatchUpId:s,drawDefinition:c,winnerMatchUp:u,dualMatchUp:d,matchUpsMap:l,event:p}){let m="directWinner";if(o){let r=u.drawPositions||[],d=r[e],f=o.source.structureId,h=Vd({structureId:f,drawDefinition:c});if(h.error)return h;let{structure:g}=h,{positionAssignments:I}=qd({structureId:f,drawDefinition:c}),U=I?.find(e=>e.drawPosition===n)?.participantId,S=o.target.structureId,{positionAssignments:v}=qd({structureId:S,drawDefinition:c}),y=v?.find(e=>e.participantId===U)?.drawPosition,w=v?.filter(e=>{let t=r.includes(e.drawPosition),i=!e.participantId&&!e.bye&&!e.qualifier;return t&&i}).map(e=>e.drawPosition),P=w?.includes(d);if(U&&1===o.target.roundNumber&&P)KI({drawPosition:d,participantId:U,structureId:S,inContextDrawMatchUps:t,sourceMatchUpStatus:i,tournamentRecord:a,drawDefinition:c,matchUpsMap:l,event:p});else if(U&&w?.length){let e=w.pop();e&&KI({participantId:U,structureId:S,inContextDrawMatchUps:t,sourceMatchUpStatus:i,tournamentRecord:a,drawDefinition:c,drawPosition:e,matchUpsMap:l,event:p})}else if(y){let e=jI({drawPosition:y,matchUpId:u.matchUpId,inContextDrawMatchUps:t,sourceMatchUpStatus:i,tournamentRecord:a,sourceMatchUpId:s,drawDefinition:c,matchUpsMap:l});if(e.error)return Pn({result:e,stack:m})}else if(g?.stage!==Yo){let e="winner target position unavaiallble";console.log(e),Pn({stack:m,result:{error:e}})}if(g?.seedAssignments&&g.structureId!==S){let e=g.seedAssignments.find(({participantId:e})=>e===U),t=e?.participantId;e&&t&&xI({eventId:u?.eventId,structureId:S,...e,tournamentRecord:a,drawDefinition:c,participantId:t})}}else{let e=jI({matchUpId:u.matchUpId,drawPosition:n,inContextDrawMatchUps:t,sourceMatchUpStatus:i,tournamentRecord:a,sourceMatchUpId:s,drawDefinition:c,matchUpsMap:l});if(e.error)return e}if(d&&r){let e=d.sides?.find(e=>e.sideNumber===r);if(e?.lineUp){let t=d.roundPosition,r=u.roundPosition,i=t===r&&1!==t||Math.floor(t/2)===r?2:1,n=l?.drawMatchUps?.find(({matchUpId:e})=>e===u.matchUpId),o=[1,2].map(e=>({...n.sides?.find(t=>t.sideNumber===e)||{},sideNumber:e}));n.sides=o;let s=n.sides.find(e=>e.sideNumber===i);if(s){let t=e.lineUp?.filter(e=>e?.participantId);s.lineUp=qI({lineUp:t}),Dl({tournamentId:a?.tournamentId,eventId:u?.eventId,matchUp:n,context:m,drawDefinition:c})}}}return{...ce}}({sourceMatchUpStatus:n&&p||Id,winnerMatchUpDrawPositionIndex:b,sourceMatchUpId:U,inContextDrawMatchUps:o,projectedWinningSide:s,winningDrawPosition:a,tournamentRecord:d,winnerTargetLink:P,drawDefinition:l,winnerMatchUp:R,dualMatchUp:m,matchUpsMap:f,event:y});if(e.error)return Pn({result:e,stack:t})}if(N){let e=function(e){let{loserMatchUpDrawPositionIndex:t,inContextDrawMatchUps:r,projectedWinningSide:i,propagateExitStatus:n,sourceMatchUpStatus:a,loserDrawPosition:o,tournamentRecord:s,loserTargetLink:c,drawDefinition:u,loserMatchUp:d,dualMatchUp:l,matchUpsMap:p,event:m}=e,f="directLoser",h=c.linkCondition,I=d.drawPositions||[],U=h===gs&&2===d.roundNumber&&Math.min(...I.filter(Boolean)),S=U||I[t],v=U||I[1-t],y=c.source.structureId,{structure:w}=Vd({structureId:y,drawDefinition:u}),{matchUps:P}=Bf({afterRecoveryTimes:!1,inContext:!0,drawDefinition:u,structure:w,event:m}),T=P.filter(e=>e.drawPositions?.includes(o)).filter(e=>{let t=e.sides.find(e=>e.drawPosition===o),r=e.matchUpStatus===Rd||e.matchUpStatus===Sd&&!ch(e);return t?.sideNumber===e.winningSide&&!r}),D=h===gs&&0===T.length,{positionAssignments:b}=qd({structureId:y,drawDefinition:u}),M=b?.find(e=>e.drawPosition===o)?.participantId,R={loserParticipantId:M},N=c.target.structureId,{positionAssignments:A}=qd({structureId:N,drawDefinition:u}),E=A?.filter(({drawPosition:e})=>I.includes(e)),C=E?.some(e=>e.participantId&&M&&e.participantId===M),O=n&&[Dd,Rd,Sd].includes(a||"");if(C)return{...ce,stack:f};let k=E?.filter(e=>{let t=I.includes(e.drawPosition),r=!e.participantId&&!e.bye&&!e.qualifier;return t&&r}).map(e=>e.drawPosition),F=k?.includes(S),x=c.target.roundNumber>1&&k?.length,_=1===c.target.roundNumber&&F;if(U){let e=function(){let e="loserLinkFedFMLC";return Pn(D?{result:B(),stack:e}:{result:L(),stack:e})}();if(e.context&&Object.assign(R,e.context),e.error)return Pn({result:e,stack:f})}else if(_){let e=B();if(e.context&&Object.assign(R,e.context),e.error)return Pn({result:e,stack:f})}else{if(!M||!x)return Pn({context:{loserDrawPosition:o,loserTargetLink:c,targetDrawPositionIsUnfilled:F},result:{error:F?Fe:ke},stack:f});{k.sort(g);let e=k[0],t=KI({participantId:M,structureId:N,drawPosition:e,inContextDrawMatchUps:r,sourceMatchUpStatus:a,tournamentRecord:s,drawDefinition:u,matchUpsMap:p,event:m});if(t.error)return Pn({result:t,stack:f});if(!t.error&&O&&n)return{stack:f,context:{progressExitStatus:!0,loserParticipantId:M}}}}if(w?.seedAssignments&&w.structureId!==N){let e=w.seedAssignments.find(({participantId:e})=>e===M),t=e?.participantId;e&&t&&xI({eventId:d?.eventId,structureId:N,...e,tournamentRecord:s,drawDefinition:u,participantId:t})}if(l&&i){let e=l.sides?.find(e=>e.sideNumber===3-i);if(e?.lineUp){let{roundNumber:t,eventId:r}=d,{roundPosition:i}=l,n=1===t?2-i%2:1,a=p?.drawMatchUps?.find(({matchUpId:e})=>e===d.matchUpId),o=[1,2].map(e=>({...a.sides?.find(t=>t.sideNumber===e)||{},sideNumber:e}));a.sides=o;let c=a.sides.find(e=>e.sideNumber===n);c&&(c.lineUp=qI({lineUp:e.lineUp}),Dl({tournamentId:s?.tournamentId,matchUp:a,context:f,drawDefinition:u,eventId:r}))}}return Pn({result:{...ce},stack:f,context:R});function L(){return Pn({result:vh({drawPosition:v,structureId:N,tournamentRecord:s,drawDefinition:u,event:m}),stack:"assignLoserPositionBye"})}function B(){let e=M?KI({drawPosition:S,participantId:M,structureId:N,inContextDrawMatchUps:r,sourceMatchUpStatus:a,tournamentRecord:s,drawDefinition:u,matchUpsMap:p,event:m}):{error:Ir};return!e.error&&O&&n?{stack:f,context:{progressExitStatus:!0}}:Pn({result:e,stack:"assignLoserDrawPosition"})}}({sourceMatchUpStatus:n&&p||Id,sourceMatchUpStatusCodes:u||[],sourceWinningSide:h,loserMatchUpDrawPositionIndex:M,sourceMatchUpId:U,inContextDrawMatchUps:o,projectedWinningSide:s,propagateExitStatus:c,loserDrawPosition:S,tournamentRecord:d,loserTargetLink:w,drawDefinition:l,loserMatchUp:N,winningSide:h,matchUpsMap:f,dualMatchUp:m,event:y});if(e.context?.progressExitStatus&&Object.assign(v,e.context,{sourceMatchUpStatus:n&&p||Id,sourceMatchUpStatusCodes:u||[],loserMatchUp:N,matchUpsMap:f}),e.error)return Pn({result:e,stack:t})}if(A){let e=A.drawPositions||[],r=vh({drawPosition:Math.min(...e.filter(Boolean)),structureId:D.target.structureId,tournamentRecord:d,drawDefinition:l,event:y});if(r.error)return Pn({result:r,stack:t})}return Pn({result:{...ce,...i},stack:t,context:v})}return Pn({result:{error:Ce},stack:t})}function uv(e){let t="genPlayoffStructure";if(!e.drawDefinition)return Pn({result:{error:ye},stack:t});let r=LS(e);if(r.error)return Pn({result:r,stack:t});let{structureId:i,addNameBaseToAttributeName:n,playoffStructureNameBase:a,finishingPositionNaming:o,finishingPositionLimit:s,playoffAttributes:c,playoffPositions:u,roundOffsetLimit:d,tournamentRecord:l,exitProfileLimit:f,roundProfiles:h,roundNumbers:g,idPrefix:U,isMock:S,event:v,uuids:y}=e,w=Wa(e.drawDefinition,!1,!0),{structure:P}=Vd({structureId:i,drawDefinition:w});if(!P)return Pn({result:{error:et},stack:t});if(P.structureType===cs||P.structures)return function(e){let t="generateAndPopulateRRplayoffStructures";if(!e.playoffGroups)return Pn({result:{error:$t},info:"playoffGroups required",stack:t});let{sourceStructureId:r,requireSequential:i,tournamentRecord:n,drawDefinition:a,playoffGroups:o,groupCount:s,groupSize:c,event:u}=e,d=qS({requireSequential:i,sourceStructureId:r,playoffGroups:o,groupCount:s,groupSize:c,...e});if(d.error)return Pn({result:d,stack:t});let{structures:l=[],links:m=[],finishingPositionTargets:f,positionRangeMap:h}=d,g=f?.flatMap(({finishingPositions:e})=>e).flatMap(e=>h[e].finishingPositions);a.structures.push(...l),a.links.push(...m);let{matchUps:I,matchUpsMap:U}=Kf({inContext:!0,drawDefinition:a}),S=new Set(l.map(({structureId:e})=>e)),v=I?.filter(({structureId:e})=>S.has(e)).map(ld),y=U?.drawMatchUps?.filter(({matchUpId:e})=>v?.includes(e));if(y?.length){let t=zp({drawDefinition:a,event:u})?.tieFormat;t&&y.forEach(r=>{let{tieMatchUps:i}=yS({isMock:e.isMock,tieFormat:t,matchUp:r});Object.assign(r,{tieMatchUps:i,matchUpType:p})})}let{positionAssignments:w}=$d({structureId:r,drawDefinition:a}),P={};w?.forEach(e=>{let t=Ru({element:e,name:Ju})?.extension?.value?.groupOrder;t&&(P[t]||(P[t]=[]),P[t].push(e.participantId))});let T=FU({provisionalPositioning:e.provisionalPositioning,structureId:r,applyPositioning:!0,event:e.event,tournamentRecord:n,drawDefinition:a});return T.error&&T.error?.code!==De.code?Pn({result:T,stack:t}):{structures:l,links:m,positionsPlayedOff:g,drawDefinition:a,...ce}}({sourceStructureId:P.structureId,...e,...r,drawDefinition:w});let{playoffRoundsRanges:T,playoffRounds:D}=r,{playoffPositionsReturned:b,error:M,playoffSourceRounds:R,playoffRoundsRanges:N}=_S(e);if(M)return Pn({result:{error:M},stack:t});let A=h?.length&&Object.assign({},...h),E=g||"object"==typeof h&&h.map(e=>Object.keys(e)).flat(),C=Array.isArray(E)&&E.map(e=>!isNaN(e)&&I(e)).filter(Boolean);if(C){if(!Array.isArray(C))return Pn({result:{error:gi},context:{validRoundNumbers:C},stack:t});C.forEach(e=>{if(!D?.includes(e))return Pn({result:{error:gi},context:{roundNumber:e},stack:t})})}u&&u.forEach(e=>{if(!b?.includes(e))return Pn({result:{error:gi},context:{playoffPosition:e},stack:t})});let O=C||R,k=C?T:N,F=[],x=[];for(let p of O??[]){let e=k?.find(e=>e.roundNumber===p);if(!e)return Pn({result:{error:gi},context:{roundNumber:p},stack:t});let r=e.finishingPositions.length,u=Math.min(...e.finishingPositions)-1,l=2,m=p&&A?.[p]&&l+A[p]-1,h=ES({exitProfile:`0-${p}`,addNameBaseToAttributeName:n,playoffStructureNameBase:a,finishingPositionOffset:u,playoffAttributes:c,exitProfileLimit:f,stage:Jo,roundOffset:0,drawDefinition:w,sequenceLimit:m,stageSequence:l,drawSize:r,idPrefix:U,isMock:S,uuids:y,finishingPositionNaming:o,finishingPositionLimit:s,roundOffsetLimit:d});if(h.error)return Pn({result:h,stack:t});let{structures:g,links:I}=h;if(g?.length&&F.push(...g),I?.length&&x.push(...I),h.structureId&&p){let e={linkType:hs,source:{structureId:i,roundNumber:p},target:{structureId:h.structureId,feedProfile:ls,roundNumber:1}};x.push(e)}}if(!F.length)return Pn({result:{error:gi},info:"No structures generated",stack:t});w.structures.push(...F),w.links.push(...x);let{matchUps:_,matchUpsMap:L}=Kf({inContext:!0,drawDefinition:w}),B=F.map(({structureId:e})=>e),V=_?.filter(({structureId:e})=>B.includes(e)).map(ld),G=L?.drawMatchUps?.filter(({matchUpId:e})=>V?.includes(e));if(G?.length){let e=zp({drawDefinition:w,event:v})?.tieFormat;e&&G.forEach(t=>{let{tieMatchUps:r}=yS({matchUp:t,tieFormat:e,isMock:S});Object.assign(t,{tieMatchUps:r,matchUpType:m})})}_?.filter(e=>Vf({matchUp:e})&&e.structureId===i)?.forEach(e=>{let{matchUpId:t,score:r,winningSide:i}=e,n=Wf({inContextDrawMatchUps:_,drawDefinition:w,matchUpId:t}),a=cv({inContextDrawMatchUps:_,tournamentRecord:l,drawDefinition:w,matchUpsMap:L,winningSide:i,targetData:n,matchUpId:t,structure:P,matchUp:e,score:r,event:v});a.error&&console.log(a.error)}),_?.filter(e=>"BYE"===e.matchUpStatus&&e.structureId===i)?.forEach(e=>{let{matchUpId:t}=e,r=Wf({inContextDrawMatchUps:_,drawDefinition:w,matchUpId:t}),{targetLinks:{loserTargetLink:i},targetMatchUps:{loserMatchUpDrawPositionIndex:n,loserMatchUp:a}}=r;if(i&&a){let e=i.target.structureId,t=vh({drawPosition:a.drawPositions[n],structureId:e,tournamentRecord:l,drawDefinition:w,event:v});t.error&&console.log(t.error)}});let j=[],$=oh({inContextDrawMatchUps:_,drawDefinition:w,matchUpsMap:L}).goesToMap,{structure:q}=Vd({drawDefinition:e.drawDefinition,structureId:i}),{matchUps:W}=Bf({structure:q});return W.forEach(r=>{let i=$?.loserMatchUpIds[r.matchUpId];if(i&&r.loserMatchUpId!==i){r.loserMatchUpId=i;let n={tournamentId:l?.tournamentId,eventId:e.event?.eventId,context:t,matchUp:r};j.push(n)}let n=$?.winnerMatchUpIds[r.matchUpId];if(n&&r.winnerMatchUpId!==n){r.winnerMatchUpId=n;let i={tournamentId:l?.tournamentId,eventId:e.event?.eventId,context:t,matchUp:r};j.push(i)}}),{structures:F,matchUpModifications:j,links:x,drawDefinition:w,...ce}}function dv({element:e}){if(!e)return{error:gi};if(!e.timeItems)return{};if(!Array.isArray(e.timeItems))return{error:gi};return e.timeItems.reduce((t="itemType",r="itemValue",(e,i)=>(i[t]&&(e[i[t]]=i[r]),e)),{});var t,r}function lv(e){let{duplicateValues:t=!0,creationTime:r=!0,removePriorValues:i,timeItem:n}=e;if(!n)return{error:ri};let a=Jl(e);if(a.error)return a;if(!(v(n)&&S(n.itemType)&&Object.keys(n).includes("itemValue")))return{error:ei};if(a.timeItems){if(function({element:e,duplicateValues:t,timeItem:r}){let{itemType:i,itemSubTypes:n,itemValue:a}=r,o=i&&Ql({itemSubTypes:n,itemType:i,element:e})?.timeItem;return o&&JSON.stringify(o?.itemValue)===JSON.stringify(a)&&!t}({element:a,duplicateValues:t,timeItem:n}))return{...ce}}else a.timeItems=[];if(n.itemSubTypes&&!n.itemSubTypes.length&&delete n.itemSubTypes,r){let e=(new Date).toISOString();Object.assign(n,{createdAt:e})}return i&&(a.timeItems=a.timeItems.filter(({itemType:e})=>n.itemType!==e)),i&&!n.itemValue||a.timeItems.push(n),{...ce}}function pv({creationTime:e=!0,removePriorValues:t,tournamentRecord:r,duplicateValues:i,participantId:n,timeItem:a}){if(!r)return{error:Ie};if(!n)return{error:Ir};let o=Kl({tournamentRecord:r,participantId:n});return o.error?o:lv({element:o.participant,removePriorValues:t,duplicateValues:i,creationTime:e,timeItem:a})}function mv(e){let{removePriorValues:t,tournamentRecord:r,duplicateValues:i,creationTime:n,timeItem:a}=e;if(!r)return{error:Ie};let o=lv({element:r,removePriorValues:t,duplicateValues:i,creationTime:n,timeItem:a});if(o.error)return o;let s=dv({element:r});return rn({payload:{parentOrganisation:r.parentOrganisation,tournamentId:r.tournamentId,timeItemValues:s},topic:dl}),o}function fv(e){let{removePriorValues:t,duplicateValues:r,creationTime:i,timeItem:n,event:a}=e;return a?lv({removePriorValues:t,duplicateValues:r,element:a,creationTime:i,timeItem:n}):{error:st}}function hv(e){return Iv({...e,itemType:"attachConsolationStructures"})}function gv(e){return Iv({...e,itemType:"attachPlayoffStructures"})}function Iv({itemType:e="attachStructures",matchUpModifications:t,tournamentRecord:r,drawDefinition:i,structures:n,links:a=[],event:o}){let s="attachStructures";if(!i)return{error:ye};if(!Array.isArray(n)||!Array.isArray(a))return Pn({result:{error:gi},stack:s});let c=e=>[e.source.structureId,e.source.roundNumber||e.source.finishingPositions?.join("|"),e.target.roundNumber].join("|"),u=i.links?.map(c);if(a.some(e=>{let t=c(e);return u?.includes(t)}))return Pn({result:{error:Ni},info:"playoff structure exists",stack:s});a.length&&i.links?.push(...a);let d=n.map(({structureId:e})=>e),l=i.structures?.map(({structureId:e})=>e);i.structures=(i.structures??[]).map(e=>d.includes(e.structureId)?n.find(({structureId:t})=>t===e.structureId):e);let p=n?.filter(({structureId:e})=>!l?.includes(e));p.length&&i.structures.push(...p),oh({drawDefinition:i});let m=n.map(e=>Bf({structure:e})?.matchUps||[]).flat();Pl({tournamentId:r?.tournamentId,eventId:o?.eventId,drawDefinition:i,matchUps:m});let f=n.map(({structureId:e})=>e);if(Ml({drawDefinition:i,structureIds:f}),t?.length){let e={};t.forEach(t=>{let r=t.matchUp?.matchUpId;r&&(e[r]=t)});let r=t=>{t.matchUps.forEach(t=>{if(e[t.matchUpId]){let{tieMatchUps:r,...i}=e[t.matchUpId].matchUp;if(Object.assign(t,i),r?.length){let i={};r.forEach(t=>e[t.matchUpId]=t),t.tieMatchUps.forEach(e=>Object.assign(e,i[e.matchUpId]))}e[t.matchUpId].matchUp=t,Dl(e[t.matchUpId])}})};i.structures.forEach(e=>{if(l?.includes(e.structureId))if(e.structures)for(let t of e.structures)r(t);else r(e)})}let h=p.map(nh("structureId"));if(r){lv({element:r,timeItem:{itemValue:{structureIds:f,drawId:i.drawId},itemType:e}})}return{...ce,addedStructureIds:h}}function Uv(e){let{structures:t,links:r,matchUpModifications:i,error:n}=uv(e);if(n)return{error:n};let a=e.drawDefinition;return gv({tournamentId:e.tournamentRecord?.tournamentId,eventId:e.event?.eventId||e.eventId,matchUpModifications:i,drawDefinition:a,structures:t,links:r})}function Sv(e){let t=$c(e,[{_anyOf:{[zs]:!1,[Js]:!1,[Xs]:!1,[bc]:!1},[Ks]:!0}]);if(t.error)return t;let r=[],i=e.drawDefinition??e.event??((e.tournamentId||!e.tournamentRecords)&&e.tournamentRecord);if(i){let t=vv(e,i);if(t.error)return t;r.push(...t?.applied??[]),e.drawDefinition&&Ml({drawDefinition:e.drawDefinition,tournamentId:e.tournamentId})}else{if(!e.tournamentRecords)return{error:Ie};{let t=Object.keys(e.tournamentRecords);if(!t.length)return{error:Ie};for(let i of t){let t=vv(e,e.tournamentRecords[i]);if(t.error)return t;r.push(...t?.applied??[])}}}return r.length?{...ce,applied:r}:{error:Lt}}function vv(e,t){let r=up(e).appliedPolicies??{};t.extensions||(t.extensions=[]);let i=[],n=Object.keys(e.policyDefinitions);if(!n.length)return{error:kt};for(let a of n)if(!r[a]||e.allowReplacement){let t=e.policyDefinitions[a];if(!t)continue;if(!v(t))return{error:gi};let{policyName:n,...o}=t;if(!o||!Object.keys(o).length||n&&!S(n))return{error:gi};r[a]=e.policyDefinitions[a],i.push(a)}return i?.length?{...Uu({element:t,extension:{name:Nu,value:r}}),applied:i}:{applied:i,error:Lt}}function yv({tournamentRecord:e,drawDefinition:t,flightProfile:r,drawName:i,drawId:n,event:a}){if(!i||"string"!=typeof i)return Pn({result:{error:gi},context:{drawName:i}});r||(r=Nf({event:a}).flightProfile);let o=r?.flights?.find(e=>e.drawId===n);if(o){o.drawName=i,yu({event:a,extension:{name:Lu,value:{...r,flights:r.flights}}})}return t&&(t.drawName=i,Ml({tournamentId:e?.tournamentId,drawDefinition:t})),o||t?{...ce,flight:o}:{error:ye}}function wv({tournamentRecord:e,drawDefinition:t,drawUpdates:r,drawId:i,event:n}){if(!v(r))return{error:gi};let a=Nf({event:n}).flightProfile,o=r.drawName&&yv({drawName:r.drawName,tournamentRecord:e,drawDefinition:t,flightProfile:a,drawId:i,event:n});if(o?.error)return o?.error;let s=o?.flight||a?.flights?.find(e=>e.drawId===i);if(!s&&!t)return{error:ye};if(s){yu({event:n,extension:{name:Lu,value:{...a,flights:a.flights}}})}return t&&(r.policyDefinitions&&Sv({policyDefinitions:r.policyDefinitions,drawDefinition:t}),Ml({tournamentId:e?.tournamentId,drawDefinition:t})),{...ce}}function Pv({tournamentRecord:e,removeScheduling:t,drawDefinition:r}){if(!r)return{error:ye};let i=Kp({drawDefinition:r}),n=e=>i?.drawMatchUps?.find(t=>t.matchUpId===e);for(let a of r.structures||[]){let{positionAssignments:o,stage:s,stageSequence:c}=a;o&&(1!==c||![Yo,Ho].includes(s))&&(a.positionAssignments=o.map(e=>(delete e.participantId,e)),a.seedAssignments=[]);let{matchUps:u,isRoundRobin:d}=Bf({afterRecoveryTimes:!1,inContext:!0,matchUpsMap:i,structure:a});for(let i of u){let{matchUpId:a,roundNumber:o}=i,s=i.sides||[],c=n(a);if(c){if(delete c.extensions,delete c.notes,"BYE"!==c.matchUpStatus&&Object.assign(c,QS),o&&o>1&&c.drawPositions?.length&&!d){let e=s?.map(({drawPosition:e,participantFed:t})=>!t&&e).filter(Boolean),t=c.drawPositions.map(t=>e.includes(t)?void 0:t);c.drawPositions=t}t?delete c.timeItems:c.timeItems?.length&&(c.timeItems=c.timeItems.filter(e=>e.itemType&&![Um,Sm,Im,Pm,ym,Tm].includes(e.itemType))),Dl({tournamentId:e?.tournamentId,context:"resetDrawDefiniton",drawDefinition:r,matchUp:c})}}}return r.extensions=r.extensions.filter(e=>e.name!==qu),Ml({drawDefinition:r,structureIds:(r.structures||[]).map(({structureId:e})=>e)}),{...ce}}function Tv({tournamentRecord:e}){if(!e)return{error:Ie};let t={positionsNoOutcomes:[],canBePruned:[],matchPlay:[],inactive:[],drawAnalysis:{}},r={};return(e.events?.flatMap(e=>{let t=e.eventId;return r[t]=e,(e?.drawDefinitions||[]).map(e=>({drawDefinition:e,eventId:t}))}).filter(Boolean)).forEach(({drawDefinition:e,eventId:i})=>{let n=0,a=0,o=0,{allStructuresLinked:s}=GU({drawDefinition:e}),c=r[i],u=(e?.structures||[]).map(t=>{let{stage:r,stageSequence:i,structureId:s}=t,u=Xo[r],{inContextStructureMatchUps:d}=ph({drawDefinition:e,structureId:s,structure:t,event:c}),l=d?.filter(({winningSide:e})=>e),p=l.filter(Boolean).length||0;a+=p,o+=d.length-a;let m=Math.max(l.filter(({roundNumber:e})=>1===e).map(({roundPosition:e})=>e)),{positionAssignments:f}=$d({structure:t}),h=f?.filter(({participantId:e})=>e);n+=h?.length??0;let g=(f?.length??0)-(h?.length??0),{roundMatchUps:I,roundProfile:U,roundNumbers:S,maxMatchUpsCount:v}=em({matchUps:d}),y=U&&Object.keys(U).filter(e=>!U[e].inactiveRound).map(e=>Number.parseInt(e)),w=U&&Object.keys(U).filter(e=>U[e].inactiveRound).map(e=>Number.parseInt(e)),P=U&&Object.values(U).every(e=>e.inactiveRound);return{positionsAssignedCount:h?.length??0,maxWinningSideFirstRoundPosition:m,unassignedPositionsCount:g,inactiveStructure:P,maxMatchUpsCount:v,inactiveRounds:w,roundMatchUps:I,activeRounds:y,roundNumbers:S,roundProfile:U,structureId:s,stageSequence:i,orderNumber:u,stage:r}}),d=u.find(e=>2===e.orderNumber&&1===e.stageSequence),l=u.filter(({inactiveStructure:e})=>!e).length,{links:p}=$f({structureId:d.structureId,drawDefinition:e}),m=1===I(d.activeRounds[0])&&1===d.activeRounds.length&&1===l,f=u?.every(({inactiveStructure:e})=>e),h=!p.length&&d.activeRounds.length&&(d.roundProfile[1].inactiveCount||d.inactiveRounds.length),g=e.drawId;n&&!a&&t.positionsNoOutcomes.push(g),f&&t.inactive.push(g),m&&t.matchPlay.push(g),h&&t.canBePruned.push(g);let U={matchUpsWithWinningSideCount:a,matchUpsNoOutcomeCount:o,positionsAssignedCount:n,allStructuresLinked:s,structuresData:u,inactiveDraw:f,isMatchPlay:m,drawId:g};t.drawAnalysis[g]=U}),{...ce,drawsAnalysis:t}}function Dv({matchPlayDrawPositions:e=!0,tournamentRecord:t,drawDefinition:r,drawId:i}){if(!t)return{error:Ie};if(!r)return{error:ye};let n=[],{drawsAnalysis:a}=Tv({tournamentRecord:t});if(a.canBePruned.includes(i)){let o=a.matchPlay.includes(i),s=a.drawAnalysis[i],{structures:[c]}=Gd({stageSequence:1,drawDefinition:r,stage:Ho}),u=s.structuresData.find(({structureId:e})=>c.structureId===e),d=(c.matchUps??[]).sort((e,t)=>e.roundPosition-t.roundPosition);n=d.filter(({roundNumber:e})=>!u.inactiveRounds.includes(e));let l=n.map(ld),p=d.map(ld).filter(e=>!l.includes(e));if(o){let t=n.filter(({roundNumber:e})=>!u.inactiveRounds.includes(e)).filter(({winningSide:e})=>e),r=t.map(ld),i=l.filter(e=>!r.includes(e));p.push(...i);let a=t.flatMap(e=>e.drawPositions??[]).filter(Boolean).flat(),o=Object.assign({},...a.map((e,t)=>({[e]:t+1})));if(t.forEach(t=>{e?t.drawPositions=t.drawPositions.map(e=>o[e]):delete t.drawPositions}),e){let e=c?.positionAssignments?.filter(e=>a.includes(e.drawPosition)).map(e=>(e.drawPosition=o[e.drawPosition],e));c.positionAssignments=e}else c.positionAssignments=[];c.matchUps=t,n=t}Tl({tournamentId:t?.tournamentId,matchUpIds:p,drawDefinition:r}),Ml({drawDefinition:r})}return{...ce,matchUps:n}}function bv({isPositionAction:e,tournamentRecord:t,drawDefinition:r,drawPosition:i,loserMatchUp:n,matchUpsMap:a,structureId:o,structure:s,event:c}){if(!r)return{error:ye};if(s||({structure:s}=Vd({drawDefinition:r,structureId:o})),!s)return{error:et};o||({structureId:o}=s);let u="assignDrawPositionQualifier";gh({method:u,color:"cyan",drawPosition:i}),a??=Kp({drawDefinition:r});let{positionAssignments:d}=$d({structure:s}),{activeDrawPositions:l}=ph({drawDefinition:r,structureId:o});if(d?.find(e=>e.drawPosition===i)?.qualifier)return{...ce};let p=!(!n||!a.drawMatchUps.some(e=>e.loserMatchUpId===n?.matchUpId&&Sh(e.matchUpStatus)));if(l?.includes(i)&&!p)return{error:Oe};let m=d?.find(e=>e.drawPosition===i);if(!m)return{error:Fe};let{containsQualifier:f,containsParticipant:h}=Uh(m);if(f)return{...ce};let g=up({tournamentRecord:t,drawDefinition:r,event:c}).appliedPolicies??{};return d?.forEach(e=>{e.drawPosition===i&&(e.qualifier=!0,p&&(e.participantId=void 0,console.log("oddity: invalid participantId on qualifier position cleared")))}),Nl({tournamentId:t?.tournamentId,drawDefinition:r,structure:s,event:c}),function({assignedParticipantId:e,isPositionAction:t,appliedPolicies:r,drawDefinition:i,drawPosition:n,structureId:a,stack:o}){return t&&Cl({appliedPolicies:r,drawDefinition:i,positionAction:{removedParticipantId:e,drawPosition:n,structureId:a,name:o}}),Pn({result:{...ce},stack:o})}({assignedParticipantId:h,isPositionAction:e,appliedPolicies:g,drawDefinition:r,drawPosition:i,structureId:o,stack:u})}function Mv({tournamentRecord:e,drawDefinition:t,participantId:r,drawPosition:i,structureId:n,qualifier:a,event:o,bye:s}){if(!t)return{error:ye};if(!i)return{error:xe};if(!n)return{error:Ze};if(s){let r=vh({tournamentRecord:e,drawDefinition:t,drawPosition:i,structureId:n,event:o});if(r.error)return r}else if(a){let r=bv({tournamentRecord:e,drawDefinition:t,drawPosition:i,structureId:n,event:o});if(r.error)return r}else{let a=KI({participantId:r,tournamentRecord:e,drawDefinition:t,drawPosition:i,structureId:n,event:o});if(a.error)return a}return{...ce}}function Rv(e){let t=e.matchUpIds??[],{drawDefinition:r}=e,i=e.structureId??r?.structures?.find(e=>e.matchUps?.some(({matchUpId:e})=>t.includes(e)))?.structureId??r?.structures?.[0]?.structureId;if(!i)return{error:et};let n=r.structures?.find(e=>e.structureId===i);if(!n)return{error:et};let a=n?.matchUps,o=a?.find(e=>!!e.roundPosition);if(n.structures||o||n.finishingPosition===qs)return{error:Te};let s=a.filter(({roundNumber:t})=>e.roundNumbers?.includes(t)).map(ld);return t=t.filter(e=>!s.includes(e)),e.roundNumbers&&!t.length&&(t=s),{existingMatchUps:a,matchUpIds:t,structureId:i,structure:n}}function Nv(e){let t=$c(e,[{[Xs]:!0},{[Bc]:{[cc]:!1,roundNumbers:!1},[xc]:gi,[_c]:Oc}]);if(t.error)return t;let{removeIncomplete:r=!1,removeUnAssigned:i=!0,removeCompleted:n=!1,tournamentRecord:a,drawDefinition:o,event:s}=e,c=Rv(e);if(c.error)return c;let{structure:u,structureId:d,existingMatchUps:l,matchUpIds:m}=c,f=[],h=l?.filter(({matchUpId:e,score:t,winningSide:a})=>{if(a&&!n)return!1;if(a||ch({score:t})){if(!a&&!r)return!1;f.push(e)}else if(!i)return!1;return m?.includes(e)})??[],g=h.map(ld),I=h.map(({tieMatchUps:e})=>e?.map(ld)).filter(Boolean).flat();if(g.length){u.matchUps=(u.matchUps??[]).filter(({matchUpId:e})=>!g.includes(e)),Tl({tournamentId:a?.tournamentId,matchUpIds:[...I,...g],action:"deleteAdHocMatchUps",eventId:s?.eventId,drawDefinition:o});let e=function(e,t=1){return Array.isArray(e)&&e.every(F)?K(Math.min(...e,t),Math.max(...e)+1).filter(t=>!e.includes(t)):[]}(L(u.matchUps.map(nh("roundNumber"))));if(e.length){e.reverse();for(let t of e)u.matchUps.forEach(e=>{e.roundNumber&&e.roundNumber>t&&(e.roundNumber-=1,Dl({tournamentId:a?.tournamentId,context:["adHoc round deletion"],eventId:s?.eventId,drawDefinition:o,matchUp:e}))})}if(f.length){u.positionAssignments=L(u.matchUps.flatMap(e=>(e.sides??[]).map(e=>e.participantId)).filter(Boolean)).map(e=>({participantId:e}));let e=u?.matchUpFormat??o?.matchUpFormat??s?.matchUpFormat,t=c.existingMatchUps.some(e=>e.matchUpType===p)?{matchUpTypes:[p]}:void 0,{matchUps:r}=Bf({afterRecoveryTimes:!1,inContext:!0,matchUpFilters:t,structure:u,event:s});nm({structure:u})&&(u.positionAssignments=L(r.flatMap(e=>(e.sides??[]).map(e=>e.participantId)).filter(Boolean)).map(e=>({participantId:e})));let i=HS({positionAssignments:u.positionAssignments,tournamentRecord:a,drawDefinition:o,matchUpFormat:e,matchUps:r,event:s});i.error&&console.log(i)}Ml({structureIds:[d],eventId:s?.eventId,drawDefinition:o})}return!g.length&&m.length?{error:Ci}:{...ce,deletedMatchUpsCount:[...g,...I].length}}function Av({removeCompletedMatchUps:e,tournamentRecord:t,drawDefinition:r,structureId:i,roundNumber:n,event:a}){if(!t)return{error:Ie};if(!r)return{error:ye};if(!n)return Pn({result:{error:$t},info:"roundNumber required"});let o=Vd({drawDefinition:r,structureId:i});if(o.error)return o;let s=o.structure;return s?.structures?{error:Te}:nm({structure:s})?function({removeCompletedMatchUps:e,drawDefinition:t,tournamentId:r,roundNumber:i,structure:n,eventId:a}){let o=n?.matchUps??[],s=[],c=[],u=!1;if(o.reduce((e,t)=>{let r=t?.roundNumber;return r?e.includes(r)?e:e.concat(r):e},[]).sort(g).includes(i)){let d=o.filter(t=>{let r=t.roundNumber===i&&(!kd.includes(t.matchUpStatus)||e);return r&&(c.push(t.matchUpId),t.tieMatchUps&&s.push(...t.tieMatchUps.map(ld))),!r});c.length&&(Tl({matchUpIds:[...s,...c],drawDefinition:t,tournamentId:r,eventId:a}),d.some(e=>e.roundNumber===i)||(d.forEach(e=>{e.roundNumber>i&&(e.roundNumber-=1,Dl({drawDefinition:t,tournamentId:r,eventId:a,matchUp:e}))}),u=!0),n.matchUps=d)}return{deletedMatchUpsCount:c.length,roundRemoved:u,...ce}}({tournamentId:t.tournamentId,removeCompletedMatchUps:e,eventId:a.eventId,drawDefinition:r,roundNumber:n,structure:s}):(console.log("not implemented"),{...ce})}function Ev(e){let{suppressNotifications:t,tournamentRecord:r,drawDefinition:i,matchUps:n,event:a}=e;if("object"!=typeof i)return{error:ye};let o=e?.structureId;if(!o&&1===i.structures?.length&&(o=i.structures?.[0]?.structureId),"string"!=typeof o)return{error:Ze};if(!Zp(n))return{error:gi,info:WI("matchUps")};let s=i.structures?.find(e=>e.structureId===o);if(!s)return{error:et};let c=(s?.matchUps).find(e=>!!e.roundPosition);if(s.structures||c||s.finishingPosition===qs)return{error:Te};if(Z(Xf({tournamentRecord:r,inContext:!1})?.matchUps?.map(ld)??[],n.map(ld)))return{error:Mi,info:"One or more matchUpIds already present in tournamentRecord"};s.matchUps.push(...n);let u=n.map(({tieMatchUps:e})=>e).filter(Boolean).flat();return t||(Pl({tournamentId:r?.tournamentId,matchUps:[...u,...n],eventId:a?.eventId,drawDefinition:i}),Ml({drawDefinition:i,structureIds:[o]})),{...ce}}function Cv({tournamentRecord:e,drawDefinition:t,drawPosition:r,structureId:i,subOrder:n,event:a}){if(!t)return{error:ye};if(!i)return{error:Ze};if(!r)return{error:xe};let{structure:o}=Vd({drawDefinition:t,structureId:i});if(!o)return{error:et};let s=o;o.structures&&o.structureType===cs&&(s=o.structures?.find(e=>e.positionAssignments?.find(e=>e.drawPosition===r)));let c=s?.positionAssignments,u=c?.find(e=>e.drawPosition===r);u&&Uu({element:u,extension:{name:Ku,value:n}});let d=(a?.eventType===m||t.matchUpType===m||(a?.tieFormat??t?.tieFormat??o?.tieFormat))&&{matchUpTypes:[m]},{matchUps:l}=Bf({structure:s,afterRecoveryTimes:!1,inContext:!0,matchUpFilters:d,event:a});return HS({positionAssignments:c,tournamentRecord:e,drawDefinition:t,matchUpFormat:o?.matchUpFormat??t.matchUpFormat,matchUps:l,event:a}),Ml({drawDefinition:t,structureIds:[i]}),{...ce}}var Ov={};function kv({excludedMatchUpStatuses:e=[],includeEventParticipants:t,includeQualifyingStage:r,finishingRoundLimit:i,policyDefinitions:n,roundNumberLimit:a,tournamentRecord:o,drawDefinition:s,matchUpsLimit:c,requirePlay:u,requireLoss:d,allEntries:l,winsLimit:p,event:m}){if(!s)return{error:ye};let f=[Ho,Jo];r&&f.push(Yo);let h=m?.eventType?{matchUpTypes:[m.eventType]}:void 0,g=s?.matchUpType?{matchUpTypes:[s.matchUpType]}:void 0,I=t&&m?Qf({contextFilters:{stages:f},matchUpFilters:h,tournamentRecord:o,inContext:!0,event:m})?.matchUps??[]:th({contextFilters:{stages:f},matchUpFilters:g,tournamentRecord:o,inContext:!0,drawDefinition:s})?.matchUps??[],U=qp({stage:Ko,drawDefinition:s}),S=new Set(U.map(({participantId:e})=>e)),v={},y={},w={},P={};n??=dp({policyTypes:[Zc],tournamentRecord:o,drawDefinition:s,event:m}).policyDefinitions;let T=n?.[Zc];e=e.length&&e||T?.excludedMatchUpStatuses||[],t=t??T?.includeEventParticipants,l=l??T?.allEntries,i=i??T?.finishingRoundLimit,a=a??T?.roundNumberLimit,c=c??T?.matchUpsLimit,u??=T?.requirePlay??!0,d??=T?.requireLoss??!0,p=p??T?.winsLimit;for(let A of I){if(u&&A.winningSide&&![1,2].includes(A.winningSide)&&A.matchUpStatus!==yd||A.finishingRound&&i&&A.finishingRound>=i||A.finishingRound&&a&&A.finishingRound<=a)continue;let t=A.sides?.find(({sideNumber:e})=>A.winningSide&&e===3-A.winningSide),r=A.sides?.find(({sideNumber:e})=>A.winningSide&&e===A.winningSide);if(A.sides?.forEach(t=>{let r=t?.participant?.participantId;r&&(w[r]=t.participant,A.matchUpStatus===yd&&!u&&(y[r]=t.participant,v[r]||(v[r]=0),(!A.matchUpStatus||!e.includes(A.matchUpStatus))&&(v[r]+=1)))}),t?.participant){let r=t.participant.participantId;y[r]=t.participant,v[r]||(v[r]=0),A.matchUpStatus&&!e.includes(A.matchUpStatus)&&(v[r]+=1)}if(r?.participant){let t=r.participant.participantId;P[t]||(P[t]=0),P[t]+=1,v[t]||(v[t]=0),A.matchUpStatus&&!e.includes(A.matchUpStatus)&&(v[t]+=1)}}let D,b=o?.participants&&!u&&!d&&l;D=t&&m?m.entries:s.entries;let M=b?(D??[]).filter(e=>![Fp,Cp].includes(e.entryStatus)).map(({participantId:e})=>e):[],R=Object.keys(y),N=b?(o?.participants??[]).filter(({participantId:e})=>M.includes(e)):d&&Object.values(y)||Object.values(w);return{eligibleParticipants:N.filter(e=>(e=>!d||R.includes(e))(e.participantId)&&(e=>!u||(v[e]||0)>=0)(e.participantId)&&(e=>!p||(P[e]||0)<=p)(e.participantId)&&(e=>!c||v[e]<=c)(e.participantId)&&(e=>!S.has(e))(e.participantId)).map(e=>({...e,individualParticipants:e.individualParticipantIds?.map(e=>o?.participants?.find(t=>t.participantId===e))})),losingParticipantIds:R,...ce}}function Fv(e){let t=$c(e,[{drawDefinition:!0}]);if(t.error)return t;let{drawDefinition:r,roundNumber:i}=e,n=e.structureId??(1===r.structures?.length&&r.structures?.[0]?.structureId);if("string"!=typeof n)return{error:Ze};let a=r.structures?.find(e=>e.structureId===n);if(!a)return{error:et};let o,s=(a.matchUps??[])?.reduce((e,t)=>(t.roundPosition&&(o=!0),(t?.roundNumber||0)>e?t.roundNumber:e),0);if(a.structures||o||a.finishingPosition===qs)return{error:Te};let c=r?.entries?.filter(e=>{let t=e.entryStatus;return Bp.includes(t)})??[],u=Math.floor(c?.length/2)||1,d=i??s??1,l=u-(a.matchUps?.filter(e=>e.roundNumber===d)?.length??0),p=l>0?l:0;return{...ce,availableMatchUpsCount:p,lastRoundNumber:s,roundMatchUpsCount:u}}function xv({drawDefinition:e}){let t=Ru({name:"participantRepresentatives",element:e});return t.error?t:{representativeParticipantIds:t.extension?.value||[]}}function _v({tournamentRecord:e,drawDefinition:t,stage:r=Ho,structureId:i,structure:n}){if(!e)return{error:Ie};if(!n&&!t)return{error:ye};if(!n&&!i&&1===t?.structures?.filter(e=>e.stage===r).length&&(n=t.structures.find(e=>e.stage===r)),!n&&!i)return{error:Ze};let{error:a,positionAssignments:o}=$d({drawDefinition:t,structureId:i,structure:n});return{positionAssignments:o??[],structureId:n?.structureId,error:a}}function Lv({dates:e=[],extension:t}){if(!t)return!1;if("boolean"==typeof t.value&&t.value)return!0;if(!e.length)return!1;let r=v(t.value)?t.value?.dates:void 0;return Array.isArray(r)?!!r?.length&&!!r.filter(t=>!e.length||e.includes(t)).length:void 0}function Bv({convertExtensions:e,ignoreDisabled:t,venue:r,court:i}){let n={...Wa(i,e,!0),venueId:r.venueId},{extension:a}=Ru({name:Cu,element:i});if(t&&a){let e=v(a.value)?a.value?.dates:void 0,t=!0===a?.value?[]:n.dateAvailability.map(t=>{let r=t.date;if(r&&!e.includes(r))return t}).filter(Boolean);n.dateAvailability=t}return function({inContextCourt:e,venue:t}){let{defaultStartTime:r,defaultEndTime:i,dateAvailability:n}=t;if(!(r||i||n?.length))return;let a=e.dateAvailability;a?.length?e.dateAvailability=a.map(e=>{let t=function({date:e,venueDateAvailability:t,defaultStartTime:r,defaultEndTime:i}){if(t?.length){if(e){let r=t.find(t=>t.date===e);if(r)return r}let r=t.find(e=>!e.date);if(r)return r}if(r||i)return{startTime:r,endTime:i}}({date:e.date,venueDateAvailability:n,defaultStartTime:r,defaultEndTime:i});if(!t)return e;let a=function(e,t){return e?t?e>t?e:t:e:t}(e.startTime,t.startTime),o=function(e,t){return e?t?e<t?e:t:e:t}(e.endTime,t.endTime),s=function(e,t){let r=[];return e?.length&&r.push(...e),t?.length&&r.push(...t),r}(e.bookings,t.bookings);return{...e,startTime:a,endTime:o,...s.length?{bookings:s}:{}}}):n?.length?e.dateAvailability=n.map(e=>({...e})):r&&i&&(e.dateAvailability=[{startTime:r,endTime:i}])}({inContextCourt:n,venue:r}),{inContextCourt:n}}function Vv(e,t,r){if(t.length&&!t.includes(e.venueId))return!1;if(r){let{extension:t}=Ru({name:Cu,element:e});if(t?.value)return!1}return!0}function Gv({venue:e,convertExtensions:t,ignoreDisabled:r,dates:i,uniqueVenueIds:n,venues:a,uniqueCourtIds:o,courts:s}){n.includes(e.venueId)||(a.push(Wa(e,t,!0)),n.push(e.venueId));for(let c of e.courts??[])if(!o.includes(c.courtId)){if(r){let{extension:e}=Ru({name:Cu,element:c});if(Lv({extension:e,dates:i}))continue}let{inContextCourt:n}=Bv({convertExtensions:t,ignoreDisabled:r,venue:e,court:c});s.push(n),o.push(c.courtId)}}function jv(e){let{convertExtensions:t,ignoreDisabled:r,venueIds:i=[],dates:n}=e,a=e.tournamentRecords||e.tournamentRecord&&{[e.tournamentRecord.tournamentId]:e.tournamentRecord}||{},o=[],s=[],c=[],u=[];return Object.keys(a).filter(t=>!e.tournamentId||t===e.tournamentId).forEach(e=>{let d=a[e];for(let a of d.venues??[])Vv(a,i,!!r)&&Gv({venue:a,convertExtensions:t,ignoreDisabled:r,dates:n,uniqueVenueIds:o,venues:u,uniqueCourtIds:s,courts:c})}),{courts:c,venues:u,...ce}}function $v({tournamentRecords:e,requireCourts:t,dates:r}){return"object"==typeof e&&Object.keys(e).length?Object.keys(e).reduce((i,n)=>{let a=e[n],{venues:o}=function({convertExtensions:e,tournamentRecord:t,ignoreDisabled:r,dates:i}){if(!t)return{error:ge};let n=Wa(t.venues??[],e).filter(e=>{if(!r)return e;let{extension:t}=Ru({name:Cu,element:e});return!t?.value&&e}).filter(Boolean),a=n.reduce((t,n)=>{let a=(n?.courts||[]).filter(e=>{if(!r&&!i?.length)return e;let{extension:t}=Ru({name:Cu,element:e});return Lv({extension:t,dates:i})}).filter(Boolean).map(t=>{let{inContextCourt:i}=Bv({convertExtensions:e,ignoreDisabled:r,venue:n,court:t});return i});return a.length?t.concat(a):t},[]);return{venues:n,courts:a}}({tournamentRecord:a,dates:r});return o?.forEach(e=>{let{venueId:r,courts:n}=e;(!t||n?.length)&&!i.venueIds.includes(r)&&(i.venues.push(e),i.venueIds.push(r))}),i},{venues:[],venueIds:[]}):{error:ge}}function qv({event:e}){return{eventInfo:(({eventId:e,eventName:t,eventType:r,eventLevel:i,surfaceCategory:n,matchUpFormat:a,category:o,gender:s,startDate:c,endDate:u,ballType:d,discipline:l,onlineResources:p,notes:m})=>({eventId:e,eventName:t,eventType:r,eventLevel:i,surfaceCategory:n,matchUpFormat:a,category:o,gender:s,startDate:c,endDate:u,ballType:d,discipline:l,onlineResources:p,notes:m}))(e)}}n(Ov,{addGoesTo:()=>oh,allPlayoffPositionsFilled:()=>cU,checkValidEntries:()=>$y,findDrawDefinition:()=>ry,getAssignedParticipantIds:()=>Nh,getAvailableMatchUpsCount:()=>Fv,getAvailablePlayoffProfiles:()=>LS,getDrawDefinitionTimeItem:()=>Xl,getDrawParticipantRepresentativeIds:()=>xv,getDrawStructures:()=>Gd,getDrawTypeCoercion:()=>Ly,getEligibleVoluntaryConsolationParticipants:()=>kv,getMatchUpsMap:()=>Kp,getParticipantIdFinishingPositions:()=>ey,getPositionAssignments:()=>_v,getPositionsPlayedOff:()=>xS,getRandomQualifierList:()=>By,getSeedingThresholds:()=>RI,getSeedsCount:()=>jy,getStructureSeedAssignments:()=>Wp,getTeamLineUp:()=>kf,getValidGroupSizes:()=>DI,isAdHoc:()=>nm,isCompletedStructure:()=>sU,isValidForQualifying:()=>Vy,positionActions:()=>_y});var Wv="tournamentImage",Hv={TOURNAMENT_IMAGE_RESOURCE_NAME:Wv,IN_PROGRESS:"IN_PROGRESS",ABANDONED:"ABANDONED",CANCELLED:"CANCELLED",COMPLETED:"COMPLETED",ACTIVE:"ACTIVE"},Yv={[ou]:{policyName:"Staff Privacy Policy",participant:{contacts:!1,individualParticipants:!1,individualParticipantIds:!1,onlineResources:!1,participantName:!0,participantOtherName:!0,participantId:!0,participantRole:!0,participantRoleResponsibilities:!0,participantStatus:!0,penalties:!1,representing:!0,participantType:!0,person:{addresses:!1,biographicalInformation:!1,birthDate:!1,contacts:!1,nationalityCode:!0,nativeFamilyName:!1,nativeGivenName:!1,onlineResources:!1,otherNames:!0,parentOrganisationId:!1,passportFamilyName:!1,passportGivenName:!1,personId:!1,personOtherIds:!1,previousNames:!1,sex:!1,standardFamilyName:!0,standardGivenName:!0,status:!1,tennisId:!1,wheelchair:!0}}}};function zv(e){let{tournamentRecord:t,withMatchUpStats:r,withStructureDetails:i,withVenueData:n}=e??{};if(!t)return{error:Ie};let a=(({tournamentId:e,tournamentRank:t,tournamentStatus:r,formalName:i,tournamentName:n,promotionalName:a,onlineResources:o,localTimeZone:s,activeDates:c,startDate:u,endDate:d,hostCountryCode:l,venues:p,notes:m,updatedAt:f})=>({tournamentId:e,tournamentRank:t,tournamentStatus:r,formalName:i,tournamentName:n,promotionalName:a,onlineResources:o,localTimeZone:s,activeDates:c,startDate:u,endDate:d,hostCountryCode:l,venues:p,notes:m,updatedAt:f}))(t),o=Ag({participantFilters:{participantRoles:[Jg,eI,Xg,Zg,rI]},policyDefinitions:Yv,tournamentRecord:t})?.participants??[];o&&(a.tournamentContacts=o);let s=t?.onlineResources?.find(e=>e.name===Wv&&"URL"===e.resourceType)?.identifier;s&&(a.imageUrl=s);let c=wg({tournamentRecord:t})?.publishState,u=c?.tournament?.status?.publishedEventIds||[],d=[];for(let m of t.events??[])if(!e?.usePublishState||u.includes(m.eventId)){let e=qv({event:m}).eventInfo;e&&d.push(e)}a.timeItemValues=dv({element:t}),a.publishState=c?.tournament,a.eventInfo=d;let l=[],p=[];if(r||i)for(let m of t.events??[])for(let e of m.drawDefinitions??[])for(let t of e.structures??[])p.push(...t.matchUps??[]),l.push(wn({eventId:m.eventId,eventName:m.eventName,eventType:m.eventType,drawId:e.drawId,drawName:e.drawName,drawType:e.drawType,structureId:t.structureId,structureName:t.structureName,stage:t.stage,stageSequence:t.stageSequence,positionAssignments:t.positionAssignments,seedAssignments:t.seedAssignments,matchUpFormat:t.matchUpFormat}));if(i&&(a.structures=l),r){let e=t.participants?.filter(e=>e.participantType===Vl).length??0,r=t.participants?.filter(e=>e.participantType===$l).length??0,i=t.events?.length??0,n=p?.filter(e=>"BYE"!==e.matchUpStatus),o=n?.length,s=n?.filter(e=>kd.includes(e.matchUpStatus)||e.winningSide)?.length,c=n?.filter(e=>ff({matchUp:e})?.scheduledDate||mf({matchUp:e})?.scheduledTime)?.length,u=o>0?Math.round(s/o*100):0;a.matchUpStats={total:o,completed:s,scheduled:c,percentComplete:u},a.individualParticipantCount=e,a.teamParticipantCount=r,a.eventCount=i}if(n){let{venues:e}=jv({tournamentRecord:t});a.venues=e??[]}return{tournamentInfo:Wa(wn(a),!1,!0),...ce}}function Kv({publishStatus:e,drawId:t}){return e?.drawDetails?e.drawDetails?.[t]?.publishingDetail?.published:!e?.drawIds||e.drawIds.includes(t)}var Jv="PUBLIC",Qv={PUBLIC_DISPLAY:Jv,ADMIN_DISPLAY:"ADMIN"};function Xv(e){let{tournamentParticipants:t=[],includePositionAssignments:r,policyDefinitions:i,tournamentRecord:n,inContext:a=!0,usePublishState:o,status:s=Gm,pressureRating:c,refreshResults:u,contextProfile:d,drawDefinition:l,noDeepCopy:m,sortConfig:f,context:h,event:g}=e;if(!l)return{error:ye};let{matchUpFormat:I,updatedAt:U,drawType:S,drawName:v,drawId:y}=l,w={matchUpFormat:I,updatedAt:U,drawName:v,drawType:S,drawId:y};w.display=Ru({element:l,name:Fu}).extension?.value;let P,T,D={},{allStructuresLinked:b,sourceStructureIds:M,hasDrawFeedProfile:R,structureGroups:N}=GU({drawDefinition:l});if(!b)return{error:nt};let A=e?.eventPublishState??wg({event:g}).publishState,E=e?.publishStatus??vg({event:g,status:s}),C=A?.status?.drawDetails?.[l.drawId],O=!!A?.status?.published,k=C?.structureDetails,F=!1,x=!1,_=N.map(s=>{let m={},I=s.map(e=>{let{structure:t}=Vd({drawDefinition:l,structureId:e}),{seedAssignments:r}=Wp({drawDefinition:l,structure:t});return t?.stage===Ho&&1===t.stageSequence&&(P=r),t?.stage===Yo&&(D[t.stageSequence??0]=r),t}).sort((e,t)=>Ld(e,t,f)).map(r=>{if(!r)return;let s=r?.structureId,f=[];r.stage&&[Ho,zo,Jo].includes(r.stage)&&(f=P),r?.stage===Yo&&(f=D[r.stageSequence??0]);let{matchUps:I,roundMatchUps:U,roundProfile:S}=Bf({seedAssignments:r?.seedAssignments?.length?void 0:f,context:{drawId:w.drawId,...h},hydrateParticipants:e.hydrateParticipants,participantsProfile:e.participantsProfile,tournamentParticipants:t,policyDefinitions:i,tournamentRecord:n,usePublishState:o,publishStatus:E,contextProfile:d,drawDefinition:l,inContext:a,structure:r,event:g}),{positionAssignments:v}=$d({structure:r}),y=v?.filter(nh(tc)).map(e=>{let t=Ru({element:e,name:Ju})?.extension?.value,{drawPosition:r,participantId:i}=e;return x=!0,{participantResult:t,participantId:i,drawPosition:r}});if(I.length&&(!y?.length&&e.allParticipantResults||u&&!r.structures)){let{subOrderMap:e}=Ig({positionAssignments:v}),t=I.some(e=>e.matchUpType===p)?I.filter(e=>e.matchUpType===p):I,n=fg({matchUpFormat:r.matchUpFormat,matchUps:t,policyDefinitions:i,pressureRating:c,subOrderMap:e});T=n?.report,y=v?.filter(nh(tc)).map(e=>{let{drawPosition:t,participantId:r}=e;return x=!0,{participantResult:r&&n?.participantResults?.[r],participantId:r,drawPosition:t}})}let b=r?{stageSequence:r.stageSequence,structureName:r.structureName,structureType:r.structureType,matchUpFormat:r.matchUpFormat,stage:r.stage}:{},N=Ru({element:r,name:Fu}).extension?.value;b.display=N?.[Jv]??N,b.sourceStructureIds=M[s],b.hasDrawFeedProfile=R[s],b.positionAssignments=v,b.structureActive=I.reduce((e,t)=>{let r=[yd,vd,wd,Id,gd,Sd,Dd,Rd].includes(t.matchUpStatus);return e||r||!!t.winningSide||!!t.score?.scoreStringSide1},!1);let A=I.every(e=>[...kd,"BYE"].includes(e.matchUpStatus));return b.structureCompleted=A,m[s]=A,b.structureActive&&(F=!0),{...b,participantResults:y,seedAssignments:f,roundMatchUps:U,roundProfile:S,structureId:s,report:T}});return I.forEach(e=>{r||delete e.positionAssignments,e.sourceStructuresComplete=e.sourceStructureIds?.every(e=>m[e])}),I}).flat().filter(e=>!o||k?.[e?.structureId]?.published||!0);return w.drawActive=F,w.participantPlacements=x,w.drawGenerated=_?.reduce((e,t)=>e||!!t?.roundMatchUps,!1),w.drawCompleted=_?.reduce((e,t)=>e&&t.structureCompleted,!0),w.drawPublished=o?O&&Kv({publishStatus:E,drawId:w.drawId}):void 0,{structures:!o||w.drawPublished?m&&_||Wa(_,!1,!0):void 0,drawInfo:m?w:Wa(w,!1,!0),...ce}}function Zv(e){let{includePositionAssignments:t,participantsProfile:r,policyDefinitions:i,usePublishState:n,status:a=Gm,contextProfile:o,sortConfig:s}=e,c=$c(e,[{tournamentRecord:!0},{[Lc]:{event:!1,eventId:!1}}]);if(c.error)return c;let u=Wa(e.tournamentRecord,!1,!0),d=null==e.event?Af({tournamentRecord:u,eventId:e.eventId}).event:void 0,l=e.event?Wa(e.event,!1,!0):d&&Wa(d,!1,!0)||void 0;if(!l)return{error:st};let{eventId:p}=l,{tournamentId:m,endDate:f}=u,h=vg({event:l,status:a}),g=wg({event:l}).publishState??{},I=!!g?.status?.published,{participants:U}=Ag({participantFilters:e.participantFilters,withGroupings:!0,withEvents:!1,withDraws:!1,policyDefinitions:i,...r,tournamentRecord:u}),S=l.drawDefinitions||[],v=!n||I?S.filter(({drawId:e})=>!n||Kv({publishStatus:h,drawId:e})).map(r=>(({drawInfo:e,structures:t})=>({...e,structures:t}))(Xv({allParticipantResults:e.allParticipantResults,hydrateParticipants:e.hydrateParticipants,context:{eventId:p,tournamentId:m,endDate:f},pressureRating:e.pressureRating,refreshResults:e.refreshResults,includePositionAssignments:t,tournamentParticipants:U,eventPublishState:g,noDeepCopy:!0,policyDefinitions:i,tournamentRecord:u,usePublishState:n,contextProfile:o,drawDefinition:r,publishStatus:h,sortConfig:s,event:l}))).map(({structures:e,...t})=>{let r=e?.filter(({stage:e,structureId:r})=>(({structureId:e,drawId:t})=>{if(!n)return!0;let r=h?.drawDetails?.[t]?.structureDetails;return!r||!Object.keys(r).length||r[e]?.published})({structureId:r,drawId:t.drawId})&&(({stage:e,drawId:t})=>{if(!n)return!0;let r=h?.drawDetails?.[t]?.stageDetails;return!r||!Object.keys(r).length||r[e]?.published})({stage:e,drawId:t.drawId})).map(e=>(({drawId:e,structure:t})=>{if(!n)return t;let r=h?.drawDetails?.[e]?.structureDetails?.[t.structureId]?.roundLimit;if(F(r)){let e=K(1,r+1),i={},n={};for(let r of e)t.roundMatchUps[r]&&(i[r]=t.roundMatchUps[r],n[r]=t.roundProfile[r]);t.roundMatchUps=i,t.roundProfile=n}return t})({drawId:t.drawId,structure:e}));return{...t,structures:r}}).filter(e=>e.structures?.length):void 0,y=(Array.isArray(u.venues)?u.venues:[]).map(e=>{let{venueData:t}=Rf({venueId:e.venueId,tournamentRecord:u});return{...t}}),w=(({eventId:e,eventName:t,eventType:r,eventLevel:i,surfaceCategory:n,matchUpFormat:a,category:o,gender:s,startDate:c,endDate:u,ballType:d,discipline:l})=>({eventId:e,eventName:t,eventType:r,eventLevel:i,surfaceCategory:n,matchUpFormat:a,category:o,gender:s,startDate:c,endDate:u,ballType:d,discipline:l}))(l);w.display=Ru({element:l,name:Fu}).extension?.value;let{tournamentInfo:P}=zv({tournamentRecord:u}),T={tournamentInfo:P,venuesData:y,eventInfo:w,drawsData:v};return T.eventInfo.publishState=g,T.eventInfo.published=g?.status?.published,{...ce,eventData:T,participants:U}}function ey({byeAdvancements:e=!1,tournamentRecord:t,drawDefinition:r,event:i}){if(!r)return{error:ye};let{participantIds:n,participantIdMatchUps:a}=function({tournamentParticipants:e,drawDefinition:t,event:r}){if(!t)return{error:ye};let i=Wa(Kf({tournamentParticipants:e,inContext:!0,drawDefinition:t,event:r}).matchUps,!1,!0),n=L(i.reduce((e,t)=>e.concat(...t.sides.map(e=>e.participantId).filter(Boolean)),[])),a=Object.assign({},...n.map(e=>{let t=i.filter(t=>t.sides.map(e=>e.participantId).filter(Boolean).includes(e));return{[e]:t}}));return{participantIds:n,participantIdMatchUps:a}}({tournamentParticipants:t?.participants,drawDefinition:r}),o=Object.values(a).some(e=>e.some(e=>e.containerStructureId)),s=(o&&Zv({tournamentRecord:t,event:i}))?.eventData?.drawsData?.find(e=>e.drawId===r.drawId)?.structures,c=r?.structures?.find(e=>e.stage===Ho&&1===e.stageSequence),u=c?.structureType===cs&&c.structures,d=(o?_v({tournamentRecord:t,drawDefinition:r,structureId:c?.structureId})?.positionAssignments:void 0)?.length||0,l=n?.map(t=>{let i=a[t].filter(e=>[Id,"BYE"].includes(e.matchUpStatus)||e.winningSide),n=i.map(i=>{let n=i.sides.find(e=>e.bye),a=i.sides.find(e=>e.participantId===t).sideNumber;if(i.containerStructureId){let e=function({containedStructures:e,drawPositionsCount:t,drawDataStructures:r,drawDefinition:i,participantId:n,matchUp:a}){let o=e?.find(e=>e.structureId===a.structureId)?.positionAssignments?.length,s=r.find(e=>e.structureId===a.containerStructureId)?.participantResults?.find(e=>e.participantId===n)?.participantResult,{ties:c,groupOrder:u,provisionalOrder:d}=s||{},l=e?.length,p=i.structure?.find(e=>e.stage===Jo);if($i()&&console.log({drawPositionsCount:t,provisionalOrder:d,bracketsCount:l,bracketSize:o,groupOrder:u,ties:c}),t===o&&u)return[u,u];if(l>1&&u&&!p)return[1,l];if(l>1&&u&&p){let e=i.links?.find(e=>e.source.structureId===a.containerStructureId)?.source?.finishingPositions,r=e.length*l;if(u in e)return[1,r];return[r+1,t-(o-u)*l]}}({containedStructures:u,drawPositionsCount:d,drawDataStructures:s,drawDefinition:r,participantId:t,matchUp:i});if(e)return e}return(i.winningSide||e&&n&&a)===a?i.finishingPositionRange.winner:i.finishingPositionRange.loser}),o=e=>Math.abs(e[0]-e[1]),c=n.reduce((e,t)=>e&&o(e)<o(t)?e:t,void 0);return{[t]:{finishingPositionRanges:n,finishingPositionRange:c,relevantMatchUps:i}}})||[];return Object.assign({},...l)}function ty({tournamentRecords:e,tournamentRecord:t,tournamentId:r,drawId:i}){if(!t&&!e)return{error:Ie};if(!i)return{error:Ge};if(!t&&e){if("string"!=typeof r&&!(r=ov({tournamentRecords:e,drawId:i})))return{error:Se};if(!(t=e[r]))return{error:Ie}}let n=t&&Af({tournamentRecord:t,drawId:i});return n?.drawDefinition?{drawDefinition:n.drawDefinition,event:n.event,tournamentRecord:t,...ce}:Pn({result:{error:Pe},stack:"findDrawDefinition"})}function ry(e){let{drawDefinition:t,error:r}=ty(e);return r?{error:r}:{drawDefinition:Wa(t)}}function iy({tournamentParticipants:e,returnParticipants:t,drawPosition:r,participant:i,drawId:n,event:a}){let o=a?.entries?.filter(({entryStatus:e})=>[Cp,Op].includes(e)).map(({participantId:e})=>e)||[];if(o.length){let a=i.individualParticipantIds,s=t?e.filter(({participantId:e})=>o.includes(e)):void 0,c=t?e.filter(({participantId:e})=>a.includes(e)):void 0;return{validModifyAssignedPairAction:wn({payload:{participantId:i.participantId,replacementIndividualParticipantId:void 0,existingIndividualParticipantId:void 0,drawPosition:r,drawId:n},method:"modifyPairAssignment",availableIndividualParticipantIds:o,availableIndividualParticipants:s,existingIndividualParticipantIds:a,existingIndividualParticipants:c,type:nS},!1,!1,!0)}}return{}}function ny(e){let{inContextDrawMatchUps:t,targetData:r,drawDefinition:i,relevantLink:n}=e;if(n?.linkCondition===gs&&"BYE"===r?.matchUp?.matchUpStatus)return!1;let{targetMatchUps:{loserMatchUp:a,winnerMatchUp:o},targetLinks:s}=r,c=a&&Wf({matchUpId:a.matchUpId,inContextDrawMatchUps:t,drawDefinition:i}),u=c?.targetMatchUps?.loserMatchUp,d=c?.targetMatchUps?.loserMatchUpDrawPositionIndex,l=u?.sides[d]?.participant,p=Sh(a?.matchUpStatus),m=p&&!l,f=a?.sides?.filter(e=>e?.participant).length??0,h=a?.winningSide&&p&&1===f,g=o?.drawPositions?.filter(Boolean).length||0;if(!h&&(a?.winningSide&&!m||o?.winningSide&&2===g&&(!o.feedRound||!Sh(o?.matchUpStatus))))return!0;let I=o&&Wf({matchUpId:o.matchUpId,inContextDrawMatchUps:t,drawDefinition:i}),U=c&&ny({relevantLink:s?.loserTargetLink,targetData:c,inContextDrawMatchUps:t,drawDefinition:i});return!!(I&&ny({targetData:I,inContextDrawMatchUps:t,drawDefinition:i})||U)}var ay={[ru]:{policyName:"positionActionsDefault",enabledStructures:[{stages:[Yo,Ho],stageSequences:[1],enabledActions:[],disabledActions:[]},{stages:[],stageSequences:[],enabledActions:[mS,hS,aS,fS],disabledActions:[]}],disbledStructures:[],otherFlightEntries:!1,activePositionOverrides:[]}},oy="positionAction",sy="matchUpAction";function cy({actionType:e=oy,appliedPolicies:t,drawDefinition:r,structure:i}){let n=e===oy&&ru||e===sy&&iu,a=e===oy&&ay||e===sy&&Wg,o=n&&(t?.[n]||a?.[n]),s=r.links?.filter(e=>e?.target?.structureId===i?.structureId)?.map(({target:e})=>e.feedProfile)??[],{enabledStructures:c,disabledStructures:u}=o||{},d=u?.find(e=>{let{stages:t,stageSequences:r,structureTypes:n,feedProfiles:a}=e;return(!a?.length||Array.isArray(a)&&a.some(e=>s.includes(e)))&&(!t?.length||Array.isArray(t)&&t?.includes(i?.stage))&&(!n?.length||Array.isArray(n)&&n?.includes(i?.structureType))&&(!r?.length||Array.isArray(r)&&r.includes(i?.stageSequence))});return{enabledStructures:c,actionsDisabled:d,actionsPolicy:o}}function uy({activePositionOverrides:e,activeDrawPositions:t,action:r}){return!(!r||!e.includes(r))||!t.length}function dy({enabledStructures:e,drawDefinition:t,structure:r}){if(!1===e)return{};if(!e?.length)return{policyActions:{enabledActions:[],disabledActions:[]}};let{stage:i,stageSequence:n,structureType:a}=r||{},o=t.links?.filter(e=>e?.target?.structureId===r?.structureId)?.map(({target:e})=>e.feedProfile)||[];return{policyActions:e.find(e=>{let{stages:t,stageSequences:r,structureTypes:s,feedProfiles:c}=e||{},u=!t?.length||Array.isArray(t)&&t.includes(i),d=!r?.length||Array.isArray(r)&&r.includes(n),l=!s?.length||Array.isArray(s)&&s.includes(a),p=!c?.length||Array.isArray(c)&&c.some(e=>o.includes(e));return d&&l&&p&&e&&u})}}function ly({action:e,policyActions:t}){let r=!t?.enabledActions||t?.disabledActions?.length&&t.disabledActions.includes(e);return!r&&((0===t?.enabledActions.length||t?.enabledActions.includes(e))&&!r)}var py="replaceTieMatchUpParticipantId",my="assignTieMatchUpParticipantId",fy="removeTieMatchUpParticipantId",hy="assignMatchUpSideParticipant",gy="substituteParticipant",Iy="REMOVE_SUBSTITUTION",Uy="REPLACE_PARTICIPANT",Sy="REMOVE_PARTICIPANT",vy="setMatchUpStatus",yy="SUBSTITUTION",wy="SCHEDULE",Py="REFEREE",Ty="STATUS",Dy="START",by="SCORE",My={REPLACE_TEAM_POSITION_METHOD:py,ASSIGN_TEAM_POSITION_METHOD:my,REMOVE_TEAM_POSITION_METHOD:fy,REPLACE_PARTICIPANT:Uy,SUBSTITUTION_METHOD:gy,REMOVE_SUBSTITUTION:Iy,REMOVE_PARTICIPANT:Sy,SCHEDULE_METHOD:vy,SUBSTITUTION:yy,SCHEDULE:wy,PENALTY:"PENALTY",REFEREE:Py,STATUS:Ty,SCORE:by,START:Dy,END:"END"};function Ry({tournamentParticipants:e=[],possiblyDisablingAction:t,activeDrawPositions:r,positionAssignments:i,returnParticipants:n,appliedPolicies:a,drawDefinition:o,drawPosition:s,validActions:c,structureId:u,structure:d,drawId:l,event:p}){if(r.includes(s))return{};let m=c.find(e=>e.type===cS)?.availableParticipantIds,f=a?.[ru]?.otherFlightEntries,h=a?.[ru]?.restrictQualifyingAlternates,g=(o.entries??[]).filter(({entryStage:e})=>!h||(d.stage===Yo?e===Yo:e!==Yo)).sort((e,t)=>(e.entryPosition??1/0)-(t.entryPosition??1/0)).map(({participantId:e})=>e).filter(Boolean),{allPositionedParticipantIds:I}=jd({drawDefinition:o}),U=i.map(e=>e.participantId).filter(Boolean),S=g.filter(e=>d.stage&&[Yo,Ho,Jo].includes(d.stage)?!I?.includes(e):!U.includes(e)),v=(p?.entries??[]).filter(e=>e.entryStatus===Pp&&Ny({restrictQualifyingAlternates:h,structure:d,entry:e})&&(d.stage&&[Yo,Ho,Jo].includes(d.stage)?!I?.includes(e.participantId):!U.includes(e.participantId))).sort((e,t)=>(e.entryPosition??1/0)-(t.entryPosition??1/0)).map(e=>e.participantId),y=L(S.concat(v));if(f){let e=(p?Nf({event:p}).flightProfile:void 0)?.flights?.filter(e=>e.drawId!==l).map(e=>e.drawEntries.filter(e=>e.participantId&&![Fp,Cp,Op].includes(e.entryStatus)&&!g.includes(e.participantId)).map(({participantId:e})=>e)).flat().filter(Boolean);e?.length&&y.push(...e)}m?.length&&(y=y.filter(e=>!m.includes(e)));let w=n?e?.filter(e=>y.includes(e.participantId)):void 0;return w?.forEach(e=>{let t=(o.entries??[]).find(t=>t.participantId===e.participantId);e.entryPosition=t?.entryPosition}),w?.sort((e,t)=>(e.entryPosition||1/0)-(t.entryPosition||1/0)),y.length?{validAlternatesAction:wn({payload:{drawId:l,structureId:u,drawPosition:s},willDisableLinks:t,method:"alternateDrawPositionAssignment",availableAlternatesParticipantIds:y,type:oS,availableAlternates:w})}:{}}function Ny({restrictQualifyingAlternates:e,structure:t,entry:r}){let{stage:i}=t;if(!r.entryStage||r.entryStage===i||i===Yo&&!e||r.entryStage===Ho&&i===zo)return!0}function Ay({restrictAdHocRoundParticipants:e,tournamentParticipants:t,matchUpParticipantIds:r,otherFlightEntries:i,drawDefinition:n,structureId:a,sideNumber:o,matchUpId:s,structure:c,matchUp:u,drawId:d,event:l}){let p=[],m=c?.matchUps??[],f=u.sides?.find(e=>e.sideNumber===o)?.participantId,h=m.filter(({roundNumber:e})=>e===u.roundNumber),g=n?.entries?.filter(({entryStatus:e})=>e&&Lp.includes(e)).map(dd)??[],I=h.map(e=>(e.sides??[]).flatMap(dd)).flat().filter(Boolean),U=g.filter(t=>!(r.includes(t)||e&&I.includes(t))),S=t?.filter(e=>U?.includes(e.participantId)).map(e=>Wa(e,void 0,!0));S?.forEach(e=>{let t=(n.entries??[]).find(t=>t.participantId===e.participantId);e.entryPosition=t?.entryPosition}),U.length&&p.push({payload:{drawId:d,matchUpId:s,structureId:a,sideNumber:o},method:hy,type:cS,availableParticipantIds:U,participantsAvailable:S});let v=function({eventEntries:e,structure:t}){return e.filter(e=>e.entryStatus===Pp&&Ny({structure:t,entry:e})).sort((e,t)=>(e.entryPosition||1/0)-(t.entryPosition||1/0)).map(dd)}({eventEntries:l?.entries??[],structure:c}),y=L(g.concat(v));if(i){let e=(l?Nf({event:l}):void 0)?.flights?.filter(e=>e.drawId!==d).flatMap(e=>e.drawEntries.filter(e=>e.participantId&&![Fp,Cp,Op].includes(e.entryStatus)).map(({participantId:e})=>e)).filter(Boolean);e?.length&&y.push(...e)}y=y.filter(t=>!(r.includes(t)||U.includes(t)||e&&I.includes(t)));let w=t?.filter(e=>y.includes(e.participantId)).map(e=>Wa(e,void 0,!0));if(w?.forEach(e=>{let t=(n.entries??[]).find(t=>t.participantId===e.participantId);e.entryPosition=t?.entryPosition}),w?.sort((e,t)=>(e.entryPosition||1/0)-(t.entryPosition||1/0)),y.length&&p.push({payload:{drawId:d,matchUpId:s,structureId:a,sideNumber:o},availableParticipantIds:y,participantsAvailable:w,method:hy,type:Pp}),!ch(u)&&o&&f){p.push({payload:{drawId:d,matchUpId:s,structureId:a,sideNumber:o},method:"removeMatchUpSideParticipant",type:Sy});let e=e=>e.sides.map(dd),r=({matchUpId:e})=>e!==u.matchUpId,i=e=>!ch(e),n=u.sides?.find(e=>e.sideNumber!==o)?.participantId,c=[n,...m.filter(({roundNumber:e})=>e!==u.roundNumber).filter(r).map(e).filter(e=>e.includes(f)).flat()].filter(Boolean),l=e=>!c.flat().includes(e),g=h.filter(i).filter(r).map(e).flat().filter(l);if(g.length){let e=t?.filter(e=>g.includes(e.participantId)).map(e=>Wa(e,void 0,!0));p.push({payload:{participantIds:[f],roundNumber:u.roundNumber,structureId:a,sideNumber:o,matchUpId:s,drawId:d},swappableParticipantIds:g,method:"adHocPositionSwap",type:pS,swappableParticipants:e})}}return p}function Ey(e){if(!e)return{error:gi};let{drawDefinition:t,event:r}=e,{restrictAdHocRoundParticipants:i=!0,policyDefinitions:n,enforceGender:a,participantId:o,sideNumber:s,matchUpId:u}=e,l=e.tournamentRecord??(e.tournamentId&&S(e.tournamentId)&&e.tournamentRecords?.[e.tournamentId]);if(!l)return{error:Ie};if(!u||!S(u))return{error:Mt};if(s&&![1,2].includes(s))return Pn({result:{error:gi},context:{sideNumber:s}});if(!t){let e=(Xf({tournamentRecord:l}).matchUps??[]).find(e=>e.matchUpId===u);r=(l?.events??[]).find(t=>t.eventId===e?.eventId);let i=(r?.drawDefinitions??[]).find(t=>t.drawId===e?.drawId);i&&(t=i)}if(!t)return{error:ye};let p=Ag({withIndividualParticipants:!0,tournamentRecord:l}).participants,{drawId:m}=t,{matchUp:f,structure:h}=zS({drawDefinition:t,matchUpId:u,event:r});if(!f)return{error:Nt};let g=up({tournamentRecord:l,drawDefinition:t,structure:h,event:r}).appliedPolicies??{};Object.assign(g,n??{});let I=g?.[ru]?.otherFlightEntries,U=g?.[iu]??Hg[iu],{enabledStructures:v}=cy({actionType:sy,appliedPolicies:g,drawDefinition:t,structure:h}),{policyActions:y}=dy({enabledStructures:v,drawDefinition:t,structure:h}),w=e.matchUpsMap??Kp({drawDefinition:t}),P=e.inContextDrawMatchUps??Kf({tournamentParticipants:p,inContext:!0,drawDefinition:t,matchUpsMap:w,event:r}).matchUps,T=P?.find(e=>e.matchUpId===u),D=s&&T?.sides?.find(e=>e.sideNumber===s),b=T?.sides?.map(e=>e.participantId||e.participant?.participantid).filter(Boolean)??[],{assignedPositions:M,allPositionsAssigned:R}=qd({structure:h}),{structureId:N}=h??{},A=[];if(!N)return{validActions:A};let E=nm({structure:h}),C=!!f.collectionId;if(E&&!C){let e=Ay({restrictAdHocRoundParticipants:i,tournamentParticipants:p,matchUpParticipantIds:b,otherFlightEntries:I,drawDefinition:t,structureId:N,sideNumber:s,matchUpId:u,structure:h,matchUp:f,drawId:m,event:r});A.push(...e)}let O=sU({drawDefinition:t,structure:h}),k=M?.filter(e=>e.participantId).map(e=>e.drawPosition),F=M?.filter(e=>e.bye).map(e=>e.drawPosition),x="BYE"===f.matchUpStatus||!C&&f.drawPositions?.reduce((e,t)=>F?.includes(t)||e,!1);if(x)return{validActions:A,isByeMatchUp:x};ly({policyActions:y,action:Py})&&A.push({type:Py,payload:{matchUpId:u}});let _=!uh({matchUpStatus:f.matchUpStatus}),L=g?.scoring?.structures,B=h?.stage&&L?.stage?.[h.stage],V=h?.stageSequence&&B?.stageSequence?.[h.stageSequence],G=!(g?.scoring?.requireAllPositionsAssigned||B?.requireAllPositionsAssigned||V?.requireAllPositionsAssigned)||R,j=2===f.sides?.filter(e=>e?.participantId).length,$=f.matchUpStatus&&[yd,vd].includes(f.matchUpStatus),q=ny({inContextDrawMatchUps:P,drawDefinition:t,targetData:Wf({inContextDrawMatchUps:P,drawDefinition:t,matchUpId:u})}),W=(2===T?.drawPositions?.length&&T.drawPositions.every(e=>k?.includes(e))&&2===T?.sides?.length&&T.sides.every(({participantId:e})=>e)||j)&&!($&&q),H={method:iS,type:hS,payload:{drawId:m,matchUpId:u,penaltyCode:void 0,penaltyType:void 0,participantIds:[],notes:void 0}};if(_&&A.push({payload:{drawId:m,matchUpId:u,schedule:{}},method:vy,type:wy}),ly({policyActions:y,action:hS})&&(D?.participant||!s&&b?.length)&&A.push(H),_&&W&&A.push({type:Ty}),G&&W){let{matchUpId:e,matchUpFormat:t}=f,r={drawId:m,matchUpId:e,matchUpFormat:t,outcome:{scoreStringSide1:void 0,scoreStringSide2:void 0,sets:[]},winningSide:void 0};A.push({info:"set outcome and winningSide",method:vy,type:by,payload:r}),ly({policyActions:y,action:Dy})&&A.push({type:Dy}),ly({policyActions:y,action:"END"})&&A.push({type:"END"})}if(C&&T){let e=function({specifiedPolicyDefinitions:e,inContextDrawMatchUps:t,matchUpParticipantIds:r,matchUpActionsPolicy:i,inContextMatchUp:n,policyActions:a,enforceGender:o,participantId:s,sideNumber:u,matchUpId:l,matchUp:p,drawId:m,side:f}){let h=[],g=n.sides?.find(e=>e.participant),I=En(n.gender)&&n.sideNumber&&1===n.sides?.filter(e=>e.particiapntId).length&&g?.participant?.person?.sex,U=n.matchUpType,S=!1!==(o??i?.participants?.enforceGender)?n.gender:void 0,v=n.sides?.flatMap(e=>e.participant?.individualParticipants||e.participant).filter(Boolean)?.map(dd),y=n.sides?.filter(e=>!u||e.sideNumber===u).flatMap(e=>e.participant?.individualParticipants||e.participant).filter(Boolean),w=y?.map(dd),P=t?.find(e=>e.matchUpId===n.matchUpTieId)?.sides?.map(e=>e?.participant?.individualParticipants?.filter(({participantId:e,person:t})=>!w?.includes(e)&&(!S||Cn(S)||t.sex===S||En(S)&&!I||I&&t.sex!==I))),T=u?P?.[u-1]:P?.map((e,t)=>({participants:e,sideNumber:t+1})),D=u?P?.[u-1]?.map(dd):P?.map((e,t)=>({participants:e?.map(dd),sideNumber:t+1})),b=u&&(Wm(c)(U)&&!w?.length||Wm(d)(U)&&(w?.length??0)<2)||!u&&(Wm(c)(U)&&(w?.length??0)<2||Wm(d)(U)&&(w?.length??0)<4),M=D?.filter(e=>!v?.includes(e)),R=T?.filter(({participantId:e})=>M.includes(e));if(b&&M?.length&&h.push({availableParticipantIds:M,method:my,availableParticipants:R,type:cS,payload:{participantId:void 0,tieMatchUpId:l,sideNumber:u,drawId:m}}),w?.length&&(!ch(p)||f?.substitutions?.length)&&h.push({method:fy,type:Sy,existingParticipantIds:w,payload:{participantId:void 0,tieMatchUpId:l,drawId:m}}),R?.length&&(!u&&w?.length||u&&f?.participant)&&h.push({availableParticipantIds:M,method:py,availableParticipants:R,type:Uy,existingParticipantIds:w,payload:{existingParticipantId:void 0,participantId:void 0,tieMatchUpId:l,drawId:m}}),ly({policyActions:a,action:Iy})&&f?.substitutions?.length){let e=f.participant?.participantType===Vl&&[f.participantId]||f.participant?.participantType===jl&&f.participant.individualParticipantIds||[],t=f.substitutions.map(e=>e.participantId).filter(t=>e.includes(t));(!s||t.includes(s))&&h.push({method:fy,type:Iy,substitutedParticipantIds:t,payload:{participantId:void 0,tieMatchUpId:l,drawId:m}})}let N=e?.[iu],A=N?.substituteWithoutScore,E=N?.substituteAfterCompleted;if(ly({policyActions:a,action:yy})&&2===r.length&&(!u&&w?.length||u&&f?.participant)&&(A||ch(p))&&(E||p.matchUpStatus&&!kd.includes(p.matchUpStatus))&&y?.length&&T.length){let e=y.map(dd);h.push({info:"list of team players available for substitution",method:gy,availableParticipantIds:D,existingParticipantIds:e,availableParticipants:T,existingParticipants:y,type:yy,payload:{substituteParticipantId:void 0,existingParticipantId:void 0,sideNumber:u,matchUpId:l,drawId:m}})}return h}({specifiedPolicyDefinitions:n,inContextDrawMatchUps:P,matchUpParticipantIds:b,matchUpActionsPolicy:U,inContextMatchUp:T,policyActions:y,enforceGender:a,participantId:o,sideNumber:s,matchUpId:u,matchUp:f,drawId:m,side:D});A.push(...e)}return{structureIsComplete:O,validActions:A,isDoubleExit:$,...ce}}function Cy({tournamentParticipants:e=[],sourceStructuresComplete:t,possiblyDisablingAction:r,isWinRatioFedStructure:i,activeDrawPositions:n,positionAssignments:a,drawDefinition:o,drawPosition:s,structureId:c,structure:u,drawId:d,event:l}){if(n.includes(s)||i&&!t)return{};let{sourceStructureIds:p,targetStructureIds:m}=o.links?.reduce((e,t)=>{let r=t.source?.structureId,i=t.target?.structureId;return e.sourceStructureIds.includes(r)||e.sourceStructureIds.push(r),e.targetStructureIds.includes(i)||e.targetStructureIds.push(i),e},{sourceStructureIds:[],targetStructureIds:[]})||{},f=[],h=o.links?.filter(e=>e.target?.structureId===u.structureId)??[];for(let I of h){let e=I?.source?.structureId,{structure:t}=Vd({structureId:e,drawDefinition:o}),r={};if(t?.finishingPosition===qs&&(1!==p?.length||1!==m?.length)){let{matchUps:e}=Bf({drawDefinition:o,structure:u,event:l}),{initialRoundNumber:t}=mh({drawPosition:s,matchUps:e}),i=o.links?.find(e=>e.target?.structureId===u?.structureId&&e.target.roundNumber===t)?.source?.roundNumber;r.roundNumbers=[i]}let{completedMatchUps:i}=Gf({structureId:e,inContext:!0,matchUpFilters:r,drawDefinition:o}),n=a.map(e=>e.participantId).filter(Boolean);i?.filter(({matchUpType:e,winningSide:t})=>t&&(l?.eventType!==$o||e===$o)).map(({winningSide:e,sides:t})=>e&&t?.[1-(e-1)]).map(dd).filter(e=>e&&!n.includes(e))?.forEach(e=>{f.includes(e)||f.push(e)})}let g=e?.filter(e=>f?.includes(e.participantId));return g?.forEach(e=>{let t=(o.entries??[]).find(t=>t.participantId===e.participantId);e.entryPosition=t?.entryPosition}),f?.length?{validLuckyLosersAction:{type:dS,method:"luckyLoserDrawPositionAssignment",availableLuckyLosers:g,availableLuckyLoserParticipantIds:f,willDisableLinks:r,payload:{drawId:d,structureId:c,drawPosition:s}}}:{}}function Oy({positionSourceStructureIds:e,unassignedParticipantIds:t,possiblyDisablingAction:r,provisionalPositioning:i,tournamentParticipants:n,isWinRatioFedStructure:a,positionAssignments:o,returnParticipants:s,appliedPolicies:c,drawDefinition:u,seedingProfile:d,isByePosition:l,drawPosition:p,structureId:m,event:f}){let h,g,{drawId:I}=u,U=[],S=[],v=c?.[lu]?.validSeedPositions?.ignore;if(v||({unplacedSeedParticipantIds:h,unplacedSeedAssignments:g,unfilledPositions:S}=kI({provisionalPositioning:i,returnAllProxies:!0,randomize:!0,drawDefinition:u,seedingProfile:d,structureId:m,event:f})),S?.length||(S=o.filter(e=>!e.participantId&&!e.bye&&!e.qualifier).map(e=>e.drawPosition)),l||U.push({payload:{drawId:I,structureId:m,drawPosition:p,isPositionAction:!0},willDisableLinks:r,method:"assignDrawPositionBye",type:"BYE"}),a&&v){let t=o.map(e=>e.participantId).filter(Boolean),i={structureIds:e},{completedMatchUps:a}=Jf({inContext:!0,matchUpFilters:i,drawDefinition:u}),c=L((a??[]).filter(({matchUpType:e})=>f?.eventType!==$o||e===$o)?.map(({sides:e})=>e?.map(dd)).flat().filter(e=>e&&!t.includes(e))),d=s?n?.filter(e=>c?.includes(e.participantId)).map(e=>Wa(e,void 0,!0)):void 0;return d?.forEach(e=>{let t=(u.entries??[]).find(t=>t.participantId===e.participantId);e.entryPosition=t?.entryPosition}),d?.length&&U.push(wn({payload:{drawId:I,structureId:m,drawPosition:p},willDisableLinks:r,method:rS,type:cS,availableParticipantIds:c,participantsAvailable:d})),{validAssignmentActions:U}}if(S.includes(p)||l){let e;if(g?.length){let t=g.filter(e=>h?.includes(e.participantId));t.sort(ky),e=t.map(e=>e.participantId)}else e=t;let i=s?n?.filter(t=>e.includes(t.participantId)).map(e=>Wa(e,void 0,!0)):void 0;i?.length&&U.push(wn({payload:{drawId:I,structureId:m,drawPosition:p},willDisableLinks:r,method:rS,type:cS,availableParticipantIds:e,participantsAvailable:i}))}return{validAssignmentActions:U}}function ky(e,t){return e.bye||NI(e.seedValue)<NI(t.seedValue)||e.seedValue&&!t.seedValue?-1:(e.seedNumber||0)-(t.seedNumber||0)}function Fy({drawPositionInitialRounds:e,tournamentParticipants:t,positionAssignments:r,returnParticipants:i,appliedPolicies:n,drawDefinition:a,drawPosition:o,structureId:s,drawId:c}){let u=[],d=[],l=[],p=[],m=new Set(r.map(e=>e.participantId).filter(Boolean)),f=n?.[ru],h=!f?.disableRoundRestrictions&&e[o],g=f?.requireCompletedStructures,{sourceStructureIds:I,relevantLinks:U}=LU({targetRoundNumber:h,linkType:fs,drawDefinition:a,structureId:s})||{};I?.length&&p.push(...I);let{sourceStructureIds:S,relevantLinks:v}=LU({targetRoundNumber:h,linkType:ms,drawDefinition:a,structureId:s})||{};S?.length&&p.push(...S);for(let y of U){let e=a.structures?.find(e=>e.structureId===y.source.structureId);if(e?.stage!==Yo)continue;let r=sU({structureId:y.source.structureId,drawDefinition:a});if(!g||r){let r=e.qualifyingRoundNumber,{matchUps:n}=Bf({matchUpFilters:{roundNumbers:[r],isCollectionMatchUp:!1,hasWinningSide:!0},afterRecoveryTimes:!1,tournamentParticipants:t,inContext:!0,structure:e});for(let e of n){let t=e.sides.find(t=>t?.sideNumber===e.winningSide),r="BYE"===e.matchUpStatus&&e.sides?.find(({participantId:e})=>e);if(t||r){let{participantId:e,participant:n}=t||r||{};e&&!m.has(e)&&(n&&i&&u.push(n),d.push(e))}}}}for(let y of v){let e=a.structures?.find(e=>e.structureId===y.source.structureId);if(e?.stage!==Yo)continue;let r=sU({structureId:y.source.structureId,drawDefinition:a});if(!g||r){let{positionAssignments:r}=$d({structure:e}),n=r?.map(e=>{let t=e.participantId,r=Ru({element:e,name:Ju}).extension?.value;return r?{participantId:t,groupOrder:r?.groupOrder}:{}}).filter(({groupOrder:e,participantId:t})=>1===e&&!m.has(t)).map(({participantId:e})=>e)??[];if(n&&d.push(...n),i){let e=t.filter(({participantId:e})=>n.includes(e));u.push(...e)}}}return d.length&&l.push(wn({qualifyingParticipants:i?u:void 0,method:"qualifierDrawPositionAssignment",type:aS,qualifyingParticipantIds:d,payload:{qualifyingParticipantId:void 0,drawPosition:o,structureId:s,drawId:c}})),{validAssignmentActions:l,sourceStructureIds:p}}function xy({onlyAssignedPositions:e=!0,possiblyDisablingAction:t,tournamentParticipants:r,inactiveDrawPositions:i,activeDrawPositions:n,positionAssignments:a,returnParticipants:o,byeDrawPositions:s,drawDefinition:c,isByePosition:u,drawPosition:d,structureId:l,structure:p,drawId:m,event:f}){if(n.includes(d))return{};let h=i?.filter(e=>e!==d&&!(u&&s.includes(e))),g=a?.filter(t=>(t=>!e||t.participantId||t.qualifier||t.bye)(t)&&h?.includes(t.drawPosition))??[],I=g.map(({drawPosition:e})=>e),{matchUps:U}=Bf({afterRecoveryTimes:!1,inContext:!0,drawDefinition:c,structure:p,event:f}),S=U.filter(({drawPositions:e})=>Z(e,I)),v=Object.assign({},...S.map(e=>e.sides?.filter(({sourceDrawPositionRange:e})=>e).map(({drawPosition:e,sourceDrawPositionRange:t})=>({[e]:t}))).flat()),y=g.map(e=>e.participantId).filter(Boolean),w=(r??[]).filter(e=>y.includes(e.participantId)),P=Object.assign({},...w.map(e=>({[e.participantId]:e}))),T=g.map(e=>{let t=P?.[e.participantId],r=v[e.drawPosition];return wn({...e,participant:o?Wa(t,!1,!0):void 0,sourceDrawPositionRange:r})});return T.length?{validSwapAction:{payload:{drawId:m,structureId:l,drawPositions:[d]},willDisableLinks:t,method:tS,type:pS,availableAssignments:T}}:{}}function _y(e){return function(e){let t=$c(e,[{event:!0,drawDefinition:!0,structureId:!0}]);if(t.error)return t;let{policyDefinitions:r,returnParticipants:i=!0,provisionalPositioning:n,tournamentRecord:a,drawDefinition:o,drawPosition:s,event:c}=e,u=e.tournamentParticipants??(a&&Ag({withIndividualParticipants:!0,tournamentRecord:a}).participants)??[],d=Vd({structureId:e.structureId,drawDefinition:o});if(d.error)return d;let l=d.containingStructure||d.structure;if(!l)return{error:et};let p=l.structureId;if(d=ph({drawDefinition:o,structureId:p}),void 0===s&&!d.isAdHoc)return{error:xe};if(d.isAdHoc)return Ey(e);if(d.error)return d;let{drawPositionInitialRounds:m,inactiveDrawPositions:f,activeDrawPositions:h,byeDrawPositions:g}=d,I=up({tournamentRecord:a,drawDefinition:o,structure:l,event:c}).appliedPolicies??{};Object.assign(I,r??{});let U,{actionsPolicy:S,enabledStructures:v,actionsDisabled:y}=cy({actionType:oy,appliedPolicies:I,drawDefinition:o,structure:l}),w=S?.activePositionOverrides||[],{sourceStructureIds:P}=LU({finishingPosition:$s,targetRoundNumber:1,linkType:ms,drawDefinition:o,structureId:p})||{};P?.length&&(U=P.every(e=>sU({structureId:e,drawDefinition:o})));let T=P.length,D=P.length&&!U,{policyActions:b}=dy({enabledStructures:v,drawDefinition:o,structure:l}),M=![Yo,Ho].includes(l.stage)||1!==l.stageSequence,{drawId:R}=o,N=[],{assignedPositions:A,positionAssignments:E}=qd({structure:l}),C=A?.find(e=>e.drawPosition===s),O=!!C;if(!E?.map(e=>e.drawPosition)?.includes(s))return{error:Fe};let{stage:k,stageSequence:F}=l,x=[k];k===zo&&x.push(Ho),k===Ho&&x.push(zo);let _=qp({entryStatuses:Lp,provisionalPositioning:n,drawDefinition:o,stageSequence:F,structureId:p,stages:x}),L=Nh({drawDefinition:o,stages:x}).assignedParticipantIds??[],B=function(e,t){return e.filter(e=>!t.includes(e.participantId)).map(e=>e.participantId)}(_,L),V=g.includes(s),G=h.includes(s);if(y)return{info:"Actions Disabled for structure",isActiveDrawPosition:G,isDrawPosition:!0,hasPositionAssigned:O,validActions:[],isByePosition:V};(function({validActions:e,policyActions:t,isActiveDrawPosition:r,positionAssignments:i,disablePlacementActions:n,positionAssignment:a,isByePosition:o,getValidAssignmentActions:s,positionSourceStructureIds:c,unassignedParticipantIds:u,possiblyDisablingAction:d,isWinRatioFedStructure:l,tournamentParticipants:p,returnParticipants:m,appliedPolicies:f,drawDefinition:h,drawPosition:g,structureId:I,event:U}){if(ly({policyActions:t,action:cS})&&!r&&i&&!n&&(!a||o)){let{validAssignmentActions:t}=s({positionSourceStructureIds:c,unassignedParticipantIds:u,possiblyDisablingAction:d,isWinRatioFedStructure:l,tournamentParticipants:p,positionAssignments:i,returnParticipants:m,appliedPolicies:f,drawDefinition:h,isByePosition:o,drawPosition:g,structureId:I,event:U});t?.forEach(t=>e.push(t))}})({validActions:N,policyActions:b,isActiveDrawPosition:G,positionAssignments:E,disablePlacementActions:D,positionAssignment:C,isByePosition:V,getValidAssignmentActions:Oy,positionSourceStructureIds:P,unassignedParticipantIds:B,possiblyDisablingAction:M,isWinRatioFedStructure:T,tournamentParticipants:u,returnParticipants:i,appliedPolicies:I,drawDefinition:o,drawPosition:s,structureId:p,event:c}),function({validActions:e,policyActions:t,isActiveDrawPosition:r,getValidQualifiersAction:i,drawPositionInitialRounds:n,tournamentParticipants:a,positionAssignments:o,returnParticipants:s,appliedPolicies:c,drawDefinition:u,drawPosition:d,structureId:l,drawId:p}){if(ly({policyActions:t,action:aS})&&!r){let{validAssignmentActions:t}=i({drawPositionInitialRounds:n,tournamentParticipants:a,positionAssignments:o,returnParticipants:s,appliedPolicies:c,drawDefinition:u,drawPosition:d,structureId:l,drawId:p});t?.forEach(t=>e.push(t))}}({validActions:N,policyActions:b,isActiveDrawPosition:G,getValidQualifiersAction:Fy,drawPositionInitialRounds:m,tournamentParticipants:u,positionAssignments:E,returnParticipants:i,appliedPolicies:I,drawDefinition:o,drawPosition:s,structureId:p,drawId:R});let{participantId:j}=C||{},$=j&&u.find(e=>e.participantId===j);return C&&(function({validActions:e,policyActions:t,isActiveDrawPosition:r,drawId:i,structureId:n,drawPosition:a,possiblyDisablingAction:o,isByePosition:s}){ly({policyActions:t,action:uS})&&!r&&(e.push({type:uS,method:eS,payload:{drawId:i,structureId:n,drawPosition:a},willDisableLinks:o}),s||e.push({type:sS,method:"withdrawParticipantAtDrawPosition",payload:{drawId:i,structureId:n,drawPosition:a},willDisableLinks:o}),ly({policyActions:t,action:"BYE"})&&!s&&e.push({type:"BYE",method:eS,payload:{drawId:i,structureId:n,drawPosition:a,replaceWithBye:!0},willDisableLinks:o}))}({validActions:N,policyActions:b,isActiveDrawPosition:G,drawId:R,structureId:p,drawPosition:s,possiblyDisablingAction:M,isByePosition:V}),function({validActions:e,policyActions:t,activePositionsCheck:r,activePositionOverrides:i,activeDrawPositions:n,drawDefinition:a,structureId:o,drawPosition:s,structure:c,isByePosition:u,participantId:d,participant:l,drawId:p}){let m=c.stage===Yo||c.stage===Ho&&1===c.stageSequence;if(!u&&r({activePositionOverrides:i,activeDrawPositions:n,action:fS})&&ly({policyActions:t,action:fS})&&OI({drawDefinition:a,structureId:o,drawPosition:s})&&m){let{seedAssignments:t}=Wp({returnAllProxies:!0,drawDefinition:a,structure:c}),{seedNumber:r,seedValue:i}=t?.find(e=>e.participantId===d)??{};e.push({type:fS,method:"modifySeedAssignment",participant:l,seedNumber:r,payload:{drawId:p,structureId:o,participantId:d,seedValue:i}})}if(!u&&r({activePositionOverrides:i,activeDrawPositions:n,action:lS})&&ly({policyActions:t,action:lS})&&OI({drawDefinition:a,structureId:o,drawPosition:s})&&m){let{seedAssignments:t}=Wp({returnAllProxies:!0,drawDefinition:a,structure:c}),{seedNumber:r}=t?.find(e=>e.participantId===d)??{};e.push({method:"removeSeededParticipant",type:lS,participant:l,seedNumber:r,payload:{participantId:d,structureId:o,drawId:p}})}}({validActions:N,policyActions:b,activePositionsCheck:uy,activePositionOverrides:w,activeDrawPositions:h,drawDefinition:o,structureId:p,drawPosition:s,structure:l,isByePosition:V,participantId:j,participant:$,drawId:R}),function({validActions:e,policyActions:t,isByePosition:r,participantId:i,participant:n,drawId:a}){if(!r&&i){if(ly({policyActions:t,action:hS})){let t={type:hS,method:iS,participant:n,payload:{penaltyCode:void 0,penaltyType:void 0,participantIds:[],notes:void 0,drawId:a}};e.push(t)}if(ly({policyActions:t,action:mS})){let t={type:mS,method:"modifyParticipantOtherName",participant:n,payload:{participantId:i,otherName:void 0}};e.push(t)}}}({validActions:N,policyActions:b,isByePosition:V,participantId:j,participant:$,drawId:R}),function({validActions:e,policyActions:t,getValidSwapAction:r,possiblyDisablingAction:i,tournamentParticipants:n,inactiveDrawPositions:a,activeDrawPositions:o,positionAssignments:s,returnParticipants:c,byeDrawPositions:u,drawDefinition:d,isByePosition:l,drawPosition:p,structureId:m,structure:f,drawId:h}){if(ly({policyActions:t,action:pS})){let{validSwapAction:t}=r({possiblyDisablingAction:i,tournamentParticipants:n,inactiveDrawPositions:a,activeDrawPositions:o,positionAssignments:s,returnParticipants:c,byeDrawPositions:u,drawDefinition:d,isByePosition:l,drawPosition:p,structureId:m,structure:f,drawId:h});t&&e.push(t)}}({validActions:N,policyActions:b,getValidSwapAction:xy,possiblyDisablingAction:M,tournamentParticipants:u,inactiveDrawPositions:f,activeDrawPositions:h,positionAssignments:E,returnParticipants:i,byeDrawPositions:g,drawDefinition:o,isByePosition:V,drawPosition:s,structureId:p,structure:l,drawId:R})),function({validActions:e,policyActions:t,getValidAlternatesAction:r,possiblyDisablingAction:i,tournamentParticipants:n,positionAssignments:a,activeDrawPositions:o,returnParticipants:s,appliedPolicies:c,drawDefinition:u,drawPosition:d,structureId:l,structure:p,drawId:m,event:f,disablePlacementActions:h}){if(ly({policyActions:t,action:oS})&&!h){let{validAlternatesAction:t}=r({possiblyDisablingAction:i,tournamentParticipants:n,positionAssignments:a,activeDrawPositions:o,returnParticipants:s,appliedPolicies:c,drawDefinition:u,drawPosition:d,validActions:e,structureId:l,structure:p,drawId:m,event:f});t&&e.push(t)}}({validActions:N,policyActions:b,getValidAlternatesAction:Ry,possiblyDisablingAction:M,tournamentParticipants:u,positionAssignments:E,activeDrawPositions:h,returnParticipants:i,appliedPolicies:I,drawDefinition:o,drawPosition:s,structureId:p,structure:l,drawId:R,event:c,disablePlacementActions:D}),function({validActions:e,policyActions:t,getValidLuckyLosersAction:r,sourceStructuresComplete:i,possiblyDisablingAction:n,isWinRatioFedStructure:a,tournamentParticipants:o,activeDrawPositions:s,positionAssignments:c,drawDefinition:u,drawPosition:d,structureId:l,structure:p,drawId:m,disablePlacementActions:f,isActiveDrawPosition:h}){if(ly({policyActions:t,action:dS})&&!f&&!h&&c){let{validLuckyLosersAction:t}=r({sourceStructuresComplete:i,possiblyDisablingAction:n,isWinRatioFedStructure:a,tournamentParticipants:o,activeDrawPositions:s,positionAssignments:c,drawDefinition:u,drawPosition:d,structureId:l,structure:p,drawId:m});t&&e.push(t)}}({validActions:N,policyActions:b,getValidLuckyLosersAction:Cy,sourceStructuresComplete:U,possiblyDisablingAction:M,isWinRatioFedStructure:T,tournamentParticipants:u,activeDrawPositions:h,positionAssignments:E,drawDefinition:o,drawPosition:s,structureId:p,structure:l,drawId:R,disablePlacementActions:D,isActiveDrawPosition:G}),function({validActions:e,policyActions:t,getValidModifyAssignedPairAction:r,participant:i,tournamentParticipants:n,returnParticipants:a,drawPosition:o,drawId:s,event:c}){if(i?.participantType===jl&&ly({policyActions:t,action:nS})){let{validModifyAssignedPairAction:t}=r({tournamentParticipants:n,returnParticipants:a,drawPosition:o,participant:i,drawId:s,event:c});t&&e.push(t)}}({validActions:N,policyActions:b,getValidModifyAssignedPairAction:iy,participant:$,tournamentParticipants:u,returnParticipants:i,drawPosition:s,drawId:R,event:c}),{isActiveDrawPosition:G,isDrawPosition:!0,hasPositionAssigned:O,isByePosition:V,validActions:N,...ce}}(e)}function Ly({policyDefinitions:e,appliedPolicies:t,drawType:r}){let i=e?.[mu]?.drawTypeCoercion,n=t?.[mu]?.drawTypeCoercion;return("boolean"==typeof i?i:void 0)??(r&&i?.[r])??("boolean"==typeof n?n:void 0)??(r&&n?.[r])??!0}var By=({drawDefinition:e})=>{let t=$c({drawDefinition:e},[{[Xs]:!0}]);if(t.error)return t;let r=e.structures?.find(e=>e.stage===Ho&&1===e.stageSequence);if(!r)return Pn({result:{error:it}});let{qualifierPositions:i}=qd({structure:r});return K(0,i.length).sort(()=>Math.random()-.5)};function Vy({structureId:e,drawDefinition:t}){if(!t)return{error:ye};if(!S(e))return{error:gi};let r=$f({drawDefinition:t,structureId:e});if(r.error)return r;let i=r.links.target.flatMap(e=>e.target.feedProfile).filter(Boolean),n=!Q([ps,ls,ds,os],i).length;return{...ce,valid:n}}function Gy({participantsCount:e,participantCount:t}){if(!(e=e??t))return{error:gi};let r=O(e);return r?{drawSize:r}:Pn({result:{error:gi},stack:"getEliminationDrawSize",context:{participantsCount:e}})}function jy(e){let{drawSizeProgression:t=!1,policyDefinitions:r,drawSize:i}=e||{},{requireParticipantCount:n=!0,tournamentRecord:a,drawDefinition:o,event:s}=e||{},c="getSeedsCount",u=e?.participantsCount??e?.participantCount;if(!r){let e=dp({tournamentRecord:a,drawDefinition:o,event:s});if(e.error)return Pn({result:e,stack:c});r=e.policyDefinitions}let d=F(u);if(u&&!d)return Pn({result:{error:gi},context:{participantsCount:u},stack:c});if(n&&!d)return Pn({result:{error:Pr},stack:c});if(Number.isNaN(Number(i))){if(!u)return Pn({result:{error:Ve},stack:c});({drawSize:i}=Gy({participantsCount:u}))}let l=n&&u||i;if(l&&l>i)return{error:Rr};let p=r?.[lu];if(!p)return{error:_t};let m=p.seedsCountThresholds;return m?(void 0!==p.drawSizeProgression&&(t=p.drawSizeProgression),{seedsCount:m.filter(e=>t?e.drawSize<=i:i===e.drawSize).reduce((e,t)=>u&&u>=t.minimumParticipantCount?t.seedsCount:e,0)}):{error:We}}function $y({consideredEntries:e,policyDefinitions:t,tournamentRecord:r,appliedPolicies:i,participantMap:n,enforceGender:a,participants:o,event:s}){if((!o||!n)&&r&&({participants:o,participantMap:n}=Ag({tournamentRecord:r})),!o)return{error:gr};if(!Array.isArray(o))return{error:gi};if(!s)return{error:ot};let c=t?.[iu]??i?.[iu]??Hg[iu],u=!1!==(a??c?.participants?.enforceGender),{eventType:d,gender:l}=s,p=d===jo,m=d===qo&&$l||p&&jl||Vl,f=Object.assign({},...(e??s.entries??[]).map(e=>({[e.participantId]:e.entryStatus}))),h=Object.keys(f),g=o.filter(e=>h.includes(e.participantId)).filter(e=>{let t=function({participant:e,participantType:t,eventType:r,entryStatusMap:i}){let n=i[e.participantId],a=r&&[jo,qo].includes(r)&&e.participantType===Vl&&(Eh(n)||n===Fp);return e.participantType!==t&&!a}({participant:e,participantType:m,eventType:d,entryStatusMap:f}),r=function(e){let{participant:t,participantMap:r,eventGender:i,mismatch:n,isDoubles:a,genderEnforced:o}=e,s=!n&&a&&L(t?.individualParticipantIds?.map(e=>r?.[e]?.participant?.person?.sex).filter(Boolean)??[])||[],c=!i||!s?.length||Cn(i)||kn(i)&&On(s[0])===On(i)||En(i)&&(1===s.length&&1===t.individualParticipantIds?.length||2===s.length),u=t?.person?.sex,d=!t?.person||!i||En(i)||Cn(i)||kn(i)&&On(u)===On(i);return!o||c&&d}({genderEnforced:u,participantMap:n,eventGender:l,participant:e,isDoubles:p,mismatch:t});return t||!r});if(g.length){let e=g.map(e=>e.participantId);return{error:dt,invalidParticipantIds:e}}return{...ce,valid:!0}}function qy({hasExistingDrawDefinition:e,qualifyingProfiles:t,appliedPolicies:r,qualifyingOnly:i,tieFormat:n,idPrefix:a,isMock:o,uuids:s}){let c,u=[],d=[],l=[],p=(e,t)=>e.stageSequence-t.stageSequence,m=(e,t)=>e.roundTarget-t.roundTarget,f=0,h=0,g=1;for(let I of t.sort(m)){let m=I.structureProfiles||[];g=I.roundTarget||g;let U,S,v,y=1,w=0;for(let u of(m||[]).sort(p)){let p,h,I,P=N(u.drawSize||u.participantsCount),{qualifyingRoundNumber:T,structureOptions:D,matchUpFormat:b,structureName:M,structureId:R,drawType:A}=u,E=u.matchUpType,C=u.qualifyingPositions||Wy({drawSize:P,qualifyingRoundNumber:T});if(!F(P))return Pn({result:{error:Ve},stack:"generateQualifyingSTructures"});let O=t.length>1?`${g}-`:"",k=m.length>1||O?y:"",x=M||(O||k?`${II(Yo)} ${O}${k}`:II(Yo));if(A===_s){let{structures:t,groupCount:d,maxRoundNumber:l}=TI({structureName:u.structureName||x,structureId:R||s?.pop(),hasExistingDrawDefinition:e,stage:Yo,structureOptions:D,appliedPolicies:r,qualifyingOnly:i,stageSequence:y,matchUpType:E,roundTarget:g,tieFormat:n,drawSize:P,idPrefix:a,isMock:o,uuids:s});w=d,p=l,h=t[0],c=[1]}else({drawSize:P,matchUps:I,roundLimit:p}=DS({qualifyingRoundNumber:T,qualifyingPositions:C,matchUpType:E,drawSize:P,idPrefix:a,isMock:o,uuids:s})),h=hI({structureName:u.structureName||x,structureId:R||s?.pop(),qualifyingRoundNumber:p,hasExistingDrawDefinition:e,stage:Yo,qualifyingOnly:i,matchUpFormat:b,stageSequence:y,matchUpType:E,roundLimit:p,tieFormat:n,matchUps:I}),g&&Uu({extension:{name:Wu,value:g},element:h}),w=I?.filter(e=>e.roundNumber===p)?.length||0;if(y>1){let{link:e}=vS({sourceStructureId:S,sourceRoundNumber:U,targetStructureId:h.structureId,finishingPositions:v===ms?[1]:void 0,linkType:v});l.push(e),f+=(P||0)-w}else f+=P||0;v=A===_s?ms:fs,S=h.structureId,U=p,n&&(I=Bf({structure:h})?.matchUps||[],I?.forEach(e=>{let{tieMatchUps:t}=yS({tieFormat:n,matchUp:e,isMock:o});Object.assign(e,{tieMatchUps:t,matchUpType:E})})),d.push(h),y+=1}h+=w,u.push({qualifiersCount:w,finalQualifyingRoundNumber:U,finalQualifyingStructureId:S,finishingPositions:c,roundTarget:g,linkType:v}),g+=1}return{qualifiersCount:h,qualifyingDrawPositionsCount:f,qualifyingDetails:u,structures:d,...ce,links:l}}function Wy({drawSize:e,qualifyingRoundNumber:t}){let r=e,i=0;for(;i<t;)r=Math.floor(r/2),i+=1;return r}function Hy(e){let{drawTypeCoercion:t,enforceMinimumDrawSize:r}=e,i=I(e.drawSize),n=t&&e.drawType!==Is&&("boolean"==typeof t||t<=2)&&2===i&&ys||e.drawType||ys,a=Ws.includes(n);if(i&&a)if(t&&("boolean"==typeof t&&i<4||i<=t))n=ys;else if(i<4&&r)return{...Pn({context:{enforceMinimumDrawSize:r,drawSize:i,drawType:n},result:{error:Le},stack:"getCoercedDrawType"}),drawType:n};return{drawType:n}}function Yy({structureName:e,matchUpType:t,idPrefix:r,drawSize:i,isMock:n,uuids:a}){let o=[],{matchUps:s}=AS({linkFedFinishingRoundNumbers:[1],drawSize:i+1,matchUpType:t,idPrefix:r,isMock:n}),c=fI({structureName:e||II(Ho),structureId:a?.pop(),stageSequence:1,stage:Ho,matchUpType:t,matchUps:s});o.push(c);let u=i/2,{matchUps:d}=AS({finishingPositionOffset:u,idPrefix:r&&`${r}-c`,drawSize:i-1,isConsolation:!0,matchUpType:t,isMock:n,uuids:a}),l=fI({structureName:II(Vs),matchUps:d,structureId:a?.pop(),stage:zo,stageSequence:2,matchUpType:t});o.push(l);let{matchUps:p}=DS({idPrefix:r&&`${r}-p1t2`,drawSize:2,matchUpType:t,isMock:n}),m=fI({structureName:II(Bs),matchUps:p,structureId:a?.pop(),stageSequence:3,stage:Jo,matchUpType:t});o.push(m);let f=function({mainStructure:e,consolationStructure:t,deciderStructure:r}){let i=t.matchUps.reduce((e,t)=>(t.drawPositions||[]).filter(Boolean).length&&!e.includes(t.roundNumber)?e.concat(t.roundNumber):e,[]),n=e.matchUps.reduce((e,t)=>!e||t.roundNumber>e?t.roundNumber:e,void 0),a=t.matchUps.reduce((e,t)=>!e||t.roundNumber>e?t.roundNumber:e,void 0);return[...i.map((r,n)=>{let a=i.indexOf(r)%2?ls:ps;return{linkType:hs,source:{roundNumber:1+n,structureId:e.structureId},target:{feedProfile:a,roundNumber:r,structureId:t.structureId}}}),{linkType:fs,source:{roundNumber:a,structureId:t.structureId},target:{feedProfile:ls,roundNumber:n,structureId:e.structureId}},{linkType:fs,source:{roundNumber:n,structureId:e.structureId},target:{feedProfile:ls,roundNumber:1,structureId:r.structureId}},{linkType:hs,source:{roundNumber:n,structureId:e.structureId},target:{feedProfile:ls,roundNumber:1,structureId:r.structureId}}]}({mainStructure:c,consolationStructure:l,deciderStructure:m});return{structures:o,links:f,...ce}}function zy(e){let{qualifyingRoundNumber:t,finishingPositionOffset:r,qualifyingPositions:i,matchUpType:n,idPrefix:a,drawSize:o,isMock:s,uuids:c}=e;if(!F(o)||o<2)return{matchUps:[],roundsCount:0};if(M(o))return DS(e);let u=function(e){let t=I(e),r=t%2?t+1:t,i=!!(Math.ceil(r/2)%2),n=[{participantsCount:r,preFeedRound:i}];for(;r>2;){let e=Math.ceil(r/2),t=1===e,i=!(t||!(e%2));r=!t&&i?e+1:e;let a=!!(2!==r&&Math.ceil(r/2)%2);n.push({participantsCount:r,preFeedRound:a,feedRound:i})}return n}(o),d=u.shift(),l=K(1,(d?.participantsCount||0)+1).map(e=>({drawPosition:e})),p=[],m=1;({matchUps:p}=TS({roundNumber:m,matchUpType:n,idPrefix:a,matchUps:p,isMock:s,nodes:l,uuids:c})),m++;let f=e.roundLimit||t;for(let g of u){let e=g.participantsCount/2,t=K(1,e+1);i&&e===i&&(f=m-1);let r=t.map(e=>{let t=PS({roundPosition:e,roundNumber:m,idPrefix:a,uuids:c});return{roundPosition:e,roundNumber:m,matchUpId:t}});p.push(...r),m++}let h=m-1;return p=ah({finishingPositionOffset:r,lucky:!0,roundsCount:h,roundLimit:f,matchUps:p}),f&&(p=p.filter(e=>e.roundNumber<=f)),{matchUps:p,roundsCount:h,roundLimit:f}}function Ky(e){let{playoffAttributes:t,stageSequence:r=1,stage:i=Ho,tieFormat:n,matchUpType:a,drawSize:o,uuids:s}=e,c=e.structureId||(e.isMock||e.idPrefix?`${e.drawDefinition.drawId}-s-0`:void 0)||s?.pop(),u=e.appliedPolicies??up(e),d=e.policyDefinitions?.[pu]||u?.[pu];e.skipRounds=e.skipRounds||o<=4&&(d?.feedFromMainFinal?0:1)||0;let l=e.structureName??t?.[0]?.name??II(Ho);return{generators:{[Is]:()=>({structures:[hI({finishingPosition:$s,stageSequence:r,structureName:l,matchUps:[],matchUpType:a,structureId:c,stage:i})],links:[],...ce}),[Ds]:()=>{let{matchUps:t}=zy(e);return{structures:[hI({stageSequence:r,structureName:l,matchUpType:a,structureId:c,matchUps:t,stage:i})],links:[],...ce}},[ys]:()=>(()=>{let{matchUps:t}=DS(e);return{structures:[hI({stageSequence:r,structureName:l,matchUpType:a,structureId:c,tieFormat:n,matchUps:t,stage:i})],links:[],...ce}})(),[ws]:()=>Yy(e),[Ss]:()=>ES({...e,roundOffsetLimit:3,playoffAttributes:t??Gs}),[vs]:()=>ES({...e,roundOffsetLimit:2,playoffAttributes:t??js}),[Jo]:()=>ES(e),[Us]:()=>{let{matchUps:e}=AS({drawSize:o,uuids:s,matchUpType:a});return{structures:[hI({stageSequence:r,structureName:l,matchUpType:a,structureId:c,stage:Ho,tieFormat:n,matchUps:e})],links:[],...ce}},[Ts]:()=>VS(e),[Ps]:()=>$S({...e,feedRounds:1,fmlc:!0}),[ks]:()=>$S({...e,feedRounds:1}),[Rs]:()=>$S({...e,feedsFromFinal:1}),[As]:()=>$S({...e,feedsFromFinal:2}),[Cs]:()=>$S({...e,feedsFromFinal:3}),[xs]:()=>$S(e),[bs]:()=>jS(e),[_s]:()=>TI(e),[Ls]:()=>function(e){let{drawDefinition:t,structureOptions:r,requireSequential:i}=e,n={structureName:II(Ho),...e,stage:Ho},{structures:a,groupCount:o,groupSize:s}=TI(n);if(o<1)return{error:li};let c=r?.playoffGroups||[{finishingPositions:[1],structureName:II(Jo)}],[u]=a,{structures:d,links:l}=qS({sourceStructureId:u.structureId,requireSequential:i,drawDefinition:t,playoffGroups:c,groupCount:o,groupSize:s,...e});return d&&a.push(...d),{...ce,structures:a,links:l}}(e)}}}function Jy(e){let{enforceMinimumDrawSize:t=!0,overwriteExisting:r,appliedPolicies:i,qualifyingOnly:n,staggeredEntry:a,drawDefinition:o,tieFormat:s,isMock:c,uuids:d}=e||{},l=I(e.drawSize),p=e.drawTypeCoercion??Ly({appliedPolicies:i,drawType:e.drawType}),m=Hy({drawType:e.drawType,enforceMinimumDrawSize:t,drawTypeCoercion:p,drawSize:l});if(m.error)return m;let f=m.drawType,h=[],g=[],U=e?.matchUpType??u,S=o?.structures?.filter(({stage:e})=>e===Yo);S&&h.push(...S);let v=S?.map(({structureId:e})=>e),y=o?.structures?.find(({stage:e,stageSequence:t})=>e===Ho&&1===t),w=o?.links?.filter(e=>e.target.structureId===y?.structureId&&v?.includes(e.source.structureId)),P=(e,t)=>{if(e.linkType===ms&&t?.structures){let r=e.source.finishingPositions||[];return t.structures.length*r.length}if(e.linkType===fs&&t?.matchUps?.length){let r=e.source.roundNumber;return t.matchUps.filter(({roundNumber:e})=>e===r).length}},T=S?.map(e=>{let t=w?.find(t=>t.target.structureId===e.structureId),r=$d({structure:e})?.positionAssignments?.length??0;if(!t)return r;let i=t?.source.structureId,n=o.structures?.find(e=>e.structureId===i);return r-(P(t,n)||0)}).filter(Boolean).reduce((e,t)=>e+t,0),D=w?.map(e=>{let t=e.source.structureId,r=S?.find(e=>e.structureId===t);return P(e,r)}).filter(Boolean).reduce((e,t)=>e+t,0),b=!(!y||y?.matchUps?.length);if(S?.length&&!b)return{error:Ri};let R=!S?.length&&e.qualifyingProfiles,N=R?.length&&qy({idPrefix:e.idPrefix,qualifyingProfiles:R,appliedPolicies:i,qualifyingOnly:n,tieFormat:s,isMock:c,uuids:d});if(N?.error)return N;let{qualifyingDrawPositionsCount:A,qualifyingDetails:E,qualifiersCount:C}=N||{qualifyingDrawPositionsCount:T,qualifiersCount:D};A&&(N?.structures&&h.push(...N.structures),N?.links&&g.push(...N.links)),Object.assign(e,wn({drawSize:l,matchUpType:U,tieFormat:s}));let O=f!==Is&&(!l||l<2||!a&&![Us,Ds].includes(f)&&([Ls,_s].includes(f)&&l<3||![_s,Ls].includes(f)&&!M(l)));if(O&&!A)return Pn({context:{drawSize:l,invalidDrawSize:O},result:{error:Le},stack:"generateDrawStructuresAndLinks"});let{generators:k,error:F}=Ky(e);if(F)return{error:F};let x=k[f];if(!x)return{error:Ee};let _=x?.();if(_.error)return _;let{structures:L,links:B}=_;if(L?.length){let e=L.find(({stage:e,stageSequence:t})=>e===Ho&&1===t);if(y&&e)if(b){let t=e.structureId;if(e.structureId=y.structureId,B?.length)for(let e of B)e.source.structureId===t&&(e.source.structureId=y.structureId),e.target.structureId===t&&(e.target.structureId=y.structureId)}else if(!r)return{error:Ri};h.push(...L)}h.sort(Ld),B?.length&&g.push(...B);let V=_.structures.find(({stage:e,stageSequence:t})=>e===Ho&&1===t);for(let u of E||[]){let{finalQualifyingRoundNumber:e,finalQualifyingStructureId:t,roundTarget:r,finishingPositions:i,linkType:n}=u,a=V&&vS({targetStructureId:V.structureId,sourceStructureId:t,sourceRoundNumber:e,finishingPositions:i,targetEntryRound:r,linkType:n})?.link;if(a?.error)return a;a&&g.push(a)}return w&&g.push(...w),{...ce,qualifyingResult:{qualifyingDrawPositionsCount:A,qualifiersCount:C},structures:h,links:g}}function Qy(e){let{modifyOriginal:t=!0,stageSequence:r=1,isMock:i}=e||{},n="generateDrawTypeAndModifyDrawDefinition";if(!e.drawDefinition)return Pn({result:{error:ye},stack:n});let a=t?e.drawDefinition:Wa(e.drawDefinition,!1,!0),{tieFormat:o,matchUpType:s}=e;if(o){let e=Ba({tieFormat:o});if(e.error)return e}o=nv(o??zp({drawDefinition:a})?.tieFormat),s=s??(a.matchUpType||u),e.tieFormat=o,e.matchUpType=s;let c=Lg({drawDefinition:a,stage:Ho});e.drawSize=e.drawSize??c,!c&&e.drawSize&&JU({drawSize:e.drawSize,drawDefinition:a,stageSequence:r,stage:Ho});let d=Kp({drawDefinition:a}).drawMatchUps.map(ld),l=Jy(e);if(l.error)return Pn({result:l,stack:n});let{structures:p,links:m,qualifyingResult:f}=l;a.structures=p,a.links=m;let h=Math.max(e.qualifiersCount??0,f?.qualifiersCount||0);if(f?.qualifyingDrawPositionsCount&&!Lg({stage:Yo,drawDefinition:a})){let e=JU({drawSize:f.qualifyingDrawPositionsCount,stage:Yo,drawDefinition:a});if(e.error)return e}if(h){let e=QU({qualifiersCount:h,drawDefinition:a,stage:Ho});if(e.error)return e}let g=e.drawSize??c;Object.assign(e,wn({drawSize:g,matchUpType:s,tieFormat:o}));let{matchUps:I,matchUpsMap:U}=Kf({drawDefinition:a});o&&I?.forEach(e=>{if(!d.includes(e.matchUpId)){let{tieMatchUps:t}=yS({tieFormat:o,matchUp:e,isMock:i});Object.assign(e,{tieMatchUps:t,matchUpType:s})}});let{inContextDrawMatchUps:S}=oh({drawDefinition:a,matchUpsMap:U});return Ml({tournamentId:e.tournamentRecord?.tournamentId,drawDefinition:a}),{inContextDrawMatchUps:S,drawDefinition:a,matchUpsMap:U,...ce,structures:p,matchUps:I,links:m}}function Xy(e){let t,r,{removePriorValues:i,tournamentRecord:n,participantId:a,scaleItem:o}=e;if(!ew({scaleItem:o}))return{error:oi};if(a&&Array.isArray(n.participants)&&(r=n.participants.find(e=>e.participantId===a),r)){if(r.participantType===Bl&&o?.eventType!==qo)return{error:oi};let e=tw({removePriorValues:i,participant:r,scaleItem:o});if(e.error)return e;t=!e.valueChanged;let{topics:a}=cn();a.includes(sl)&&rn({topic:sl,payload:{tournamentId:n.tournamentId,participants:[r]}})}return t&&{...ce,info:yi,existingValue:o?.scaleValue}||r&&{...ce,newValue:o?.scaleValue}||{error:Sr}}function Zy(e){let{scaleItemsWithParticipantIds:t=[],removePriorValues:r,tournamentRecord:i,auditData:n,context:a}=e;if(!i)return{error:Ie};if(!i.participants)return{error:gr};let o=0,s={},c=[];for(let l of t){let e=l?.participantId;if(Array.isArray(l?.scaleItems))for(let t of l.scaleItems){if(!ew({scaleItem:t}))return{error:oi};Array.isArray(s[e])||(s[e]=[]),s[e].push(t)}}for(let l of i.participants){let{participantId:e}=l||{};if(Array.isArray(s[e]))for(let t of s[e]){if(l.participantType===Bl&&t?.eventType!==qo)return Pn({context:{participantId:e,scaleItem:t,participantType:l.participantType},info:"Invalid participantType for eventType",result:{error:oi}});tw({participant:l,scaleItem:t,removePriorValues:r}),c.push(l),o++}}let u=o?void 0:ci,{topics:d}=cn();if(d.includes(sl)&&o&&rn({topic:sl,payload:{tournamentId:i.tournamentId,participants:c}}),a){let{eventId:e,drawId:t,...r}=a,n=r.scaleAttributes?.scaleType&&[r.scaleAttributes.scaleType];if(Object.keys(r).length){let a={itemType:zd,itemValue:r};if(n&&(a.itemSubTypes=n),t||e){let{drawDefinition:r,event:n}=Af({tournamentRecord:i,eventId:e,drawId:t});t&&WU({drawDefinition:r,timeItem:a}),e&&fv({event:n,timeItem:a})}else mv({tournamentRecord:i,timeItem:a})}}return n&&d.includes(Qd)&&rn({topic:Qd,payload:n}),wn({...ce,modificationsApplied:o,info:u})}function ew({scaleItem:e}){let t=e&&Object.keys(e),r=["scaleType","eventType","scaleName"];return!(r.filter(e=>t?.includes(e)).length!==r.length)}function tw({removePriorValues:e,participant:t,scaleItem:r}){if(!t)return{error:hr};let i=r&&Object.keys(r),n=["scaleType","eventType","scaleName"];if(n.filter(e=>i.includes(e)&&r[e]).length!==n.length)return{error:oi};let a=(new Date).toISOString();t.timeItems||(t.timeItems=[]);let{scaleItem:o}=hg({scaleAttributes:r,participant:t}),s=e=>[void 0,null,""].includes(e),c=!(s(o?.scaleValue)&&s(r.scaleValue))&&JSON.stringify(o?.scaleValue)!==JSON.stringify(r.scaleValue);if(c){let{scaleType:i,eventType:n,scaleName:o}=r,s=[zc,i,n,o].join("."),c=wn({itemValue:r.scaleValue,itemDate:r.scaleDate,createdAt:a,itemType:s});r.scaleId&&(c.itemSubTypes=[r.scaleId]),e&&(t.timeItems=t.timeItems.filter(e=>e.itemType!==s)),t.timeItems.push(c)}return{...ce,valueChanged:c,newValue:r.scaleValue}}function rw(e){let{tournamentRecord:t,modifiedScaleValues:r,removePriorValues:i}=e,n=$c(e,[{[Js]:!0},{modifiedScaleValues:!0,[_c]:Cc}]);if(n.error)return n;for(let a in r){let e=Xy({scaleItem:r[a],removePriorValues:i,tournamentRecord:t,participantId:a});if(e.error)return e}return{...ce}}var iw={nSpread:400,diffThreshold:.125,kCalc:(e=0)=>250/Math.pow(e+5,.4),kMultiplier:function(e=3,t=2){let r=e/t;return Number.isNaN(r)?iw.kDefault():r},kDefault:()=>1};function nw(e){let{winnerRating:t,loserRating:r}=e,{ratings:i=qh,winnerCountables:n=1,loserCountables:a=0,ratingType:o="ELO",maxCountables:s,countables:c}=e||{},u=i?.[o];if(!u)return{error:$t};let d=u.range||e.ratingRange;t=t||u.defaultInitialization,r=r||u.defaultInitialization;let l=d[0]>d[1],p=u.decimalsCount||0,m=l?d.slice().reverse():d,f=(e,t)=>Number.parseFloat(t)>=Math.min(...e)&&Number.parseFloat(t)<=Math.max(...e);(!f(d,t)||!f(d,r))&&(f(d,t)||(t=u.defaultInitialization),f(d,r)||(r=u.defaultInitialization));let h=Oh({targetRange:qh.ELO.range,sourceRange:m,value:l?d[0]-t:t}),g=Oh({targetRange:qh.ELO.range,sourceRange:m,value:l?d[0]-r:r}),I=(e,t)=>1/(1+Math.pow(10,(t-e)/iw.nSpread)),U=I(h,g),S=I(g,h),v=iw.kCalc(n),y=iw.kCalc(a),w=iw.kMultiplier(s,c),P=h+w*v*(1-U),T=g+w*y*(0-S),D=Oh({sourceRange:qh.ELO.range,value:P,targetRange:m}),b=Oh({sourceRange:qh.ELO.range,value:T,targetRange:m}),M=l?d[0]-D:D,R=Number.parseFloat(M.toFixed(p)),N=l?d[0]-b:b,A=Number.parseFloat(N.toFixed(p)),E=Math.max(...d)?Math.abs(t-r)/Math.max(...d):0;return(D>b&&E>iw.diffThreshold||R<0||A<0)&&(R=t,A=r),{newWinnerRating:R,newLoserRating:A}}var aw=e=>e?.reduce((e,t)=>(t.winningSide&&(e[t.winningSide-1]+=1),e),[0,0])||[0,0];function ow(e){let t=$c(e,[{[Js]:!0},{matchUpIds:!0,[_c]:Oc,[Dc]:Rt},{ratingType:!1,[kc]:e=>qh[e]}]);if(t.error)return t;let{updateParticipantRatings:r,removePriorValues:i=!0,tournamentRecord:n,ratingType:a="ELO",refreshDynamic:o,considerGames:s,drawDefinition:c,matchUpIds:u,asDynamic:d}=e,l=qh[a],{accessor:p}=l,m={},f=(e.matchUps||o&&th({drawDefinition:c,tournamentRecord:n,inContext:!0,matchUpFilters:{matchUpStatuses:kd}}).matchUps||Xf({matchUpFilters:{matchUpIds:u,matchUpStatuses:kd},tournamentRecord:n,inContext:!0}).matchUps)??[],h=`${a}.${Wc}`,g=d?h:a;f.sort(eh);for(let U of f){let{endDate:e,matchUpFormat:t,score:c,sides:u,winningSide:d}=U,l=U.matchUpType,f={eventType:l,scaleName:a,scaleType:Yc},I={scaleName:h,eventType:l,scaleType:Yc},S=Object.assign({},...(u??[]).map(e=>{let{sideNumber:t,participant:r}=e;return t&&{[t]:[r?.participantId,...r?.individualParticipantIds??[]].filter(Boolean).flat()}})),v=Object.assign({},...Object.values(S).flat().map(t=>{let r=!o||m[t]?Eg({scaleAttributes:I,tournamentRecord:n,participantId:t}).scaleItem:void 0,i=Eg({tournamentRecord:n,scaleAttributes:f,participantId:t}).scaleItem,a=p?{[p]:void 0}:void 0;return t&&{[t]:r??i??{scaleName:g,eventType:l,scaleDate:e,scaleType:Yc,scaleValue:a}}})),y=t?Yn(t):{},w=y?.bestOf||1,P=s?w&(y?.setsTo||1):w,T=c?.sets&&aw(c.sets)||1===d&&[1,0]||[0,1],D=d?S[d]:[],b=d?S[3-d]:[];for(let r of D){let e=v[r]?.scaleValue,t="object"==typeof e?e[p]:e;for(let i of b){let n=v[i]?.scaleValue,o="object"==typeof n?n[p]:n,s=d?T[d]:[0,0],c=d?T[3-d]:[0,0],{newWinnerRating:u,newLoserRating:l}=nw({winnerCountables:s,loserCountables:c,maxCountables:P,winnerRating:t,loserRating:o,ratingType:a}),m=p?{...e,[p]:u}:u,f=p?{...n,[p]:l}:l;v[r].scaleValue=m,v[i].scaleValue=f,v[r].scaleName=g,v[i].scaleName=g}}Object.assign(m,v),r&&rw({tournamentRecord:n,modifiedScaleValues:m,removePriorValues:i})}let I=f.map(({matchUpId:e})=>e);return{...ce,modifiedScaleValues:m,outputScaleName:g,processedMatchUpIds:I}}function sw(e){let{matchUpIds:t=[],drawDefinition:r,roundNumber:i,newRound:n,isMock:a,event:o}=e;if("object"!=typeof r)return{error:ye};let{participantIdPairings:s,matchUpsCount:c}=e,u=Fv(e);if(u.error)return Pn({result:u});let{lastRoundNumber:d,availableMatchUpsCount:l=0,roundMatchUpsCount:p=0}=u;if(c){if(c>p&&!1!==e.restrictMatchUpsCount)return Pn({result:{error:gi,info:"matchUpsCount error",context:{roundMatchUpsCount:p}}})}else n?c=p:l>0&&(c=l);if(s&&!Array.isArray(s)||c&&!F(c)||t&&!Array.isArray(t)||!s&&!c)return{error:gi,info:"matchUpsCount or pairings error"};if(c&&!1!==e.restrictMatchUpsCount&&c>32)return{error:gi,info:"matchUpsCount must be less than 33"};if(i&&!e.ignoreLastRoundNumber&&i-1>(d||0))return{error:gi,info:"roundNumber error"};let f=i??(n&&(d??0)+1||d||1);s=s??K(0,c).map(()=>({participantIds:[void 0,void 0]}));let h=s?.map((i,n)=>{let a=i?.participantIds??[void 0,void 0];a.push(void 0,void 0);let o=a.slice(0,2).map((e,t)=>wn({sideNumber:t+1,participantId:e})),s=t[n]??(t=>{if(!e.idPrefix)return;return`${r.drawId}-${e.idPrefix??"ah"}-${f}-${t}`})(n)??za();return{roundNumber:f,matchUpStatus:Md,matchUpId:s,sides:o}});if(h?.length){let e=zp({drawDefinition:r,event:o})?.tieFormat;e&&h.forEach(t=>{let{tieMatchUps:r}=yS({tieFormat:e,matchUp:t,isMock:a});Object.assign(t,{tieMatchUps:r,matchUpType:m})})}return{roundNumber:f,matchUpsCount:h?.length??0,matchUps:h,...ce}}function cw(e){return e.participantIdPairings.map(({participantIds:e})=>e.sort().join("|")).sort().join("/")}function uw({valueSortedPairings:e,stipulated:t=[],pairingValueMap:r,deltaObjects:i,valueObjects:n,actorsCount:a}){let o=t.flat(),s=[],c=0;t.filter(Boolean).forEach(e=>{let[t,i]=e,n=dw(t,i),a=r[n];s.push({participantIds:e,value:a}),c+=r[n]}),re(e,a).flatMap(e=>V(e).map(e=>({...e,value:e.value+Math.random()*Math.round(Math.random())}))).forEach(e=>{let t=e.pairing.split("|");if(!t.reduce((e,t)=>o.includes(t)||e,!1)){o.push(...t);let r=e.value;c+=r,s.push({participantIds:t,value:r})}}),s.sort((e,t)=>e.value-t.value);let u=s.reduce((e,t)=>{let[r,n]=t.participantIds,a=dw(r,n),o=i[a];return Math.max(o,e)},0),d=s.reduce((e,t)=>{let[r,i]=t.participantIds,a=dw(r,i),o=n[a];return Math.max(o,e)},0);return{value:c,participantIdPairings:s,maxDelta:u,maxDiff:d}}function dw(e,t){return[e,t].sort(Mg).join("|")}function lw({participantIds:e}){let t={},r=[];e.forEach(i=>{t[i]=e.filter(e=>e!==i),t[i].forEach(e=>{let t=dw(e,i);r.includes(t)||r.push(t)})});let i=Object.assign({},...r.map(e=>({[e]:0})));return{uniquePairings:r,possiblePairings:t,deltaObjects:i}}function pw(e){let{tournamentParticipants:t,adHocRatings:r={},possiblePairings:i,uniquePairings:n,maxIterations:a,minimizeDelta:o,deltaObjects:s,valueObjects:c,eventType:u,scaleName:d,salted:l}=e;n.forEach(e=>{let i=function({tournamentParticipants:e,adHocRatings:t,eventType:r,scaleName:i,pairing:n}){let a=qh[i]?.defaultInitialization??0;return n.split("|").map(i=>{if(r===Go){let r=e?.find(e=>e.participantId===i)?.individualParticipantIds;return r?r?.map(e=>t[e]||a):2*a}return t[i]||a})}({tournamentParticipants:t,adHocRatings:r,scaleName:d,eventType:u,pairing:e}),n="number"==typeof l&&l||.5,a=l&&(Math.round(Math.random())?n:-1*n)||0,o=Math.abs(i[0]-i[1])+a,p=Math.abs(i[0]-i[1]);s[e]=p,c[e]||(c[e]=0),c[e]+=o?Math.pow(o,2):0});let p=n.map(e=>({pairing:e,value:c[e]})).sort((e,t)=>e.value-t.value),{pairingValues:m}=function({possiblePairings:e,valueObjects:t}){let r={};for(let n of Object.keys(e)){let t=e[n].map(e=>i(n,e));r[n]=t.sort((e,t)=>e.value-t.value)}function i(e,r){let i=dw(e,r);return{opponent:r,value:t[i]}}return{pairingValues:r}}({possiblePairings:i,valueObjects:c}),{candidate:f,candidatesCount:h,deltaCandidate:g,iterations:I}=function({maxIterations:e=4e3,valueSortedPairings:t,pairingValues:r,valueObjects:i,deltaObjects:n}){let a=Object.assign({},...t.map(e=>({[e.pairing]:e.value}))),o=Object.keys(r),s=[],c=uw({actorsCount:o.length,valueSortedPairings:t,pairingValueMap:a,deltaObjects:n,valueObjects:i}),u=[cw(c)];s.push(c);let d,l=c.value,p=c,m=1,f=0,h=o.length;do{h-=1,d=o.length*r[o[0]].length}while(d>e&&h>5);let g=[];o.forEach(e=>{r[e].slice(0,h).forEach(r=>{f+=1;let c=dw(e,r.opponent);if(!g.includes(c)){let d=uw({stipulated:[[e,r.opponent]],actorsCount:o.length,valueSortedPairings:t,pairingValueMap:a,deltaObjects:n,valueObjects:i});if(!u.includes(cw(d))){u.push(cw(d)),s.push(d);let{maxDelta:e,value:t}=d;e<p.maxDelta&&(p=d),(t<l||t===l&&Math.round(Math.random()))&&(l=t),g.push(c),m+=1}}}),s=s.filter(e=>Math.abs(e.value-l)<5)}),s.sort((e,t)=>e.maxDiff-t.maxDiff);let I=Y(s);return{candidatesCount:m,deltaCandidate:p,maxIterations:e,iterations:f,candidate:I}}({valueSortedPairings:p,maxIterations:a,pairingValues:m,deltaObjects:s,valueObjects:c}),{participantIdPairings:U}=o?g:f;return{participantIdPairings:U,candidatesCount:h,deltaCandidate:g,iterations:I,candidate:f}}var mw=100,fw=100,hw=4e3;function gw(e){let{encounterValue:t=mw,sameTeamValue:r=fw,maxIterations:i=hw,updateParticipantRatings:n,generateMatchUps:a=!0,ignoreLastRoundNumber:o,iterationMatchUps:s,tournamentRecord:c,dynamicRatings:u,refreshDynamic:d,participantIds:l,drawDefinition:p,roundNumber:m,structureId:f,matchUpIds:h,eventType:g,scaleName:I,idPrefix:U,isMock:S,salted:y,event:w}=e;if(!p)return{error:ye};if(!e.structure&&!f)return{error:et};let P=e.structure||Vd({drawDefinition:p,structureId:f}).structure;if(!v(P))return{error:rt};if(!l?.length)return{error:wr};let T=[...s??[],...P?.matchUps??[]],{encounters:D}=function({matchUps:e}){let t=[];for(let r of e){let e=r.sides.map(dd);if(2===e.length){let[r,i]=e,n=dw(r,i);t.includes(n)||t.push(n)}}return{encounters:t}}({matchUps:T}),b=c?.participants??[],M={};if(u){let e=L(P?.matchUps?P.matchUps.map(({roundNumber:e})=>e):[]),t=Math.max(...e,0);if(t){let e=P?.matchUps?.filter(({roundNumber:e})=>e===t).map(({matchUpId:e})=>e),r=ow({ratingType:I??w?.category?.ratingType,updateParticipantRatings:n,tournamentRecord:c,asDynamic:!0,refreshDynamic:d,drawDefinition:p,matchUpIds:e});if(r.error)return r;r.modifiedScaleValues&&(M=r.modifiedScaleValues)}}let R,N,{valueObjects:A}=function({encounters:e,tournamentParticipants:t,encounterValue:r,sameTeamValue:i}){let n={};for(let o of e)n[o]||(n[o]=0),n[o]+=r;let a=t?.filter(({participantType:e})=>e===$l);if(a)for(let o of a){let e=o.individualParticipantIds??[],{uniquePairings:t}=lw({participantIds:e});for(let r of t)n[r]||(n[r]=0),n[r]+=i}return{valueObjects:n}}({tournamentParticipants:b,encounterValue:t,sameTeamValue:r,encounters:D}),{uniquePairings:E,possiblePairings:C,deltaObjects:O}=lw({participantIds:l}),k={tournamentParticipants:b,possiblePairings:C,participantIds:l,uniquePairings:E,drawDefinition:p,maxIterations:i,adHocRatings:Object.values(M).length?M:e.adHocRatings,deltaObjects:O,valueObjects:A,eventType:g,scaleName:I,structure:P,salted:y},{candidatesCount:F,participantIdPairings:x,deltaCandidate:_,iterations:B,candidate:V}=pw(k);if(!F)return{error:di};if(a){let e=sw({structureId:P?.structureId,ignoreLastRoundNumber:o,participantIdPairings:x,newRound:!0,drawDefinition:p,roundNumber:m,matchUpIds:h,idPrefix:U,isMock:S,event:w});if(e.error)return e;R=e.roundNumber,N=e.matchUps}let{maxDelta:G,maxDiff:j}=V;return{roundNumber:R,participantIdPairings:x,modifiedScaleValues:M,candidatesCount:F,deltaCandidate:_,...ce,iterations:B,matchUps:N,maxDelta:G,maxDiff:j}}function Iw(e){let{drawType:t=ys,attachConsolation:r=!0,applyPositioning:i=!0,tournamentRecord:n,staggeredEntry:a,automated:o,placeByes:s,isMock:c,event:u}=e,d=e?.drawDefinition;if(!d)return{error:ye};let l=Ko,p=qp({stageSequence:1,drawDefinition:d,stage:l}),m=[_s,ws,Ls].includes(t)?p.length:O(p.length);if(!a&&t===Us&&p.length<2||t===_s&&p.length<3)return{error:Le};let{tieFormat:f,matchUpType:h}=e;if(f){let e=Ba({tieFormat:f});if(e.error)return e}f=nv(f??zp({drawDefinition:d})?.tieFormat),h=h??d.matchUpType;let{structures:g}=Gd({stageSequence:1,drawDefinition:d,stage:l});if(g.length>1)return{error:ft};if(g?.[0]?.matchUps?.length)return{error:Ni};let I=g?.[0]?.structureId;Object.assign(e,wn({structureName:e.structureName??II(Ko),structureId:I,matchUpType:h,tieFormat:f,drawSize:m,stage:l}));let U=Ky(e);if(U.error)return U;let S=U.generators[t];if(!S)return{error:Ee};let v=S?.();if(v.error)return v;let{structures:y,links:w}=v,P=y.flatMap(e=>Bf({structure:e}).matchUps);f&&P.forEach(e=>{let{tieMatchUps:t}=yS({matchUp:e,tieFormat:f,isMock:c});Object.assign(e,{tieMatchUps:t,matchUpType:h})}),(!i||!r)&&(d=Wa(d,!1,!0)),d.links??=[],w.length&&d.links.push(...w);let T=new Set(y.map(({structureId:e})=>e));d.structures??=[];let D=new Set(d.structures.map(({structureId:e})=>e));d.structures=d.structures.map(e=>T.has(e.structureId)?y.find(({structureId:t})=>t===e.structureId):e);let b=y.filter(({structureId:e})=>!D.has(e));return b.length&&d.structures.push(...b),o&&kU({seedingProfile:e.seedingProfile,applyPositioning:i,tournamentRecord:n,drawDefinition:d,structureId:I,placeByes:s,drawSize:m,event:u}),r&&Ml({drawDefinition:d}),{links:w,structures:y,...ce}}var Uw={};n(Uw,{ScoringEngine:()=>oP,addPoint:()=>Fw,analyzeScore:()=>PT,analyzeSequence:()=>zT,analyzeSet:()=>NT,calculateMatchStatistics:()=>Zw,calculatePointsTo:()=>bw,checkScoreHasValue:()=>ch,checkSetIsComplete:()=>GP,createMatchUp:()=>Pw,deduceMatchUpFormat:()=>ET,enrichPointHistory:()=>eP,exportMatchUpJSON:()=>nD,generate:()=>Sw,generateScoreString:()=>vw,generateTieMatchUpScore:()=>rv,getEpisodes:()=>Ww,getQuickStats:()=>tP,getScore:()=>Gw,getScoreboard:()=>jw,getSetComplement:()=>DT,getSetScoreString:()=>OT,getTiebreakComplement:()=>bT,getWinner:()=>$w,groupByMatch:()=>eD,helpers:()=>cP,inferServeSide:()=>Ow,isComplete:()=>qw,isValidMatchUpFormat:()=>ta,keyValueScore:()=>HP,mcpValidator:()=>iD,mutate:()=>sP,parseCSV:()=>ZT,parseMCPPoint:()=>XT,parseMatchUpFormat:()=>Yn,parseScoreString:()=>RT,pbpValidator:()=>FT,pointParser:()=>KT,query:()=>IT,resolvePointValue:()=>kw,reverseScore:()=>ww,shotParser:()=>JT,shotSplitter:()=>WT,stringifyMatchUpFormat:()=>jn,tidyScore:()=>gT,toStatObjects:()=>aP,validateMCPMatch:()=>tD,validateMatchUp:()=>CT,validateMatchUpScore:()=>vT,validateScore:()=>TT,validateSet:()=>kT,validateSetScore:()=>ST,validateTieFormat:()=>Ba});var Sw={};function vw(e){let{winnerFirst:t=!0,setTBlast:r=!0,addOutcomeString:i,reversed:n=!1,matchUpStatus:a,matchUpFormat:o,autoComplete:s,winningSide:c,sets:u}=e;if(!u)return{error:$t,info:"missing sets"};let d=o&&Yn(o),{bestOf:l,finalSetFormat:p,setFormat:m}=d??{},f=n||!(!t||!c||1===c),h=i?function({matchUpStatus:e}){let t={[Dd]:"RET",[Rd]:"WO",[vd]:"DF/DF",[yd]:"WO/WO",[bd]:"SUS",[fd]:"ABN",[Sd]:"DEF",[Ud]:"DR"};return e&&t[e]||""}({matchUpStatus:a}):"",g=u?.sort(yw).map(function(e){let t=l&&e.setNumber===l&&p?p:m,i=e=>E(e?.side1Score)||E(e?.side2Score),n=(I=e,E(I?.side1TiebreakScore)||E(I?.side2TiebreakScore)),a=t?.tiebreakSet||!i(e)&&n,{side1Score:o,side2Score:c,side1TiebreakScore:u,side2TiebreakScore:d}=e,h=u||(E(u)||n&&s?0:""),g=d||(E(d)||n&&s?0:"");var I;if(a){let t=i(e)&&!n,r=t?o:h,a=t?c:g;return`[${(f?[a,r]:[r,a]).join("-")}]`}let U=n?Math.min(h,g):"",S=U===h?1:2,v=E(U)?`(${U})`:"",y=o||(E(o)||s?0:""),w=c||(E(c)||s?0:""),P=e=>r||S!==e?"":v,T=`${y}${P(1)}`,D=`${w}${P(2)}`,b=r&&n?`(${U})`:"",M=f?`${[D,T].join("-")}${b}`:`${[T,D].join("-")}${b}`;return["-"," "].includes(M)&&(M=""),M}).filter(Boolean).join(" ")||"";return h?2===c?`${h} ${g}`:`${g} ${h}`:g}function yw(e,t){return e.setNumber-t.setNumber}function ww(e){if(!e?.score)return{error:$t};let{sets:t}=e.score,r=t.map(e=>{let{side1TiebreakScore:t,side2TiebreakScore:r,winningSide:i,side1Score:n,side2Score:a,setNumber:o}=e;return wn({winningSide:i?3-i:void 0,side1TiebreakScore:r,side2TiebreakScore:t,side1Score:a,side2Score:n,setNumber:o})}),i=e?.setTBlast;return{reversedScore:{sets:r,scoreStringSide1:vw({setTBlast:i,sets:r}),scoreStringSide2:vw({sets:r,reversed:!0,setTBlast:i})},...ce}}function Pw(e){let{matchUpId:t=za(),matchUpFormat:r,participants:i=[],isDoubles:n=!1,matchUpType:a}=e,o=a||(n?"DOUBLES":"SINGLES"),s=i.map((e,t)=>({sideNumber:t+1,participantId:e.participantId,participant:e}));return 0===s.length&&s.push({sideNumber:1},{sideNumber:2}),{matchUpId:t,matchUpFormat:r,matchUpStatus:"TO_BE_PLAYED",matchUpType:o,sides:s,score:{sets:[]},createdAt:(new Date).toISOString()}}function Tw(e){return!!e&&!!e.aggregate}function Dw(e,t){let r=e.bestOf||e.exactly||3,i=Math.ceil(r/2);if(t[0]===i-1&&t[1]===i-1&&e.finalSetFormat){let t=e.finalSetFormat;return t.tiebreakSet?"matchTiebreak":t.timed?"timed":"standard"}let n=e.setFormat;return n?n.tiebreakSet?"tiebreakOnly":n.timed?"timed":"standard":"standard"}function bw(e,t,r,i,n){if("timed"===r||!i)return;let a=function(e){let t=e.score.sets;if(0===t.length)return;let r=t.at(-1);return void 0===r?.winningSide?r:void 0}(e),o=function(e){let t=[0,0];return e.score.sets.forEach(e=>{1===e.winningSide&&t[0]++,2===e.winningSide&&t[1]++}),t}(e),s=t.exactly||t.bestOf||3,c=Math.ceil(s/2),{side1Points:u,side2Points:d}=function(e){if(!e)return{side1Points:0,side2Points:0};let t=e.side1GameScores||[],r=e.side2GameScores||[];if(0===t.length&&0===r.length)return{side1Points:0,side2Points:0};let i=Math.max(t.length,r.length)-1;return{side1Points:t[i]??0,side2Points:r[i]??0}}(a),l=function(e,t,r,i,n,a){if("tiebreakOnly"===i){return Rw(e,t,r.tiebreakSet?.tiebreakTo||11,r.tiebreakSet?.NoAD||!1)}if("matchTiebreak"===i){return Rw(e,t,n.finalSetFormat?.tiebreakSet?.tiebreakTo||10,n.finalSetFormat?.tiebreakSet?.NoAD||!1)}if(a){let i=a.side1Score||0,n=a.side2Score||0,o=r.setTo||6,s=("number"==typeof r.tiebreakAt?r.tiebreakAt:void 0)??o;if(!r.noTiebreak&&i===s&&n===s){return Rw(e,t,r.tiebreakFormat?.tiebreakTo||7,r.tiebreakFormat?.NoAD||!1)}}if("CONSECUTIVE"===n.gameFormat?.type){let e=n.gameFormat.count||3;return[e,e]}return function(e,t,r){let i=r.gameFormat?.NoAD||r.NoAD||!1,n=4;return[Mw(e,t,n,i),Mw(t,e,n,i)]}(e,t,r)}(u,d,i,r,t,a),p=function(e,t,r){if("tiebreakOnly"===r||"matchTiebreak"===r)return e&&e.winningSide,[1,1];let i=e?.side1Score||0,n=e?.side2Score||0,a=t.setTo||6,o=("number"==typeof t.tiebreakAt?t.tiebreakAt:void 0)??a,s=t.noTiebreak||!1,c=t.winBy||2;return[Aw(i,n,a,o,s,c),Aw(n,i,a,o,s,c)]}(a,i,r),m=function(e,t,r,i){if("tiebreakOnly"===i||"matchTiebreak"===i)return[...e];let n=4;return[Ew(e[0],t[0],n),Ew(e[1],t[1],n)]}(l,p,0,r),f=function(e,t,r,i){let n=i.setFormat,a=function(e,t){if(!e)return 24;if(e.tiebreakSet)return e.tiebreakSet.tiebreakTo||11;if(e.timed)return 0;let r=e.setTo||6,i="CONSECUTIVE"===t.gameFormat?.type?t.gameFormat?.count||3:4;return r*i}(n,i);return[Cw(e[0],t[0],r,a),Cw(e[1],t[1],r,a)]}(m,o,c,t),h=function(e,t){if(void 0===t)return!1;let r=1-t;return 1===e[r]}(l,n);return{pointsToGame:l,pointsToSet:m,pointsToMatch:f,gamesToSet:p,isBreakpoint:h}}function Mw(e,t,r,i){if(e>=r-1&&t>=r-1){if(i)return e>t?0:e===t?1:2;let r=e-t;return r>=2?0:1===r?1:2}return e>=r?0:r-e}function Rw(e,t,r,i){return[Nw(e,t,r,i),Nw(t,e,r,i)]}function Nw(e,t,r,i){if(e>=r&&(e-t>=2||i&&e>t))return 0;if(e>=r-1&&t>=r-1){if(i)return e>t?0:e===t?1:2;let r=e-t;return r>=2?0:1===r?1:2}return e>=r?0:r-e}function Aw(e,t,r,i,n,a){if(!n&&e===i&&t===i)return 1;if(e>=r){let r=e-t;return r>=a?0:a-r}let o=r-e;if(t>=r-1&&e>=r-1){if(!n)return Math.max(1,r-e);let i=e-t;return i>=a?0:a-i}return o}function Ew(e,t,r){if(t<=0)return 0;return e+Math.max(0,t-1)*r}function Cw(e,t,r,i){if(t>=r)return 0;return e+Math.max(0,r-t-1)*i}function Ow(e,t,r){if("timed"===r)return;let i=function(e){let t=e.score.sets;if(0===t.length)return;let r=t[t.length-1];return void 0===r.winningSide?r:void 0}(e);return Tw(t)?function(e,t){let r=0;for(let i of e.score.sets)void 0!==i.winningSide&&(void 0!==i.side1TiebreakScore?r+=(i.side1TiebreakScore??0)+(i.side2TiebreakScore??0):r+=(i.side1Score??0)+(i.side2Score??0));if(t&&void 0===t.winningSide){let e=t.side1GameScores||[],i=t.side2GameScores||[];if(e.length>0||i.length>0){let t=Math.max(e.length,i.length)-1;r+=(e[t]??0)+(i[t]??0)}else r+=(t.side1Score??0)+(t.side2Score??0)}return r%2==0?"deuce":"ad"}(e,i):"tiebreakOnly"===r||"matchTiebreak"===r?function(e){if(!e)return"deuce";let t=e.side1GameScores||[],r=e.side2GameScores||[];return 0===t.length&&0===r.length||((t[0]??0)+(r[0]??0))%2==0?"deuce":"ad"}(i):function(e,t,r){if(!r)return"deuce";let i=r.side1GameScores||[],n=r.side2GameScores||[];if(0===i.length&&0===n.length)return"deuce";let a=Math.max(i.length,n.length)-1;return((i[a]??0)+(n[a]??0))%2==0?"deuce":"ad"}(0,0,i)}function kw(e,t){if(!t.length)return 1;for(let{condition:r,value:i}of t)if(r.results&&e.result&&r.results.includes(e.result)||r.strokes&&e.stroke&&r.strokes.includes(e.stroke))return i;return 1}function Fw(e,t,r){if(!v(t)||void 0===t.winner||null===t.winner)return e;let i=e,{winner:n,server:a,timestamp:o}=t;i.history??={points:[]};let s=Yn(e.matchUpFormat);if(!s)throw new Error(`Invalid matchUpFormat: ${e.matchUpFormat}`);let c=s.exactly||s.bestOf||3,u=Math.ceil(c/2),d=i.history.points.length+1,l=i.history.points.length,p=[0,0];i.score.sets.forEach(e=>{1===e.winningSide&&p[0]++,2===e.winningSide&&p[1]++});let m=Dw(s,p),f=p[0]===u-1&&p[1]===u-1,h=f&&s.finalSetFormat?s.finalSetFormat:s.setFormat;void 0===a&&!("RALLY"===h?.tiebreakSet?.modifier||"RALLY"===h?.modifier)&&(a=Bw(i,s,m));let g=t.code;!g&&void 0!==n&&void 0!==a&&(g=n===a?"S":"R");let I={...t,pointNumber:d,winner:n,server:a,timestamp:o||(new Date).toISOString()};g&&(I.code=g),I.index=l;let U=bw(i,s,m,h,a);U&&(I.pointsToGame=U.pointsToGame,I.pointsToSet=U.pointsToSet,I.pointsToMatch=U.pointsToMatch,I.gamesToSet=U.gamesToSet,I.isBreakpoint=U.isBreakpoint);let S=Ow(i,s,m);void 0!==S&&(I.serveSide=S);let y=kw(I,r?.pointMultipliers||[]);switch(1!==y&&(I.scoreValue=y),i.history.points.push(I),"TO_BE_PLAYED"===i.matchUpStatus&&(i.matchUpStatus="IN_PROGRESS"),m){case"tiebreakOnly":!function(e,t,r,i,n,a,o,s=1){let c=xw(e,!0,!1),u=e.score.sets.indexOf(c),d=n.tiebreakSet.tiebreakTo||11,l=n.tiebreakSet.NoAD||!1,p=c.side1GameScores||[],m=c.side2GameScores||[];0===p.length&&0===m.length&&(p.push(0),m.push(0),c.side1GameScores=p,c.side2GameScores=m);let f=p[0]||0,h=m[0]||0;t.set=u,t.game=0,t.number=f+h,0===r?(f+=s,p[0]=f):(h+=s,m[0]=h),c.side1GameScores=p,c.side2GameScores=m;let g=Lw(f,h,d,l);t.score=void 0===g?`${f}-${h}`:"0-0",void 0!==g&&(c.winningSide=g+1,c.side1TiebreakScore=f,c.side2TiebreakScore=h,c.side1Score=0===g?1:0,c.side2Score=0===g?0:1,_w(e,i,o))}(i,I,n,s,h,0,u,y);break;case"matchTiebreak":!function(e,t,r,i,n,a,o=1){let s=i.finalSetFormat?.tiebreakSet?.tiebreakTo||10,c=i.finalSetFormat?.tiebreakSet?.NoAD||!1,u=xw(e,!1,!1),d=e.score.sets.indexOf(u),l=u.side1GameScores||[],p=u.side2GameScores||[];0===l.length&&0===p.length&&(l.push(0),p.push(0),u.side1GameScores=l,u.side2GameScores=p);let m=l[0]||0,f=p[0]||0;t.set=d,t.game=0,t.number=m+f,0===r?(m+=o,l[0]=m):(f+=o,p[0]=f),u.side1GameScores=l,u.side2GameScores=p;let h=Lw(m,f,s,c);t.score=void 0===h?`${m}-${f}`:"0-0",void 0!==h&&(u.side1TiebreakScore=m,u.side2TiebreakScore=f,u.side1Score=0===h?1:0,u.side2Score=0===h?0:1,u.winningSide=h+1,_w(e,i,a))}(i,I,n,s,0,u,y);break;case"timed":!function(e,t,r,i,n=1){let a=xw(e,!1,!0),o=e.score.sets.indexOf(a);t.set=o,t.game=0,t.number=(a.side1Score||0)+(a.side2Score||0),0===r?a.side1Score=(a.side1Score||0)+n:a.side2Score=(a.side2Score||0)+n;let s=a.side1Score||0,c=a.side2Score||0;t.score=`${s}-${c}`}(i,I,n,0,y);break;default:!function(e,t,r,i,n,a,o,s){let c=xw(e,!1,!1),u=e.score.sets.indexOf(c),d=c.side1Score||0,l=c.side2Score||0,p=c.side1GameScores||[],m=c.side2GameScores||[];0===p.length&&0===m.length&&(p.push(0),m.push(0));let f=Math.max(p.length,m.length)-1,h=f>=0?p[f]??0:0,g=f>=0?m[f]??0:0;t.set=u,t.game=f,t.number=h+g;let I=n.setTo||6,U=("number"==typeof n.tiebreakAt?n.tiebreakAt:void 0)??I,S=s&&i.finalSetFormat?.noTiebreak;0===r?(h++,p[p.length-1]=h):(g++,m[m.length-1]=g),c.side1GameScores=p,c.side2GameScores=m;let v="CONSECUTIVE"===i.gameFormat?.type,y=i.gameFormat?.count||3;if(v){let e=c.currentStreak;e&&e.side===r?c.currentStreak={side:r,count:e.count+1}:c.currentStreak={side:r,count:1}}let w,P=!S&&d===U&&l===U;w=v&&!P?c.currentStreak.count>=y?c.currentStreak.side:void 0:function(e,t,r,i){let n=r.gameFormat?.NoAD||r.NoAD||!1;if(i){return Lw(e,t,r.tiebreakFormat?.tiebreakTo||7,r.tiebreakFormat?.NoAD||!1)}let a=4,o=Math.abs(e-t);if(n)return e>=a||t>=a?e>t?0:1:void 0;if((e>=a||t>=a)&&o>=2)return e>t?0:1}(h,g,n,P);let T=void 0===w?Vw(h,g,P,v&&!P):"0-0";if(t.score=T,void 0!==w){v&&(c.currentStreak=void 0),0===w?c.side1Score=d+1:c.side2Score=l+1,P&&(c.side1TiebreakScore=h,c.side2TiebreakScore=g);let t=function(e,t,r,i,n){let a=r.setTo||6,o=("number"==typeof r.tiebreakAt?r.tiebreakAt:void 0)??a,s=i&&n?.noTiebreak;if(1===a)return e>=1||t>=1?e>t?0:1:void 0;let c=(i&&n?n:r).winBy||2;if(!s&&(e===o+1||t===o+1)||(e>=a||t>=a)&&Math.abs(e-t)>=c)return e>t?0:1}(c.side1Score||0,c.side2Score||0,n,s,i.finalSetFormat);"number"==typeof t?(c.winningSide=t+1,_w(e,i,o)):(c.side1GameScores.push(0),c.side2GameScores.push(0))}}(i,I,n,s,h,0,u,f)}return i}function xw(e,t,r){let i=e.score.sets.length-1;if(i>=0&&void 0===e.score.sets[i].winningSide)return e.score.sets[i];let n={setNumber:e.score.sets.length+1,side1Score:0,side2Score:0,side1GameScores:[],side2GameScores:[]};return t&&(n.isTiebreakOnly=!0),r&&(n.isTimed=!0),e.score.sets.push(n),n}function _w(e,t,r){let i=[0,0];e.score.sets.forEach(e=>{1===e.winningSide&&i[0]++,2===e.winningSide&&i[1]++});let n=Tw(t),a=t.exactly;if(n){let r=a||t.bestOf||3;if(e.score.sets.filter(e=>void 0!==e.winningSide).length<r)return;let i=e.score.sets.reduce((e,t)=>(void 0!==t.side1TiebreakScore&&void 0!==t.side2TiebreakScore?(e[0]+=t.side1TiebreakScore,e[1]+=t.side2TiebreakScore):(e[0]+=t.side1Score??0,e[1]+=t.side2Score??0),e),[0,0]);return void(i[0]!==i[1]&&(e.matchUpStatus="COMPLETED",e.winningSide=i[0]>i[1]?1:2,e.endTime=(new Date).toISOString()))}if(!(i[0]>=r||i[1]>=r)||a&&e.score.sets.filter(e=>void 0!==e.winningSide).length<a)return;let o=i[0]>=r?0:1;e.matchUpStatus="COMPLETED",e.winningSide=o+1,e.endTime=(new Date).toISOString()}function Lw(e,t,r,i=!1){let n=Math.abs(e-t);if((e>=r||t>=r)&&n>=(i?1:2))return e>t?0:1}function Bw(e,t,r){let i=function(e,t,r){let i=e.score.sets.length-1,n=i>=0?e.score.sets[i]:void 0;if("tiebreakOnly"===r||"matchTiebreak"===r){let t=n?.side1GameScores||[],r=n?.side2GameScores||[],i=(t[0]||0)+(r[0]||0),a=0;for(let n=0;n<e.score.sets.length-1;n++){let t=e.score.sets[n];a+=(t.side1Score||0)+(t.side2Score||0)}return(a%2+Math.floor(i/2)%2)%2}if("timed"===r)return((n?.side1Score||0)+(n?.side2Score||0))%2;let a=n?.side1Score||0,o=n?.side2Score||0,s=t.setFormat?.setTo||6,c=("number"==typeof t.setFormat?.tiebreakAt?t.setFormat.tiebreakAt:void 0)??s;if(!t.finalSetFormat?.noTiebreak&&a===c&&o===c){let e=n?.side1GameScores||[],t=n?.side2GameScores||[],r=(e.at(-1)||0)+(t.at(-1)||0);return((a+o)%2+Math.floor(r/2)%2)%2}return(a+o)%2}(e,t,r);return 1===e.history?.points?.[0]?.server?1-i:i}function Vw(e,t,r,i){if(r||i)return`${e}-${t}`;let n=["0","15","30","40"];if(e<4&&t<4)return`${n[e]}-${n[t]}`;if(e>=3&&t>=3&&e===t)return"40-40";if(e>=3&&t>=3){let r=e-t;if(1===r)return"A-40";if(-1===r)return"40-A";if(r>=2)return"G-40";if(r<=-2)return"40-G"}return e>=3?`40-${t<4?n[t]:"40"}`:t>=3?`${e<4?n[e]:"40"}-40`:`${e<4?n[e]:"0"}-${t<4?n[t]:"0"}`}function Gw(e,t){let r=e.score.sets,i=function(e,t=!1){let r=e.score.sets;return 0===r.length?"0-0":r.map(e=>{let r=e.side1Score||0,i=e.side2Score||0;if(void 0!==e.side1TiebreakScore||void 0!==e.side2TiebreakScore){let n=e.side1TiebreakScore||0,a=e.side2TiebreakScore||0;return t&&(0===r&&1===i||1===r&&0===i)?`[${n}-${a}]`:r>i?`${r}-${i}(${a})`:`${r}(${n})-${i}`}return`${r}-${i}`}).join(", ")}(e,t?.useBracketNotation),n=r.length>0?r.at(-1):null,a=n&&void 0===n.winningSide?[n.side1Score||0,n.side2Score||0]:[0,0],o=[0,0];if(n?.side1GameScores&&n.side2GameScores){let e=Math.max(n.side1GameScores.length,n.side2GameScores.length)-1;e>=0&&(o=[n.side1GameScores[e]||0,n.side2GameScores[e]||0])}let s=function(e,t){if("COMPLETED"===e.matchUpStatus||"TO_BE_PLAYED"===e.matchUpStatus)return;let r=Yn(e.matchUpFormat);if(!r)return;let i=e.score.sets.at(-1);if(!i||void 0!==i.winningSide)return;let n=[0,0];e.score.sets.forEach(e=>{1===e.winningSide&&n[0]++,2===e.winningSide&&n[1]++});let a=Dw(r,n),o="tiebreakOnly"===a||"matchTiebreak"===a,s="CONSECUTIVE"===r.gameFormat?.type,c=o;if(!c&&"standard"===a){let e=r.exactly||r.bestOf||3,t=Math.ceil(e/2),a=n[0]===t-1&&n[1]===t-1,o=a&&r.finalSetFormat?r.finalSetFormat:r.setFormat;if(o){let e=i.side1Score||0,t=i.side2Score||0,n=o.setTo||6,s=("number"==typeof o.tiebreakAt?o.tiebreakAt:void 0)??n,u=o.noTiebreak||!1,d=a&&r.finalSetFormat?.noTiebreak;c=!u&&!d&&e===s&&t===s}}let u=Vw(t[0],t[1],c,s&&!c).split("-");return 2===u.length?[u[0],u[1]]:[String(t[0]),String(t[1])]}(e,o),c=function(e){if("COMPLETED"===e.matchUpStatus||"TO_BE_PLAYED"===e.matchUpStatus)return;let t=Yn(e.matchUpFormat);if(!t)return;let r=t.exactly||t.bestOf||3,i=Math.ceil(r/2),n=[0,0];e.score.sets.forEach(e=>{1===e.winningSide&&n[0]++,2===e.winningSide&&n[1]++});let a,o=Dw(t,n),s=n[0]===i-1&&n[1]===i-1,c=s&&t.finalSetFormat?t.finalSetFormat:t.setFormat,u="RALLY"===c?.tiebreakSet?.modifier||"RALLY"===c?.modifier;u||(a=Bw(e,t,o));let d=bw(e,t,o,c,a);if(!d)return{isBreakPoint:!1,isGamePoint:!1,isSetPoint:!1,isMatchPoint:!1,isGoldenPoint:!1,isTiebreak:!1,server:a};let{pointsToGame:l,pointsToSet:p,pointsToMatch:m,isBreakpoint:f}=d,h="tiebreakOnly"===o||"matchTiebreak"===o;if(!h&&"standard"===o&&c){let r=e.score.sets.at(-1);if(r){let e=r.side1Score||0,i=r.side2Score||0,n=c.setTo||6,a=("number"==typeof c.tiebreakAt?c.tiebreakAt:void 0)??n,o=c.noTiebreak||!1,u=s&&t.finalSetFormat?.noTiebreak;h=!o&&!u&&e===a&&i===a}}let g=!!(c?.NoAD||c?.gameFormat?.NoAD||h&&(c?.tiebreakFormat?.NoAD||c?.tiebreakSet?.NoAD||t.finalSetFormat?.tiebreakSet?.NoAD))&&1===l[0]&&1===l[1],I=void 0!==a&&1===l[a],U=1===Math.min(p[0],p[1]),S=1===Math.min(m[0],m[1]);return{isBreakPoint:f,isGamePoint:I,isSetPoint:U,isMatchPoint:S,isGoldenPoint:g,isTiebreak:h,server:a}}(e);return{sets:r,scoreString:i,games:a,points:o,pointDisplay:s,situation:c}}function jw(e,t){let r=e.score.sets;if(0===r.length)return"0-0";let i=t?.perspective,n=r.map(e=>{let t=e.side1Score||0,r=e.side2Score||0;if(1===i&&([t,r]=[r,t]),void 0!==e.side1TiebreakScore||void 0!==e.side2TiebreakScore){let n=e.side1TiebreakScore||0,a=e.side2TiebreakScore||0;return 1===i&&([n,a]=[a,n]),t>r?`${t}-${r}(${a})`:`${t}(${n})-${r}`}return`${t}-${r}`}),a=r.at(-1);if("IN_PROGRESS"===e.matchUpStatus&&a&&!a.winningSide){let t=a.side1GameScores||[],r=t.length-1;if(r>=0&&t.length>0){let o=t[r]||0,s=(a.side2GameScores||[])[r]||0;if(0===o&&0===s)return n.join(", ");1===i&&([o,s]=[s,o]);let c=a.side1Score||0,u=a.side2Score||0,d=e.matchUpFormat?Yn(e.matchUpFormat):void 0,l=d?.setFormat?.setTo||6,p=("number"==typeof d?.setFormat?.tiebreakAt?d.setFormat.tiebreakAt:void 0)??l,m=c===p&&u===p,f="CONSECUTIVE"===d?.gameFormat?.type,h=n.at(-1),g=`${n.slice(0,-1).join(", ")}${n.length>1?", ":""}${h}`;if(m||f)return`${g} (${o}-${s})`;{let e=function(e,t){let r=["0","15","30","40"];if(e<=3&&t<=3)return`${r[e]}-${r[t]}`;if(e>=3&&t>=3){let r=e-t;return 0===r?"40-40":1===r?"A-40":-1===r?"40-A":r>=2?"G-40":"40-G"}return e>=3?"G-40":t>=3?"40-G":`${r[e]}-${r[t]}`}(o,s);return`${g} (${e})`}}}return n.join(", ")}function $w(e){if("COMPLETED"===e.matchUpStatus)return e.winningSide}function qw(e){return"COMPLETED"===e.matchUpStatus}function Ww(e){if(!e)return[];let t=e.history?.points;if(!t||0===t.length)return[];let r=[];for(let i=0;i<t.length;i++){let n,a,o=t[i],s=i<t.length-1?t[i+1]:void 0,c=o.set??0,u=o.game??0,d=o.number??0,l=s?s.set??0:void 0,p=s?s.game??0:void 0,m=i===t.length-1,f=m?"COMPLETED"===e.matchUpStatus||void 0===l&&void 0===p:l!==c||p!==u,h=m?"COMPLETED"===e.matchUpStatus||!1:void 0!==s&&l!==c;if(f&&(n=o.winner),h){let t=e.score.sets[c];void 0!==t?.winningSide&&(a=t.winningSide-1)}let g={};o.pointsToGame&&(g.pointsToGame=o.pointsToGame),o.pointsToSet&&(g.pointsToSet=o.pointsToSet),o.pointsToMatch&&(g.pointsToMatch=o.pointsToMatch),o.gamesToSet&&(g.gamesToSet=o.gamesToSet),void 0!==o.isBreakpoint&&(g.isBreakpoint=o.isBreakpoint);let I=s?.server??o.server??0,U=e.score.sets[c],S=!!(U?.isTiebreakOnly||u>0&&U&&void 0!==U.side1Score&&void 0!==U.side2Score&&!U.isTiebreakOnly),v={action:"addPoint",point:{index:i,number:d,winner:o.winner,server:o.server,score:o.score,result:o.result},game:{index:u,isTiebreak:S,complete:f,winner:n},set:{index:c,complete:h,winner:a},needed:g,nextService:I,result:o.result,complete:m&&"COMPLETED"===e.matchUpStatus};r.push(v)}return r}n(Sw,{ScoringEngine:()=>oP,generateScoreString:()=>vw,generateTieMatchUpScore:()=>rv,reverseScore:()=>ww});var Hw={A:"Ace",D:"Double Fault",S:"Serve Winner",R:"Return Winner",W:"Winner",E:"Unforced Error",F:"Forced Error"},Yw=new Set(["A","S"]),zw=new Set(["D","R","E","F"]);function Kw(e,t){let r={...e};return r.server=t.server,r.index=t.index,r.set=t.set,r.game=t.game,r.code&&!r.winner&&(r.winner=function(e,t){return Yw.has(e)?t:zw.has(e)?1-t:t}(r.code,t.server)),r.code&&!r.result&&(r.result=Hw[r.code]),r.first_serve?r.serve=2:r.serve||(r.serve=1),r}function Jw(e,t){let r={players:{},teams:{}};for(let a=0;a<2;a++)r.players[a]={},r.teams[a]={};let i,n=e;return void 0!==t?.setFilter&&(n=e.filter(e=>e.set===t.setFilter)),n.forEach((e,t)=>{if(void 0===e.winner)return void console.warn("Point missing winner:",e);let{winner:n,loser:a}=function(e){let t=[],r=[],i=e.result?.toLowerCase()||"";return i.includes("ace")&&t.push("aces"),(i.includes("winner")||i.includes("ace"))&&t.push("winners"),i.includes("double fault")&&r.push("doubleFaults"),i.includes("unforced error")&&r.push("unforcedErrors"),i.includes("forced error")&&r.push("forcedErrors"),e.winner===e.server?(t.push("servesWon"),1===e.serve?t.push("serves1stWon"):2===e.serve&&t.push("serves2ndWon")):(t.push("returns"),1===e.serve?t.push("received1stWon"):2===e.serve&&t.push("received2ndWon")),t.push("pointsWon"),{winner:t,loser:r}}(e),o=e.winner,s=1-o;if(n.forEach(t=>{r.teams[o][t]||(r.teams[o][t]=[]),r.teams[o][t].push(e),r.players[o][t]||(r.players[o][t]=[]),r.players[o][t].push(e)}),a.forEach(t=>{r.teams[s][t]||(r.teams[s][t]=[]),r.teams[s][t].push(e),r.players[s][t]||(r.players[s][t]=[]),r.players[s][t].push(e)}),void 0!==e.server){let t=e.server;r.teams[t].pointsServed||(r.teams[t].pointsServed=[]),r.teams[t].pointsServed.push(e),1===e.serve?(r.teams[t].serves1stIn||(r.teams[t].serves1stIn=[]),r.teams[t].serves1stIn.push(e)):2===e.serve&&(r.teams[t].serves2ndIn||(r.teams[t].serves2ndIn=[]),r.teams[t].serves2ndIn.push(e))}if(e.hand){let i=e.hand;r.teams[o][i]||(r.teams[o][i]=[]),r.teams[o][i].push({point:e,index:t})}if(function(e,t){return!(!t||void 0===e.game||void 0===t.game)&&e.game!==t.game}(e,i)&&void 0!==i?.winner){let e=i.winner;r.teams[e].gamesWon||(r.teams[e].gamesWon=[]),r.teams[e].gamesWon.push(i),r.players[e].gamesWon||(r.players[e].gamesWon=[]),r.players[e].gamesWon.push(i)}if(e.breakpoint){let t=e.server;r.teams[t].breakpointsFaced||(r.teams[t].breakpointsFaced=[]),r.teams[t].breakpointsFaced.push(e),o===t&&(r.teams[t].breakpointsSaved||(r.teams[t].breakpointsSaved=[]),r.teams[t].breakpointsSaved.push(e))}i=e}),r}function Qw(e,t,r){switch(e.calc){case"number":return function(e,t,r){let i=Xw(e.numerators,t,r);return{value:i,display:String(i),numerators:e.numerators}}(e,t,r);case"percentage":return function(e,t,r){let i=Xw(e.numerators,t,r),n=Xw(e.denominators||[],t,r);if(!n)return{value:0,display:"0",numerators:e.numerators};let a=Math.round(i/n*100);return{value:a,display:`${a}% (${i}/${n})`,numerators:e.numerators}}(e,t,r);case"maxConsecutive":return function(e,t,r){let i=e.numerators[0],n=e.attribute||"index";if(!t[r][i])return{value:0,display:"0"};let a,o=t[r][i],s=0,c=o.length?1:0;return o.forEach(e=>{let t=e[n];void 0!==a&&t===a+1?c++:(c>s&&(s=c),c=1),a=t}),c>s&&(s=c),{value:s,display:String(s)}}(e,t,r);case"difference":return function(e,t,r){let i=Xw(e.numerators,t,r),n=Xw(e.denominators||[],t,r);if(!n)return{value:0,display:"0",numerators:e.numerators};let a=Math.abs(n-i),o=Math.round(a/n*100);return{value:o,display:`${o}% (${a}/${n})`,numerators:e.numerators}}(e,t,r);case"aggressiveMargin":return function(e,t,r){let i=Xw(e.denominators||[],t,r),n=Xw(e.numerators,t,r),a=i-n;return{value:a,display:String(a)}}(e,t,r)}}function Xw(e,t,r){return e?e.reduce((e,i)=>{let n=i.startsWith("-"),a=(i.includes("*"),i.replace("-","").replace("*","")),o=n?1-r:r,s=t[o]?.[a];return s?e+s.length:e},0):0}function Zw(e,t,r){let i=Jw(t||[],r),n=function(e){if(!e?.teams)return[];let t=[];return Object.values({Aces:{category:"Aces",numerators:["aces"],calc:"number"},"Double Faults":{category:"Double Faults",numerators:["doubleFaults"],calc:"number"},Winners:{category:"Winners",numerators:["winners"],calc:"number"},"Unforced Errors":{category:"Unforced Errors",numerators:["unforcedErrors"],calc:"number"},"Forced Errors":{category:"Forced Errors",numerators:["forcedErrors"],calc:"number"},"Total Points Won":{category:"Total Points Won",numerators:["pointsWon"],calc:"number"},"Max Pts/Row":{category:"Max Pts/Row",numerators:["pointsWon"],calc:"maxConsecutive",attribute:"index"},"Max Games/Row":{category:"Max Games/Row",numerators:["gamesWon"],calc:"maxConsecutive",attribute:"game"},"First Serve %":{category:"First Serve %",numerators:["serves1stIn"],denominators:["pointsServed"],calc:"percentage"},"Points Won 1st":{category:"Points Won 1st",numerators:["serves1stWon"],denominators:["serves1stIn"],calc:"percentage"},"Points Won 2nd":{category:"Points Won 2nd",numerators:["serves2ndWon"],denominators:["serves2ndIn"],calc:"percentage"},"Points Won Receiving":{category:"Points Won Receiving",numerators:["received1stWon","received2ndWon"],denominators:["-pointsServed"],calc:"percentage"},"Breakpoints Saved":{category:"Breakpoints Saved",numerators:["breakpointsSaved"],denominators:["breakpointsFaced"],calc:"percentage"},"Breakpoints Converted":{category:"Breakpoints Converted",numerators:["-breakpointsSaved"],denominators:["-breakpointsFaced"],calc:"difference"},"Games Won":{category:"Games Won",numerators:["gamesWon"],calc:"number"},"Service Points Won":{category:"Service Points Won",numerators:["servesWon"],denominators:["pointsServed"],calc:"percentage"},"Aggressive Margin":{category:"Aggressive Margin",numerators:["*doubleFaults","*unforcedErrors"],denominators:["*aces","*winners","-*forcedErrors"],calc:"aggressiveMargin"}}).forEach(r=>{let i=[Qw(r,e.teams,0),Qw(r,e.teams,1)];(0!==i[0].value||0!==i[1].value)&&t.push({category:r.category,teams:i})}),t}(i),a=function(e){let t={totalPoints:0,byTeam:[0,0],byCategory:{}};for(let i=0;i<2;i++)if(e.teams[i].pointsWon){let r=e.teams[i].pointsWon.length;t.byTeam[i]=r,t.totalPoints+=r}let r=new Set;for(let i=0;i<2;i++)Object.keys(e.teams[i]).forEach(e=>r.add(e));return r.forEach(r=>{t.byCategory[r]=0;for(let i=0;i<2;i++)e.teams[i][r]&&(t.byCategory[r]+=e.teams[i][r].length)}),t}(i);return{counters:i,calculated:n,summary:a}}function eP(e){if(!e)return[];let t=[];return e.forEach((e,r)=>{let i=Kw(e,{server:0,index:r,set:0,game:0});t.push(i)}),t}function tP(e,t){let r=Jw(e||[],t);return{aces:[r.teams[0].aces?.length||0,r.teams[1].aces?.length||0],doubleFaults:[r.teams[0].doubleFaults?.length||0,r.teams[1].doubleFaults?.length||0],winners:[r.teams[0].winners?.length||0,r.teams[1].winners?.length||0],unforcedErrors:[r.teams[0].unforcedErrors?.length||0,r.teams[1].unforcedErrors?.length||0],totalPoints:[r.teams[0].pointsWon?.length||0,r.teams[1].pointsWon?.length||0]}}function rP(e,t,r){return e.teams[t]?.[r]?.length??0}function iP(e,t){return t&&e?Number.parseFloat((e/t*100).toFixed(2)):0}function nP(e,t,r){return e.find(e=>e.category===t)?.teams[r]?.value??0}function aP(e){if(!e?.counters?.teams)return[];let{counters:t,calculated:r}=e,i=[];i.push({name:"Aces",numerator:[rP(t,0,"aces"),rP(t,1,"aces")],default:"numerator"},{name:"Double Faults",numerator:[rP(t,0,"doubleFaults"),rP(t,1,"doubleFaults")],default:"numerator"});let n=[rP(t,0,"serves1stWon"),rP(t,1,"serves1stWon")],a=[rP(t,0,"servesWon"),rP(t,1,"servesWon")];if(n[0]+n[1]>0&&(a[0]!==n[0]||a[1]!==n[1])){let e=[rP(t,0,"pointsServed"),rP(t,1,"pointsServed")],r=[rP(t,0,"serves1stIn"),rP(t,1,"serves1stIn")],a=[rP(t,0,"serves2ndWon"),rP(t,1,"serves2ndWon")],o=[rP(t,0,"serves2ndIn"),rP(t,1,"serves2ndIn")];i.push({name:"1st Serve In",numerator:r,denominator:e,pct:[iP(r[0],e[0]),iP(r[1],e[1])]},{name:"1st Serve Points Won",numerator:n,denominator:r,pct:[iP(n[0],r[0]),iP(n[1],r[1])]},{name:"2nd Serve Points Won",numerator:a,denominator:o,pct:[iP(a[0],o[0]),iP(a[1],o[1])]})}i.push({name:"Total Points Won",numerator:[rP(t,0,"pointsWon"),rP(t,1,"pointsWon")],default:"numerator"});let o=rP(t,0,"received1stWon")+rP(t,0,"received2ndWon"),s=rP(t,1,"received1stWon")+rP(t,1,"received2ndWon"),c=rP(t,1,"pointsServed"),u=rP(t,0,"pointsServed");i.push({name:"Receiving Points Won",numerator:[o,s],denominator:[c,u],pct:[iP(o,c),iP(s,u)]});let d=rP(t,1,"breakpointsFaced")-rP(t,1,"breakpointsSaved"),l=rP(t,0,"breakpointsFaced")-rP(t,0,"breakpointsSaved"),p=rP(t,1,"breakpointsFaced"),m=rP(t,0,"breakpointsFaced");i.push({name:"Break Points Won",numerator:[d,l],denominator:[p,m],pct:[iP(d,p),iP(l,m)]});let f=rP(t,0,"breakpointsSaved"),h=rP(t,1,"breakpointsSaved"),g=rP(t,0,"breakpointsFaced"),I=rP(t,1,"breakpointsFaced");i.push({name:"Break Points Saved",numerator:[f,h],denominator:[g,I],pct:[iP(f,g),iP(h,I)]},{name:"Winners",numerator:[rP(t,0,"winners"),rP(t,1,"winners")],default:"numerator"},{name:"Unforced Errors",numerator:[rP(t,0,"unforcedErrors"),rP(t,1,"unforcedErrors")],default:"numerator"},{name:"Forced Errors",numerator:[rP(t,0,"forcedErrors"),rP(t,1,"forcedErrors")],default:"numerator"});let U=a,S=[rP(t,0,"pointsServed"),rP(t,1,"pointsServed")];return i.push({name:"Service Points Won",numerator:U,denominator:S,pct:[iP(U[0],S[0]),iP(U[1],S[1])]},{name:"Games Won",numerator:[rP(t,0,"gamesWon"),rP(t,1,"gamesWon")]},{name:"Most Consecutive Points Won",numerator:[nP(r,"Max Pts/Row",0),nP(r,"Max Pts/Row",1)]},{name:"Most Consecutive Games Won",numerator:[nP(r,"Max Games/Row",0),nP(r,"Max Games/Row",1)]}),i}var oP=class{constructor(e={}){this.redoStack=[],this.pointMultipliers=[],e.competitionFormat?(this.competitionFormat=e.competitionFormat,this.matchUpFormat=e.matchUpFormat||e.competitionFormat.matchUpFormat||"SET3-S:6/TB7",this.pointMultipliers=e.pointMultipliers||e.competitionFormat.pointMultipliers||[]):(this.matchUpFormat=e.matchUpFormat||"SET3-S:6/TB7",this.pointMultipliers=e.pointMultipliers||[]),this.matchUpId=e.matchUpId,this.isDoubles=e.isDoubles||!1,this.eventHandlers=e.eventHandlers,this.state=Pw({matchUpFormat:this.matchUpFormat,matchUpId:this.matchUpId,isDoubles:this.isDoubles}),this.cacheFormatStructure()}setState(e){this.state=e,this.matchUpFormat=e.matchUpFormat,this.matchUpId=e.matchUpId,this.isDoubles="DOUBLES"===e.matchUpType,this.redoStack=[],this.initialScore=void 0,this.cacheFormatStructure()}getState(){return this.state}addPoint(e){let t=this.state.history?.points.length||0,r=this.state.score.sets.reduce((e,t)=>e+(t.side1Score||0)+(t.side2Score||0),0),i=this.state.score.sets.filter(e=>void 0!==e.winningSide).length,n="COMPLETED"===this.state.matchUpStatus,a=this.hasLineUp()?this.getActivePlayers():void 0;if(this.state=Fw(this.state,e,{pointMultipliers:this.pointMultipliers}),a){let e=this.state.history.points[this.state.history.points.length-1];this.isDoubles?e.activePlayers=[a.side1,a.side2]:e.activePlayers=[a.side1[0]||"",a.side2[0]||""]}if(e.penaltyType){this.state.history.points[this.state.history.points.length-1].penaltyType=e.penaltyType}if(this.ensureHistory(),this.state.history.entries.push({type:"point",data:{winner:e.winner,server:e.server,timestamp:e.timestamp,rallyLength:e.rallyLength,result:e.result,penaltyType:e.penaltyType},timestamp:e.timestamp||(new Date).toISOString(),pointIndex:t}),this.redoStack=[],this.eventHandlers){let t=this.buildEventContext();if(this.eventHandlers.onPoint?.(t),this.state.score.sets.reduce((e,t)=>e+(t.side1Score||0)+(t.side2Score||0),0)>r&&this.eventHandlers.onGameComplete?.({...t,gameWinner:e.winner}),this.state.score.sets.filter(e=>void 0!==e.winningSide).length>i){let e=1===this.state.score.sets.findLast(e=>void 0!==e.winningSide)?.winningSide?0:1;this.eventHandlers.onSetComplete?.({...t,setWinner:e})}if(!n&&"COMPLETED"===this.state.matchUpStatus){let e=1===this.state.winningSide?0:1;this.eventHandlers.onMatchComplete?.({...t,matchWinner:e})}}}addSet(e){this.applyAddSet(e),this.ensureHistory();let t=this.state.score.sets.at(-1)?.winningSide;this.state.history.entries.push({type:"set",data:{...e,winningSide:t},timestamp:e.timestamp||(new Date).toISOString()}),this.redoStack=[]}addGame(e){this.applyAddGame(e),this.ensureHistory(),this.state.history.entries.push({type:"game",data:e,timestamp:e.timestamp||(new Date).toISOString()}),this.redoStack=[]}endSegment(e){this.applyEndSegment(e),this.ensureHistory();let t=(e?.setNumber??this.state.score.sets.length)-1;this.state.history.entries.push({type:"endSegment",data:{setNumber:t+1,...e},timestamp:e?.timestamp||(new Date).toISOString()})}setInitialScore(e){this.initialScore=e,this.redoStack=[],this.applyInitialScore(this.state,e),this.ensureHistory(),this.state.history.entries.push({type:"setInitialScore",data:e,timestamp:(new Date).toISOString()}),"TO_BE_PLAYED"===this.state.matchUpStatus&&(this.state.matchUpStatus="IN_PROGRESS")}undo(e=1){let t=this.state.history?.entries;if(t&&t.length>0){let r=Math.min(e,t.length);for(let e=0;e<r;e++){let e=t.pop();this.redoStack.push(e),"point"===e.type&&this.state.history.points.pop()}return this.rebuildFromEntries(),this.eventHandlers?.onUndo?.(this.buildEventContext()),!0}let r=this.state.history?.points||[];if(0===r.length)return!1;let i=Math.min(e,r.length);for(let n=0;n<i;n++){let e=r.pop();this.redoStack.push({type:"point",data:{winner:e.winner,server:e.server,timestamp:e.timestamp,rallyLength:e.rallyLength},timestamp:e.timestamp||""})}return this.rebuildState(),this.eventHandlers?.onUndo?.(this.buildEventContext()),!0}redo(e=1){if(0===this.redoStack.length)return!1;let t=Math.min(e,this.redoStack.length);for(let r=0;r<t;r++){let e=this.redoStack.pop();this.ensureHistory(),this.state.history.entries.push(e),e.type}return this.rebuildFromEntries(),this.eventHandlers?.onRedo?.(this.buildEventContext()),!0}canUndo(){let e=this.state.history?.entries;return!!(e&&e.length>0)||(this.state.history?.points.length||0)>0}canRedo(){return this.redoStack.length>0}getUndoDepth(){let e=this.state.history?.entries;return e&&e.length>0?e.length:this.state.history?.points.length||0}getRedoDepth(){return this.redoStack.length}getScore(){return Gw(this.state)}getScoreboard(e){return jw(this.state,e)}getWinner(){return $w(this.state)}isComplete(){return qw(this.state)}getPointCount(){return this.state.history?.points.length||0}getFormat(){return this.state.matchUpFormat}getStatistics(e){let t=this.state.history?.points||[];return Zw(this.state,t,e)}getStatObjects(e){return aP(this.getStatistics(e))}getNextServer(){if("WINNER_SERVES"===this.competitionFormat?.serverRule){let e=this.state.history?.points.at(-1);return e?e.winner:0}if(!this.cachedFormatStructure)return 0;let e=[0,0];this.state.score.sets.forEach(t=>{1===t.winningSide&&e[0]++,2===t.winningSide&&e[1]++});let t=Dw(this.cachedFormatStructure,e);return Bw(this.state,this.cachedFormatStructure,t)}getEpisodes(){return Ww(this.state)}isNoAd(){return!(!this.cachedFormatStructure?.setFormat?.NoAD&&!this.cachedFormatStructure?.setFormat?.gameFormat?.NoAD)}getSetsToWin(){if(!this.cachedFormatStructure)return 2;let e=this.cachedFormatStructure.exactly||this.cachedFormatStructure.bestOf||3;return Math.ceil(e/2)}getTiebreakAt(){let e=this.cachedFormatStructure?.setFormat;if(!e||e.tiebreakSet||e.timed||e.noTiebreak)return null;let t=e.setTo||6;return("number"==typeof e.tiebreakAt?e.tiebreakAt:void 0)??t}hasFinalSetTiebreak(){let e=this.cachedFormatStructure?.finalSetFormat;return e?!!e.tiebreakSet||!e.noTiebreak&&!(!e.tiebreakFormat&&void 0===e.tiebreakAt):null!==this.getTiebreakAt()}getFormatStructure(){return this.cachedFormatStructure}getInputMode(){let e=this.state.history?.entries||[];if(0===e.length)return(this.state.history?.points.length||0)>0?"points":"none";let t=new Set(e.filter(e=>"setInitialScore"!==e.type&&"endSegment"!==e.type).map(e=>e.type));if(0===t.size)return"none";if(1===t.size){let e=t.values().next().value;if("point"===e)return"points";if("game"===e)return"games";if("set"===e)return"sets"}return"mixed"}setLineUp(e,t){let r=this.state.sides.find(t=>t.sideNumber===e);r&&(r.lineUp=t),this.initialLineUps??={},this.initialLineUps[e]=t.map(e=>({...e}))}substitute(e){let t=this.state.sides.find(t=>t.sideNumber===e.sideNumber);if(!t?.lineUp)return;let r=t.lineUp.findIndex(t=>t.participantId===e.outParticipantId);if(-1===r)return;this.ensureHistory(),this.state.history.substitutions??=[];let i={sideNumber:e.sideNumber,outParticipantId:e.outParticipantId,inParticipantId:e.inParticipantId,beforePointIndex:this.state.history.points.length,timestamp:e.timestamp};this.state.history.substitutions.push(i),t.lineUp[r]={...t.lineUp[r],participantId:e.inParticipantId},this.state.history.entries.push({type:"substitution",data:i,timestamp:e.timestamp||(new Date).toISOString()}),this.redoStack=[]}getActivePlayers(){let e=this.state.sides.find(e=>1===e.sideNumber),t=this.state.sides.find(e=>2===e.sideNumber);return{side1:e?.lineUp?.map(e=>e.participantId)||[],side2:t?.lineUp?.map(e=>e.participantId)||[]}}hasLineUp(){return this.state.sides.some(e=>e.lineUp&&e.lineUp.length>0)}setPointMultipliers(e){this.pointMultipliers=e}getPointMultipliers(){return this.pointMultipliers}getSupplementaryState(){return{redoStack:[...this.redoStack],initialLineUps:this.initialLineUps?Object.fromEntries(Object.entries(this.initialLineUps).map(([e,t])=>[e,t.map(e=>({...e}))])):void 0}}loadSupplementaryState(e){e.redoStack&&(this.redoStack=[...e.redoStack]),e.initialLineUps&&(this.initialLineUps=Object.fromEntries(Object.entries(e.initialLineUps).map(([e,t])=>[e,t.map(e=>({...e}))])))}getPenaltyProfile(){return this.competitionFormat?.penaltyProfile}getPointProfile(){return this.competitionFormat?.pointProfile}getTimerProfile(){return this.competitionFormat?.timerProfile}getTimeoutRules(){return this.competitionFormat?.timeoutRules}getSubstitutionRules(){return this.competitionFormat?.substitutionRules}getPlayerRules(){return this.competitionFormat?.playerRules}setEventHandlers(e){this.eventHandlers=e}getEventHandlers(){return this.eventHandlers}decoratePoint(e,t){let r=this.state.history?.points[e];r&&Object.assign(r,t)}markHardBoundary(e){let t=this.state.score.sets[e.setIndex];t&&(t.hardBoundaries??=[],t.hardBoundaries.includes(e.gameIndex)||(t.hardBoundaries.push(e.gameIndex),t.hardBoundaries.sort((e,t)=>e-t)))}editPoint(e,t,r){let i=this.state.history?.points;if(!i||e<0||e>=i.length)return;let n=!1!==r?.recalculate,a=i[e];if(void 0!==t.winner&&(a.winner=t.winner),void 0!==t.server&&(a.server=t.server),void 0!==t.timestamp&&(a.timestamp=t.timestamp),void 0!==t.rallyLength&&(a.rallyLength=t.rallyLength),void 0!==t.wrongSide&&(a.wrongSide=t.wrongSide),void 0!==t.wrongServer&&(a.wrongServer=t.wrongServer),void 0!==t.penaltyPoint&&(a.penaltyPoint=t.penaltyPoint),!n)return;let o=this.state.history?.entries;if(o){let r=o.find(t=>"point"===t.type&&t.pointIndex===e);r&&(void 0!==t.winner&&(r.data.winner=t.winner),void 0!==t.server&&(r.data.server=t.server))}o&&o.length>0?this.rebuildFromEntries():this.rebuildState(),this.redoStack=[]}reset(){this.state=Pw({matchUpFormat:this.matchUpFormat,matchUpId:this.matchUpId,isDoubles:this.isDoubles}),this.redoStack=[],this.initialScore=void 0,this.initialLineUps=void 0,this.eventHandlers?.onReset?.(this.buildEventContext())}ensureHistory(){this.state.history??={points:[]},this.state.history.entries??=[]}buildEventContext(){return{state:this.state,score:Gw(this.state)}}cacheFormatStructure(){this.cachedFormatStructure=Yn(this.matchUpFormat)}getInitialLineUps(){return this.initialLineUps}applyAddSet(e){let{side1Score:t,side2Score:r,side1TiebreakScore:i,side2TiebreakScore:n}=e,a=e.winningSide;void 0===a&&(t>r?a=1:r>t&&(a=2));let o={setNumber:this.state.score.sets.length+1,side1Score:t,side2Score:r,winningSide:a};void 0!==i&&(o.side1TiebreakScore=i),void 0!==n&&(o.side2TiebreakScore=n),this.state.score.sets.push(o),"TO_BE_PLAYED"===this.state.matchUpStatus&&(this.state.matchUpStatus="IN_PROGRESS"),void 0!==a&&this.checkMatchCompletion()}applyAddGame(e){let{winner:t,tiebreakScore:r}=e,i=this.state.score.sets.length>0?this.state.score.sets.at(-1):void 0;(!i||void 0!==i.winningSide)&&(i={setNumber:this.state.score.sets.length+1,side1Score:0,side2Score:0},this.state.score.sets.push(i)),0===t?i.side1Score=(i.side1Score||0)+1:i.side2Score=(i.side2Score||0)+1,r&&(i.side1TiebreakScore=r[0],i.side2TiebreakScore=r[1]),"TO_BE_PLAYED"===this.state.matchUpStatus&&(this.state.matchUpStatus="IN_PROGRESS"),this.checkSetCompletion(i),void 0!==i.winningSide&&this.checkMatchCompletion()}applySubstitution(e){let t=this.state.sides.find(t=>t.sideNumber===e.sideNumber);if(!t?.lineUp)return;let r=t.lineUp.findIndex(t=>t.participantId===e.outParticipantId);-1!==r&&(t.lineUp[r]={...t.lineUp[r],participantId:e.inParticipantId},this.state.history??={points:[]},this.state.history.substitutions??=[],this.state.history.substitutions.push(e))}applyEndSegment(e){let t=(e?.setNumber??this.state.score.sets.length)-1,r=this.state.score.sets[t];if(!r||void 0!==r.winningSide)return;let i=r.side1Score||0,n=r.side2Score||0;i>n?r.winningSide=1:n>i&&(r.winningSide=2),this.checkMatchCompletion()}checkSetCompletion(e){let t=Yn(this.state.matchUpFormat);if(!t)return;let r=t.exactly||t.bestOf||3,i=Math.ceil(r/2),n=[0,0];this.state.score.sets.forEach(e=>{1===e.winningSide&&n[0]++,2===e.winningSide&&n[1]++});let a=n[0]===i-1&&n[1]===i-1&&t.finalSetFormat?t.finalSetFormat:t.setFormat;if(!a)return;let o=e.side1Score||0,s=e.side2Score||0;if(a.tiebreakSet){let t=a.tiebreakSet.tiebreakTo||11,r=a.tiebreakSet.NoAD?1:2;(o>=t||s>=t)&&Math.abs(o-s)>=r&&(e.winningSide=o>s?1:2)}else if(!a.timed){let t=a.setTo||6,r=("number"==typeof a.tiebreakAt?a.tiebreakAt:void 0)??t,i=a.noTiebreak||!1,n=a.winBy||2;(!i&&void 0!==e.side1TiebreakScore&&(o===r+1||s===r+1)||(o>=t||s>=t)&&Math.abs(o-s)>=n)&&(e.winningSide=o>s?1:2)}}checkMatchCompletion(){let e=Yn(this.state.matchUpFormat);if(!e)return;let t=e.exactly||e.bestOf||3,r=Math.ceil(t/2),i=Tw(e),n=e.exactly;if(i){let e=n||t;if(this.state.score.sets.filter(e=>void 0!==e.winningSide).length>=e){let e=this.state.score.sets.reduce((e,t)=>(void 0===t.side1TiebreakScore?(e[0]+=t.side1Score??0,e[1]+=t.side2Score??0):(e[0]+=t.side1TiebreakScore,e[1]+=t.side2TiebreakScore??0),e),[0,0]);e[0]!==e[1]&&(this.state.matchUpStatus="COMPLETED",this.state.winningSide=e[0]>e[1]?1:2,this.state.endTime=(new Date).toISOString())}}else{let e=[0,0];if(this.state.score.sets.forEach(t=>{1===t.winningSide&&e[0]++,2===t.winningSide&&e[1]++}),(e[0]>=r||e[1]>=r)&&(!n||this.state.score.sets.filter(e=>void 0!==e.winningSide).length>=n)){let t=e[0]>=r?0:1;this.state.matchUpStatus="COMPLETED",this.state.winningSide=t+1,this.state.endTime=(new Date).toISOString()}}}rebuildFromEntries(){let e=this.state.history?.entries||[],t=this.getInitialLineUps(),r=Pw({matchUpFormat:this.matchUpFormat,matchUpId:this.matchUpId,isDoubles:this.isDoubles});if(t)for(let i of r.sides)t[i.sideNumber]&&(i.lineUp=t[i.sideNumber].map(e=>({...e})));this.initialScore&&(this.applyInitialScore(r,this.initialScore),"TO_BE_PLAYED"===r.matchUpStatus&&(r.matchUpStatus="IN_PROGRESS")),r.history={points:[],entries:[...e]},this.state=r;for(let i of e)switch(i.type){case"point":this.state=Fw(this.state,i.data,{pointMultipliers:this.pointMultipliers}),this.state.history.entries=r.history.entries;break;case"set":this.applyAddSet(i.data);break;case"game":this.applyAddGame(i.data);break;case"endSegment":this.applyEndSegment(i.data);break;case"substitution":this.applySubstitution(i.data)}}rebuildState(){let e=this.state.history?.points||[],t=Pw({matchUpFormat:this.matchUpFormat,matchUpId:this.matchUpId,isDoubles:this.isDoubles});this.initialScore&&(this.applyInitialScore(t,this.initialScore),"TO_BE_PLAYED"===t.matchUpStatus&&(t.matchUpStatus="IN_PROGRESS"));for(let r of e)t=Fw(t,{winner:r.winner,server:r.server,timestamp:r.timestamp,rallyLength:r.rallyLength,result:r.result},{pointMultipliers:this.pointMultipliers});this.state=t}applyInitialScore(e,t){e.score.sets=[];for(let r=0;r<t.sets.length;r++){let i=t.sets[r],n={setNumber:r+1,side1Score:i.side1Score,side2Score:i.side2Score};void 0!==i.side1TiebreakScore&&(n.side1TiebreakScore=i.side1TiebreakScore),void 0!==i.side2TiebreakScore&&(n.side2TiebreakScore=i.side2TiebreakScore),void 0!==i.winningSide?n.winningSide=i.winningSide:i.side1Score>i.side2Score?n.winningSide=1:i.side2Score>i.side1Score&&(n.winningSide=2),e.score.sets.push(n)}if(t.currentSetScore){let r={setNumber:e.score.sets.length+1,side1Score:t.currentSetScore.side1Score,side2Score:t.currentSetScore.side2Score,side1GameScores:[],side2GameScores:[]};t.currentGameScore?(r.side1GameScores=[t.currentGameScore.side1Points],r.side2GameScores=[t.currentGameScore.side2Points]):(r.side1GameScores=[0],r.side2GameScores=[0]),e.score.sets.push(r)}}},sP={};n(sP,{addPoint:()=>Fw,calculatePointsTo:()=>bw,createMatchUp:()=>Pw,inferServeSide:()=>Ow,resolvePointValue:()=>kw});var cP={};n(cP,{keyValueScore:()=>HP,parseMatchUpFormat:()=>Yn,stringifyMatchUpFormat:()=>jn,tidyScore:()=>gT});var uP=["RET","DEF","WO","WO/WO","ABN","SUS","INT"],dP="DEFAULTED",lP="WALKOVER",pP="ABANDONED",mP="SUSPENDED",fP="RETIRED",hP="INTERRUPTED",gP=[fP,dP,lP],IP="()",UP="[]",SP=["up","left","shift+tab"],vP=["enter","down","tab","right"],yP="backspace",wP=["r","d","w","a","s","i"],PP="space",TP=["[","("],DP=[...SP,...vP,PP,"]"],bP="-",MP="-",RP=["/"],NP=["0","1","2","3","4","5","6","7","8","9"].concat(wP),AP=NP.map(e=>`shift+${e}`),EP=[bP,yP].concat(DP,RP),CP=[NP,AP,EP].join(","),OP=[CP,SP,vP,["=","+","num_1","num_2","shift+=","shift+-"]].join(","),kP=([].concat(...NP,...NP,...EP,...NP,...NP,...NP,...NP,...NP,...NP),{OUTCOMEKEYS:wP,SIDE1KEYS:NP,SIDE2KEYS:AP,MODIFIERS:EP,PROMPT:"Enter Score",MOVEUP:SP,MOVEDOWN:vP,HOTKEYS:OP});function FP({scoreString:e,lowSide:t,outcome:r}){if(({scoreString:e}=xP({scoreString:e})),2===t){return e+(" "!==(e&&e[e.length-1])?" ":"")+r}return r+" "+e}function xP({scoreString:e}){if(!e)return{scoreString:""};let t=!1;for(let r of uP){let i=e?.indexOf(r);0===i?e=e.slice(r.length+1).trim()+" ":i>0&&(e=e.slice(0,i)),i>=0&&(t=!0)}return e?.trim()||(e=""),{scoreString:e,removed:t}}function _P({analysis:e,scoreString:t,sets:r,lowSide:i}){let n,a;if(!t)return{scoreString:t,sets:r};let{scoreString:o,removed:s}=xP({scoreString:t});if(t=o,s)return{scoreString:t,sets:r,outcomeRemoved:!0};let c=r[r.length-1]||{},u=Object.values(c).filter(e=>void 0!==e).length;c.setNumber&&1===u&&(c=(r=r.slice(0,r.length-1))[r.length-1]||{});let{tiebreakSet:d}=e.setFormat,{tiebreakTo:l,NoAD:p}=d||{},{isTiebreakEntry:m}=LP({brackets:UP,scoreString:t}),f=function(e){return e.split("").reduce((e,t,r)=>(t.match(/\d+/g)&&e.push(r),e),[]).pop()}(t);if(f>=0){n=t.slice(0,f);let{isTiebreakEntry:o}=LP({brackets:IP,scoreString:n}),{lastOpenBracketIndex:s,isTiebreakEntry:u}=LP({brackets:UP,scoreString:n}),d=n&&n[n.length-1].trim(),h=n&&!isNaN(d),g=e.isIncompleteSetScore;if(m&&u){let e=n.slice(s+1).split(MP),r=e?.length>0&&void 0!==e[0]&&!isNaN(parseInt(e[0]))&&parseInt(e[0])||void 0,a=e?.length>1&&void 0!==e[1]&&parseInt(e[1])||void 0,o=[r,a];if(a){let e=1===i?1:0;o[e]=(o?.[1-e]||0)+(p?1:2),(o[e]||0)<l&&(o[e]=l),n=t.slice(0,s+1),n+=o.join(MP)}else void 0!==r?(n=t.slice(0,s+1),n+=r):(n=t.slice(0,s),g=!0);c.side1TiebreakScore=o[0]||0,c.side2TiebreakScore=o[1]||0}if(n.length||(n=void 0),g){let t=c.side1Score?.toString();if(t){let e=t?.slice(0,t.length-1);c.side1Score=!isNaN(e)&&parseInt(e)||void 0,void 0===c.side1Score&&(c.side2Score=void 0)}e.isTimedSet?(a=c.side1Score?r:r?.slice(0,r.length-1)||[],a[r.length-1]=c):a=r?.slice(0,r.length-1)||[]}else if(h){let t=c.side2Score?.toString(),i=c.side1Score?.toString();if(!e.isTiebreakEntry&&!e.isMatchTiebreak)if(c.side2Score){let e=t?.slice(0,t.length-1);c.side2Score=!isNaN(e)&&parseInt(e)||void 0}else{let e=i?.slice(0,i.length-1);c.side1Score=!isNaN(e)&&parseInt(e)||void 0}e.isTimedSet?c.side1Score?(a=r||[],a[r.length-1]=c):a=r?.slice(0,r.length-1)||[]:(a=r||[],a[r.length-1]=c),a[a.length-1]&&Object.assign(a[a.length-1],{winningSide:void 0})}else o?(a=r||[],Object.assign(a[a.length-1]||{},{winningSide:void 0,side1TiebreakScore:void 0,side2TiebreakScore:void 0})):(m&&!u?a=r?.slice(0,r.length-1)||[]:(a=r,a[r.length-1]=c),m||(a[a.length-1].side2Score=0,a[a.length-1].winningSide=void 0));return{scoreString:n,sets:a}}return{scoreString:t,sets:r}}function LP({brackets:e=IP,scoreString:t}){if(!t)return{};let[r,i]=e.split(""),n=t.split(""),a=Math.max(...J(r,n));return{isTiebreakEntry:a>Math.max(...J(i,n)),lastOpenBracketIndex:a}}function BP(e){let{lowValue:t=0,NoAD:r=!1,tiebreakTo:i}=e||{};return t+1>=i?t+(r?1:2):parseInt(i)}function VP({matchUpFormat:e,matchUpStatus:t,winningSide:r,sets:i}){let n=Yn(e),{bestOf:a}=n,o=Math.ceil(a/2),s=i?.reduce((e,t)=>{let{winningSide:r}=t;return r&&e[r-1]++,e},[0,0])?.indexOf(o)+1||void 0;return gP.includes(t)&&r&&(s=r),{matchUpWinningSide:s}}function GP({ignoreTiebreak:e=!1,matchUpScoringFormat:t,matchUpFormat:r,isTiebreakSet:i,isDecidingSet:n,isTimedSet:a,set:o}){if(!o)return{error:$t,info:"missing set"};t=t||r&&Yn(r);let s=n&&t.finalSetFormat||t?.setFormat||{},{side1Score:c,side2Score:u}=o,{setTo:d,tiebreakAt:l}=s,p=c||u,m=jP({set:o}),f=Math.abs(c-u),h=c>=d||u>=d,g=i||c>=d&&u>=d||l&&l<d&&(c===l||u===l),I=e||g&&(1===m&&o.side1TiebreakScore>o.side2TiebreakScore||2===m&&o.side2TiebreakScore>o.side1TiebreakScore),U=!g&&s.NoAD||g||i&&s.tiebreakFormat?.NoAD?1:2;return!(!(a&&p||h&&(f>=U||g)||i)||g&&!I)}function jP({set:e}){if(e.side1Score||e.side2Score){if(e.side1Score>e.side2Score)return 1;if(e.side2Score>e.side1Score)return 2}else if(e.side1TiebreakScore||e.side2TiebreakScore){if(e.side1TiebreakScore>e.side2TiebreakScore)return 1;if(e.side2TiebreakScore>e.side1TiebreakScore)return 2}}function $P({analysis:e,set:t}){let r=jP({set:t}),{isDecidingSet:i,isTiebreakSet:n,matchUpScoringFormat:a}=e;return GP({matchUpScoringFormat:a,isDecidingSet:i,isTiebreakSet:n,set:t})&&r}function qP({lowSide:e,value:t,sets:r,scoreString:i,winningSide:n,matchUpStatus:a}){let o;return"r"===t?i?(o=!0,i=FP({scoreString:i,lowSide:e,outcome:"RET"}),n=2===e?1:2,a=fP):(o=!0,i=FP({scoreString:i,lowSide:e,outcome:"DEF"}),n=2===e?1:2,a=dP):"d"===t?(o=!0,i=FP({scoreString:i,lowSide:e,outcome:"DEF"}),n=2===e?1:2,a=dP):"w"===t?(o=!0,r=[],i="WO",n=2===e?1:2,a=lP):"s"===t&&i?(o=!0,i=FP({scoreString:i,lowSide:e,outcome:"SUS"}),a=mP,n=void 0):"a"===t?(o=!0,i=FP({scoreString:i,lowSide:e,outcome:"ABN"}),a=pP,n=void 0):"i"===t&&i&&(o=!0,i=FP({scoreString:i,lowSide:e,outcome:"INT"}),a=hP,n=void 0),{updated:o,sets:r,scoreString:i,matchUpStatus:a,winningSide:n}}function WP({matchUpFormat:e,scoreString:t,winningSide:r,value:i,sets:n}){let a=(n?.filter(e=>e?.winningSide)?.length||0)+(r?0:1),o=Yn(e),s=a===o?.bestOf,c=s&&o?.finalSetFormat||o?.setFormat||{},u=c?.timed,d=s&&n[o?.bestOf-1],l=d?.winningSide,{isTiebreakEntry:p}=LP({brackets:IP,scoreString:t}),{isTiebreakEntry:m}=LP({brackets:UP,scoreString:t}),f=p||m,h=!!c.tiebreakSet,g=t?.[t.length-1]?.trim(),I=t&&!isNaN(g),U=!f&&g===bP,S=p&&TP.includes(g),v=m&&TP.includes(g),y=m&&g===MP,w=t?.split(""),[P]=UP.split(""),T=w&&Math.max(...J(P,w)),D=w&&Math.max(...J(MP,w)),b=w&&D>T,M=n[n.length-1]?.winningSide,R=n?.length&&!M,N=uP.find(e=>t?.indexOf(e)>=0),A=!isNaN(i),E=i===PP,C=DP.includes(i),O=t?.split("").find(e=>TP.includes(e)),k=C&&m&&!v&&(y||!function({scoreString:e}){if(!e)return!1;let t=e&&e[e.length-1].trim(),r=e&&!isNaN(t),[i,n]=UP.split(""),a=e.split(""),o=Math.max(...J(i,a)),s=Math.max(...J(n,a)),c=Math.max(...J(MP,a));return r&&o>s&&c>o}({scoreString:t}));return{isTiebreakSetValue:h&&A,matchUpScoringFormat:o,setNumber:a,setFormat:c,matchTiebreakHasJoiner:b,isGameScoreEntry:R,isSpace:E,isCloser:C,isTiebreakCloser:C&&O&&f&&I,isDecidingSet:s,isTiebreakSet:h,isTimedSet:u,isNumericEnding:I,isNumericValue:A,hasOpener:O,hasOutcome:N,finalSet:d,finalSetIsComplete:l,lastSetIsComplete:M,isInvalidSetTiebreakValue:E&&f&&S,isInvalidMatchTiebreakValue:k,isTiebreakEntry:f,isSetTiebreakEntry:p,isMatchTiebreakEntry:m,isIncompleteSetScore:U,isIncompleteSetTiebreak:S,isIncompleteMatchTiebreak:v,isPartialMatchTiebreakValue:y}}function HP(e){let t,r,{lowSide:i=1,value:n}=e,{scoreString:a,sets:o,winningSide:s,matchUpStatus:c}=e,{matchUpFormat:u,shiftFirst:d,auto:l=!0}=e,p=d&&2===i||!d&&1===i;if(!CP.includes(n))return{updated:!1,info:"invalid key"};d&&(i=3-i);let{matchUpWinningSide:m}=VP({sets:o,winningSide:s,matchUpStatus:c,matchUpFormat:u});s=m;let f=WP({value:n,winningSide:s,scoreString:a,sets:o,matchUpFormat:u});if(RP.includes(n)&&(n=bP),f.hasOpener&&f.isTiebreakEntry&&!f.isTiebreakSet&&p&&0===I(n)&&(f.isTiebreakCloser=!0),DP.includes(n)&&f.hasOpener&&(n=""),DP.includes(n)&&(n=PP),f.lastSetIsComplete){let e=a?.length&&a[a.length-1];a&&" "!==e&&(a+=" ")}if(f.isTimedSet)({info:r,sets:o,scoreString:a,updated:t,matchUpStatus:c,winningSide:s}=function(e){let t,r,{sets:i,info:n,scoreString:a,winningSide:o,matchUpStatus:s}=e,{analysis:c,lowSide:u,value:d}=e;!i?.length&&d!==yP&&(i=[{setNumber:1}]);let l=i.length-1;if(wP.includes(d)){let e=i[i.length-1]||{},{side1Score:r,side2Score:l}=e;r&&!l?n="missing side2Score":c.finalSetIsComplete||o?n="final set is already complete":c.isIncompleteSetScore?n="incomplete set scoreString":c.isIncompleteSetScore||({sets:i,scoreString:a,winningSide:o,matchUpStatus:s,updated:t}=qP({lowSide:u,value:d,sets:i,scoreString:a,matchUpStatus:s,winningSide:o}))}else if(d===yP){if(({scoreString:a,sets:i,outcomeRemoved:r}=_P({analysis:c,scoreString:a,sets:i})),""===a?.trim()&&(a=a.trim()),a||(i=[]),r){let e=i[i.length-1]||{},{side1Score:t,side2Score:r}=e;if(t&&r){let n=(t>r?1:r>t&&2)||void 0;n&&(e.winningSide=n,i.push({setNumber:i.length+1}))}}s=void 0,o=void 0,t=!0}else if(c.hasOutcome)n="has outcome";else{if(o)return{sets:i,scoreString:a,winningSide:o,matchUpStatus:s,updated:!1,info:"matchUp is complete"};if(d===PP){let e=i[i.length-1]||{},{side1Score:r,side2Score:n}=e,s=(r>n?1:n>r&&2)||void 0;s&&!o&&!c.isIncompleteSetScore&&(i[i.length-1].winningSide=s,i.push({setNumber:i.length+1}),a+=" ",t=!0)}else if(d===bP&&void 0!==i[l].side1Score&&void 0===i[l].side2Score&&a&&c.isNumericEnding)a+="-",i[l].side2Score=0,s=void 0,o=void 0,t=!0;else if(!isNaN(d)){let e;if(void 0===i[l].side2Score){let r=I((i[l].side1Score||0).toString()+d).toString().slice(0,2);i[l].side1Score=I(r),e=i[l].side1Score.toString(),t=!0}else{let r=I((i[l].side2Score||0).toString()+d).toString().slice(0,2);i[l].side2Score=I(r),e=[i[l].side1Score,i[l].side2Score].join("-"),t=!0}if(t){let t=(i.slice(0,l)||[]).filter(e=>e).map(e=>{let{side1Score:t,side2Score:r}=e;return[t,r].join("-")}).join(" ");a=t?t+" "+e:e}}}return{sets:i,scoreString:a,winningSide:o,matchUpStatus:s,info:n,updated:t}}({analysis:f,lowSide:i,scoreString:a,sets:o,matchUpStatus:c,winningSide:s,value:n}));else if(wP.includes(n))f.finalSetIsComplete||s?r="final set is already complete":f.isTiebreakEntry||f.isIncompleteSetScore?f.isTiebreakEntry||f.isIncompleteSetScore?r="incomplete set scoreString or tiebreak entry":console.log("handle case",{value:n}):({sets:o,scoreString:a,matchUpStatus:c,winningSide:s,updated:t}=qP({lowSide:i,sets:o,scoreString:a,matchUpStatus:c,winningSide:s,value:n}));else if(n===yP)t=!0,({scoreString:a,sets:o}=_P({analysis:f,scoreString:a,sets:o,lowSide:i})),a||(o=[]),c=void 0,s=void 0;else if(f.hasOutcome)r="has outcome";else if(n!==bP||f.isMatchTiebreakEntry)if(n===MP&&f.isMatchTiebreakEntry&&!f.isSetTiebreakEntry)f.matchTiebreakHasJoiner?r="existing joiner":f.isNumericEnding&&(t=!0,a+=MP);else if([bP,MP].includes(n))r="invalid location for joiner";else{if(s)return{updated:!1,info:"matchUp is complete"};if(f.isIncompleteSetScore)f.isNumericValue&&({sets:o,scoreString:a,updated:t}=function({analysis:e,scoreString:t,sets:r,value:i}){let n;if(!r?.length)return{sets:[]};let a=r[r.length-1];i=I(i);let{validSide2Score:o,requiresTiebreak:s}=function({analysis:e,set:t={},value:r}){let i,n,a=e.isDecidingSet&&e.matchUpScoringFormat.finalSetFormat||e.matchUpScoringFormat.setFormat,{tiebreakAt:o,setTo:s,NoAD:c}=a,{side1Score:u}=t;return i=o&&o<s?u===o?r<=s:r<=o:u===s?c?r<s:r<=s+1:u===s-1?c?r<=s:r<=s+1:u===s+1?r===s||r===s-1:r<=s,i&&(n=o&&o<s?u===s&&r===o||u===o&&r===s:u>=s&&r>=s&&u!==r),{validSide2Score:i,requiresTiebreak:n}}({analysis:e,set:a,value:i});if(o){n=!0,t=(t||"")+i,a.side2Score=i;let o=$P({analysis:e,set:r[r.length-1]});a.winningSide=o||void 0,s?t+=IP.split("")[0]:e.isDecidingSet||(t+=" ")}return{sets:r,scoreString:t,updated:n}}({analysis:f,scoreString:a,sets:o,value:n}));else if(f.isInvalidMatchTiebreakValue)r="invalid matchUp tiebreak character";else if(f.isInvalidSetTiebreakValue)r="invalid set tiebreak character";else if(f.isTiebreakCloser){let e=f.isSetTiebreakEntry?IP:UP,r=e.split("").reverse()[0],i=e.split("")[0],n=o[o.length-1],{tiebreakFormat:s}=f.setFormat,{tiebreakTo:c,NoAD:u}=s||{},d=jP({set:n});if(!f.isTiebreakSet){let e=Number.parseInt(a.split(i).reverse()[0]),t=BP({lowValue:e,tiebreakTo:c,NoAD:u});1===d?(n.side1TiebreakScore=t,n.side2TiebreakScore=e):(n.side1TiebreakScore=e,n.side2TiebreakScore=t)}a=(a||"")+r,f.isDecidingSet||(a+=" ");let l=$P({analysis:f,set:n});n.winningSide=l||void 0,t=!0}else if(f.isTiebreakSetValue)({info:r,scoreString:a,sets:o,updated:t}=function({analysis:e,auto:t,lowSide:r,scoreString:i="",sets:n,value:a}){let o,s,{tiebreakSet:{tiebreakTo:c,NoAD:u}}=e.setFormat,[d]=UP.split("");if(e.isMatchTiebreakEntry||(i+=d),n[e.setNumber-1]){let{lastOpenBracketIndex:e}=LP({brackets:UP,scoreString:i}),d=(i.slice((e??0)+1)+(t?"":a)).split(MP);if((d[r-1]?.length||0)>=2)s="tiebreak digit limit";else if(t){1===r&&(d[0]=(d[0]||"")+a),2===r&&(d[1]=(d[1]||"")+a);let t=[d[0]||0,d[1]||0].map(e=>I(e)),s=1===r?1:0;t[s]=t[1-s]+(u?1:2),t[s]<c&&(t[s]=c);let l=n[n.length-1];l.side1TiebreakScore=t[0],l.side2TiebreakScore=t[1],i=i.slice(0,(e??0)+1),i+=t.join(MP),o=!0}else{let e=[d[0]||0,d[1]||0].map(e=>I(e)),t=n[n.length-1];t.side1TiebreakScore=e[0],t.side2TiebreakScore=e[1],i+=a,o=!0}}else{let e=BP({lowValue:I(a||0),tiebreakTo:c,NoAD:u}),t=[I(a),e];2===r&&t.reverse();let s={side1TiebreakScore:t[0],side2TiebreakScore:t[1],setNumber:n?.length+1||1};n.push(s),i+=t.join(MP),o=!0}return{info:s,scoreString:i,sets:n,updated:o}}({analysis:f,auto:l,lowSide:i,scoreString:a,sets:o,value:n}));else if(f.isSetTiebreakEntry){let[e]=IP.split(""),i=Math.max(...J(e,a.split(""))),o=a.slice(i+1),s=o&&0===I(o),c=I(o?o+n:n),{tiebreakFormat:u}=f.setFormat,{tiebreakTo:d,NoAD:l}=u||{};!s&&o.length<2?l&&c>d-1?r="invalid low value for NoAD tiebreak":(t=!0,a=(a||"")+n):r=s?"tiebreak begins with zero":"tiebreak digit limit"}else if(f.isCloser)r=`invalid key: ${n}`;else if(f.isGameScoreEntry)r="game scoreString entry";else if(f.lastSetIsComplete||!o.length){t=!0;let{scoreString:e,set:r}=function({analysis:e,lowSide:t,scoreString:r,value:i}){let{setTo:n,tiebreakAt:a,NoAD:o}=e?.setFormat||{},s=i===parseInt(a||n);if(a&&a<n&&i>a)return{scoreString:r};if(o&&i===n||i>n)return{scoreString:r};let c=[i,s?i+1:i+1===n?i+(o?1:2):n];2===t&&c.reverse();let u=IP.split("")[0];r=(r||"")+(c.join(bP)+(s?u:" "));let d={side1Score:c[0],side2Score:c[1]},l=$P({analysis:e,set:d});return d.winningSide=l||void 0,{scoreString:r,set:d}}({analysis:f,lowSide:i,scoreString:a,value:I(n)});r&&(r.setNumber=o?.length+1||1),o=o?.concat(r).filter(Boolean)||[r],a=e||void 0}else console.log("error: unknown outcome")}else(!f.isSetTiebreakEntry||f.isSetTiebreakEntry&&!f.isNumericEnding)&&(t=!0,({scoreString:a,sets:o}=_P({analysis:f,scoreString:a,sets:o,lowSide:i})),c=void 0);if(t){o=o?.filter(Boolean);let{matchUpWinningSide:e}=VP({sets:o,winningSide:s,matchUpStatus:c,matchUpFormat:u});return s=e,!e||c&&![Md,Pd].includes(c)?a&&!s&&![mP,pP,hP].includes(c)&&(c=void 0):(c="COMPLETED",o=o.filter(e=>{let{side1Score:t,side2Score:r,side1TiebreakScore:i,side2TiebreakScore:n}=e;return t||r||i||n})),{updated:t,scoreString:a,sets:o,winningSide:s,matchUpStatus:c,info:r}}return{updated:t,scoreString:a,sets:o,winningSide:s,matchUpStatus:c,info:r}}var YP="\\d+-\\d+",zP="\\d+-\\d+\\(\\d+\\)",KP="\\[\\d+-\\d+\\]",JP=new RegExp(`(${YP}),`,"g"),QP=new RegExp(`(${zP}),`,"g"),XP=[YP,zP,KP,"\\d+-\\d+\\(\\d+-\\d+\\)"],ZP=["0","1","2","00","01","10","11","002","012","102","112","000","001","010","100","011","101","110","111","002","012","102","112","0002","0012","0102","1002","0112","1012","1102","1112","3","03","13","013","103"].map(e=>{let t=e.split("").map(e=>XP[e]).join(" ");return new RegExp(`^${t}$`)});function eT(e){return!e||ZP.some(t=>t.test(e))}function tT(e){return/^\(\d+\)$/.test(e)||/^\(\d+$/.test(e)}function rT(e){let t=(r=e,r?.split("-").join("").split("/").join(""));var r;if(/^\d+$/.test(t)&&2===t.length){let e=t.split("");return 1===Math.abs(e.reduce((e,t)=>+e-+t))}return!1}function iT(e,t){let r=[e.slice(t,t+2),t?e.slice(0,1):e.slice(2)].map(e=>parseInt(e.join("")));t&&r.reverse();let i=r;if(Math.abs(i.reduce((e,t)=>+e-+t))>=2)return i.join("-")}function nT(e){return 2===e.length?e.split("").join("-"):([", ",",","/"," "].forEach(t=>e=e.split(t).join("-")),e=e.replace(/-{2,}/,"-"))}function aT(e){return e.startsWith("(")&&e.endsWith(")")}function oT(e){if(!/^[\d-]+(\(\d\))*$/.test(e))return e;let t=J("-",e.split(""));if(!t.length)return e;let r=e.split("-"),i=!(r.length%2),n=!!(t.length%2);return i&&n&&t.length>r.length/2&&t.filter((e,t)=>t%2).forEach(t=>{e=e.substring(0,t)+" "+e.substring(t+1)}),e}function sT({score:e}){let t,r=e.split(""),i=[],n=()=>t=[void 0,void 0,void 0],a=()=>{let e=`${t[0]}-${t[1]}`;return t[2]&&(e+=` (${t[2]})`),n(),t.push(t),e};n();let o=()=>void 0!==t[0]&&void 0!==t[1]&&Math.abs(parseInt(t[0])-parseInt(t[1]));for(;r.length;){let e=r.shift(),n=E(e)&&parseInt(e),s=void 0!==t[0]&&void 0!==t[1];if(E(n)){if(void 0===t[0]){t[0]=n;continue}if(void 0===t[1]&&(t[1]=n,o())){i.push(a()),t=[void 0,void 0];continue}if(s&&1===r.length&&E(r[0])){let e=r.pop();t[0]=t[0].toString()+t[1].toString(),t[1]=e,i.push(a()),t=[void 0,void 0]}s&&o()}}return{sets:i}}function cT(e){let t=e.indexOf("1"),r=e.split(""),i=r.every(e=>!isNaN(e));if(i&&3===e.length&&0===t){let e=iT(r,t);if(e)return e}if(i&&7===e.length&&t>3){let e=iT(r.slice(4),t-4);if(e)return`${r[0]}-${r[1]} ${r[2]}-${r[3]} ${e}`}}function uT(e){let{score:t}=e,{applied:r,matchUpStatus:i}=e,n=t?.toString().split(""),a=n?.every(e=>E(e)),o=e=>Math.abs(e[0]-e[1]);if("number"==typeof t||a){t=t.toString().toLowerCase(),a&&(t=n.join(""));let e=a?n.map(e=>parseInt(e)):t.split("").map(e=>parseInt(e)),{sets:i}=sT({score:t});if(e.length,3===t.length&&1===o(e.slice(0,2))){let[i,n,a]=e;t=`${i}-${n}(${a})`,r.push("numericTiebreakPattern1")}else if(3===t.length&&1===e[0]){let[i,n,a]=e;t=`[${i}${n}-${a}]`,r.push("numericTiebreakPattern2")}else if(4===t.length&&1===o(e.slice(0,2))&&"987654".split("").includes(e[0].toString())){let[i,n,a,o]=e;t=`${i}-${n}(${Math.min(a,o)})`,r.push("numericTiebreakPattern3")}else if(4===t.length&&1===e[0]&&1===e[2]){let[i,n,a,o]=e;t=`[${i}${n}-${a}${o}]`,r.push("bigSuper")}else if(4===t.length){let[i,n,a,o]=e;t=`${i}${n} ${a}${o}`,r.push("split4")}else if(5===t.length&&1===o(e.slice(0,2))){let[i,n,a,o,s]=e;t=`${i}-${n}(${a}) ${o}-${s}`,r.push("numericTiebreakPattern4")}else if(5===t.length&&1===o(e.slice(3))){let[i,n,a,o,s]=e;t=`${i}-${n} ${a}-${o}(${s})`,r.push("numericTiebreakPattern5")}else if(7===e.length)if(o(e.slice(0,2))>1&&o(e.slice(2,4))>1&&1===e[4]){let[i,n,a,o,s,c,u]=e;t=`${i}-${n} ${a}-${o} [${s}${c}-${u}]`,r.push("numericTiebreakPattern6")}else if(1===o(e.slice(0,2))&&o(e.slice(3,5))>1&&o(e.slice(5,7))>1){let[i,n,a,o,s,c,u]=e;t=`${i}-${n}(${a}) ${o}-${s} ${c}-${u}`,r.push("numericTiebreakPattern7")}else if(o(e.slice(0,2))>1&&1===o(e.slice(2,4))&&o(e.slice(5,7))>1){let[i,n,a,o,s,c,u]=e;t=`${i}-${n} ${a}-${o}(${s}) ${c}-${u}`,r.push("numericTiebreakPattern8")}else if(o(e.slice(0,2))>1&&o(e.slice(2,4))>1&&1===o(e.slice(4,6))){let[i,n,a,o,s,c,u]=e;t=`${i}-${n} ${a}-${o} ${s}-${c}(${u})`,r.push("numericTiebreakPattern9")}else t=t.slice(0,2)+" "+t.slice(2,4)+" "+t.slice(4),r.push("numericMatchTiebreakPattern");else if(t.length%2){let e=cT(t);e&&t!==e&&r.push("parsedSuperPattern"),t=e??t}else{let i=re(t.split(""),2).map(e=>e.join("")),n=i.map(e=>{let[t,r]=e.split("").map(e=>parseInt(e)),i=t>r?1:2;return Math.abs(t-r)>1&&i||-1*i}),a=n.reduce((e,t)=>e>0&&t>0,1),o=j(n),s=j(n.map(e=>Math.abs(e))),c=n[0]<0,u=!c&&n[1]<0;if(n[0]>0&&n[1]>0&&n[0]!==n[1])t=[i.slice(0,2).join(" "),i.slice(2).join("-")].join(" "),r.push("numeric3rdSetTiebreakPattern");else if(a)t=i.join(" "),r.push("chunkSplit");else if(6===e.length){if(2===o[1]||2===o[2])if(Object.values(s).includes(3)){let[i,a,o,s,c,u]=e,d=n.reduce((e,t,r)=>t<0?r:e,void 0);if(0===d){t=`${i}-${a}(${Math.min(o,s)}) ${c}-${u}`,r.push("chunkSplitTiebreak1")}else if(1===d){t=`${i}-${a} ${o}-${s}(${Math.min(c,u)})`,r.push("chunkSplitTiebreak2")}else t=`${i}-${a} ${o}-${s}`,r.push("chunkSplitTrimExtraneous")}else t=i.join(" "),r.push("chunkSplit")}else if(8===e.length){let[r,i,a,o,s,d,l,p]=e;c||u?1===e[5]&&(t=c?`${r}-${i}(${a}) ${o}-${s} [${d}${l}-${p}]`:`${r}-${i} ${a}-${o}(${s}) [${d}${l}-${p}]`):(n[0],n[1])}}}return{score:t,applied:r,matchUpStatus:i}}function dT(e){let t=[0,0],r=[],i=e.split(" "),n=/(\d+)-(\d+)/;i.forEach(e=>{if(n.test(e)){let i=e.match(n).slice(1).map(e=>Number.parseInt(e)),a=i[0]>i[1]?1:i[1]>i[0]&&2;a&&(t[a-1]+=1,r.push(a))}});let a=t[0]>t[1]?1:t[1]>t[0]&&2,o=t[0]>0&&t[0]===t[1],s=t.reduce((e,t)=>e+t,0);return{setsWon:t,setsTied:o,setWinners:r,totalSets:s,winningSide:a}}var lT={handleTiebreakSlashSeparation:function({score:e}){let t=new RegExp(/\(\d+\/\d+\)/g),r=e.match(t);for(let i of r||[]){let t=i.replace("/","-");e=e.replace(i,t)}return{score:e}},handleSetSlashSeparation:function({score:e}){return new RegExp(/-\d+\/\d+-/).test(e)&&(e=e.split("/").join(" ")),{score:e}},punctuationAdjustments:function({score:e,applied:t}){e=function(e){let t="[];()",r=["[","("],i=Object.assign({},...t.split("").map(e=>({[e]:0}))),n="",a=e.split("").map(e=>{let a=t.includes(e)&&e,o=r.includes(a);if(o&&a)return i[a]+=1,n=a,e;if(!o&&a&&n&&a!==n){i[n]-=1;let e=("[];".includes(n)?"[];":"()".includes(n)&&"()")||"",t=e.split("").find(e=>e!==n);if(!e.includes(a))return i[a]||(n=""),t;i[n]||(n="")}return e}).join("");return e!==a?a:e}(e);let r=/\)(\d+)/g;if(r.test(e))for(let v of e.match(r)){let t=v.replace(")",") ");e=e.replace(v,t)}let i=/\(([\d- ]+)\)/,n=(e=(e=e.replace(/\)\//g,") / ")).replace(/\/\)/g,")")).match(/\(([\d- ]+)\)/g);for(let v of n||[]){let[t]=v.match(i).slice(1),r=t.replace(/ /g,"");e=e.replace(v,`(${r})`)}let a=/\(\(\d-\d\)\)/g;if(a.test(e)){let t=e.match(a);t.length&&t.forEach(t=>{let r=t.match(/\((\(\d-\d\))\)/).slice(1)[0];e=e.replace(t,r)})}if(a=/\(\((\d)\)\)/g,a.test(e)){let t=e.match(a);t.length&&t.forEach(t=>{let r=t.match(/\((\(\d\))\)/).slice(1)[0];e=e.replace(t,r)})}/(^|\s)6-,/.test(e)&&(e=e.replace(/(^|\s)6-,/g,"6-0,"));let o=new RegExp(/[-,]{2,}/g);e=e.replace(o,"-"),["- "," -"].forEach(t=>{let r=new RegExp(`(\\d+)${t}(\\d+)`,"g"),i=e.match(r);i&&i.forEach(r=>e=e.replace(r,r.split(t).join("-")))}),/^[(-/,]+$/.test(e)&&(e=""),/\)[-/,]+$/.test(e)&&(e=e.slice(0,e.length-1)),/\d \/\d/.test(e)&&(e=e.replace(/ \//g,"/")),e.includes(" /")&&(e=e.replace(/ \//g," "));let s=/\(\d+, \)/g;s.test(e)&&e.match(s).forEach(t=>{let[r]=t.match(/\((\d+), \)/).slice(1);2===r.length?e=e.replace(t,`(${r})`):1===r.length&&"6"===r&&(e=e.replace(t,"(6-0)"))});let c=/\((\d+)\/\)/g;c.test(e)&&e.match(c).forEach(t=>{let[r]=t.match(/\((\d+)\/\)/).slice(1);e=2===r.length?e.replace(t,`(${r})`):1===r.length&&"6"===r?e.replace(t,"(6-0)"):e.replace(t,`(${r})`)});let u=/\d\/\d\/,/g;u.test(e)&&e.match(u).forEach(r=>{let[i]=r.match(/(\d\/\d)\/,/).slice(1);e=e.replace(r,`${i},`),t.push("slashComma")});let d=/\(\/(\d+)\)/g;d.test(e)&&e.match(d).forEach(t=>{let[r]=t.match(/\(\/(\d+)\)/).slice(1);e=2===r.length?e.replace(t,`(${r})`):1===r.length&&parseInt(r)<6?e.replace(t,`(6-${r})`):e.replace(t,`(${r})`)});let l,p,m,f,h,g=()=>{h=j(e.split("")),p=h["("]===(h[")"]||0)+1,l=(h["("]||0)+1===h[")"],m=h["["]===h["]"]+1,f=p&&!m};g();let I=/(\d+-\d+\(\d+)0,/;if(I.test(e)){let[t]=e.match(I).slice(1);e=e.replace(I,t+")")}if(h["("]===h[")"]&&h["("]>1){let t=e.split(")(").join(") (").split(" ");e=t.every(aT)?t.map(e=>{let t=e.slice(1,e.length-1);return t.length>2?t:e}).join(" "):t.join(" ")}g();let U=/[A-Za-z]+/.test(e),S=/\d+/.test(e);if(!U&&!S)return{score:""};if(/^\[.+\]$/.test(e)&&"()/,- ".split("").some(e=>h[e])&&(e=e.slice(1,e.length-1)),/^\(.+\)$/.test(e)&&1===h["("]&&1===h[")"]&&"[]/,".split("").some(e=>h[e]>1)&&(e=e.slice(1,e.length-1)),e.startsWith("(")&&e.endsWith("))")&&(e=e.slice(1,e.length-1)),h["("]>(h[")"]||0)&&"("===e[e.length-1]&&(e=e.slice(0,e.length-1)+")",g()),1===h["("]&&!h[")"]&&"("===e[0]&&(e+=")",g()),h["("]>(h[")"]||0)&&"(("===e.slice(0,2)&&(e=e.slice(1)),l){if(/^9\d/.test(e))e="("+e.slice(1);else if("("!==e[0])e="("+e;else{let t=[],r=0;for(let i of e.split("").reverse())")"===i&&(r?t.push("("):r+=1),"("===i&&(r-=1),t.push(i);t.reverse(),e=t.join("")}g()}if(h[")"]>(h["("]||0)&&")"===e[0]&&(e="("+e.slice(1),g()),f&&(e.endsWith(9)||/\d+0$/.test(e))&&(e=e.slice(0,e.length-1)+")",g()),f&&(!e.endsWith(")")||e.startsWith("(("))&&(e+=")",g()),f){let t="",r=0;for(let i of e.split(""))"("===i&&(r?t+=")":r+=1),")"===i&&(r-=1),t+=i;e=t}if(g(),m&&!p&&(e+="]"),e.includes("([")&&e.includes("])")&&(e=e.split("([").join("[").split("])").join("]"),g()),/\(\d+0$/.test(e)&&(e=e.slice(0,e.length-1)+")"),g(),1===h[")"]&&!h["("]&&e.endsWith(")")&&(e=e.slice(0,e.length-1)),e.startsWith("(")&&e.endsWith(")")&&1===h["("]&&1===h[")"]&&(e=e.slice(1,e.length-1),g()),/^\([\d ]+.*[\d ]+\)$/.test(e)&&h["("]===h[")"]){let t=e.slice(1,e.length-1);(e=>{let t=e.indexOf("("),r=e.indexOf(")");return t>=0&&r>=0&&t<r})(t)&&(e=t,g())}return{score:e,applied:t}},handleGameSeparation:function({score:e}){let t=new RegExp(/^\d+\/\d+/),r=e.split(" ");r.some(e=>t.test(e))&&(e=r.map(e=>t.test(e)?e.replace("/","-"):e).join(" "));let i=/^(\d+), *(\d+)$/;if(i.test(e)){let[t,r]=e.match(i).slice(1);e=[t,r].join("-")}return{score:e}},joinFloatingTiebreak:function({score:e}){if("string"!=typeof e)return{score:e};let t=e=>e?.split("-").join("").split("/").join(""),r=e=>e.split("[").join("(").split("]").join(")"),i=(e=e.split(", ").join(" ")).split(" ");e=i.map(e=>{let t=/^-(\d+)$/;if(t.test(e)){let[r]=e.match(t).slice(1);if(2===r.length)return r.split("").join("-")}return e}).join(" "),i=e.split(" ");let n=i.filter(tT),a=0,o="";for(let p of n){let e=J(p,i).find(e=>!a||e>a),r=i.slice(a,e-1),n=i[e-1],s=t(n);if(/^\d+$/.test(s)&&2===s.length){let t=s.split(""),i=Math.abs(t.reduce((e,t)=>+e-+t));if(1===i){o+=[r.join(" "),[n,p].join("")].join(" "),a=e+1}else if(0===i){let i=Math.max(...t);if([4,5,6,7,8,9].includes(i)){let t=[i,[6,4].includes(i)?i+1:i-1].sort().reverse().join("-");o+=[r.join(" "),[t,p].join("")].join(" "),a=e+1}}}}if(n.length&&o.length){return o=[o,i.slice(a).join(" ")].join(" "),{score:o.trim()}}if(2===i.length&&["(","["].some(e=>i[1].includes(e))){let e=t(i[0]).split("");if(1===Math.abs(e.reduce((e,t)=>+e-+t,0)))return i[1]=r(i[1]),{score:i.join("")}}let s=i.map(e=>function(e){return/^\(\d+-\d+\)$/.test(e)||/^\[\d+-\d+\]$/.test(e)}(e)?"bracket":rT(e)&&"set");if(s.includes("set")&&s.includes("bracket")){let e,t="";return i.forEach((i,n)=>{"bracket"===s[n]&&"set"===e?(i=r(i),t+=i):t+=` ${i}`,e=s[n]}),{score:t.trim()}}i=e.split(" ");let c,u=i.map(e=>{let t=new RegExp(/^(\d+)-(\d+)$/);if(t.test(e)){let[r,i]=e.match(t).slice(1),n=Math.abs([r,i].reduce((e,t)=>+e-+t,0)),a=Math.max(r,i);if(1===n)return c="tiebreakSet",c;if(n>=2&&a>=7&&"tiebreakSet"===c)return c="tiebreak",c}}),d=J("tiebreak",u);if(d.length){let t="";i.forEach((e,r)=>{d.includes(r)?t+=`(${e}) `:d.includes(r+1)?t+=`${e}`:t+=`${e} `}),e=t.trim()}let l=/(\d+-\d+)\((\d+)-(\d+)\)$/;if(l.test(e)){let[t,r,i]=e.match(l).slice(1),n=Math.max(r,i)>=10;!rT(t)&&n&&(e=e.replace(l,`${t} [${r}-${i}]`))}return u=[],{score:e=e.split(" ").map(e=>{let t=/^\((.*)\)$/,r=t.test(e),i=(new RegExp(KP).test(e)?"super":new RegExp(zP).test(e)&&"tiebreak")||new RegExp(YP).test(e)&&"standard"||"unknown";return u.push(i),"standard"===i&&r?e.match(t)[1]:e}).join(" ")}},handleBracketSpacing:function({score:e,applied:t}){return e.includes("( ")&&(t.push("removeParenSpacingAfterOpen"),e=e.split("( ").map(e=>e.trim()).join("(")),e.includes(" )")&&(t.push("removeParenSpacingBeforeClose"),e=e.split(" )").map(e=>e.trim()).join(")")),[JP,QP].forEach(r=>{let i=e.match(r);i?.length&&(i.forEach(t=>{e=e.replace(t,t.slice(0,t.length-1)+" ")}),t.push("setsEndComma"))}),{score:e=e.split(" ").filter(Boolean).map(oT).join(" "),applied:t}},handleSpaceSeparator:function({score:e}){if(e.includes(",")){let t=e.split(",").map(e=>e.trim()),r=e=>/\d \d/.test(e);t.every(r)&&(e=t.map(e=>{let t=/\d+ \d+/g;for(let r of e.match(t)){let[t,i]=r.match(/(\d+) (\d+)/).slice(1);e=e.replace(r,`${t}-${i}`)}return e}).join(" "))}if(e.includes(" ")){let t=e.replace(/[ ,]/g,"");t.split("").every(e=>E(e))&&4===t.length&&(e=t)}return{score:e}},separateScoreBlocks:function({score:e,applied:t}){return"string"!=typeof e?{score:e}:{score:e=e.toLowerCase().split(" ").map(e=>{if(/^\d+$/.test(e)&&e.length>2){let r=e.indexOf("1");if(e.length%2){if(3===e.length&&0===r){let i=iT(e.split(""),r);return t.push("getSuper"),i}}else{let{score:r,applied:i}=uT({score:e,applied:[]});r!==e&&(e=r,t.push(...i))}}return e}).join(" "),applied:t}},matchKnownPatterns:function({score:e,applied:t}){for(let P of[".",","," ","/"]){let r=new RegExp(`^(\\d+)\\${P}(\\d+)$`);if(r.test(e)){let i=e.match(r).slice(1).map(e=>parseInt(e)),n=Math.abs(i[0]-i[1]);n<=10&&n>=2&&(e=e.split(P).join("-"),t.push("variedJoinerPattern"))}}e.includes(";")&&(e=e.split(";").join(" "),t.push("semicolon set separation"));let r=/(^|\s)(\d)\/(\d)(\d)\/(\d)(\(|$)/;if(r.test(e)){let[i,n,a,o,s,c]=e.match(r).slice(1);e=e.replace(r,`${i}${n}-${a} ${o}-${s}${c}`),t.push("smashSlashPattern")}/.*\s6[/-]+$/.test(e)&&(e+="0",t.push("incompleteFinalSetPattern"));let i=/\(6,\)/g;i.test(e)&&(e=e.replace(i,"(6, 0)"),t.push("missingZeroPattern1"));let n=/^\d{3,}\(/,a=/\(\d+\)\d+/;[n,a].forEach(()=>{e=e.split(" ").map(e=>(n.test(e)&&(e=e.replace("("," (")),a.test(e)&&(e=e.replace(")",") ")),e)).join(" "),t.push("spaceConsiderationPatterns")});let o=oT(e);o!==e&&(e=o,t.push("deDashMash"));let s=/^(\d)[-/,]+(\d{2})[-/,]+(\d)$/;if(s.test(e)){let[r,i,n]=e.match(s).slice(1),[a,o]=i.split("");e=`${r}-${a} ${o}-${n}`,t.push("smashSetPattern")}let c=/^(\d+)[ -](\d+)$/,u=/^([\d -]+)\/([\d -]+)$/;if(u.test(e)){let[r,i]=e.match(u).slice(1),n=r.trim(),a=i.trim();if(c.test(n)&&c.test(a)){let r=n.match(c).slice(1,3).join("-"),i=a.match(c).slice(1,3).join("-");e=`${r} ${i}`,t.push("slashSeparationPattern")}}let d=/^([\d -]+),([\d -]+)$/;if(d.test(e)){let[r,i]=e.match(d).slice(1),n=r.trim(),a=i.trim();if(c.test(n)&&c.test(a)){let r=n.match(c).slice(1,3).join("-"),i=a.match(c).slice(1,3).join("-");e=`${r} ${i}`,t.push("commaSeparationPattern")}}let l=/^\d \d,/;if(l.test(e)){let r=e.match(l)[0],i=r.slice(0,r.length-1).split(" ").join("-");e=e.replace(r,i),t.push("singleSetCommaSeparationPattern")}let p=0,m=/(\d+)-(\d{2})-(\d+)/;for(;m.test(e)&&p<3;){let[r,i,n]=e.match(m).slice(1),a=i.split(""),o=`${r}-${a[0]} ${a[1]}-${n}`;e=e.replace(m,o),t.push("noSetSeparationPattern"),p+=1}let f=e.match(/(^|\s)7-6\s(\d+)\s/g);if(f?.length){let r=/(^|\s)7-6\s(\d+)\s/;f.forEach(i=>{let n=i.match(r).slice(2)[0];e=e.replace(i,`7-6(${n}) `),t.push("floatingTiebreakPattern1")})}let h=e.match(/\d \d /);h?.forEach(r=>{let i=r.slice(0,r.length-1).split(" ").join("-");e=e.replace(r,i),t.push("spaceSeparatedSetPattern1")}),h=e.match(/ \d \d$/),h?.forEach(r=>{let i=" "+r.slice(1).split(" ").join("-");e=e.replace(r,i),t.push("spaceSeparatedSetPattern2")});let g=/^\d, *\d\/\d, *\d/;if(g.test(e)){let r=e.match(g)[0],i=r.split("/").map(e=>`(${e})`).join(" ")+" ";e=e.replace(r,i),t.push("slashCommaSetPattern")}let I=/\(6-\)/g;I.test(e)&&(e=e.replace(I,"(6-0)"),t.push("missingZeroPattern2"));let U=/(?<!-)(\d+)\/(\d+)(?!-)/g;if(U.test(e)){let r=e.match(U),i=/(?<!-)(\d+)\/(\d+)(?!-)/,n=e;r.forEach(e=>{let[t,r]=e.match(i).slice(1),a=`${t}-${r}`;n=n.replace(e,a)}),e=n,t.push("slashSetPattern")}let S=/(.*)\s(1\d)\s(\d+)$/;if(S.test(e)){let[r,i,n]=e.match(S).slice(1);r.replace(/\D/g,"").length>=4&&(e=r+` ${i}${n}`,t.push("spaceSeparatedSuperPattern"))}let v=/(^|\s)(\d+-\d+)\s(\d+)(\s|$)/g;for(let P of e.match(v)||[]){let[r,i,n,a]=P.match(/(^|\s)(\d+-\d+)\s(\d+)(\s|$)/).slice(1),[o,s]=i.split("-").map(e=>parseInt(e));1===Math.abs(o-s)&&(e=e.replace(P,`${r}${i}(${n})${a}`),t.push("spaceSeparatedSetPattern"))}let y=/\d-\d \(\d{1,2}\)(\s|$|,)/g;for(let P of e.match(y)||[]){let r=/(\d-\d) \((\d{1,2})\)(\s|$|,)/,[i,n,a]=P.match(r).slice(1),[o,s]=i.split("-").map(e=>parseInt(e));1===Math.abs(o-s)&&(e=e.replace(P,`${i}(${n})${a}`),t.push("floatingTiebreakPattern2"))}let w=/(^|\s)(\d \d)\(/g;for(let P of e.match(w)||[]){let r=/(^|\s)(\d \d)\(/,[i,n]=P.match(r).slice(1);e=e.replace(P,`${i}${n.split(" ").join("-")}(`),t.push("spacedTiebreakPattern")}return{score:e,applied:t}},removeDanglingBits:function({score:e,attributes:t}){(e.endsWith(" am")||e.endsWith(" pm"))&&(e=""),e=e.replace(/[A-Za-z]+/g,"").trim(),[".",","].some(t=>e.endsWith(t))&&(e=e.slice(0,e.length-1));let r="()/-".split("").some(t=>e.includes(t));/ \d$/.test(e)&&r&&(t={removed:e.slice(e.length-2).trim()},e=e.slice(0,e.length-2));let i=/(.*)[A-Za-z]+$/;return i.test(e)&&(e=e.match(i).slice(1)[0].trim()),{score:e,attributes:t}},removeErroneous:function({score:e,applied:t}){return"string"!=typeof e?{score:e}:[3,4].includes(e.length)&&cT(e)?{score:cT(e)}:{score:e=e.toLowerCase().split(" ").map(e=>{if(!/^\d+$/.test(e)||1!==e.length)return e;t.push("removeErroneous1")}).filter(Boolean).join(" "),applied:t}},handleDefaulted:function({score:e,profile:t,applied:r}){e=e?.toString().toLowerCase();let i=/^(.*\d+.*)(def|defaulted)+[A-Za-z ]*$/;if(i.test(e)){let[t]=e.match(i).slice(1);return r.push("handleDefaulted"),{score:t.trim(),matchUpStatus:"defaulted",applied:r}}let n=t?.matchUpStatuses?.defaulted,a=["dft",...Array.isArray(n)?n:[n].filter(Boolean)].find(t=>e?.endsWith(t));return a?(r.push("handleDefaulted"),{matchUpStatus:"defaulted",score:e?.replace(a,"").trim(),applied:r}):{score:e}},handleWalkover:function({score:e,applied:t}){return["walkover","wo","w/o","w-o"].includes(e?.toString().toLowerCase())?(t.push("handleWalkover"),{matchUpStatus:"walkover",score:"",applied:t}):{score:e}},properTiebreak:function({score:e,matchUpStatus:t}){let r=e?.split(" ");e=r.map(e=>{if(e.endsWith("]")){let t=e.split("[");if(rT(t[0]))return t[0]+`(${t[1].slice(0,-1)})`}return e}).join(" ");let i=new RegExp(/(\([\d ]+\))/g);if(i.test(e))for(let s of e.match(i)){let t=s.replace(" ","-").match(/\((.*)\)/)?.[1];if(E(t)&&t?.[0]>2)if([2,4].includes(t.length))t=t.split("").join("-");else if(3===t.length){let e=t.indexOf("1");t=iT(t.split(""),e)}e=e.replace(s,`(${t})`)}r=e?.split(" ");let n=new RegExp(/^(\d[-/]+\d)\((\d+)[-/]+(\d+)\)$/),a=r.length-1;e=r.map((e,r)=>{let i=[void 0,"","COMPLETED"].includes(t)||r!==a;if(n.test(e)&&i){let[t,r,i]=Array.from(e.match(n)).slice(1);return`${t}(${Math.min(r,i)})`}return e}).join(" "),r=e?.split(" "),n=new RegExp(/^(\d{2})\((\d+)\)$/),e=r.map(e=>{if(n.test(e)){let[t,r]=Array.from(e.match(n)).slice(1),i=t.split("");return`${i[0]}-${i[1]}(${r})`}return e}).join(" "),r=e?.split(" "),n=new RegExp(/^\((\d[-/]+\d)\)(\d+)$/),e=r.map(e=>{if(n.test(e)){let[t,r]=Array.from(e.match(n)).slice(1);return rT(t)?`${t}(${r})`:t}return e}).join(" "),r=e?.split(" "),n=new RegExp(/^1-0\((\d+)\)$/),e=r.map(e=>{if(n.test(e)){let[t]=e.match(n).slice(1);return`[${t<9?10:Number.parseInt(t)+2}-${t}]`}return e}).join(" ");let o=/\((\d)+0 /;if(o.test(e)){let t=e.match(o)[1];e=e.replace(o,`(${t}) `)}return{score:e}},handleNumeric:uT,handleRetired:function({score:e,profile:t,applied:r}){e=e?.toString().toLowerCase();let i=/^(.*\d+.*)(ret|con)+[A-Za-z ]*$/;if(i.test(e)){let[t]=e.match(i).slice(1);return r.push("handleRetired"),{score:t.trim(),matchUpStatus:"retired",applied:r}}let n=t?.matchUpStatuses?.retired,a=["rtd",...Array.isArray(n)?n:[n].filter(Boolean)].find(t=>e?.endsWith(t));return a?(r.push("handleRetired"),{matchUpStatus:"retired",score:e?.replace(a,"").trim(),applied:r}):{score:e}},containedSets:function({score:e,attributes:t,identifier:r}){if("string"!=typeof e)return{score:e,identifier:r};let i=new RegExp(/\([\d,/ ]+\)/g),n=e.match(i);for(let c of n||[]){let t=c.match(/^\((.*)\)$/)?.slice(1)?.[0],r=e.split(c)[0].split(")").reverse()[0].replace(/\D/g,"");if(2===t?.length&&r?.length>=2){let e=r.slice(r.length-2).split("").map(e=>parseInt(e));if(1===Math.abs(e[0]-e[1]))continue}let i=oT(nT(t));e=e.replace(c,`(${i})`).trim()}let a=new RegExp(/\[[\d,/ ]+\]/g);if(e.match(a)?.forEach(t=>{let r=nT(t.match(/^\[(.*)\]$/)[1]);e=e.replace(t,`(${r}) `).trim()}),e.startsWith("(")&&[")","]"].some(t=>e.endsWith(t))&&[")(","), (",") (",")[",") [","](","] ("].some(t=>e.includes(t))){let t="",r=e.split(/[)\]]/).filter(Boolean).map(e=>(e.startsWith(",")&&(e=e.slice(1)),e.trim())),i=r.every(e=>e.includes(",")||tT(e)),n=r.every(e=>e.includes("/")||tT(e)),a=r.every(e=>e.includes("-")||tT(e)),o=(i?",":a&&"-")||n&&"/";if(o){let i;r.forEach(e=>{if(e.startsWith("("))if("set"===i&&(t+=" "),e.includes(o))t+=e.slice(1).split(o).map(e=>e.trim()).join("-"),i="set";else{let r=e.slice(1);t+=`(${r}) `,i="tiebreak"}else if(e.startsWith("[")){let r=e.slice(1).split(o).map(e=>parseInt(e.trim())),n=Math.min(...r);t+="set"===i?`(${n}) `:`[${r.join("-")}] `,i="tiebreak"}}),e=t.trim()}}let o=j(e.split(""));1===o["("]&&1===o[")"]&&e.startsWith("(")&&e.endsWith(")")&&(e=e.slice(1,e.length-1),1===o["-"]&&rT(e)&&E(t?.removed)&&(e+=`(${t.removed})`,t.removed=void 0));let s=/\(\)/g;return s.test(e)&&(e=e.replace(s,"").trim()),{score:e}},sensibleSets:function({score:e,matchUpStatus:t,attributes:r}){let i,n=[],a=e.split(" "),o=a.length;e=a.map((e,r)=>{if(new RegExp(zP).test(e)){let r=e.slice(3),i=e.slice(0,3),n=i.split("-");if(!rT(i)&&!t){let e=Math.max(...n),t=[e,e-1];return i.indexOf(e)&&t.reverse(),t.join("-")+r}}else if(2===e.length&&E(e))return e.split("").join("-");e=oT(e);let a=(new RegExp(`^${KP}$`).test(e)?"super":new RegExp(`^${zP}$`).test(e)&&"tiebreak")||new RegExp(`^${YP}$`).test(e)&&"standard"||"unknown";if(n.push(a),o>1&&"standard"===a&&r<2){let[t,n]=e.split("-"),a=Math.abs(parseInt(t)-parseInt(n)),o=Math.max(t,n),s=Math.min(t,n),c=[parseInt(t),parseInt(n)].indexOf(s);if(o>9&&a>2){let t=o.toString().split(""),n=t.find(e=>parseInt(e)>s||r&&parseInt(e)<=i)??t[0];n&&(e=c?[n,s].join("-"):[s,n].join("-"))}o>(i||0)&&(i=o)}if("standard"===a){let[r,i]=e.split("-");if(!Math.abs(parseInt(r)-parseInt(i))&&"RETIRED"!==t)return""}return e}).filter(Boolean).join(" ");let{setsWon:s,setWinners:c,totalSets:u}=dT(e);if(1===u&&"6"===r?.removed&&(e+=" 6-0"),e.split(" ").length>2&&Math.max(...s)>=2&&c[0]===c[1]&&(e=e.split(" ").slice(0,2).join(" ")),Math.max(...s)>2){let t=[0,0];e=e.split(" ").map((e,r)=>(t[c[r]]+=1,Math.max(...t)>2?void 0:e)).filter(Boolean).join(" ")}return{score:e,profile:n}},stringScore:function({score:e}){return{score:e=e?.toString().toLowerCase()||""}},superSquare:function({score:e}){let{setsTied:t,winningSide:r}=dT(e),i=/\s\((\d+)\)$/;if(!r&&t&&i.test(e)){let t=e.match(i).slice(1)[0],r=t<=8?10:t+2;e=e.replace(i,` [${r}-${t}]`)}let n=e.split(" "),a=n[n.length-1];if(!a.includes("-")||a.indexOf("(")>0)return{score:e};let o=a.split("(").join("").split(")").join("").split("-");if(!o.every(e=>E(e)))return{score:e};if("76"===o[0]){let t=2===o[1].length?Math.min(...o[1].split("").map(e=>parseInt(e))):o[1];e=[...n.slice(0,n.length-1),`7-6(${t})`].join(" ")}else{o=o.map(e=>parseInt(e));let t=Math.max(...o),r=Math.abs(o[0]-o[1]);if(t>=10){if(r>2&&o.every(e=>+e>=10)){let e=o.map(e=>e===t?e-10:10).sort();r=Math.abs(e[0]-e[1]),r>2&&(o=e)}e=[...n.slice(0,n.length-1),`[${o.join("-")}]`].join(" ")}else 3===n.length&&t>=7&&r>2&&(e=[...n.slice(0,n.length-1),`[${o.join("-")}]`].join(" "))}return{score:e}},setBuilder:sT,excisions:function({score:e}){let t=new RegExp(/^\[\d+\](.*)$/);t.test(e)&&(e=e.match(t).slice(1)[0].trim());let r=/\(,/g;return r.test(e)&&(e=e.replace(r,"(")),{score:e}},replaceOh:function({score:e,applied:t}){return"string"!=typeof e?{score:e}:(e.toLowerCase().includes("o")&&(e=e.toLowerCase().split(" ").map(e=>e.split("o").join("0")).join(" "),t.push("replaceOh")),{score:e,applied:t})}},pT={},mT=[],fT=["handleNumeric","handleWalkover","handleRetired","handleDefaulted","replaceOh","stringScore","punctuationAdjustments","excisions","handleSpaceSeparator","matchKnownPatterns","removeDanglingBits","handleBracketSpacing","matchKnownPatterns","containedSets","separateScoreBlocks","handleGameSeparation","removeErroneous","joinFloatingTiebreak","handleSetSlashSeparation","handleTiebreakSlashSeparation","properTiebreak","sensibleSets","superSquare"],hT=["handleNumeric","separateScoreBlocks","sensibleSets","superSquare"];function gT(e){if(!e.score)return{error:gi};let t,r,i,{score:n,sheetName:a,identifier:o,fileName:s,stepLog:c,fullLog:u,profile:d}=e,l=[],p=[],m=n,f=e=>{e.forEach(e=>{i=lT[e]({profile:d,identifier:o,matchUpStatus:t,attributes:r,applied:p,score:m});let n=i.score!==m;n&&l.push({method:e,score:i.score}),c&&(u||n||i.matchUpStatus!==t)&&console.log(t?{score:i.score,matchUpStatus:t}:{score:i.score},e),i.matchUpStatus&&(t=i.matchUpStatus),i.attributes&&(r=i.attributes),i.applied&&(p=i.applied),m=i.score})};f(fT);let h=eT(m);return h||(m=n.toString().replaceAll(/\D/g,""),r?.removed&&(r.removed=void 0),f(hT),h=eT(m),h||(mT.push({score:m,fileName:s,sheetName:a}),m="")),p.forEach(e=>{pT[e]||(pT[e]=0),pT[e]+=1}),{matchUpStatus:t?.toUpperCase(),modifications:l,attributes:r,isValid:h,score:m}}var IT={};function UT(e,t,r,i,n,a,o){if(r&&i){let n=function(e,t,r,i){let n=i===r?r+1:r;return e!==n?{isValid:!1,error:`Tiebreak set winner must have ${n} games, got ${e}`}:t!==i?{isValid:!1,error:`Tiebreak set loser must have ${i} games, got ${t}`}:{isValid:!0}}(e,t,r,i);if(!n.isValid)return n}return void 0===n&&void 0===a||!o?{isValid:!0}:function(e,t,r){let i=Math.max(e||0,t||0),n=Math.min(e||0,t||0),a=i-n,o=r.tiebreakTo||7;return i<o?{isValid:!1,error:`Tiebreak winner must reach ${o} points, got ${i}`}:a<2?{isValid:!1,error:`Tiebreak must be won by 2 points, got ${i}-${n}`}:n>=o-1&&a>2?{isValid:!1,error:`Tiebreak score ${i}-${n} is invalid`}:{isValid:!0}}(n,a,o)}function ST(e,t,r,i){if(!t)return{isValid:!0};let n=Yn(t);if(!n)return{isValid:!0};let a=r&&n.finalSetFormat?n.finalSetFormat:n.setFormat;if(!a)return{isValid:!0};if(a.timed){if(!i){let t=e.side1Score??0,r=e.side2Score??0;if(0===t&&0===r)return{isValid:!1,error:"Timed set requires at least one side to have scored"};if("P"===a.based&&t===r&&t>0&&a.tiebreakFormat&&void 0===e.side1TiebreakScore&&void 0===e.side2TiebreakScore)return{isValid:!1,error:"Tied timed set requires tiebreak"}}return{isValid:!0}}let{setTo:o,tiebreakAt:s,tiebreakFormat:c,tiebreakSet:u}=a,d=u?.tiebreakTo,l=!!d&&!o,p=void 0!==e.side1TiebreakScore&&void 0!==e.side2TiebreakScore,{side1Score:m,side2Score:f,side1TiebreakScore:h,side2TiebreakScore:g}=function(e,t,r){let i=e.side1TiebreakScore,n=e.side2TiebreakScore;return{side1Score:t&&r?i:e.side1Score||e.side1||0,side2Score:t&&r?n:e.side2Score||e.side2||0,side1TiebreakScore:i,side2TiebreakScore:n}}(e,l,p),I=Math.max(m,f),U=Math.min(m,f),S=I-U;if(l){return function(e,t,r,i,n,a=!1){return n?{isValid:!0}:0===e&&0===t?{isValid:!1,error:"Tiebreak-only set requires both scores"}:e<i?{isValid:!1,error:`Tiebreak-only set winner must reach at least ${i}, got ${e}`}:r<(a?1:2)?{isValid:!1,error:a?`Tiebreak-only set (NoAD) must be won by at least 1 point, got ${e}-${t}`:`Tiebreak-only set must be won by at least 2 points, got ${e}-${t}`}:a?{isValid:!0}:e===i&&t>i-2?{isValid:!1,error:`Tiebreak-only set at ${i}-${t} requires playing past ${i}`}:e>i&&2!==r?{isValid:!1,error:`Tiebreak-only set past ${i} must be won by exactly 2 points, got ${e}-${t}`}:{isValid:!0}}(I,U,S,d,i??!1,e.NoAD??a.tiebreakSet?.NoAD??!1)}return void 0!==h||void 0!==g||o&&I===o+1&&U===o?UT(I,U,o,s,h,g,c):function(e,t,r){let{side1:i,side2:n,winner:a,loser:o,diff:s}=e,{setTo:c,tiebreakAt:u}=t;if(c&&u){let e=function(e,t,r,i){return i?e===r+1&&t<r-1?{isValid:!1,error:`With tiebreak format, if side 1 has ${r+1} games, side 2 must be at least ${r-1}, got ${t}`}:t===r+1&&e<r-1?{isValid:!1,error:`With tiebreak format, if side 2 has ${r+1} games, side 1 must be at least ${r-1}, got ${e}`}:{isValid:!0}:{isValid:!0}}(i,n,c,u);if(!e.isValid)return e}return r?function(e,t,r){return r&&(e>r+10||t>r+10)?{isValid:!1,error:`Set score ${e}-${t} exceeds expected range for ${r}-game sets`}:{isValid:!0}}(a,o,c):c?function(e,t,r,i,n){if(e<i)return{isValid:!1,error:`Set winner must reach ${i} games, got ${e}`};let a=n&&e===i&&t===n&&1===r;if(r<2&&!a)return{isValid:!1,error:`Set must be won by at least 2 games, got ${e}-${t}`};if(n){if(t>=n&&!a)return{isValid:!1,error:`When tied at ${n}-${n}, must play tiebreak. Use format like ${n+1}-${n}(5)`};let r=n===i?i+1:i;if(e>r)return{isValid:!1,error:`With tiebreak format, set score cannot exceed ${r}-${n}. Got ${e}-${t}`}}else if(e>i+10)return{isValid:!1,error:`Set score ${e}-${t} exceeds reasonable limits`};return{isValid:!0}}(a,o,s,c,u):{isValid:!0}}({side1:m,side2:f,winner:I,loser:U,diff:S},{setTo:o,tiebreakAt:s},i)}function vT(e,t,r){if(!e||0===e.length)return{isValid:!0};let i=t?.match(/SET(\d+)/)?.[1],n=i?Number.parseInt(i):3,a=[Dd,Rd,Sd].includes(r||"");for(let o=0;o<e.length;o++){let i=e[o],s=o+1===n,c=void 0!==i.winningSide,u=ST(i,t,s,a||void 0===r&&!c);if(!u.isValid)return{isValid:!1,error:`Set ${o+1}: ${u.error}`}}return{isValid:!0}}function yT(e){return!!e?.aggregate}function wT(e,t,r,i,n,a){let o=t+1===i,{side1Score:s,side2Score:c,side1TiebreakScore:u,side2TiebreakScore:d,winningSide:l}=e,p=Math.max(s??0,c??0),m=u??d,{finalSetFormat:f,setFormat:h}=r,g=o&&f||h;return!(m&&!function(e,t,r,i,n,a){let{tiebreakTo:o,NoAD:s}=e||{},c=Math.max(t??0,r??0);return!(s&&c>o||c<o&&i&&(n&&!a||!n))}(g?.tiebreakFormat,u,d,l,n,a))&&(!g.setTo||!(!g.noTiebreak&&p>g.setTo+1))}function PT({existingMatchUpStatus:e,matchUpFormat:t,matchUpStatus:r,winningSide:i,score:n}){let a=n?.sets??[],o=(a?.filter(e=>e?.winningSide)||[]).reduce((e,t)=>{let{winningSide:r}=t;return r?(e[r-1]++,e):e},[0,0]),s=i?i-1:void 0,c=void 0!==s&&[0,1].includes(s)?1-s:void 0,u=void 0!==s&&o[s],d=void 0!==c&&o[c],l=t?Yn(t):void 0,p=Math.max(...o),m=j(o)[p],f=l?.setFormat?.timed||l?.finalSetFormat?.timed,h=l?.bestOf||l?.exactly,g=h&&Math.ceil(h/2)||1,I=r??e,U=!(!I||![Sd,Dd,Rd].includes(I)),S=!l||!a.length||a.every((e,t)=>wT(e,t,l,h??0,t===a.length-1,U)),v=l?.exactly,y=!v||!I||I!==Id||U||a.length>=v,w=yT(l),P=w&&a.length>0?function(e){let t=e.reduce((e,t)=>((void 0!==t.side1Score||void 0!==t.side2Score)&&(e[0]+=t.side1Score??0,e[1]+=t.side2Score??0),e),[0,0]);return t[0]>t[1]?1:t[1]>t[0]?2:e.find(e=>void 0!==e.side1TiebreakScore||void 0!==e.side2TiebreakScore)?.winningSide}(a):function(e,t,r,i,n){return(!n||e===t)&&1===r&&i.indexOf(e)+1||void 0}(p,g,m,o,t);return{valid:!!(S&&y&&(i&&w&&i===P||i&&!w&&u>d&&i===P||i&&U||!i&&!P&&(![Id,Sd,Dd,Rd].includes(I)||f&&I===Id)))}}function TT({existingMatchUpStatus:e,matchUpFormat:t,matchUpStatus:r,winningSide:i,score:n}){if("object"!=typeof n)return{error:gi};let{sets:a,scoreStringSide1:o,scoreStringSide2:s}=n,c="scoreString must be a string!";if(void 0!==o&&"string"!=typeof o)return{error:gi,info:c};if(void 0!==s&&"string"!=typeof s)return{error:gi,info:c};if(void 0!==a&&!Array.isArray(a))return{error:gi,info:WI("sets")};if(a?.length){let o=a.map(e=>e?.setNumber).filter(Boolean);if(o.length!==L(o).length)return{error:gi,info:"setNumbers not unique"};for(let e of a){let{side1Score:t,side2Score:r,side1TiebreakScore:i,side2TiebreakScore:n,side1PointScore:a,side2PointScore:o,winningSide:s,setNumber:c}=e;if(![[t,r],[i,n],[a,o]].filter(e=>e.some(e=>![void 0,null].includes(e))).every(e=>e.every(e=>F(e))))return{error:gi,info:"non-numeric values"};if(![c,s].filter(e=>![void 0,null].includes(e)).every(e=>F(e)))return{error:gi,info:"non-numeric values"};if(s&&![1,2].includes(s))return{error:gi,info:"winningSide must be 1 or 2"}}let{valid:s}=PT({existingMatchUpStatus:e,matchUpStatus:r,matchUpFormat:t,winningSide:i,score:n});if(!s)return{error:tr,info:"score is invalid for matchUpFormat or winningSide does not match calculated winningSide"}}return{valid:!0}}n(IT,{analyzeScore:()=>PT,analyzeSet:()=>NT,calculateMatchStatistics:()=>Zw,checkScoreHasValue:()=>ch,checkSetIsComplete:()=>GP,deduceMatchUpFormat:()=>ET,enrichPointHistory:()=>eP,getEpisodes:()=>Ww,getQuickStats:()=>tP,getScore:()=>Gw,getScoreboard:()=>jw,getSetComplement:()=>DT,getTiebreakComplement:()=>bT,getWinner:()=>$w,isComplete:()=>qw,isValidMatchUpFormat:()=>ta,parseScoreString:()=>RT,toStatObjects:()=>aP,validateMatchUpScore:()=>vT,validateScore:()=>TT,validateSetScore:()=>ST,validateTieFormat:()=>Ba});var DT=e=>{let{isSide1:t,lowValue:r,setTo:i,tiebreakAt:n,NoAD:a}=e;if(void 0===r)return!1;let o,s=I(r);return s?.toString().length>2&&(s=Number.parseInt(s.toString().slice(0,2))),n&&n<i&&s>n&&(s=n),o=a&&!n?s>i||s<i?i:i-1:s+1<i&&i||n&&n<i&&s===n&&i||!n&&s+2||i+1,[t?s:o,t?o:s]},bT=e=>{let{isSide1:t,lowValue:r,tiebreakTo:i,tiebreakNoAd:n}=e;if(void 0===r)return!1;let a="string"==typeof r?Number.parseInt(r):r;a?.toString().length>2&&(a=Number.parseInt(a.toString().slice(0,2))),n&&a>i-1&&(a=i-1);let o=function(e){let{lowValue:t,NoAD:r,tiebreakTo:i}=e,n=r?1:2;return t+1>=i?t+n:i}({lowValue:a,NoAD:n,tiebreakTo:i});return[t?a:o,t?o:a]};function MT(e,t){return(e>t?1:e<t&&2)||void 0}function RT({tiebreakTo:e=7,scoreString:t="",matchUpFormat:r}){let i,n=3;if(r)try{i=Yn(r);let e=/SET(\d+)/.exec(r)?.[1];n=e?Number.parseInt(e):3}catch{}return t?.split(" ").filter(Boolean).map((e,t)=>function({set:e,setNumber:t}){let r,o=/\[([^\]]+)\]/,s=/\(([^)]+)\)/.exec(e),c=o.exec(e),u=e?.startsWith("[")&&c,d=function(e,t){if(!i||!t)return!1;let r=e===n&&i.finalSetFormat?i.finalSetFormat:i.setFormat;if(!r)return!1;let a=r.tiebreakSet?.tiebreakTo,o=r.setTo;return!!a&&!o}(t,!!u),l=a(t),p=d&&1===l;if(u){r=function(e,t){return t?{side1Score:e[0],side2Score:e[1],winningSide:MT(e[0],e[1])}:{side1TiebreakScore:e[0],side2TiebreakScore:e[1],winningSide:MT(e[0],e[1])}}(c[1].split("-").map(e=>Number.parseInt(e)),d)}else r=function(e,t,r,i){let n,o,s=(t&&e.replace(t[0],"")||r&&e.replace(r[0],"")||e).split("-").map(e=>Number.parseInt(e)),c=s[0],u=s[1],d=MT(c,u);if(t&&([n,o]=function(e,t,r){let i=e[1],n=a(r),o=bT({lowValue:i,isSide1:2===t,tiebreakTo:n});return Array.isArray(o)?[o[0],o[1]]:[void 0,void 0]}(t,d,i)),r){let e=r[1].split("-").map(e=>Number.parseInt(e));n=e[0],o=e[1]}return{side1Score:c,side2Score:u,side1TiebreakScore:n,side2TiebreakScore:o,winningSide:d}}(e,s,c,t);return{side1Score:r.side1Score,side2Score:r.side2Score,side1TiebreakScore:r.side1TiebreakScore,side2TiebreakScore:r.side2TiebreakScore,winningSide:r.winningSide,setNumber:t,...p&&{NoAD:!0},...d&&{tiebreakSet:!0}}}({set:e,setNumber:t+1}));function a(t){if(!i)return e;let r=t===n&&i.finalSetFormat?i.finalSetFormat:i.setFormat;return r?.tiebreakSet?.tiebreakTo??r?.tiebreakFormat?.tiebreakTo??e}}function NT(e){let{setObject:t,matchUpScoringFormat:r}=e;if(!t)return{error:Gt};let{setNumber:i}=t||{},{bestOf:n,exactly:a}=r||{},o=n||a,s=!(!i||!o||i!==o),c=s&&r?.finalSetFormat||r?.setFormat,u=!!c?.tiebreakSet,d=!!c?.timed,l=!u&&!d,p=!!(i&&o&&i<=o),m=[t?.side1Score,t?.side2Score],f=[t?.side1PointScore,t?.side2PointScore],h=[t?.side1TiebreakScore,t?.side2TiebreakScore],g=m.filter(e=>void 0!==e).length,I=f.filter(e=>void 0!==e).length,U=h.filter(e=>void 0!==e).length,S=m?.filter(e=>!isNaN(e)).length,v=h?.filter(e=>!isNaN(e)).length,{tiebreakAt:y}=c||{},w=y&&2===m.filter(e=>e>=y).length,P=w&&((m[0]>m[1]?1:m[1]>m[0]&&2)||void 0),T=!(!v||S),D=!!t?.winningSide,{error:b,result:M}=function({setObject:e,setFormat:t,sideGameScores:r,sideTiebreakScores:i}){if(!e)return{result:!1,error:Gt};let n=!!t?.tiebreakSet,a=!!t?.timed;if(!t||n||a)return{result:!1,error:gi};if(2!==r?.filter(e=>!isNaN(e)).length)return{result:!1,error:er};let{setTo:o,tiebreakAt:s,tiebreakFormat:c,NoAD:u}=t||{};if(!o||!r?.find(e=>e>=o))return{result:!1,error:er};let d=[1,2].includes(e?.winningSide);if(!e||!d)return{result:!1,error:rr};let l=e?.winningSide-1,p=1-l,m=r[l],f=r[p],h=m-f;if(!(m>f))return{result:!1,error:{message:"winningSide game scoreString is not high"}};let g=s&&c,I=2===i?.filter(e=>!isNaN(e)).length,U=i?.[l],S=i?.[p],v=s&&2===r.filter(e=>e>=s).length;if(g){let{NoAD:e,tiebreakTo:t}=c;if(v){if(h>1)return{result:!1,error:{message:"invalid winning game scoreString (5)"}};if(!I)return{result:!1,error:{message:"invalid tiebreak scores (1)"}};if(isNaN(t))return{result:!1,error:{message:"tiebreakTo error"}};if(!t||!i?.find(e=>e>=t))return{result:!1,error:{message:"invalid tiebreak scores (2)"}};if(m>(s<o?o:o+1))return{result:!1,error:{message:"invalid winning game scoreString (1)"}};if(!U||!S||U<S)return{result:!1,error:{message:"winningSide tiebreak value is not high"}};let r=U-S;if(r&&S>=t-1&&r<(e?1:2))return{result:!1,error:{message:"invalid tiebreak scores (3)"}}}if(m>o&&!v)return{result:!1,error:{message:"invalid winning game scoreString (2)"}}}let y=u?1:2,w=f>=o-1;return h&&w&&!v&&h<y?{result:!1,error:{message:"invalid winning game scoreString (3)"}}:h>y&&m>o?{result:!1,error:{message:"invalid winning game scoreString (4)"}}:{result:!0}}({sideTiebreakScores:h,sideGameScores:m,setFormat:c,setObject:t}),{error:R,result:N}=function({setObject:e,setFormat:t,sideTiebreakScores:r}){if(!e)return{result:!1,error:Gt};let i=!!t?.tiebreakSet,n=!!t?.timed;if(!t||!i||n)return{result:!1,error:{message:"not tiebreak set"}};let a=[1,2].includes(e?.winningSide);if(!e||!a)return{result:!1,error:rr};let{tiebreakSet:o}=t||{},{NoAD:s,tiebreakTo:c}=o||{};if(2!==r?.filter(e=>!isNaN(e)).length)return{result:!1,error:{message:"invalid tiebreak scores (1)"}};if(isNaN(c))return{result:!1,error:{message:"tiebreakTo error"}};if(!r?.find(e=>e>=c))return{result:!1,error:{message:"invalid tiebreak scores (2)"}};let u=e?.winningSide-1,d=1-u,l=r[u],p=r[d];if(!l||!p||l<p)return{result:!1,error:{message:"winningSide tiebreak value is not high"}};let m=s?1:2,f=l-p,h=p>=c-1;return f&&h&&f<m?{result:!1,error:{message:"invalid tiebreak scores (3)"}}:{result:!0}}({sideTiebreakScores:h,setObject:t,setFormat:c}),A=l&&!T&&M||u&&T&&N||d,E=p&&!(u&&!T)&&!(l&&T)&&(!D||A),C=function({matchUpScoringFormat:e,isDecidingSet:t,isTiebreakSet:r,isTimedSet:i,setObject:n}){if(!n)return;let a=jP({set:n});return GP({matchUpScoringFormat:e,set:n,isDecidingSet:t,isTiebreakSet:r,isTimedSet:i})&&a||void 0}({isTimedSet:d,matchUpScoringFormat:r,isDecidingSet:s,isTiebreakSet:T,setObject:t}),O={expectTiebreakSet:u,expectTimedSet:d,hasTiebreakCondition:w,isCompletedSet:D,isDecidingSet:s,isTiebreakSet:T,isValidSet:E,isValidSetNumber:p,isValidSetOutcome:A,leadingSide:P,setFormat:c,sideGameScores:m,sideGameScoresCount:g,sidePointScores:f,sidePointScoresCount:I,sideTiebreakScores:h,sideTiebreakScoresCount:U,winningSide:C};return void 0!==t?.winningSide&&(T?(O.isValidTiebreakSetOutcome=N,N||(O.tiebreakSetError=R)):(O.isValidStandardSetOutcome=M,M||(O.standardSetError=b))),O}var AT="SET3-S:6/TB7";function ET(e){let t,r=e.split(/[\s,]+/).filter(e=>e.length>0);if(0===r.length)return AT;t=1===r.length?1:2===r.length?3:5;for(let s of r){let e=s.replace(/\([^)]*\)/g,"").match(/(\d+)/g)?.map(e=>Number.parseInt(e,10))||[];if(2===e.length){let r=Math.max(...e),i=Math.min(...e);if(10===r||r>10&&r-i<=2)return`SET${t}-S:TB10`}}let i,n=null;for(let s of r)if(/\(/.test(s)){n=s;break}if(n){let e=n.replace(/\([^)]*\)/g,"").match(/(\d+)/g)?.map(e=>parseInt(e,10))||[];if(0===e.length)return AT;let t=Math.max(...e),r=Math.min(...e);i=t===r+1?r:t-1}else{let e=[];for(let i of r){let t=i.replace(/\([^)]*\)/g,"").match(/(\d+)/g)?.map(e=>parseInt(e,10))||[];t.length>0&&e.push(Math.max(...t))}if(0===e.length)return AT;let t=Math.max(...e);i=t>=6?6:t}let a,o=!1;if(r.length>=3){let e=r.at(-1).replace(/\([^)]*\)/g,"").match(/(\d+)/g)?.map(e=>Number.parseInt(e,10))||[];if(2===e.length){let t=Math.max(...e),r=Math.min(...e);t>i+1&&t-r===2&&(o=!0)}}return a=6===i?`SET${t}-S:6/TB7`:4===i?`SET${t}-S:4/TB7`:`SET${t}-S:${i}/TB7`,o&&(a+=`-F:${i}`),a}function CT(e){let{matchUp:t,expectedScore:r}=e;if(!t)return{isValid:!1,errors:["No matchUp provided"],warnings:[],actual:{sets:[],scoreString:""},expected:{sets:r?.sets,scoreString:r?.scoreString},pointsProcessed:0,pointsRejected:0};let i=[],n=[],a=Pw({matchUpFormat:t?.matchUpFormat,matchUpId:t?.matchUpId,participants:t?.sides?.map(e=>e.participant).filter(e=>void 0!==e)}),o=t?.history?.points||[];0===o.length&&n.push("No points found to validate");let s=0,c=0;for(let l of o)try{a=Fw(a,{winner:l.winner,server:l.server}),s++}catch(d){c++;let e=d instanceof Error?d.message:String(d);i.push(`Point ${l.pointNumber||s+1}: ${e}`)}let u=Gw(a);return r&&(r.sets&&(u.sets.length!==r.sets.length&&i.push(`Set count mismatch: expected ${r.sets.length}, got ${u.sets.length}`),r.sets.forEach((e,t)=>{let r=u.sets[t];r?(void 0!==e.side1Score&&r.side1Score!==e.side1Score&&i.push(`Set ${t+1} side1Score: expected ${e.side1Score}, got ${r.side1Score}`),void 0!==e.side2Score&&r.side2Score!==e.side2Score&&i.push(`Set ${t+1} side2Score: expected ${e.side2Score}, got ${r.side2Score}`),void 0!==e.side1TiebreakScore&&r.side1TiebreakScore!==e.side1TiebreakScore&&i.push(`Set ${t+1} side1TiebreakScore: expected ${e.side1TiebreakScore}, got ${r.side1TiebreakScore}`),void 0!==e.side2TiebreakScore&&r.side2TiebreakScore!==e.side2TiebreakScore&&i.push(`Set ${t+1} side2TiebreakScore: expected ${e.side2TiebreakScore}, got ${r.side2TiebreakScore}`)):i.push(`Missing set ${t+1}`)})),r.scoreString&&u.scoreString!==r.scoreString&&i.push(`Score string mismatch: expected "${r.scoreString}", got "${u.scoreString}"`)),{isValid:0===i.length,errors:i,warnings:n,actual:{sets:u.sets,scoreString:u.scoreString},expected:{sets:r?.sets,scoreString:r?.scoreString},pointsProcessed:s,pointsRejected:c}}function OT(e){let t=e?.side1Score||0,r=e?.side2Score||0;if(void 0!==e?.side1TiebreakScore||void 0!==e?.side2TiebreakScore){let i=e?.side1TiebreakScore||0;return t>r?`${t}-${r}(${e?.side2TiebreakScore||0})`:`${t}(${i})-${r}`}return`${t}-${r}`}function kT(e){let{points:t,matchUpFormat:r,expectedGames:i,expectedTiebreak:n}=e;return CT({matchUp:{matchUpId:"validation",matchUpFormat:r,matchUpStatus:"TO_BE_PLAYED",matchUpType:"SINGLES",sides:[{sideNumber:1},{sideNumber:2}],score:{sets:[]},history:{points:t?.map((e,t)=>({...e,pointNumber:t+1,timestamp:"",winner:e.winner,server:e.server}))}},expectedScore:{sets:[{side1Score:i?.[0],side2Score:i?.[1],side1TiebreakScore:n?.[0],side2TiebreakScore:n?.[1]}]}})}function FT(e){let t,{points:r,expectedScore:i,matchUpFormat:n,allowExtraPoints:a=!1,debug:o=!1}=e,s=[],c=[],u=[],d=!1;n?t=n:i?(t=ET(i),d=!0,o&&console.log(`Deduced format: ${t} from score: ${i}`)):(t="SET3-S:6/TB7",d=!0,c.push("No format provided, using default SET3-S:6/TB7"));let l=Pw({matchUpFormat:t}),p=r?.split("").map(e=>{let t=Number.parseInt(e,10);return Number.isNaN(t)||0!==t&&1!==t?null:t}).filter(e=>null!==e);if(0===p?.length)return s.push("No valid points found in point string"),{valid:!1,errors:s,warnings:c,pointsProcessed:0,pointsRejected:[],actualScore:"0-0",matchUpFormat:t,formatDeduced:d,sets:[]};let m=0;for(let S=0;S<p?.length;S++){let e=p[S];if("COMPLETED"!==l.matchUpStatus||a)try{if(l=Fw(l,{winner:e}),m++,o){let t=Gw(l);console.log(`Point ${S+1}: ${e} \u2192 ${t.scoreString}`)}}catch(U){u.push(e);let t=U instanceof Error?U.message:String(U);s.push(`Point ${S+1}: ${t}`),o&&console.log(`Point ${S+1}: Error - ${t}`)}else u.push(e),o&&console.log(`Point ${S+1}: Rejected (match complete)`)}let f=Gw(l),h=f.scoreString,g=f.sets.map(e=>{let t=[e.side1Score||0,e.side2Score||0],r=void 0===e.side1TiebreakScore?void 0:[e.side1TiebreakScore,e.side2TiebreakScore||0],i=`${t[0]}-${t[1]}`;return r&&(i=t[0]>t[1]?`${t[0]}-${t[1]}(${r[1]})`:`${t[0]}(${r[0]})-${t[1]}`),{games:t,tiebreak:r,scoreString:i}}),I=!0;if(i){xT(i)!==xT(h)&&(I=!1,s.push(`Score mismatch: expected "${i}", got "${h}"`))}return u.length>0&&c.push(`${u.length} excess points after match complete`),s.length>0&&(I=!1),{valid:I,errors:s,warnings:c,pointsProcessed:m,pointsRejected:u,expectedScore:i,actualScore:h,matchUpFormat:t,formatDeduced:d,sets:g}}function xT(e){return e.replace(/\s+/g,"").replace(/,/g,", ").toLowerCase()}var _T={4:"Wide",5:"Body",6:"T"},LT={f:"Forehand",r:"Forehand Slice",v:"Forehand Volley",o:"Overhead Smash",u:"Forehand Drop Shot",l:"Forehand Lob",h:"Forehand Half-volley",j:"Forehand Drive Volley"},BT={b:"Backhand",s:"Backhand Slice",z:"Backhand Volley",p:"Backhand Overhead Smash",y:"Backhand Drop Shot",m:"Backhand Lob",i:"Backhand Half-volley",k:"Backhand Drive Volley"},VT={...LT,...BT,t:"Trick Shot",q:"Unknown Shot"},GT={7:"shallow",8:"deep",9:"very deep"},jT={1:1,2:2,3:3},$T={"+":"approach","-":"net","=":"baseline"},qT={n:"Net",w:"Out Wide",d:"Out Long",x:"Out Wide and Long",g:"Foot Fault",e:"Unknown","!":"Shank"};function WT(e){let t=[],r="";for(let i=0;i<e.length;i++){let n=e[i];n&&("fbrsvzouymlhijkpqt".includes(n)||"456".includes(n)?(r&&t.push(r),r=n):r+=n)}return r&&t.push(r),t}function HT(e){return e.includes("*")?"*":e.includes("#")?"#":e.includes("@")?"@":void 0}function YT(e){if(e)for(let t of Object.keys(qT))if(e.includes(t))return t}function zT(e){if(!S(e))return{serves:[],rally:[]};let t,r,i,n=e.split("c").length-1,a=WT(e=e.split("c").join("")),o=a;for(let d=a.length-1;d>=0;d--){let e=a[d];if(e&&(r=HT(e),r)){o=a.slice(0,d+1),i=a.slice(d+1),t=e;break}}let s=function(e){let t=[];for(let r of e){if(!r)continue;let e=r[0];if(!e||!/[456]/.test(e))break;t.push(r)}return t}(o),c=s.length?o.slice(s.length):o;if(!r&&!s.length&&1===c.length){let e=c[0];e&&["S","P","Q","R"].includes(e)&&(t=e,c.length=0)}let u={serves:s,rally:c};return n&&(u.lets=n),r&&(u.terminator=r),t&&(u.result=t),u}function KT(e){let t=e.join("|"),r=JT(e[0],1);if("S"===r.winner||!e[1])return r.serve=1,r.code=t,r;let i=JT(e[1],2);return i.serve=2,i.first_serve={serves:r.serves},r.lets&&(i.first_serve.lets=r.lets),r.error&&(i.first_serve.error=r.error),r.parse_notes&&(i.first_serve.parse_notes=r.parse_notes),i.code=t,i}function JT(e,t){let r=zT(e);if(["Q","S"].includes(r.result||""))return r.winner="S",r;if(["P","R"].includes(r.result||"")||!r.terminator&&!YT(r.serves[0])&&r.serves.length>2)return r.winner="R",r;let i,n=(r.serves.length+r.rally.length)%2==0?"R":"S";if(r.rally.length>0?i=r.rally[r.rally.length-1]:r.serves.length>0&&(i=r.serves[r.serves.length-1]),!i)return{...r,winner:void 0};if(!r.rally.length){if("*"===r.terminator)r.result="Ace",r.winner="S";else if("#"===r.terminator)r.result="Serve Winner",r.winner="S";else{let e=YT(r.serves[0]);e?(r.error=qT[e],2===t&&(r.result="Double Fault",r.winner="R")):(r.parse_notes="treated as a fault",2===t&&(r.result="Double Fault",r.winner="R"))}return r}if(1===r.rally.length&&i.includes("#")){r.result="Serve Winner",r.winner="S";let e=YT(i);return e&&(r.error=qT[e]),r}return i.includes("#")?(r.result="Forced Error",r.error=qT[YT(i)],r.winner="R"===n?"S":"R"):i.includes("*")?(r.result="Winner",r.winner=n):i.includes("@")?(r.result="Unforced Error",r.error=qT[YT(i)],r.winner="R"===n?"S":"R"):YT(r.serves[0])?1===r.rally.length&&YT(i)&&(r.error=qT[YT(i)],r.winner="R"===n?"S":"R"):r.serves.length&&r.rally.length?(r.parse_notes="no terminator: receiver wins point",r.result="Unknown",r.winner="R"):1===r.rally.length&&YT(i)&&(r.error=qT[YT(i)],r.winner="R"===n?"S":"R"),r}function QT(e){if(e)for(let t of e){let e=VT[t];if(e)return e}}function XT(e,t){let r=function(e,t){return e.PtWinner===e.Svr?t:1-t}(e,t),i=e["1st"]||"",n=e["2nd"]||"";if(!i&&!n)return{winner:r,server:t,result:"Unknown"};let a=KT([i,n]),o={winner:r,server:t};a.result&&(o.result=a.result),a.serve&&(o.serve=a.serve);let s=function(e){if(e)for(let t of e){let e=_T[t];if(e)return e}}(1===a.serve?i:n);s&&(o.serveLocation=s);let c=a.rally[a.rally.length-1];if(c){let e=QT(c);e&&(o.stroke=e,Object.values(LT).includes(e)?o.hand="Forehand":Object.values(BT).includes(e)&&(o.hand="Backhand"))}let u=function(e,t,r){let i=[],n=1,a=r;if(e.length>0&&!YT(e[e.length-1])){let t=e[e.length-1],r=QT(t)||"Forehand";i.push({shotNumber:n++,player:a,stroke:r,code:t}),a=1-a}for(let o of t){let e=QT(o);if(!e)continue;let t={shotNumber:n++,player:a,stroke:e,code:o};for(let r of o){let e=jT[r];void 0!==e&&(t.direction=e)}for(let r of o){let e=GT[r];e&&(t.depth=e)}for(let r of o){let e=$T[r];e&&(t.position=e)}i.push(t),a=1-a}return i}(a.serves,a.rally,t);return u.length>0&&(o.rally=u,o.rallyLength=u.length),a.code&&(o.code=a.code),o}function ZT(e){if(!e||!S(e))return[];let t=e.trim().split("\n");if(t.length<2)return[];let r=t[0]?.split(",")||[],i=[];for(let n=1;n<t.length;n++){let e=t[n];if(!e)continue;let a=e.split(","),o={};for(let t=0;t<r.length;t++){let e=r[t];e&&(o[e]=a[t]||"")}i.push(o)}return i}function eD(e){if(!Array.isArray(e))return[];let t=new Map;for(let r of e){let e=r.match_id;t.has(e)||t.set(e,[]),t.get(e).push(r)}return Array.from(t.entries()).map(([e,t])=>({match_id:e,points:t}))}function tD(e,t={}){let r,{matchUpFormat:i,validateScore:n=!0,debug:a=!1}=t,o=[],s=[],c=function(e){let t=e?.split("-")||[];if(t.length<6)return{player1:"Player 1",player2:"Player 2"};let r=t[0],i=t[2]?.replace(/_/g," ");return{player1:t[4]?.replace(/_/g," ")||"Player 1",player2:t[5]?.replace(/_/g," ")||"Player 2",date:r,tournament:i}}(e.match_id),u=function(e){if(!e||0===e.length)return;let t=e.at(-1);if(!t)return;let r=t.Set1,i=t.Set2,n=t.Set3,a=t.Set4,o=t.Set5,s=[];return r&&s.push(`${r}-${i}`),n&&s.push(`${n}-${i||"0"}`),a&&s.push(`${a}-${i||"0"}`),o&&s.push(`${o}-${i||"0"}`),s.length>0?s.join(", "):void 0}(e.points),d=!1;i?r=i:u?(r=ET(u),d=!0,a&&console.log(`Deduced format: ${r} from score: ${u}`)):(r="SET3-S:6/TB7",d=!0,s.push("No format provided, using default SET3-S:6/TB7")),a&&(console.log(`Validating match: ${c.player1} vs ${c.player2}`),console.log(`Format: ${r}`),console.log(`Total points: ${e.points.length}`),u&&console.log(`Expected score: ${u}`));let l=Pw({matchUpFormat:r,matchUpId:e.match_id});l.sides[0]&&(l.sides[0].participant={participantId:"player1",participantName:c.player1,participantType:"INDIVIDUAL",participantRole:"COMPETITOR"}),l.sides[1]&&(l.sides[1].participant={participantId:"player2",participantName:c.player2,participantType:"INDIVIDUAL",participantRole:"COMPETITOR"});let p,m=0,f=0,h=0,g=0,I=0,U=0;for(let P=0;P<e.points?.length;P++){let t=e.points[P];if(t){p="1"===t.Svr?0:1;try{let r=XT(t,p);if(l=Fw(l,{winner:r.winner,server:r.server}),l.history?.points&&l.history.points.length>0){let e=l.history.points[l.history.points.length-1];e&&(r.result&&(e.result=r.result),r.stroke&&(e.stroke=r.stroke),r.hand&&(e.hand=r.hand),r.serve&&(e.serve=r.serve),r.serveLocation&&(e.serveLocation=r.serveLocation),r.rally&&(e.rally=r.rally),r.rallyLength&&(e.rallyLength=r.rallyLength),r.code&&(e.code=r.code))}if(U++,"Ace"===r.result&&m++,"Double Fault"===r.result&&f++,"Winner"===r.result&&h++,"Unforced Error"===r.result&&g++,"Forced Error"===r.result&&I++,a&&(P<5||P===e.points.length-1)){let e=Gw(l);console.log(`Point ${P+1}: ${r.result||"Rally"} \u2192 ${e.scoreString}`)}}catch(w){let e=w instanceof Error?w.message:String(w);o.push(`Point ${P+1}: ${e}`),a&&console.error(`Point ${P+1} failed:`,e)}}}let S,v=Gw(l).scoreString,y="COMPLETED"===l.matchUpStatus;if(y||s.push(`Match not complete. Final score: ${v}`),n&&u){let e=rD(u),t=rD(v);S=e===t,S||o.push(`Score mismatch: expected "${u}", got "${v}"`),a&&(console.log(`Expected: ${u} \u2192 ${e}`),console.log(`Actual: ${v} \u2192 ${t}`),console.log(`Score matches: ${S}`))}return a&&(console.log(`Final score: ${v}`),console.log(`Match complete: ${y}`),console.log(`Stats: ${m} aces, ${f} DFs, ${h} winners, ${g} UEs, ${I} FEs`)),{valid:0===o.length,errors:o,warnings:s,matchUp:l,pointsProcessed:U,expectedScore:u,actualScore:v,scoreMatches:S,formatDeduced:d,aces:m,doubleFaults:f,winners:h,unforcedErrors:g,forcedErrors:I}}function rD(e){return e.replace(/\s+/g,"").replace(/,/g,", ").toLowerCase()}function iD(e){let t,{csvData:r,matchId:i,matchUpFormat:n,debug:a=!1}=e,o=[],s=[],c=[];try{t=ZT(r)}catch(I){let e=I instanceof Error?I.message:String(I);return o.push(`Failed to parse CSV: ${e}`),{valid:!1,errors:o,warnings:s,matchesProcessed:0,pointsProcessed:0,matchUps:[],totalAces:0,totalDoubleFaults:0,totalWinners:0,totalUnforcedErrors:0,totalForcedErrors:0}}let u=eD(t);a&&console.log(`Parsed ${t.length} points from ${u.length} matches`);let d=i?u.filter(e=>e.match_id===i):u;if(0===d.length)return o.push(i?`Match ID not found: ${i}`:"No matches found in CSV data"),{valid:!1,errors:o,warnings:s,matchesProcessed:0,pointsProcessed:0,matchUps:[],totalAces:0,totalDoubleFaults:0,totalWinners:0,totalUnforcedErrors:0,totalForcedErrors:0};let l=0,p=0,m=0,f=0,h=0,g=0;for(let U of d){let e=tD(U,{matchUpFormat:n,debug:a});e.valid||o.push(...e.errors),s.push(...e.warnings),c.push(e.matchUp),l+=e.pointsProcessed,p+=e.aces,m+=e.doubleFaults,f+=e.winners,h+=e.unforcedErrors,g+=e.forcedErrors}return{valid:0===o.length,errors:o,warnings:s,matchesProcessed:d.length,pointsProcessed:l,matchUps:c,totalAces:p,totalDoubleFaults:m,totalWinners:f,totalUnforcedErrors:h,totalForcedErrors:g}}function nD(e){return JSON.stringify(e,null,2)}function aD(e){let t=e.drawDefinition,{existingQualifyingPlaceholderStructureId:r,appliedPolicies:i,qualifyingOnly:n,drawEntries:a,structureId:o,tieFormat:s,idPrefix:c,isMock:u,event:d}=e,l=e.qualifyingProfiles,p=l?.length?qy({hasExistingDrawDefinition:!0,uuids:e.uuids,qualifyingProfiles:l,appliedPolicies:i,qualifyingOnly:n,tieFormat:s,idPrefix:c,isMock:u}):void 0;if(p?.error)return p;t.structures=t.structures?.filter(({structureId:e})=>e!==r),t.links=t.links?.filter(({source:e})=>e.structureId!==r);let{qualifiersCount:m,qualifyingDrawPositionsCount:f,qualifyingDetails:h}=p??{};f&&(p?.structures&&t.structures?.push(...p.structures),p?.links&&t.links?.push(...p.links));let g=t.structures?.find(({stage:e,stageSequence:t})=>e===Ho&&1===t),{qualifiersCount:I}=_g({stageSequence:1,drawDefinition:t,structureId:o,stage:Ho}),U=QU({qualifiersCount:Math.max(m??0,I??0),drawDefinition:t,stage:Ho});if(U.error||(U=JU({drawSize:f,stage:Yo,drawDefinition:t}),U.error))return U;!function({drawDefinition:e,drawEntries:t,event:r}){for(let i of(t??[]).filter(({entryStage:e})=>e===Yo)){Gg({...i,entryStage:i.entryStage??Ho,drawDefinition:e,event:r})}}({drawDefinition:t,drawEntries:a,event:d});let S=function({mainStructure:e,qualifyingDetails:t,drawDefinition:r}){for(let i of t||[]){let{finalQualifyingRoundNumber:t,finalQualifyingStructureId:n,roundTarget:a,finishingPositions:o,linkType:s}=i,c=e&&vS({targetStructureId:e.structureId,sourceStructureId:n,sourceRoundNumber:t,finishingPositions:o,targetEntryRound:a,linkType:s})?.link;if(c?.error)return c;c&&(r.links||(r.links=[]),r.links.push(c))}return{error:void 0}}({mainStructure:g,qualifyingDetails:h,drawDefinition:t});return S.error?S:{drawDefinition:t,structureId:o}}function oD(e){let{participantIds:t}=e,r=e.drawDefinition?.entries?.filter(t=>{let r=t.entryStatus;return!e.restrictEntryStatus||Bp.includes(r)}).map(dd)??[];if(t){let e=t.filter(e=>!r?.includes(e));if(e?.length)return Pn({result:{error:dr},info:{invalidParticipantIds:e}})}else t=r;return e.roundsCount&&!1!==e.restrictRoundsCount&&e.roundsCount>t.length-1&&(!e.enableDoubleRobin||e.roundsCount>2*(t.length-1))?{error:gi,info:"Not enough participants for roundsCount"}:e.roundsCount&&!1!==e.restrictRoundsCount&&e.roundsCount>31?{error:gi,info:"roundsCount must be less than 32"}:{participantIds:t}}function sD(e){let t,r=[],{roundsCount:i=1,drawDefinition:n,matchUpsCount:a,structureId:o,idPrefix:s,isMock:c,event:u}=e,d=oD(e);if(d.error)return d;for(let l of K(1,i+1)){let i=sw({restrictMatchUpsCount:e.restrictMatchUpsCount,ignoreLastRoundNumber:!!t,newRound:!t,drawDefinition:n,matchUpsCount:a,structureId:o,roundNumber:t,idPrefix:s,isMock:c,event:u});if(i.error)return Pn({result:i,info:{iteration:l}});i.matchUps?.length&&r.push(...i.matchUps),t=(i?.roundNumber??1)+1}return{matchUps:r}}function cD({scaleType:e=Yc,scaleAccessor:t,participant:r,scaleName:i,eventType:n}){let a=(r&&hg({scaleAttributes:{eventType:n??Vo,scaleType:e,scaleName:i},participant:r}))?.scaleItem?.scaleValue;return t&&v(a)?a[t]:a}function uD(e){let t=function(e){return e.roundsCount&&"number"!=typeof e.roundsCount?{error:gi,info:"roundsCount must be a number"}:"object"!=typeof e.drawDefinition||e.drawDefinition.drawType&&e.drawDefinition.drawType!==Is?{error:ve}:Array.isArray(e.drawDefinition?.entries)||!e.participantIds||Array.isArray(e.participantIds)?{error:void 0}:{error:gi,info:"Missing Entries"}}(e);if(t?.error)return t;let r=oD(e);if(r.error)return r;let i=function(e){if(e.structureId)return e.structureId;let t=e.drawDefinition,r=t?.structures?.filter(e=>1===e.stageSequence)?.reduce((e,t)=>{let r=t.stage&&Xo[t.stage];return nm({structure:t})&&r>(Xo[e?.stage]||1)?t:e},void 0),i=t?.structures?.find(e=>e.structureId===r?.structureId);return i?nm({structure:i})?{structure:i}:{error:ve}:{error:et}}(e);if(i.error)return i;let n,a=function(e){let{tournamentRecord:t,participantIds:r,scaleName:i,eventType:n,adHocRatings:a={}}=e,o=e.scaleAccessor??qh[i]?.accessor,s=t.participants??[];for(let c of r??[]){let e=s?.find(e=>e.participantId===c),t=cD({scaleName:`${i}.${Wc}`,participant:e,eventType:n});!t&&i&&(t=cD({scaleAccessor:o,participant:e,scaleName:i,eventType:n})),t&&!a[c]&&(a[c]=t)}return a}(e),o=e.tournamentRecord?.isMock??e.isMock,s=e.eventType??e.event?.eventType,c=[],u=[];for(let d of K(1,(e.roundsCount??1)+1)){let t=gw({...e,participantIds:r.participantIds,structure:i.structure,ignoreLastRoundNumber:!0,iterationMatchUps:c,adHocRatings:a,roundNumber:n,eventType:s,isMock:o});if(t.error)return t;let{matchUps:l,...p}=t;p.modifiedScaleValues&&(a=p.modifiedScaleValues),u.push({...p,iteration:d,matchUpsCount:l?.length}),n=(p?.roundNumber??1)+1,l?.length&&c.push(...l)}return{...ce,matchUps:c,roundResults:u}}function dD(e){let{tournamentRecord:t,drawDefinition:r,structureId:i,idPrefix:n,isMock:a,event:o}=e,s=o?.entries?.filter(({entryStage:e,entryStatus:t})=>(!e||e===Ho)&&t&&Bp.includes(t)),c=s?.map(dd),u=s?Math.floor(s.length/2):0;if(e.automated)return function(e){let{restrictEntryStatus:t,generateMatchUps:r,structureId:i,matchUpIds:n,scaleName:a,scaleAccessor:o}=e.drawMatic??{},s=uD({...e,eventType:e.drawMatic?.eventType??e.matchUpType,generateMatchUps:r??!0,scaleAccessor:o??e.scaleAccessor,scaleName:a??e.scaleName,participantIds:e.participantIds,roundsCount:e.roundsCount,restrictEntryStatus:t,structureId:i,matchUpIds:n});return s.error?s:(s?.matchUps?.length&&Ev({tournamentRecord:e.tournamentRecord,drawDefinition:e.drawDefinition,suppressNotifications:!0,matchUps:s.matchUps,event:e.event,structureId:i}),{...ce})}({...e,participantIds:c});{let s=sD({roundsCount:e.roundsCount,drawDefinition:r,matchUpsCount:u,idPrefix:n,isMock:a,event:o});if(s.error)return s;s.matchUps?.length&&Ev({matchUps:s.matchUps,suppressNotifications:!0,tournamentRecord:t,drawDefinition:r,structureId:i,event:o})}return{...ce}}function lD({sortDescending:e=!1,tournamentRecord:t,scaleAttributes:r,scaleSortMethod:i,stageSequence:n,entries:a,event:o,stage:s}){if(!t)return{error:Ie};let c=(a=a??o?.entries??[]).filter(e=>(!s||!e.entryStage||e.entryStage===s)&&(!n||!e.entryStageSequence||e.entryStageSequence===n)&&Bp.includes(e.entryStatus)),u={...r};return{scaledEntries:c.map(e=>{let{participantId:i}=e,{scaleItem:n}=Eg({tournamentRecord:t,scaleAttributes:r,participantId:i});return{...e,...n}}).filter(e=>{let t=e.scaleValue;return!!(i||!Number.isNaN(t)&&Number.parseFloat(t))&&t}).sort(i||(e||!1===u?.ascending?function(e,t){return d(t)-d(e)}:function(e,t){return d(e)-d(t)}))};function d(t){return Number.parseFloat(t.scaleValue||(e?-1:1e5))}}function pD(e){let t="prepareStage",{drawDefinition:r}=e,{structures:i}=Gd({stageSequence:e.stageSequence||1,roundTarget:e.roundTarget,stage:e.stage,drawDefinition:r}),n=e.preparedStructureIds||[],a=i?.find(({structureId:e})=>!n.includes(e));if(!a)return Pn({result:{error:et},stack:t});let o=a?.structureId,{seedsCount:s,stageEntries:c,seedLimit:u}=function(e){let{seedsCount:t}=e;e.seededParticipants&&(t=e.seededParticipants.length),t>e.drawSize&&(t=e.drawSize);let r=function({entries:e,stage:t,stageSequence:r,roundTarget:i}){return e.filter(e=>{let n=Ru({name:Wu,element:e})?.extension?.value;return(!e.entryStage||e.entryStage===t)&&(!r||!e.entryStageSequence||e.entryStageSequence===r)&&(!i||!n||n===i)&&Lp.includes(e.entryStatus)})}(e);t>r.length&&(t=r.length);let{seedLimit:i}=function({requireParticipantCount:e=!0,enforcePolicyLimits:t=!0,drawSizeProgression:r,participantsCount:i,participantCount:n,appliedPolicies:a,drawDefinition:o,seedingProfile:s,structureId:c,seedsCount:u}){i=i??n;let d=Vd({drawDefinition:o,structureId:c});if(d.error)return d;let l=d.structure;if(!l)return{error:et};let{positionAssignments:p}=qd({structure:l}),m=p?.length||0;if(u>m)return{error:qe};let f=l.structures?.length,h=F(s?.groupSeedingThreshold)&&s?.groupSeedingThreshold,g=MI({roundRobinGroupsCount:f,drawSize:m})?.seedGroups,{seedsCount:I}=jy({policyDefinitions:a,requireParticipantCount:e,drawSizeProgression:r,participantsCount:i,drawSize:m});return I&&a?.[lu]&&u>I&&t&&(u=I),l.seedLimit=u,l.seedAssignments=K(1,u+1).map(e=>{let t=g?.find(t=>t.includes(e)),r=t&&Math.min(...t);return{participantId:void 0,seedNumber:e,seedValue:h&&e>=h?r:e}}),Ml({drawDefinition:o,structureIds:[c]}),{...ce,seedLimit:u}}({enforcePolicyLimits:e.enforcePolicyLimits??!0,appliedPolicies:e.appliedPolicies,participantsCount:r.length,seedingProfile:e.seedingProfile,drawDefinition:e.drawDefinition,structureId:e.structureId,seedsCount:t});return i&&i<t&&(t=i),{seedsCount:t,stageEntries:r,seedLimit:i}}({...e,structureId:o});(e.seededParticipants||e.event||e.seedingScaleName)&&function(e){let{seededParticipants:t,seedingScaleName:r,entries:i,event:n}=e,a=i.map(dd);t?function(e){let{provisionalPositioning:t,enteredParticipantIds:r,seededParticipants:i,tournamentRecord:n,appliedPolicies:a,drawDefinition:o,seedingProfile:s,structureId:c,structure:u,event:d}=e,l=u?AI({provisionalPositioning:t,appliedPolicies:a,drawDefinition:o,seedingProfile:s,structure:u}):void 0;i.filter(({participantId:e})=>r.includes(e)).filter(e=>!e.seedNumber||e.seedNumber<=i.length).sort((e,t)=>e.seedNumber<t.seedNumber?-1:e.seedNumber<t.seedNumber?1:0).forEach(e=>{let{participantId:r,seedNumber:i,seedValue:a}=e;xI({provisionalPositioning:t,tournamentRecord:n,drawDefinition:o,seedingProfile:s,participantId:r,seedBlockInfo:l,structureId:c,seedNumber:i,seedValue:a,event:d})})}({...e,enteredParticipantIds:a}):(n||r)&&function(e){let t=e.seedsCount,{provisionalPositioning:r,enteredParticipantIds:i,seedAssignmentProfile:n,assignSeedsCount:a,tournamentRecord:o,drawDefinition:s,seedByRanking:c,seedingProfile:u,structureId:d,event:l}=e,{categoryName:p,ageCategoryCode:m}=l?.category||{},f=l?.eventType,h=function(e){let{tournamentRecord:t,seedingScaleName:r,stageSequence:i,entries:n,stage:a,event:o}=e,{categoryName:s,ageCategoryCode:c}=o?.category||{},u=o?.eventType,d={scaleName:r||s||c||o.eventId,scaleType:Kc,eventType:u};return lD({scaleAttributes:d,tournamentRecord:t,stageSequence:i,entries:n,stage:a}).scaledEntries}({...e,ageCategoryCode:m,categoryName:p,eventType:f})||c&&function(e){let{tournamentRecord:t,stageSequence:r,event:i,entries:n,stage:a}=e,{categoryName:o,ageCategoryCode:s}=i?.category||{},c=i?.eventType;return lD({scaleAttributes:{scaleName:o||s,scaleType:Hc,eventType:c},tournamentRecord:t,stageSequence:r,entries:n,stage:a}).scaledEntries}({...e,ageCategoryCode:m,categoryName:p,eventType:f}),g=h?.length??0;g<t&&(t=g),h?.filter(({participantId:e})=>i.includes(e)).slice(0,a||t).forEach((e,t)=>{let i=t+1,{participantId:a,scaleValue:c}=e;xI({provisionalPositioning:r,tournamentRecord:o,drawDefinition:s,seedingProfile:u,participantId:a,structureId:d,seedNumber:i,seedValue:n?.[i]||c||i,event:l})})}({...e,enteredParticipantIds:a})}({...e,seedsCount:s,structure:a,structureId:o});let d=!1!==e.automated&&e.drawType!==Is&&!(e.qualifyingOnly&&e.stage!==Yo),l=(i?.length||0)>1,p=d?function(e){let t="object"==typeof e.automated&&e.automated.seedsOnly,r=kU({...e,seedsOnly:t});if(r.error)return r;let i=r?.positionAssignments,n=r?.positioningReport;return{conflicts:r.conflicts,positionAssignments:i,positioningReport:n}}({...e,multipleStructures:l,seedLimit:u,structureId:o}):{};return p?.error?Pn({result:p,stack:t}):{...p,stageEntries:c,structureId:o,seedsCount:s}}function mD(e){let t=Qy({...e,modifyOriginal:!1});if(t.error)return t;let r=t.drawDefinition,{suppressDuplicateEntries:i=!0,ignoreStageSpace:n,appliedPolicies:a,qualifyingOnly:o,seedingProfile:s,participants:c,drawEntries:u,placeByes:d,drawSize:l,drawType:p,entries:m}=e,f=[],h=[],g=function(e){let{ignoreStageSpace:t,drawDefinition:r,drawEntries:i,drawType:n,entries:a}=e;for(let o of a){if(i&&o.entryStage&&o.entryStage!==Ho)continue;let a=Gg({...o,ignoreStageSpace:t??n===Is,entryStage:o.entryStage??Ho,event:e.event,drawDefinition:r,drawType:n});if(i&&a.error)return a}return{error:void 0}}({suppressDuplicateEntries:i,ignoreStageSpace:n,drawDefinition:r,drawEntries:u,drawType:p,entries:m});if(g.error)return g;let U=p===Ds?0:I(e.seedsCount??0),S=pD({...e,qualifyingOnly:!l||o,appliedPolicies:a,drawDefinition:r,seedingProfile:s,participants:c,stage:Ho,seedsCount:U,placeByes:d,drawSize:l,entries:m});if(S.error&&!S.conflicts)return S;S.positioningReport?.length&&f.push({[Ho]:S.positioningReport});let v=S.structureId;return S.conflicts&&(h=S.conflicts),p===Is&&e.roundsCount&&dD({...e,drawDefinition:r,structureId:v}),{drawDefinition:r,positioningReports:f,conflicts:h,structureId:v}}var fD=()=>({matchUpType:void 0,drawName:void 0,drawId:void 0,structures:[],entries:[],links:[]});function hD(e){let t=e.structureIds,{tournamentRecord:r,drawDefinition:i,matchUpFormat:n,structureId:a,matchUpId:o,event:s}=e,c=$c(e,[{[Xs]:!0,[ec]:!0}]);if(c.error)return c;if(!ta({matchUpFormat:n}))return{error:Ut};if(o){let e=zS({drawDefinition:i,matchUpId:o,event:s});if(e.error)return e;let t=e.matchUp;if(t?.matchUpType===$o)return{info:"Cannot set matchUpFormat when { matchUpType: TEAM }",error:Ct};t&&(t.matchUpFormat=n,Dl({tournamentId:r?.tournamentId,eventId:s?.eventId,context:"setMatchUpFormat",drawDefinition:i,matchUp:t}))}else if(Array.isArray(t)){if(s?.eventType===$o)return{error:at};for(let e of t){let t=Vd({drawDefinition:i,structureId:e});if(t.error)return t;t.structure&&(t.structure.matchUpFormat=n)}}else if(a){if(s?.eventType===$o)return{error:at};let e=Vd({drawDefinition:i,structureId:a});if(e.error)return e;e.structure&&(e.structure.matchUpFormat=n)}else i&&(i.matchUpFormat=n);return t=t??(a?[a]:void 0),Ml({drawDefinition:i,structureIds:t}),{...ce}}function gD({existingQualifyingStructures:e,tournamentRecord:t,drawDefinition:r,matchUpFormat:i,matchUpType:n,tieFormat:a,event:o}){if((i||a)&&!(i&&o?.matchUpFormat===i||o?.tieFormat&&a&&JSON.stringify(o.tieFormat)===JSON.stringify(a))){if(a){let t=function({tieFormat:e}){let t=Ba({checkCollectionIds:!1,tieFormat:e});if(t.error)return t;for(let r of e.collectionDefinitions)r.collectionId||(r.collectionId=za());return{tieFormat:e}}({tieFormat:a});if(t.error)return t;let i=e?.every(e=>e.tieFormat);(!e?.length||i)&&(r.tieFormat=t.tieFormat??a)}else if(i){let e=hD({tournamentRecord:t,drawDefinition:r,matchUpFormat:i,event:o});if(e.error)return{info:"matchUpFormat or tieFormat error",error:e.error}}n&&(r.matchUpType=n)}return{error:void 0}}var ID={};n(ID,{attachPolicies:()=>Sv,findPolicy:()=>Sp,getAppliedPolicies:()=>up,getPolicyDefinitions:()=>dp,mutate:()=>UD,query:()=>yD,removePolicy:()=>SD});var UD={};function SD(e){let t=$c(e,[{[dc]:!0,_anyOf:{[zs]:!1,[Js]:!1,[Xs]:!1,[bc]:!1}}]);if(t.error)return t;let r,i=e.drawDefinition??e.event??((e.tournamentId||!e.tournamentRecords)&&e.tournamentRecord);if(i)return vD(e,i);if(!e.tournamentRecords)return{error:Ie};{let t=Object.keys(e.tournamentRecords);if(!t.length)return{error:Ie};for(let i of t){let t=vD(e,e.tournamentRecords[i]);if(t.error)return t;r=!0}}return r?{...ce}:{error:Bt}}function vD(e,t){let r=up(e).appliedPolicies??{};return r[e.policyType]?(delete r[e.policyType],Object.keys(r).length?Uu({element:t,extension:{name:Nu,value:r}}):gu({element:t,name:Nu}),{...ce}):{error:Bt}}n(UD,{attachPolicies:()=>Sv,removePolicy:()=>SD});var yD={};n(yD,{findPolicy:()=>Sp,getAppliedPolicies:()=>up,getPolicyDefinitions:()=>dp});var wD={[lu]:{validSeedPositions:{ignore:!0},duplicateSeedNumbers:!0,drawSizeProgression:!0,seedingProfile:{drawTypes:{[Ls]:{positioning:os},[_s]:{positioning:os}},positioning:as},policyName:"USTA SEEDING",seedsCountThresholds:[{drawSize:4,minimumParticipantCount:3,seedsCount:2},{drawSize:16,minimumParticipantCount:12,seedsCount:4},{drawSize:32,minimumParticipantCount:24,seedsCount:8},{drawSize:64,minimumParticipantCount:48,seedsCount:16},{drawSize:128,minimumParticipantCount:96,seedsCount:32},{drawSize:256,minimumParticipantCount:192,seedsCount:64}]}},PD=wD;function TD({appliedPolicies:e,policyDefinitions:t,drawDefinition:r,stack:i}){if(t&&"object"!=typeof t)return Pn({info:"policyDefinitions must be an object",result:{error:gi},stack:i});let n={[uu]:e?.[uu]};return t?function({policyDefinitions:e,appliedPolicies:t,policiesToAttach:r,drawDefinition:i}){for(let n of Object.keys(e))JSON.stringify(t?.[n])!==JSON.stringify(e[n])&&(r[n]=e[n]);Object.keys(r).length&&(Sv({policyDefinitions:r,drawDefinition:i}),t&&Object.assign(t,r))}({policyDefinitions:t,appliedPolicies:e,policiesToAttach:n,drawDefinition:r}):n.avoidance&&Sv({drawDefinition:r,policyDefinitions:n}),!e?.[lu]&&!t?.[lu]&&(Sv({policyDefinitions:PD,drawDefinition:r}),e&&Object.assign(e,PD)),{error:void 0}}function DD(e){let{tournamentRecord:t,policyDefinitions:r,appliedPolicies:i,matchUpFormat:n,matchUpType:a,tieFormat:o,drawType:s,stack:c,event:u}=e,d=e.drawId?u?.drawDefinitions?.find(t=>t.drawId===e.drawId):void 0,l=d?.structures?.find(e=>e.stage===Ho&&1===e.stageSequence)?.structureId,p=d?d.structures?.filter(e=>e.stage===Yo):[],m=1===p?.length&&!p[0].matchUps?.length&&p[0].structureId;d&&s!==d.drawType&&(d.drawType=s);let f=d??function(e){let{drawId:t=za(),processCodes:r,matchUpType:i,drawType:n}=e??{},a=fD();return Object.assign(a,{processCodes:r,matchUpType:i,drawType:n,drawId:t})}({processCodes:e.processCodes,drawId:e.drawId,drawType:s}),h=gD({existingQualifyingStructures:p,tournamentRecord:t,drawDefinition:f,matchUpFormat:n,matchUpType:a,tieFormat:o,event:u});if(h.error)return Pn({result:h,stack:c});let g=TD({appliedPolicies:i,policyDefinitions:r,drawDefinition:f,stack:c});return g.error?g:{drawDefinition:f,structureId:l,existingDrawDefinition:d,existingQualifyingPlaceholderStructureId:m}}var bD={};function MD(){return"\n    This project would not have been possible without the generous input and patience\n    of tournament organizers and directors who worked with early versions of CourtHive/TMX.\n\n    Thanks to Miro, Pavel, Ivan, Mladen, Zdenko, Antonia, Jakov, Kreso, Barry, Jeff, Bobby... to name just a few. \n\n    The project would not have even begun without the support of Miro, or the introduction by Sretchko.\n    The project would not have succeeded without the enthusiasm of Randy and Bruce.\n    Thanks to serendipity and Luca and the ensuing TODS conversations with ITF.\n    Thanks to Scott and Jake for sanity checks, suggestions, and camaraderie.\n    Thanks to Zoran for inspiring the async support and getting into the weeds with subscriptions.\n    Thanks to Dave for backing the conversion of TMX 1.x source into the factory repository.\n    Thanks to Vuk and Pavle and Rich and Chris and Deepa for the direct engagement with the APIs.\n    Thanks to Joe for repeatedly challenging me and the many pointers to useful tooling.\n    Thanks to Shannon for the validation of the approach from his deep domain experience.\n    Thanks to Nikola for the ongoing camaraderie and explorations of what we can do with TODS.\n\n    And a special thanks to my family for putting up with the long days and weeks and months of coding\n    and conversations at all hours.\n  "}n(bD,{addGoesTo:()=>oh,allCompetitionMatchUps:()=>Zf,allDrawMatchUps:()=>th,allEventMatchUps:()=>Qf,allPlayoffPositionsFilled:()=>cU,allTournamentMatchUps:()=>Xf,analyzeDraws:()=>Tv,analyzeMatchUp:()=>nM,analyzeTournament:()=>$D,bulkUpdatePublishedEventIds:()=>rb,calculateWinCriteria:()=>zb,categoryCanContain:()=>_a,checkMatchUpIsComplete:()=>Vf,checkValidEntries:()=>$y,compareTieFormats:()=>JD,competitionScheduleMatchUps:()=>jb,courtGridRows:()=>yb,credits:()=>MD,drawMatchUps:()=>aM,eventMatchUps:()=>Bb,filterMatchUps:()=>Lf,filterParticipants:()=>Rg,findDrawDefinition:()=>ry,findExtension:()=>Ru,findVenue:()=>Pf,getAggregateTeamResults:()=>GD,getAllDrawMatchUps:()=>Kf,getAllEventData:()=>ib,getAllStructureMatchUps:()=>Bf,getAllowedDrawTypes:()=>xD,getAllowedMatchUpFormats:()=>FD,getAppliedPolicies:()=>up,getAssignedParticipantIds:()=>Nh,getAvailableMatchUpsCount:()=>Fv,getAvailablePlayoffProfiles:()=>LS,getCategoryAgeDetails:()=>Fa,getCheckedInParticipantIds:()=>qm,getCompetitionDateRange:()=>BD,getCompetitionMatchUps:()=>Gb,getCompetitionParticipants:()=>ND,getCompetitionPenalties:()=>LD,getCompetitionVenues:()=>$v,getCourtInfo:()=>Mf,getCourts:()=>sM,getDrawData:()=>Xv,getDrawDefinitionTimeItem:()=>Xl,getDrawParticipantRepresentativeIds:()=>xv,getDrawStructures:()=>Gd,getDrawTypeCoercion:()=>Ly,getEligibleVoluntaryConsolationParticipants:()=>kv,getEntriesAndSeedsCount:()=>Pb,getEvent:()=>lM,getEventData:()=>Zv,getEventMatchUpFormatTiming:()=>Ob,getEventProperties:()=>uM,getEventPublishStatus:()=>vg,getEventStructures:()=>aU,getEventTimeItem:()=>Zl,getEvents:()=>dM,getFlightProfile:()=>Nf,getHomeParticipantId:()=>Kb,getLinkedTournamentIds:()=>nd,getMatchUpCompetitiveProfile:()=>mm,getMatchUpContextIds:()=>Jb,getMatchUpDailyLimits:()=>$b,getMatchUpDailyLimitsUpdate:()=>Fb,getMatchUpDependencies:()=>sh,getMatchUpFormat:()=>Zb,getMatchUpFormatTiming:()=>uf,getMatchUpFormatTimingUpdate:()=>Mb,getMatchUpScheduleDetails:()=>Ef,getMatchUpType:()=>Ff,getMatchUpsMap:()=>Kp,getMatchUpsStats:()=>eM,getMatchUpsToSchedule:()=>ob,getMaxEntryPosition:()=>Tb,getModifiedMatchUpFormatTiming:()=>kb,getPairedParticipant:()=>Of,getParticipantEventDetails:()=>AD,getParticipantIdFinishingPositions:()=>ey,getParticipantMembership:()=>ED,getParticipantResults:()=>Zh,getParticipantScaleItem:()=>Eg,getParticipantSchedules:()=>CD,getParticipantSignInStatus:()=>OD,getParticipantTimeItem:()=>tp,getParticipants:()=>Ag,getPersonRequests:()=>hb,getPolicyDefinitions:()=>dp,getPositionAssignments:()=>_v,getPositionsPlayedOff:()=>xS,getPredictiveAccuracy:()=>qb,getProfileRounds:()=>Sb,getPublishState:()=>wg,getRandomQualifierList:()=>By,getRoundMatchUps:()=>em,getRounds:()=>iM,getScaleValues:()=>Qc,getScaledEntries:()=>lD,getScheduledRoundsDetails:()=>cb,getSchedulingProfile:()=>lb,getSchedulingProfileIssues:()=>fb,getSeedingThresholds:()=>RI,getSeedsCount:()=>jy,getStructureSeedAssignments:()=>Wp,getTeamLineUp:()=>kf,getTieFormat:()=>eb,getTimeItem:()=>Ql,getTournamentIds:()=>Mu,getTournamentInfo:()=>zv,getTournamentPenalties:()=>_D,getTournamentPersons:()=>VD,getTournamentPoints:()=>YD,getTournamentPublishStatus:()=>Sg,getTournamentStructures:()=>oU,getTournamentTimeItem:()=>ep,getValidGroupSizes:()=>DI,getVenueData:()=>Rf,getVenuesAndCourts:()=>jv,isAdHoc:()=>nm,isCompletedStructure:()=>sU,isValidForQualifying:()=>Vy,isValidMatchUpFormat:()=>ta,matchUpActions:()=>Ey,participantScaleItem:()=>hg,participantScheduledMatchUps:()=>_b,positionActions:()=>_y,publicFindCourt:()=>bf,publicFindVenue:()=>Tf,tallyParticipantResults:()=>fg,tieFormatGenderValidityCheck:()=>Fn,tournamentMatchUps:()=>Vb,validMatchUp:()=>Xp,validMatchUps:()=>Zp,validateCollectionDefinition:()=>La,validateLineUp:()=>HI});var RD={};function ND(e){let{tournamentRecords:t}=e||{};if("object"!=typeof t||!Object.keys(t).length)return{error:ge};let r=[],i={},n={},a={},o=[],s={},c=[];for(let u of Object.values(t)){let{participantIdsWithConflicts:t,mappedMatchUps:d,participantMap:l,participants:p,matchUps:m,derivedEventInfo:f,derivedDrawInfo:h}=Ag({...e,tournamentRecord:u});Object.assign(s,d),Object.assign(i,l),Object.assign(n,f),Object.assign(a,h),r.push(...p??[]),o.push(...m??[]),t?.forEach(e=>{c.includes(e)||c.push(e)})}return{participantIdsWithConflicts:c,derivedEventInfo:n,derivedDrawInfo:a,participantMap:i,mappedMatchUps:s,participants:r,...ce,matchUps:o}}function AD({tournamentRecord:e,participantId:t}){if(!e)return{error:Ie};if(!t)return{error:Ir};let r=[t].concat((e.participants??[]).filter(e=>e?.participantType&&[$l,jl].includes(e.participantType)&&e.individualParticipantIds?.includes(t)).map(e=>e.participantId));return{eventDetails:(e.events??[]).filter(e=>Z((e?.entries??[]).map(e=>e.participantId),r)).map(e=>({eventName:e.eventName,eventId:e.eventId}))}}function ED({tournamentRecord:e,participantId:t}){if(!e)return{error:Ie};if(!t)return{error:Ir};let{participants:r}=Ag({participantFilters:{participantTypes:[$l,jl,Gl]},tournamentRecord:e});return(r??[]).filter(e=>e.individualParticipantIds?.includes(t)).reduce((e,t)=>{let r=t.participantType;return r&&(e[r]||(e[r]=[]),e[r].push(t)),e},{})}function CD({participantFilters:e={},tournamentRecord:t}){if(!t)return{error:Ie};if("object"!=typeof e)return{error:mi,context:{participantFilters:e}};let r=Xf({tournamentRecord:t,contextFilters:{eventIds:e.eventIds}}).matchUps??[],i=Object.assign({},...r.map(e=>({[e.matchUpId]:e}))),n=r.filter(({schedule:e})=>e&&Object.keys(e).length),a=sh({tournamentRecord:t,matchUps:r}).sourceMatchUpIds??[],o={};for(let s of n){let e,{sides:t}=s,r=t?.map(t=>{if(t.participant)return[t.participant].concat(...t.participant.individualParticipants||[]);a[s.matchUpId]&&!e&&(e=(a[s.matchUpId]||[]).map(e=>i[e]).filter(({winningSide:e,bye:t})=>!e&&!t))}).filter(Boolean).flat()??[];for(let i of r){let{participantId:e}=i;o[e]||(o[e]={potentialMatchUps:[],participant:i,matchUps:[]}),o[e].matchUps.push(s)}let n=e?.map(({sides:e})=>e).flat().map(({participant:e})=>e&&[e].concat(...e.individualParticipants||[])).filter(Boolean).flat()||[];for(let i of n){let{participantId:e}=i;o[e]||(o[e]={potentialMatchUps:[],participant:i,matchUps:[]}),o[e].potentialMatchUps.push(s)}}return{participantSchedules:Object.values(o).filter(({participant:t})=>!(e.participantIds&&!e.participantIds.includes(t.participantId)||e.participantTypes&&!e.participantTypes.includes(t.participantType))),...ce}}function OD({tournamentRecord:e,participantId:t}){if(!e)return{error:Ie};if(!t)return{error:Ir};let{participant:r}=Kl({tournamentRecord:e,participantId:t});if(!r)return{error:Sr};let{timeItem:i}=Ql({itemType:xl,element:r});return i&&i.itemValue===Ll&&Ll}n(RD,{filterParticipants:()=>Rg,getCompetitionParticipants:()=>ND,getPairedParticipant:()=>Of,getParticipantEventDetails:()=>AD,getParticipantMembership:()=>ED,getParticipantScaleItem:()=>Eg,getParticipantSchedules:()=>CD,getParticipantSignInStatus:()=>OD,getParticipantTimeItem:()=>tp,getParticipants:()=>Ag,getScaleValues:()=>Qc,participantScaleItem:()=>hg,validateLineUp:()=>HI});var kD={};function FD({tournamentRecord:e,categoryName:t,categoryType:r}){if(!e)return{error:Ie};let{appliedPolicies:i}=up({tournamentRecord:e});return(i?.[du]?.matchUpFormats||[]).filter(({categoryNames:e,categoryTypes:i})=>!t&&!i||t&&e?.includes(t)||r&&i?.includes(r))}function xD({tournamentRecord:e,categoryName:t,categoryType:r}){if(!e)return{error:Ie};let{appliedPolicies:i}=up({tournamentRecord:e});return(i?.[mu]?.allowedDrawTypes||[]).filter(({categoryNames:e,categoryTypes:i})=>!t&&!i||t&&e?.includes(t)||r&&i?.includes(r))}function _D({tournamentRecord:e}){if(!e)return{error:Ie};let t=(e?.participants??[]).reduce((e,t)=>{let{participantId:r}=t;return(t.penalties??[]).forEach(t=>{let{penaltyId:i}=t||{};e[i]?e[i].participants.push(r):e[i]={...t,participantIds:[r]}}),e},{});return{penalties:Object.values(t)}}function LD({tournamentRecords:e}){if("object"!=typeof e||!Object.keys(e).length)return{error:ge};let t=[];for(let r of Object.values(e)){let{penalties:e}=_D({tournamentRecord:r});t.push(...e??[])}return{penalties:t}}function BD({tournamentRecords:e}){if(!v(e))return{error:ge};let t=Object.keys(e??{}).reduce((t,r)=>{let i=e[r],{tournamentInfo:{startDate:n,endDate:a}}=zv({tournamentRecord:i}),o=n&&ya(n),s=o&&new Date(o);(!t.startDate||s&&s<t.startDate)&&(t.startDate=s);let c=a&&ya(a),u=c&&new Date(c);return(!t.endDate||u&&u>t.endDate)&&(t.endDate=u),t},{startDate:void 0,endDate:void 0}),r=t.startDate&&ya(t.startDate.toISOString()),i=t.endDate&&ya(t.endDate.toISOString());return r&&i?{startDate:r,endDate:i}:{error:Wt}}function VD({tournamentRecord:e,participantFilters:t}){if(!e)return{error:Ie};let r=e.participants||[];t&&(r=Rg({participants:r,participantFilters:t,tournamentRecord:e}));let i={};return r.forEach(e=>{e.person&&(e=>{if(e.person){let{personId:t}=e.person;i[t]?i[t].participantIds.push(e.participantId):i[t]={...e.person,participantIds:[e.participantId]}}})(e)}),{tournamentPersons:Object.values(i)}}function GD(e){let t=$c(e,[{[Js]:!0}]);if(t.error)return t;let r=e.finishingPositionRangeBounsPoints||{},i={},n=e=>{let t=e?.individualParticipants?.map(e=>1===e.teams?.length&&e.teams[0]);return 1===e?.teams?.length&&e?.teams?.[0]||t?.[0].participantId===t?.[1].participantId&&t?.[0]},{matchUps:a,participants:o}=Ag({participantFilters:{participantTypes:[Vl]},withRankingProfile:!0,withStatistics:!0,...e});for(let l of o??[]){if(l.participantType===Bl)continue;"draw-0-3"===l.draws?.[0]?.drawId&&console.log(l.participantType,l.draws[0].finishingPositionRange);let e=n(l);if(e)for(let t of l?.draws??[]){let n=t?.finishingPositionRange?.join("-");if(n&&r?.[n]){let a=e?.participantId,o=t?.drawId;i[`${a}|${o}|${n}`]=r[n]}}}let s=e=>({teamName:e,standingPoints:0,pointsPlayed:0,pointsPct:0,points:0,bonus:0,diff:0,loss:0,win:0}),c=(e,t,r)=>{void 0===e[t]&&(e[t]=0),e[t]+=r},u={},d={};for(let l of a??[]){let{sides:e,matchUpFormat:t}=l,r=t&&Yn(t);if(2===e?.length&&r.setFormat?.timed&&(!r.finalSetFormat||r.finalSetFormat?.timed))for(let i of e){let e=n(i.participant),t=e?.participantId,r=i.participant?.participantId,a=e?.participantName,o=i.sideNumber,p=i.participant?.individualParticipantIds||r&&[r]||[];if(p.forEach(e=>{e&&!u[e]&&(u[e]=s(a))}),t&&o){d[t]||(d[t]=s(a));let e=[...p.map(e=>u[e]),d[t]];l.winningSide&&(o===l.winningSide?e.forEach(e=>c(e,"win",1)):e.forEach(e=>c(e,"loss",1)));let r=l.score?.sets||[];for(let t of r){let r=t?.[`side${3-o}Score`]||0,i=t?.[`side${o}Score`]||0,n=i-r;e.forEach(e=>c(e,"pointsPlayed",i+r)),e.forEach(e=>c(e,"points",i)),e.forEach(e=>c(e,"diff",n))}}}}for(let l of Object.keys(i)){let[e]=l.split("|");d[e]&&(d[e].bonus+=i[l],d[e].pointsPct=parseFloat((d[e].points/d[e].pointsPlayed).toFixed(2)),d[e].standingPoints=d[e].win+d[e].bonus)}for(let l of Object.keys(u))u[l].pointsPct=parseFloat((u[l].points/u[l].pointsPlayed).toFixed(2));return{...ce,individualResults:u,teamResults:d}}function jD(e){let t=2===e.participants?.filter(({participantType:e})=>e===$l)?.length,r=1===e.events?.length&&e.events[0],i=1===r?.drawDefinitions?.length&&r.drawDefinitions[0],n=2===(1===i?.structures?.length&&i.structures[0])?.positionAssignments?.length;return!!(r.tieFormat&&t&&n)}function $D({tournamentRecord:e}){if(!e)return{error:Ie};let{drawsAnalysis:t}=Tv({tournamentRecord:e}),r={isDual:jD(e),drawsAnalysis:t},i=Ag({tournamentRecord:e});return i.missingParticipantIds?.length&&(r.missingParticipantIds=i.missingParticipantIds),{...ce,analysis:r}}function qD(e,t){return e&&t&&Array.isArray(t)&&t[e-1]||"object"==typeof t&&t[e]}function WD(e){let{participation:t={},awardProfiles:r,startDate:i,eventType:n,drawSize:a,drawType:o,category:s,endDate:c,level:u}=e,{participationOrder:d,flightNumber:l,rankingStage:p}=t;return{awardProfile:r.find(e=>(e=>!i&&!c||!e.dateRanges||e.dateRanges.some(e=>{let t=!i||!e.startDate||new Date(i)>new Date(e.startDate),r=!c||!e.endDate||new Date(c)<=new Date(e.endDate);return t&&r}))(e)&&(!e.maxFlightNumber||l<=e.maxFlightNumber)&&(!e.drawTypes?.length||e.drawTypes?.includes(o))&&(!e.drawSizes?.length||e.drawSizes.includes(a))&&(!e.stages?.length||e.stages.includes(p))&&(!e.levels?.length||e.levels.includes(u))&&(!e.maxDrawSize||a<=e.maxDrawSize)&&(!e.drawSize||e.drawSize===a)&&(!e.maxLevel||u<=e.maxLevel)&&(!l||!e.flights?.flightNumbers?.length||e.flights.flightNumbers.includes(l))&&(!e.participationOrder||e.participationOrder===d)&&(!e.category?.ageCategoryCodes||e.category.ageCategoryCodes.includes(s?.ageCategoryCode))&&(!e.eventTypes?.length||e.eventTypes?.includes(n)))}}function HD({participantWon:e,flightNumber:t,valueObj:r,drawSize:i,flights:n,level:a}){let o,s,c,u,d=(e,t)=>{if(e){if(Array.isArray(t)){let r=t.find(t=>t.flight===e||t.f===e);return r.value||r.v}if("object"==typeof t){let r=t.flights||t.f;if(Array.isArray(r))return r[e-1]}}},l=(e,t)=>{let r=e?.value||e?.v||(F(e)?e:0),i=qD(a,e?.level);return{value:d(t,i)||F(i)&&i||r}},p=0,m=(e?"won":!1===e&&"lost")||void 0;if(Array.isArray(r)){let e=r.find(e=>e.drawSize===i||e.drawSizes?.includes(i)),n=r.find(e=>e.drawSize&&e.threshold&&i>e.drawSize),a=r.find(e=>!e.drawSize&&!e.drawSizes?.length);void 0!==m&&(e=e?.[m],n=n?.[m],a=a?.[m]),s=l(e,t).value,c=l(n,t).value,u=l(a,t).value,p=s||c||u,o=s&&e.requireWin||c&&n.requireWin||a?.requireWin}else if("object"==typeof r){let e=r?.drawSizes?.[i],n=r;void 0!==m&&(e=e?.[m],n=n?.[m]),s=l(e,t).value,u=l(n,t).value,p=s||u,o=s?e.requireWin:n?.requireWin}else F(r)&&void 0===m&&(p=r);return t&&n?.pct?.[t]&&(p=Math.round(p*n.pct[t])),{awardPoints:p,requireWin:o}}function YD({participantFilters:e,policyDefinitions:t,tournamentRecord:r,level:i}){if(!r)return{error:Ie};let{policyDefinitions:n}=dp({policyTypes:[nu],tournamentRecord:r}),a=t?.[nu]??n?.[nu];if(!a)return{error:kt};let o=a.awardProfiles,s=a.requireWinFirstRound,c=a.requireWinForPoints,{participants:u,derivedEventInfo:d,derivedDrawInfo:l,mappedMatchUps:p}=Ag({withRankingProfile:!0,participantFilters:e,tournamentRecord:r}),m=u?.filter(e=>e.draws?.length),f={},h={},g={};for(let I of m??[]){let{participantType:e,participantId:t,person:n,draws:a}=I;for(let u of a){let a,{drawId:m,structureParticipation:U,eventId:S}=u,v=d[S],y=l[m],w=y?.drawType,{category:P,eventType:T}=v||{},D=u.startDate||v.startDate||r.startDate,b=u.endDate||v.endDate||r.endDate;if((T!==qo||t===Bl)&&o){let r,u=c,d=0,l=0,S=0;for(let n of U){let{finishingPositionRange:c,participationOrder:m,participantWon:f,flightNumber:h,rankingStage:g,winCount:U}=n;d+=U||0;let v=y?.drawSize,{awardProfile:M}=WD({awardProfiles:o,participation:n,eventType:T,startDate:D,category:P,drawSize:v,drawType:w,endDate:b,level:i});if(M){if(!v)continue;let e=Array.isArray(c)&&Math.max(...c),t=L(c||[]).join("-"),n=e&&g!==Yo&&c?.includes(v);void 0!==M.requireWinForPoints&&(u=M.requireWinForPoints),void 0!==M.requireWinFirstRound&&(s=M.requireWinFirstRound);let a,{finishingPositionPoints:o={},finishingPositionRanges:d,finishingRound:p,pointsPerWin:I,flights:y}=M,w=Array.isArray(M.perWinPoints)?M.perWinPoints?.find(e=>e.participationOrders?.includes(m)):M.perWinPoints,P=o.participationOrders,T=0;if((!P||P.includes(m))&&d&&e){let t=d[e];t&&({awardPoints:T,requireWin:a}=HD({flightNumber:h,valueObj:t,drawSize:v,flights:y,level:i}))}if(!T&&p&&1===m&&e){let t=p[e];t&&({awardPoints:T,requireWin:a}=HD({participantWon:f,flightNumber:h,valueObj:t,drawSize:v,flights:y,level:i}))}if(n&&void 0!==s&&(u=s),void 0!==a&&(u=a),T>l&&(!u||U)&&(l=T,r=e),!T&&I&&U&&(S+=U*I,r=t),!T&&U&&w){let e=qD(i,w?.level);e?S+=U*e:w.value&&(S+=U*w.value)}}if(a=l+S,e===Bl){let e=(I.matchUps||[]).filter(({structureId:e})=>e===n.structureId);for(let{matchUpId:r}of e){let e=p[r],i=e.sides.find(e=>e.participantId===t).sideNumber;if(e.winningSice===i)for(let t of e.tieMatchUps)t.winningSide}}}if(S||l){let i={winCount:d,positionPoints:l,rangeAccessor:r,perWinPoints:S,eventType:T,drawId:m,points:a},o=n?.personId;o?(f[o]||(f[o]=[]),f[o].push(i)):e===jl?(g[t]||(g[t]=[]),g[t].push(i)):e===Bl&&(h[t]||(h[t]=[]),h[t].push(i))}}}}return{participantsWithOutcomes:m,personPoints:f,pairPoints:g,teamPoints:h,...ce}}n(kD,{analyzeDraws:()=>Tv,analyzeTournament:()=>$D,getAggregateTeamResults:()=>GD,getAllowedDrawTypes:()=>xD,getAllowedMatchUpFormats:()=>FD,getAppliedPolicies:()=>up,getCompetitionDateRange:()=>BD,getCompetitionPenalties:()=>LD,getPolicyDefinitions:()=>dp,getTournamentInfo:()=>zv,getTournamentPenalties:()=>_D,getTournamentPersons:()=>VD,getTournamentPoints:()=>YD,getTournamentStructures:()=>oU,getTournamentTimeItem:()=>ep});var zD={};function KD(e){if(!e)return{};let t=[],r=e.tieFormatName,i=e.collectionDefinitions?.map(e=>{let{matchUpType:r,matchUpFormat:i,matchUpCount:n,category:a,gender:o}=e;t.includes(i)||t.push(i);let s=a?.ageCategoryCode;return[n,r===d?"D":"S",s,i,o].join(";")}).join("|");return{tieFormatName:e&&r||"UNNAMED",matchUpFormats:t,tieFormatDesc:i}}function JD({considerations:e={},descendant:t,ancestor:r}){let i={},n={},{matchUpFormats:a,tieFormatDesc:o}=KD(t),{matchUpFormats:s,tieFormatDesc:c}=KD(r),u=L((a??[]).filter(e=>!(s??[]).includes(e)).concat((s??[]).filter(e=>!(a??[]).includes(e)))),d=!(!e?.collectionName||t.collectionDefinitions.map(({collectionName:e})=>e).join("|")===r.collectionDefinitions.map(({collectionName:e})=>e).join("|")),l=!(!e?.collectionOrder||t.collectionDefinitions.map(({collectionOrder:e})=>e).join("|")===r.collectionDefinitions.map(({collectionOrder:e})=>e).join("|")),p=Object.assign({},...(t?.collectionDefinitions||[]).map(e=>({[e.collectionId]:e}))),m=Object.assign({},...(r?.collectionDefinitions||[]).map(e=>({[e.collectionId]:e})));i.collectionIds=X(Object.keys(p),Object.keys(m)),n.collectionIds=X(Object.keys(m),Object.keys(p)),i.collectionsValue=QD(p),n.collectionsValue=QD(m),i.groupsCount=r?.collectionGroups?.length??(0-(t?.collectionGroups?.length??0)||0),n.groupsCount=i.groupsCount?-1*i.groupsCount:0;let f=i.collectionsValue.totalValue-n.collectionsValue.totalValue,h=i.collectionsValue.totalMatchUps-n.collectionsValue.totalMatchUps,g=n.collectionsValue.assignmentValues.length!==i.collectionsValue.assignmentValues.length,I=n.collectionsValue.assignmentValues.some((e,t)=>{let r=i.collectionsValue.assignmentValues[t];return!r||e.valueKey!==r.valueKey||e.value!==r.value||!!Array.isArray(e.value)&&e.value.every((e,t)=>r.value[t]===e)}),U=d||l||c!==o||g||I||0!==f,S=[...n.collectionsValue.invalidValues,...i.collectionsValue.invalidValues],v=S.length&&S;return{matchUpFormatDifferences:u,matchUpCountDifference:h,descendantDifferences:i,ancestorDifferences:n,orderDifference:l,valueDifference:f,nameDifference:d,descendantDesc:o,ancestorDesc:c,...ce,different:U,invalid:v}}function QD(e){let t=[],r=[],i=0;return{totalValue:Object.keys(e).sort(Mg).reduce((n,a)=>{let o=e[a],{collectionValueProfiles:s,collectionValue:c,matchUpCount:u,matchUpValue:d,scoreValue:l,setValue:p}=o,m={collectionValueProfiles:s,collectionValue:c,matchUpValue:d,scoreValue:l,setValue:p},f=Object.keys(m).filter(e=>![void 0,null].includes(m[e])&&(!Array.isArray(m[e])||m[e].length>0));1!==f.length&&t.push({collectionId:a});let h=f[0];if(h){let e="collectionValueProfiles"===h?Object.values(s):m[h];r.push({valueKey:h,value:e})}return i+=u,s?.length?n+s.reduce((e,t)=>e+t.value,0):u?F(d)?n+d*u:F(l)?n+l*u:F(p)?n+p*u:n+c:n},0),totalMatchUps:i,invalidValues:t,assignmentValues:r}}function XD(e){Object.assign(e,{inContext:!0});let{matchUp:t,error:r}=ZD(e);return{matchUp:Wa(t,!0,!0),error:r}}function ZD({participantsProfile:e,afterRecoveryTimes:t,tournamentRecord:r,contextContent:i,contextProfile:n,drawDefinition:a,nextMatchUps:o,matchUpId:s,inContext:c,eventId:u,drawId:d,event:l}){if(!r)return{error:Ie};if("string"!=typeof s)return{error:Mt};if(!a||!l){let e=(Xf({tournamentRecord:r,nextMatchUps:o}).matchUps??[]).find(e=>e.matchUpId===s);if(!e)return{error:Nt};({eventId:u,drawId:d}=e),({event:l,drawDefinition:a}=Af({tournamentRecord:r,eventId:u,drawId:d}))}if(!a)return{error:Pe};n&&!i&&(i=Up({tournamentRecord:r,contextProfile:n}));let p={surfaceCategory:l?.surfaceCategory??r.surfaceCategory,indoorOutDoor:l?.indoorOutdoor??r.indoorOutdoor,endDate:l?.endDate??r.endDate,tournamentId:r.tournamentId,eventId:u??l?.eventId,drawId:d},{participants:m=[]}=cp({participantsProfile:e,tournamentRecord:r,contextProfile:n,inContext:c});if(o){let e=(th({context:c?p:void 0,participants:m,afterRecoveryTimes:t,contextContent:i,contextProfile:n,drawDefinition:a,nextMatchUps:o,inContext:c,event:l}).matchUps??[]).find(e=>e.matchUpId===s);if(!e)return{error:Nt};let r=a?.structures?.find(t=>t.structureId===e.structureId);return{drawDefinition:a,structure:r,matchUp:e}}{let{matchUp:e,structure:r}=zS({context:c?p:void 0,tournamentParticipants:m,afterRecoveryTimes:t,contextContent:i,drawDefinition:a,contextProfile:n,matchUpId:s,inContext:c,event:l});return{matchUp:e,structure:r,drawDefinition:a}}}function eb({tournamentRecord:e,drawDefinition:t,structureId:r,matchUpId:i,structure:n,eventId:a,drawId:o,event:s}){if(!e)return{error:Ie};if(!(o||s||r||i))return Pn({result:{error:$t},stack:"getTieFormat"});a&&!s&&(s=e.events?.find(e=>e.eventId===a));let c=XD({tournamentRecord:e,drawDefinition:t,matchUpId:i,drawId:o,event:s});if(i&&c?.error)return c;if(!t&&c?.drawDefinition&&(t=c?.drawDefinition),!(n=n??c?.structure)&&r&&!i){if(!t)return{error:Ge};let e=Vd({drawDefinition:t,structureId:r});if(e.error)return e;n=e.structure}let u=(n?.tieFormat||n?.tieFormatId)&&zp({structure:n,drawDefinition:t,event:s})?.tieFormat,d=(t?.tieFormat||t?.tieFormatId)&&zp({drawDefinition:t,event:s})?.tieFormat,l=zp({event:s})?.tieFormat,p=zp({matchUp:c?.matchUp,drawDefinition:t,structure:n,event:s})?.tieFormat;return{...ce,matchUp:c?.matchUp,structureDefaultTieFormat:nv(u),eventDefaultTieFormat:nv(l),drawDefaultTieFormat:nv(d),tieFormat:nv(p),structure:n}}n(zD,{compareTieFormats:()=>JD,getTieFormat:()=>eb,tieFormatGenderValidityCheck:()=>Fn,validateCollectionDefinition:()=>La});var tb={};function rb({tournamentRecord:e,outcomes:t}){if(!e)return{error:Ie};if(!t?.length)return{error:$t,info:"Missing outcomes"};let r=t.reduce((e,t)=>{let{drawId:r,eventId:i}=t;return i&&r&&(e[i]?e[i].includes(r)||e[i].push(r):e[i]=[r]),e},{}),i=Object.keys(r);return{publishedEventIds:(e.events?.filter(e=>i.includes(e.eventId))).filter(e=>{let t=vg({event:e}),{drawDetails:i,drawIds:n}=t??{},{eventId:a}=e;return r[a].filter(e=>{let r=i?Object.keys(t.drawDetails).filter(e=>yg({drawId:e,drawDetails:i})):[];return n?.includes(e)||r.includes(e)}).length}).map(e=>e.eventId),eventIdPublishedDrawIdsMap:r}}function ib({tournamentRecord:e,policyDefinitions:t}){if(!e)return{error:Ie};let r=e.events||[],i=e?.participants||[],{tournamentInfo:n}=zv({tournamentRecord:e}),{venues:a}=jv({tournamentRecord:e});return{allEventData:{tournamentInfo:n,venuesData:a,eventsData:r.map(r=>{let{eventId:n}=r,a=qv({event:r}).eventInfo,o=vp({tournamentRecord:e,event:r}).scheduleTiming,s=(r.drawDefinitions||[]).map(a=>{let{drawId:s,drawName:c,matchUpFormat:u,updatedAt:d}=a,l={drawId:s,drawName:c,matchUpFormat:u,updatedAt:d},{abandonedMatchUps:p,completedMatchUps:m,upcomingMatchUps:f,pendingMatchUps:h}=Jf({requireParticipants:!0,tournamentParticipants:i,context:{eventId:n},policyDefinitions:t,tournamentRecord:e,inContext:!0,scheduleTiming:o,drawDefinition:a,event:r});return{drawInfo:l,matchUps:{abandonedMatchUps:p,completedMatchUps:m,upcomingMatchUps:f,pendingMatchUps:h}}}),c=vg({event:r});return Object.assign(a,{drawsData:s,publish:c}),a})}}}n(tb,{bulkUpdatePublishedEventIds:()=>rb,getAllEventData:()=>ib,getCourtInfo:()=>Mf,getDrawData:()=>Xv,getEventData:()=>Zv,getEventPublishStatus:()=>vg,getPublishState:()=>wg,getTournamentPublishStatus:()=>Sg,getVenueData:()=>Rf});var nb={};function ab({matchUpPotentialParticipantIds:e,matchUpNotBeforeTimes:t,timeAfterRecovery:r,matchUp:i}){let{individualParticipantIds:n}=kl(i);r=r??i.schedule?.timeAfterRecovery;let a=t=>{e[t]||(e[t]=[]),e[t]=L(e[t].concat(...n))},o=e=>{r&&(!t[e]||r>t[e])&&(t[e]=r)},s=i.winnerTo?.matchUpId||i.winnerMatchUpId;s&&(r&&o(s),a(s));let c=i.loserTo?.matchUpId||i.loserMatchUpId;c&&(r&&o(c),a(c)),i.sidesTo?.length&&i.sidesTo.forEach(({matchUpId:e})=>{e&&(r&&o(e),a(e))})}function ob(e){let t=$c(e,[{[vc]:!0}]);if(t.error)return t;let{matchUpPotentialParticipantIds:r,dateScheduledMatchUpIds:i=[],scheduleCompletedMatchUps:n,matchUpNotBeforeTimes:a,matchUpScheduleTimes:o,orderedMatchUpIds:s,clearDate:c,matchUps:u}=e,d=o?Object.keys(o):[],l=(s??[]).map(e=>u.find(t=>t.matchUpId===e)).filter(Boolean).filter(e=>{let t=!c&&(i.includes(e.matchUpId)||d.includes(e.matchUpId)),r=["BYE",Sd,Id,fd,Dd,Rd,yd,vd].includes(e?.matchUpStatus);return n||!t&&!e.winningSide&&!r}),p=r&&a?l.reduce((e,t)=>{let{drawId:i,tournamentId:n}=t;return e.matchUpMap[n]||(e.matchUpMap[n]={}),e.matchUpMap[n][i]?e.matchUpMap[n][i].push(t):e.matchUpMap[n][i]=[t],ab({matchUpPotentialParticipantIds:r,matchUpNotBeforeTimes:a,matchUp:t}),e},{matchUpMap:{}}).matchUpMap:{};return{matchUpsToSchedule:l,matchUpMap:p}}function sb({defaultRecoveryMinutes:e=0,defaultAverageMinutes:t,tournamentRecords:r,matchUpFormat:i,categoryName:n,categoryType:a,tournamentId:o,eventType:s,eventId:c}){if(!ta({matchUpFormat:i}))return{error:Ut};let u;return Object.keys(r).filter(e=>!o||e===o).forEach(e=>{if(u)return;let t=r[e],o=c?Af({tournamentRecord:t,eventId:c})?.event:void 0;return u=uf({tournamentRecord:t,matchUpFormat:i,categoryName:n,categoryType:a,eventType:s,event:o}),u?.averageMinutes||u?.recoveryMinutes}),{recoveryMinutes:u?.recoveryMinutes||e,averageMinutes:u?.averageMinutes||t,typeChangeRecoveryMinutes:u?.typeChangeRecoveryMinutes||u?.recoveryMinutes||e}}function cb(e){let t=$c(e,[{[Lc]:{tournamentRecords:!1,tournamentRecord:!1}},{rounds:!0,[_c]:Oc}]);if(t.error)return t;let{scheduleCompletedMatchUps:r,periodLength:i=30}=e,n=e.tournamentRecords||e.tournamentRecord&&{[e.tournamentRecord.tournamentId]:e.tournamentRecord}||{};if("object"!=typeof n)return{error:ge};let a={},o=[],s=[],c=e.rounds.toSorted((e,t)=>(e.sortOrder??0)-(t.sortOrder??0)),u=e.containedStructureIds??Object.assign({},...Object.values(n).map(e=>Ol({tournamentRecord:e}).containedStructures)),d=e.matchUps??Zf({nextMatchUps:!0,tournamentRecords:n}).matchUps,l=0,p={},m={},f={};return{scheduledRoundsDetails:c.flatMap(e=>{let t=e.periodLength||i,c=[];u?.[e.structureId]?c.push(...u[e.structureId]):c.push(e.structureId);let h=d?Lf({tournamentIds:[e.tournamentId],roundNumbers:[e.roundNumber],matchUpIds:e.matchUpIds,eventIds:[e.eventId],drawIds:[e.drawId],processContext:!0,structureIds:c,matchUps:d}).sort(eh):[],{segmentNumber:g,segmentsCount:I}=e.roundSegment||{};if(F(g)&&M(h?.length)&&M(I)&&g>0&&g<=I&&I<h?.length&&!e.matchUpIds?.length){let e=h.length/I,t=e*(g-1);h=h.slice(t,t+e)}let U=n[e.tournamentId],S=Af({drawId:e.drawId,tournamentRecord:U}).event,v=[];for(let r of h){let e=r.matchUpFormat;e&&(a[e]||(a[e]=[],a[e].push(r)),v.push(e))}for(let i of v){let{eventType:a,category:c}=S??{},{categoryName:u,ageCategoryCode:d}=c??{},{typeChangeRecoveryMinutes:g,recoveryMinutes:I,averageMinutes:U,error:v}=sb({categoryName:u??d,categoryType:c?.categoryType,tournamentId:e.tournamentId,eventId:e.eventId,tournamentRecords:n,matchUpFormat:i,eventType:a});if(v)return{error:v,round:e};let y=h.filter(e=>(r||!kd.includes(e.matchUpStatus))&&"BYE"!==e.matchUpStatus).map(ld);y.forEach(e=>{f[e]={typeChangeRecoveryMinutes:g,recoveryMinutes:I,averageMinutes:U},p[e]=I,m[e]=U}),s.push(...y),l=Math.max(U||0,l);let w=`${U}|${t}`;return o.includes(w)||o.push(w),{roundPeriodLength:t,recoveryMinutes:I,averageMinutes:U,matchUpIds:y,hash:w}}}),greatestAverageMinutes:l,matchUpFormatCohorts:a,recoveryMinutesMap:p,averageMinutesMap:m,orderedMatchUpIds:s,minutesMap:f,...ce}}function ub({schedulingProfile:e,venueIds:t,eventIds:r,drawIds:i}){let n=[],a=e?.map(e=>{let a=ya(e?.scheduleDate);if(!a)return void n.push(`Invalid date: ${e?.scheduledDate}`);let o=(e?.venues||[]).map(e=>{let{rounds:a,venueId:o}=e;if(!t?.includes(o))return void n.push(`Missing venueId: ${o}`);let s=a.filter(e=>{let t=r.includes(e.eventId)&&i.includes(e.drawId);return t||n.push(`Invalid eventId: ${e.eventId} or drawId: ${e.drawId}`),t});return s.length?{venueId:o,rounds:s}:void 0}).filter(Boolean);return o.length&&a&&{...e,venues:o}}).filter(Boolean);return{updatedSchedulingProfile:a,modifications:n.length,issues:n}}function db({tournamentRecords:e,schedulingProfile:t}){if(!t)return{valid:!0};if(!Array.isArray(t))return{valid:!1,error:gi};let r,i,{venueIds:n,tournamentsMap:a}=function(e){let t=e?.tournamentRecords&&Object.values(e?.tournamentRecords)||[],r={},{venueIds:i,eventIds:n,drawIds:a,structureIds:o,tournamentIds:s}=t.reduce((e,t)=>{let{tournamentIds:i,tournamentMap:n,structureIds:a,venueIds:o,eventIds:s,drawIds:c}=function(e){let{tournamentRecord:t={},tournamentMap:r={},requireCourts:i}=e,n=[],a=[],o=[],s=[],c=(t?.venues||[]).map(({venueId:e,courts:t})=>(!i||t?.length)&&e),u=t?.tournamentId;if(u){n.push(u),r[u]={};let e=t?.events||[];for(let t of e){let e=t.eventId;o.push(e),r[u][e]={};let i=e=>parseInt(e);for(let n of t.drawDefinitions||[]){let t=n.drawId;s.push(t),r[u][e][t]={};let{structures:o}=Gd({drawDefinition:n});for(let n of o||[]){let o=n.structureId,{matchUps:s}=Bf({structure:n}),{roundMatchUps:c}=em({matchUps:s}),d=c&&Object.keys(c).map(i);if(r[u][e][t][o]=d,a.push(o),n.structures?.length)for(let i of n.structures)a.push(i.structureId),r[u][e][t][i.structureId]=d}}}}return{tournamentMap:r,tournamentIds:n,structureIds:a,venueIds:c,eventIds:o,drawIds:s}}({tournamentRecord:t});return o.forEach(t=>{e.venueIds.includes(t)||e.venueIds.push(t)}),e.tournamentIds.push(...i),e.structureIds.push(...a),e.eventIds.push(...s),e.drawIds.push(...c),Object.assign(r,n),e},{tournamentIds:[],structureIds:[],venueIds:[],eventIds:[],drawIds:[]});return{tournamentsMap:r,tournamentIds:s,structureIds:o,venueIds:i,eventIds:n,drawIds:a}}({tournamentRecords:e}),o=t.every(e=>{let{scheduleDate:t,venues:o}=e;return!!ua(t)&&o.every(e=>{let{venueId:t,rounds:o}=e;return"string"!=typeof t?(i="venueId should be a string",!1):Array.isArray(o)?n.includes(t)?!!o.every(e=>{if(!e)return i="empty round",!1;let{roundSegment:t,tournamentId:r,structureId:n,roundNumber:o,eventId:s,drawId:c}=e,u=a?.[r]?.[s]?.[c]?.[n]?.includes(o);u||(i="Invalid rounds");let{segmentNumber:d,segmentsCount:l}=t||{},p=!t||F(d)&&M(l)&&d<=l;return p||(i="Invalid segment"),u&&p}):(r=Yr,!1):(i="rounds should be an array",!1)})});return!o&&!r&&(r=gi),{valid:!!o,error:r,info:i}}function lb({tournamentRecords:e,tournamentRecord:t}){if("object"!=typeof e||!Object.keys(e).length)return{error:ge};let{extension:r}=Ru({element:t,name:zu,tournamentRecords:e,discover:!0}),i=r?.value||[];if(i.length){let{venueIds:r}=$v({requireCourts:!0,tournamentRecords:e}),{eventIds:n,drawIds:a}=av({tournamentRecords:e}),{updatedSchedulingProfile:o,modifications:s,issues:c}=ub({schedulingProfile:i,venueIds:r,eventIds:n,drawIds:a});if(s){i=o;let r=pb({tournamentRecords:e,tournamentRecord:t,schedulingProfile:i});return r.error?r:{schedulingProfile:i,modifications:s,issues:c}}}return{schedulingProfile:i,modifications:0}}function pb({tournamentRecords:e,tournamentRecord:t,schedulingProfile:r}){let i=db({tournamentRecords:e,schedulingProfile:r});return i.error?i:r?Uu({tournamentRecords:e,discover:!0,extension:{name:zu,value:r}}):gu({element:t,name:zu,tournamentRecords:e,discover:!0})}function mb(e){let{tournamentRecord:t}=e,r=e.tournamentRecords||t&&{[t.tournamentId]:t}||{};if(!e.schedulingProfile){let{modifications:e,issues:i}=lb({tournamentRecords:r,tournamentRecord:t});return{success:!e,modifications:e,issues:i}}let{venueIds:i}=$v({tournamentRecords:r}),{eventIds:n,drawIds:a}=av({tournamentRecords:r}),{updatedSchedulingProfile:o,modifications:s,issues:c}=ub({schedulingProfile:e.schedulingProfile,venueIds:i,eventIds:n,drawIds:a});return s?{...pb({schedulingProfile:o,tournamentRecords:r}),modifications:s,issues:c}:{...ce,modifications:s,issues:c}}function fb(e){let{scheduleDates:t=[],tournamentRecords:r,periodLength:i=30}=e??{};if("object"!=typeof r)return{error:Ue};if(!Array.isArray(t))return{error:gi};if(!t.every(ua))return{error:Jt};let n=[],a=0,o={},{schedulingProfile:s}=lb({tournamentRecords:r});if(!s)return{issues:n,...ce};let{matchUps:c}=Zf({nextMatchUps:!0,tournamentRecords:r});for(let u of s){let{scheduleDate:e,venues:s=[]}=u;if(!t?.length||t.includes(e))for(let t of s||[])if(t){let{rounds:s}=t,u=[],{orderedMatchUpIds:d,scheduledRoundsDetails:l}=cb({tournamentRecords:r,periodLength:i,matchUps:c,rounds:s}),{matchUpDependencies:p}=sh({tournamentRecords:r,matchUps:c}),m=e=>{let t;return l?.find((r,i)=>{let n=r.matchUpIds.includes(e);return n&&(t=i),n}),t};if(d?.forEach((e,t)=>{let r=Q(d.slice(t+1),p?.[e]?.matchUpIds||[]);r.length&&u.push({matchUpId:e,shouldBeAfter:r})}),u.length){a+=u.length;let t=u.map(({matchUpId:t,shouldBeAfter:r})=>{let i=m(t),n=L(r.map(m));return o[e]||(o[e]={}),o[e][i]||(o[e][i]=[]),n.forEach(t=>{o[e][i].includes(t)||o[e][i].push(t)}),{matchUpId:t,matchUpRoundIndex:i,earlierRoundIndices:n,shouldBeAfter:r}});n.push(...t)}}}return{issuesCount:a,profileIssues:{matchUpIdShouldBeAfter:Object.assign({},...n.map(e=>{let{matchUpId:t,shouldBeAfter:r,earlierRoundIndices:i}=e;return{[t]:{earlierRoundIndices:i,shouldBeAfter:r}}}))},roundIndexShouldBeAfter:o,...ce}}function hb(e){let{tournamentRecords:t,requestType:r}=e,i=$c(e,[{[zs]:!0}]);if(i.error)return i;let n={};for(let a of Object.values(t)){let{extension:e}=Ru({element:a,name:$u}),t=e?.value||[];for(let i of t){let{personId:e,requests:t}=i||{};n[e]||(n[e]=[]);for(let i of t)r&&i.requestType!==r||n[e].push(i)}}return{personRequests:n,...ce}}function gb(e){let{containerStructureId:t,roundSegment:r,isRoundRobin:i,tournamentId:n,roundNumber:a,structureId:o,eventId:s,drawId:c}=e,u=i?t:o,d=[n,s,c,u,a].join("|");return wn({structureId:u,roundSegment:r,tournamentId:n,roundNumber:a,eventId:s,drawId:c,id:d})}function Ib({round:e,matchUps:t,events:r,tournamentRecords:i}){let n=r.find(t=>t.eventId===e.eventId),{eventType:a,category:o,categoryType:s}=n||{},{categoryName:c,ageCategoryCode:u}=o||{},d=j(t.map(({matchUpFormat:e})=>e)),l=0;return Object.keys(d).forEach(t=>{let r=d[t],n=sb({categoryName:c||u,tournamentId:e.tournamentId,eventId:e.eventId,tournamentRecords:i,matchUpFormat:t,categoryType:s,eventType:a});if(n.error)return n;let o=n.averageMinutes*r;isNaN(l)||(l+=o)}),{roundMinutes:l}}function Ub(e){let t=e.length,r=e.filter(({sides:e})=>e?.some(({bye:e})=>e)).length||0,i=e.filter(({winningSide:e,matchUpStatus:t})=>e||kd.includes(t)).length||0,n=e.filter(({schedule:e,matchUpStatus:t})=>e?.scheduledDate&&e?.scheduledTime&&"BYE"!==t).length||0,a=t-r;return{unscheduledCount:a-n,incompleteCount:a-n,scheduledCount:n,completedCount:i,matchUpsCount:t,isScheduled:a===n,isComplete:a===i,byeCount:r}}function Sb({tournamentRecords:e,schedulingProfile:t,tournamentRecord:r,withRoundId:i}){if(r&&!e){if("object"!=typeof r)return{error:Ue};e={[r.tournamentId]:r}}if(t){let r=db({tournamentRecords:e,schedulingProfile:t});if(r.error)return r}if(!t&&e){let r=lb({tournamentRecords:e});if(r.error)return r;t=r.schedulingProfile}if(!t)return{error:wi};let n={};return{profileRounds:t.map(({venues:e,scheduleDate:t})=>e.map(({rounds:e})=>e.map(e=>{let r=gb(e);return r.roundSegment?.segmentsCount&&(n[r.id]=r.roundSegment.segmentsCount),wn({id:i?r.id:void 0,scheduleDate:t,...r})}))).flat(1/0),segmentedRounds:n}}function vb({court:e,date:t}){let r=t&&e.dateAvailability?.find(e=>Ca(e.date,t)),i=e.dateAvailability?.find(e=>!e.date);return r||i}function yb({courtPrefix:e="C|",minRowsCount:t,courtsData:r,scheduledDate:i}){if(!Array.isArray(r))return{error:gi};let n=r?.reduce((e,t)=>{let r=t.matchUps||[],i=Math.max(0,...r.map(e=>e.schedule.courtOrder||0));return Math.max(i,e)},1),a=K(0,Math.max(t||0,n)).map(e=>({matchUps:K(0,r.length).map(t=>{let n=r[t],{courtId:a,venueId:o}=n;if(i){let{gridBookings:t}=function({court:e,date:t}){let r=vb({court:e,date:t}),i=new Map,n=[];return(r?.bookings||[]).forEach(e=>{if("number"==typeof e.courtOrder){let t=e.rowCount||1;for(let r=0;r<t;r++)i.set(e.courtOrder+r,e)}else n.push(e)}),{gridBookings:i,timeBookings:n}}({court:n,date:i});if(t.has(e+1)){let r=t.get(e+1);return{schedule:{courtOrder:e+1,venueId:o,courtId:a},isBlocked:!0,booking:r}}}return{schedule:{courtOrder:e+1,venueId:o,courtId:a}}})}));return r.forEach((e,t)=>{for(let r of e.matchUps){let e=r.schedule?.courtOrder;e&&(a[e-1].matchUps[t]=r)}}),{courtPrefix:e,rows:a.map((t,r)=>Object.assign({rowId:`rowId-${r+1}`},...t.matchUps.map((t,r)=>({[`${e}${r}`]:t}))))}}n(nb,{courtGridRows:()=>yb,findVenue:()=>Pf,getMatchUpsToSchedule:()=>ob,getPersonRequests:()=>hb,getProfileRounds:()=>Sb,getScheduledRoundsDetails:()=>cb,getSchedulingProfile:()=>lb,getSchedulingProfileIssues:()=>fb,publicFindCourt:()=>bf});var wb={};function Pb({policyDefinitions:e,drawDefinition:t,drawSize:r,drawId:i,event:n,stage:a}){if(!n)return{error:ot};let{entries:o,stageEntries:s}=cI({drawDefinition:t,drawId:i,stage:a,event:n}),c=s.length,{drawSize:u}=Gy({participantsCount:c}),d=jy({drawSize:r??u,participantsCount:c,policyDefinitions:e});if(d.error)return Pn({result:d,stack:"getEntriesAndSeedsCount"});let{seedsCount:l}=d;return{entries:o,seedsCount:l,stageEntries:s}}function Tb(e){let{entries:t=[],entryStatus:r,stage:i}=e;return Math.max(...t.filter(e=>!(i&&i!==e.entryStage||r&&e.entryStatus!==r||isNaN(e.entryPosition))).map(({entryPosition:e})=>I(e||0)),0)}n(wb,{getEntriesAndSeedsCount:()=>Pb,getMaxEntryPosition:()=>Tb});var Db={};function bb({tournamentRecords:e,extensionName:t}){if("object"!=typeof e||!Object.keys(e).length)return{error:ge};let r,i=[];for(let n of Object.values(e)){let{extension:e}=Ru({element:n,name:t});e&&!r&&(i.push({params:{extension:e,discover:!0},method:"addExtension"}),r=!0);let a=n.events??[];for(let r of a){let{eventId:e}=r,{extension:n}=Ru({name:t,element:r});n&&i.push({params:{eventId:e,extension:n},method:"addEventExtension"})}}return{methods:i}}function Mb({tournamentRecords:e}){return bb({extensionName:Yu,tournamentRecords:e})}n(Db,{allCompetitionMatchUps:()=>Zf,allDrawMatchUps:()=>th,allEventMatchUps:()=>Qf,allTournamentMatchUps:()=>Xf,analyzeMatchUp:()=>nM,calculateWinCriteria:()=>zb,checkMatchUpIsComplete:()=>Vf,competitionScheduleMatchUps:()=>jb,drawMatchUps:()=>aM,eventMatchUps:()=>Bb,filterMatchUps:()=>Lf,getAllDrawMatchUps:()=>Kf,getAllStructureMatchUps:()=>Bf,getCheckedInParticipantIds:()=>qm,getCompetitionMatchUps:()=>Gb,getEventMatchUpFormatTiming:()=>Ob,getHomeParticipantId:()=>Kb,getMatchUpCompetitiveProfile:()=>mm,getMatchUpContextIds:()=>Jb,getMatchUpDailyLimits:()=>$b,getMatchUpDailyLimitsUpdate:()=>Fb,getMatchUpDependencies:()=>sh,getMatchUpFormat:()=>Zb,getMatchUpFormatTiming:()=>uf,getMatchUpFormatTimingUpdate:()=>Mb,getMatchUpScheduleDetails:()=>Ef,getMatchUpType:()=>Ff,getMatchUpsStats:()=>eM,getModifiedMatchUpFormatTiming:()=>kb,getParticipantResults:()=>Zh,getPredictiveAccuracy:()=>qb,getRoundMatchUps:()=>em,getRounds:()=>iM,isValidMatchUpFormat:()=>ta,matchUpActions:()=>Ey,participantScheduledMatchUps:()=>_b,tallyParticipantResults:()=>fg,tournamentMatchUps:()=>Vb,validMatchUp:()=>Xp,validMatchUps:()=>Zp});var Rb="ADULT",Nb="JUNIOR",Ab="WHEELCHAIR",Eb={[cu]:{allowModificationWhenMatchUpsScheduled:{courts:!1,venues:!1},defaultTimes:{averageTimes:[{categoryNames:[],minutes:{default:90}}],recoveryTimes:[{minutes:{[l]:30,default:60}}]},defaultDailyLimits:{[u]:2,[l]:2,total:3},matchUpAverageTimes:[{matchUpFormatCodes:[ao],averageTimes:[{categoryNames:[],minutes:{default:90}},{categoryTypes:[Ab],minutes:{default:120}}]},{matchUpFormatCodes:["SET3-S:6/TB7-F:TB10"],averageTimes:[{categoryNames:[],minutes:{default:85}}]},{matchUpFormatCodes:["SET3-S:6/TB7-F:TB7"],averageTimes:[{categoryNames:[],minutes:{default:70}}]},{matchUpFormatCodes:["SET3-S:4NOAD-F:TB7"],averageTimes:[{categoryNames:[],minutes:{default:55}}]},{matchUpFormatCodes:["SET3-S:4/TB7"],averageTimes:[{categoryNames:[],minutes:{default:60}}]},{matchUpFormatCodes:["SET3-S:4/TB7-F:TB7"],averageTimes:[{categoryNames:[],minutes:{default:50}}]},{matchUpFormatCodes:["SET3-S:4/TB7-F:TB10"],averageTimes:[{categoryNames:[],minutes:{default:55}}]},{matchUpFormatCodes:["SET3-S:4/TB5@3"],averageTimes:[{categoryNames:[],minutes:{default:45}}]},{matchUpFormatCodes:["SET1-S:8/TB7","SET1-S:8/TB7@7"],averageTimes:[{categoryNames:[],minutes:{default:40}}]},{matchUpFormatCodes:["SET1-S:5/TB9@4"],averageTimes:[{categoryNames:[],minutes:{default:30}}]},{matchUpFormatCodes:["SET1-S:6/TB7"],averageTimes:[{categoryNames:[],minutes:{default:30}}]},{matchUpFormatCodes:["SET1-S:6NOAD"],averageTimes:[{categoryNames:[],minutes:{default:30}}]},{matchUpFormatCodes:["SET1-S:4/TB7","SET1-S:4/TB5@3","SET3-S:TB10","SET1-S:T20"],averageTimes:[{categoryNames:[],minutes:{default:20}}]},{matchUpFormatCodes:["SET1-S:4NOAD"],averageTimes:[{categoryNames:[],minutes:{default:20}}]},{matchUpFormatCodes:["SET1-S:TB10"],averageTimes:[{categoryNames:[],minutes:{default:10}}]}],matchUpRecoveryTimes:[{matchUpFormatCodes:["SET3-S:6/TB7","SET3-S:6/TB7-F:TB10","SET3-S:6/TB7-F:TB7"],recoveryTimes:[{categoryTypes:[Rb,Ab],minutes:{default:60,[l]:30}},{categoryTypes:[Nb],minutes:{default:60,[l]:60}}]},{matchUpFormatCodes:["SET3-S:4/TB7-F:TB7","SET3-S:4/TB7-F:TB10","SET3-S:4NOAD-F:TB7","SET3-S:4/TB7","SET3-S:4/TB5@3"],recoveryTimes:[{categoryTypes:[Rb,Ab],minutes:{default:30}},{categoryTypes:[Nb],minutes:{default:60}}]},{matchUpFormatCodes:["SET1-S:8/TB7","SET1-S:8/TB7@7","SET1-S:5/TB9@4","SET1-S:6/TB7","SET1-S:6NOAD","SET1-S:4/TB7","SET1-S:4NOAD","SET3-S:TB10","SET1-S:T20"],recoveryTimes:[{categoryNames:[],minutes:{default:30}}]},{matchUpFormatCodes:["SET1-S:4/TB5@3"],recoveryTimes:[{categoryTypes:[Rb,Nb],minutes:{default:30}},{categoryTypes:[Ab],minutes:{default:15}}]},{matchUpFormatCodes:["SET1-S:TB10"],recoveryTimes:[{categoryNames:[],minutes:{default:15}}]}],matchUpDailyLimits:[]}},Cb=Eb;function Ob({tournamentRecord:e,matchUpFormats:t,categoryType:r,event:i}){if(!i)return{error:ot};let n,a;if(t?.length){let e=[];n=t.map(t=>{let r="string"==typeof t?{matchUpFormat:t}:t;if(!e.includes(r?.matchUpFormat)&&ta({matchUpFormat:r?.matchUpFormat}))return e.push(r.matchUpFormat),r}).filter(Boolean)}else{let{policy:t}=Sp({policyType:du,tournamentRecord:e,event:i});if(t?.matchUpFormats)n=t?.matchUpFormats;else{let e,t,{extension:r}=Ru({name:Yu,element:i});({matchUpAverageTimes:e,matchUpRecoveryTimes:t}=r?.value?r.value:Cb[cu]),n=L([...(e||[]).map(e=>e.matchUpFormatCodes),...(t||[]).map(e=>e.matchUpFormatCodes)].flat()).map(e=>({matchUpFormat:e})),a="default scheduling policy in use"}}let{eventType:o,eventId:s,category:c}=i,u=c?.categoryName??c?.ageCategoryCode??s;return s?wn({eventMatchUpFormatTiming:n.map(({matchUpFormat:t,description:n})=>({matchUpFormat:t,description:n,...uf({tournamentRecord:e,matchUpFormat:t,categoryName:u,categoryType:r,eventType:o,event:i})})),info:a}):{error:ot}}function kb(e){let t=$c(e,[{[Js]:!0},{[kc]:e=>ta({matchUpFormat:e}),[xc]:Ut,[ec]:!0}]);if(t.error)return t;let{tournamentRecord:r,matchUpFormat:i,event:n}=e,{extension:a}=Ru({name:Yu,element:n}),o=a?.value,{extension:s}=Ru({element:r,name:Yu}),c=s?.value,u=[o?.matchUpAverageTimes&&Hm({...o,matchUpFormat:i}),c?.matchUpAverageTimes&&Hm({...c,matchUpFormat:i})].find(e=>e);return{matchUpFormat:i,recoveryTimes:[o?.matchUpRecoveryTimes&&Ym({...o,matchUpFormat:i}),c?.matchUpRecoveryTimes&&Ym({...c,matchUpFormat:i})].find(e=>e),averageTimes:u}}function Fb({tournamentRecords:e}){return bb({extensionName:Hu,tournamentRecords:e})}var xb=({scheduleAttributes:e=["scheduledDate","scheduledTime"],schedule:t={}})=>!!Object.keys(t).filter(t=>e.includes(t)).filter(e=>t[e]).length;function _b({scheduleAttributes:e=["scheduledDate","scheduledTime"],matchUps:t=[]}){if(!Zp(t))return{error:At};if(!Array.isArray(e))return{error:gi};let r=t.filter(Boolean).filter(({schedule:t})=>xb({schedule:t,scheduleAttributes:e})).reduce((e,t)=>{let{schedule:r}=t,i=ya(r?.scheduledDate),n=va(r?.scheduledTime);return i&&n&&(e[i]?e[i].push(t):e[i]=[t]),e},{});return Object.keys(r).forEach(e=>{r[e].sort((e,t)=>Da(va(e.schedule?.scheduledTime),va(t.schedule?.scheduledTime)))}),{...ce,scheduledMatchUps:r}}function Lb({schedulingProfile:e,matchUps:t=[]}){let r={},i=({eventId:e,drawId:t,structureId:r,roundNumber:i})=>`${e}|${t}|${r}${i}`;e?.length&&e.flatMap(({venues:e})=>e.map(({rounds:e})=>e)).forEach(e=>{e.sort((e,t)=>(e.sortOrder||0)-(t.sortOrder||0)).forEach(({eventId:e,drawId:t,structureId:n,roundNumber:a},o)=>{let s=i({eventId:e,drawId:t,structureId:n,roundNumber:a});r[s]=o})});let n=[],a={noScheduledDate:[]};for(let s of t){let e=s.schedule||{},t=e.scheduledDate&&ya(e.scheduledDate)||e.scheduledTime&&ya(e.scheduledTime)||"noScheduledDate";a[t]||(a[t]=[]),a[t].push(s)}let o=Object.keys(a).sort((e,t)=>e.localeCompare(t));for(let s of o){let e=a[s],t={noScheduledTime:[]};for(let r of e){let e=r.schedule||{},i=e.scheduledTime&&va(e.scheduledTime)||"noScheduledTime";t[i]||(t[i]=[]),t[i].push(r)}for(let r of Object.keys(t)){let e=t[r].sort((e,t)=>(e.roundNumber||0)-(t.roundNumber||0));t[r]=e}let o=Object.keys(t).sort((e,t)=>e.localeCompare(t));for(let a of o){let e=t[a];e.sort((e,t)=>(r[i(e)]||0)-(r[i(t)]||0)),n.push(...e)}}return n}function Bb(e){let{participants:t,contextContent:r,participantMap:i}=e,{tournamentAppliedPolicies:n,scheduleVisibilityFilters:a,participantsProfile:o,afterRecoveryTimes:s,policyDefinitions:c,useParticipantMap:u,tournamentRecord:d,usePublishState:l,contextFilters:p,matchUpFilters:m,contextProfile:f,nextMatchUps:h,tournamentId:g,inContext:I,context:U,event:S}=e;if(!S)return{error:ot};let v,{eventId:y,eventName:w,endDate:P,eventType:T,category:D,gender:b}=S??{},M={...U,...wn({surfaceCategory:S.surfaceCategory??d?.surfaceCategory,indoorOutDoor:S.indoorOutdoor??d?.indoorOutdoor,tournamentId:g??d?.tournamentId,endDate:P??d?.endDate,eventName:w,eventType:T,category:D,eventId:y,gender:b})};!t&&d&&({participants:t,participantMap:i,groupInfo:v}=cp({participantsProfile:o,policyDefinitions:c,useParticipantMap:u,tournamentRecord:d,contextProfile:f,inContext:I})),f&&!r&&(r=Up({policyDefinitions:c,tournamentRecord:d,contextProfile:f,event:S}));let R=vg({event:S});return{...(S.drawDefinitions??[]).reduce((u,g)=>{let U=Jf({hydrateParticipants:e.hydrateParticipants,context:M,tournamentAppliedPolicies:n,scheduleVisibilityFilters:a,tournamentParticipants:t,participantsProfile:o,afterRecoveryTimes:s,policyDefinitions:c,tournamentRecord:d,usePublishState:l,contextContent:r,contextFilters:p,matchUpFilters:m,participantMap:i,publishStatus:R,contextProfile:f,drawDefinition:g,nextMatchUps:h,inContext:I,event:S});return Object.keys(U)?.forEach(e=>{Array.isArray(U[e])&&(u[e]||(u[e]=[]),u[e]=u[e].concat(U[e]))}),u},{}),...ce,groupInfo:v}}function Vb(e){if(!e?.tournamentRecord)return{error:Ie};let t=e.contextContent,{scheduleVisibilityFilters:r,participantsProfile:i,afterRecoveryTimes:n,policyDefinitions:a,tournamentRecord:o,inContext:s=!0,usePublishState:c,contextFilters:u,matchUpFilters:d,contextProfile:l,nextMatchUps:p,context:m}=e,f=e.tournamentId??o.tournamentId,h=o?.events??[],{participants:g,participantMap:I,groupInfo:U}=cp({participantsProfile:i,policyDefinitions:a,tournamentRecord:o,contextProfile:l,inContext:s});l&&!t&&(t=Up({policyDefinitions:a,tournamentRecord:o,contextProfile:l}));let{appliedPolicies:S}=up({tournamentRecord:o}),v=u?.eventIds??[];return{...h.filter(e=>!v.includes(e.eventId)).map(h=>{let U={eventDrawsCount:Nf({event:h}).flightProfile?.flights?.length||h.drawDefinitions?.length||0,...m};return Bb({hydrateParticipants:e.hydrateParticipants,context:U,tournamentAppliedPolicies:S,scheduleVisibilityFilters:r,participantsProfile:i,afterRecoveryTimes:n,policyDefinitions:a,tournamentRecord:o,usePublishState:c,contextFilters:u,contextProfile:l,contextContent:t,matchUpFilters:d,participantMap:I,participants:g,tournamentId:f,nextMatchUps:p,inContext:s,event:h})}).reduce((e,t)=>((t&&Object.keys(t).filter(e=>!["success","matchUpsMap"].includes(e)))?.forEach(r=>{Array.isArray(t[r])&&(e[r]||(e[r]=[]),e[r]=e[r].concat(t[r]),void 0!==e.matchUpsCount?e.matchUpsCount+=t[r].length:e.matchUpsCount=t[r].length)}),e),{matchUpsCount:0}),groupInfo:U,participants:g}}function Gb({scheduleVisibilityFilters:e,hydrateParticipants:t,participantsProfile:r,tournamentRecords:i,useParticipantMap:n,policyDefinitions:a,usePublishState:o,matchUpFilters:s,contextFilters:c,nextMatchUps:u,inContext:d}){if("object"!=typeof i||!Object.keys(i).length)return{error:ge};let l=Object.keys(i).map(l=>{let p=i[l];return Vb({scheduleVisibilityFilters:e,hydrateParticipants:t,participantsProfile:r,useParticipantMap:n,policyDefinitions:a,tournamentRecord:p,usePublishState:o,matchUpFilters:s,contextFilters:c,nextMatchUps:u,inContext:d})}),p={},m={};return{...l.reduce((e,t)=>(Object.keys(t).forEach(r=>{if("groupInfo"===r)Object.assign(m,t[r]);else if("participants"===r)for(let e of t[r]??[])p[e.participantId]=e;else Array.isArray(t[r])&&(e[r]||(e[r]=[]),e[r]=e[r].concat(t[r]))}),e),{}),groupInfo:m,mappedParticipants:p}}function jb(e){if("object"!=typeof e?.tournamentRecords||!Object.keys(e?.tournamentRecords).length)return{error:ge};let t,r,{courts:i,venues:n}=jv(e),a=lb(e).schedulingProfile,{sortDateMatchUps:o=!0,courtCompletedMatchUps:s,alwaysReturnCompleted:c,activeTournamentId:u,tournamentRecords:d,withCourtGridRows:l,minCourtGridRows:p,usePublishState:m,status:f=Gm,sortCourtsData:h}=e,g=u??ln()??Object.keys(d)[0],I=m?Sg({tournamentRecord:d[g],status:f}):void 0,U=c?Gb({...e,matchUpFilters:{...e.matchUpFilters,matchUpStatuses:[Id]},contextFilters:e.contextFilters}).completedMatchUps:[];if(m&&!I?.orderOfPlay?.published)return{completedMatchUps:U,dateMatchUps:[],courtsData:[],venues:n};m&&({drawIds:t,detailsMap:r}=function({tournamentRecords:e}){let t={},r=[];for(let i of Object.values(e))for(let e of i.events??[]){let i=vg({event:e}),n=i?.drawDetails;v(n)?(Object.assign(t,n),r.push(...Object.keys(n).filter(e=>yg({drawId:e,drawDetails:n})))):i?.drawIds?.length&&r.push(...i.drawIds)}return{drawIds:r,detailsMap:t}}({tournamentRecords:d})),t?.length&&(e.contextFilters??={},e.contextFilters.drawIds?e.contextFilters.drawIds=e.contextFilters.drawIds.filter(e=>t.includes(e)):e.contextFilters.drawIds=t),I?.eventIds?.length&&(e.matchUpFilters??={},e.matchUpFilters?.eventIds&&e.matchUpFilters.eventIds.length?e.matchUpFilters.eventIds=e.matchUpFilters.eventIds.filter(e=>I.eventIds.includes(e)):e.matchUpFilters.eventIds=I.eventIds),I?.scheduledDates?.length&&(e.matchUpFilters??={},e.matchUpFilters.scheduledDates&&e.matchUpFilters.scheduledDates.length?e.matchUpFilters.scheduledDates=e.matchUpFilters.scheduledDates.filter(e=>I.scheduledDates.includes(e)):e.matchUpFilters.scheduledDates=I.scheduledDates),c&&(e.matchUpFilters??={},e.matchUpFilters?.excludeMatchUpStatuses?.length?e.matchUpFilters.excludeMatchUpStatuses.includes(Id)||e.matchUpFilters.excludeMatchUpStatuses.push(Id):e.matchUpFilters.excludeMatchUpStatuses=[Id]);let{completedMatchUps:S,upcomingMatchUps:y,pendingMatchUps:w,abandonedMatchUps:P,groupInfo:T,mappedParticipants:D}=Gb({...e,matchUpFilters:e.matchUpFilters,contextFilters:e.contextFilters}),b=[...y??[],...w??[]];r&&(!t?.length||Object.keys(r).length)&&(b=b.filter(e=>{let{drawId:t,structureId:i,stage:n}=e;if(!r?.[t]?.publishingDetail?.published)return!1;let a=Object.keys(r[t].stageDetails??{});if(a.length){let e=a.filter(e=>!r[t].stageDetails[e].published),i=a.filter(e=>r[t].stageDetails[e].published);return(!e.length||!e.includes(n))&&(!(!i.length||!i.includes(n))||e.length&&!e.includes(n)&&!i.length)}let o=Object.keys(r[t].structureDetails??{});if(o.length){let e=o.filter(e=>!r[t].structureDetails[e].published),n=o.filter(e=>r[t].structureDetails[e].published);return(!e.length||!e.includes(i))&&(!(!n.length||!n.includes(i))||e.length&&!e.includes(i)&&!n.length)}return!0}));let M=o?Lb({matchUps:b,schedulingProfile:a}):b,R=i?.map(e=>{let t=function({courtId:e}){let t=(s?M.concat(S??[],P??[]):M).filter(t=>t.schedule?.courtId===e||t.schedule?.allocatedCourts?.map(({courtId:e})=>e).includes(e));return h?Lb({matchUps:t,schedulingProfile:a}):t}(e);return{surfaceCategory:e?.surfaceCategory??"",matchUps:t,...e}}),N={completedMatchUps:c?U:S,mappedParticipants:e.hydrateParticipants?void 0:D,dateMatchUps:M,courtsData:R,groupInfo:T,venues:n};if(l){let t=e.matchUpFilters?.scheduledDate,{rows:r,courtPrefix:i}=yb({minRowsCount:Math.max(p||0,M.length||0),scheduledDate:t,courtsData:R});N.courtPrefix=i,N.rows=r}return{...N,...ce}}function $b({tournamentRecords:e,tournamentId:t}){if("object"!=typeof e||!Object.keys(e).length)return{error:ge};let r;return Object.keys(e).filter(e=>!t||e===t).forEach(t=>{let i=e[t],{matchUpDailyLimits:n}=function(e){let t=$c(e,[{[Js]:!0}]);if(t.error)return t;let{tournamentRecord:r}=e,{policy:i}=Sp({policyType:cu,tournamentRecord:r}),{extension:n}=Ru({element:r,name:Hu}),a=n?.value?.dailyLimits,o=i?.defaultDailyLimits;return{matchUpDailyLimits:a||o}}({tournamentRecord:i});r=n}),{matchUpDailyLimits:r}}function qb(e){let{matchUps:t}=e,{singlesForDoubles:r,tournamentRecord:i,drawDefinition:n,excludeMargin:a,exclusionRule:o,zoneDoubling:s,matchUpType:c,scaleName:d,eventId:p,zonePct:m,drawId:f,event:h}=e;if(!i&&!t)return{error:Ie};if(c&&![u,l].includes(c))return{error:gi,info:{matchUpType:c}};if(t&&!Zp(t))return{error:gi,context:{matchUps:t}};let g=qh[d],I=g?.ascending??e.ascending??!1,U=g?.accessor??e.valueAccessor,S=Array.isArray(g?.range)?Math.abs(g.range[0]-g.range[1]):0,v=F(m)&&S?(m??0)*S:e.zoneMargin??S,y={withScaleValues:!0,withCompetitiveness:!0},w={matchUpTypes:c?[c]:[u,l]},P=i?.participants;t?.[0]?.hasContext?f?t=t.filter(e=>e.drawId===f):p&&(t=t.filter(e=>e.eventId===p)):t??=f&&!n&&[]||!f&&p&&!h&&[]||f&&th({inContext:!0,drawDefinition:n,contextFilters:w,contextProfile:y,participants:P})?.matchUps||!f&&p&&Qf({inContext:!0,contextFilters:w,contextProfile:y,participants:P,event:h})?.matchUps||Xf({tournamentRecord:i,contextFilters:w,contextProfile:y})?.matchUps||[],c&&(t=t.filter(e=>e.matchUpType===c));let T=t.filter(({winningSide:e,score:t,sides:r,matchUpStatus:i})=>![Dd,Sd,Rd,Ud,fd].includes(i??"")&&ch({score:t})&&2===r?.length&&e),D=function({excludeMargin:e,exclusionRule:t,valueAccessor:r,ascending:i,scaleName:n,matchUps:a}){let o={affirmative:[],negative:[],excluded:[]};for(let u of a)Yb({matchUp:u,accuracy:o,excludeMargin:e,exclusionRule:t,valueAccessor:r,ascending:i,scaleName:n});let s=o.affirmative.length+o.negative.length,c=s&&o.affirmative.length/s*100;return o.percent=c?Math.round(100*c)/100:0,o}({matchUps:T,excludeMargin:a,exclusionRule:o,valueAccessor:U,ascending:I,scaleName:d}),b=!s||Wm(u)(c)?v:2*(v||0),M=v?T.map(({competitiveProfile:e,matchUpType:t,score:i,sides:n})=>{let a=Wb({singlesForDoubles:r,valueAccessor:U,matchUpType:t,scaleName:d,sides:n}),o=Math.abs(a[0].value-a[1].value);return{competitiveness:e?.competitiveness,valuesGap:o,score:i}}).filter(({valuesGap:e})=>e<=b):[],R=function({zoneData:e}){let t={[mp]:[],[fp]:[],[hp]:[]};for(let r of e){let{competitiveness:e,score:i,valuesGap:n}=r;t[e]&&t[e].push({score:i,valuesGap:n})}return t}({zoneData:M}),N=R&&Object.values(R).flat().length,A=N&&Object.assign({},...Object.keys(R).map(e=>({[e]:Math.round(1e4*R[e].length/N)/100}))),E=T.length-(M?.length||0);return{...ce,relevantMatchUps:T,zoneDistribution:A,zoneData:M,accuracy:D,nonZone:E}}function Wb({singlesForDoubles:e,exclusionRule:t,valueAccessor:r,matchUpType:i,scaleName:n,sides:a}){let o=t?.range.sort(),s=e=>{let r=e?.[t?.valueAccessor];return{exclude:t&&r>=o[0]&&r<=o[1],exclusionValue:r}};return a.sort((e,t)=>e.sideNumber-t.sideNumber).map(({participant:t})=>{let a=[],o=t?.individualParticipants;if(o?.length){let c=[],u=0;for(let t of o){let{scaleValue:o,value:d}=Hb({singlesForDoubles:e,valueAccessor:r,participant:t,matchUpType:i,scaleName:n}),{exclude:l,exclusionValue:p}=s(o);l&&a.push(p),c.push(o),d&&!Number.isNaN(Number(u))?u+=d:u=void 0}return{participantName:t.participantName,exclusionValues:a,scaleValues:c,value:u}}if(t){let{scaleValue:o,value:c}=Hb({singlesForDoubles:e,valueAccessor:r,matchUpType:i,participant:t,scaleName:n}),{exclude:u,exclusionValue:d}=s(o);return u&&a.push(d),{participantName:t.participantName,exclusionValues:a,scaleValue:o,value:c}}return{}})}function Hb({singlesForDoubles:e,valueAccessor:t,matchUpType:r,participant:i,scaleName:n}){let a=e?u:r,o=i?.rankings?.[a]?.find(e=>e.scaleName===n),s=(i?.ratings?.[a]?.find(e=>e.scaleName===n)||o)?.scaleValue;return{scaleValue:s,value:t?s?.[t]:s}}function Yb({matchUp:e,accuracy:t,excludeMargin:r,exclusionRule:i,valueAccessor:n,ascending:a,scaleName:o}){let{matchUpType:s,sides:c,score:u,winningSide:d}=e;if(!d)return;if(i&&(!i.valueAccessor||!i.range))return void(t.error={info:"exclusionRule requires valueAccessor and range",error:$t});let l=d-1,p=Wb({exclusionRule:i,valueAccessor:n,matchUpType:s,scaleName:o,sides:c});if(function({exclusionRule:e,sideValues:t,accuracy:r,score:i,winningSide:n}){if(e){let e=t.flatMap(({exclusionValues:e})=>e);if(e.length)return r.excluded.push({scoreString:i?.scoreStringSide1,exclusionValues:e,winningSide:n,sideValues:t}),!0}return!1}({exclusionRule:i,sideValues:p,accuracy:t,score:u,winningSide:d}))return;if(function(e){return e.filter(e=>![void 0,"",null].includes(e.value)).length<2}(p))return void t.excluded.push({scoreString:u?.scoreStringSide1,missingValues:!0,winningSide:d,sideValues:p});let m=p[l].value-p[1-l].value;if(function({excludeMargin:e,valuesGap:t}){let r=Number.parseFloat(e||0);return r&&Math.abs(t)<r}({excludeMargin:r,valuesGap:m}))return void t.excluded.push({scoreString:u?.scoreStringSide1,excludeMargin:r,winningSide:d,excludeGap:!0,sideValues:p,valuesGap:m});let f=a?m:-1*m,h=1===d?u?.scoreStringSide1:u?.scoreStringSide2;f>0?t.affirmative.push({winningScoreString:h,winningSide:d,sideValues:p,valuesGap:m,score:u}):t.negative.push({winningScoreString:h,winningSide:d,sideValues:p,valuesGap:m,score:u})}function zb({collectionDefinitions:e=[],collectionGroups:t=[]}){let r,i=0,{groupValueNumbers:n}=ev({collectionGroups:t});for(let a of e||[]){let{collectionValueProfiles:e,collectionGroupNumber:t,collectionValue:o,matchUpCount:s,matchUpValue:c,scoreValue:u,setValue:d}=a,l=t&&n.includes(t);if(F(d||u))r=!0;else{if(l)continue;if("number"==typeof o&&F(o))i+=o;else if(Array.isArray(e)&&e?.length)for(let t of e)i+=t.matchUpValue;else"number"==typeof c&&F(c)&&(i+=(s??0)*c)}}for(let a of t)i+=a.groupValue??0;return r||!i?{aggregateValue:!0,...ce}:{valueGoal:Math.floor(i/2)+1,...ce}}function Kb(e){let{timeStamp:t,schedule:r,matchUp:i}=e,n=$c(e,[{[Pc]:!0}]);if(n.error)return n;let{itemValue:a,timeStamp:o}=pf({timeItems:i?.timeItems||[],itemType:wm});return!r||o&&t&&new Date(o).getTime()>new Date(t).getTime()?{homeParticipantId:a}:r}function Jb({matchUps:e,matchUpId:t}){if(!Zp(e))return{error:gi};let r=e.find(e=>e.matchUpId===t),{drawId:i,eventId:n,structureId:a,tournamentId:o}=r||{};return{matchUpId:t,drawId:i,eventId:n,structureId:a,tournamentId:o}}function Qb(e,t){if(!v(e))return{error:gi};if(!Array.isArray(t))return{error:gi};let r={};for(let{param:i,error:n,attr:a}of t){let t=Xb({params:e,param:i,attr:a,error:n});if(t?.error)return t;r[i]=t}return r}function Xb({params:e,param:t,attr:r,error:i}){if(t===gc&&v(e.drawDefinition)&&S(e.structureId)){let t=(e.drawDefinition.structures??[]).find(({structureId:t})=>t===e.structureId);return!t.length&&i?{error:i}:{structure:t}}if(t===Pc){let t=ZD({...e,...r});return t.error&&i?{...t,error:i}:t}return{error:wi,info:{param:t}}}function Zb(e){let{structureId:t,matchUpId:r,event:i}=e,n=e.drawDefinition,a=$c(e,[{[Js]:!0},{[Lc]:{[oc]:!1,[mc]:!1,[Tc]:!1,[bc]:!1}}]);if(a[Dc])return a;let o=Qb(e,[{[Mc]:Pc,[Dc]:$t}])?.matchUp;if(r&&o?.error)return o;!n&&o?.drawDefinition&&(n=o?.drawDefinition);let s=o?.structure;if(!s&&t&&!r){if(!n)return{error:Ge};let e=Vd({drawDefinition:n,structureId:t});if(e.error)return e;s=e.structure}let c=s?.matchUpFormat,u=n?.matchUpFormat,d=i?.matchUpFormat;return{structureDefaultMatchUpFormat:c,eventDefaultMatchUpFormat:d,drawDefaultMatchUpFormat:u,matchUpFormat:o?.matchUp?.matchUpFormat||c||u||d}}function eM({profileBands:e,tournamentRecord:t,matchUps:r}){if(!Zp(r))return{error:At};let i=!e&&Sp({policyType:eu,tournamentRecord:t}).policy,n=e||i?.profileBands||Ip[eu].profileBands,a=r.filter(({winningSide:e})=>e),o=a.map(dm),s=pm(o).reduce((e,t)=>((e,t)=>(e[um(t,n)]+=1,e))(e,t),{[mp]:0,[fp]:0,[hp]:0,[lp]:0}),c=Object.keys(s).reduce((e,t)=>(s[t]||0)+e,0),u=Object.keys(s).map(e=>{let t=Number.parseFloat((s[e]/c).toFixed(4));return{[e]:100*t}}),d=a.filter(({matchUpStatus:e})=>e===pp).length;return u.push({[pp]:100*Number.parseFloat((d/c).toFixed(4))}),{competitiveBands:Object.assign({},...u),...ce}}var{stageOrder:tM}=Ys;function rM(e,t){return e.eventName.localeCompare(t.eventName)||e.eventId.localeCompare(t.eventId)||(tM[e?.stage]||0)-(tM[t?.stage]||0)||t.matchUpsCount-e.matchUpsCount||`${e.stageSequence}-${e.roundNumber}-${e.minFinishingSum}`.localeCompare(`${t.stageSequence}-${t.roundNumber}-${t.minFinishingSum}`)}function iM({excludeScheduleDateProfileRounds:e,excludeScheduledRounds:t,excludeCompletedRounds:r,inContextMatchUps:i,tournamentRecords:n,schedulingProfile:a,tournamentRecord:o,withSplitRounds:s,matchUpFilters:c,scheduleDate:u,withRoundId:d,venueId:l,context:p}){if(i&&!Array.isArray(i||"object"!=typeof i[0]))return{error:gi,inContextMatchUps:i};if(o&&!n){if("object"!=typeof o)return{error:Ue};n={[o.tournamentId]:o}}let m="object"!=typeof n||!Object.keys(n).length;if((l||u||!i||!a&&(e||r||a||s))&&m)return{error:ge};let f=Object.assign({},...Object.values(n??{}).map(({venues:e=[],tournamentId:t})=>({[t]:e?.map(({venueId:e})=>e)}))),h=Object.values(n??{}).map(({events:e=[],tournamentId:t,startDate:r,endDate:i})=>e.map(e=>({...e,validVenueIds:f[t],startDate:e.startDate??r,endDate:e.endDate??i}))).flat(),{segmentedRounds:g,profileRounds:I}=n&&(e||r||a||s)&&Sb({tournamentRecords:n,schedulingProfile:a})||{},U=e&&Object.assign({},...I.map(e=>({[e.id]:e}))),S=i||n&&Zf({tournamentRecords:n,matchUpFilters:c})?.matchUps||[],v=[],y=S&&Object.values(S.reduce((e,t)=>{let r=gb(t).id,i=g?.[r],n=[...e[r]?.matchUps??[],t],{containerStructureId:a,stageSequence:o,structureName:s,tournamentId:c,isRoundRobin:u,matchUpType:l,roundNumber:p,roundOffset:m,structureId:f,eventName:h,roundName:I,drawName:U,eventId:S,drawId:v}=t,y=u?a:f;return{...e,[r]:{id:d?r:void 0,structureId:y,stageSequence:o,segmentsCount:i,structureName:s,tournamentId:c,matchUpType:l,roundNumber:p,roundOffset:m,eventName:h,roundName:I,drawName:U,matchUps:n,eventId:S,drawId:v}}},{})).map(e=>{let{minFinishingSum:t,winnerFinishingPositionRange:r}=function(e){return(e||[]).reduce((e,t)=>{let r=(t.finishingPositionRange?.winner||[]).reduce((e,t)=>e+t,0),i=(t.finishingPositionRange?.winner||[]).join("-")||"";return!e.minFinishingSum||r<e.minFinishingSum?{minFinishingSum:r,winnerFinishingPositionRange:i}:e},{minFinishingSum:0,winnerFinishingPositionRange:""})}(e.matchUps),i=e.segmentsCount;if(i){let a=e.matchUps.length/i;return re(e.matchUps.sort((e,t)=>e.roundPosition-t.roundPosition),a).map((a,o)=>{let{unscheduledCount:s,incompleteCount:c,matchUpsCount:u,isScheduled:d,isComplete:l,byeCount:m}=Ub(a),f=Ib({matchUps:e.matchUps,tournamentRecords:n,events:h,round:e});return wn({...e,...p,roundSegment:{segmentsCount:i,segmentNumber:o+1},winnerFinishingPositionRange:r,unscheduledCount:s,incompleteCount:c,minFinishingSum:t,matchUpsCount:u,isScheduled:d,roundTiming:f,isComplete:l,byeCount:m,matchUps:a})})}let{unscheduledCount:a,incompleteCount:o,matchUpsCount:s,isScheduled:c,isComplete:u,byeCount:d}=Ub(e.matchUps),l=Ib({matchUps:e.matchUps,tournamentRecords:n,events:h,round:e});return wn({...e,...p,winnerFinishingPositionRange:r,unscheduledCount:a,incompleteCount:o,minFinishingSum:t,matchUpsCount:s,isScheduled:c,roundTiming:l,isComplete:u,byeCount:d})}).flat().filter(i=>{if(e){let t=ya(e),r=d?i.id:gb(i).id;if(t&&U[r]&&ya(U[r].scheduleDate)===t)return!1}let{isComplete:n,isScheduled:a}=i,s=!r||!n,c=!t||!a,p=l||u?h?.find(({eventId:e})=>e===i.eventId):void 0,m=p?.startDate??o?.startDate,f=p?.endDate??o?.endDate,g=!u||!m||new Date(u)>=new Date(m),I=!u||!f||new Date(u)<=new Date(f),S=g&&I,y=!l||p?.validVenueIds.includes(l),w=s&&c&&y&&S;return w||v.push(i),w}).sort(rM)||[];return{...ce,rounds:y,excludedRounds:v}}function nM(e){let{matchUp:t,sideNumber:r,setNumber:i,isTiebreakValue:n,isPointValue:a}=e||{},{matchUpFormat:o}=e||{};if(!t)return{error:Et};o=o||t?.matchUpFormat;let s=Yn(o),c=!!t?.winningSide,u=t.score?.sets,d=u?.length,l=i&&i-1,p=!!u?.find((e,t)=>e.setNumber===i&&t===l),m=u?.filter(e=>e?.winningSide)||[],f=m?.length||0,h=i&&u?.slice(i)||[],g=!!(d&&i&&h?.reduce((e,t)=>(!t||!t.side1Score&&!t.side2Score&&!t.side1TiebreakScore&&!t.side2TiebreakScore&&!t.side1PointScore&&!t.side2PointScore)&&e,!0)),I=i<=d&&u.find(e=>e.setNumber===i),U=I&&NT({setObject:I,matchUpScoringFormat:s}),{isCompletedSet:S,sideGameScores:v,sideTiebreakScores:y}=U||{},w=!!(I&&!S&&g||i&&i===d+1&&!c),P=[1,2].includes(r),T=P?r-1:0,D=I&&P&&(!n&&!a&&void 0!==v[T]&&v[T]||n&&void 0!==y[T]&&y[T]),b=!!D,M=m?.map(e=>NT({setObject:e,matchUpScoringFormat:s}).isValidSetOutcome).reduce((e,t)=>e&&t,!0),R=m.reduce((e,t)=>{let{winningSide:r}=t;return e[r-1]++,e},[0,0]),N=t?.winningSide,A=N&&N-1,E=1-A,C=R[A],O=R[E],k=Math.max(...R),F=j(R)[k],{bestOf:x,exactly:_}=s??{},L=k===Math.ceil((x||_||1)/2)&&1===F&&R.indexOf(k)+1||void 0,B=C>O&&N===L;return{completedSetsHaveValidOutcomes:M,validMatchUpWinningSide:B,calculatedWinningSide:L,matchUpScoringFormat:s,validMatchUpOutcome:L&&M&&B,isLastSetWithValues:g,completedSetsCount:f,isCompletedMatchUp:c,isValidSideNumber:P,hasExistingValue:b,existingValue:D,isExistingSet:p,isActiveSet:w,...U}}function aM({participants:e,tournamentAppliedPolicies:t,scheduleVisibilityFilters:r,participantsProfile:i,afterRecoveryTimes:n,policyDefinitions:a,useParticipantMap:o,tournamentRecord:s,usePublishState:c,contextFilters:u,contextContent:d,matchUpFilters:l,participantMap:p,publishStatus:m,contextProfile:f,drawDefinition:h,nextMatchUps:g,tournamentId:I,inContext:U,context:S,event:v}){let y,{eventId:w,eventName:P,endDate:T,eventType:D,category:b,gender:M}=v??{},R={...S,...wn({surfaceCategory:v?.surfaceCategory??s?.surfaceCategory,indoorOutDoor:v?.indoorOutdoor??s?.indoorOutdoor,endDate:T??v?.endDate??s?.endDate,tournamentId:I??s?.tournamentId,eventName:P,eventType:D,category:b,eventId:w,gender:M})};return!e?.length&&s&&({participants:e,participantMap:p,groupInfo:y}=cp({participantsProfile:i,policyDefinitions:a,useParticipantMap:o,tournamentRecord:s,contextProfile:f,inContext:U})),v&&f&&!d&&(d=Up({policyDefinitions:a,tournamentRecord:s,contextProfile:f,drawDefinition:h,event:v})),{...Jf({context:R,tournamentAppliedPolicies:t,scheduleVisibilityFilters:r,tournamentParticipants:e,participantsProfile:i,afterRecoveryTimes:n,policyDefinitions:a,tournamentRecord:s,usePublishState:c,participantMap:p,contextContent:d,contextFilters:u,matchUpFilters:l,publishStatus:m,contextProfile:f,drawDefinition:h,nextMatchUps:g,inContext:U,event:v}),groupInfo:y}}var oM={};function sM({tournamentRecord:e,venueId:t,venueIds:r}){return e?{courts:(e.venues||[]).filter(e=>t?e.venueId===t:!r||r.includes(e.venueId)).map(e=>{let{venueId:t}=e,r=Wa(e.courts||[]);return r.forEach(e=>Object.assign(e,{venueId:t})),r}).flat()}:{error:Ie}}n(oM,{getCompetitionVenues:()=>$v,getCourts:()=>sM,getVenuesAndCourts:()=>jv,publicFindVenue:()=>Tf});var cM={};function uM({tournamentRecord:e,event:t}){if(!e)return{error:Ie};if(!t)return{error:ot};let r,i,n,a=t.entries||[],o=e.participants||[],s=t.category?.categoryName||t.category?.ageCategoryCode,{eventType:c}=t,u=new Set(a.map(e=>e.participantId));return{entryScaleAttributes:o.filter(e=>u.has(e.participantId)).map(e=>{let{participantId:t,participantName:a,name:o}=e,u={scaleType:Bm,eventType:c,scaleName:s},d=hg({participant:e,scaleAttributes:u})?.scaleItem?.scaleValue;u={scaleType:Lm,eventType:c,scaleName:s};let l=hg({participant:e,scaleAttributes:u})?.scaleItem?.scaleValue;u={scaleType:_m,eventType:c,scaleName:s};let p=hg({participant:e,scaleAttributes:u})?.scaleItem?.scaleValue;return r=!(!r&&!d),i=!(!i&&!l),n=!(!n&&!p),{participantId:t,participantName:a||o,seed:d,ranking:l,rating:p}}),hasSeededParticipants:r,hasRankedParticipants:i,hasRatedParticipants:n}}function dM({tournamentRecord:e,withScaleValues:t,scaleEventType:r,inContext:i,eventIds:n,drawIds:a,context:o}){if(!e)return{error:Ie};let{tournamentId:s}=e,c=(e.events??[]).filter(({eventId:e})=>!n||Array.isArray(n)&&n.includes(e)).map(e=>{let t=e.drawDefinitions?.map(pd);if(a?.length&&!Q(a,t).length)return;let r=Wa(e);return i&&Object.assign(r,{tournamentId:s}),o&&Object.assign(r,o),r}).filter(Boolean),u={};if(t){let t=Ag({withScaleValues:!0,tournamentRecord:e}).participantMap,i=e=>e.reduce((e,t)=>e+Number.parseFloat(t),0);for(let e of c){let n=r??e.eventType,o=e.eventId;u[o]||(u[o]={ratingsStats:{},ratings:{},ranking:{},draws:{}});let s=(e.entries??[]).filter(({entryStatus:e})=>Bp.includes(e)).map(dd),c=e=>{if(e?.ratings?.[n])for(let t of e?.ratings?.[n]??[]){let e=t.scaleName;u[o].ratings[e]||(u[o].ratings[e]=[]);let r=qh[e]?.accessor;if(r){let i=Number.parseFloat(t.scaleValue?.[r]);i&&u[o].ratings[e].push(i)}}if(e?.rankings?.[n])for(let t of e?.rankings?.[n]??[]){let e=t.scaleName;u[o].ranking[e]||(u[o].ranking[e]=[]),t.scaleValue&&u[o].ranking[e].push(t.scaleValue)}};for(let e of s){let r=t?.[e]?.participant;if(r?.participantType===Vl)c(r);else for(let e of r?.individualParticipantIds??[]){let r=t?.[e]?.participant;c(r)}}let d=u[o].ratings;for(let e of Object.keys(d)){let t=d[e];if(!t.length)continue;let r=R(t)?.toFixed(2);u[o].ratingsStats[e]={avg:Number.parseFloat((i(t)/t.length).toFixed(2)),median:r?Number.parseFloat(r):void 0,max:Math.max(...t),min:Math.min(...t)}}let l=(e,r)=>{let i=t=>{if(u[o].draws?.[e]&&t?.ratings?.[n])for(let r of t?.ratings?.[n]??[]){let t=r.scaleName;u[o].draws[e]?.ratings[t]||(u[o].draws[e].ratings[t]=[]);let i=qh[t]?.accessor;if(i){let n=Number.parseFloat(r.scaleValue?.[i]);n&&u[o].draws[e].ratings[t].push(n)}}if(u[o].draws?.[e]&&t?.rankings?.[n])for(let r of t?.rankings?.[n]??[]){let t=r.scaleName;u[o].draws[e]?.ranking[t]||(u[o].draws[e].ranking[t]=[]);let i=r.scaleValue;i&&u[o].draws[e].ranking[t].push(i)}};for(let n of r.filter(Boolean)){let e=t?.[n]?.participant;if(e?.participantType===Vl)i(e);else for(let r of e?.individualParticipantIds??[]){let e=t?.[r]?.participant;i(e)}}},p=[],m=e=>a?.length&&a.includes(e)||p.includes(e);for(let t of e.drawDefinitions??[]){let e=t.drawId;if(m(e))continue;let r=Nh({drawDefinition:t}).assignedParticipantIds??[];u[o].draws[e]||(u[o].draws[e]={ratingsStats:{},ratings:{},ranking:{}}),p.push(e),l(e,r)}let f=Nf({event:e}).flightProfile;for(let e of f?.flights??[]){let t=e.drawId;m(t)||l(t,e.drawEntries.map(dd))}for(let e of p){let t=u[o].draws[e].ratings;for(let r of Object.keys(t)){let n=t[r];if(!n.length)continue;let a=R(n)?.toFixed(2);u[o].draws[e].ratingsStats[r]={avg:Number.parseFloat((i(n)/n.length).toFixed(2)),median:a?Number.parseFloat(a):void 0,max:Math.max(...n),min:Math.min(...n)}}}}}return wn({eventScaleValues:u,events:c,...ce})}function lM({tournamentRecord:e,drawDefinition:t,context:r,event:i}){if(!e)return{error:Ie};if(!i)return{error:ot};let n=Wa(i);return r&&Object.assign(n,r),wn({drawDefinition:t&&n.drawDefinitions?.find(({drawId:e})=>t.drawId===e),event:n})}function pM(e){let t="validateAndDeriveDrawValues",{appliedPolicies:r,policyDefinitions:i}=function(e){let{tournamentRecord:t,event:r}=e,i={...e?.appliedPolicies,...up({tournamentRecord:t,event:r}).appliedPolicies??{}},n=Wa(e.policyDefinitions??{},!1,!0);return{appliedPolicies:i,policyDefinitions:n}}(e),n=function({enforceGender:e,policyDefinitions:t,appliedPolicies:r}){return e??t?.[iu]?.participants?.enforceGender??r?.[iu]?.participants?.enforceGender}({...e,policyDefinitions:i,appliedPolicies:r}),a=function({considerEventEntries:e=!0,drawEntries:t,eventEntries:r,qualifyingOnly:i}){return(i&&[]||mM(t)||(e?r:[])).filter(({entryStage:e})=>!e||e===Ho)}(e),o=function(e){let{consideredEntries:t,appliedPolicies:r,policyDefinitions:i,enforceGender:n,participantMap:a,participants:o,event:s}=e;return s&&o&&$y({consideredEntries:t,policyDefinitions:i,appliedPolicies:r,participantMap:a,enforceGender:n,participants:o,event:s})}({...e,consideredEntries:a,appliedPolicies:r});if(o?.error)return Pn({result:o,stack:t});let s=function(e){return!e.drawSize&&e.consideredEntries.length&&![Is,ws,Us,_s,Ls].includes(e.drawType??"")&&O(e.consideredEntries.length)||e.drawSize&&I(e.drawSize)||!1}({...e,consideredEntries:a}),c=function(e){let{policyDefinitions:t,appliedPolicies:r,enforceMinimumDrawSize:i=!0,drawSize:n}=e,a=e.drawTypeCoercion??Ly({drawType:e.drawType,policyDefinitions:t,appliedPolicies:r}),o=Hy({drawType:e.drawType,enforceMinimumDrawSize:i,drawTypeCoercion:a,drawSize:n});return o.error?o:{drawType:o.drawType}}({...e,appliedPolicies:r,policyDefinitions:i,drawSize:s});if(c.error)return Pn({result:c,stack:t});let u=c.drawType;if(isNaN(s)&&u!==Is)return Pn({result:{error:Ve},stack:t});let d=i?.[lu]??r?.[lu],l=e.seedingProfile??d?.seedingProfile?.drawTypes?.[u??""]??d?.seedingProfile;e.seedingProfile&&(i[lu]||(i[lu]={...PD[lu]}),i[lu].seedingProfile=l);let p=function(e){let{tournamentRecord:t,event:r,ignoreAllowedDrawTypes:i,drawType:n}=e,a=!i&&t&&xD({tournamentRecord:t,categoryType:r?.category?.categoryType,categoryName:r?.category?.categoryName});return a?.length&&!a.includes(n)?{error:_e}:{...ce}}({...e,drawType:u});return p?.error?Pn({result:p,stack:t}):{drawSize:s,drawType:u,enforceGender:n,seedingProfile:l,appliedPolicies:r,policyDefinitions:i}}function mM(e){return e?.filter(e=>e.entryStatus&&[...Bp,Ap].includes(e.entryStatus))}function fM(e){let{drawDefinition:t,appliedPolicies:r}=e,i=r?.[au],n=Kp({drawDefinition:t});return t.structures?.forEach(e=>{let r=Jp({structureId:e.structureId,matchUpsMap:n}),a=sm({roundNamingPolicy:i,drawDefinition:t,structure:e,matchUps:r}),{roundNamingProfile:o,roundProfile:s}=a;(e.structures||[e]).forEach(e=>{(e.matchUps??[]).forEach(e=>{let t=e?.roundNumber?.toString();if(t){let r=o?.[t]?.roundName,i=o?.[t]?.abbreviatedRoundName,n=s?.[t]?.feedRound;Object.assign(e,{abbreviatedRoundName:i,feedRound:n,roundName:r})}})})}),{drawDefinition:t}}function hM(e){let{voluntaryConsolation:t,tournamentRecord:r,event:i}=e,n="generateDrawDefinition",{participants:a,participantMap:o}=Ag({withIndividualParticipants:!0,convertExtensions:!0,internalUse:!0,tournamentRecord:r}),s=mM(i?.entries)??[],c=pM({...e,participantMap:o,participants:a,eventEntries:s});if(c.error)return Pn({result:c,stack:n});let{appliedPolicies:u,policyDefinitions:d,drawSize:l,drawType:p,enforceGender:m,seedingProfile:f}=c,h=i?.eventType,g=e.matchUpType??h,I=function(e){let{existingDrawDefinition:t,hydrateCollections:r,enforceGender:i,tieFormatName:n,matchUpType:a,eventType:o,isMock:s,event:c}=e,{tieFormat:u,matchUpFormat:d}=e;if(a===$o&&o===$o){let e=t?.structures?.find(({stage:e})=>e===Ho)?.tieFormat;u=u||e||n&&c?.tieFormat?.tieFormatName===n&&c.tieFormat||n&&Lo({namedFormat:n,hydrateCollections:r,isMock:s,event:c})||c?.tieFormat||Lo({event:c,isMock:s,hydrateCollections:r}),d=void 0}else d||(u=void 0,c?.matchUpFormat||(d=ao));if(u){let e=Ba({gender:c?.gender,enforceGender:i,tieFormat:u});if(e.error)return e}return{tieFormat:u,matchUpFormat:d}}({...e,enforceGender:m,eventType:h,matchUpType:g});if(I.error)return Pn({result:I,stack:n});let{matchUpFormat:U,tieFormat:S}=I;if(e.drawId&&"string"!=typeof e.drawId)return Pn({result:{error:gi},stack:n});let v=function(e){let t="generateOrGetExisting",r=[],i=[],n=DD(e);if(n.error)return Pn({result:n,stack:t});let a,o,s=n.existingDrawDefinition,c=e.drawEntries??e.eventEntries??[],u=n.existingQualifyingPlaceholderStructureId&&aD({...e,...n})||mD({...e,...n,entries:c});return u.error?Pn({result:u,stack:t}):(u.positioningReports?.length&&r.push(...u.positioningReports??[]),u.conflicts?.length&&i.push(...u.conflicts??[]),a=u.drawDefinition,o=u.structureId,{existingDrawDefinition:s,positioningReports:r,drawDefinition:a,structureId:o,conflicts:i,entries:c})}({...e,policyDefinitions:d,tournamentRecord:r,appliedPolicies:u,matchUpFormat:U,seedingProfile:f,participants:a,eventEntries:s,matchUpType:g,tieFormat:S,drawSize:l,drawType:p,event:i});if(v.error)return Pn({result:v,stack:n});let{existingDrawDefinition:y,positioningReports:w,drawDefinition:P,structureId:T,conflicts:D,entries:b}=v;if(!P)return Pn({result:{error:gi},stack:n});let M=function(e){let{qualifyingPlaceholder:t,existingDrawDefinition:r,positioningReports:i,qualifyingProfiles:n,appliedPolicies:a,qualifyingOnly:o,drawDefinition:s,seedingProfile:c,participants:u,structureId:d,tieFormat:l,entries:p,stack:m}=e,f=t&&!n?.length&&!r,h=[];if(n){let t=(e,t)=>e.stageSequence-t.stageSequence,r=(e,t)=>e.roundTarget-t.roundTarget,d=[],l=1;n.sort(r);for(let f of n){if(!Array.isArray(f.structureProfiles))return Pn({info:WI("structureProfiles"),result:{error:$t},stack:m});l=f.roundTarget||l;let r=f.structureProfiles?.sort(t)||[],n=1;for(let t of r){let{qualifyingRoundNumber:r,qualifyingPositions:m,seededParticipants:f,seedingScaleName:g,seedsCount:I=0,seedByRanking:U,placeByes:S,drawSize:v}=t,y=pD({...e,seedingProfile:t.seedingProfile??c,stageSequence:n,qualifyingRoundNumber:r,preparedStructureIds:d,qualifyingPositions:m,seededParticipants:f,stage:Yo,seedingScaleName:g,appliedPolicies:a,drawDefinition:s,qualifyingOnly:o,seedByRanking:U,participants:u,roundTarget:l,seedsCount:I,placeByes:S,drawSize:v,entries:p});if(y.error)return y;y.structureId&&d.push(y.structureId),n+=1,y.conflicts?.length&&h.push(...y.conflicts),y.positioningReport?.length&&i.push({[Yo]:y.positioningReport})}l+=1}}else if(d&&f){let e=hI({structureName:II(Yo),stage:Yo,qualifyingOnly:o,tieFormat:l}),{link:t}=vS({sourceStructureId:e.structureId,targetStructureId:d,sourceRoundNumber:0,linkType:ms});s.structures||(s.structures=[]),s.structures.push(e),s.links||(s.links=[]),s.links.push(t)}return{qualifyingConflicts:h,error:void 0}}({...e,existingDrawDefinition:y,positioningReports:w,appliedPolicies:u,drawDefinition:P,seedingProfile:f,participants:a,structureId:T,entries:b,params:e,stack:n});if(M.error)return M;let{qualifyingConflicts:R}=M;return P.drawName=e.drawName??(p&&II(p)),l&&"object"==typeof t&&l>=4&&UI({...t,drawDefinition:P,matchUpType:g}),e.hydrateRoundNames&&u?.[au]&&fM({drawDefinition:P,appliedPolicies:u}),{existingDrawDefinition:!!y,qualifyingConflicts:R,positioningReports:w,drawDefinition:P,structureId:T,...ce,conflicts:D}}function gM({matchUps:e,matchUpType:t}){if(!e)return{error:At};let r=[],i=[],n=0;t&&(e=e.filter(e=>e.matchUpType===t));let a=L(e.map(({matchUpType:e})=>e));if(a.length>1)if(se(a,m))e=e.filter(Wm(m));else if(se(a,u))e=e.filter(Wm(u));else{if(!se(a,l))return{};e=e.filter(Wm(l))}if(!Zp(e)||!e.length)return{};let o=(e,t)=>I(e)-I(t),s=L(e.flatMap(e=>e.drawPositions).filter(Boolean)).sort(o),c=K(1,Math.max(...s)+1).filter(e=>!s.includes(e)).sort(o),{roundMatchUps:d}=em({matchUps:e}),p=d?.[1],f=d?.[2]??[],h=p?.[0],g=h?.drawId,U=h?.structureId,S=d?Object.keys(d).map(e=>I(e)):[],v=Math.max(...S),y=d?.[v]?.length??0,w=Math.ceil(Math.log(y)/Math.log(2)),P=K(1,w+1).map(e=>{let t=Math.pow(2,e-1),r=v+w-e+1;return K(1,t+1).map(t=>({drawId:g,structureId:U,matchUpId:za(),drawPositions:[],sides:[],roundNumber:r,roundPosition:t,finishingRound:e}))});w&&(e=e.concat(...P.flat()));let T=p?.map(e=>e.drawPositions)?.flat(1/0),D=f.map(e=>e.drawPositions).flat(1/0).filter(e=>!T?.includes(e)).sort(o),b=f.filter(e=>e.drawPositions?.find(e=>D.includes(e))).map(e=>{let t=e.drawPositions?.find(e=>D.includes(e)),r=t&&e.drawPositions?.indexOf(t),i=void 0!==r&&e.sides?.[r];return t&&{[t]:i}});if(c?.length&&D?.length===c?.length){let t=D.map((e,t)=>[e,c[t]].sort(o)),r=Object.assign({},...b),n=Wa(p?.[0].finishingRound,!1,!0),a=Wa(p?.[0].finishingPositionRange,!1,!0);i=t.map((e,t)=>{let i=Math.max(...e||[])/2,o=e?.map(e=>r[e]||{bye:!0,drawPosition:e});return{finishingPositionRange:a,sideNumber:t+1,matchUpStatus:"BYE",matchUpId:za(),finishingRound:n,roundNumber:1,drawPositions:e,roundPosition:i,structureId:U,drawId:g,sides:o}}),e=e.concat(...i)}let M=v+w;return K(1,M+1).forEach(t=>{let i=[],a=IM({matchUps:e,roundNumber:t}),o=IM({matchUps:e,roundNumber:t-1}),s=new Set(o.map(UM).filter(Boolean)),c=a?.length===r?.length,u=a?.length===r?.length/2;1===t&&a.forEach(e=>{let t=e.drawPositions||[],{matchUpId:r,structureId:n}=e,a=[{...e.sides[0],drawPosition:t[0],matchUpId:r,structureId:n},{...e.sides[1],drawPosition:t[1],matchUpId:r,structureId:n}],o={...e,children:a};i.push(o)}),c?(n++,a.forEach((e,t)=>{let a=e.drawPositions||[],{matchUpId:o,structureId:c}=e,u=a.filter(Boolean).reduce((e,t)=>T?.includes(t)?e:t,void 0),d=[{...e.sides.filter(Boolean).reduce((e,t)=>t.participantId&&!s.has(t.participantId)?t:e,void 0),drawPosition:u,feedRoundNumber:n,sides:e.sides,matchUpId:o,structureId:c},r[t]],l={...e,children:d};i.push(l)})):u&&a.forEach((e,t)=>{let n={...e,children:[r[2*t],r[2*t+1]]};i.push(n)}),r=i}),{hierarchy:r[0],missingMatchUps:i,maxRound:v,finalRound:M,matchUps:e}}function IM({matchUps:e,roundNumber:t}){return e.filter(e=>e.roundNumber===t).sort((e,t)=>e.roundPosition-t.roundPosition)}function UM(e){return"BYE"===e.matchUpStatus?e.sides.reduce((e,t)=>t.participantId||e,void 0):e.winningSide?e.sides.reduce((t,r)=>r.sideNumber===e.winningSide?r.participantId:t,void 0):void 0}function SM({scaleAttributes:e,scaledEntries:t,stageEntries:r,seedsCount:i,scaleName:n}){if(!e)return{error:$t,info:"missing scaleAttributes"};let a=Object.assign({},...(t||[]).slice(0,i).map(({participantId:e},t)=>({[e]:t+1})));n=n||e.scaleName;let o=(new Date).toISOString();return{scaleItemsWithParticipantIds:r.map(({participantId:t})=>({scaleItems:[{scaleValue:a[t],eventType:e.eventType,scaleType:Kc,scaleName:n,scaleDate:o}],participantId:t}))}}function vM({tournamentRecord:e,drawDefinition:t,policyDefinitions:r,scaleAttributes:i,scaleName:n,drawSize:a,drawId:o,event:s,stage:c,sortDescending:u,scaleSortMethod:d}){let l=Pb({policyDefinitions:r,drawDefinition:t,drawSize:a,drawId:o,event:s,stage:c});if(l.error)return l;let{entries:p,seedsCount:m,stageEntries:f}=l;if(!f||!m)return{error:gi};let h=lD({tournamentRecord:e,scaleAttributes:i,scaleSortMethod:d,sortDescending:u,entries:p,stage:c}).scaledEntries??[],{scaleItemsWithParticipantIds:g}=SM({scaleAttributes:i,scaledEntries:h,stageEntries:f,seedsCount:m,scaleName:n});return{scaleItemsWithParticipantIds:g}}n(cM,{categoryCanContain:()=>_a,getCategoryAgeDetails:()=>Fa,getEvent:()=>lM,getEventProperties:()=>uM,getEventStructures:()=>aU,getEventTimeItem:()=>Zl,getEvents:()=>dM,getFlightProfile:()=>Nf,getScaledEntries:()=>lD});var yM={};n(yM,{addDrawEntries:()=>jg,addEventEntries:()=>Kg,addEventEntryPairs:()=>EM,destroyPairEntries:()=>lI,destroyPairEntry:()=>dI,getEntriesAndSeedsCount:()=>Pb,getMaxEntryPosition:()=>Tb,modifyEntriesStatus:()=>Ch,modifyEventEntries:()=>CM,mutate:()=>wM,promoteAlternate:()=>DM,promoteAlternates:()=>bM,query:()=>wb,removeDrawEntries:()=>RM,removeEventEntries:()=>qg,setEntryPosition:()=>PM,setEntryPositions:()=>TM});var wM={};function PM({tournamentRecord:e,drawDefinition:t,participantId:r,entryPosition:i,skipRefresh:n,event:a}){if(!e)return{error:Ie};if(!r)return Pn({result:{error:Ir},stack:"setEntryPositions"});if(void 0!==i&&!Number.isSafeInteger(i))return{error:gi,entryPosition:i};(a?.entries||[]).forEach(e=>{e.participantId===r&&(e.entryPosition=i)}),(t?.entries||[]).forEach(e=>{e.participantId===r&&(e.entryPosition=i)});let o=e=>{e.entries.forEach(e=>{e.entryPosition===i&&e.participantId!==r&&(e.entryPosition+=.1)})};return n||(a?.entries&&(o(a),a.entries=Ah({entries:a.entries})),t?.entries&&(o(t),t.entries=Ah({entries:t.entries}))),{...ce}}function TM({tournamentRecord:e,entryPositions:t,drawDefinition:r,event:i}){if(!e)return{error:Ie};if(!Array.isArray(t))return{error:gi};for(let n of t){let{participantId:t,entryPosition:a}=n,o=PM({skipRefresh:!0,tournamentRecord:e,drawDefinition:r,participantId:t,entryPosition:a,event:i});if(o.error)return o}return i?.entries&&(i.entries=Ah({entries:i.entries})),r?.entries&&(r.entries=Ah({entries:r.entries})),{...ce}}function DM(e){let{participantId:t}=e;return t&&"string"!=typeof t?{error:gi,participantId:t}:bM({...e,participantIds:[t].filter(Boolean)})}function bM({tournamentRecord:e,drawDefinition:t,participantIds:r,stageSequence:i,stage:n=Ho,eventId:a,event:o}){if(!e)return{error:Ie};if(!Array.isArray(r))return{error:gi,participantIds:r};if(!o)return{error:ot};if(o){let e=MM({element:o,participantIds:r,stageSequence:i,stage:n});if(e.error)return e}if(t){let e=MM({element:t,participantIds:r,stageSequence:i,stage:n});if(e.error)return a?Pn({context:{drawPromotionError:e.error,drawId:t.drawId},result:{...ce},stack:"promoteAlternates"}):e}return{...ce}}function MM({participantIds:e,stageSequence:t,element:r,stage:i}){let n=(r.entries||[]).filter(e=>e.entryStatus===Pp),a=(r.entries||[]).filter(t=>e.includes(t.participantId)),o=n.reduce((e,t)=>{let{entryPosition:r}=t;return isNaN(r)&&e||(!e||r<e.entryPosition)&&t||e},void 0),s=a.length?a:[o].filter(Boolean);if(!s?.length)return{error:Ar};let c=s.filter(({entryStatus:e})=>e!==Pp);if(c.length)return{error:Nr,invalidEntryStatus:c};let u=s.filter(({entryStage:e})=>e&&e!==i);if(u.length)return{error:Er,invalidStage:u};let d=t&&s.filter(e=>e.stageSequence!==t);if(d?.length)return{error:Cr,invalidStageSequence:d};for(let l of s){l.entryStatus=Dp;let e=l?.entryPosition;isNaN(e)||r.entries.forEach(t=>{t.entryStatus===Pp&&t.entryPosition>e&&(t.entryPosition=t.entryPosition-1)});let t=Math.max(...r.entries.filter(e=>e.entryStatus===Dp&&!isNaN(e.entryPosition)).map(({entryPosition:e})=>I(e||0)),0);l.entryPosition=t||0}return{...ce}}function RM({autoEntryPositions:e=!0,participantIds:t,drawDefinition:r,drawId:i,stages:n,event:a}){if(!a)return{error:ot};if(!i)return{error:Ge};if(!t?.length)return{error:wr};if(Z(Nh({drawDefinition:r,stages:n}).assignedParticipantIds??[],t))return{error:br};let o=e=>{let r=e.participantId;return!t.includes(r)},{flightProfile:s}=Nf({event:a}),c=s?.flights?.find(e=>e.drawId===i);return c?.drawEntries&&(c.drawEntries=c.drawEntries.filter(o),e&&(c.drawEntries=Ah({entries:c.drawEntries}))),r?.entries&&(r.entries=r.entries.filter(o),e&&(r.entries=Ah({entries:r.entries}))),{...ce}}function NM(e){let t="addParticipant",{allowDuplicateParticipantIdPairs:r,returnParticipant:i,disableNotice:n,pairOverride:a,participant:o}=e,s=e.tournamentId?e.tournamentRecords?.[e.tournamentId]:e.tournamentRecord??(e.activeTournamentId&&e.tournamentRecords?.[e.activeTournamentId]);if(!s)return{error:Ie};if(!o)return Pn({result:{error:hr},stack:t});o.participantId||(o.participantId=za()),s.participants||(s.participants=[]);let{participantId:c,individualParticipantIds:u}=o;if(s.participants.reduce((e,t)=>t.participantId===c||e,!1))return{error:vr};let{participantType:d,participantRole:l}=o;if(!d||!Object.keys(ql).includes(d))return{error:mr,participantType:d};if(!l)return{error:fr};let p=s.participants||[],m=p.filter(e=>e.participantType===Vl).map(e=>e.participantId);if(d!==Vl&&o.person)return{error:gi,person:o.person};if(u&&!Array.isArray(u))return{error:gi,individualParticipantIds:u};if(d===jl){if(o.person)return{error:gi,person:o.person};if(!o.individualParticipantIds)return Pn({result:{error:wr},stack:t});if(2!==o.individualParticipantIds.length&&!a)return Pn({info:"PAIR must be 2 individualParticipantIds",result:{error:lr},stack:t});{let e=p.filter(e=>e.participantType===Vl).map(e=>e.participantId);if(!Array.isArray(o.individualParticipantIds))return Pn({result:{error:lr},stack:t});if(!o.individualParticipantIds.reduce((t,r)=>e.includes(r)&&t,!0))return Pn({result:{error:lr},stack:t})}let e=p.filter(e=>e.participantType===jl).map(e=>({individualParticipantIds:e.individualParticipantIds,participant:e})),n=o.participantType===jl&&e.find(e=>2===Q(e.individualParticipantIds,o.individualParticipantIds).length);if(n&&!r)return{...ce,existingParticipant:!0,participant:i&&Wa(n.participant)};if(!o.participantName){let e=p.filter(e=>o.individualParticipantIds?.includes(e.participantId)),t=e.map(e=>e.person?.standardFamilyName).filter(Boolean).join("/");1===e.length&&(t+="/Unknown"),o.participantName=t}}else if(d===Vl){if(!o.person?.standardFamilyName||!o.person?.standardGivenName)return{error:Dr};if(!o.participantName){let e=`${o.person.standardFamilyName.toUpperCase()}, ${o.person.standardGivenName}`;o.participantName=e}}else{if(!d||![$l,Gl].includes(d))return{error:mr};if(u||(o.individualParticipantIds=[]),o.individualParticipantIds?.length)for(let e of o.individualParticipantIds){if("string"!=typeof e)return Pn({result:{participantId:e,error:gi},stack:t});if(!m.includes(e))return Pn({result:{participantId:e,error:Sr},stack:t})}}return s.participants.push(o),n||rn({payload:{tournamentId:s.tournamentId,participants:[o]},topic:Yd}),wn({participant:i&&Wa(o),...ce})}function AM({allowDuplicateParticipantIdPairs:e,returnParticipants:t,tournamentRecord:r,participants:i=[]}){if(!r)return{error:Ie};r.participants||(r.participants=[]);let n=r.participants.map(e=>e.participantId)||[];i.forEach(e=>{e.participantId||(e.participantId=za())});let a=i.filter(e=>!n.includes(e.participantId)),o=i.filter(e=>n.includes(e.participantId)),s=a.filter(e=>e.participantType===Vl),c=a.filter(e=>e.participantType!==Vl),u=s.concat(...c),d=[];if(u.length){for(let t of u){let i=NM({allowDuplicateParticipantIdPairs:e,returnParticipant:!0,disableNotice:!0,tournamentRecord:r,participant:t});if(i.error)return i;i.success&&!i.existingParticipant&&d.push(i.participant)}d.length&&rn({topic:Yd,payload:{tournamentId:r.tournamentId,participants:d}});let i={participants:t&&Wa(d),addedCount:d.length,...ce};return o.length&&Object.assign(i,{notAdded:o,info:Mr}),wn(i)}return{info:"No new participants to add",addedCount:0,...ce}}function EM(e){let t=$c(e,[{[Js]:!0,[bc]:!0}]);if(t.error)return t;let{allowDuplicateParticipantIdPairs:r,entryStatus:i=Pp,participantIdPairs:n=[],entryStage:a=Ho,tournamentRecord:o,drawDefinition:s,event:c,uuids:u}=e;if(c.eventType!==l)return{error:at};let d=[],p=new Map;for(let l of o.participants??[]){let{participantType:e,participantId:t,person:r,individualParticipantIds:i}=l;e===Vl&&r?.sex?p.set(t,r.sex):e===jl&&i&&d.push(i)}let m=n.filter(e=>{if(2!==e.length)return!0;if(!c.gender||Cn(c.gender))return!1;if(!p.has(e[0])||!p.has(e[1]))return!0;let t=e.map(e=>p.get(e)),r=An(c.gender)&&(!An(t[0])||!An(t[1]))||Nn(c.gender)&&(!Nn(t[0])||!Nn(t[1]));return En(c.gender)&&(t.sort(Mg),(!Nn(t[0])||!An(t[1]))&&(r=!0)),r});if(m.length)return{error:lr,invalidParticipantIdPairs:m};let f,h=n.map(e=>({participantId:u?.pop()??za(),participantRole:Qg,individualParticipantIds:e,participantType:jl})),g=r?h:h.filter(e=>!d.find(t=>2===Q(t,e.individualParticipantIds).length)),I=[];if(g){let e=AM({allowDuplicateParticipantIdPairs:r,participants:g,returnParticipants:!0,tournamentRecord:o});if(e.error)return e;I=e.participants||[],f=e.info}let U=Kg({participantIds:n.map(e=>{let t=I.find(t=>2===Q(t.individualParticipantIds,e).length);if(t)return t;let{participant:r}=Of({tournamentRecord:o,participantIds:e});return r}).map(e=>e.participantId),tournamentRecord:o,drawDefinition:s,entryStatus:i,entryStage:a,event:c});return g.length&&rn({payload:{participants:g},topic:Yd}),{...U,info:f,newParticipantIds:g.map(dd)}}function CM({entryStatus:e=Dp,unpairedParticipantIds:t=[],participantIdPairs:r=[],entryStage:i=Ho,tournamentRecord:n,event:a}){if(!n)return{error:Ie};if(!a)return{error:ot};let o=n.participants??[],s=o.filter(e=>e.participantType===Vl).map(e=>e.participantId),c=t.concat(...r).flat(1/0).filter(e=>!s.includes(e));if(c.length)return{error:lr,invalidParticipantIds:c};let u=r.filter(e=>2!==e.length);if(u.length)return{error:lr,invalidParticipantIdPairs:u};let d=o.filter(e=>e.participantType===jl).map(e=>e.individualParticipantIds),l=AM({participants:r.filter(e=>!d.find(t=>2===Q(t,e).length)).map(e=>({participantType:jl,participantRole:Qg,individualParticipantIds:e})),tournamentRecord:n});if(l.error)return l;let p=r.map(e=>{let{participant:t}=Of({tournamentRecord:n,participantIds:e});return t}).map(t=>({participantId:t,entryStatus:e,entryStage:i})),m=t.map(e=>({entryStatus:Cp,participantId:e,entryStage:i}));return a.entries=(a.entries??[]).filter(e=>e.entryStage===i),a.entries=a.entries.concat(...p,...m),{...ce}}n(wM,{addDrawEntries:()=>jg,addEventEntries:()=>Kg,addEventEntryPairs:()=>EM,destroyPairEntries:()=>lI,destroyPairEntry:()=>dI,modifyEntriesStatus:()=>Ch,modifyEventEntries:()=>CM,promoteAlternate:()=>DM,promoteAlternates:()=>bM,removeDrawEntries:()=>RM,removeEventEntries:()=>qg,setEntryPosition:()=>PM,setEntryPositions:()=>TM});var OM={};n(OM,{addDrawDefinition:()=>uR,addEvent:()=>xM,addFlight:()=>UR,assignSeedPositions:()=>dR,attachFlightProfile:()=>lR,categoryCanContain:()=>_a,deleteDrawDefinitions:()=>WM,deleteEvents:()=>hR,deleteFlightAndFlightDraw:()=>sR,deleteFlightProfileAndFlightDraws:()=>HM,generate:()=>kM,generateEventsFromTieFormat:()=>_M,getCategoryAgeDetails:()=>Fa,getEvent:()=>lM,getEventProperties:()=>uM,getEventStructures:()=>aU,getEventTimeItem:()=>Zl,getEvents:()=>dM,getFlightProfile:()=>Nf,getScaledEntries:()=>lD,modifyEvent:()=>gR,modifyEventMatchUpFormatTiming:()=>JM,modifyPairAssignment:()=>cR,mutate:()=>LM,query:()=>cM,refreshEventDrawOrder:()=>oR,removeEventMatchUpFormatTiming:()=>QM,removeScaleValues:()=>pR,removeSeeding:()=>fR,setEventDates:()=>iR,setEventDisplay:()=>mR,setEventEndDate:()=>rR,setEventStartDate:()=>tR,updateDrawIdsOrder:()=>aR,validateCategory:()=>xa});var kM={};n(kM,{generateEventsFromTieFormat:()=>_M});var FM={COLLEGE_D3:{collectionDefinitions:[{collectionName:"Doubles",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7@7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Singles",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1}],tieFormatName:"COLLEGE_D3",winCriteria:{valueGoal:5}},COLLEGE_DEFAULT:{collectionDefinitions:[{collectionName:"Doubles",collectionValue:1,matchUpCount:3,matchUpFormat:"SET1-S:6/TB7",matchUpType:"DOUBLES"},{collectionName:"Singles",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1}],tieFormatName:"COLLEGE_DEFAULT",winCriteria:{valueGoal:5}},COLLEGE_JUCO:{collectionDefinitions:[{collectionName:"Doubles",matchUpCount:3,matchUpFormat:"SET1-S:8/TB7",matchUpType:"DOUBLES",matchUpValue:1},{collectionName:"Singles",matchUpCount:6,matchUpFormat:"SET3-S:6/TB7",matchUpType:"SINGLES",matchUpValue:1}],tieFormatName:"COLLEGE_JUCO",winCriteria:{valueGoal:5}},DOMINANT_DUO:so,DOMINANT_DUO_MIXED:to,LAVER_CUP:mo,TEAM_DOUBLES_3_AGGREGATION:Ja,TIME_TENNIS_DUAL:ro,TIME_TENNIS_PRO_CIRCUIT:eo,USTA_BREWER_CUP:io,USTA_OZAKI_CUP:no,USTA_COLLEGE:co,USTA_GOLD_TEAM_CHALLENGE:Ka,USTA_INTERSECTIONAL:Za,USTA_LEVEL_1:uo,USTA_SECTION_BATTLE:Xa,USTA_SOUTHERN_LEVEL_5:Qa,USTA_TOC:fo,USTA_WTT_ITT:lo,USTA_ZONAL:po};function xM({suppressNotifications:e,tournamentRecord:t,internalUse:r,event:i}){if(!t)return{error:Ie};if(t.events||(t.events=[]),!i)return{error:ot};let{startDate:n,endDate:a}=t;if(!r&&(i.entries?.length||i.drawDefinitions?.length)){let e=wn({drawDefinitions:!!i.drawDefinitions?.length,entries:!!i.entries?.length});return{info:"entries/drawDefinitions cannot exist",error:gi,context:e}}let o={eventType:Vo,drawDefinitions:[],entries:[],startDate:n,endDate:a,...i};if(i.eventType===qo)if(i.tieFormat){let e=Ba({tieFormat:i.tieFormat});if(e.error)return e}else if(i.tieFormatName){if(!FM[i.tieFormatName])return{context:{tieFormatName:i.tieFormatName},error:gi};let e=Lo({isMock:t?.isMock,namedFormat:i.tieFormatName,event:i});o.tieFormat=e}if(o.eventId||(o.eventId=za()),t.events.reduce((e,t)=>e||t.eventId===o.eventId,void 0))return{error:ct};{let r=o;if(t.events.push(r),!e){let{topics:e}=cn();if(e.includes(Hd)){let e=Qf({event:i}).matchUps??[];Pl({tournamentId:t?.tournamentId,eventId:i.eventId,matchUps:e})}let{drawDefinitions:r,...n}=i;for(let t of r||[])bl({drawDefinition:t});!function({tournamentId:e,event:t}){t&&rn({payload:{tournamentId:e,event:t},key:t.eventId,topic:Kd})}({tournamentId:t?.tournamentId,event:n})}return{...ce,event:o}}}function _M(e){let t=$c(e,[{[Bc]:{[fc]:!0,[Zs]:!0}},{[Js]:!0}]);if(t.error)return t;let r=e.tieFormat||Lo({namedFormat:e.tieFormatName}),i=e.uuids||[Ya(r.collectionDefinitions.length)],n={[Mn]:[],[Tn]:[]};if(e.addEntriesFromTeams){let t=e.tournamentRecord.participants?.filter(e=>e.participantType===Bl)?.flatMap(e=>e.individualParticipantIds??[]);for(let r of e.tournamentRecord.participants??[])if(t?.includes(r.participantId)){let e=r.person?.sex;if(e&&kn(e)){let t=On(e);t&&n[t].push(r.participantId)}}}let a=[];for(let o of r.collectionDefinitions??[]){let t=i?.pop()?.toString()||za(),r=o.matchUpType,s=o.gender,c={matchUpFormat:o.matchUpFormat,eventName:o.collectionName,category:o.category,gender:s,eventType:r,eventId:t};if(e.addEntriesFromTeams){let t=r===jo?Cp:e.entryStatus||Dp,i=En(s)?[...n[Mn],...n[Tn]]:n[On(s)||Dn]??[];if(i.length){let e=Kg({participantIds:i,entryStatus:t,event:c});if(e.error)return e}}if(a.push(c),!1!==e.addEvents){let t=xM({internalUse:!0,tournamentRecord:e.tournamentRecord,event:c});if(t.error)return t}}return{...ce,events:a}}var LM={};function BM({removePriorValues:e=!0,status:t=Gm,statusObject:r,event:i}){if(!v(r))return{error:gi};let n=vg({event:i,status:t}),a=`${Vm}.${jm}`;return fv({timeItem:{itemValue:{[t]:{...n,...r}},itemType:a},removePriorValues:e,event:i})}function VM(e){let t=$c(e,[{[Js]:!0,[bc]:!0},{eventDataParams:!1,[_c]:Cc}]);if(t.error)return t;let{includePositionAssignments:r,removePriorValues:i,tournamentRecord:n,status:a=Gm,event:o,drawIdsToRemove:s,drawIdsToAdd:c}=e,{appliedPolicies:u}=up({tournamentRecord:n,event:o}),d={...u,...e.policyDefinitions},l=o?.drawDefinitions?.map(({drawId:e})=>e)??[],p=e.drawDetails?Object.keys(e.drawDetails):[],m=p.length?[]:e.drawIds,f=(c??[]).concat(...s??[],...m??[],...p),h=f.filter(e=>!l.includes(e));if(h.length)return Pn({result:{error:Pe},context:{invalidDrawIds:h}});let g=vg({event:o,status:a}),I=Object.keys(g?.drawDetails||{}).filter(e=>l.includes(e)).reduce((e,t)=>(e[t]=g.drawDetails[t],e),{});for(let y of l)if((!f.length||f.includes(y))&&(s?.includes(y)||m?.length&&!m.includes(y)?I[y]={...I[y],publishingDetail:{published:!1}}:(c?.includes(y)||m?.includes(y)||!m?.length)&&(I[y]={...I[y],publishingDetail:{published:!0}})),e.drawDetails?.[y]){let t=e.drawDetails[y],r=t.structureDetails??I[y].structureDetails,i=t.stageDetails??I[y].stageDetails??{},{structureIdsToRemove:n=[],structureIdsToAdd:a=[],publishingDetail:s={},stagesToRemove:c=[],stagesToAdd:u=[]}=t;if((a||u)&&(s.published=!0),I[y]={publishingDetail:s,structureDetails:r,stageDetails:i},a.length||n.length){let e=(o?.drawDefinitions?.find(e=>e.drawId===y)?.structures??[]).map(({structureId:e})=>e),t=(a??[]).concat(n??[]).filter(t=>!e.includes(t));if(t.length)return Pn({result:{error:et},context:{invalidStructureIds:t}});r=r??{};for(let i of e)n.includes(i)?r[i]={published:!1}:r[i]={published:!0};I[y].structureDetails=r}let d=(o?.drawDefinitions?.find(e=>e.drawId===y)?.structures??[]).map(({stage:e})=>e);if(u.length){for(let e of u)i[e]={published:!0};for(let e of d)i[e]||(i[e]={published:!1})}if(u.length||c.length){for(let e of c)i[e]={published:!1};for(let e of d)i[e]||(i[e]={published:!0})}(u.length||c.length)&&(I[y].stageDetails=i)}BM({statusObject:{drawDetails:I},removePriorValues:i,status:a,event:o});let{topics:U}=cn(),S=U.includes(ml),v=S||e.returnEventData?Zv({includePositionAssignments:r,...e.eventDataParams,usePublishState:!0,tournamentRecord:n,policyDefinitions:d,event:o})?.eventData:void 0;return S&&rn({payload:{eventData:v,tournamentId:n.tournamentId},topic:ml}),{...ce,eventData:v}}n(LM,{addDrawDefinition:()=>uR,addEvent:()=>xM,addFlight:()=>UR,assignSeedPositions:()=>dR,attachFlightProfile:()=>lR,deleteDrawDefinitions:()=>WM,deleteEvents:()=>hR,deleteFlightAndFlightDraw:()=>sR,deleteFlightProfileAndFlightDraws:()=>HM,modifyEvent:()=>gR,modifyEventMatchUpFormatTiming:()=>JM,modifyPairAssignment:()=>cR,refreshEventDrawOrder:()=>oR,removeEventMatchUpFormatTiming:()=>QM,removeScaleValues:()=>pR,removeSeeding:()=>fR,setEventDates:()=>iR,setEventDisplay:()=>mR,setEventEndDate:()=>rR,setEventStartDate:()=>tR,updateDrawIdsOrder:()=>aR,validateCategory:()=>xa});var GM="deleteDrawDefinitions",jM="autoSchedulingAudit",$M="deleteEvents",qM={AUTO_SCHEDULING_AUDIT:jM,DELETE_EVENTS:$M,DELETE_DRAW_DEFINITIONS:GM};function WM(e){if(!e.tournamentRecord)return{error:Ie};let t="deleteDrawDefinitions",r=e.drawIds??[],i=e.event,{autoPublish:n=!0,tournamentRecord:a,auditData:o,eventId:s,force:c}=e,{appliedPolicies:u}=up({tournamentRecord:a,event:i}),d={...u,...e.policyDefinitions},l=Array.isArray(r)?r[0]:void 0;if(!i){let e=Af({tournamentRecord:a,eventId:s,drawId:l});if(e.error)return e;i=e.event}let p=[],m=[],f=[];if(!i?.drawDefinitions)return Pn({info:"event has no drawDefinition",result:{...ce},stack:t});let h=i.drawDefinitions.map(({drawId:e})=>e);if(r.length||(r=h),r=r.filter(e=>h.includes(e)),!r.length)return Pn({info:"nothing to do; no matching drawIds in event.",result:{...ce},stack:t});let g,I=Wa(Nf({event:i}).flightProfile,!1,!0),U=({participantId:e,drawPosition:t,qualifier:r,bye:i})=>({bye:i,qualifier:r,drawPosition:t,participantId:e}),S=c??u?.[du]?.allowDeletionWithScoresPresent?.drawDefinitions,v=vg({event:i})??{},y=v.drawIds??(v.drawDetails&&Object.keys(v.drawDetails))??[],w=[],P=i.drawDefinitions.filter(e=>{if(r.includes(e.drawId)){let t=th({event:i,drawDefinition:e})?.matchUps??[];if(t.some(({score:e})=>ch({score:e}))&&!S)return w.push(e.drawId),!0;let{drawId:r,drawType:n,drawName:c}=e,u=I?.flights?.find(t=>t.drawId===e.drawId);u&&(u.drawEntries=u.drawEntries?.filter(e=>Bp.includes(e.entryStatus))),y.includes(r)&&(y=y.filter(e=>e!==r),g=!0);let d=Gd({stageSequence:1,drawDefinition:e,stage:Ho})?.structures?.[0],l=(d?_v({structureId:d.structureId,tournamentRecord:a,drawDefinition:e}):void 0)?.positionAssignments?.map(U),h=Gd({stage:Yo,drawDefinition:e})?.structures,v=h?.length?h.map(t=>{let r=t.stageSequence;return{positionAssignments:_v({structureId:t.structureId,tournamentRecord:a,drawDefinition:e})?.positionAssignments.map(U),stageSequence:r}}):void 0,P={action:GM,payload:{drawDefinitions:[e],eventId:s??i?.eventId,auditData:o}};f.push(P),p.push(wn({tournamentId:a.tournamentId,eventId:s??i?.eventId,qualifyingPositionAssignments:v,positionAssignments:l,auditData:o,drawType:n,drawName:c,drawId:r})),t?.forEach(({matchUpId:e})=>m.push(e))}return!r.includes(e.drawId)});if(w.length&&!c)return Pn({context:{drawIdsWithScoresPresent:w},result:{error:Ci},stack:t});if(i.drawDefinitions=P,I&&yu({event:i,extension:{name:Lu,value:I}}),mb({tournamentRecord:a}),g){let e={};for(let r of y)e[r]=v.drawDetails?.[r]??{published:!0};let t=BM({statusObject:{drawDetails:e},event:i});if(t.error)return{error:t.error}}if(f.length)if(un(Qd)){let e=a.tournamentId;rn({topic:Qd,payload:{tournamentId:e,detail:f}});let t=(Ql({element:i,itemType:xu})?.timeItem?.itemValue||0)+1;lv({element:i,timeItem:{itemType:xu,itemValue:t},removePriorValues:!0})}else!function({appliedPolicies:e,event:t,deletedDrawsDetail:r,auditData:i}){if(!1===e?.audit?.[xu])return;let{extension:n}=Ru({name:xu,element:t}),a={...i,deletedDrawsDetail:r},o={value:Array.isArray(n?.value)?n?.value.concat(a):[a],name:xu};Uu({element:t,extension:o})}({appliedPolicies:u,event:i,deletedDrawsDetail:p,auditData:o});if(m.length&&Tl({tournamentId:a?.tournamentId,matchUpIds:m}),r.forEach(e=>function({tournamentId:e,eventId:t,drawId:r}){return rn({payload:{drawId:r,tournamentId:e,eventId:t},topic:tl,key:r}),on({key:r}),{...ce}}({drawId:e})),n&&g){let t=VM({...e.eventDataParams,drawIdsToRemove:r,policyDefinitions:d,tournamentRecord:a,event:i});if(t.error)return{...ce,info:t.error}}return{...ce}}function HM({autoPublish:e=!0,tournamentRecord:t,auditData:r,event:i,force:n}){if(!t)return{error:Ie};if(!i)return{error:ot};let{flightProfile:a}=Nf({event:i});if(a){let o=a.flights?.map(({drawId:e})=>e).filter(Boolean),s=WM({eventId:i.eventId,tournamentRecord:t,autoPublish:e,auditData:r,drawIds:o,event:i,force:n});return s.error?s:Du({event:i,name:Lu})}return{...ce}}function YM(e){let{matchUpFormat:t,recoveryTimes:r,averageTimes:i,tournamentId:n,eventId:a}=e,o=e?.tournamentRecords??(e?.tournamentRecord&&{[e.tournamentRecord.tournamentId]:e.tournamentRecord})??{};if(!Object.keys(o).length)return{error:ge};let s,c=Object.keys(o).filter(e=>!n||n===e);if(n&&!c.includes(n))return{error:gi};for(let u of c){let e=o[u],{event:n}=Af({tournamentRecord:e,eventId:a});a&&n&&(s=!0);let c=zM({tournamentRecord:e,event:n,matchUpFormat:t,averageTimes:i,recoveryTimes:r});if(c.error)return c}return!a||s?{...ce}:{error:st}}function zM({tournamentRecord:e,recoveryTimes:t,matchUpFormat:r,averageTimes:i,event:n}){if(!e)return{error:Ie};if(i&&!Array.isArray(i))return{error:gi};if(t&&!Array.isArray(t))return{error:gi};let a=Yu;if(n){let{extension:e}=Ru({element:n,name:a});Uu({element:n,extension:{name:a,value:KM({...e?.value||{},matchUpFormat:r,averageTimes:i,recoveryTimes:t})}})}else{let{extension:n}=Ru({element:e,name:a});Uu({extension:{name:a,value:KM({...n?.value||{},matchUpFormat:r,averageTimes:i,recoveryTimes:t})},element:e})}return{...ce}}function KM(e){let{matchUpRecoveryTimes:t=[],matchUpAverageTimes:r=[],matchUpFormat:i}=e,{averageTimes:n,recoveryTimes:a}=e;n=(n||[]).filter(e=>e?.categoryNames?.length||e?.categoryTypes?.length);let o=n?.length&&r.map(e=>e?.matchUpFormatCodes.includes(i)?{...e,matchUpFormatCodes:e.matchUpFormatCodes?.filter(e=>e!==i)}:e).filter(({matchUpFormatCodes:e})=>e?.length).concat({matchUpFormatCodes:[i],averageTimes:n});a=(a||[]).filter(e=>e?.categoryNames?.length||e?.categoryTypes?.length);let s=a?.length&&t.map(e=>e?.matchUpFormatCodes.includes(i)?{...e,matchUpFormatCodes:e.matchUpFormatCodes?.filter(e=>e!==i)}:e).filter(({matchUpFormatCodes:e,averageTimes:t})=>e?.length||t).concat({matchUpFormatCodes:[i],recoveryTimes:a});return{matchUpAverageTimes:o?.length&&o||r,matchUpRecoveryTimes:s?.length&&s||t}}function JM(e){let{tournamentRecord:t,recoveryMinutes:r,averageMinutes:i,matchUpFormat:n,categoryType:a,eventId:o,event:s}=e;if(!t)return{error:Ie};if(!ta({matchUpFormat:n}))return{error:gi};if(!s)return{error:ot};let{averageTimes:c=[],recoveryTimes:d=[]}=kb({tournamentRecord:t,matchUpFormat:n,event:s}),l=s.category,p=l?.categoryName||l?.ageCategoryCode||s?.eventId,m={categoryNames:[p],minutes:{}},f={categoryNames:[p],minutes:{}},h=e=>{if(e.categoryTypes?.includes(a)&&console.log("encountered:",{categoryType:a}),!e.categoryNames?.includes(p)||(e.categoryNames=e.categoryNames.filter(e=>e!==p),m={minutes:e.minutes,categoryNames:[p]},e.categoryNames.length))return e},g=i&&!isNaN(I(i)),U=r&&!isNaN(I(r)),S=c.map(h).filter(e=>e?.categoryNames?.length),v=d.map(h).filter(e=>e?.categoryNames?.length);return g&&(Object.assign(m.minutes,{[s?.eventType||u]:i}),S.push(m)),U&&(Object.assign(f.minutes,{[s?.eventType||u]:r}),v.push(f)),g||U?YM({averageTimes:g&&S,recoveryTimes:U&&v,tournamentRecord:t,matchUpFormat:n,eventId:o,event:s}):{error:gi}}function QM(e){if(e.event)return XM({event:e.event});{e.tournamentRecord&&!e.tournamentRecords&&(e.tournamentRecords={[e.tournamentRecord.tournamentId]:e.tournamentRecord});let t=$c(e,[{[zs]:!0,[wc]:!0}]);if(t.error)return t;let{tournamentRecords:r,eventId:i}=e;for(let e of Object.values(r??{})){let{event:t}=Af({tournamentRecord:e,eventId:i});if(t)return XM({event:t})}}return{error:st}}function XM({event:e}){return Du({event:e,name:Yu})}var ZM={MON:"MON",TUE:"TUE",WED:"WED",THU:"THU",FRI:"FRI",SAT:"SAT",SUN:"SUN"};function eR(e){return!(!Array.isArray(e)||L(e).length!==e.length)&&e.every(e=>Object.keys(ZM).includes(e))}function tR({tournamentRecord:e,event:t,startDate:r}){if(!e)return{error:Ie};if(!t)return{error:ot};if(!na.test(r))return{error:Jt};let i=nR(e),n="setEventStartDate";if(i.error)return Pn({result:i,stack:n});let{tournamentStartDate:a,tournamentEndDate:o}=i,s=new Date(ya(r)).getTime();if(!a||!o||s<a||s>o)return Pn({result:{error:Jt},stack:n,info:"startDate must be within tournament start and end dates"});let c=t.endDate&&new Date(ya(t.endDate)).getTime();return c&&s>c&&(t.endDate=r),t.startDate=r,{...ce}}function rR(e){let{tournamentRecord:t,event:r,endDate:i}=e;if(!t)return{error:Ie};if(!r)return{error:ot};if(!na.test(i))return{error:Jt};let n=nR(t);if(n.error)return n;let{tournamentStartDate:a,tournamentEndDate:o}=n,s=new Date(ya(i)).getTime();if(!a||!o||s<a||s>o)return{error:Jt};let c=r.startDate&&new Date(ya(r.startDate)).getTime();return c&&s<c&&(r.startDate=i),r.endDate=i,{...ce}}function iR(e){let t="setEventDates",r=$c(e,[{tournamentRecord:!0,event:!0},{[kc]:e=>na.test(e),[xc]:Jt,startDate:!1,endDate:!1},{[kc]:e=>e.filter(Boolean).every(e=>na.test(e)),[xc]:Jt,activeDates:!1},{[kc]:eR,weekdays:!1}]);if(r.error)return r;let{tournamentRecord:i,weekdays:n,event:a,startDate:o,endDate:s}=e,c=e.activeDates?.filter(Boolean);if(o&&s){if(new Date(ya(o)).getTime()>new Date(ya(s)).getTime())return Pn({result:{error:gi},stack:t,info:"startDate cannot be after endDate"})}if(c){let e=o||i.startDate,r=s||i.endDate,n=!e||c.every(t=>new Date(t)>=new Date(e)),a=!r||c.every(e=>new Date(e)<=new Date(r));if(!n||!a)return Pn({result:{error:Jt},stack:t})}if(o){let e=tR({tournamentRecord:i,event:a,startDate:o});if(e.error)return Pn({result:e,stack:t})}if(s){let e=rR({tournamentRecord:i,event:a,endDate:s});if(e.error)return Pn({result:e,stack:t})}return c&&(a.activeDates=c),n&&(a.weekdays=n),{...ce}}function nR(e){let{startDate:t,endDate:r}=e;return na.test(t)&&na.test(r)?{tournamentStartDate:new Date(ya(t)).getTime(),tournamentEndDate:new Date(ya(r)).getTime()}:Pn({result:{error:Xt},context:{startDate:t,endDate:r}})}function aR({event:e,orderedDrawIdsMap:t}){if("object"!=typeof e)return{error:ot};if(!t)return{error:$t,info:"Missing drawIdsOrderMap"};if("object"!=typeof t)return{error:gi,info:"orderedDrawIdsMap must be an object"};let r=Object.values(t);if(!r.every(e=>!Number.isNaN(Number(e))))return{error:gi,info:"drawOrder must be numeric"};if(L(r).length!==r.length)return{info:"drawOrder values must be unique",error:gi};if(e.drawDefinitions?.length){let r=(e.drawDefinitions||[]).map(({drawId:e})=>e),i=Object.keys(t);if(i?.length&&Q(r,i).length!==r.length)return{error:gi,info:"Missing drawIds"};e.drawDefinitions.forEach(e=>{e.drawOrder=t[e.drawId]})}let{flightProfile:i}=Nf({event:e});return i?.flights?.forEach(e=>{e.flightNumber=t[e.drawId]}),{...ce}}function oR({tournamentRecord:e,event:t}){if(!e)return{error:Ie};if(!t)return{error:ot};let{flightProfile:r}=Nf({event:t}),i=r?.flights?.sort((e,t)=>e.flightNumber-t.flightNumber).map(e=>e.drawId).filter(Boolean),n=t.drawDefinitions?.sort((e,t)=>e.drawOrder-t.drawOrder).map(e=>e.drawId).filter(Boolean).filter(e=>!i?.includes(e)),a=Object.assign({},...[...i||[],...n||[]].map((e,t)=>({[e]:t+1})));return a?aR({event:t,orderedDrawIdsMap:a}):{...ce}}function sR({autoPublish:e=!0,tournamentRecord:t,auditData:r,drawId:i,event:n,force:a}){if(!t)return{error:Ie};if(!i)return{error:Ge};if(!n)return{error:ot};let{flightProfile:o}=Nf({event:n});if(o&&o.flights?.find(e=>e.drawId===i)){let e=o.flights.filter(e=>e.drawId!==i);yu({event:n,extension:{name:Lu,value:{...o,flights:e}}})}if(n.drawDefinitions?.find(e=>e.drawId===i)){let o=WM({drawIds:[i],eventId:n.eventId,tournamentRecord:t,autoPublish:e,auditData:r,event:n,force:a});if(o.error)return o}return oR({tournamentRecord:t,event:n})}function cR(e){let t=$c(e,[{[bc]:!0,[Js]:!0,[Rc]:!1},{replacementIndividualParticipantId:!0,[kc]:e=>S(e),existingIndividualParticipantId:!0,[Dc]:Ir,participantId:!0}]),{replacementIndividualParticipantId:r,existingIndividualParticipantId:i,tournamentRecord:n,drawDefinition:a,participantId:o,event:s,uuids:c}=e;if(t.error)return t;if(s?.eventType!==Go)return{error:at};if(!(s?.entries?.filter(({entryStatus:e})=>[Cp,Op].includes(e)).map(({participantId:e})=>e)||[]).includes(r))return{error:dr};let u=(n.participants||[]).find(e=>e.participantId===o);if(u?.participantType!==jl)return{error:ur,participant:u};let d,l=u.individualParticipantIds,p=[r,...l.filter(e=>e!==i)],{participant:m}=Of({participantIds:p,tournamentRecord:n});if(m)d=m.participantId;else{let e=NM({participant:{participantId:c?.pop(),participantRole:Qg,individualParticipantIds:p,participantType:jl},returnParticipant:!0,tournamentRecord:n});if(e.error)return e;d=e.participant.participantId}let{flightProfile:f}=Nf({event:s});if(a){let e=f?.flights?.find(({drawId:e})=>e===a.drawId);e&&(e.drawEntries=e.drawEntries.map(e=>e.participantId===o?{...e,participantId:d}:e)),a.entries=a.entries.map(e=>e.participantId===o?{...e,participantId:d}:e);for(let t of a.structures||[])if(t.structures){t.positionAssignments=void 0;for(let e of t.structures)e.positionAssignments=e.positionAssignments.map(e=>e.participantId===o?{...e,participantId:d}:e)}else t.positionAssignments&&(t.positionAssignments=t.positionAssignments.map(e=>e.participantId===o?{...e,participantId:d}:e))}s.entries=s.entries.map(e=>e.participantId===o&&{...e,participantId:d}||e.participantId===r&&{...e,participantId:i}||e);let h=n.events.some(({entries:e,eventId:t,drawDefinitions:r})=>s.eventId===t?r.some(({drawId:e,entries:t})=>e!==a?.drawId&&t?.find(e=>e.participantId===o)):e?.find(e=>e.participantId===o));if(!h){let e=sI({addIndividualParticipantsToEvents:!1,participantIds:[o],tournamentRecord:n});if(e.error)return e}return{...ce,participantOtherEntries:h,newPairParticipantId:d}}function uR(e){let{flight:t,suppressNotifications:r,modifyEventEntries:i,existingDrawCount:n,allowReplacement:a,checkEntryStatus:o,tournamentRecord:s,drawDefinition:c,event:u}=e;if(!c)return{error:ye};if(!u)return{error:ot};u.drawDefinitions||(u.drawDefinitions=[]);let{drawId:d,drawName:l,entries:p}=c,{entries:m}=u,f=0;if(void 0!==n&&n!==u.drawDefinitions.length)return{error:gi,info:"drawDefintions count mismatch"};let{flightProfile:h}=Nf({event:u}),g=t&&h?.flights?.find(e=>e.flightNumber===t.flightNumber),U=h?.links?.find(e=>e?.target?.drawId===d)?.source?.drawId;if(U&&!u.drawDefinitions.find(e=>e.drawId===U))return Pn({result:{error:ye},info:{sourceDrawId:U}});if(g&&g.drawId!==c.drawId)return Pn({result:{error:ve},info:{relevantFlight:g}});let S=p?.every(({participantId:e,entryStatus:t})=>{let r=g?.drawEntries.find(t=>t.participantId===e);return!t||r?.entryStatus===t}),v=!o||m&&p?.every(({participantId:e,entryStatus:t,entryStage:r})=>m.find(t=>t.participantId===e&&(!t.entryStage||t.entryStage===r))?.entryStatus===t);if(g&&!S)return Pn({result:{error:ve},context:{drawEntriesPresentInFlight:S,matchingEventEntries:v,relevantFlight:g},info:"Draw entries are not present in flight or do not match entryStatuses"});if(i&&p?.filter(Boolean).forEach(e=>{if(e?.entryStatus&&Bp.includes(e?.entryStatus)){let t=m?.filter(Boolean).find(t=>t.participantId===e.participantId);t&&e.entryStatus&&t?.entryStatus!==e.entryStatus&&(t.entryStatus=e.entryStatus,f+=1)}}),m&&!v)return Pn({result:{info:"Draw entries do not match event entryStatuses",context:{matchingEventEntries:v,eventEntries:m},error:ve}});let y,w=h?.flights?.map(({flightNumber:e})=>!isNaN(e)&&I(e))?.filter(Boolean)||[],P=u.drawDefinitions.map(({drawOrder:e})=>e&&I(e))?.filter(Boolean)||[],T=Math.max(0,...P,...w)+1,D=h?.flights?.find(e=>e.drawId===d);if(D){D.drawName=c.drawName,y={name:Lu,value:{...h,flights:h.flights}};let e=D.flightNumber;e&&!P.includes(e)?T=e:D.flightNumber=T}else{let e=h?.flights||[];e.push({manuallyAdded:!0,flightNumber:T,drawEntries:p,drawName:l,drawId:d}),y={name:Lu,value:{...h||{},flights:e}}}yu({event:u,extension:y}),Object.assign(c,{drawOrder:T});let b=u.drawDefinitions.find(e=>e.drawId===d),M=s?.tournamentId,R=u.eventId;if(b){if(!a)return{error:je};let e=th({drawDefinition:b})?.matchUps?.map(ld)??[],t=th({drawDefinition:c})?.matchUps;if(!r){e?.length&&Tl({matchUpIds:e,action:"modifyDrawDefinition",tournamentId:M,eventId:R}),t?.length&&Pl({matchUps:t,tournamentId:M,eventId:R}),u.drawDefinitions=u.drawDefinitions.map(e=>e.drawId===d?c:e);let r=c.structures?.map(({structureId:e})=>e);Ml({drawDefinition:c,tournamentId:M,structureIds:r,eventId:R})}}else if(u.drawDefinitions.push(c),!r){let{matchUps:e}=th({drawDefinition:c,event:u});e&&Pl({tournamentId:s?.tournamentId,matchUps:e}),bl({drawDefinition:c,tournamentId:M,eventId:R})}return{...ce,modifiedEventEntryStatusCount:f}}function dR(e){let{provisionalPositioning:t,useExistingSeedLimit:r,tournamentRecord:i,drawDefinition:n,seedingProfile:a,structureId:o,assignments:s,drawId:c,event:u}=e,d=0;if(!s?.length)return{error:lt};if(!i)return{error:Ie};if(!c)return{error:Ge};let l=Wp({provisionalPositioning:t,drawDefinition:n,structureId:o});if(l.error)return l;let{seedAssignments:p,seedLimit:m}=l,f=Object.assign({},...(p??[]).filter(e=>e.seedNumber).map(e=>({[e.seedNumber]:e})));s.forEach(e=>{let{seedNumber:t}=e;m&&t<=m&&(!r||f[t])&&(f[t]=e)});let h=Object.values(f),g=h.map(e=>e?.participantId).filter(Boolean);if(g.length!==H(g).length)return{error:$e};for(let I of h){let e=xI({...I,provisionalPositioning:t,tournamentRecord:i,drawDefinition:n,seedingProfile:a,structureId:o,event:u});if(e?.error)return e;e?.success&&d++}return d?{...ce,modifications:d}:{error:ci}}function lR({deleteExisting:e,event:t,flightProfile:r}){let i="attachFlightProfile";if(!r)return Pn({result:{error:$t},stack:i});if(!t)return Pn({result:{error:ot},stack:i});let{flightProfile:n}=Nf({event:t});return n&&!e?Pn({result:{error:Di},stack:i}):t.drawDefinitions?.length?Pn({result:{error:we},stack:i}):(yu({event:t,extension:{name:Lu,value:r}}),{flightProfile:Wa(r,!1,!0),...ce})}function pR({tournamentRecord:e,scaleAttributes:t,drawDefinition:r,entryStatuses:i,drawId:n,event:a,stage:o}){if(!a)return{error:ot};if(i&&!Array.isArray(i))return Pn({result:{error:gi},info:WI("entryStatus"),stack:"removeScaleValues"});let s=a.entries;if(n){let{flightProfile:e}=Nf({event:a}),t=e?.flights?.find(e=>e.drawId===n);s=t?t.drawEntries:r?.entries}return function({tournamentRecord:e,scaleAttributes:t,participantIds:r}){if(!e)return{error:Ie};if(!r)return{error:wr};if(!t)return{error:$t,info:"scaleAttributes required"};let{scaleType:i,eventType:n,scaleName:a}=t,o=[xm,i,n,a].join(".");return e.participants?.forEach(e=>{r.includes(e.participantId)&&e.timeItems&&(e.timeItems=e.timeItems.filter(e=>e&&e?.itemType!==o))}),{...ce}}({tournamentRecord:e,scaleAttributes:t,participantIds:(s||[]).filter(e=>(!o||!e.entryStage||e.entryStage===o)&&(!i||i.includes(e.entryStatus))).map(dd)})}function mR({removePriorValues:e,tournamentRecord:t,displaySettings:r,status:i=Gm,event:n}){if(!t)return Pn({result:{error:Ie}});if(!n)return Pn({result:{error:ot}});if(!v(r))return Pn({result:{error:$t}});if(v(r.draws))for(let o of Object.keys(r.draws)){let e=r.draws[o].scheduleDetails??[];if(e.length){let t=[];for(let r of e){let e=t.find(e=>y(e.attributes,r.attributes));e?.dates&&r.dates?e.dates.push(...r.dates):t.push(r)}r.draws[o].scheduleDetails=t}}let a=BM({statusObject:{displaySettings:r},removePriorValues:e,status:i,event:n});return a.error?a:{...ce}}function fR({tournamentRecord:e,drawDefinition:t,entryStatuses:r,scaleName:i,drawId:n,event:a,stage:o}){if(!e)return{error:Ie};if(!a)return{error:ot};return i=i||a.category?.categoryName||a.category?.ageCategoryCode,pR({tournamentRecord:e,scaleAttributes:{eventType:a.eventType,scaleType:Kc,scaleName:i},drawDefinition:t,entryStatuses:r,drawId:n,event:a,stage:o})}function hR(e){let t=$c(e,[{[Js]:!0},{eventIds:!0,[_c]:Oc}]);if(t.error)return t;let{removePairParticipants:r,tournamentRecord:i,eventIds:n}=e,a=[],o=[],s=[],c=[];if(i.events=(i.events||[]).filter(e=>{if(n.includes(e.eventId)){let t={action:$M,payload:{events:[e]}};a.push(t),o.push({tournamentId:i.tournamentId,eventName:e.eventName,eventType:e.eventType,category:e.category,eventId:e.eventId,gender:e.gender})}let t=e.eventType===Go?(e.entries||[]).map(({entryStatus:e,participantId:t})=>e!==Cp&&t).filter(Boolean):[],r=n.includes(e.eventId);return r?c.push(...t):s.push(...t),!r}),r){let e=c.filter(e=>!s.includes(e));i.participants=i.participants.filter(({participantId:t})=>!e.includes(t))}if(mb({tournamentRecord:i}),a.length)if(un(Qd)){let e=i.tournamentId;rn({topic:Qd,payload:{type:$M,tournamentId:e,detail:a}})}else mv({tournamentRecord:i,timeItem:{itemValue:o,itemType:$M}});return{...ce}}function gR(e){let t=$c(e,[{tournamentRecord:!0,eventId:!0,event:!0},{eventUpdates:!0,_ofType:Cc}]);if(t.error)return t;let{eventUpdates:r,event:i}=e,n="modifyEvent",a=function(e){let{tournamentRecord:t,event:r}=e,i=r?.entries?.filter(({entryStatus:e})=>{let t=e;return[...Bp,Pp].includes(t)}).map(({participantId:e})=>e)??[];return i?Ag({participantFilters:{participantIds:i},withIndividualParticipants:!0,tournamentRecord:t}).participants??[]:[]}(e),o=function({enteredParticipants:e}){let t=[],r=e.reduce((e,r)=>{let i=r.person?.sex?[r.person.sex]:r.individualParticpants?.map(e=>e.person?.sex)||[];return t.push(...i),e.includes(r.participantType)?e:e.concat(r.participantType)},[]),i=L(t);return{enteredParticipantTypes:r,enteredParticipantGenders:i}}({enteredParticipants:a}),{enteredParticipantGenders:s,enteredParticipantTypes:c}=o,u=Nf({event:i})?.flightProfile?.flights,d=function({noFlightsNoDraws:e,enteredParticipantGenders:t,eventUpdates:r,stack:i}){let n=!t.length||!r.gender||Cn(r.gender)||1===t.length&&t[0]===r.gender||e&&En(r.gender);return r.gender&&!n?Pn({context:{gender:r.gender,validGender:n},result:{error:fi},stack:i}):{...ce}}({noFlightsNoDraws:!i.drawDefinitions?.length&&!u?.length,enteredParticipantGenders:s,eventUpdates:r,stack:n});if(d.error)return d;let l=function({enteredParticipantTypes:e,eventUpdates:t,stack:r}){let i=(e.includes($o)&&[$o]||e.includes(Vl)&&[Bo]||e.includes(jl)&&[Go]||[Go,Bo,$o]).includes(t.eventType??"");return t.eventType&&!i?Pn({context:{participantType:t.eventType,validEventType:i},result:{error:at},stack:r}):{...ce}}({enteredParticipantTypes:c,eventUpdates:r,stack:n});if(l.error)return l;let p=function(e){let t=e.eventUpdates?.category;if(!t)return{...ce};let r=xa({category:t});if(r.error)return r;if(e.event.eventType===$o){let t=function(e){let t=e.event?.drawDefinitions?.map(e=>Hp(e))??[],r=Hp(e.event),i=(Qf(e)?.matchUps??[]).map(e=>Hp(e))??[];return[r,...t,...i].filter(Boolean).every(t=>t.collectionDefinitions.every(t=>!t.category||_a({category:e.eventUpdates.category,childCategory:t.category})))?{...ce}:Pn({result:{error:hi},stack:e.stack})}(e);if(t.error)return t}if(e.enteredParticipants?.length){let r=function(e,t){let r=e.eventUpdates.startDate||e.event.startDate||e.tournamentRecord.startDate,i=e.eventUpdates.endDate||e.event.endDate||e.tournamentRecord.endDate,n=e.enteredParticipants.flatMap(e=>e.participantType===Vl?[e]:e.individualParticpants??[]),a=Fa({category:t,consideredDate:r}),o=Fa({category:t,consideredDate:i});if(a?.ageMinDate||a?.ageMaxDate||o?.ageMinDate||o?.ageMaxDate)for(let s of n){let t=s.person?.birthDate;if(!t)return Pn({result:{error:qt},stack:e.stack});let r=new Date(t).getTime(),i=IR(r,a,e.stack);if(i)return i;let n=IR(r,o,e.stack);if(n)return n}return{...ce}}(e,t);if(r.error)return r}return{...ce}}({...e,...o,enteredParticipants:a,stack:n});if(p.error)return p;let m=function(e){let{tournamentRecord:t,eventUpdates:r,event:i,stack:n}=e;if(r.startDate||r.endDate){let e=iR({startDate:r.startDate||i.startDate||t.startDate,endDate:r.endDate||i.endDate||t.endDate,tournamentRecord:t,event:i});if(e.error)return Pn({result:e,stack:n})}return{...ce}}({...e,stack:n});return m.error?m:(r.eventType&&(i.eventType=r.eventType),r.eventName&&(i.eventName=r.eventName),r.gender&&(i.gender=r.gender),{...ce})}function IR(e,t,r){if(!t)return null;if(t.ageMinDate||t.ageMaxDate){let i=new Date(t.ageMinDate).getTime(),n=new Date(t.ageMaxDate).getTime();if(e<i||e>n)return Pn({result:{error:sr},stack:r})}return null}function UR({qualifyingPositions:e,drawEntries:t=[],drawName:r,drawId:i,event:n,stage:a}){let o="addFlight";if(!n)return Pn({result:{error:ot},stack:o});if(!r)return Pn({result:{error:$t},stack:o});if(t?.length){let e=(n.entries??[]).map(dd),r=t.map(dd);if(Q(r,e).length!==r.length)return Pn({result:{error:gi},stack:o})}let s=Nf({event:n})?.flightProfile,c=s?.flights?.map(({flightNumber:e})=>!isNaN(e)&&I(e))?.filter(Boolean)||[],u=Math.max(0,...c)+1,d={drawId:i||za(),flightNumber:u,drawEntries:t,drawName:r};if(a&&(d.stage=a),e&&(d.qualifyingPositions=e),(s?.flights||[]).find(({drawId:e})=>e===d.drawId))return Pn({result:{error:Ti},stack:o});let l=(s?.flights||[]).concat(d);return yu({event:n,extension:{name:Lu,value:{...s||{},flights:l}}})}var SR={};n(SR,{drawMatic:()=>uD,garman:()=>FR,generateAdHocMatchUps:()=>sw,generateAdHocRounds:()=>sD,generateAndPopulatePlayoffStructures:()=>uv,generateCourts:()=>kR,generateDrawDefinition:()=>hM,generateDrawMaticRound:()=>gw,generateDrawStructuresAndLinks:()=>Jy,generateDrawTypeAndModifyDrawDefinition:()=>Qy,generateFlightProfile:()=>PR,generateLineUps:()=>OR,generateQualifyingStructure:()=>bS,generateSeedingScaleItems:()=>SM,generateStatCrew:()=>bR,generateVoluntaryConsolation:()=>Iw,roundRobinGroups:()=>PI});var vR="splitWaterfall",yR="splitShuttle",wR={SPLIT_LEVEL_BASED:"splitLevelBased",SPLIT_WATERFALL:vR,SPLIT_SHUTTLE:yR};function PR(e){let{drawNameRoot:t="Flight",attachFlightProfile:r,tournamentRecord:i,scaleAttributes:n,scaleSortMethod:a,deleteExisting:o,sortDescending:s,drawNames:c=[],flightsCount:u,splitMethod:d,uuids:l=[],event:p,stage:m}=e;if(!p)return{error:ot};let f=p.entries??[],{flightProfile:h}=Nf({event:p});if(h&&r&&!o)return{error:Di};let g=e.scaledEntries??lD({tournamentRecord:i,scaleAttributes:n,scaleSortMethod:a,sortDescending:s,event:p,stage:m}).scaledEntries,I=new Set(g.map(dd)),U=V(f.filter(({participantId:e})=>!I.has(e)).filter(e=>(!m||!e.entryStage||e.entryStage===m)&&(!e.entryStatus||Lp.includes(e.entryStatus)))),S=g.concat(...U),v=S.length,y=re(S,Math.ceil(v/u));function w(e){return(e||[]).map(({participantId:e,scaleValue:t})=>{let r=f.find(t=>t.participantId===e);return r?.scaleValue&&t&&(r.scaleValue=t),r}).sort((e,t)=>e.scaleValue-t.scaleValue).map((e,t)=>(e.scaleValue&&(e.seedNumber=t+1),e))}d===vR?y=oe(S,u):d===yR&&(y=oe(S,u,!0));let P={scaleAttributes:n,splitMethod:d,flights:K(0,u).map(e=>{let r=e+1;return{flightNumber:r,drawId:l?.pop()??za(),drawEntries:w(y[e]),drawName:c?.length&&c[e]||`${t} ${r}`}})};if(r){let e=lR({flightProfile:P,deleteExisting:o,event:p});return{splitEntries:$i()&&y||void 0,...e}}return{flightProfile:P,...ce}}function TR({json:e,tagName:t}){let r=Object.keys(e).filter(t=>Array.isArray(e[t])).map(t=>({key:t,value:e[t].filter(e=>"object"==typeof e&&1===Object.keys(e).length)})),i=Object.keys(e).filter(t=>"object"==typeof e[t]&&!Array.isArray(e[t])).map(t=>({key:t,value:e[t]}));return DR({tagName:t,attributes:Object.keys(e).filter(t=>["string","number"].includes(typeof e[t])).map(t=>({key:t,value:e[t]})),childArrays:r,childObjects:i})}function DR(e){let{tagName:t,attributes:r=[],childArrays:i=[],childObjects:n}=e,a="\r\n",o=e=>{let t=Object.keys(e)[0];return{key:t,value:e[t]}},s=i?.map(({key:e,value:t})=>DR({tagName:e,childObjects:t.map(o)})).join("\r\n"),c=n?.map(({key:e,value:t})=>TR({tagName:e,json:t??[]})).join("\r\n"),u=r?.map(({key:e,value:t})=>`${e}="${t}"`).join(" ");return"childArray"===t?c:`<${t}${u?` ${u}`:""}>${c?.length?`${a}${c}${a}`:""}${s?.length?`${a}${s}${a}`:""}</${t}>`}function bR(e){let t=$c(e,[{[Js]:!0}]);if(t.error)return t;let{tournamentRecord:r}=e,{startDate:i,tournamentId:n,tournamentName:a}=r,{participantMap:o,matchUps:s,mappedMatchUps:c}=Ag({withMatchUps:!0,withEvents:!0,tournamentRecord:r}),d=r.participants.filter(e=>e.participantType===$l),p=s?.filter(e=>e.matchUpType===$l)??[],m=p?.reduce((e,t)=>{let r=t?.tieMatchUps??[];return r&&[...e,...r]},[])??[],f=s?.filter(e=>e.matchUpType===u)??[],h=s?.filter(e=>e.matchUpType===l)??[],g=m.length===f.length+h.length,I=1===p.length&&g,U={mappedMatchUps:c,participantMap:o,tournamentName:a,tournamentId:n,tournament:g?"N":"Y",startDate:i},S=[],v=[];if(I){let e=p[0],{json:t,xml:r}=MR({teamParticipants:d,teamMatchUp:e,...U,doubles:h,singles:f});v.push(t),S.push(r)}else for(let y of p){let e=y?.sides?.map(({participant:e})=>e?.participantId).filter(Boolean);if(2!==e?.length)continue;let t=e.map(e=>e&&o?.[e]?.participant),{xml:r,json:i}=MR({doubles:y.tieMatchUps?.filter(e=>e.matchUpType===l),singles:y.tieMatchUps?.filter(e=>e.matchUpType===u),teamParticipants:t,teamMatchUp:y,...U});v.push(i),S.push(r)}return{json:v,xml:S,...ce}}function MR({teamParticipants:e,mappedMatchUps:t,participantMap:r,tournamentName:i,tournamentId:n,teamMatchUp:a,tournament:o,startDate:s,doubles:c,singles:u}){let d=e?.find(e=>e.participantRoleResponsibilities?.includes("Home")),l=e?.filter(e=>e.participantId!==d?.participantId),p=la(s,"/","MDY"),m=d?.participantName||l?.[1]?.participantName,f=d?.participantId||l?.[1]?.participantId,h=l?.[0]?.participantName,g=l?.[0]?.participantId,I={},U=e.map(e=>({team:{...NR({teamParticipant:e,teamMatchUp:a,uniValues:I,participantMap:r,mappedMatchUps:t,homeid:f})}})),S=wn({venue:{tournamentname:o?i:void 0,neutralgame:d?"N":"Y",gameid:n,officials:{},tournament:o,rules:{},homename:m,visname:h,homeid:f,visid:g,date:p},childArray:U,singles_matches:u?.map(e=>AR({matchUp:e,homeid:f,uniValues:I})),doubles_matches:c?.map(e=>AR({matchUp:e,homeid:f,uniValues:I}))});return{json:S,xml:TR({json:S,tagName:"tngame"})}}function RR({homeid:e,uniValues:t,participant:r}){if(!r)return{};let i=2===r.individualParticipants?.length,n=i?L(r.individualParticipants?.map(e=>e.teams?.[0]?.participantId)):[],a=i?L(r.individualParticipants?.map(e=>e.teams?.[0]?.teamId)):[],o=!i&&r.teams?.[0]?.participantId||1===n?.length&&n[0]||void 0,s=!i&&r.teams?.[0]?.teamId||1===a?.length&&a[0]||o,c=i?void 0:r.participantName,u=r.individualParticipants?.[0]?.participantName,d=r.individualParticipants?.[1]?.participantName;return wn({vh:e&&(o===e?"H":"V")||"",uni:i?void 0:t[o][r.participantId],uni_1:t[o][r.individualParticipants?.[0]?.participantId],uni_2:t[o][r.individualParticipants?.[1]?.participantId],team:s,name:c,name_1:u,name_2:d})}function NR({teamParticipant:e,teamMatchUp:t,participantMap:r,mappedMatchUps:i,homeid:n,uniValues:a}){let{participantId:o,participantName:s}=e,c=n&&(o===n?"H":"V")||"",d=r?.[o]?.matchUps,p=d&&Object.keys(d),m=t?.sides?.find(({participant:e})=>e.participantId===o)?.sideNumber,f=t?.score?.sets?.[0]?.[`side${m}Score`]??0;a[o]={};let h={SINGLES:{w:0,l:0},DOUBLES:{w:0,l:0}},g=[],I=[],U=0;for(let w of p??[]){let e=i?.[w],t=e.sides.find(({participant:e})=>e.participantId===o)?.sideNumber;U+=e.score?.sets?.[0]?.[`side${t}Score`]??0;for(let r of e.tieMatchUps??[]){let{matchUpType:e,winningSide:i}=r,n=i&&(i===t?"w":"l")||"";n&&(h[e][n]+=1);let a="w"===n?"1":"0",o="l"===n?"1":"0";if(e===u){let e=I.length+1;I.push({singles_pair:{pair:e,won:a,lost:o,tied:"0"}})}else if(e===l){let e=g.length+1;g.push({doubles_pair:{pair:e,won:a,lost:o,tied:"0"}})}}}let S=[{singles:{childArray:I,won:h.SINGLES.w,lost:h.SINGLES.l}},{doubles:{childArray:g,won:h.DOUBLES.w,lost:h.DOUBLES.l}}],v=[],y=1;for(let u of e.individualParticipantIds){let e=r?.[u];if(e){let{participant:t,counters:r}=e,i={won:r?.DOUBLES?.wins||0,lost:r?.DOUBLES?.losses||0},n={won:r?.SINGLES?.wins||0,lost:r?.SINGLES?.losses||0},{participantName:s,participantId:c}=t;a[o][c]=y,v.push({player:{name:s,uni:y,singles:n,doubles:i}})}y+=1}return{vh:c,id:o,name:s,score:f||U,totals:S,childArray:v}}function AR({matchUp:e,homeid:t,uniValues:r}){let{collectionPosition:i,orderOfFinish:n,matchUpType:a,sides:o}=e??{},s=o?.map(i=>{let{sideNumber:n,participant:o}=i,s=function({sets:e,sideNumber:t}){return Object.assign({},...e?.map(e=>{let{setNumber:r,side1Score:i,side2Score:n,side1TiebreakScore:a,side2TiebreakScore:o}=e,s=`set_${r}`,c=`tie_${r}`,u=1===t?i:n,d=1===t?a:o;return{[s]:u,[c]:d}})??[])}({sets:e.score?.sets,sideNumber:n});return{[a===u?"singles_score":"doubles_score"]:{...RR({homeid:t,uniValues:r,participant:o}),...s}}});return{[a===u?"singles_match":"doubles_match"]:{match:i,order:n,childArray:s}}}var ER="DESC",CR={ASC:"ASC",ASCENDING:"ASC",DESC:"DESC",DESCENDING:ER};function OR(e){let{tieFormat:t}=e,{useDefaultEventRanking:r,tournamentRecord:i,drawDefinition:n,scaleAccessor:a,singlesOnly:o,attach:s,event:u}=e;if(u?.eventType!==qo)return{error:at};if(!i)return{error:Ie};if(!t&&!n)return{error:Pe};if(t=t??zp({drawDefinition:n,event:u})?.tieFormat,Ba({tieFormat:t}).error)return{error:wt};if("object"!=typeof a&&!r)return{error:gi,context:{scaleAccessor:a}};let l={},p=(n?.entries??u?.entries??[]).filter(e=>e?.entryStatus===Dp).map(dd),{participants:m=[]}=Ag({withIndividualParticipants:!0,withScaleValues:!0,tournamentRecord:i}),f=m.filter(({participantId:e})=>p.includes(e)),h=u?.category?.categoryName??u?.category?.ageCategoryCode,{scaleName:g=h,scaleType:I=Hc,sortOrder:U,accessor:S}=a||{},v=I===Hc?"rankings":"ratings",y=(e,t)=>{let i=e[v]?.[t];if(!i&&r&&(i=e[v]?.[c]),Array.isArray(i)){let e=i.find(e=>e.scaleName===g)?.scaleValue;if(E(e))return e;if(S&&"object"==typeof e)return e[S]}return 0},w=(e,t,r)=>{let i=U===ER?e:t;return y(U===ER?t:e,r)-y(i,r)},P=(e,t)=>w(e,t,c),T=(e,t)=>w(e,t,d),D=[],b=t?.collectionDefinitions??[];for(let d of f){let e=d.individualParticipants?.sort(P)??[],t=o?e:d.individualParticipants?.sort(T)??[],r={};for(let n of b){let i=[],{collectionId:a,matchUpCount:o,matchUpType:s,gender:u}=n,d=Wm(c)(s);K(0,o).forEach(n=>{let o=d?e:t??[],s=n+1,c=[];K(0,d?1:2).forEach(e=>{let t=o?.find(t=>{let r=On(u),n=r&&(kn(u)&&r||En(u)&&[Mn,Tn][e]);return!(n&&n!==t.person?.sex||i.includes(t.participantId))})?.participantId;t&&(c.push(t),i.push(t),r[t]||(r[t]=[]),r[t].push({collectionPosition:s,collectionId:a}))}),d||D.push(c)})}let i=Object.keys(r).map(e=>({collectionAssignments:r[e],participantId:e}));l[d.participantId]=i}let M=[];for(let c of D){let{participant:e}=Of({tournamentParticipants:m,participantIds:c});if(!e){let e={individualParticipantIds:c,participantRole:Qg,participantType:jl};M.push(e)}}if(s){for(;M.length;)NM({participant:M.pop(),tournamentRecord:i});Uu({element:n,extension:{name:Vu,value:l}})}return{...ce,lineUps:l,participantsToAdd:M}}function kR(e){if(!e)return{error:$t};let t=$c(e,[{dates:!1,[kc]:e=>Array.isArray(e)&&e.every(ua)},{uuids:!1,[kc]:e=>Array.isArray(e)&&e.every(S)},{startTime:!1,endTime:!1,[kc]:Ia},{idPrefix:!1,namePrefix:!1,[kc]:S},{count:!0,[kc]:E}]);if(t.error)return t;let{startDate:r,endDate:i}=e.tournamentRecord??{},n=e.dates||r&&i&&fa(r,i)||[],a=K(1,e.count+1).map(t=>wn({courtId:e.uuids?.pop()??(e.idPrefix&&`${e.idPrefix}-${t}`)??za(),courtName:e.courtNames?.pop()??(e.namePrefix&&`${e.namePrefix} ${t}`),dateAvailability:n.map(t=>({startTime:e.startTime??"08:00",endTime:e.endTime??"20:00",date:t}))}));return{...ce,courts:a}}var FR={};function xR(e){let t=$c(e,[{courtDate:!0,_ofType:Cc}]);if(t.error)return t;let{includeBookingTypes:r=[],courtDate:i}=e,n=[],a=Ma(i.startTime);(i.bookings||[]).filter(e=>!e.bookingType||!r.includes(e.bookingType)).sort((e,t)=>(Sa(e.startTime)||"").localeCompare(Sa(t.startTime)||"")).forEach(e=>{let t={startTime:va(a.toISOString()),endTime:e.startTime};Ma(e.startTime)>a&&n.push(t),Ma(e.endTime)>a&&(a=Ma(e.endTime))});let o={startTime:va(a.toISOString()),endTime:i.endTime};return Ma(i.endTime)>a&&n.push(o),{timeSlots:n}}function _R(e){let t=$c(e,[{periodStart:!0,date:!0},{courts:!0,_ofType:Oc}]);if(t.error)return t;let{averageMatchUpMinutes:r,includeBookingTypes:i,periodStart:n,date:a}=e,o=e.courts,s=Ma(n),c=Aa(s,r),{enoughTime:u}=function({averageMatchUpMinutes:e,includeBookingTypes:t,periodStartTime:r,periodEndTime:i}){function n(t){let n=Ma(t.startTime),a=Ma(t.endTime);return!(n>r||a<i)&&Ra(r,a)>=e}return{enoughTime:e=>{let{timeSlots:r}=xR({includeBookingTypes:t,courtDate:e});return!!r?.filter(n)?.length}}}({averageMatchUpMinutes:r,includeBookingTypes:i,periodStartTime:s,periodEndTime:c});return{availableToScheduleCount:(o?.filter(e=>{if(!Array.isArray(e.dateAvailability))return!1;let t=vb({date:a,court:e});return!(!t||!u(t))})||[]).length,...ce}}function LR(e){let{remainingScheduleTimes:t=[],clearScheduleDates:r,periodLength:i=30,scheduleDate:n,courts:a=[]}=e,{bookings:o=[]}=e;if(!Array.isArray(a)||!a.length)return{error:gi,courts:a};if(!Array.isArray(o))return{error:Yt};if(!ua(n))return{error:Jt};r&&(Array.isArray(r)?r.includes(n)&&(o=[]):o=[]);let{courtBookings:s,unassignedBookings:c}=o.reduce((e,t)=>{let{courtId:r}=t;return r?e.courtBookings[r]?e.courtBookings[r].push(t):e.courtBookings[r]=[t]:e.unassignedBookings.push(t),e},{courtBookings:{},unassignedBookings:[]}),u=a.map((e,r)=>{let{courtId:i,courtName:a}=e,o=s[i]||[],c=vb({date:n,court:e})||{},{bookings:u=[],startTime:d,endTime:l,date:p}=c;return{courtId:i,courtName:a,dateAvailability:{bookings:[t[r]&&{startTime:d,endTime:t[r]},...Wa(u,!1,!0),...o].filter(Boolean),startTime:d,endTime:l,date:p}}});c.sort((e,t)=>Ua(e.startTime)-Ua(t.startTime));let d=()=>u.flatMap(e=>{let t=e.dateAvailability,{timeSlots:r=[]}=xR({courtDate:t});return{courtName:e.courtName,courtId:e.courtId,timeSlots:r}}),l=[];for(let p of c){let{startTime:e,endTime:t,averageMinutes:r,recoveryMinutes:n,matchUpId:a}=p,o=Ua(e),s=Ua(t),c=d().reduce((e,{courtId:t,courtName:r,timeSlots:n})=>{let a;return n.find(({startTime:t,endTime:r})=>{a=Ua(t)-o;let n=o>=Ua(t);return s<=Ua(r)&&0!==e.startDifference&&((0===a||a+i>=0)&&(void 0===e.startDifference||a<e.startDifference)||n)})?{courtName:r,courtId:t,startDifference:a}:e},{});if(c.courtId){let i={averageMinutes:r,recoveryMinutes:n,matchUpId:a,startTime:e,endTime:t};l.push(i),u.find(({courtId:e})=>e===c.courtId)?.dateAvailability.bookings.push(i)}else console.log({unassignedBooking:p})}return{virtualCourts:u.map(({courtId:e,courtName:t,dateAvailability:r})=>({dateAvailability:[r],courtName:t,courtId:e})),assignedBookings:l}}function BR({averageMatchUpMinutes:e,periodLength:t=30,recoveryMinutes:r}){let i=(e||90)+(r||0);return t>i?i:t||30}function VR(e){let{startTime:t="8:00",endTime:r="20:30",count:i=10,date:n}=e??{};return K(0,i).map(()=>({dateAvailability:[{date:n,startTime:t,endTime:r}]}))}function GR({scheduleDate:e,startTime:t,endTime:r,courts:i}){let n=(t?"startTime":r&&"endTime")||void 0;return i.reduce((i,a)=>{let o=vb({date:e,court:a}),s=n&&(o?.[n]||a[n]);return s&&(!i||t&&Ua(s)<Ua(i)||r&&Ua(s)>Ua(i))?s:i},void 0)}function jR(e){let t=$c(e,[{courts:!0,_ofType:Oc}]);if(t.error)return t;let{date:r=da(),startTime:i="08:00",endTime:n="19:00",periodLength:a,courts:o}=e,{calculateStartTimeFromCourts:s=!0,remainingScheduleTimes:c,averageMatchUpMinutes:u,clearScheduleDates:d,courtsCount:l,bookings:p}=e;a=a||BR({averageMatchUpMinutes:u}),r=ya(r),i=va(i),n=va(n);let m=0,f=0,h=0,g=0,U=0;!o&&l&&(o=VR({startTime:i,endTime:n,count:l,date:r}));let{virtualCourts:S}=LR({remainingScheduleTimes:c,clearScheduleDates:d,scheduleDate:r,periodLength:a,bookings:p,courts:o}),{firstTimeSlotStartTime:v}=function({averageMinutes:e,startTime:t,endTime:r,courts:i,date:n}){let a;if(t=t||GR({courts:i,scheduleDate:n,startTime:!0}),r=r||GR({courts:i,scheduleDate:n,endTime:!0}),t&&r){let o=Ma(t),s=Ma(r);for(let t of i||[]){if(!Array.isArray(t.dateAvailability))continue;let r=vb({court:t,date:n}),{timeSlots:i}=xR({courtDate:r});i?.forEach(t=>{let r=Ma(t.startTime),i=Ma(t.endTime);if(r>s||r<o||i<o)return!1;if(Ra(r,i)>=e){let e=va(r.toISOString());e&&(!a||e<a)&&(a=e)}})}}return{firstTimeSlotStartTime:a}}({averageMinutes:u,courts:S,startTime:i,endTime:n,date:r});s&&v&&(i=v??i);let y=Ua(i),w=Ua(n)-y,P=K(0,Math.floor(w/a)+1).map(e=>{let t=function(e){let t=Math.floor(e/60),r=e-60*t;return t>23&&(t%=24),[Ea(t),Ea(r)].join(":")}(y+e*a),i=_R({courts:S??[],averageMatchUpMinutes:u,periodStart:t,date:r});if(i.error)return{error:i.error};let{availableToScheduleCount:n=0}=i,o=n>f?n-f:0;U+=e?n:0;let s=e?U/e:n,c=e?a*s/u*(e-1)+s:s,d=n?f&&c-m||o:0;m=c,f=n,h+=d;let l=I(h)-g;return g+=l,{periodStart:t,add:l,availableToScheduleCount:n,newCourts:o,totalMatchUps:g}});return{scheduleTimes:P.reduce((e,t)=>{let r=K(0,t.add).map(()=>({scheduleTime:t.periodStart}));return e.concat(...r)},[]).flat(),timingProfile:P,totalMatchUps:g}}n(FR,{default:()=>qR,garman:()=>$R});var $R={getCourtsAvailableAtPeriodStart:_R,generateTimeSlots:xR,getScheduleTimes:jR,courtGenerator:VR},qR=$R,WR={};n(WR,{isAggregateFormat:()=>yT,isValid:()=>ta,isValidMatchUpFormat:()=>ta,parse:()=>Yn,stringify:()=>jn});var HR={};n(HR,{allCompetitionMatchUps:()=>Zf,allDrawMatchUps:()=>th,allEventMatchUps:()=>Qf,allTournamentMatchUps:()=>Xf,analyzeMatchUp:()=>nM,applyLineUps:()=>aA,assignMatchUpSideParticipant:()=>zR,assignTieMatchUpParticipantId:()=>nN,bulkMatchUpStatusUpdate:()=>XN,calculateWinCriteria:()=>zb,checkInParticipant:()=>QR,checkMatchUpIsComplete:()=>Vf,checkOutParticipant:()=>JR,competitionScheduleMatchUps:()=>jb,disableTieAutoCalc:()=>HN,drawMatchUps:()=>aM,enableTieAutoCalc:()=>$N,eventMatchUps:()=>Bb,filterMatchUps:()=>Lf,findMatchUp:()=>XD,getAllDrawMatchUps:()=>Kf,getAllStructureMatchUps:()=>Bf,getCheckedInParticipantIds:()=>qm,getCompetitionMatchUps:()=>Gb,getEventMatchUpFormatTiming:()=>Ob,getHomeParticipantId:()=>Kb,getMatchUpCompetitiveProfile:()=>mm,getMatchUpContextIds:()=>Jb,getMatchUpDailyLimits:()=>$b,getMatchUpDailyLimitsUpdate:()=>Fb,getMatchUpDependencies:()=>sh,getMatchUpFormat:()=>Zb,getMatchUpFormatTiming:()=>uf,getMatchUpFormatTimingUpdate:()=>Mb,getMatchUpScheduleDetails:()=>Ef,getMatchUpType:()=>Ff,getMatchUpsStats:()=>eM,getModifiedMatchUpFormatTiming:()=>kb,getParticipantResults:()=>Zh,getPredictiveAccuracy:()=>qb,getRoundMatchUps:()=>em,getRounds:()=>iM,isValidMatchUpFormat:()=>ta,matchUpActions:()=>Ey,mutate:()=>YR,participantScheduledMatchUps:()=>_b,query:()=>Db,removeDelegatedOutcome:()=>qN,removeMatchUpSideParticipant:()=>sN,removeTieMatchUpParticipantId:()=>oN,replaceTieMatchUpParticipantId:()=>eN,resetAdHocMatchUps:()=>iA,resetMatchUpLineUps:()=>zN,resetScorecard:()=>rA,resetTieFormat:()=>tA,setDelegatedOutcome:()=>eA,setMatchUpFormat:()=>YN,setMatchUpState:()=>GN,setMatchUpStatus:()=>QN,setOrderOfFinish:()=>nA,substituteParticipant:()=>WN,tallyParticipantResults:()=>fg,toggleParticipantCheckInState:()=>XR,tournamentMatchUps:()=>Vb,updateTieMatchUpScore:()=>sv,validMatchUp:()=>Xp,validMatchUps:()=>Zp});var YR={};function zR({tournamentRecord:e,drawDefinition:t,participantId:r,sideNumber:i,matchUpId:n,event:a}){if(r&&"string"!=typeof r)return{error:dr};if(!t)return{error:ye};if(!n)return{error:Mt};let o=void 0===i;if(o&&(i=1),![1,2].includes(i))return Pn({result:{error:gi,context:{sideNumber:i}}});let{matchUp:s,structure:c}=zS({drawDefinition:t,matchUpId:n,event:a});if(!s)return{error:Nt};if(c?.structures||t.drawType&&t.drawType!==Is||c?.matchUps?.find(({roundPosition:e})=>!!e))return{error:_e};if(!r&&(s?.score?.scoreStringSide1||kd.includes(s?.matchUpstatus)||s?.matchUpStatus&&[yd,vd].includes(s.matchUpStatus)))return{error:or,info:"matchUp has completed status or score"};if(s){if(s.sides=[1,2].map(e=>{let t=s.sides?.find(t=>t.sideNumber===e)??{sideNumber:e};return i===e?{...t,participantId:r}:t}),o)for(let e of s.sides)e.sideNumber&&(e.sideNumber=3-e.sideNumber);Dl({tournamentId:e?.tournamentId,context:"assignSideParticipant",drawDefinition:t,matchUp:s})}return{...ce,sidesSwapped:o}}function KR({removePriorValues:e,tournamentRecord:t,duplicateValues:r,drawDefinition:i,disableNotice:n,matchUpId:a,timeItem:o,event:s}){let{matchUp:c}=zS({drawDefinition:i,event:s,matchUpId:a});if(!c)return{error:Nt};let u=lv({removePriorValues:e,element:c,duplicateValues:r,timeItem:o});return n||Dl({tournamentId:t?.tournamentId,eventId:s?.eventId,context:"addTimeItem",drawDefinition:i,matchUp:c}),u}function JR(e){let t=$c(e,[{[Js]:!0},{[Xs]:!0},{[tc]:!0},{[mc]:!0}]);if(t.error)return t;let r=Qb(e,[{[Mc]:Pc,attr:{[hc]:!0}}]);if(r.error)return r;let{tournamentRecord:i,drawDefinition:n,participantId:a,matchUpId:o}=e,s=r?.matchUp?.matchUp,{matchUpStatus:c,score:u}=s??{};if(c&&Fd.includes(c)||c&&kd.includes(c)||ch({score:u}))return{error:He};let d=qm({matchUp:s});if(d?.error)return d;let{checkedInParticipantIds:l,allRelevantParticipantIds:p}=d??{};if(!p?.includes(a))return{error:dr};if(!l?.includes(a))return{error:Tr};let m=fm({matchUp:s});if(m?.error)return m;let{sideParticipantIds:f,nestedIndividualParticipantIds:h}=m??{},g=f?.indexOf(a);return void 0!==g&&[0,1].includes(g)&&(h?.[g]??[]).forEach(e=>{KR({drawDefinition:n,matchUpId:o,timeItem:{itemType:gm,itemValue:e}})}),KR({tournamentRecord:i,drawDefinition:n,matchUpId:o,timeItem:{itemValue:a,itemType:gm}}),{...ce,checkedOut:!0}}function QR(e){let t=$c(e,[{[Js]:!0},{[Xs]:!0},{[tc]:!0},{[mc]:!0}]);if(t[Dc])return t;let r=Qb(e,[{[Mc]:Pc,attr:{[hc]:!0}}]);if(r[Dc])return r;let{tournamentRecord:i,drawDefinition:n,participantId:a,matchUpId:o}=e,s=qm({matchUp:r?.matchUp?.matchUp});if(s?.error)return s;let{checkedInParticipantIds:c,allRelevantParticipantIds:u}=s??{};if(!u?.includes(a))return{[Dc]:dr};let d={...ce,checkedIn:!0};return c?.includes(a)||KR({tournamentRecord:i,drawDefinition:n,matchUpId:o,timeItem:{itemValue:a,itemType:hm}}),d}function XR(e){let t=$c(e,[{[tc]:!0,[Xs]:!0,[mc]:!0}]);if(t.error)return t;let r=e.tournamentId??e.activeTournamentId,i=e.tournamentRecord??(r&&e.tournamentRecords?.[r]);if(!i)return{error:Ie};let n=Qb(e,[{[Mc]:Pc,attr:{[hc]:!0},[Dc]:Nt}]).matchUp?.matchUp;if(!n)return{error:Nt};let{checkedInParticipantIds:a=[]}=qm({matchUp:n}),{participantId:o,matchUpId:s,drawDefinition:c}=e;return o&&a.includes(o)?JR({tournamentRecord:i,drawDefinition:c,participantId:o,matchUpId:s,matchUp:n}):QR({tournamentRecord:i,drawDefinition:c,participantId:o,matchUpId:s,matchUp:n})}function ZR({tournamentRecord:e,drawDefinition:t,tieMatchUpId:r,event:i}){if(!e)return{error:Ie};if(!t)return{error:Ge};if(!i)return{error:st};let n=Kp({drawDefinition:t}),{matchUp:a}=zS({matchUpId:r,drawDefinition:t,matchUpsMap:n});if(!a)return{error:Nt};let{matchUp:o,structure:s}=zS({tournamentParticipants:e.participants,matchUpId:r,inContext:!0,drawDefinition:t,matchUpsMap:n,event:i});if(!o)return{error:Nt};let{collectionPosition:c,drawPositions:d,collectionId:p,matchUpTieId:m,matchUpType:f}=o;if(f&&!se([u,l],f))return{error:Ct};let{positionAssignments:h}=$d({structure:s}),g=h?.filter(e=>d?.includes(e.drawPosition)),{matchUp:I}=zS({matchUpId:m,drawDefinition:t,matchUpsMap:n}),U=[...I?.sides?.map(dd)??[],...g?.map(dd)??[]],{participants:S}=Ag({tournamentRecord:e,participantFilters:{participantTypes:[$l],participantIds:U}}),{matchUp:v}=zS({matchUpId:m,inContext:!0,drawDefinition:t,matchUpsMap:n}),y=zp({matchUp:I,drawDefinition:t,structure:s,event:i})?.tieFormat;return{inContextDualMatchUp:v,inContextTieMatchUp:o,relevantAssignments:g,collectionPosition:c,teamParticipants:S,collectionId:p,matchUpType:f,dualMatchUp:I,tieMatchUp:a,tieFormat:y,structure:s,...ce}}function eN(e){let t=ZR(e);if(t.error)return t;let r="replaceTieMatchUpParticipantid",{existingParticipantId:i,tournamentRecord:n,newParticipantId:a,drawDefinition:o,substitution:s,event:c}=e;if(!i||!a)return Pn({result:{error:Ir},stack:r});if(i===a)return{...ce};let{inContextDualMatchUp:u,inContextTieMatchUp:d,collectionPosition:p,collectionId:m,dualMatchUp:f,tieMatchUp:h,tieFormat:g}=t,I=d?.matchUpType,U=d?.sides?.find(e=>e.participant?.participantId===i||e.participant?.individualParticipantIds?.includes(i));if(!U)return{error:Sr};let S=Ag({tournamentRecord:n,participantFilters:{participantIds:[i,a]}})?.participants??[];if(2!==S.length)return Pn({result:{error:Ir},stack:r});if(S[0].participantType!==S[1].participantType)return Pn({result:{error:mr},stack:r});let{appliedPolicies:v}=up({tournamentRecord:n,drawDefinition:o,event:c}),y=e.policyDefinitions?.[iu]??v?.[iu]??Hg[iu],w=S.find(({participantId:e})=>e===a);if(!1!==(e.enforceGender??y?.participants?.enforceGender)&&kn(d?.gender)&&On(d?.gender)!==On(w?.person?.sex))return{error:ur,info:"Gender mismatch"};let P=y?.processCodes?.substitution;iv({tournamentId:n.tournamentId,eventId:c.eventId,inContextDualMatchUp:u,drawDefinition:o,dualMatchUp:f});let T=f?.sides?.find(({sideNumber:e})=>e===U.sideNumber);if(!T)return Pn({result:{sideNumber:U.sideNumber,existingParticipantId:i,error:wi},stack:r});if(d?.sides?.flatMap(e=>e.participant?.individualParticipantIds||e.participant?.participantId||[])?.includes(a))return Pn({result:{error:Mr},stack:r});let D=u?.sides?.find(({sideNumber:e})=>e===U.sideNumber)?.participantId,b=T.lineUp,M=b?.find(({participantId:e})=>a===e),R=b?.reduce((e,t)=>t.substitutionOrder>e?t.substitutionOrder:e,0),N=b?.map(e=>{let t=Wa(e,!1,!0);if(![i,a].includes(t.participantId))return t;if(!s&&[i,a].includes(t.participantId)&&(t.collectionAssignments=t.collectionAssignments?.filter(e=>!(e.collectionPosition===p&&e.collectionId===m))),s&&i===t.participantId&&(t.collectionAssignments=t.collectionAssignments.map(e=>e.collectionPosition===p&&e.collectionId===m&&void 0===e.substitutionOrder?{...e,substitutionOrder:R}:e)),t.participantId===a){t.collectionAssignments||(t.collectionAssignments=[]);let e={collectionId:m,collectionPosition:p};s&&(e.previousParticipantId=i,e.substitutionOrder=(R??0)+1),t.collectionAssignments.push(e)}return t})??[];if(!M){let e={collectionId:m,collectionPosition:p};s&&(e.substitutionOrder=(R??0)+1,e.previousParticipantId=i);let t={collectionAssignments:[e],participantId:a};N.push(t)}let A,E,C=I===l,{assignedParticipantIds:O}=Cf({lineUp:b,collectionPosition:p,collectionId:m}),{assignedParticipantIds:k}=Cf({lineUp:N,collectionPosition:p,collectionId:m});if(T.lineUp=N,D&&g){let e=YI({participantId:D,lineUp:N,drawDefinition:o,tieFormat:g});if(e.error)return Pn({result:e,stack:r})}else console.log("team participantId not found");if(C){let{tournamentRecord:t}=e,i=Of({participantIds:k,tournamentRecord:t});if(!i.participant){let e=NM({returnParticipant:!0,pairOverride:!0,tournamentRecord:t,participant:{participantRole:Qg,individualParticipantIds:k,participantType:jl}});if(e.error)return Pn({result:e,stack:r});A=e.participant?.participantId}i=Of({participantIds:O,tournamentRecord:t});let n=i.participant?.participantId;n&&sI({participantIds:[n],tournamentRecord:t}).success&&(E=n)}if(s||1===U.substitutions?.length){if(s)P&&h&&(h.processCodes=L([...h?.processCodes??[],...P]));else for(let e of P||[]){let t=h?.processCodes?.lastIndexOf(e);void 0!==t&&h?.processCodes?.splice(t,1)}h&&Dl({tournamentId:n?.tournamentId,matchUp:h,context:r,drawDefinition:o})}return f&&Dl({tournamentId:n?.tournamentId,matchUp:f,context:r,drawDefinition:o}),{...ce,modifiedLineUp:N,participantRemoved:E,participantAdded:A}}function tN({collectionPosition:e,teamParticipantId:t,dualMatchUpSide:r,drawDefinition:i,participantIds:n,collectionId:a}){if(!a||!e||!Array.isArray(n))return{modifiedLineUp:r?.lineUp||[],error:gi};let o=r?.lineUp||kf({participantId:t,drawDefinition:i})?.lineUp,s=[],c=[];return{modifiedLineUp:o?.map(t=>{if(!n.includes(t.participantId))return t;let r=t.collectionAssignments?.filter(r=>{let i=r.collectionId===a&&r.collectionPosition===e;return i&&(r.previousParticipantId&&s.push(r.previousParticipantId),c.push({participantId:t.participantId,...r})),!i});return{participantId:t.participantId,collectionAssignments:r}}).filter(Boolean)||[],assignmentsRemoved:c,previousParticipantIds:s}}function rN({individualParticipantIds:e,groupingParticipantId:t,removeFromOtherTeams:r,tournamentRecord:i}){let n="addIndividualParticipantIds";if(!i)return Pn({result:{error:Ie},stack:n});if(!t||!e)return Pn({result:{error:$t},stack:n});let a=i.participants??[],o=a.find(e=>e.participantId===t);if(!o)return Pn({result:{error:Sr},stack:n});if(o?.participantType&&![$l,Gl].includes(o.participantType))return Pn({context:{participantType:o.participantType},result:{error:mr},stack:n});let s=e.filter(e=>a.find(t=>t.participantId===e)?.participantType!==Vl);if(s.length)return Pn({result:{error:lr,invalidParticipantIds:s},stack:n});o.individualParticipantIds||(o.individualParticipantIds=[]);let c=o.individualParticipantIds,u=e.filter(e=>!c.includes(e));u.length&&(r&&oI({individualParticipantIds:u,tournamentRecord:i}),o.individualParticipantIds=o.individualParticipantIds.concat(...u));let{topics:d}=cn();if(d.includes(sl)){let e=a.find(({participantId:e})=>e===t);rn({topic:sl,payload:{participants:[e]}})}return function({individualParticipantIds:e,groupingParticipantId:t,tournamentRecord:r}){let i=(r.events||[]).filter(e=>e?.eventType===$o&&e?.entries?.some(e=>e.participantId===t)),n=t=>!e.includes(t.participantId);for(let a of i){a.entries=(a.entries||[]).filter(n);let{flightProfile:e}=Nf({event:a});e?.flights?.forEach(e=>{e.drawEntries=(e.drawEntries||[]).filter(n)}),a?.drawDefinitions?.forEach(e=>{e.entries=(e.entries||[]).filter(n)})}}({individualParticipantIds:e,groupingParticipantId:t,tournamentRecord:i}),{groupingParticipant:Wa(o,!1,!0),added:u.length,...ce}}function iN(e){let{updateParticipantName:t=!0,groupingParticipantId:r,removeFromOtherTeams:i,tournamentRecord:n,pairOverride:a,participant:o}=e;if(!n)return{error:Ie};if(!o)return{error:hr};if(!o.participantId)return NM({tournamentRecord:n,participant:o});let{participant:s}=Kl({participantId:o.participantId,tournamentRecord:n});if(!s)return NM({tournamentRecord:n,participant:o});let{participantRoleResponsibilties:c,individualParticipantIds:u,participantOtherName:d,participantName:l,participantRole:p,participantType:f,onlineResources:h,contacts:g,person:I}=o;if(f&&s.participantType!==f)return{error:ar};let U={};if(g&&(U.contacts=g),h&&(U.onlineResources=h),d&&S(d)&&(U.participantOtherName=d),l&&S(l)&&(U.participantName=l),Array.isArray(u)){let{participants:e}=Ag({participantFilters:{participantTypes:[Vl]},tournamentRecord:n}),r=e?.map(dd);if(r){let i=u.filter(e=>S(e)&&r.includes(e));([Gl,m].includes(f||s.participantType)||f===jl&&(2===i.length||a))&&(U.individualParticipantIds=i),s.participantType===ql.PAIR&&t&&(U.participantName=function({individualParticipants:e,newValues:t}){let r=t.individualParticipantIds,i=e.filter(({participantId:e})=>r.includes(e)).map(({person:e})=>e?.standardFamilyName).filter(Boolean).sort().join("/");return 1===r.length&&(i+="/Unknown"),i}({individualParticipants:e,newValues:U}))}}return Object.keys(iI).includes(p)&&(U.participantRole=p),Object.keys(ql).includes(f)&&(U.participantType=f),Array.isArray(c)&&(U.participantRoleResponsibilties=c),s.participantType===ql.INDIVIDUAL&&I&&function({updateParticipantName:e,existingParticipant:t,newValues:r,person:i}){let n,a={},{standardFamilyName:o,standardGivenName:s,nationalityCode:c,personId:u,birthdate:d,tennisId:l,sex:p}=i;if(p&&Object.keys(Rn).includes(p)&&(a.sex=p),S(u)&&(a.personId=u),c&&S(c)&&(function(e){return Yl.flatMap(({iso:e,ioc:t})=>[e,t]).filter(Boolean).includes(e)}(c)||""===c)&&(a.nationalityCode=c),o&&typeof S(o)&&o.length>1&&(a.standardFamilyName=o,n=!0),s&&typeof S(s)&&s.length>1&&(a.standardGivenName=s,n=!0),n&&e){let e=`${a.standardGivenName} ${a.standardFamilyName}`;r.participantName=e}d&&ua(d)&&(a.birthdate=d),l&&S(l)&&(a.tennisId=l),Object.assign(t.person,a)}({updateParticipantName:t,existingParticipant:s,newValues:U,person:I}),Object.assign(s,wn(U)),r&&rN({individualParticipantIds:[s.participantId],groupingParticipantId:r,removeFromOtherTeams:i,tournamentRecord:n}),rn({topic:sl,payload:{tournamentId:n.tournamentId,participants:[s]}}),{participant:Wa(s),...ce}}function nN(e){let t=ZR(e);if(t.error)return t;let r="assignTieMatchUpParticipantId",i=e.teamParticipantId,{tournamentRecord:n,drawDefinition:a,participantId:o,event:s}=e;if(!o)return Pn({result:{error:Ir},stack:r});if(e.sideNumber&&![1,2].includes(e.sideNumber))return Pn({result:{error:Vt},stack:r});let{inContextDualMatchUp:c,inContextTieMatchUp:d,relevantAssignments:p,collectionPosition:m,teamParticipants:f,collectionId:h,matchUpType:g,dualMatchUp:I,tieFormat:U}=t;if(d?.sides?.flatMap(e=>e.participant?.individualParticipantIds||e.participant?.participantId||[])?.includes(o))return Pn({result:{...ce},stack:r});i=i??(e.sideNumber?c?.sides?.find(t=>t.sideNumber===e.sideNumber)?.participantId:void 0);let S=Ag({participantFilters:{participantIds:[o]},tournamentRecord:n})?.participants?.[0];if(!S)return Pn({result:{error:Sr},stack:r});let{appliedPolicies:v}=up({tournamentRecord:n,drawDefinition:a,event:s}),y=e.policyDefinitions?.[iu]??v?.[iu]??Hg[iu];if(!1!==(e.enforceGender??y?.participants?.enforceGender)&&kn(d?.gender)&&On(d?.gender)!==On(S.person?.sex))return{error:ur,info:"Gender mismatch"};let{individualParticipantIds:w,participantType:P}=S;if(Wm(u)(g)&&P!==Vl)return{error:mr};let T=P===Vl?[o]:w,D=i&&f?.find(({participantId:e})=>e===i)||f?.find(({individualParticipantIds:e})=>Z(T,e));if(!D)return{error:Ui};if(i||(i=D.participantId),!i)return{error:Sr};let b=p?.find(e=>e.participantId===D?.participantId)?.drawPosition,M=I?.sides?.find(e=>e.participantId===i)?.sideNumber,R=d?.sides?.find(e=>b&&e.drawPosition===b)?.sideNumber,N=M??R??e.sideNumber;if(!U)return{error:bt};if(!U.collectionDefinitions?.find(e=>e.collectionId===h))return{error:Dt};iv({tournamentId:n.tournamentId,eventId:s.eventId,inContextDualMatchUp:c,drawDefinition:a,dualMatchUp:I});let A=I?.sides?.find(e=>e.sideNumber===N),E=d?.sides?.find(e=>e.sideNumber===N),C=(A?.lineUp??kf({participantId:i,drawDefinition:a})?.lineUp)?.filter(e=>e.collectionAssignments?.find(e=>e.collectionPosition===m&&e.collectionId===h&&!e.previousParticipantId))?.map(e=>e?.participantId),O=C?.length>1&&C||(P===jl?S.individualParticipantIds:[o]),k=tN({collectionPosition:m,teamParticipantId:i,dualMatchUpSide:A,drawDefinition:a,participantIds:O,collectionId:h});if(k.error)return Pn({result:k,stack:r});let F,{modifiedLineUp:x}=k;if(g===l){if(P!==jl){let e=aN({collectionPosition:m,teamParticipantId:i,drawDefinition:a,modifiedLineUp:x,participantId:o,collectionId:h,tieFormat:U});if(e?.error)return Pn({result:e,stack:r});if(e=function({side:e}){let t;if(e.participant){let r=e.participant.individualParticipantIds||[];if(1===r.filter(Boolean).length){let{participant:e}=Of({participantIds:r,tournamentRecord:n});r.push(o);let{participant:i}=Of({participantIds:r,tournamentRecord:n});if(!i&&e){e.individualParticipantIds=r;let t=iN({pairOverride:!0,tournamentRecord:n,participant:e});if(t.error)return t}else t=e?.participantId}}else{let e=NM({participant:{individualParticipantIds:[o],participantRole:Qg,participantType:jl},pairOverride:!0,tournamentRecord:n});if(e.error)return e}return{...ce,deletedParticipantId:t}}({side:E}),e.error)return e;F=e.deletedParticipantId,A&&(A.lineUp=x),I&&Dl({tournamentId:n?.tournamentId,matchUp:I,context:r,drawDefinition:a})}else if(P===jl)for(let u of O)aN({collectionPosition:m,teamParticipantId:i,drawDefinition:a,modifiedLineUp:x,participantId:u,collectionId:h,tieFormat:U})}else{let e=aN({collectionPosition:m,teamParticipantId:i,drawDefinition:a,modifiedLineUp:x,participantId:o,collectionId:h,tieFormat:U});if(e?.error)return e}if(A&&(A.lineUp=x),I&&Dl({tournamentId:n?.tournamentId,matchUp:I,context:r,drawDefinition:a}),F){let{error:e}=sI({participantIds:[F],tournamentRecord:n});e&&console.log("cleanup")}return{...ce,modifiedLineUp:x}}function aN({collectionPosition:e,teamParticipantId:t,drawDefinition:r,modifiedLineUp:i,participantId:n,collectionId:a,tieFormat:o}){let s=kf({participantId:t,drawDefinition:r})?.lineUp,c=(i||s)?.find(e=>e?.participantId===n),u={collectionId:a,collectionPosition:e};if(c)c.collectionAssignments.push(u);else{let e={collectionAssignments:[u],participantId:n};i.push(e)}return YI({participantId:t,lineUp:i,drawDefinition:r,tieFormat:o})}function oN(e){let{tournamentRecord:t,drawDefinition:r,participantId:i,event:n}=e,a="removeTieMatchUpParticiapantId";if(!i)return Pn({result:{error:Ir},stack:a});let o=ZR(e);if(o.error)return o;let{appliedPolicies:s}=up({tournamentRecord:t,drawDefinition:r,event:n}),c=(e.policyDefinitions?.[iu]??s?.[iu]??Hg[iu])?.processCodes?.substitution,{inContextDualMatchUp:d,inContextTieMatchUp:p,relevantAssignments:m,collectionPosition:f,teamParticipants:h,collectionId:g,matchUpType:I,dualMatchUp:U,tieMatchUp:S,tieFormat:v}=o;if(!U)return Pn({result:{error:Et},stack:a});let y=p?.sides?.find(e=>e.participant?.participantId===i||e.participant?.individualParticipantIds?.includes(i));if(!y)return Pn({result:{error:Sr},stack:a});let w=e.policyDefinitions?.[du]??s?.[du];if(!y.substitutions?.length&&(ch({score:p?.score})||p?.winningSide)&&!1!==w?.requireParticipantsForScoring)return Pn({result:{error:bi},stack:a});let P=d?.sides?.find(({sideNumber:e})=>e===y.sideNumber)?.participantId;if(!P)return Pn({result:{error:Sr},stack:a});let T=Ag({participantFilters:{participantIds:[i]},tournamentRecord:t})?.participants?.[0];if(!T)return Pn({result:{error:Sr},stack:a});if(I===u&&T.participantType===jl)return Pn({result:{error:ur},stack:a});let D=T.participantType===Vl?[i]:T.individualParticipantIds;iv({tournamentId:t.tournamentId,eventId:n.eventId,inContextDualMatchUp:d,drawDefinition:r,dualMatchUp:U});let b=U.sides?.find(({sideNumber:e})=>e===y.sideNumber);if(!b&&(U.sides?.filter(({lineUp:e})=>!e).length||0)<2){let e=h?.map(({participantId:e})=>({drawPosition:m?.find(t=>t.participantId===e)?.drawPosition,teamParticipantId:e}));b=U.sides?.find(t=>e?.find(({drawPosition:e})=>e===t.drawPosition)?.teamParticipantId===P)}if(!b)return Pn({result:{error:Sr,context:{participantId:i}}});let{modifiedLineUp:M,previousParticipantIds:R}=tN({collectionPosition:f,teamParticipantId:P,dualMatchUpSide:b,participantIds:D,drawDefinition:r,collectionId:g});if(b.lineUp=M,P&&v&&YI({participantId:P,lineUp:M,drawDefinition:r,tieFormat:v}),I===l&&T.participantType===Vl){let e=p?.sides?.find(e=>e.sideNumber===b?.sideNumber),{participantId:r}=e??{},n=r&&Ag({participantFilters:{participantIds:[r]},tournamentRecord:t,withDraws:!0})?.participants?.[0];if(!n)return Pn({result:{error:Sr},stack:a});{let e=n?.individualParticipantIds?.filter(e=>e!==i)??[];if(R&&e.push(...R),e.length>2)return Pn({result:{error:lr},stack:a});if(n.draws?.length){if(1===e.length){let{participant:r}=Of({participantIds:e,tournamentRecord:t});if(!r){let r=NM({participant:{participantRole:Qg,individualParticipantIds:e,participantType:jl},pairOverride:!0,tournamentRecord:t});if(r.error)return Pn({result:r,stack:a})}}}else if(e.length){n.individualParticipantIds=e;let r=iN({participant:n,pairOverride:!0,tournamentRecord:t});if(r.error)return Pn({result:r,stack:a})}else{let e=sI({participantIds:[r],tournamentRecord:t});e.error&&console.log("cleanup",{result:e})}}}if(1===y.substitutions?.length&&!p?.sides?.find(e=>e.sideNumber!==y.sideNumber)?.substitutions?.length&&S?.processCodes?.length){for(let e of c||[]){let t=S.processCodes.lastIndexOf(e);S.processCodes.splice(t,1)}Dl({tournamentId:t?.tournamentId,matchUp:S,context:a,drawDefinition:r})}return Dl({tournamentId:t?.tournamentId,matchUp:U,context:a,drawDefinition:r}),{...ce,modifiedLineUp:M}}function sN(e){let t=$c(e,[{[Js]:!0,[Xs]:!0,[mc]:!0}]);if(t.error)return t;let{drawDefinition:r,sideNumber:i,matchUpId:n,event:a}=e;if(i&&![1,2].includes(i))return{error:gi,sideNumber:i};let{matchUp:o,structure:s}=zS({drawDefinition:r,matchUpId:n,event:a});return o?nm({structure:s})?(o.sides?.forEach(e=>{(!i||e.sideNumber===i)&&delete e.participantId}),Dl({tournamentId:e.tournamentRecord?.tournamentId,context:"assignSideParticipant",drawDefinition:r,matchUp:o}),{...ce}):{error:_e}:{error:Nt}}function cN({inContextDrawMatchUps:e,positionAssignments:t,sourceMatchUpStatus:r,targetDrawPosition:i,tournamentRecord:n,sourceMatchUpId:a,drawDefinition:o,dualMatchUp:s,matchUpsMap:c,matchUp:u,event:d}){if(s){let t=e.find(({matchUpId:e})=>u.matchUpId===e).sides?.find(e=>e.drawPosition===i)?.sideNumber,r=u.sides?.find(e=>e.sideNumber===t);r&&delete r.lineUp}u.drawPositions=(u.drawPositions||[]).map(e=>e===i?void 0:e).filter(Boolean);let l=t.filter(({drawPosition:e})=>u.drawPositions?.includes(e)).filter(e=>e.bye).length;return u.matchUpStatus=(l?"BYE":Sh(u.matchUpStatus)&&u.matchUpStatus)||Md,Sh(u.matchUpStatus)&&(u.winningSide=void 0),u.matchUpStatusCodes&&VI({inContextDrawMatchUps:e,sourceMatchUpStatus:r,sourceMatchUpId:a,matchUpsMap:c,matchUp:u}),Dl({tournamentId:n?.tournamentId,eventId:d?.eventId,context:`removeSubsequentDrawPosition-${i}`,drawDefinition:o,matchUp:u}),{...ce}}function uN(e){let{dualWinningSideChange:t,inContextDrawMatchUps:r,tournamentRecord:i,drawDefinition:n,matchUpStatus:a,matchUpsMap:o,dualMatchUp:s,targetData:c,matchUpId:u,structure:d,event:l}=e,p=!!e.matchUp.collectionId,m=nm({structure:d}),{drawPositions:f,winningSide:h}=c.matchUp||{};if(!m&&!f)return{error:Ce};let g,{targetLinks:{loserTargetLink:I,winnerTargetLink:U,byeTargetLink:S},targetMatchUps:{loserMatchUp:v,winnerMatchUp:y,byeMatchUp:w}}=c,P=XS({...e,matchUpStatus:a||Md,removeWinningSide:!0});if(P.error)return P;if(p){let{matchUpTieId:r,matchUpsMap:a}=e;if(g=sv({appliedPolicies:e.appliedPolicies,matchUpId:r,tournamentRecord:i,drawDefinition:n,matchUpsMap:a,event:l}),!t&&!g.removeWinningSide)return{...ce}}if(m)return{...ce};let{matchUps:T}=Bf({afterRecoveryTimes:!1,inContext:!0,drawDefinition:n,matchUpsMap:o,structure:d}),{positionAssignments:D}=qd({structure:d}),b=h-1,M=1-b,R=f[b],N=f[M],{winnerParticipantId:A,loserParticipantId:E}=D?.reduce((e,t)=>(t.drawPosition===N&&(e.loserParticipantId=t.participantId),t.drawPosition===R&&(e.winnerParticipantId=t.participantId),e),{winnerParticipantId:void 0,loserParticipantId:void 0})||{},C=T.filter(e=>e.drawPositions?.includes(N));if(y&&dN({sourceMatchUpStatus:a,sourceMatchUpId:u,inContextDrawMatchUps:r,winningDrawPosition:R,winnerParticipantId:A,tournamentRecord:i,winnerTargetLink:U,drawDefinition:n,winnerMatchUp:y,dualMatchUp:s,matchUpsMap:o}),v){let{winnerHadMatchUpStatus:e}=function({matchUpStatuses:e=["BYE",Rd,Sd],drawPositionMatchUps:t,loserDrawPosition:r,sourceMatchUps:i}){let n=t?.reduce((e,t)=>!e||t.roundNumber>e.roundNumber?t:e,void 0),a=n?.drawPositions?.find(e=>e!==r),o=i.filter(e=>e?.drawPositions?.includes(a)).map(e=>e.matchUpStatus),s=i.filter(e=>e?.drawPositions?.includes(r)).map(e=>e.matchUpStatus);return{sourceMatchUp:n,winnerHadMatchUpStatus:Z(o||[],e),winnerMatchUpStatuses:o,loserHadMatchUpStatus:Z(s||[],e),loserMatchUpStatuses:s}}({drawPositionMatchUps:C,loserDrawPosition:N,sourceMatchUps:T}),t=I.linkCondition===gs;if(e&&t){lN({targetLink:I,inContextDrawMatchUps:r,drawDefinition:n,drawPosition:Math.min(...v.drawPositions),matchUpsMap:o,event:l})}let c=function({sourceMatchUpStatus:e,loserParticipantId:t,tournamentRecord:r,loserTargetLink:i,sourceMatchUpId:n,drawDefinition:a,loserMatchUp:o,matchUpsMap:s,dualMatchUp:c,event:u}){let d="removeDirectedLoser",l=i.target.structureId,{structure:p}=Vd({drawDefinition:a,structureId:l});if(!p)return{error:et};let{positionAssignments:m}=qd({structure:p}),f=m?.find(e=>e.participantId===t)?.drawPosition;if(m?.forEach(e=>{e.participantId===t&&delete e.participantId}),n&&e){let t=s?.drawMatchUps?.find(({matchUpId:e})=>e===o.matchUpId);t.matchUpStatusCodes=e===yd?["WO","WO"]:[]}if(p.seedAssignments=(p.seedAssignments??[]).filter(e=>e.participantId!==t),c){let e=o?.sides.reduce((e,t,r)=>t.drawPosition===f?r:e,void 0),t=s?.drawMatchUps?.find(({matchUpId:e})=>e===o.matchUpId),i=t?.sides?.[e];i&&(delete i.lineUp,Dl({tournamentId:r?.tournamentId,eventId:u?.eventId,matchUp:t,context:d,drawDefinition:a}))}return{...ce}}({sourceMatchUpStatus:a,sourceMatchUpId:u,loserParticipantId:E,tournamentRecord:i,loserTargetLink:I,drawDefinition:n,loserMatchUp:v,dualMatchUp:s,matchUpsMap:o,event:l});if(c.error)return c}if(w){lN({sourceMatchUpId:u,targetLink:S,inContextDrawMatchUps:r,drawDefinition:n,drawPosition:Math.min(...w.drawPositions),matchUpsMap:o,event:l})}return{...ce,...g&&{tieMatchUpResult:g}}}function dN({inContextDrawMatchUps:e,winningDrawPosition:t,sourceMatchUpStatus:r,winnerParticipantId:i,tournamentRecord:n,winnerTargetLink:a,sourceMatchUpId:o,drawDefinition:s,winnerMatchUp:c,matchUpsMap:u,dualMatchUp:d,event:l}){let{structureId:p,roundNumber:m}=c;if(a){let e=a.target.structureId,{structure:t}=Vd({drawDefinition:s,structureId:e});if(!t)return{error:et};let{positionAssignments:r}=qd({structure:t});t.seedAssignments=(t.seedAssignments??[]).filter(e=>e.participantId!==i);let o=r?.find(e=>e.participantId===i)?.drawPosition,{matchUps:d}=Bf({drawDefinition:s,structure:t,event:l}),p=j(d.map(e=>e.drawPositions).flat(1/0).filter(Boolean));if(1===(o?p[o]:void 0))r?.forEach(e=>{e.participantId===i&&delete e.participantId});else{let e=d.filter(({drawPositions:e})=>e.includes(o));console.log("not removing from position assignments since instances > 1",{drawPositionMatchUps:e,winnerTargetLink:a})}let m=u?.drawMatchUps?.find(({matchUpId:e})=>e===c.matchUpId);m&&Dl({tournamentId:n?.tournamentId,eventId:l?.eventId,matchUp:m,context:"removeDirectedWinner",drawDefinition:s})}return m&&function({inContextDrawMatchUps:e,sourceMatchUpStatus:t,targetDrawPosition:r,tournamentRecord:i,sourceMatchUpId:n,drawDefinition:a,structureId:o,dualMatchUp:s,roundNumber:c,matchUpsMap:u,event:d}){let{structure:l}=Vd({drawDefinition:a,structureId:o});if(l?.structureType===cs)return{...ce};u=u??Kp({drawDefinition:a});let p=(u?.mappedMatchUps||{})[o].matchUps,{initialRoundNumber:m}=mh({drawPosition:r,matchUps:p}),f=p?.filter(e=>e.roundNumber>=c&&e.roundNumber!==m&&e.drawPositions?.includes(r)),{positionAssignments:h}=$d({drawDefinition:a,structureId:o});for(let g of f??[])cN({inContextDrawMatchUps:e,sourceMatchUpStatus:t,positionAssignments:h,targetDrawPosition:r,tournamentRecord:i,sourceMatchUpId:n,drawDefinition:a,dualMatchUp:s,matchUpsMap:u,matchUp:g,event:d})}({targetDrawPosition:t,inContextDrawMatchUps:e,sourceMatchUpStatus:r,tournamentRecord:n,sourceMatchUpId:o,drawDefinition:s,dualMatchUp:d,matchUpsMap:u,roundNumber:m,structureId:p}),{...ce}}function lN({inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,drawPosition:i,matchUpsMap:n,targetLink:a,event:o}){let s=a.target.structureId,c="removeDirectedBye";return gh({color:"brightyellow",method:c,drawPosition:i}),Pn({result:bh({inContextDrawMatchUps:e,tournamentRecord:t,drawDefinition:r,drawPosition:i,matchUpsMap:n,structureId:s,event:o}),stack:c})}function pN(e){let{tournamentRecord:t,appliedPolicies:r,drawDefinition:i,matchUpsMap:n,targetData:a,structure:o,event:s}=e,c="doubleExitAdvancement";if(o.structureType===cs)return Pn({result:{...ce},stack:c});let{matchUp:u,targetMatchUps:d,targetLinks:l}=a,{loserMatchUp:p,winnerMatchUp:m,loserTargetDrawPosition:f}=d,h=Sh(p?.matchUpStatus)&&!p.sides?.map(e=>e.participantId??e.participant).filter(Boolean).length,g=p?.matchUpStatus===yd;if(gh({method:c,newline:!0,color:"brightyellow",keyColors:{sourceMatchUpId:"brightcyan",loserMatchUpId:"brightmagenta",winnerMatchUpId:"brightgreen"},sourceMatchUpId:u?.matchUpId,sourceStatus:e.matchUpStatus,sourceDP:JSON.stringify(u?.drawPositions),loserMatchUpId:p?.matchUpId,loserStatus:p?.matchUpStatus,loserDP:JSON.stringify(p?.drawPositions),loserTargetDP:f,loserIsEmptyExit:h,loserIsDoubleExit:g,loserSides:JSON.stringify(p?.sides?.map(e=>({sn:e.sideNumber,pid:e.participantId?.slice(0,8),fed:e.participantFed}))),winnerMatchUpId:m?.matchUpId,winnerStatus:m?.matchUpStatus,winnerDP:JSON.stringify(m?.drawPositions)}),p&&"BYE"!==p.matchUpStatus){let{loserTargetLink:a}=l,o=r?.progression?.doubleExitPropagateBye,d=p.feedRound&&p.sides?.[0]?.participantFed;if(o||d){gh({method:c,color:"cyan",decision:"advanceByeToLoserMatchUp",propagateBye:o,targetFedIn:!!d});let e=fN({loserTargetDrawPosition:f,tournamentRecord:t,loserTargetLink:a,drawDefinition:i,loserMatchUp:p,matchUpsMap:n,event:s});if(e.error)return Pn({result:e,stack:c})}else if(h){let t=e.matchUpStatus===vd?vd:yd,r=e.matchUpStatus===vd?Sd:Rd,i=n.drawMatchUps.find(e=>e.matchUpId===p.matchUpId);if(gh({method:c,color:"brightred",decision:"EMPTY_EXIT_converting_to_DOUBLE_EXIT",loserMatchUpId:p.matchUpId,currentStatus:p.matchUpStatus,newStatus:t}),i){let n=[{matchUpStatus:r,previousMatchUpStatus:t,sideNumber:1},{matchUpStatus:r,previousMatchUpStatus:e.matchUpStatus,sideNumber:2}].map(e=>wn(e)),a=XS({...e,matchUp:i,matchUpId:p.matchUpId,matchUpStatus:t,matchUpStatusCodes:n,winningSide:void 0,removeScore:!0,context:c});if(a.error)return Pn({result:a,stack:c})}}else if(g)gh({method:c,color:"brightyellow",decision:"SKIP_loserMatchUp_already_doubleExit",loserMatchUpId:p.matchUpId});else{let{feedRound:r,drawPositions:i,matchUpId:n}=p,a=r?2:2-i.indexOf(f);gh({method:c,color:"cyan",decision:"conditionallyAdvanceLoser",feedRound:r,walkoverWinningSide:a,loserMatchUpId:n});let o=mN({...e,targetMatchUp:p,walkoverWinningSide:a,tournamentRecord:t,sourceMatchUp:u,matchUpId:n});if(o.error)return Pn({result:o,stack:c})}}if(m){gh({method:c,color:"cyan",decision:"conditionallyAdvanceWinner",winnerMatchUpId:m.matchUpId});let r=mN({...e,matchUpId:m.matchUpId,targetMatchUp:m,tournamentRecord:t,sourceMatchUp:u});if(r.error)return Pn({result:r,stack:c})}return Pn({result:{...ce},stack:c})}function mN(e){let{inContextDrawMatchUps:t,tournamentRecord:r,drawDefinition:i,sourceMatchUp:n,targetMatchUp:a,matchUpsMap:o}=e,s=i.structures.find(({structureId:e})=>e===a.structureId),c=e.matchUpStatus===vd?vd:yd,u=e.matchUpStatus===vd?Sd:Rd,d="conditionallyAdvanceDrawPosition",l=o.drawMatchUps.find(e=>e.matchUpId===a.matchUpId);if(!l)return{error:Et};let p=n?.drawPositions||[],m=l.drawPositions?.filter(Boolean),f=n?.structureId===a.structureId;if(gh({method:d,newline:!0,color:"magenta",keyColors:{targetMatchUpId:"brightcyan",sourceMatchUpId:"brightyellow"},targetMatchUpId:a.matchUpId,targetStructureId:a.structureId?.slice(0,8),targetRound:[a.roundNumber,a.roundPosition],targetDP:JSON.stringify(l.drawPositions),targetStatus:l.matchUpStatus,targetFeedRound:a.feedRound,sourceMatchUpId:n?.matchUpId,sourceStructureId:n?.structureId?.slice(0,8),sourceRound:n?[n.roundNumber,n.roundPosition]:void 0,sourceDP:JSON.stringify(p),sameStructure:f,paramMatchUpStatus:e.matchUpStatus,EXIT:u,DOUBLE_EXIT:c}),f&&Z(p,m)&&(m=m.filter(e=>!p.includes(e))),f&&m.length>1)return Pn({result:{error:Me},stack:d});let{pairedPreviousMatchUpIsDoubleExit:h,pairedPreviousMatchUp:g}=LI({...e,structure:s});gh({method:d,color:"magenta",keyColors:{pairedMatchUpId:"brightcyan"},pairedMatchUpId:g?.matchUpId,pairedRound:g?[g.roundNumber,g.roundPosition]:void 0,pairedStatus:g?.matchUpStatus,pairedStructureId:g?.structureId?.slice(0,8),pairedIsDoubleExit:h});let I=Wf({matchUpId:a.matchUpId,inContextDrawMatchUps:t,drawDefinition:i}),{targetMatchUps:U,targetLinks:S}=I,{loserTargetDrawPosition:v,winnerMatchUp:y,loserMatchUp:w}=U;if(w){let{loserTargetLink:e}=S,t=fN({loserTargetDrawPosition:v,loserMatchUp:w,tournamentRecord:r,loserTargetLink:e,drawDefinition:i,matchUpsMap:o});if(t.error)return Pn({result:t,stack:d})}let P=l.drawPositions?.filter(Boolean)||[],T=1===P.length,D=e.walkoverWinningSide||T&&GI({drawPosition:P[0],matchUpId:a.matchUpId,inContextDrawMatchUps:t})||void 0,b=Sh(l.matchUpStatus)&&!P.length,M=b?c:u;gh({method:d,color:"brightyellow",keyColors:{matchUpStatus:"brightgreen",existingExit:"brightred"},existingExit:b,matchUpStatus:M,targetCurrentStatus:l.matchUpStatus,targetDP:JSON.stringify(P),hasDrawPosition:T,walkoverWinningSide:D});let R,N=t.find(e=>e.matchUpId===g.matchUpId),A=[];n&&(n?.structureId===N?.structureId?R=n.roundPosition<g?.roundPosition?1:2:a.feedRound?R=n.structureId===a.structureId?2:1:D&&(R=3-D),gh({method:d,color:"cyan",keyColors:{sourceSideNumber:"brightgreen"},sourceSideNumber:R,sourceStructureId:n.structureId?.slice(0,8),pairedStructureId:N?.structureId?.slice(0,8),targetStructureId:a.structureId?.slice(0,8),sameStructureAsPaired:n?.structureId===N?.structureId,targetFeedRound:a.feedRound,sourceRP:n.roundPosition,pairedRP:g?.roundPosition}));let E=e.matchUpStatus,C=g?.matchUpStatus;1===R?A=[{matchUpStatus:hN(E),previousMatchUpStatus:E,sideNumber:1},{matchUpStatus:hN(C),previousMatchUpStatus:C,sideNumber:2}]:2===R&&(A=[{matchUpStatus:hN(C),previousMatchUpStatus:C,sideNumber:1},{matchUpStatus:hN(E),previousMatchUpStatus:E,sideNumber:2}]),A.length&&(A=A.map(e=>wn(e))),gh({method:d,color:"brightgreen",keyColors:{matchUpStatus:"brightcyan",winningSide:"brightyellow"},action:"modifyMatchUpScore",targetMatchUpId:l.matchUpId,matchUpStatus:M,winningSide:D,matchUpStatusCodes:JSON.stringify(A),sourceStatus:E,pairedStatus:C});let O=XS({...e,winningSide:D,matchUp:l,matchUpStatusCodes:A,context:d,matchUpStatus:M});if(O.error)return Pn({result:O,stack:d});if(b)return gh({method:d,color:"brightred",decision:"EXISTING_EXIT_triggers_recursive_doubleExitAdvancement",targetMatchUpId:l.matchUpId,matchUpStatus:M}),pN({...e,matchUpStatus:M,targetData:I});if(!y)return Pn({result:{...ce},stack:d});let k=2===m.length?m[D-1]:m[0],{positionAssignments:F}=$d({structure:s}),x=F?.find(e=>e.drawPosition===k),_=o.drawMatchUps.find(e=>e.matchUpId===y.matchUpId),L=_?.drawPositions?.filter(Boolean),B=1===L.length;if(k){if(x?.bye){let r=Wf({matchUpId:_.matchUpId,inContextDrawMatchUps:t,drawDefinition:i});if(B){let r=L.filter(Boolean)[0],n=GI({drawPosition:r,matchUpId:_.matchUpId,inContextDrawMatchUps:t}),a=XS({appliedPolicies:e.appliedPolicies,matchUpId:_.matchUpId,matchUp:_,matchUpStatus:u,matchUpStatusCodes:[],removeScore:!0,context:d,drawDefinition:i,winningSide:n});return a.error?Pn({result:a,stack:d}):Ph({drawPositionToAdvance:r,matchUpId:_.matchUpId,inContextDrawMatchUps:t,drawDefinition:i,matchUpsMap:o})}if(Sh(y.matchUpStatus)){let t=pN({...e,matchUpId:_.matchUpId,matchUpStatus:M,targetData:r});if(t.error)return Pn({result:t,stack:d})}return Pn({result:{...ce},stack:d})}return jI({matchUpId:y.matchUpId,drawPosition:k,inContextDrawMatchUps:t,drawDefinition:i})}if(h){if(!_)return{error:Et};if(B){let e=L[0],r=GI({matchUpId:a.matchUpId,inContextDrawMatchUps:t,drawPosition:e});console.log("existing drawPosition is winningSide",{walkoverWinningSide:r})}let r=Sh(_.matchUpStatus)?u:c,n=XS({matchUpId:_.matchUpId,appliedPolicies:e.appliedPolicies,matchUp:_,matchUpStatusCodes:[],removeScore:!0,context:d,drawDefinition:i,matchUpStatus:r});if(n.error)return Pn({result:n,stack:d});if(r===c){let t=pN({...e,matchUpId:a.matchUpId,matchUpStatus:r,targetData:I});if(t.error)return t}}return Pn({result:{...ce},stack:d})}function fN(e){let{loserTargetDrawPosition:t,tournamentRecord:r,loserTargetLink:i,drawDefinition:n,matchUpsMap:a,event:o,loserMatchUp:s}=e,c=i?.target?.structureId,{structure:u}=Vd({drawDefinition:n,structureId:c});return u?vh({drawPosition:t,tournamentRecord:r,drawDefinition:n,structureId:c,matchUpsMap:a,loserMatchUp:s,event:o}):{error:rt}}function hN(e){return e===yd?Rd:e===vd?Sd:e}function gN(e){let{tournamentRecord:t,drawDefinition:r,matchUpStatus:i,structure:n,matchUp:a}=e,o=!(!a.tieMatchUps||a.rondPosition||!e.inContextDrawMatchUps.find(e=>e.matchUpId===a.matchUpId).containerStructureId),s="attemptToSetMatchUpStatus",c="BYE"===i,u=a.winningSide,d=[yd,vd].includes(i),l=uh({matchUpStatus:i}),p=dh({matchUpStatus:i}),m=!l&&!p,f=e.matchUpTieId||u&&l&&!d,h=u&&d;gh({method:s,newline:!0,color:"brightyellow",keyColors:{matchUpStatus:"brightcyan",matchUpId:"brightmagenta"},matchUpId:a.matchUpId,matchUpStatus:i,existingStatus:a.matchUpStatus,existingWinningSide:u,isDoubleExit:d,isBYE:c,directing:l,nonDirecting:p,unrecognized:m,onlyModifyScore:f,changeCompletedToDoubleExit:h,propagateExitStatus:e.propagateExitStatus,teamRoundRobinContext:o});return gh({method:s,color:"brightgreen",keyColors:{route:"brightcyan"},route:(m?"unrecognized":f&&"onlyModifyScore")||h&&"changeCompletedToDoubleExit"||u&&"existingWinningSide_removeDirected"||p&&"nonDirecting_clearScore"||c&&"isBYE"||!l&&"notDirecting_error"||d&&"isDoubleExit_modifyAndAdvance"||o&&"teamRoundRobinContext"||e.propagateExitStatus&&"propagateExitStatus"||"fallthrough_error",matchUpId:a.matchUpId}),m&&{error:It}||f&&IN(e)||h&&function(e){let t=uN(e);return t.error?t:pN(e)}(e)||u&&uN(e)||p&&XS({...e,removeScore:[gd,Rd].includes(i),matchUpStatus:i||Md})||c&&function({tournamentRecord:e,drawDefinition:t,structure:r,matchUp:i}){let n="attemptToSetMatchUpStatusBYE";if(i?.winningSide)return Pn({result:{error:yt},context:{matchUpStatus:"BYE"},stack:n});let{positionAssignments:a}=qd({structure:r}),o=a?.filter(e=>e.bye).map(e=>e.drawPosition);return i.drawPositions?.some(e=>o?.includes(e))?(i.matchUpStatus="BYE",i.matchUpStatusCodes=[],Dl({tournamentId:e?.tournamentId,context:n,drawDefinition:t,matchUp:i}),{...ce}):Pn({result:{error:gt},info:"matchUp does not include BYE",stack:n})}({tournamentRecord:t,drawDefinition:r,structure:n,matchUp:a})||!l&&{error:It}||d&&function(e){let t=IN({...e,removeScore:!0});return t.error?t:pN(e)}(e)||o&&IN(e)||e.propagateExitStatus&&IN(e)||Pn({result:{error:yt,info:"matchUpStatus: "+i},stack:s})}function IN(e){let t="scoreModification";if(e.isCollectionMatchUp&&e.dualMatchUp?.winningSide&&!e.projectedWinningSide){let r=uN(e);if(r.error)return Pn({result:r,stack:t})}let r=!!e.matchUp.collectionId,i=XS({...e,context:t});if(r){let{matchUpTieId:r,drawDefinition:n,matchUpsMap:a}=e,o=sv({tournamentRecord:e.tournamentRecord,appliedPolicies:e.appliedPolicies,matchUpId:r,event:e.event,drawDefinition:n,matchUpsMap:a});if(o.error)return Pn({result:o,stack:t});Object.assign(i,{tieMatchUpResult:o})}return Pn({result:i,stack:t})}function UN({drawDefinition:e,structure:t,matchUp:r}){let i=[];if(t.finishingPosition===$s&&sU({drawDefinition:e,structure:t})){let{structureIds:n}=function({drawDefinition:e,structure:t,matchUp:r}){let{drawPositions:i}=r,{positionAssignments:n}=$d({drawDefinition:e,structure:t}),a=n?.filter(({drawPosition:e})=>i?.includes(e))?.map(e=>{let{extension:t}=Ru({element:e,name:Ju});return t?.value?.groupOrder}),{containerStructures:o}=Ol({drawDefinition:e}),s=o[t.structureId];return{structureIds:$f({drawDefinition:e,structureId:s})?.links?.source?.filter(e=>Z(a,e.source?.finishingPositions||[])).map(e=>e.source.structureId)}}({drawDefinition:e,structure:t,matchUp:r});n?.length&&i.push(...n)}return{connectedStructureIds:i}}function SN(e){let t,r="attemptToSetWinningSide",i={},{appliedPolicies:n,disableAutoCalc:a,drawDefinition:o,dualMatchUp:s,winningSide:c,structure:u,matchUp:d}=e;if(s?._disableAutoCalc&&!1!==a)return ZS(e);if(d.winningSide&&d.winningSide!==c){let{connectedStructureIds:r}=UN({drawDefinition:o,structure:u,matchUp:d});r.length&&(console.log({connectedStructureIds:r}),t=!0);let i=uN(e);if(i.error)return i}let l,p,m=cv(e);return m.context?.progressExitStatus&&Object.assign(i,m.context),m.error?Pn({result:m,stack:r}):(e.qualifierChanging&&n?.[su]?.autoReplaceQualifiers&&(l=function(e){let t,{inContextDrawMatchUps:r,inContextMatchUp:i,drawDefinition:n,winningSide:a}=e,o=e.targetData.targetLinks?.winnerTargetLink;if(o.target.feedProfile===us){let s=i.sides.find(({sideNumber:e})=>e!==a).participantId,c=r.find(e=>e.structureId===o.target.structureId&&e.roundNumber===o.target.roundNumber&&e.sides.some(({participantId:e})=>e===s));if(c?.matchUpStatus===Md&&!ny({inContextDrawMatchUps:r,drawDefinition:n,targetData:Wf({matchUpId:c.matchUpId,inContextDrawMatchUps:r,drawDefinition:n})})){let{structure:r}=Vd({structureId:c.structureId,drawDefinition:n}),o=$d({structure:r}).positionAssignments;for(let c of o||[])if(c.participantId===s){let s=i.sides.find(({sideNumber:e})=>e===a).participantId;if(c.participantId=s,r?.positionAssignments)r.positionAssignments=o;else if(r?.structures){let e=Object.assign({},...(o||[]).map(e=>({[e.drawPosition]:e.participantId})));for(let t of r.structures)t.positionAssignments?.forEach(t=>t.participantId=e[t.drawPosition])}Nl({tournamentId:e.tournamentRecord?.tournamentId,event:e.event,drawDefinition:n,structure:r}),t=!0}}}return{...ce,qualifierReplaced:t}}(e).qualifierReplaced),e.qualifierAdvancing&&n?.[su]?.autoPlaceQualifiers&&(p=function(e){let t,{inContextDrawMatchUps:r,inContextMatchUp:i,drawDefinition:n,winningSide:a}=e,o=e.targetData.targetLinks?.winnerTargetLink;if(o.target.feedProfile===us){let s=i.sides.find(({sideNumber:e})=>e===a)?.participantId,c=z(r.filter(e=>e.structureId===o.target.structureId&&e.roundNumber===o.target.roundNumber&&e.sides.some(({participantId:e,qualifier:t})=>t&&!e)));if(c?.matchUpStatus===Md&&!ny({inContextDrawMatchUps:r,drawDefinition:n,targetData:Wf({matchUpId:c.matchUpId,inContextDrawMatchUps:r,drawDefinition:n})})){let r=c.sides.find(e=>e.qualifier&&!e.participantId)?.drawPosition,{structure:i}=Vd({structureId:c.structureId,drawDefinition:n});if(!i)return{error:et};let a=$d({structure:i}).positionAssignments;for(let o of a||[])if(o.drawPosition===r&&!o.participantId){if(o.participantId=s,i.positionAssignments)i.positionAssignments=a;else if(i.structures){let e=Object.assign({},...(a||[]).map(e=>({[e.drawPosition]:e.participantId})));for(let t of i.structures)t.positionAssignments?.forEach(t=>t.participantId=e[t.drawPosition])}Nl({tournamentId:e.tournamentRecord?.tournamentId,event:e.event,drawDefinition:n,structure:i}),t=!0}}}return{...ce,qualifierPlaced:t}}(e).qualifierPlaced),Pn({result:wn({...ce,...m,connectedStructures:t,qualifierReplaced:l,qualifierPlaced:p,context:i}),stack:r}))}n(YR,{applyLineUps:()=>aA,assignMatchUpSideParticipant:()=>zR,assignTieMatchUpParticipantId:()=>nN,bulkMatchUpStatusUpdate:()=>XN,checkInParticipant:()=>QR,checkOutParticipant:()=>JR,disableTieAutoCalc:()=>HN,enableTieAutoCalc:()=>$N,findMatchUp:()=>XD,removeDelegatedOutcome:()=>qN,removeMatchUpSideParticipant:()=>sN,removeTieMatchUpParticipantId:()=>oN,replaceTieMatchUpParticipantId:()=>eN,resetAdHocMatchUps:()=>iA,resetMatchUpLineUps:()=>zN,resetScorecard:()=>rA,resetTieFormat:()=>tA,setDelegatedOutcome:()=>eA,setMatchUpFormat:()=>YN,setMatchUpState:()=>GN,setMatchUpStatus:()=>QN,setOrderOfFinish:()=>nA,substituteParticipant:()=>WN,toggleParticipantCheckInState:()=>XR,updateTieMatchUpScore:()=>sv});var vN={drawPositionToRemove:"green",iteration:"brightred",winner:"green",loser:"brightred"};function yN(e){let{inContextDrawMatchUps:t,appliedPolicies:r,drawDefinition:i,matchUpsMap:n,targetData:a,matchUp:o}=e,{matchUpId:s}=o,{iteration:c=0}=e;c+=1;let u="removeDoubleExit";gh({color:"brightyellow",method:u,matchUpId:s,iteration:c,keyColors:vN});let{targetMatchUps:{loserMatchUp:d,winnerMatchUp:l,loserTargetDrawPosition:p},targetLinks:{loserTargetLink:m}}=a;if(l&&"BYE"!==l.matchUpStatus){let{stage:t,roundNumber:r,roundPosition:i,structureName:n}=l;gh({winner:"winner",roundPosition:i,structureName:n,roundNumber:r,keyColors:vN,stage:t}),wN({...e,targetMatchUp:l,sourceMatchUp:o,iteration:c})}let f="BYE"===d?.matchUpStatus&&(d?.feedRound||1===d?.roundNumber);if(f&&a?.targetLinks?.loserTargetLink?.linkCondition===gs){let e=t.filter(({roundNumber:e,structureId:t})=>t===o.structureId&&1===e),r=re(e.map(({roundPosition:e})=>e).sort(),2).find(e=>e.includes(o.roundPosition));if((e.filter(({roundPosition:e})=>r.includes(e))?.map(({matchUpStatus:e})=>e)).every(e=>[vd,yd].includes(e)))return Pn({result:{...ce},stack:u})}if(d&&("BYE"!==d.matchUpStatus||f)){let a=t.find(({matchUpId:e})=>e===d.matchUpId),{structure:o}=Vd({drawDefinition:i,structureId:a.structureId}),{stage:s,roundNumber:l,roundPosition:h,feedRound:g,structureName:I}=d;if(gh({loser:"loser",roundPosition:h,structureName:I,roundNumber:l,keyColors:vN,feedRound:g,stage:s}),r?.progression?.doubleExitPropagateBye||f)lN({drawPosition:p,targetLink:m,inContextDrawMatchUps:t,drawDefinition:i,matchUpsMap:n});else{let t=wN({...e,targetMatchUp:d,structure:o,iteration:c});if(t.error)return Pn({result:t,stack:u})}}return Pn({result:{...ce},stack:u})}function wN(e){let{inContextDrawMatchUps:t,appliedPolicies:r,drawDefinition:i,sourceMatchUp:n,targetMatchUp:a,matchUpsMap:o,structure:s,iteration:c}=e,u="conditionallyRemoveDrawPosition";gh({method:u,structureName:s?.structureName,iteration:c});let d,l,p,m=Wf({matchUpId:a.matchUpId,inContextDrawMatchUps:t,drawDefinition:i}),{targetMatchUps:{winnerMatchUp:f}}=m,h=o?.drawMatchUps.find(e=>e.matchUpId===a.matchUpId);if(a.feedRound)p=f?.drawPositions?.filter(Boolean)?.find(e=>a.drawPositions.includes(e));else if(null==n)p=Q(a?.drawPositions||[],f?.drawPositions||[])?.[0];else{l=BI({structureId:s.structureId,matchUp:n,matchUpsMap:o})?.pairedPreviousMatchUp,d=[yd,vd].includes(l?.matchUpStatus);let e=l?.drawPositions?.filter(Boolean)||[];if([...kd,"BYE"].includes(l?.matchUpStatus)||l?.winningSide){let t=n.drawPositions||[],r=a.drawPositions?.filter(Boolean);Z(t,r)&&(r=r?.filter(e=>!t.includes(e))),p=t.concat(e).find(e=>r?.includes(e))}}if(f&&p){let{stage:e,roundNumber:r,roundPosition:n,structureName:a}=f;gh({method:"removeDirectedWinner",drawPositionToRemove:p,color:"brightgreen",roundPosition:n,structureName:a,roundNumber:r,keyColors:vN,stage:e}),dN({winningDrawPosition:p,winnerMatchUp:f,inContextDrawMatchUps:t,drawDefinition:i,matchUpsMap:o})}let g=yN({targetData:m,matchUp:a,inContextDrawMatchUps:t,appliedPolicies:r,drawDefinition:i,matchUpsMap:o,structure:s,iteration:c});if(g.error)return Pn({result:g,stack:u});let I=function({pairedPreviousDoubleExit:e,noContextTargetMatchUp:t}){return"BYE"===t.matchUpStatus?"BYE":e?[vd,Sd].includes(t?.matchUpStatus)?Sd:Rd:Md}({pairedPreviousDoubleExit:d,noContextTargetMatchUp:h}),U=!d;return g=XS({...e,matchUpId:a.matchUpId,matchUp:h,removeWinningSide:!0,matchUpStatusCodes:[],context:u,matchUpStatus:I,removeScore:U,score:{scoreStringSide1:"",scoreStringSide2:"",sets:void 0}}),g.error?Pn({result:g,stack:u}):{...ce}}function PN(e){let{matchUp:t,matchUpStatus:r,score:i,winningSide:n}=e,a="noDownStreamDependencies";if([yd,vd].includes(t?.matchUpStatus)&&![yd,vd].includes(r)){let t=yN(e);if(t.error)return Pn({result:t,stack:a})}let o=r===yd,s=ch({score:i})&&!o&&(e.isCollectionMatchUp&&!e.projectedWinningSide||!n),c=e?.inContextMatchUp?.collectionId&&function(e){let{matchUpFormat:t,score:r}=e,i=r?.sets?.length,n=t&&Yn(t),{setFormat:a,finalSetFormat:o,bestOf:s}=n??{};return(s&&i===s&&o||a)?.timed||!1}(e.inContextMatchUp),u=e.removeScore||!c&&![Pd,fd].includes(r||Pd),d=e.isCollectionMatchUp&&e.dualMatchUp.winningSide&&!e.projectedWinningSide||t.winningSide&&!n&&!ch({score:i}),l=r=>{let i,{structure:n,drawDefinition:a,dualMatchUp:o,disableAutoCalc:s}=e;if(o?._disableAutoCalc&&!1!==s)return ZS({...e,removeWinningSide:d});let{connectedStructureIds:c}=UN({drawDefinition:a,structure:n,matchUp:t});c.length&&(console.log({connectedStructureIds:c}),i=!0),Object.assign(e,{removeScore:r});let u=uN(e);if(u.error)return u;if(e.removingQualifier&&e.appliedPolicies?.[su]?.autoRemoveQualifiers){let t=function(e){let t,{inContextDrawMatchUps:r,inContextMatchUp:i,drawDefinition:n}=e,a=e.targetData.targetLinks?.winnerTargetLink;if(a.target.feedProfile===us){let o=i.sides?.find(({sideNumber:e})=>e===i.winningSide)?.participantId,s=r.find(e=>e.structureId===a.target.structureId&&e.roundNumber===a.target.roundNumber&&e.sides?.some(({participantId:e})=>e===o));if(s&&s.matchUpStatus===Md&&!ny({inContextDrawMatchUps:r,drawDefinition:n,targetData:Wf({matchUpId:s.matchUpId,inContextDrawMatchUps:r,drawDefinition:n})})){let{structure:r}=Vd({structureId:s.structureId,drawDefinition:n}),i=$d({structure:r}).positionAssignments;for(let a of i||[])if(a.participantId===o){if(a.participantId=void 0,r?.positionAssignments)r.positionAssignments=i;else if(r?.structures){let e=Object.assign({},...(i||[]).map(e=>({[e.drawPosition]:e.participantId})));for(let t of r?.structures||[])t.positionAssignments?.forEach(t=>t.participantId=e[t.drawPosition])}Nl({tournamentId:e.tournamentRecord?.tournamentId,event:e.event,drawDefinition:n,structure:r}),t=!0}}}return{qualifierRemoved:t}}(e);return{...ce,connectedStructures:i,...t}}return{...ce,connectedStructures:i}};if(d&&n&&e.isCollectionMatchUp)return TN(e);let p=[gd,fd].includes(r)&&e.dualWinningSideChange,m=r&&r!==Md,f=e.propagateExitStatus&&Sh(r);return Pn({result:(n||p||f)&&SN(e)||s&&l(u)||m&&gN(e)||d&&l(u)||t&&TN({...e,removeScore:!0})||{...ce},stack:a})}function TN(e){let t="ndd:scoreModification";if(e.isCollectionMatchUp&&e.dualMatchUp?.winningSide&&!e.projectedWinningSide&&!e.autoCalcDisabled){let t=uN(e);if(t.error)return t}let r=XS({...e,context:t});if(e.isCollectionMatchUp){let{matchUpTieId:t,drawDefinition:r,event:i,matchUpsMap:n}=e,{removeWinningSide:a}=sv({tournamentRecord:e.tournamentRecord,appliedPolicies:e.appliedPolicies,matchUpId:t,drawDefinition:r,matchUpsMap:n,event:i});a&&console.log("REMOVE WINNING SIDE")}return Pn({result:r,stack:t})}function DN(e){let t=$c(e,[{[Js]:!0,[Xs]:!0,[mc]:!0},{homeParticipantId:!0,[Dc]:Ir}]);if(t.error)return t;let r=Qb(e,[{[Mc]:Pc,attr:{[hc]:!0}}]);if(r.error)return r;let i=r?.matchUp?.matchUp?.sides?.map(e=>e?.participantId);if(e.homeParticipantId&&!i?.includes(e.homeParticipantId))return{error:dr};let{disableNotice:n,homeParticipantId:a,removePriorValues:o,tournamentRecord:s,drawDefinition:c,matchUpId:u}=e;return KR({duplicateValues:!1,removePriorValues:o,tournamentRecord:s,drawDefinition:c,disableNotice:n,matchUpId:u,timeItem:{itemType:wm,itemValue:a}})}function bN({timeStamp:e,schedule:t,matchUp:r}){let{itemValue:i,timeStamp:n}=pf({timeItems:r?.timeItems||[],itemType:Nm});return!t||n&&e&&new Date(n).getTime()>new Date(e).getTime()?{timeModifiers:i}:t}function MN(e){let t="addMatchUpScheduledTime",r=e.matchUp,{removePriorValues:i,tournamentRecord:n,drawDefinition:a,disableNotice:o,scheduledTime:s,matchUpId:c}=e;if(!c)return Pn({result:{error:Mt},stack:t});if(!ca(s))return Pn({result:{error:Qt},stack:t});if(!r){let e=zS({drawDefinition:a,matchUpId:c});if(e.error)return Pn({result:e,stack:t});r=e.matchUp}let u=ya(s),d=ff({matchUp:r}).scheduledDate,l=u&&!d;if((bN({matchUp:r}).timeModifiers||[])?.length){let e=RN({disableNotice:!0,removePriorValues:i,tournamentRecord:n,timeModifiers:[],drawDefinition:a,matchUpId:c,matchUp:r});if(e?.error)return Pn({result:e,stack:t})}let p=Ta(s,!0,l);return KR({duplicateValues:!1,removePriorValues:i,tournamentRecord:n,drawDefinition:a,disableNotice:o,matchUpId:c,timeItem:{itemType:Tm,itemValue:p}})}function RN({removePriorValues:e,tournamentRecord:t,drawDefinition:r,disableNotice:i,timeModifiers:n,matchUpId:a,matchUp:o}){let s="addMatchUpTimeModifiers";if(!a)return Pn({result:{error:Mt},stack:s});if(void 0!==n&&!Array.isArray(n))return Pn({info:WI("timeModifiers"),result:{error:gi},stack:s});if(!o){let e=zS({drawDefinition:r,matchUpId:a});if(e.error)return Pn({result:e,stack:s});o=e.matchUp}let c=bN({matchUp:o}).timeModifiers||[],u=n.filter(e=>!c.includes(e));if(n.length&&!u.length)return{...ce};if(u.some(e=>Fm.includes(e))){c=c.filter(e=>!Fm.includes(e));let i=MN({disableNotice:!0,removePriorValues:e,scheduledTime:"",tournamentRecord:t,drawDefinition:r,matchUpId:a});if(i.error)return Pn({result:i,stack:s})}let d=n?.length?[...u,...c]:void 0;return KR({duplicateValues:!1,removePriorValues:e,tournamentRecord:t,drawDefinition:r,disableNotice:i,matchUpId:a,timeItem:{itemType:Nm,itemValue:d}})}function NN({scheduledDate:e,removePriorValues:t,tournamentRecord:r,drawDefinition:i,disableNotice:n,matchUpId:a}){if(!a)return{error:Mt};let o=e&&na.test(e);return e&&!o?{error:Jt}:KR({duplicateValues:!1,removePriorValues:t,tournamentRecord:r,drawDefinition:i,disableNotice:n,matchUpId:a,timeItem:{itemValue:ya(e),itemType:ym}})}function AN({removePriorValues:e,tournamentRecords:t,tournamentRecord:r,drawDefinition:i,disableNotice:n,courtDayDate:a,matchUpId:o,courtIds:s}){if(!r&&!t)return{error:Ie};if(!o)return{error:Mt};let c,u=zS({drawDefinition:i,matchUpId:o});if(u.error)return u;if(u?.matchUp?.matchUpType!==p)return{error:Ct};if(!(void 0===s||Array.isArray(s)&&s.length&&s.every(e=>"string"==typeof e)))return{error:gi,context:{courtIds:s}};if(s){let e=jv({tournamentRecords:t||r&&{[r.tournamentId]:r}});if(e.error)return e;let i=e.courts?.filter(e=>s.includes(e.courtId));if(i?.length!==s.length)return{error:gi,context:{courtIds:s}};c=i?.map(e=>({venueId:e.venueId,courtId:e.courtId}))}return KR({duplicateValues:!1,removePriorValues:e,tournamentRecord:r,drawDefinition:i,disableNotice:n,matchUpId:o,timeItem:{itemType:Um,itemDate:a,itemValue:c}})}function EN({removePriorValues:e,tournamentRecords:t,tournamentRecord:r,drawDefinition:i,disableNotice:n,matchUpId:a,venueId:o}){if(!r)return{error:Ie};if(!a)return{error:Mt};if(o){let e=Pf({tournamentRecords:t,tournamentRecord:r,venueId:o});if(e.error)return e}return KR({duplicateValues:!1,removePriorValues:e,tournamentRecord:r,drawDefinition:i,disableNotice:n,matchUpId:a,timeItem:{itemType:Im,itemValue:o}})}function CN({removePriorValues:e,tournamentRecords:t,tournamentRecord:r,drawDefinition:i,disableNotice:n,courtDayDate:a,matchUpId:o,courtId:s}){if(!r&&!t)return{error:Ie};if(!o)return{error:Mt};if(s){let e=Df({tournamentRecords:t,tournamentRecord:r,courtId:s});if(e.error)return e;let a=e.venue?.venueId;EN({tournamentRecords:t,tournamentRecord:r,drawDefinition:i,disableNotice:n,matchUpId:o,venueId:a})}return KR({duplicateValues:!1,removePriorValues:e,tournamentRecord:r,drawDefinition:i,disableNotice:n,matchUpId:o,timeItem:{itemType:Sm,itemDate:a,itemValue:s}})}function ON(e,t){let r=ia.test(e)?e:va(e),i=ya(e)||ya(t)||la(new Date);return new Date(`${i}T${r}`).getTime()}function kN(e){let t="addMatchUpScheduleItems",r=$c(e,[{drawDefinition:!0,matchUpId:!0},{schedule:!0,[_c]:Cc}],t);if(r.error)return r;let i,n,{matchUpDependencies:a,inContextMatchUps:o}=e,{proConflictDetection:s=!1,errorOnAnachronism:c=!1,checkChronology:u=!0,removePriorValues:d,tournamentRecords:l,tournamentRecord:p,drawDefinition:m,disableNotice:f,drawMatchUps:h,matchUpId:g,schedule:U,event:v}=e;if(h)i=h.find(e=>e.matchUpId===g);else{let e=zS({drawDefinition:m,event:v,matchUpId:g});if(e.error)return e;i=e.matchUp}let{endTime:y,courtId:w,courtIds:P,courtOrder:T,resumeTime:D,homeParticipantId:b,scheduledDate:M,scheduledTime:R,startTime:N,stopTime:A,timeModifiers:E,venueId:C}=U;u&&(!a||!o)&&({matchUpDependencies:a,matchUps:o}=sh({drawDefinition:m}));let O=a?.[g]?.matchUpIds;if(U.scheduledDate&&u&&O){let e=o?.filter(e=>(e.schedule?.scheduledDate||ya(e.schedule?.scheduledTime))&&O.includes(e.matchUpId)).map(({schedule:e})=>{let t=oa(e);return new Date(t??"").getTime()});if(e?.length){let r=oa(U),i=new Date(r??"").getTime();if(Math.max(...e)>=i){if(c)return Pn({result:{error:pe},stack:t});n=pe}}}if(void 0!==M){let e=NN({disableNotice:!0,removePriorValues:d,tournamentRecord:p,drawDefinition:m,scheduledDate:M,matchUpId:g});if(e?.error)return Pn({result:e,stack:t,context:{scheduledDate:M}})}if(void 0!==R){let e=MN({disableNotice:!0,removePriorValues:d,tournamentRecord:p,drawDefinition:m,scheduledTime:R,matchUpId:g,matchUp:i});if(e?.error)return Pn({result:e,stack:t,context:{scheduledTime:R}})}if(void 0!==N){let e=_N({disableNotice:!0,removePriorValues:d,tournamentRecord:p,drawDefinition:m,matchUpId:g,startTime:N,event:v});if(e?.error)return Pn({result:e,stack:t,context:{startTime:N}})}if(void 0!==A){let e=BN({disableNotice:!0,removePriorValues:d,tournamentRecord:p,drawDefinition:m,matchUpId:g,stopTime:A,event:v});if(e?.error)return Pn({result:e,stack:t,context:{stopTime:A}})}if(void 0!==D){let e=VN({disableNotice:!0,removePriorValues:d,tournamentRecord:p,drawDefinition:m,resumeTime:D,matchUpId:g,event:v});if(e?.error)return Pn({result:e,stack:t,context:{resumeTime:D}})}if(void 0!==y){let e=LN({disableNotice:!0,removePriorValues:d,tournamentRecord:p,drawDefinition:m,matchUpId:g,endTime:y,event:v});if(e?.error)return Pn({result:e,stack:t,context:{endTime:y}})}if(void 0!==P){let e=AN({disableNotice:!0,removePriorValues:d,tournamentRecord:p,drawDefinition:m,matchUpId:g,courtIds:P});if(e?.error)return Pn({result:e,stack:t,context:{courtIds:P}})}if(s&&void 0!==w&&void 0!==M&&void 0!==T&&F(T)){let e=I(T),r=(Xf({tournamentRecord:p})?.matchUps??[]).find(t=>{if(t.matchUpId===g)return!1;let r=t.schedule?.courtOrder?I(t.schedule.courtOrder):void 0;return t.schedule?.courtId===w&&r===e&&t.schedule?.scheduledDate===M});if(r)return Pn({result:{error:Ne,info:`Court slot already occupied by matchUp ${r.matchUpId}`},stack:t,context:{courtId:w,courtOrder:T,scheduledDate:M}})}if(void 0!==w&&void 0!==M){let e=CN({courtDayDate:M,disableNotice:!0,removePriorValues:d,tournamentRecords:l,tournamentRecord:p,drawDefinition:m,matchUpId:g,courtId:w});if(e?.error)return Pn({result:e,stack:t,context:{courtId:w}})}if(void 0!==C){let e=EN({disableNotice:!0,removePriorValues:d,tournamentRecords:l,tournamentRecord:p,drawDefinition:m,matchUpId:g,venueId:C});if(e?.error)return Pn({result:e,stack:t,context:{venueId:C}})}if(void 0!==T&&F(T)){let e=FN({disableNotice:!0,removePriorValues:d,tournamentRecord:p,drawDefinition:m,courtOrder:T,matchUpId:g});if(e?.error)return Pn({result:e,stack:t,context:{courtOrder:T}})}if(void 0!==E){let e=RN({disableNotice:!0,removePriorValues:d,tournamentRecord:p,drawDefinition:m,timeModifiers:E,matchUpId:g,matchUp:i});if(e?.error)return Pn({result:e,stack:t,context:{timeModifiers:E}})}return S(b)&&DN({disableNotice:!0,homeParticipantId:b,removePriorValues:d,tournamentRecord:p,drawDefinition:m,matchUpId:g}),f||Dl({tournamentId:p?.tournamentId,eventId:v?.eventId,context:t,drawDefinition:m,matchUp:i}),n?{...ce,warnings:[n]}:{...ce}}function FN({removePriorValues:e,tournamentRecord:t,drawDefinition:r,disableNotice:i,courtOrder:n,matchUpId:a}){if(!a)return{error:Mt};if(n&&!F(n))return{error:gi,info:"courtOrder must be numeric"};let o=n&&I(n);return KR({duplicateValues:!1,removePriorValues:e,tournamentRecord:t,drawDefinition:r,disableNotice:i,matchUpId:a,timeItem:{itemType:vm,itemValue:o}})}function xN({removePriorValues:e,tournamentRecord:t,drawDefinition:r,disableNotice:i,participantId:n,officialType:a,matchUpId:o}){if(!o)return{error:Mt};if(!n)return{error:Ir};if(t){if(!hu({tournamentParticipants:Ag({tournamentRecord:t,participantFilters:{participantTypes:[Vl],participantRoles:[eI]}}).participants??[],participantId:n}))return{error:Sr}}let s={itemType:"SCHEDULE.ASSIGNMENT.OFFICIAL",itemValue:n};return a&&(s.itemSubTypes=[a]),KR({duplicateValues:!1,removePriorValues:e,tournamentRecord:t,drawDefinition:r,disableNotice:i,matchUpId:o,timeItem:s})}function _N({removePriorValues:e,tournamentRecord:t,drawDefinition:r,disableNotice:i,matchUpId:n,startTime:a,event:o}){if(!n)return{error:Mt};if(!ca(a))return{error:Qt};let{matchUp:s}=zS({drawDefinition:r,event:o,matchUpId:n}),{scheduledDate:c}=ff({matchUp:s}),u=(s?.timeItems??[]).filter(e=>[bm,Mm,Rm].includes(e?.itemType)).map(e=>ON(e.itemValue,c)).reduce((e,t)=>!e||t<e?t:e,void 0);if(!u||ON(a,c)<u){s?.timeItems&&(s.timeItems=s.timeItems.filter(e=>e.itemType!==Dm));let o=Ta(a,!0,!0);return KR({duplicateValues:!1,removePriorValues:e,tournamentRecord:t,drawDefinition:r,disableNotice:i,matchUpId:n,timeItem:{itemType:Dm,itemValue:o}})}return{error:Xr}}function LN({validateTimeSeries:e=!0,removePriorValues:t,tournamentRecord:r,drawDefinition:i,disableNotice:n,matchUpId:a,endTime:o,event:s}){if(!a)return{error:Mt};if(!ca(o))return{error:Qt};let{matchUp:c}=zS({drawDefinition:i,event:s,matchUpId:a}),{scheduledDate:u}=ff({matchUp:c}),d=(c?.timeItems??[]).filter(e=>[Dm,Mm,bm].includes(e?.itemType)).map(e=>ON(e.itemValue,u)).reduce((e,t)=>!e||t>e?t:e,void 0);if(!e||!d||ON(o,u)>d){c?.timeItems&&(c.timeItems=c.timeItems.filter(e=>e.itemType!==Rm));let e=Ta(o,!0,!0);return KR({duplicateValues:!1,removePriorValues:t,tournamentRecord:r,drawDefinition:i,disableNotice:n,matchUpId:a,timeItem:{itemType:Rm,itemValue:e}})}return{error:Kr}}function BN({removePriorValues:e,tournamentRecord:t,drawDefinition:r,disableNotice:i,matchUpId:n,stopTime:a,event:o}){if(!n)return{error:Mt};if(!ca(a))return{error:Qt};let{matchUp:s}=zS({drawDefinition:r,event:o,matchUpId:n}),{scheduledDate:c}=ff({matchUp:s}),u=s?.timeItems??[];if(u.reduce((e,t)=>t.itemType===Rm||e,void 0))return{error:Jr};let d=u.filter(e=>[Dm,Mm,bm].includes(e?.itemType)).sort((e,t)=>ON(e.itemValue,c)-ON(t.itemValue,c)),l=d.at(-1),p=l?.itemType===bm,m=d.filter(e=>!p||e.createdAt!==l.createdAt).map(e=>ON(e.itemValue,c)).reduce((e,t)=>!e||t>e?t:e,void 0);if(ON(a,c)>m){if(s?.timeItems&&p){let e=l.createdAt;s.timeItems=s.timeItems.filter(t=>t.createdAt!==e)}return KR({duplicateValues:!0,removePriorValues:e,tournamentRecord:t,drawDefinition:r,disableNotice:i,matchUpId:n,timeItem:{itemValue:Ta(a,!0,!0),itemType:bm}})}return{error:Qr}}function VN({removePriorValues:e,tournamentRecord:t,drawDefinition:r,disableNotice:i,resumeTime:n,matchUpId:a,event:o}){if(!a)return{error:Mt};if(!ca(n))return{error:Qt};let{matchUp:s}=zS({drawDefinition:r,event:o,matchUpId:a}),{scheduledDate:c}=ff({matchUp:s}),u=s?.timeItems??[];if(u.reduce((e,t)=>t.itemType===Rm||e,void 0))return{error:Jr};let d=u.filter(e=>[Dm,Mm,bm].includes(e?.itemType)).sort((e,t)=>ON(e.itemValue,c)-ON(t.itemValue,c)),l=d.at(-1),p=l?.itemType===Mm,m=d.filter(e=>!p||e.createdAt!==l.createdAt).map(e=>ON(e.itemValue,c)).reduce((e,t)=>!e||t>e?t:e,void 0);if(ON(n,c)>m){if(s?.timeItems&&p){let e=l.createdAt;s.timeItems=s.timeItems.filter(t=>t.createdAt!==e)}return KR({duplicateValues:!0,removePriorValues:e,tournamentRecord:t,drawDefinition:r,disableNotice:i,matchUpId:a,timeItem:{itemValue:Ta(n,!0,!0),itemType:Mm}})}return{error:Zr}}function GN(e){let t="setMatchUpStatus";e.matchUpStatus&&[Rd,yd].includes(e.matchUpStatus)&&(e.score=void 0);let{allowChangePropagation:r,disableScoreValidation:i,propagateExitStatus:n,tournamentRecords:a,tournamentRecord:o,disableAutoCalc:s,enableAutoCalc:c,drawDefinition:u,matchUpStatus:d,winningSide:l,matchUpId:p,event:f,score:h}=e;if(!u)return{error:ye};if(d&&[gd,Pd,fd,Md].includes(d)&&l)return{error:gi,winningSide:l,matchUpStatus:d};if(![void 0,...Ed].includes(d))return Pn({result:{error:yt},info:"matchUpStatus does not exist",stack:"setMatchUpStatus"});let g=Kp({drawDefinition:u}),{matchUps:I}=Kf({nextMatchUps:!0,tournamentRecord:o,inContext:!0,drawDefinition:u,matchUpsMap:g,event:f}),U=g.drawMatchUps.find(e=>e.matchUpId===p),S=I?.find(e=>e.matchUpId===p);if(!U||!I)return{error:Nt};if((U.winningSide||l)&&"BYE"===d)return{context:"Cannot have Bye with winningSide",error:St,matchUpStatus:d};let y=S?.structureId,{structure:w}=Vd({drawDefinition:u,structureId:y}),P=Wm(m)(U.matchUpType),T=S?.drawPositions?.filter(Boolean),D=S?.matchUpTieId,b=Wf({matchUpId:D||p,inContextDrawMatchUps:I,drawDefinition:u});Object.assign(e,{inContextDrawMatchUps:I,inContextMatchUp:S,matchUpTieId:D,matchUpsMap:g,targetData:b,structure:w,matchUp:U});let M=d===Md&&""===h?.scoreStringSide1&&""===h?.scoreStringSide2&&!l;if(function(e){let{targetData:t,matchUpsMap:r}=e,{targetMatchUps:{loserMatchUp:i}}=t,n=Sh(i?.matchUpStatus),a=!!r?.drawMatchUps.find(e=>e.loserMatchUpId===i?.matchUpId&&Sh(e.matchUpStatus));return a&&i?.matchUpStatus===yd||a&&n}(e)&&M)return{error:vt};let R,N=ny(e);if(P){if(s)Uu({extension:{name:Ou,value:!0},element:U});else if(c){let t=U.winningSide,{winningSide:r,scoreStringSide1:i,scoreStringSide2:n,set:a}=rv({drawDefinition:u,matchUpsMap:g,structure:w,matchUp:U,event:f}),o={scoreStringSide1:i,scoreStringSide2:n,sets:a?[a]:[]};if(R=r!==t,N&&R)return Pn({stack:"winningSideWithDownstreamDependencies",result:{error:cr},context:{winningSide:l,matchUp:U}});gu({name:Ou,element:U}),Object.assign(e,{winningSide:r,dualWinningSideChange:R,projectedWinningSide:r,score:o})}iv({tournamentId:o?.tournamentId,inContextDualMatchUp:S,eventId:f?.eventId,dualMatchUp:U,drawDefinition:u})}if(P&&d&&[hd].includes(d))return{info:"Not supported for matchUpType: TEAM",error:gi};if(h&&!P&&!i){let e=U.matchUpFormat??w?.matchUpFormat??u?.matchUpFormat??f?.matchUpFormat,t=TT({existingMatchUpStatus:U.matchUpStatus,matchUpFormat:e,matchUpStatus:d,winningSide:l,score:h});if(t.error)return t}let A=up({policyTypes:[su,du],tournamentRecord:o,drawDefinition:u,event:f})?.appliedPolicies??{};v(e.policyDefinitions)&&Object.assign(A,e.policyDefinitions);let E=function({assignedDrawPositions:e,propagateExitStatus:t,inContextMatchUp:r,appliedPolicies:i,drawDefinition:n,matchUpStatus:a,structure:o,matchUp:s}){if(!1===i?.[du]?.requireParticipantsForScoring)return{...ce};let c=r?.sides?.map(e=>e.participantId).filter(Boolean).length,u=s?.sides?[]:$d({structureId:o?.structureId,drawDefinition:n}).positionAssignments,d=c&&2===c||s.collectionId&&nm({structure:o})&&c&&c>=1||2===e?.length&&u?.filter(t=>e.includes(t.drawPosition)).every(e=>e.participantId);return a&&[Rd,Sd,yd].includes(a)&&1===c&&t?{...ce}:a&&Ad.includes(a)&&!d?Pn({info:"matchUpStatus requires assigned participants",context:{matchUpStatus:a,requiredParticipants:d},result:{error:yt}}):{...ce}}({assignedDrawPositions:T,propagateExitStatus:n,inContextMatchUp:S,appliedPolicies:A,drawDefinition:u,matchUpStatus:d,structure:w,matchUp:U});if(E?.error)return E;let C=S?.stage===Yo&&1===S.finishingRound,O=C&&l,k=C&&U.winningSide&&!l&&(!e.matchUpStatus||e.matchUpStatus&&dh({matchUpStatus:e.matchUpStatus}))&&(!e.outcome||!ch({outcome:e.outcome})),F=O&&l!==U.winningSide&&U.winningSide;if(Object.assign(e,{qualifierAdvancing:O,qualifierChanging:F,removingQualifier:k,appliedPolicies:A}),D){let{matchUp:t}=zS({matchUpId:D,inContext:!0,drawDefinition:u,matchUpsMap:g,event:f});if(t){let r=zp({matchUp:t,drawDefinition:u,structure:w,event:f})?.tieFormat,{projectedWinningSide:i}=function({drawDefinition:e,matchUpStatus:t,matchUpsMap:r,winningSide:i,dualMatchUp:n,tieFormat:a,structure:o,matchUp:s,event:c,score:u}){let d=Wa(n,void 0,!0);for(let p of d?.tieMatchUps||[])p.matchUpId===s.matchUpId&&(p.winningSide=i,p.score=u,ch({score:u})||t?t&&(p.matchUpStatus=t):Object.assign(p,{...QS}));a=a??zp({matchUp:s,structure:o,drawDefinition:e,event:c})?.tieFormat;let{winningSide:l}=rv({matchUp:d,drawDefinition:e,matchUpsMap:r,structure:o,tieFormat:a,event:c});return{projectedWinningSide:l}}({drawDefinition:u,matchUpStatus:d,dualMatchUp:t,matchUpsMap:g,winningSide:l,tieFormat:r,structure:w,matchUp:U,event:f,score:h});R=i!==t.winningSide;let n=t._disableAutoCalc;Object.assign(e,{isCollectionMatchUp:!0,dualWinningSideChange:R,projectedWinningSide:i,autoCalcDisabled:n,matchUpTieId:D,dualMatchUp:t,tieFormat:r})}}let x=uh({matchUpStatus:d});if(!D){if(N&&!l&&(d&&dh({matchUpStatus:d})||d&&[yd,vd].includes(d)))return{error:St,activeDownstream:N,winningSide:l};if(l&&l===U.winningSide&&d&&!x)return{context:"winningSide must include directing matchUpStatus",error:St,directingMatchUpStatus:x,matchUpStatus:d}}let{schedule:_}=e;if(_){let e=kN({disableNotice:!0,tournamentRecords:a,tournamentRecord:o,drawDefinition:u,matchUpId:p,schedule:_});if(e.error)return e}let L=!P&&!R&&l&&U.winningSide&&U.winningSide!==l;if(r&&L&&U.roundPosition)return function(e){let{tournamentRecord:t,inContextMatchUp:r,structure:i,drawDefinition:n}=e,a=r.roundNumber,o=r.sides.find(e=>e.sideNumber===r.winningSide),s=r.sides.find(e=>e.sideNumber!==r.winningSide),{drawPosition:c,participantId:u}=o,{drawPosition:d,participantId:l}=s,p="swapWinnerLoser",{matchUps:m}=Bf(e),f=m.filter(({drawPositions:e,roundNumber:t})=>e?.includes(c)&&t>a);$i({changeWinner:!0})&&console.log({existingWinnerSubsequentMatchUps:f}),f.forEach(r=>{r.drawPositions=r.drawPositions?.map(e=>e===c?d:e)||[],Dl({tournamentId:t?.tournamentId,eventId:e.event?.eventId,context:p,drawDefinition:n,matchUp:r})});let{stage:h,stageSequence:g}=i,I=n.structures.filter(({stage:e,stageSequence:t})=>e===h&&t>g).map(({structureId:e})=>e),{targetLinks:{loserTargetLink:U,winnerTargetLink:S}}=e.targetData,v=[U?.target.structureId,S?.target?.structureId].filter(Boolean);return n.structures.filter(({stage:e,structureId:t})=>e!==h&&v.includes(t)).forEach(({stage:e,stageSequence:t,structureId:r})=>{I.includes(r)||I.push(r),n.structures.filter(({stage:r,stageSequence:i})=>r===e&&i>t).forEach(({structureId:e})=>{I.includes(e)||I.push(e)})}),n.structures.filter(({structureId:e})=>I.includes(e)).forEach(e=>{let{positionAssignments:t}=$d({structure:e}),r=t?.find(({participantId:e})=>e===u),i=t?.find(({participantId:e})=>e===l);r&&(r.participantId=l),i&&(i.participantId=u)}),XS({...e,context:p})}(e);let B=l&&!D||e.projectedWinningSide;gh({activeDownstream:N,matchUpWinner:B,method:t,winningSide:l});let V=!N&&PN(e)||B&&function(e){let{matchUp:t,winningSide:r,matchUpTieId:i,dualWinningSideChange:n}=e;return r===t.winningSide||i&&!n?jN(e):Pn({stack:"winningSideWithDownstreamDependencies",result:{error:cr},context:{winningSide:r,matchUp:t}})}(e)||(x||e.autoCalcDisabled)&&jN(e)||{error:Si};return Pn({result:V,stack:t})}function jN(e){let{tournamentRecord:t,matchUp:r,event:i}=e,n=e.isCollectionMatchUp&&r.winningSide&&!e.winningSide&&!ch({score:e.score}),a=e.isCollectionMatchUp?e.matchUpStatus||n&&Md||e.winningSide&&Id||Pd:e.matchUpStatus||Id,o=e.removeScore||[gd,Rd].includes(a)&&![Pd,fd].includes(a),s=XS({...e,matchUpStatus:a,removeWinningSide:n,context:"sms",removeScore:o});if(s.error)return s;if(e.isCollectionMatchUp){let{matchUpTieId:r,drawDefinition:n,matchUpsMap:a}=e,o=sv({appliedPolicies:e.appliedPolicies,matchUpId:r,tournamentRecord:t,drawDefinition:n,matchUpsMap:a,event:i});if(o.error)return o;Object.assign(s,{tieMatchUpResult:o})}return s}function $N({tournamentRecord:e,drawDefinition:t,matchUpId:r,event:i}){if(!t)return{error:ye};let{matchUp:n}=zS({drawDefinition:t,matchUpId:r,event:i});return n?.matchUpType!==p?{error:Ct}:GN({enableAutoCalc:!0,tournamentRecord:e,drawDefinition:t,matchUpId:r,event:i})}function qN({drawDefinition:e,event:t,matchUpId:r}){if(!e)return{error:ye};if(!r)return{error:Mt};let{matchUp:i}=zS({drawDefinition:e,event:t,matchUpId:r});return i?gu({name:Eu,element:i}):{error:Nt}}function WN(e){return function({substituteParticipantId:e,existingParticipantId:t,tournamentRecord:r,drawDefinition:i,sideNumber:n,matchUpId:a,event:o}){let s="substituteParticipant";if(!i)return{error:ye};if(!a)return{error:Mt};if(!t||!e)return Pn({result:{error:Ir},stack:s});let{matchUp:c}=zS({drawDefinition:i,matchUpId:a,event:o});if(!c)return{error:Nt};if(!c.collectionId)return Pn({result:{error:Ct},stack:s});let u=Kp({drawDefinition:i}),{matchUps:d}=Kf({tournamentParticipants:r?.participants,inContext:!0,drawDefinition:i,matchUpsMap:u}),l=d?.find(e=>e.matchUpId===a),p=d?.find(e=>e.matchUpId===l?.matchUpTieId)?.sides?.find(e=>e.participant.individualParticipants.some(({participantId:e})=>e===t));return!p||n&&p.sideNumber!==n?{error:dr}:p.participant?.individualParticipants?.map(dd).filter(e=>e!==t)?.includes(e)?eN({newParticipantId:e,tieMatchUpId:a,existingParticipantId:t,substitution:!0,tournamentRecord:r,drawDefinition:i,event:o}):Pn({result:{error:dr},stack:s})}(e)}function HN({drawDefinition:e,matchUpId:t,event:r}){if(!e)return{error:ye};let{matchUp:i}=zS({drawDefinition:e,matchUpId:t,event:r});return Uu({extension:{name:Ou,value:!0},element:i})}function YN(e){let t="setMatchUpFormat",r=$c(e,[{tournamentRecord:!0},{[kc]:e=>ta({matchUpFormat:e}),[xc]:Ut,matchUpFormat:!0}]);if(r.error)return Pn({result:r,stack:t});let{tournamentRecord:i,drawDefinition:n,scheduledDates:a,stageSequences:o,matchUpFormat:s,structureId:c,eventType:u,matchUpId:d,eventId:l,stages:p,drawId:m,event:f,force:h}=e;if(a&&!Array.isArray(a))return Pn({result:{error:gi,scheduledDates:a},stack:t});if(u&&!se([Bo,Go],u))return Pn({result:{error:at},stack:t});let g=0,I=e.structureIds||c&&[c].filter(Boolean)||[],U=e.eventIds||l&&[l].filter(Boolean)||[],S=e.drawIds||m&&[m].filter(Boolean)||[];if((c||I?.length)&&!n)return Pn({result:{error:ye},stack:t});if(m&&d&&n){let e=hD({tournamentRecord:i,drawDefinition:n,matchUpFormat:s,structureIds:I,structureId:c,matchUpId:d});if(e.error)return e;g+=1}let v=e=>{let r=[];for(let n of e.structures||[]){if(Array.isArray(p)&&!p.includes(n.stage)||Array.isArray(o)&&!o.includes(n.stageSequence)||I?.length&&!I.includes(n.structureId))continue;I?.length&&n.matchUpFormat!==s&&(n.matchUpFormat=s,r.push(n.structureId),g+=1);let c=((h||a)&&Bf({matchUpFilters:{matchUpStatuses:[Md]},structure:n}).matchUps)??[],u=(a&&Bf({matchUpFilters:{matchUpStatuses:[Md]},contextFilters:{scheduledDates:a},afterRecoveryTimes:!1,inContext:!0,structure:n}).matchUps)??[];if(c?.length){let r=u?u.map(ld):c.map(ld);for(let n of c)r.includes(n.matchUpId)&&(n.matchUpFormat=a?.length?s:void 0,Dl({tournamentId:i?.tournamentId,eventId:f?.eventId,context:t,drawDefinition:e,matchUp:n}))}}return!r.length&&e.matchUpFormat!==s&&(e.matchUpFormat=s,g+=1),r};for(let y of i?.events||[])if(!(U?.length&&!U.includes(y.eventId)||u&&u!==y.eventType||u===$o))if(Array.isArray(o)||Array.isArray(p)||I?.length||S?.length)for(let e of y.drawDefinitions||[]){if(Array.isArray(S)&&!S.includes(e.drawId))continue;Ml({structureIds:v(e),drawDefinition:e})}else y.matchUpFormat!==s&&(y.matchUpFormat=s,g+=1);return g?{...ce,modificationsCount:g}:{...ce,info:ci}}function zN({inheritance:e=!0,tournamentRecord:t,drawDefinition:r,matchUpId:i,event:n}){if(!r)return{error:ye};let a=zS({drawDefinition:r,matchUpId:i})?.matchUp;if(!a?.tieMatchUps)return{error:Ct};let o=zS({inContext:!0,drawDefinition:r,matchUpId:i,event:n})?.matchUp,s=0;return(a?.sides||[]).forEach(e=>{e.lineUp&&delete e.lineUp}),(o?.sides||[]).forEach(i=>{if(s+=1,!1===e){let e=o?.tieFormat,t=i.participantId;e&&t&&YI({drawDefinition:r,participantId:t,lineUp:[],tieFormat:e})}Dl({tournamentId:t?.tournamentId,context:"resetMatchUpLineUps",eventId:n?.eventId,drawDefinition:r,matchUp:a})}),{...ce,modificationsCount:s}}function KN(e){let{matchUpFormat:t,matchUpStatus:r,winningSide:i,score:n,setTBlast:a}=e;if(!n)return{sets:[]};let o=n.sets||[],s=vw({winnerFirst:!1,matchUpFormat:t,matchUpStatus:r,setTBlast:a,sets:o}),c=vw({winnerFirst:!1,reversed:!0,matchUpFormat:t,matchUpStatus:r,setTBlast:a,sets:o}),u=vw({matchUpFormat:t,matchUpStatus:r,winningSide:i,setTBlast:a,sets:o}),d=s===u?c:s;return i&&(s=1===i?u:d,c=2===i?u:d),{score:{sets:o,scoreStringSide1:s,scoreStringSide2:c}}}function JN({sourceMatchUpStatusCodes:e,propagateExitStatus:t,sourceMatchUpStatus:r,loserParticipantId:i,tournamentRecord:n,drawDefinition:a,loserMatchUp:o,matchUpsMap:s,event:c}){let u="progressExitStatus";gh({method:u,newline:!0,color:"magenta",keyColors:{loserMatchUpId:"brightcyan",sourceMatchUpStatus:"brightyellow"},loserMatchUpId:o?.matchUpId,loserMatchUpStatus:o?.matchUpStatus,sourceMatchUpStatus:r,sourceMatchUpStatusCodes:JSON.stringify(e),loserParticipantId:i?.slice(0,8),propagateExitStatus:t});let d=Sh(r)&&r!==Dd&&r||Rd,l=Kf({inContext:!0,drawDefinition:a,matchUpsMap:s})?.matchUps,p=d,m=l?.find(e=>e.matchUpId===o?.matchUpId);if(gh({method:u,color:"magenta",carryOverMatchUpStatus:d,updatedLoserMatchUpId:m?.matchUpId,updatedLoserStatus:m?.matchUpStatus,updatedLoserSides:JSON.stringify(m?.sides?.map(e=>({sn:e.sideNumber,pid:e.participantId?.slice(0,8),bye:e.bye}))),updatedLoserDP:JSON.stringify(m?.drawPositions),existingStatusCodes:JSON.stringify(m?.matchUpStatusCodes)}),m?.matchUpId&&p){let r,s=m.matchUpStatusCodes?.map(e=>"string"==typeof e?e:"WO")??[],d=m.sides?.find(e=>e.participantId===i);if(d?.sideNumber){let t=m?.sides?.reduce((e,t)=>t?.participantId?e+1:e,0);if(gh({method:u,color:"brightyellow",keyColors:{decision:"brightgreen"},loserSideNumber:d.sideNumber,participantsCount:t,statusCodesLength:s.length,existingStatusCodes:JSON.stringify(s),loserMatchUpIsExit:Sh(o.matchUpStatus),loserMatchUpOriginalStatus:o.matchUpStatus}),1===t&&0===s.length)r=1===d.sideNumber?2:1,s[0]=e[0],gh({method:u,color:"brightgreen",decision:"SINGLE_PARTICIPANT_no_existing_codes",winningSide:r,statusCodes:JSON.stringify(s)});else if(Sh(o.matchUpStatus)){let t=s[0];s[d.sideNumber-1]=e[0],s[(1===d.sideNumber?2:1)-1]=t,p=yd,r=void 0,gh({method:u,color:"brightred",decision:"BOTH_EXITS_converting_to_DOUBLE_WALKOVER",loserMatchUpStatus:p,winningSide:r,statusCodes:JSON.stringify(s)})}else r=1===d.sideNumber?2:1,s[0]=e[0],gh({method:u,color:"brightgreen",decision:"TWO_PARTICIPANTS_not_exit",winningSide:r,statusCodes:JSON.stringify(s)})}else gh({method:u,color:"brightyellow",decision:"NO_LOSER_PARTICIPANT_SIDE_FOUND",loserParticipantId:i?.slice(0,8),availableSides:JSON.stringify(m.sides?.map(e=>({sn:e.sideNumber,pid:e.participantId?.slice(0,8)})))});return gh({method:u,color:"brightmagenta",keyColors:{finalStatus:"brightgreen",finalWinningSide:"brightyellow"},action:"calling_setMatchUpState",loserMatchUpId:o.matchUpId,finalStatus:p,finalWinningSide:r,finalStatusCodes:JSON.stringify(s)}),Pn({result:GN({matchUpStatus:p,matchUpId:o.matchUpId,matchUpStatusCodes:s,allowChangePropagation:!0,propagateExitStatus:t,tournamentRecord:n,drawDefinition:a,winningSide:r,event:c}),stack:u,context:{progressExitStatus:!0}})}return Pn({result:{error:Et},stack:u})}function QN(e){let t=$c(e,[{[mc]:!0,[Xs]:!0}]);if(t.error)return t;let r=Fl(e);if(!e.drawDefinition){let t=e.tournamentRecord??(e.tournamentId&&r[e.tournamentId]);e.tournamentRecord||(e.tournamentRecord=t);let i=Af({eventId:e.eventId,drawId:e.drawId,tournamentRecord:t});if(i.error)return i;i.drawDefinition&&(e.drawDefinition=i.drawDefinition),e.event=i.event}let{disableScoreValidation:i,propagateExitStatus:n,policyDefinitions:a,tournamentRecord:o,disableAutoCalc:s,enableAutoCalc:c,drawDefinition:u,matchUpId:d,schedule:l,event:p,notes:m}=e,f=e.matchUpFormat||e.outcome?.matchUpFormat,{policy:h}=Sp({policyType:du,tournamentRecord:o,event:p}),g=void 0!==e.allowChangePropagation&&e.allowChangePropagation||void 0!==h?.allowChangePropagation&&h.allowChangePropagation||void 0,{outcome:I,setTBlast:U}=e;if(I?.winningSide&&![1,2].includes(I.winningSide))return{error:rr};if(f){let e=hD({tournamentRecord:o,drawDefinition:u,matchUpFormat:f,matchUpId:d,event:p});if(e.error)return e}if(I?.score?.sets&&!I.score.scoreStringSide1){let{score:e}=KN({...I,setTBlast:U});I.score=e,I.score.sets=I.score.sets.filter(e=>e.side1Score||e.side2Score||e.side1TiebreakScore||e.side2TiebreakScore)}let S=GN({matchUpStatusCodes:I?.matchUpStatusCodes,matchUpStatus:I?.matchUpStatus,winningSide:I?.winningSide,allowChangePropagation:g,disableScoreValidation:i,score:I?.score,propagateExitStatus:n,tournamentRecords:r,policyDefinitions:a,tournamentRecord:o,disableAutoCalc:s,enableAutoCalc:c,drawDefinition:u,matchUpFormat:f,matchUpId:d,schedule:l,event:p,notes:m});if(S.context?.progressExitStatus){let t=!0,r=0;for(;t&&r<10;){t=!1,r+=1;let i=JN({sourceMatchUpStatusCodes:S.context.sourceMatchUpStatusCodes,sourceMatchUpStatus:S.context.sourceMatchUpStatus,loserParticipantId:S.context.loserParticipantId,propagateExitStatus:e.propagateExitStatus,tournamentRecord:e.tournamentRecord,loserMatchUp:S.context.loserMatchUp,matchUpsMap:S.context.matchUpsMap,drawDefinition:e.drawDefinition,event:e.event});i.context?.loserMatchUp&&(Object.assign(S.context,i.context),t=!0)}}return Pn({result:S,stack:"setMatchUpStatus"})}function XN(e){if(!e?.outcomes)return{error:$t};if(!Array.isArray(e.outcomes))return{error:$t,info:{outcomes:e.outcomes}};let t=e.tournamentRecords||e.tournamentRecord&&{[e.tournamentRecord.tournamentId]:e.tournamentRecord}||{},r=e.outcomes??[],i=r.reduce((e,t)=>e.includes(t.tournamentId)?e:e.concat(t.tournamentId),[]);for(let n of i){let e=t[n];if(!e)return{error:Ie};let i=r.filter(e=>e.tournamentId===n);if(i.length){let t=ZN({outcomes:i,tournamentRecord:e});if(t.error)return t}}return{...ce}}function ZN(e){let{tournamentRecords:t,tournamentRecord:r,outcomes:i,policyDefinitions:n}=e,a={};i.forEach(e=>{let{eventId:t}=e;a[t]||(a[t]=[]),a[t].push(e)});for(let o of Object.keys(a)){let{event:e}=Af({tournamentRecord:r,eventId:o});for(let i of a[o]){let{drawId:a}=i,o=e?.drawDefinitions?.find(e=>e.drawId===a);if(o&&a){let{matchUpFormat:s,matchUpId:c}=i,u=QN({schedule:i?.schedule,tournamentRecords:t,policyDefinitions:n,tournamentRecord:r,drawDefinition:o,matchUpFormat:s,matchUpId:c,outcome:i,drawId:a,event:e});if(u.error)return u}}}return{...ce}}function eA(e){return function({drawDefinition:e,matchUpId:t,outcome:r,matchUp:i}){if(!i&&!e)return{error:ye};if(!r)return{error:$t,info:"missing outcome"};if(!i&&!t)return{error:Et};if(!i){let r=zS({drawDefinition:e,matchUpId:t});if(r.error)return r;i=r.matchUp}return"object"==typeof r&&r.score?.scoreStringSide1&&r.score?.scoreStringSide2?Uu({element:i,extension:{name:Eu,value:r}}):{error:gi}}(e)}function tA(e){let t="resetTieFormat",{drawDefinition:r,event:i,uuids:n}=e,a=$c(e,[{[Js]:!0,[mc]:!0}],t);if(a.error)return a;let o=Qb(e,[{[Mc]:Pc}]);if(o[Dc])return o;let s=e.tournamentRecord?.tournamentId,{matchUp:c,structure:u}=o?.matchUp??{};if(!c?.tieMatchUps)return Pn({result:{error:Ct},info:"Must be a TEAM matchUp",stack:t});if(!c.tieFormat)return{...ce};let d=zp({structure:u,drawDefinition:r,event:i})?.tieFormat;if(!d)return Pn({result:{error:wi},info:"No inherited tieFormat",stack:t});let l=[],p=[],m=[],f=[];for(let h of d.collectionDefinitions){let{matchUpCount:e,collectionId:t}=h;p.push(t);let r=(c.tieMatchUps||[]).filter(e=>e.collectionId===t);if(r.length>e)r.sort((e,t)=>(e.matchUpStatus===Md?1:0)-(t.matchUpStatus===Md?1:0)),m.push(...r.slice(0,e)),l.push(...r.slice(3).map(ld));else if(m.push(...r),r.length<e){let t=wS({collectionDefinition:h,matchUpsLimit:e-r.length,matchUp:c,uuids:n});f.push(...t)}}for(let h of c?.tieMatchUps||[])h.collectionId&&!p.includes(h.collectionId)&&l.push(h.matchUpId);return f.length&&(m.push(...f),Pl({eventId:i?.eventId,matchUps:f,drawDefinition:r,tournamentId:s})),l.length&&Tl({matchUpIds:l,eventId:i?.eventId,drawDefinition:r,tournamentId:s}),c&&(c.tieMatchUps=m,c.tieFormatId=void 0,c.tieFormat=void 0,Dl({structureId:u?.structureId,eventId:i?.eventId,context:t,drawDefinition:r,tournamentId:s,matchUp:c})),{...ce,newMatchUps:f,deletedMatchUpIds:l}}function rA(e){let{tournamentRecord:t,drawDefinition:r,matchUpId:i,event:n}=e,a="resetScorecard";if(!r)return Pn({result:{error:ye},stack:a});if(!i)return Pn({result:{error:Mt},stack:a});if(!S(i))return Pn({result:{error:gi,matchUpId:i},stack:a});let o=Kp({drawDefinition:r}),{matchUps:s}=Kf({nextMatchUps:!0,inContext:!0,drawDefinition:r,matchUpsMap:o}),c=o.drawMatchUps.find(e=>e.matchUpId===i),u=s?.find(e=>e.matchUpId===i);if(!c||!s)return{error:Nt};if(c.matchUpType!==qo)return{error:Ct};let d=Wf({inContextDrawMatchUps:s,drawDefinition:r,matchUpId:i}),l=u?.structureId,{structure:p}=Vd({drawDefinition:r,structureId:l});if(Object.assign(e,{inContextDrawMatchUps:s,inContextMatchUp:u,matchUpsMap:o,targetData:d,structure:p,matchUp:c}),ny(e))return{error:cr};if(c.tieMatchUps?.length)for(let h of c.tieMatchUps){let e=GN({matchUpId:h.matchUpId,matchUpTieId:i,winningSide:void 0,removeScore:!0,tournamentRecord:t,drawDefinition:r,event:n});if(e.error)return Pn({result:e,stack:a})}let m=up({tournamentRecord:t,drawDefinition:r,event:n})?.appliedPolicies,f=sv({event:e.event,removeScore:!0,tournamentRecord:t,appliedPolicies:m,drawDefinition:r,matchUpsMap:o,matchUpId:i});if(f.error)return Pn({result:f,stack:a});if(e.tiebreakReset&&!f.tieFormatRemoved){let e=zp({drawDefinition:r,structure:p,event:n})?.tieFormat;if(c.tieFormat&&e){let{matchUpCountDifference:a,descendantDifferences:o,ancestorDifferences:s,valueDifference:u}=JD({descendant:c.tieFormat,ancestor:e});if(1===o.collectionIds.length&&!s.collectionIds.length&&!s.groupsCount&&1===a&&1===u){let e=tA({tournamentRecord:t,drawDefinition:r,matchUpId:i,event:n});if(e.error)return e}}}return{...ce}}function iA(e){let t=$c(e,[{[Xs]:!0,[bc]:!0},{[Bc]:{[cc]:!1,roundNumbers:!1},[Fc]:"At least one must be provided",[_c]:Oc}]);if(t.error)return t;let r=Rv(e);if(r.error)return r;let{matchUpIds:i}=r,n=Wm(qo)(e.event.eventType),{tournamentRecord:a,drawDefinition:o,event:s}=e;for(let c of i){if(n){let t=rA({tiebreakReset:!0,tournamentRecord:a,drawDefinition:o,matchUpId:c,event:s});if(t.error||e.removeAssignments&&zN({inheritance:!1,drawDefinition:o,matchUpId:c}).error)return t}let t=GN({winningSide:void 0,removeScore:!0,tournamentRecord:a,drawDefinition:o,matchUpId:c,event:s});if(t.error)return t;if(e.removeAssignments){let t=sN({...e,matchUpId:c});if(t.error)return t}}return{...ce}}function nA(e){return function({tournamentRecord:e,drawDefinition:t,finishingOrder:r}){if(!t)return{error:ye};let i="setOrderOfFinish";if(!Array.isArray(r))return Pn({info:WI("finishingOrder"),result:{error:gi},stack:i});let{completedMatchUps:n,matchUpsMap:a}=Jf({inContext:!0,drawDefinition:t}),o=n?.map(ld)??[],s=r.map(ld),{matchUpTypes:c,roundNumbers:u,structureIds:d,matchUpTieIds:l}=(n??[]).filter(({matchUpId:e})=>s.includes(e)).reduce((e,t)=>{let{matchUpTieId:r,matchUpType:i,roundNumber:n,structureId:a}=t;return e.matchUpTypes.includes(i)||e.matchUpTypes.push(i),e.roundNumbers.includes(n)||e.roundNumbers.push(n),e.structureIds.includes(a)||e.structureIds.push(a),e.matchUpTieIds.includes(r)||e.matchUpTieIds.push(r),e},{matchUpTypes:[],roundNumbers:[],structureIds:[],matchUpTieIds:[]});if(c.length>1||l.length>1||u.length>1||d.length>1)return Pn({info:"matchUpType, structureId and roundNumber must be equivalent",result:{error:gi},stack:i});let p,m,f={},h=[],g=[];if(!r.every(({orderOfFinish:e,matchUpId:t})=>(h.push(t),e&&g.push(e),f[t]=e,p=o.includes(t),m=void 0===e||F(e)&&Math.floor(e)>0,p&&m)))return Pn({result:{error:p?gi:yt},info:(p?!m&&"orderOfFinish must be integer > 0 or undefined":"matchUps must be completed")||void 0,stack:i});let I=n?.filter(e=>e.structureId===d[0]&&e.roundNumber===u[0]&&e.matchUpType===c[0]&&e.matchUpTieId===l[0]&&!h.includes(e.matchUpId));for(let U of I??[]){let{orderOfFinish:e}=U||{};if(e){if(!F(e))return Pn({context:{orderOfFinish:e,matchUp:U},result:{error:gi},stack:i});g.push(e)}}if(H(g).length!==g.length||Math.max(...g)>g.length)return Pn({info:"Values not unique or greater than expected number of values",result:{error:gi},stack:i});if(d.length){let r=Gf({matchUpFilters:{matchUpIds:s},structureId:d[0],drawDefinition:t,matchUpsMap:a});if(r.error)return Pn({result:r,stack:i});r.completedMatchUps?.forEach(r=>{r.orderOfFinish=f[r.matchUpId],Dl({tournamentId:e.tournamentId,context:"setOrderOfFinish",drawDefinition:t,matchUp:r})})}return{...ce}}(e)}function aA(e){let{tournamentRecord:t,drawDefinition:r,matchUpId:i,lineUps:n,event:a}=e,o="applyLineUps",s=$c(e,[{[Js]:!0,[Xs]:!0,[mc]:!0},{lineUps:!0,[_c]:Oc}],o);if(s.error)return s;let c=t.participants||[],d=zS({tournamentParticipants:c,inContext:!0,drawDefinition:r,matchUpId:i});if(d.error)return d;if(!d.matchUp)return{error:Nt};let{matchUp:p,structure:f}=d,{drawPositions:h,matchUpType:g}=p;if(g!==m)return{error:Ct};if(!h?.length)return{error:Ce};let I=zp({matchUp:p,drawDefinition:r,structure:f,event:a})?.tieFormat,U={};for(let m of n){if(!Array.isArray(m))return{error:gi,lineUp:m};let e={},r=[];for(let t of m){if("object"!=typeof t)return{error:gi,lineUpAssignment:t};let{participantId:i,collectionAssignments:n=[]}=t;if(!Array.isArray(n))return{error:gi,collectionAssignments:n};let a=c.find(e=>e.participantId===i);if(!a)return{error:Sr};if(a.participantType!==Vl)return{error:mr};let o=p.sides?.find(e=>e.participant?.individualParticipantIds?.includes(i))?.sideNumber;o&&r.push(o);for(let t of n){if("object"!=typeof t)return{error:gi,collectionAssignment:t};let{collectionId:r,collectionPosition:n}=t,a=I?.collectionDefinitions?.find(e=>e.collectionId===r);if(!a)return{error:gi,collectionId:r};let o=`${r}-${n}`;e[o]||(e[o]=[]);let s=e[o].length;if(Wm(u)(a.matchUpType)&&s||a.matchUpType===l&&s>1)return{info:"Excessive collectionPosition assignments",error:gi};e[o].push(i)}}let i=Object.values(e);for(let s of i)if(2===s.length){let{participant:e}=Of({tournamentParticipants:c,participantIds:s});if(!e){let e=NM({participant:{participantType:jl,participantRole:Qg,individualParticipantIds:s},pairOverride:!0,tournamentRecord:t});if(e.error)return e}}let n=j(r),a=((n[1]||0)>(n[2]||0)?1:(n[2]||0)>(n[1]||0)&&2)||void 0,o=Object.keys(U).map(e=>parseInt(e));a&&!o.includes(a)&&(U[a]=m)}if(!Object.keys(U).length)return{error:yi};if(d=zS({drawDefinition:r,matchUpId:i}),d.error)return d;if(!d.matchUp)return{error:Nt};let{matchUp:S}=d;S.sides??=[];for(let u of[1,2]){let e=S.sides.find(e=>e.sideNumber===u),t=U[u];t&&(e?e.lineUp=t:S.sides.push({lineUp:t,sideNumber:u}))}return Dl({tournamentId:t?.tournamentId,context:o,drawDefinition:r,matchUp:S}),{...ce}}var oA={};n(oA,{anonymizeTournamentRecord:()=>wE,generate:()=>sA,generateEventWithDraw:()=>pE,generateOutcome:()=>ZA,generateOutcomeFromScoreString:()=>cA,generateParticipants:()=>WA,generateTournamentRecord:()=>vE,modifyTournamentRecord:()=>bE,mutate:()=>yE});var sA={};function cA(e){let{matchUpFormat:t,matchUpStatus:r,winningSide:i,scoreString:n,setTBlast:a,preserveSideOrder:o=!1}=e;if(!n)return{outcome:{...QS,winningSide:i,matchUpStatus:r}};if(i&&![1,2,void 0].includes(i))return{error:gi,winningSide:i};let s=n&&RT({scoreString:n,matchUpFormat:t}),c=n?.trim().startsWith("["),u=function(e,t,r){return!e&&t&&r?yT(Yn(t))?function(e){let t=e.reduce((e,t)=>((void 0!==t.side1Score||void 0!==t.side2Score)&&(e.side1+=t.side1Score??0,e.side2+=t.side2Score??0),e),{side1:0,side2:0});return t.side1>t.side2?1:t.side2>t.side1?2:e.find(e=>void 0!==e.side1TiebreakScore||void 0!==e.side2TiebreakScore)?.winningSide}(r):function(e){let t={side1:0,side2:0};return e.forEach(e=>{1===e.winningSide?t.side1++:2===e.winningSide&&t.side2++}),t.side1>t.side2?1:t.side2>t.side1?2:void 0}(r):e}(i,t,s),d=Yn(t),l=o||c||yT(d)?function(e,t,r){let i=RT({scoreString:e,matchUpFormat:t});return{sets:i,scoreStringSide1:vw({sets:i,matchUpFormat:t,setTBlast:r}),scoreStringSide2:vw({sets:i,reversed:!0,matchUpFormat:t,setTBlast:r})}}(n,t,a):function(e,t,r,i){let n=vw({sets:e,matchUpFormat:r,setTBlast:i}),a=vw({sets:e,reversed:!0,matchUpFormat:r,setTBlast:i});if("string"!=typeof n)return n;if("string"!=typeof a)return a;let o=2===t?a:n,s=2===t?n:a;return{sets:RT({scoreString:o,matchUpFormat:r}),scoreStringSide1:o,scoreStringSide2:s}}(s,u,t,a);return wn({outcome:{matchUpStatus:r,winningSide:u,score:l}})}function uA({matchUpScheduleTimes:e,matchUpDependencies:t,allDateMatchUpIds:r,matchUp:i}){let n=(t?.[i.matchUpId]?.matchUpIds||[]).filter(e=>r.includes(e)).filter(t=>!e[t]);return{dependenciesScheduled:!n?.length,remainingDependencies:n}}function dA({individualParticipantProfiles:e,participantId:t}){e[t]||(e[t]={typeChangeTimeAfterRecovery:void 0,timeAfterRecovery:void 0,priorMatchUpType:void 0,potentialRecovery:{},potentialCounted:{},potentialBookings:{},bookings:[],counters:{}})}function lA({matchUpPotentialParticipantIds:e,individualParticipantProfiles:t,typeChangeRecoveryMinutes:r,averageMatchUpMinutes:i=0,matchUpNotBeforeTimes:n,matchUpDependencies:a,recoveryMinutes:o=0,scheduleTime:s,matchUp:c}){let u=va(c?.schedule?.endTime),d=u?Na(u,I(o)):Na(s,I(i)+I(o)),l=r&&(u?Na(va(u),r):Na(s,I(i)+I(r))),p=a?.[c.matchUpId]?.participantIds||[],m=(c.roundPosition&&e[c.matchUpId]||[]).flat();p.forEach(e=>{dA({individualParticipantProfiles:t,participantId:e});let r=t[e].priorMatchUpType!==c.matchUpType&&l||d;m.includes(e)?function({individualParticipantProfiles:e,recoveryValue:t,participantId:r,scheduleTime:i,drawId:n}){e[r].potentialRecovery[n]||(e[r].potentialRecovery[n]=[]),e[r].potentialRecovery[n].push(t),e[r].potentialBookings[n]||(e[r].potentialBookings[n]=[]),e[r].potentialBookings[n].push({timeAfterRecovery:t,scheduleTime:i})}({individualParticipantProfiles:t,drawId:c.drawId,recoveryValue:r,participantId:e,scheduleTime:s}):(t[e].timeAfterRecovery=r,t[e].bookings.push({scheduleTime:s,timeAfterRecovery:r}))}),ab({matchUpPotentialParticipantIds:e,matchUpNotBeforeTimes:n,timeAfterRecovery:d,matchUp:c})}function pA({matchUpScheduleTimes:e,matchUpDependencies:t,scheduleTime:r,matchUpId:i,details:n}){let a,o=n.minutesMap?.[i]?.recoveryMinutes,s=Na(r,(n.minutesMap?.[i]?.averageMinutes||0)+(o||0)),c=t?.[i]?.dependentMatchUpIds||[];if(c.length){let t=c.reduce((t,r)=>{let i=e[r];if(!i)return t;let n={scheduleTime:i,matchUpId:r};return i&&!t.matchUpId||Ua(i)<Ua(t.scheduleTime)?n:t},{});t.scheduleTime&&Ua(s)>Ua(t.scheduleTime)&&(a=t)}return{scheduledDependent:a}}n(sA,{generateEventWithDraw:()=>pE,generateOutcome:()=>ZA,generateOutcomeFromScoreString:()=>cA,generateParticipants:()=>WA,generateTournamentRecord:()=>vE});var mA="DO_NOT_SCHEDULE",fA={DO_NOT_SCHEDULE:mA};function hA({averageMatchUpMinutes:e=90,requestConflicts:t={},potentials:r=!0,personRequests:i,scheduleTime:n,scheduleDate:a,matchUp:o}){let s=function(e){let{sides:t,matchUpType:r}=e||{};return(t||[]).map(e=>r===l&&(e?.participant?.individualParticipants||[])||e?.participant&&[e.participant]||[]).flat()}(o).map(({person:e})=>e?.personId);if(r){let e=(o?.potentialParticipants||[]).flat().map(({person:e})=>e?.personId);s.push(...e)}let c=s.map(e=>i[e]?.map(t=>({...t,personId:e}))).filter(Boolean).flat().filter(e=>e.requestType===mA&&Ca(a,e.date)),u=[],d=o?.matchUpId,p=Ma(va(n),ya(a)),m=va(Aa(p,e).toISOString());for(let l of c){let{requestId:e,startTime:r,endTime:i}=l;(n>r&&n<i||m&&m>r&&m<i)&&(u.push({matchUpId:d,request:l,scheduleTime:n}),t[e]?(t[e].scheduleTimes.includes(n)||t[e].scheduleTimes.push(n),t[e].matchUpIds.includes(d)||t[e].matchUpIds.push(d)):t[e]={request:l,scheduleTimes:[n],matchUpIds:[d]})}return{conflicts:u}}function gA({matchUpPotentialParticipantIds:e,individualParticipantProfiles:t,matchUp:r,value:i}){let{matchUpType:n}=r,{individualParticipantIds:a}=kl(r),o=(e[r.matchUpId]||[]).filter(e=>!Z(e,a)).flat();[...a,...o].forEach(e=>{if(dA({individualParticipantProfiles:t,participantId:e}),!t[e].potentialCounted[r.drawId]){let a=t[e].counters;a[n]?a[n]+=i:i>0&&(a[n]=i),a[Qm]?a[Qm]+=i:i>0&&(a[Qm]=i),o.includes(e)&&(t[e].potentialCounted[r.drawId]=!0)}})}function IA({matchUpPotentialParticipantIds:e,individualParticipantProfiles:t,dateScheduledMatchUpIds:r,greatestAverageMinutes:i,dateScheduledMatchUps:n,matchUpNotBeforeTimes:a,matchUpScheduleTimes:o,matchUpDependencies:s,clearScheduleDates:c,scheduleDate:u,minutesMap:d,matchUps:l}){let p=[];r||(n=l?.filter(e=>{let t=e.schedule||{},r="BYE"===e.matchUpStatus;return r&&p.push({tournamentId:e.tournamentId,matchUpId:e.matchUpId}),!r&&xb({schedule:t})&&(!u||e.schedule.scheduledDate===u)}),r=n.map(ld));let m=Array.isArray(c)?c.includes(u):c,f=m?[]:l.filter(({matchUpId:e})=>r.includes(e));for(let h of f){gA({matchUpPotentialParticipantIds:e,individualParticipantProfiles:t,value:1,matchUp:h});let r=h.schedule?.scheduledTime;if(r){o[h.matchUpId]=r;let n=d?.[h.matchUpId]?.recoveryMinutes;lA({individualParticipantProfiles:t,matchUpPotentialParticipantIds:e,matchUpNotBeforeTimes:a,matchUpDependencies:s,averageMatchUpMinutes:i,recoveryMinutes:n,scheduleTime:r,matchUp:h})}}return{dateScheduledMatchUpIds:r,byeScheduledMatchUpDetails:p,dateScheduledMatchUps:n,clearDate:m}}function UA({defaultRecoveryMinutes:e=0,averageMatchUpMinutes:t=90,dateScheduledMatchUps:r,tournamentRecords:i,venueIds:n=[],periodLength:a,scheduleDate:o,matchUps:s}){if("object"!=typeof i)return{error:ge};if(!Zp(s)&&!Array.isArray(r))return{error:At};a=a??BR({recoveryMinutes:e,averageMatchUpMinutes:t});let c=Object.assign({},...Object.values(i).flatMap(e=>(e.events??[]).map(t=>{let{scheduleTiming:r}=vp({tournamentRecord:e,event:t});return{[t.eventId]:{event:t,scheduleTiming:r}}}))),u={averageTimes:[{minutes:{default:t}}],recoveryTimes:[{minutes:{default:e}}]};r??=s?.filter(e=>{let t=e.schedule;return xb({schedule:t})&&(!o||e.schedule.scheduledDate===o)});let d=r?.filter(e=>(!n.length||n.includes(e.schedule.venueId))&&"BYE"!==e.matchUpStatus);return{bookings:d?.map(({eventId:e,schedule:t,matchUpFormat:r})=>{let{event:i,scheduleTiming:n}=c[e],o=i?.eventType,s={...n,defaultTiming:u,matchUpFormat:r},{averageMinutes:d,recoveryMinutes:l}=df({timingDetails:s,eventType:o}),{courtId:p,venueId:m}=t,f=va(t.scheduledTime),h=Na(f,d);return{recoveryMinutes:l,averageMinutes:d,periodLength:a,startTime:f,courtId:p,endTime:h,venueId:m}}).filter(Boolean),relevantMatchUps:d,dateScheduledMatchUps:r}}function SA({calculateStartTimeFromCourts:e=!0,remainingScheduleTimes:t,defaultRecoveryMinutes:r,averageMatchUpMinutes:i,clearScheduleDates:n,tournamentRecords:a,tournamentRecord:o,periodLength:s,scheduleDate:c,startTime:u,venueIds:d,matchUps:l,endTime:p}){if(o&&!a&&(a={[o.tournamentId]:o}),"object"!=typeof a||!Object.keys(a).length)return{error:ge};s=s??BR({recoveryMinutes:r,averageMatchUpMinutes:i});let{courts:m,venues:f}=jv({dates:[c],ignoreDisabled:!0,tournamentRecords:a}),h=m?.filter(e=>!d||d.includes(e.venueId))??[];u=u??GR({courts:h,scheduleDate:c,startTime:!0}),p=p??GR({courts:h,scheduleDate:c,endTime:!0});let{bookings:g,dateScheduledMatchUps:I}=UA({defaultRecoveryMinutes:r,averageMatchUpMinutes:i,tournamentRecords:a,scheduleDate:c,periodLength:s,venueIds:d,matchUps:l}),U={calculateStartTimeFromCourts:e,remainingScheduleTimes:t,averageMatchUpMinutes:i,clearScheduleDates:n,date:c,periodLength:s,startTime:u,bookings:g,endTime:p,courts:h},{scheduleTimes:S}=jR(U),v=1===d?.length&&d[0]||1===f?.length&&f[0].venueId||void 0;return{dateScheduledMatchUpIds:I?.map(nh("matchUpId")),dateScheduledMatchUps:I,scheduleTimes:S,venueId:v}}function vA({scheduledRoundsDetails:e,greatestAverageMinutes:t,garmanSinglePass:r}){let i,n,a,o,s=[],c=[];for(let u of e.filter(Boolean))o||(o=u.hash),(u.hash===o||r)&&(c=c.concat(u.matchUpIds)),u.hash!==o&&!r&&(o=u.hash,s.push({averageMinutes:a,recoveryMinutes:n,roundPeriodLength:i,matchUpIds:c}),c=u.matchUpIds),a=r?t:u.averageMinutes,n=u.recoveryMinutes,i=u.roundPeriodLength;return c.length&&s.push({matchUpIds:c,roundPeriodLength:i,recoveryMinutes:n,averageMinutes:a}),{groupedRounds:s}}function yA({matchUpPotentialParticipantIds:e,individualParticipantProfiles:t,scheduleCompletedMatchUps:r,containedStructureIds:i,matchUpNotBeforeTimes:n,matchUpScheduleTimes:a,matchUpDependencies:o,clearScheduleDates:s,tournamentRecords:c,periodLength:u,scheduleDate:d,useGarman:l,matchUps:p,courts:m,venues:f}){let h={},g=[],I=[],U=[];for(let S of f){let{rounds:f=[],venueId:v}=S,{scheduledRoundsDetails:y,greatestAverageMinutes:w,orderedMatchUpIds:P,minutesMap:T}=cb({scheduleCompletedMatchUps:r,containedStructureIds:i,tournamentRecords:c,periodLength:u,matchUps:p,rounds:f});U.push(...P??[]);let D,{groupedRounds:b}=vA({scheduledRoundsDetails:y,greatestAverageMinutes:w,garmanSinglePass:!0}),M=[];l&&({scheduleTimes:M,dateScheduledMatchUpIds:D}=SA({averageMatchUpMinutes:b[0]?.averageMinutes,scheduleDate:ya(d),venueIds:[S.venueId],clearScheduleDates:s,tournamentRecords:c,periodLength:u,matchUps:p}));let R=IA({matchUpPotentialParticipantIds:e,individualParticipantProfiles:t,dateScheduledMatchUpIds:D,greatestAverageMinutes:w,matchUpNotBeforeTimes:n,matchUpScheduleTimes:a,matchUpDependencies:o,clearScheduleDates:s,scheduleDate:d,minutesMap:T,matchUps:p});({dateScheduledMatchUpIds:D}=R);let N=R,{byeScheduledMatchUpDetails:A,clearDate:E}=R;A?.length&&I.push(...A);let{matchUpsToSchedule:C,matchUpMap:O}=ob({matchUpPotentialParticipantIds:e,scheduleCompletedMatchUps:r,dateScheduledMatchUpIds:D,matchUpNotBeforeTimes:n,matchUpScheduleTimes:a,orderedMatchUpIds:P,clearDate:E,matchUps:p}),k=m.filter(e=>e.venueId===v);h[v]={previousRemainingScheduleTimes:[],courtsCount:k.length,greatestAverageMinutes:w,scheduledRoundsDetails:y,dateScheduledMatchUps:N,matchUpsToSchedule:C,scheduleTimes:M,groupedRounds:b,venueCourts:k,minutesMap:T,matchUpMap:O},s||g.push(...D)}return{allDateScheduledByeMatchUpDetails:I,allDateScheduledMatchUpIds:g,venueScheduledRoundDetails:h,allDateMatchUpIds:U}}function wA({individualParticipantProfiles:e,matchUpNotBeforeTimes:t,matchUpDependencies:r,scheduleTime:i,matchUp:n,details:a}){let o=(r?.[n.matchUpId]?.participantIds||[]).flat(),s=a?.minutesMap?.[n.matchUpId]?.averageMinutes||0,c=a?.minutesMap?.[n.matchUpId]?.recoveryMinutes||0,u=o.every(t=>{dA({individualParticipantProfiles:e,participantId:t});let r=e[t];if(!r.timeAfterRecovery)return!0;let a=va(n?.schedule?.endTime),o=a?Na(a,I(c)):Na(i,I(s)+I(c));return![...Object.keys(r.potentialBookings).filter(e=>e!==n.drawId).map(e=>r.potentialBookings[e]).flat(),...r.bookings].find(e=>function(e,t){let r=Ua(e.scheduleTime),i=Ua(e.timeAfterRecovery),n=Ua(t.scheduleTime),a=Ua(t.timeAfterRecovery),o=r>n&&r<a,s=n>r&&n<i,c=i>n&&i<a,u=a>r&&a<i;return wn({hasOverlap:r===n||i===a||o||c||s||u,startAisContained:o,endAisContained:c,startBisContained:s,endBisContained:u},!0)}({scheduleTime:i,timeAfterRecovery:o},e).hasOverlap)}),d=t[n.matchUpId],l=(d?Ra(Ma(d),Ma(i),!1):0)>=0;return{enoughTime:u&&l}}function PA({autoSchedulingAudit:e,tournamentRecords:t}){rn({topic:Qd,payload:e});let r=e=>e?Object.values(e).reduce((e,t)=>e+t.length||0,0):0,i=(e?.schedulingProfile||[]).reduce((e,t)=>e+t.venues.reduce((e,t)=>e+t.rounds.length,0),0),n={scheduledDatesCount:e.scheduledDates?.length,noTimeMatchUpIdsCount:r(e?.noTimeMatchUpIds),scheduledMatchUpIdsCount:r(e?.scheduledMatchUpIds),overLimitMatchUpIdsCount:r(e?.overLimitMatchUpIds),requestConflictsCount:r(e?.requestConflicts),profileRoundsCount:i},a={itemType:jM,itemValue:n};for(let o of Object.values(t)){let e=o.tournamentId;un(Qd)?rn({payload:{type:jM,tournamentId:e,detail:n},topic:Qd}):mv({tournamentRecord:o,timeItem:a})}}function TA({matchUpPotentialParticipantIds:e,individualParticipantProfiles:t,matchUpDailyLimits:r={},matchUp:i}){let{enteredIndividualParticipantIds:n}=kl(i),{matchUpId:a,matchUpType:o}=i,s=(i.roundPosition&&e[a]||[]).flat(),c=L(n.concat(...s));return c.forEach(e=>{dA({individualParticipantProfiles:t,participantId:e})}),{participantIdsAtLimit:c.filter(e=>{let i=t[e];if(i)return[o,Qm].find(e=>{let t=i.counters?.[e]||0,n=r[e]||0;return t&&n&&t>=n})}),relevantParticipantIds:c}}function DA({scheduleCompletedMatchUps:e=!1,scheduleByeMatchUps:t=!1,errorOnAnachronism:r=!1,checkChronology:i=!0,matchUpDependencies:n,removePriorValues:a,tournamentRecords:o,tournamentRecord:s,matchUpDetails:c,matchUpIds:u,schedule:d}){if(!s)return{error:Ie};if(!(c||u&&Array.isArray(u)))return{error:Rt};if(!(c||d&&"object"==typeof d))return{error:ai};let l,p=[],m=0;if(i&&!n){let e=sh({tournamentRecords:o,tournamentRecord:s});n=e.matchUpDependencies,l=e.matchUps}l||(l=Xf({tournamentRecord:s})?.matchUps??[]);let f=l.reduce((r,i)=>{let{matchUpId:n,drawId:a,matchUpStatus:o}=i;return(t||"BYE"!==o)&&(e||!kd.includes(o))&&(r[a]?r[a].push(n):r[a]=[n]),r},{}),h=c?.map(e=>e.matchUpId);for(let g of Object.keys(f)){let{drawDefinition:e}=ty({tournamentRecord:s,drawId:g});if(!e)continue;let t=f[g].filter(e=>u?.includes(e)??h?.includes(e)),I=th({inContext:!1,drawDefinition:e}).matchUps;for(let u of t){let t=kN({schedule:c?.find(e=>e.matchUpId===u)?.schedule||d,matchUpDependencies:n,errorOnAnachronism:r,removePriorValues:a,inContextMatchUps:l,tournamentRecords:o,tournamentRecord:s,checkChronology:i,drawDefinition:e,drawMatchUps:I,matchUpId:u});if(t?.warnings?.length&&p.push(...t.warnings),t?.success&&(m+=1),t.error)return t}}return p.length?{...ce,scheduled:m,warnings:p}:{...ce,scheduled:m}}function bA(e){let{scheduleCompletedMatchUps:t=!1,scheduleByeMatchUps:r=!1,errorOnAnachronism:i,matchUpContextIds:n,removePriorValues:a,tournamentRecords:o,checkChronology:s,matchUpDetails:c,schedule:u}=e;if(e.matchUpIds&&!n)return DA(e);let d=$c(e,[{[zs]:!0},{[Bc]:{matchUpContextIds:!1,matchUpDetails:!1},[xc]:gi,[_c]:Oc}]);if(d.error)return d;if((!c||n)&&!u)return{error:$t,info:"schedule is required"};let l=[],p=0,{matchUpDependencies:m}=sh({tournamentRecords:o});for(let f of Object.values(o)){let{tournamentId:e}=f,d=n?.filter(t=>t.tournamentId===e).map(ld),h=c?.filter(t=>t?.tournamentId===e);if(d?.length||h?.length){let e=DA({matchUpDetails:h,scheduleCompletedMatchUps:t,scheduleByeMatchUps:r,matchUpDependencies:m,errorOnAnachronism:i,removePriorValues:a,tournamentRecords:o,tournamentRecord:f,checkChronology:s,matchUpIds:d,schedule:u});if(e.warnings?.length&&l.push(...e.warnings),e.scheduled&&(p+=e.scheduled),e.error)return e}}return l.length?{...ce,scheduled:p,warnings:l}:{...ce,scheduled:p}}function MA({averageMinutes:e,startTime:t,endTime:r,court:i,date:n}){if(!Array.isArray(i.dateAvailability))return{error:$t,stack:"getEarliestCourtTime"};let a=GR({scheduleDate:n,courts:[i],startTime:!0}),o=GR({scheduleDate:n,courts:[i],endTime:!0});t=t||a,r=r||o;let s=vb({court:i,date:n}),{timeSlots:c}=xR({courtDate:s}),u=Ma(t),d=Ma(r);return{earliestCourtTime:c?.reduce((t,r)=>{let i=Ma(r.startTime),n=Ma(r.endTime);if(i>d||n<u)return t;let a=u>i?u:i;if(Ra(a,n)>=e){let e=va(a.toISOString());e&&(!t||e<t)&&(t=e)}return t},void 0),courtStartTime:a,courtEndTime:o}}function RA(e){let{scheduleAttributes:t=["scheduledDate","scheduledTime","courtOrder"],ignoreMatchUpStatuses:r=kd,scheduledDates:i,venueIds:n}=e,a=Fl(e),o=v(a)?Object.values(a).map(({tournamentId:e})=>e).filter(Boolean):[];if(!o?.length)return{error:ge};let s=0;for(let c of o){let e=NA({ignoreMatchUpStatuses:r,scheduleAttributes:t,tournamentRecord:a[c],scheduledDates:i,venueIds:n});if(e.error)return e;s+=e.clearedScheduleCount??0}return{...ce,clearedScheduleCount:s}}function NA({scheduleAttributes:e=["scheduledDate","scheduledTime","courtOrder"],ignoreMatchUpStatuses:t=kd,tournamentRecord:r,scheduledDates:i,venueIds:n=[]}){if("object"!=typeof r)return{error:Ie};if(!Array.isArray(t)||!Array.isArray(n))return{error:gi};n.length&&e.push("venueId");let a=Xf({matchUpFilters:{scheduledDates:i},tournamentRecord:r}).matchUps??[],o={};a.forEach(({matchUpStatus:r,schedule:i,drawId:a,matchUpId:s})=>{(!r||!t.includes(r))&&xb({schedule:i,scheduleAttributes:e})&&(!n?.length||n.includes(i.venueId))&&(o[a]||(o[a]=[]),o[a].push(s))});let s=r.tournamentId,c=0;for(let u in o){let{event:e,drawDefinition:t}=Af({tournamentRecord:r,drawId:u}),i=th({drawDefinition:t,matchUpFilters:{matchUpIds:o[u]}}).matchUps??[];for(let r of i){let i=!1;r.timeItems=(r.timeItems??[]).filter(e=>{let t=e?.itemType&&![Um,Sm,Im,vm,ym,Tm].includes(e?.itemType);return t||(i=!0),t}),i&&(Dl({context:"clear schedules",eventId:e?.eventId,drawDefinition:t,tournamentId:s,matchUp:r}),c+=1)}}return{...ce,clearedScheduleCount:c}}function AA(e){let{checkPotentialRequestConflicts:t=!0,scheduleCompletedMatchUps:r,clearScheduleDates:i,scheduleDates:n=[],tournamentRecords:a,periodLength:o,useGarman:s,dryRun:c,pro:d}=e,p=$c(e,[{[zs]:!0},{[kc]:e=>!e||Array.isArray(e)&&e.every(ua),[rc]:!1,[_c]:Oc}]);if(p.error)return p;let m=lb({tournamentRecords:a});if(m.error)return m;if(!m.schedulingProfile.length)return{...ce};let{modifications:f,issues:h=[],schedulingProfile:g=[]}=m,I=Object.assign({},...Object.values(a).map(e=>Ol({tournamentRecord:e}).containedStructures)),U=new Set(n.map(e=>{if(ua(e))return ya(e)}).filter(Boolean)),S=g.map(e=>e.scheduleDate).map(e=>ua(e)&&ya(e)).filter(e=>e&&(!n.length||U.has(e)));if(!S.length)return{error:Ht};if(i&&!c){RA({tournamentRecords:a,scheduledDates:Array.isArray(i)?i:[]})}let v=jv({ignoreDisabled:!1,tournamentRecords:a}).courts,{matchUps:y}=Zf({matchUpFilters:{matchUpTypes:[u,l]},afterRecoveryTimes:!0,nextMatchUps:!0,tournamentRecords:a}),{matchUpDependencies:w}=sh({includeParticipantDependencies:!0,tournamentRecords:a,matchUps:y}),{matchUpDailyLimits:P}=$b({tournamentRecords:a}),{personRequests:T}=hb({requestType:mA,tournamentRecords:a}),D={schedulingProfileModifications:f,checkPotentialRequestConflicts:t,scheduleCompletedMatchUps:r,schedulingProfileIssues:h,dateSchedulingProfiles:g.filter(e=>{let t=ya(e?.scheduleDate);return S.includes(t)}).sort((e,t)=>new Date(e.scheduleDate).getTime()-new Date(t.scheduleDate).getTime()),containedStructureIds:I,matchUpDependencies:w,matchUpDailyLimits:P,clearScheduleDates:i,tournamentRecords:a,schedulingProfile:g,personRequests:T,periodLength:o,useGarman:s,matchUps:y,dryRun:c,courts:v};return d?function({schedulingProfileModifications:e,checkPotentialRequestConflicts:t,scheduleCompletedMatchUps:r,schedulingProfileIssues:i,dateSchedulingProfiles:n,containedStructureIds:a,matchUpDependencies:o,matchUpDailyLimits:s,clearScheduleDates:c,tournamentRecords:u,periodLength:d=30,schedulingProfile:l,personRequests:p,matchUps:m=[],courts:f,dryRun:h}){let g={},I={},U={},S={},v={},y={},w={},P={},T={};for(let M of n??[]){let e=ya(M?.scheduleDate),i=M?.venues||[],n={},l={},D=(e,t)=>{e.forEach(e=>{let r=l[e].counters;r[t]?r[t]+=1:r[t]=1,r[Qm]?r[Qm]+=1:r[Qm]=1})};g[e]={},I[e]={},y[e]=[],w[e]=[],P[e]=[],T[e]=[];let b={};m?.forEach(t=>{t.schedule?.scheduledDate&&Ca(e,ya(t.schedule.scheduledDate))&&ab({matchUpPotentialParticipantIds:n,matchUpNotBeforeTimes:b,matchUp:t})});let R,{allDateScheduledByeMatchUpDetails:N,allDateScheduledMatchUpIds:A,venueScheduledRoundDetails:E,allDateMatchUpIds:C}=yA({matchUpPotentialParticipantIds:n,individualParticipantProfiles:l,scheduleCompletedMatchUps:r,containedStructureIds:a,matchUpNotBeforeTimes:b,matchUpScheduleTimes:v,matchUpDependencies:o,clearScheduleDates:c,tournamentRecords:u,periodLength:d,scheduleDate:e,matchUps:m,courts:f,venues:i}),O=m?.filter(({matchUpId:e})=>A.includes(e)),{bookings:k}=UA({dateScheduledMatchUps:O,tournamentRecords:u,scheduleDate:e,periodLength:d}),{virtualCourts:F}=LR({scheduleDate:e,periodLength:d,bookings:k,courts:f}),x=F?.reduce((t,r)=>{let{earliestCourtTime:i,courtEndTime:n}=MA({date:e,averageMinutes:0,court:r});return(!t.startTime||Ma(i)<Ma(t.startTime))&&(t.startTime=i),(!t.endTime||Ma(n)>Ma(t.endTime))&&(t.endTime=n),t},{}),_=x.startTime,L=({courtId:e,booking:t})=>F?.find(t=>t.courtId===e)?.dateAvailability[0].bookings.push(t),B=10,V=0;for(;!R;){for(let{venueId:r}of i){let i,a=E[r],c=a.matchUpsToSchedule.length,u=[],m=[],f=0;for(;!i;){for(let c of a.matchUpsToSchedule){if(m.length===a.courtsCount||u.length===a.courtsCount){i=!0;break}let{matchUpId:f,matchUpType:h}=c,{participantIdsAtLimit:y,relevantParticipantIds:P}=TA({matchUpPotentialParticipantIds:n,individualParticipantProfiles:l,matchUpDailyLimits:s,matchUp:c});if(y.length){w[e].includes(f)||w[e].push(f);continue}let{dependenciesScheduled:M,remainingDependencies:R}=uA({matchUpScheduleTimes:v,matchUpDependencies:o,allDateMatchUpIds:C,matchUp:c});if(!M){I[e][f]||(I[e][f]=[]),I[e][f].push({remainingDependencies:R});continue}let N=[],A=F?.reduce((r,i)=>{if(m.includes(i.courtId))return r;let{earliestCourtTime:s}=MA({averageMinutes:a.greatestAverageMinutes,startTime:_,date:e,court:i});if(r.scheduleTime&&Ua(s)>=Ua(r.scheduleTime))return r;let{scheduledDependent:u}=pA({matchUpScheduleTimes:v,matchUpDependencies:o,scheduleTime:s,matchUpId:f,details:a});if(u)return r;let{enoughTime:d}=wA({individualParticipantProfiles:l,matchUpNotBeforeTimes:b,matchUpDependencies:o,scheduleTime:s,details:a,matchUp:c});if(!d)return g[e][f]||(g[e][f]=[]),g[e][f].includes(s)||g[e][f].push(s),r;let I=a.minutesMap?.[f]?.averageMinutes||a.greatestAverageMinutes,{conflicts:U}=hA({potentials:t,averageMatchUpMinutes:I,requestConflicts:T,personRequests:p,scheduleTime:s,scheduleDate:e,matchUp:c});if(U?.length)return N.push(...U),!1;D(P,h);let S=a.minutesMap?.[f]?.recoveryMinutes;return lA({matchUpPotentialParticipantIds:n,individualParticipantProfiles:l,matchUpNotBeforeTimes:b,averageMatchUpMinutes:I,matchUpDependencies:o,recoveryMinutes:S,scheduleTime:s,matchUp:c}),(!r.scheduleTime||Ua(s)<Ua(r.scheduleTime))&&(r.averageMatchUpMinutes=I,r.recoveryMinutes=S,r.scheduleTime=s,r.courtName=i.courtName,r.courtId=i.courtId),r},{});if(A.scheduleTime){let{averageMatchUpMinutes:e,recoveryMinutes:t,scheduleTime:i,courtId:n}=A;v[f]=i,S[f]=n,u.push(f),m.push(n);let o=i,s=Na(o,e);L({courtId:n,booking:{averageMatchUpMinutes:e,recoveryMinutes:t,periodLength:d,matchUpId:f,startTime:o,courtId:n,endTime:s,venueId:r}}),a.matchUpsToSchedule=a.matchUpsToSchedule.filter(e=>e.matchUpId!==f)}else N?.length&&(U[e]||(U[e]=[]),U[e].push(...N))}(m.length===a.courtsCount||u.length===a.courtsCount||!a.matchUpsToSchedule.length)&&(i=!0),a.matchUpsToSchedule.length&&u<a.courtsCount&&(Ma(_)<Ma(x.endTime)?_=Na(_,d):(i=!0,a.complete=!0)),f+=1,!i&&f>=c&&(i=!0)}a.matchUpsToSchedule?.length||(a.complete=!0)}V+=1,R=i.every(({venueId:e})=>E[e].complete)||V===B}for(let{venueId:t}of i){let r=E[t].matchUpMap;Object.keys(r).forEach(t=>{let i=u[t];i&&Object.keys(r[t]).forEach(n=>{let{drawDefinition:a}=ty({tournamentRecord:i,drawId:n});a&&r[t][n].forEach(({matchUpId:t})=>{let r=v[t],n=S[t];if(r){let o=r.split(":").map(Ea).join(":"),s=`${ya(e)}T${o}`;h||(MN({drawDefinition:a,scheduledTime:s,matchUpId:t}),CN({courtDayDate:e,tournamentRecords:u,tournamentRecord:i,drawDefinition:a,matchUpId:t,courtId:n})),y[e].push(t)}})})}),P[e]=E[t].matchUpsToSchedule.map(ld)}!h&&N?.length&&bA({matchUpDetails:N,scheduleByeMatchUps:!0,removePriorValues:!0,tournamentRecords:u,schedule:{scheduledDate:"",scheduledTime:"",courtOrder:"",courtId:"",venueId:""}});for(let t of M.venues)for(let r of t.rounds){let t=(r.matchUps??[]).map(({matchUpId:e})=>e)?.filter(t=>y[e].includes(t));r.canScheduledMatchUpIds=t;let i=Math.round((t?.length||0)/r.matchUpsCount*1e4)/100;(i===1/0||isNaN(i))&&(i=void 0),r.possibleToSchedulePct=i,r.matchUpsCount===t?.length&&(r.possibleToSchedule=!0)}}let D=(n??[]).map(({scheduleDate:e})=>e),b={timeStamp:Date.now(),overLimitMatchUpIds:w,scheduledMatchUpIds:y,schedulingProfile:l,noTimeMatchUpIds:P,requestConflicts:T,scheduledDates:D};return PA({tournamentRecords:u,autoSchedulingAudit:b}),{...ce,schedulingProfileModifications:e,schedulingProfileIssues:i,dateSchedulingProfiles:n,recoveryTimeDeferredMatchUpIds:g,dependencyDeferredMatchUpIds:I,matchUpScheduleTimes:v,overLimitMatchUpIds:w,scheduledMatchUpIds:y,noTimeMatchUpIds:P,requestConflicts:T,scheduledDates:D}}(D):function({schedulingProfileModifications:e,checkPotentialRequestConflicts:t,scheduleCompletedMatchUps:r,schedulingProfileIssues:i,dateSchedulingProfiles:n,containedStructureIds:a,matchUpDependencies:o,matchUpDailyLimits:s,clearScheduleDates:c,tournamentRecords:u,schedulingProfile:d,personRequests:l,periodLength:p,matchUps:m,courts:f,dryRun:h}){let g={},I={},U={},S={},v={},y={},w={},P={},T={},D={};for(let R of n){let e=ya(R?.scheduleDate),i=R?.venues||[],n={},d={},b=(e,t)=>{e.forEach(e=>{let r=d[e].counters;r[t]?r[t]+=1:r[t]=1,r[Qm]?r[Qm]+=1:r[Qm]=1})};U[e]={},S[e]={},g[e]={},I[e]={},w[e]=[],P[e]=[],T[e]=[],D[e]=[];let M={};m.forEach(t=>{t.schedule?.scheduledDate&&Ca(e,ya(t.schedule.scheduledDate))&&ab({matchUpPotentialParticipantIds:n,matchUpNotBeforeTimes:M,matchUp:t})});let N,{allDateScheduledByeMatchUpDetails:A,venueScheduledRoundDetails:E,allDateMatchUpIds:C}=yA({matchUpPotentialParticipantIds:n,individualParticipantProfiles:d,scheduleCompletedMatchUps:r,containedStructureIds:a,matchUpNotBeforeTimes:M,matchUpScheduleTimes:y,matchUpDependencies:o,clearScheduleDates:c,tournamentRecords:u,useGarman:!0,periodLength:p,scheduleDate:e,matchUps:m,courts:f,venues:i}),O=10,k=0,F=10;for(;!N;){for(let{venueId:r}of i){let i=0,a=E[r];for(;a.courtsCount&&a.scheduleTimes?.length&&a.matchUpsToSchedule?.length&&i<=a.courtsCount;){let{scheduleTime:c,attempts:u=0}=a.scheduleTimes.shift(),p=a.matchUpsToSchedule.find(r=>{let{matchUpId:i,matchUpType:u}=r,{participantIdsAtLimit:p,relevantParticipantIds:m}=TA({matchUpPotentialParticipantIds:n,individualParticipantProfiles:d,matchUpDailyLimits:s,matchUp:r});if(p.length)return P[e].includes(i)||P[e].push(i),!1;let{scheduledDependent:f}=pA({matchUpScheduleTimes:y,matchUpDependencies:o,scheduleTime:c,matchUpId:i,details:a});if(f)return!1;let{dependenciesScheduled:h,remainingDependencies:g}=uA({matchUpScheduleTimes:y,matchUpDependencies:o,allDateMatchUpIds:C,matchUp:r});if(!h)return S[e][i]||(S[e][i]=[]),S[e][i].push({scheduleTime:c,remainingDependencies:g}),!1;let{enoughTime:I}=wA({individualParticipantProfiles:d,matchUpNotBeforeTimes:M,matchUpDependencies:o,scheduleTime:c,details:a,matchUp:r});if(!I)return U[e][i]||(U[e][i]=[]),U[e][i].push({scheduleTime:c}),!1;let w=a.greatestAverageMinutes,{conflicts:T}=hA({potentials:t,averageMatchUpMinutes:w,requestConflicts:D,personRequests:l,scheduleTime:c,scheduleDate:e,matchUp:r});if(T?.length)return v[e]||(v[e]=[]),v[e].push(...T),!1;b(m,u);let R=a.minutesMap?.[i]?.recoveryMinutes;return lA({matchUpPotentialParticipantIds:n,individualParticipantProfiles:d,matchUpNotBeforeTimes:M,averageMatchUpMinutes:w,matchUpDependencies:o,recoveryMinutes:R,scheduleTime:c,matchUp:r}),y[i]=c,!0});a.matchUpsToSchedule=a.matchUpsToSchedule.filter(({matchUpId:e})=>e!==p?.matchUpId),p?i+=1:(I[e][r]||(I[e][r]=[]),I[e][r].push({scheduleTime:c,attempts:u+1}))}a.matchUpsToSchedule?.length&&(I[e][r]=I[e][r]?.filter(e=>{let t=e.attempts<O;return t&&a.scheduleTimes.push(e),!t})),(!a.scheduleTimes?.length||!a.matchUpsToSchedule?.length)&&(a.complete=!0)}k+=1,N=i.every(({venueId:e})=>E[e].complete)||k===F}for(let{venueId:t}of i){let r=E[t].matchUpMap;Object.keys(r).forEach(i=>{let n=u[i];n&&Object.keys(r[i]).forEach(a=>{let{drawDefinition:o}=ty({tournamentRecord:n,drawId:a});o&&r[i][a].forEach(({matchUpId:r})=>{let i=y[r];if(i){let a=i.split(":").map(Ea).join(":"),s=`${ya(e)}T${a}`;h?w[e].push(r):(MN({drawDefinition:o,scheduledTime:s,matchUpId:r}).success&&w[e].push(r),t&&EN({tournamentRecord:n,drawDefinition:o,matchUpId:r,venueId:t}))}})})}),T[e]=E[t].matchUpsToSchedule.map(ld),g[e][t]=E[t].scheduleTimes.sort((e,t)=>Ua(e.scheduleTime)-Ua(t.scheduleTime))}!h&&A?.length&&bA({matchUpDetails:A,scheduleByeMatchUps:!0,removePriorValues:!0,tournamentRecords:u,schedule:{scheduledDate:"",scheduledTime:"",courtOrder:"",courtId:"",venueId:""}});for(let t of R.venues)for(let r of t.rounds){let t=(r.matchUps?.map(({matchUpId:e})=>e)||[]).filter(t=>w[e].includes(t));r.canScheduledMatchUpIds=t;let i=Math.round(t.length/r.matchUpsCount*1e4)/100;(i===1/0||isNaN(i))&&(i=0),r.possibleToSchedulePct=i,r.matchUpsCount===t.length&&(r.possibleToSchedule=!0)}}let b=n.map(({scheduleDate:e})=>e),M={timeStamp:Date.now(),overLimitMatchUpIds:P,scheduledMatchUpIds:w,schedulingProfile:d,noTimeMatchUpIds:T,requestConflicts:D,scheduledDates:b};return PA({tournamentRecords:u,autoSchedulingAudit:M}),{...ce,schedulingProfileModifications:e,schedulingProfileIssues:i,scheduleTimesRemaining:g,dateSchedulingProfiles:n,skippedScheduleTimes:I,recoveryTimeDeferredMatchUpIds:U,dependencyDeferredMatchUpIds:S,matchUpScheduleTimes:y,overLimitMatchUpIds:P,scheduledMatchUpIds:w,noTimeMatchUpIds:T,requestConflicts:D,scheduledDates:b}}(D)}function EA(e){let{tournamentRecord:t,tournamentRecords:r,activeTournamentId:i,...n}=e||{};return n.tournamentId||(n.tournamentId=za()),(!n.startDate||ga(n.startDate)||ra.test(n.startDate))&&(!n.endDate||ga(n.endDate)||ra.test(n.endDate))?(n.extensions&&(n.extensions=n.extensions.filter(Iu)),{...n}):{error:Jt}}function CA({addParticipants:e=!0,participantAttribute:t,tournamentRecord:r,personAttribute:i,teamNames:n,accessor:a,uuids:o}){if(!r)return{error:Ie};let s={},c=(r.participants??[]).filter(({participantType:e,participantRole:t})=>e===Vl&&t===Qg),u=0;for(let f of c){let e=a&&rh({element:f,accessor:a})?.value||i&&f.person?.[i]||t&&f[t];if(e){if(!Object.keys(s).includes(e)){s[e]={participantName:n?.[u]??e,participantId:o?.pop()??za(),individualParticipantIds:[],participantRole:Qg,participantType:$l};let r={value:i??t,name:Bu};Uu({element:s[e],extension:r}),u+=1}s[e].individualParticipantIds.push(f.participantId)}}let d=Object.keys(s),l=(r.participants??[]).map(e=>{if(e.participantType!==$l||e.participantRole!==Qg)return;let{extension:t}=Ru({name:Bu,element:e}),r=t?.value;return d.includes(r)?e.participantId:void 0}).filter(Boolean),p=0,m=[];return Object.keys(s).forEach(t=>{let i=s[t],{participantId:n}=i;l.includes(n)||(r.participants||(r.participants=[]),e&&r.participants.push(i),m.push(i),p++)}),e&&p?(rn({payload:{tournamentId:r.tournamentId,participants:m},topic:Yd}),{...ce,participantsAdded:p}):m.length?{...ce,newParticipants:m}:{error:ir}}var OA=[{AA:"Annexia"},{BA:"Bacteria"},{BO:"Borduria"},{BM:"Bensalem"},{BS:"Basenji"},{BI:"Balnibarbi"},{BV:"Bartovia"},{BZ:"Berzerkistan"},{CA:"Caldonia"},{CC:"Concordia"},{CH:"Chula"},{DA:"Deltora"},{DW:"Discworld"},{EA:"Eastasia"},{EP:"Ecotopia"},{ER:"Erewhon"},{FA:"Freedonia"},{FN:"Florin"},{FG:"Fogg"},{FK:"Fourecks"},{GA:"Genovia"},{GL:"Gilead"},{GD:"Gilead"},{GL:"Gondal"},{GO:"Gondor"},{GR:"Gruzinia"},{GT:"Goritania"},{GU:"Guilder"},{HA:"Heldscalla"},{HO:"Hidalgo"},{IL:"Illyria"},{KA:"Kinakuta"},{KG:"Kangan"},{KN:"Kreplachistan"},{KS:"Kallipolis"},{LH:"Lugash"},{LI:"Listenbourg"},{LT:"Lilliput"},{LU:"Luggnagg"},{LV:"Lichtenslava"},{MR:"Moher"},{NA:"Narnia"},{NV:"Novaria"},{OA:"Oceania"},{OS:"Orsinia"},{OV:"Octavia"},{PA:"Palombia"},{PG:"Penguina"},{QA:"Qasha"},{PM:"Panem"},{SA:"Solymbria"},{SD:"Syldavia"},{SG:"San Glucose"},{SL:"San Lorenzo"},{SR:"Sontar"},{SY:"Sylvania"},{TF:"Tralfamadore"},{TH:"Themyscira"},{UA:"Utopia"},{VA:"Vespugia"},{WA:"Wakanda"},{WX:"Wessex"},{ZA:"Zamunda"},{ZK:"Zubrowka"}],kA=["Amber","Ansul","Atlantis","Braavos","Busytown","Castle Rock","Centralia","Coober Pedy","Chefchaouen","Chronopolis","Damanhur","Diaspar","Dictionopolis","Diomira","El Dorado","Elista","Ephesus","Gotham","Hadleyburg","Hallstatt","Hierusalem","Ilium","Inverness","Kowloon","Laputa","Longyearbyen","Lys","Matmata","Maycomb","Metropolis","Miyake-jima","Monowi","Nagoro","Navarre","New New York","Nimbin","Pemberley","Pseudopolis","Rivendell","Roswell","Shangri-La","Springfield","Supilinn","Thneedville","Trantor","Wobegon","Yonwood","Xanadu","Xylar","Zion"];function FA({count:e=1,participantsCount:t=32}={}){let r=V(kA),i=r.slice(0,e);return{cities:K(0,t).map(t=>t<Math.min(e,r.length)?i[t]:z(i))}}function xA({count:e=1,participantsCount:t=32}={}){let r=V(OA),i=r.slice(0,e).map(e=>Object.keys(e)).flat();return{states:K(0,t).map(t=>t<Math.min(e,r.length)?i[t]:z(i))}}function _A({count:e=1,participantsCount:t=32}={}){let r=K(0,e).map(()=>K(0,5).map(()=>k(0,9)).join(""));return{postalCodes:K(0,t).map(t=>t<e?r[t]:z(r))}}function LA({idPrefix:e,participantType:t,index:r,uuids:i}){let n=S(t)?t[0]:"X";return e?`${e}-${n}-${r}`:i?.pop()||za()}function BA(e){let{cities:t,states:r,postalCodes:i,nationalityCode:n,participantIndex:a}=e;return{postalCode:i?.[a],state:r?.[a],city:t?.[a],countryCode:n}}var VA={lastNames:["Abbey","Ahern","Ampleforth","Ananiadis","Andelic","Assange","Atreides","Austen","Bach","Banks","Barrington","Batty","Bauers","Beals","Beer","Bennett","Berry","Bonaparte","Brewer","Brockovich","Bukowski","Cassidy","Catton","Calvino","Carlin","Carson","Chip","Constant","Crane","Crowne","Cummings","Curie","Dallas","Diamond","Deckard","Drazic","Dunbar","Earhart","Eisenstein","Eldritch","Elliot","Ellul","Escher","Eyre","Faulkner","Fulcher","Fukuoka","Godel","Goldstein","Greer","Hedges","Herbert","Holmgren","Humperdinck","Huxley","Illich","Jeffers","Jensen","Jevons","Johnson","Johnstone","Jovovich","Kingsnorth","Langer","Fernwright","Fuller","Le Guin","Lem","Lovelace","Mander","McLuhan","Midgely","Mond","Montoya","Moore","Murry","Nagle","Nearing","Ogden","Ophuls","Parks","Paz","Peet","Perfect","Pendejo","Pevensie","Postman","Ripley","Rodda","Rumfoord","Runciter","Rugen","Sale","Schumacher","Shaftoe","Shelley","Shepard","Smith","Stratton","Stewart","Swift","Tillich","Turing","Tyrell","Twain","Yeats","Veblen","Yates","Vonnegut","Waterhouse","Watson","Wolin","Wirt","Waschuk","Wormwood","Zecic"],firstFemale:["Ada","Amelia","Amelie","America","Anne","Antonia","Aravis","Astrid","Beatrice","Brienne","Buttercup","Caitlin","Cimorene","Cordelia","Desdemona","Ellen","Elizabeth","Emily","Emmie","Erin","Eva","Evelyn","Heather","Helen","Hermia","Hypatia","Imogen","Jane","Jasmine","Juliana","Juliet","Katniss","Leeloo","Lenina","Lilith","Linda","Lizzie","Louise","Lucy","Marie","Mary","Martha","Matilda","Milla","Miranda","Meg","Melba","Nicole","Ola","Portia","Pris","Rachael","Rachel","Rebecca","River","Rosa","Rosalind","Scout","Sharn","Susanne","Titania","Uhura","Ursula","Valentina","Viola","Virginia","Xena","Zoe"],firstMale:["Alan","Aldous","August","Axel","Barda","Barry","Bill","Bruce","Charles","Chris","Constantine","Darwin","David","Derrick","Edward","Emmanuel","Ernst","Estlin","Fezzik","Filby","Frank","Frito","George","Glen","Helmholtz","Inigo","Italo","Ivan","Jacques","James","Jared","Jerry","Joe","Johann","Julian","John Michael","Jonathan","Korben","Kirkpatrick","Kurt","Lief","Malachi","Mark","Marhsall","Masanobu","Maurits","Michael","Miro","Mustapha","Neil","Nikola","Octavio","Palmer","Paul","Pierre","Robinson","Rick","Rincewind","Roy","Shannon","Sheldon","Stafford","Stanislaw","Stanley","Syme","Thorstein","Thomas","Tyrone","Vizzini","Walton","Walker","Warren","Wendell","Westley","William","Winston","Zoran"]};function GA(e){let{count:t=100,sex:r}=e||{};if(!t||r&&!kn(r))return{personData:[],error:gi};let i=Math.ceil(1.3*t),{lastNames:n,firstFemale:a,firstMale:o}=VA,s=Yl.map(({iso:e})=>e).filter(Boolean),c=Math.ceil(i/n.length),u=Math.ceil(i/a.length),d=Math.ceil(i/o.length),l=K(0,c).flatMap(()=>{let e=Wa(n,!1,!0);return K(0,n.length).map(()=>Y(e))}),p=K(0,u).flatMap(()=>{let e=Wa(a,!1,!0);return K(0,a.length).map(()=>Y(e))}),m=K(0,d).flatMap(()=>{let e=Wa(o,!1,!0);return K(0,o.length).map(()=>Y(e))}),f={};for(let h=0;h<i;h++){let e=l.pop(),t=r||z([Mn,Tn]),i=t===Mn?m.pop():p.pop(),n=z(s);f[`${i}${e}`]={nationalityCode:n,sex:t,firstName:i,lastName:e}}return{personData:Object.values(f).slice(0,t)}}function jA(e){let t=e?.count||1,{personExtensions:r,consideredDate:i,isMock:n=!0,gendersCount:a,personData:o,category:s,sex:c}=e||{};if(Number.isNaN(Number(t)))return{error:gi};let u=a?.[Mn]||An(c)&&t||0,d=a?.[Tn]||Nn(c)&&t||0;t=Math.max(t,u+d);let l=t-(u+d),p=[...u&&GA({count:u,sex:Mn}).personData||[],...d&&GA({count:d,sex:Tn}).personData||[],...l&&GA({count:l}).personData||[]],m=p.filter(e=>!c||u&&d||e.sex===c),f=[];if(Array.isArray(o)){let e=o.filter(e=>!("string"!=typeof e.firstName||"string"!=typeof e.lastName||e.sex&&![Mn,Tn].includes(e.sex)||e.nationalityCode&&("string"!=typeof e.nationalityCode||e.nationalityCode.length>3||!Yl.some(({iso:t,ioc:r})=>[t,r].includes(e.nationalityCode))))&&(e.nationalityCode&&f.push(e.nationalityCode),!0));if(!e.length)return{error:gi};m=e}let h=o?m:V(m);if(h.length<t){let{maleFirstNames:e,maleLastNames:r,femaleFirstNames:i,femaleLastNames:n,nationalityCodes:a}=p.reduce((e,t)=>{let{firstName:r,lastName:i,nationalityCode:n}=t;return t.sex===Mn?(e.maleFirstNames.includes(r)||e.maleFirstNames.push(r),e.maleLastNames.includes(i)||e.maleLastNames.push(i)):(e.femaleFirstNames.includes(r)||e.femaleFirstNames.push(r),e.femaleLastNames.includes(i)||e.femaleLastNames.push(i)),e.nationalityCodes.includes(n)||e.nationalityCodes.push(n),e},{maleFirstNames:[],maleLastNames:[],femaleFirstNames:[],femaleLastNames:[],nationalityCodes:[]});K(0,t-h.length).forEach(()=>{let t=c||z([Mn,Tn]),o=z(a),s={firstName:z(t===Mn?e:i),lastName:z(t===Mn?r:n),sex:t,nationalityCode:o};h.push(s)})}let{ageMinDate:g,ageMaxDate:U}=Fa({consideredDate:i,category:s}),S=I(g?.slice(0,4)||0)||I(U?.slice(0,4)||0)-3,v=I(U?.slice(0,4)||0)||I(g?.slice(0,4)||0)+3,y=(g||U)&&[S,v],w=h.slice(0,t).map((e,t)=>{let[i,a]=y||[],o=y&&Y(K(i,a)),s=Y(K(0,365)),c=o&&function(e,t,r){let i=new Date(e,0);return la(new Date(i.setDate(t)),r)}(o,s);return Object.assign(wn({extensions:r||[{name:"regionCode",value:t+1}],birthDate:c,isMock:n}),e)});return{persons:w.length&&w||h[0],nationalityCodes:f}}var $A=["Ace Academy","Avengers","Ball Bouncers","Baseliners","Captivators","Civil Disobedients","Continentals","Court Royal","Court Sharks","Diamond Dogs","Danger Zone","Doubles Dominators","Double Faults","Tricksters","Eliminators","Court Crusaders","Fuzz Busters","Game Changers","Goal Gurus","Good Volley","Green Machine","Hawk Eyes","Inside Outers","Killer Instinct","Line Toers","Masters of Mayhem","Matter Catchers","Cheap Shot","Mean Machines","Mindspace Invaders","Net Centric","Net Positive","Smash Mullet","Over Your Head","Spin Meisters","Aggressors","Racket Machine","Slice Happy","Refs Nightmare","Sandeaters","Sun Seekers","Slicer Dicers","Stacked Deck","Cross Stringers","The Emergence","Total Demolition","Touch and Go","Unreturnables","Upside Downers","Vertically Challenged","Visual Spectacle"];function qA({nameRoot:e="TEAM",count:t=1}={}){let r=V($A).slice(0,t);return r.length<t&&K(0,t-r.length).forEach(t=>r.push(`${e} ${t+1}`)),{names:r}}function WA(e){let{scaledParticipantsCount:t,rankingRange:r}=e,{ratingsParameters:i=qh,valuesInstanceLimit:n,ratingsValues:a=[],consideredDate:o,categories:s,category:c,nationalityCodesCount:u,nationalityCodeType:l,nationalityCodes:p,participantsCount:m=32,participantType:f,teamSize:h=8,personIds:g,idPrefix:I,uuids:U,personExtensions:S,addressProps:y,gendersCount:w,matchUpType:P,personData:T,sex:D,inContext:b,withISO2:M,withIOC:R,scaleAllParticipants:N}=e,A=f===jl||P===d,C=f===$l||P===$l;r&&(!Array.isArray(r)||!r.every(e=>E(e))||2!==r.length)&&(r=void 0),t=N?m:t;r=r||[1,t&&t>1e3?t:1e3],r[1]+=1;let O=m*((A?2:C&&(h??8))||1),k=jA({count:O,personExtensions:S,consideredDate:o,gendersCount:w,personData:T,category:c,sex:D});if(k.error)return k;let{nationalityCodes:F,persons:x}=k,_={},L={},B={},G={},j=e=>{Object.assign(_,e.doublesRankings),Object.assign(L,e.singlesRankings),Object.assign(G,e.doublesRatings),Object.assign(B,e.singlesRatings)};if(v(c)){let e=YA({scaledParticipantsCount:t,ratingsParameters:i,participantType:f,ratingsValues:a,rankingRange:r,category:c});j(e)}Array.isArray(s)&&s.forEach(e=>{let n=YA({scaledParticipantsCount:t,ratingsParameters:i,participantType:f,ratingsValues:a,rankingRange:r,category:e});j(n)});let $=Yl.filter(e=>"IOC"===l&&e.ioc||e.iso);let{postalCodesProfile:q,postalCodesCount:W,statesProfile:H,citiesProfile:Y,citiesCount:z,statesCount:J}=y||{},Q=e=>Object.keys(e).flatMap(e=>K(0,H[e]).map(()=>e)),X={cities:Y&&Q(Y)||y?.cities||FA({count:z||O,participantsCount:O}).cities,states:H&&Q(H)||y?.states||xA({count:J||O,participantsCount:O}).states,postalCodes:q&&Q(q)||y?.postalCodes||_A({count:W||O,participantsCount:O}).postalCodes},Z=function(e){let t=Math.ceil(O/e);return n&&t>n?Math.ceil(O/n):e}(u),ee=Z?V($).slice(0,u):p&&$.filter(e=>p.includes(e.iso))||$,te=V(K(0,Math.ceil(O/(Z||1))).map(()=>ee).flat(1/0)),re=qA({count:m}).names;return{participants:K(0,m).flatMap(e=>{let t=(A?2:C&&(h??8))||1,r=K(0,t).map(r=>function(e){let t=x[e],{nationalityCode:r,participantExtensions:i,participantTimeItems:n,extensions:a,firstName:o,birthDate:u,lastName:d,personId:p,sex:m}=t||{},f=o||"GivenName",h=d||"FamilyName",S=`${f} ${h}`,v=te[e],y=F?.length&&r||v&&("IOC"===l?v.ioc||v.iso:v.iso||v.ioc)||r;te?.length&&!y&&!r&&console.log("%c Invalid Nationality Code",{participantIndex:e,country:v});let w=BA({...X,participantIndex:e,nationalityCode:y}),P=wn({participantId:LA({participantType:Vl,index:e,idPrefix:I,uuids:U}),extensions:i,timeItems:n,participantRole:Qg,participantType:Vl,participantName:S,person:{personId:p||g?.length&&g[e]||za(),birthDate:ua(u)?u:void 0,addresses:[w],standardFamilyName:h,standardGivenName:f,nationalityCode:y,extensions:a,sex:m}});if(R&&y){let e=Yl.find(({iso:e})=>e===y);e?.ioc&&(P.person.iocNationalityCode=e.ioc),e?.label&&(P.person.countryName=e.label)}if(M&&y){let e=Yl.find(({iso:e})=>e===y);e?.iso2&&(P.person.iso2NationalityCode=e.iso2),e?.label&&(P.person.countryName=e.label)}let T=t=>{let r=t.categoryName||t.ratingType||t.ageCategoryCode,i=L[r]?.[e],n=_[r]?.[e];HA({scaleValue:i,eventType:Vo,scaleType:Hc,participant:P,category:t}),HA({scaleValue:n,eventType:jo,scaleType:Hc,participant:P,category:t});let a=B[r]?.[e],o=G[r]?.[e];HA({scaleValue:a,eventType:Vo,scaleType:Yc,participant:P,category:t}),HA({scaleValue:o,eventType:jo,scaleType:Yc,participant:P,category:t})};return Array.isArray(s)?s.forEach(e=>T(e)):c&&T(c),P}(e*t+r)),i=r.map(e=>e.participantId),n=r.map(e=>e.person.standardFamilyName).join("/"),a=A?jl:$l,o={participantId:LA({participantType:a,index:e,idPrefix:I,uuids:U}),participantName:A?n:re[e],participantRole:Qg,individualParticipantIds:i,participantType:a};return b&&(o.individualParticipants=r),A||C?[o,...r]:r}),...ce}}function HA({scaleValue:e,participant:t,eventType:r,scaleType:i,category:n}){let a=n.categoryName||n.ratingType||n.ageCategoryCode,o={itemValue:e,itemType:[zc,i,r,a].join(".")};a&&e&&(t.timeItems||(t.timeItems=[]),t.timeItems.push(o))}function YA(e){let{category:t,scaledParticipantsCount:r,ratingsParameters:i,participantType:n,ratingsValues:a=[]}=e,o=t.rankingRange||e.rankingRange||[1,1e3],s={},c={},u={},d={},{categoryName:l,ageCategoryCode:p,ratingType:m}=t,f=t.categoryName||t.ratingType||t.ageCategoryCode;if((l||p)&&!m){let[e,t]=o||[];if(c[f]=V(K(e,t)).slice(0,r||k(20,30)),[jl,$l].includes(n)){let[e,t]=o||[];s[f]=V(K(e,t)).slice(0,r||k(20,30))}}if(m&&i[m]){let{ratingMax:e,ratingMin:o,ratingAttributes:s}=t,c={...i[m],...s||{}},{attributes:l={},decimalsCount:p,accessors:h,range:g,step:I}=c,U=e=>{let t={},r=Object.keys(e||{});for(let i of r){let r=e[i];if("object"==typeof r&&r.generator){let{range:e}=r,[n,a]=e.slice().sort();t[i]=k(n,a)}else t[i]=r}return t},S=g[0]>g[1]?2:.7,[v,y]=g.slice().sort(),w=K(0,2e3).map(()=>x(v,y,S,I,p)).filter(t=>(!e||t<=e)&&(!o||t>=o)).slice(0,r||k(20,30)).map(e=>h?Object.assign({},...h.map(t=>({[t]:e})),U(l)):e);u[f]=[...a,...w],[jl,$l].includes(n)&&(d[f]=[...a,...w])}return{singlesRankings:c,doublesRankings:s,singlesRatings:u,doublesRatings:d}}function zA(e){let{alternatesCount:t=0,tieFormatName:r,drawSize:i}=e,n=0,a=0,o=0,s=0,c={},d={[Mn]:0,[Tn]:0,[bn]:0,[Dn]:0,ANY:0};(v(e.tieFormat)?e.tieFormat:Lo({namedFormat:r}))?.collectionDefinitions?.filter(Boolean).forEach(e=>{let{category:t,collectionId:r,matchUpType:i,matchUpCount:p,gender:m}=e;if(kn(m)){let e=On(m),t=p*(i===l?2:1);e&&d[e]<t&&(d[e]=t)}else En(m)&&(d[Mn]<p&&(d[Mn]=p),d[Tn]<p&&(d[Tn]=p));if(t){let e=JSON.stringify(t);c[e]=t}if(r||(e.collectionId=za()),Wm(l)(i)){let e=p;s+=p,n=Math.max(n,e)}if(Wm(u)(i)){let e=p;o+=p,a=Math.max(a,e)}});let p=Object.keys(c).length?Math.max(o,2*s):Math.max(a,2*n);return{maxDoublesDraw:n*(i+t),maxSinglesDraw:a*(i+t),teamSize:p,genders:d}}function KA({participantsProfile:e,tournamentRecord:t,eventProfiles:r,drawProfiles:i,startDate:n,uuids:a}){if(0===e?.participantsCount)return{addedCount:0,...ce};let{participantsCount:o,participantType:s,largestTeamDraw:c,largestTeamSize:u,gendersCount:d}=function({participantsProfile:e,eventProfiles:t,drawProfiles:r}){let{participantsCount:i,participantType:n=Vl}=e||{},a=i||0,o={[Tn]:0,[bn]:0,[Dn]:0,[Mn]:0,ANY:0},s=0,c=0,u=0,d=0,l=0,p=({alternatesCount:e=0,uniqueParticipants:t,tieFormatName:r,drawSize:i=0,eventType:n,tieFormat:a,category:p,gender:m,stage:f})=>{let h=n===Go,g=!!(t||f===Yo||p||m);if(n===$o){d=Math.max(d,i+e),a="object"==typeof a?a:Lo({namedFormat:r});let{teamSize:t,maxDoublesDraw:n,maxSinglesDraw:l,genders:p}=zA({alternatesCount:e,tieFormatName:r,tieFormat:a,drawSize:i});u=Math.max(u,t),c=Math.max(c,l),g||(s=Math.max(s,n)),Object.keys(p).forEach(e=>o[e]+=p[e])}else if(h)if(g){let t=2*(i+e);l+=t,m&&(o[m]+=t)}else i+e&&i+e>s&&(s=i+e);else if(g){let t=i+e;m&&(o[m]+=t),l+=t}else i&&i>c&&(c=i+e)};if(t?.forEach(e=>{let{tieFormatName:t,tieFormat:r,drawProfiles:i,eventType:n,category:a,gender:o}=e;if(i)for(let s of i){let{tieFormatName:e,tieFormat:i}=s;p({...s,tieFormatName:e||t,tieFormat:i||r,eventType:n,category:a,gender:o})}}),Array.isArray(r))for(let f of r)p(f);let m=Math.max(d*u,2*s,c);return s&&(n=jl),(i||a)<m&&(i=m),i&&s&&[jl,$o].includes(n)&&(c&&Math.floor(c/2)>s?i=Math.floor(c/2):(!c||2*s>=c)&&(i=Math.ceil(i/2))),void 0===i&&(i=t?.length||r?.length?0:32),i<a&&(i=a),{uniqueParticipantsCount:l,participantsCount:i,largestTeamDraw:d,largestTeamSize:u,participantType:n,gendersCount:o}}({participantsProfile:e,eventProfiles:r,drawProfiles:i}),l=e?.teamKey,p=WA({consideredDate:n,...e,participantsCount:o,participantType:s,gendersCount:d,uuids:a}).participants,m=0,f=AM({tournamentRecord:t,participants:p});if(f.error)return f;if(m+=f.addedCount,l){let e=CA({tournamentRecord:t,...l});if(e.error)return e}let h=p.filter(({participantType:e})=>e===Vl).map(dd),g=e?.idPrefix?`${$l}-${e.idPrefix}`:void 0;return f=AM({participants:K(0,c).map(e=>{let t=h.slice(e*u,(e+1)*u),r=LA({index:e,participantType:s,idPrefix:g,uuids:a});return{participantName:`Team ${e+1}`,participantRole:Qg,individualParticipantIds:t,participantType:$l,participantId:r}}),tournamentRecord:t}),f.error?f:(m+=f.addedCount,{addedCount:m,...ce})}function JA({drawProfiles:e,category:t,gender:r}){let i={},n=e?.reduce((e,n)=>{let{qualifyingPositions:a=0,participantsCount:o=0,uniqueParticipants:s,stage:c=Ho,drawSize:u=0}=n||{};Object.keys(e).includes(c)||(e[c]=0);let d=(o||u)-a;return s||r||t||c===Yo?(Object.keys(i).includes(c)||(i[c]=0),i[c]+=d):e[c]=Math.max(e[c],d),e},{}),a=Object.keys(i);return a.forEach(e=>n[e]+=i[e]),{stageParticipantsCount:n,uniqueParticipantsCount:i,uniqueParticipantStages:a}}function QA({allUniqueParticipantIds:e,stageParticipantsCount:t,eventParticipantType:r,targetParticipants:i}){let n=t[Ho]||0,a=t[Yo]||0;return{stageParticipants:{QUALIFYING:i?.filter(({participantType:e})=>e===r).filter(({participantId:t})=>!e.includes(t)).slice(0,a),MAIN:i?.filter(({participantType:e})=>e===r).filter(({participantId:t})=>!e.includes(t)).slice(a,a+n)}}}var XA={[Rd]:2,[yd]:1,[vd]:1,[Dd]:1,[Sd]:4};function ZA(e){let{defaultWithScorePercent:t=2,winningSide:r}=e,{matchUpStatusProfile:i=XA,matchUpFormat:n=ao,pointsPerMinute:a=1,sideWeight:o=4}=e;if(!ta({matchUpFormat:n}))return{error:Pt};if("object"!=typeof i)return{error:gi};if(t>100&&(t=100),Number.isNaN(Number(t))||Number.isNaN(Number(a))||Number.isNaN(Number(o)))return{error:gi};let s=Object.keys(i).filter(e=>Object.keys(_d).includes(e)&&e!==Id);if(Object.keys(s).reduce((e,t)=>e+i[t],0)>100)return{error:gi,matchUpStatusProfile:i};let c=s.reduce((e,t)=>(e.pointer=e.pointer+i[t],e.valueMap.push([e.pointer,t]),e),{pointer:0,valueMap:[]}),u=k(1,100),d=(c.valueMap.find(e=>u<=e[0])??[100,Id])[1],l={sets:[],scoreStringSide1:"",side2ScoreString:""};if(Sh(d)){r=r||k(1,2);let e={score:l,matchUpStatus:d,winningSide:r};if(!(d===Sd&&k(1,100)>100-t))return{outcome:e}}else if([yd,vd].includes(d))return{outcome:{score:l,matchUpStatus:d}};let p,m=Yn(n),{bestOf:f=1,exactly:h,setFormat:g,finalSetFormat:I}=m??{},U=[],S=k(0,1),v=r?[r-1]:[...K(0,o).map(()=>S),1-S],y=[Dd,Sd,Pd,bd].includes(d)&&(Y(K(1,h||f))||1),w=K(1,(h??f)+1);for(let b of w){let e=b===(h??f),{set:t,incomplete:r,winningSideNumber:i}=eE({setFormat:e&&I||g,incomplete:y===b,pointsPerMinute:a,matchUpStatus:d,weightedRange:v,setNumber:b});if(U.push(t),r){p=i;break}if(nM({matchUp:{score:{sets:U},matchUpFormat:n}}).calculatedWinningSide)break}let P=nM({matchUp:{score:{sets:U},matchUpFormat:n,winningSide:r}}),T=p?r||p:P.calculatedWinningSide,{score:D}=KN({winningSide:T,score:{sets:U},matchUpStatus:d});return{outcome:{winningSide:T,matchUpStatus:d,score:D}}}function eE({weightedRange:e=[0,1],pointsPerMinute:t,matchUpStatus:r,incomplete:i,setFormat:n,setNumber:a}){let o,s={setNumber:a},{setTo:c,tiebreakFormat:u,tiebreakAt:d,tiebreakSet:l,timed:p,minutes:m}=n,f=k(0,e.length-1),h=e[f];if(p){let n=m*t,a=Math.round(.2*n),c=n+Y([1,-1])*a,u=function(e=1,t=3,r=!0){let i=0;for(let n=0;n<t;n++)i+=Math.random()*(e/t);return r&&e>1?Math.round(i):i}(c,2),d=[u,c-u];h&&d.reverse(),o=e[f]+1;let l=(d[0]>d[1]?1:d[1]>d[0]&&2)||0;if(i){let[e,t]=d;return Object.assign(s,{side1Score:e,side2Score:t}),kd.includes(r)?{set:s,incomplete:i,winningSideNumber:o}:{set:s,incomplete:i}}l||(d[k(0,1)]+=1),l=d[0]>d[1]?1:2,l!==o&&d.reverse();let[p,g]=d;return Object.assign(s,{side1Score:p,side2Score:g,winningSide:o}),{set:s}}if(i)return s.side1Score=k(0,d),s.side2Score=k(0,d),kd.includes(r)&&(o=e[f]+1),{set:s,incomplete:i,winningSideNumber:o};{let t=K(1,c+1).flatMap(e=>K(0,c+2-e).map(()=>e)),r=t[k(0,t.length-1)],i=c&&DT({isSide1:!0,tiebreakAt:d,lowValue:r,setTo:c}),a=!i,o=1===e.length&&e[f]+1;if(!a){o?(i[0]>i[1]?1:2)!==o&&i.reverse():h&&i.reverse();let[e,t]=i;Object.assign(s,{side1Score:e,side2Score:t})}let p,m=NT({matchUpScoringFormat:{setFormat:n},setObject:s});if(m.hasTiebreakCondition||a){let{NoAD:e,tiebreakTo:t}=u||l||{},r=K(1,t+1).flatMap(e=>K(0,t+2-e).map(()=>e)),i=r[k(0,r.length-1)],n=bT({isSide1:!0,tiebreakNoAd:e,tiebreakTo:t,lowValue:i});if(n)if(a){let e=n[0]>n[1]?1:2;o?e!==o&&n.reverse():h&&n.reverse(),[s.side1TiebreakScore,s.side2TiebreakScore]=n,p=(n[0]>n[1]?1:n[1]>n[0]&&2)||void 0}else 2===m.leadingSide?[s.side1TiebreakScore,s.side2TiebreakScore]=n:[s.side2TiebreakScore,s.side1TiebreakScore]=n}s.winningSide=m.winningSide||m.leadingSide||o||p}return{set:s}}function tE({firstRoundDualMatchUps:e,event:t,tournamentRecord:r,drawDefinition:i}){let n=t?.category?.ageCategoryCode||t?.category?.categoryName;if(n){let e=OR({singlesOnly:!0,tournamentRecord:r,drawDefinition:i,scaleAccessor:{scaleName:n,sortOrder:"ASC",scaleType:Hc},event:t});if(e.error)return e;let{lineUps:a,participantsToAdd:o}=e;return AM({tournamentRecord:r,participants:o}),void Uu({element:i,extension:{name:Vu,value:a}})}let a=e[0]?.structureId,{positionAssignments:o}=$d({drawDefinition:i,structureId:a});if(!o?.length)return;let{participants:s}=Ag({participantFilters:{participantTypes:[m]},tournamentRecord:r});function c(e){return s?.find(t=>{let{participantId:r}=t;return o.find(e=>e.participantId===r)?.drawPosition===e})}e.forEach(e=>{let n=e.tieMatchUps.filter(Wm(u)),a=e.tieMatchUps.filter(Wm(l));n.forEach((e,n)=>{!function(e,n,a){e.sides.forEach(e=>{let{drawPosition:o}=e,s=c(o);if(s){let e=s.individualParticipantIds?.[n];return void(e&&nN({teamParticipantId:s.participantId,participantId:e,tournamentRecord:r,drawDefinition:i,tieMatchUpId:a,event:t}))}})}(e,n,e.matchUpId)}),a.forEach((e,n)=>{!function(e,n,a){e.sides.forEach(e=>{let{drawPosition:o}=e,s=c(o);s&&s.individualParticipantIds?.slice(2*n,2*n+2)?.forEach(e=>{nN({teamParticipantId:s.participantId,participantId:e,tournamentRecord:r,drawDefinition:i,tieMatchUpId:a,event:t})})})}(e,n,e.matchUpId)})})}function rE({structure:e,matchUpsMap:t,drawDefinition:r,tournamentRecord:i,event:n,matchUpStatusProfile:a,matchUpFormat:o,matchUpStatus:s,scoreString:c,randomWinningSide:d,completionGoal:p,completedCount:m}){let f=Bf({contextFilters:{matchUpTypes:[l,u]},afterRecoveryTimes:!1,tournamentRecord:i,inContext:!0,drawDefinition:r,matchUpsMap:t,structure:e,event:n}).matchUps.filter(({winningSide:e})=>!e).sort(eh).map(ld);for(let h of f){if(!Number.isNaN(Number(p))&&m.value>=p)break;let{matchUps:f}=Bf({matchUpFilters:{matchUpTypes:[l,u]},afterRecoveryTimes:!1,tournamentRecord:i,inContext:!0,drawDefinition:r,matchUpsMap:t,structure:e,event:n}),g=f.find(e=>e.matchUpId===h),I=[yd,vd].includes(g.matchUpStatus);if(g?.readyToScore&&!I){let e=aE({matchUpStatusProfile:a,tournamentRecord:i,drawDefinition:r,targetMatchUp:g,matchUpFormat:o,matchUpStatus:s,scoreString:c,winningSide:!d&&1,event:n});if(e?.error)return e;m.value+=1}}}function iE(e){let{matchUpStatusProfile:t,completeAllMatchUps:r,randomWinningSide:i,tournamentRecord:n,completionGoal:a,drawDefinition:o,event:s}=e;if(!o)return{error:ye};let c=e.matchUpFormat||o.matchUpFormat||s?.matchUpFormat,u=o.structures.slice().sort(Ld),d={value:0},{matchUps:l,matchUpsMap:p}=Kf({matchUpFilters:{matchUpTypes:[m],roundNumbers:[1]},contextFilters:{stages:[Ho,Yo]},inContext:!0,drawDefinition:o});if(l?.length){let e=tE({firstRoundDualMatchUps:l,event:s,tournamentRecord:n,drawDefinition:o});if(e?.error)return e}let f="string"==typeof r&&r,h=f&&Id,g=2===u.length&&u[0].finishingPosition===$s&&2===Q(u.map(({stage:e})=>e),[Ho,Jo]).length,I=u.map(({structureId:e})=>e);for(let m of I){if(d.value>=a)break;let r=o.structures.find(e=>e.structureId===m),u=rE({structure:r,matchUpsMap:p,drawDefinition:o,tournamentRecord:n,event:s,matchUpStatusProfile:t,matchUpFormat:c,matchUpStatus:h,scoreString:f,randomWinningSide:i,completionGoal:a,completedCount:d});if(u?.error)return u;g&&r.finishingPosition===$s&&e.completeRoundRobinPlayoffs&&FU({structureId:r.structureId,applyPositioning:!0,drawDefinition:o})}return{...ce,completedCount:d.value}}function nE(e){let{matchUpStatusCodes:t,policyDefinitions:r,tournamentRecord:i,drawDefinition:n,targetMatchUp:a,matchUpStatus:o,matchUpFormat:s,scoreString:c,winningSide:u,event:d}=e;if(!a||"BYE"===a.matchUpStatus)return;let{matchUpId:l}=a||{},{outcome:p}=cA({matchUpFormat:s,matchUpStatus:o,scoreString:c,winningSide:u});return t&&(p.matchUpStatusCodes=t),QN({tournamentRecord:i,policyDefinitions:r,drawDefinition:n,matchUpFormat:s,matchUpId:l,outcome:p,event:d})}function aE(e){let{matchUpStatusProfile:t={},tournamentRecord:r,policyDefinitions:i,drawDefinition:n,matchUpStatus:a,matchUpFormat:o,targetMatchUp:s,scoreString:c,winningSide:u,event:d}=e;if(c||a)return nE(e);let{matchUpId:l}=s||{},{outcome:p}=ZA({matchUpStatusProfile:t,matchUpFormat:o,winningSide:u});return QN({policyDefinitions:i,tournamentRecord:r,drawDefinition:n,matchUpFormat:o,matchUpId:l,outcome:p,event:d})}function oE({matchUpStatusProfile:e,completeAllMatchUps:t,randomWinningSide:r,tournamentRecord:i,drawProfiles:n,isMock:a,event:o}){let s=Nf({event:o}).flightProfile,{eventName:c,eventType:u,category:d}=o,{startDate:l}=i,p=[],m=d?.categoryName||d?.ageCategoryCode||d?.ratingType,f=o.drawDefinitions?.map(({drawId:e})=>e);if(Array.isArray(s?.flights))for(let[h,g]of s.flights.entries()){let{drawId:s,stage:d,drawName:I,drawEntries:U}=g;p.push(g.drawId);let S=n[h],{seedsCount:v,generate:y=!0}=S||{};if(y){let p=U.filter(nh(tc)).map(nh(tc)),g=m||c;if(i&&v&&v<=p.length&&K(1,v+1).forEach((e,t)=>{let r={scaleValue:e,scaleName:g,scaleType:Kc,eventType:u,scaleDate:l},n=p[t];Xy({tournamentRecord:i,participantId:n,scaleItem:r})}),f?.includes(s))break;let y=hM({...S,matchUpType:u,seedingScaleName:g,tournamentRecord:i,drawEntries:U,drawName:I,drawId:s,isMock:a,event:o,stage:d});if(y.error)return{error:y.error,drawIds:[]};let{drawDefinition:w}=y;if(!w)return{error:Pe};let P=n[h]?.drawExtensions;if(Array.isArray(P)&&P.filter(Iu).forEach(e=>Uu({element:w,extension:e})),y=uR({suppressNotifications:!0,tournamentRecord:i,drawDefinition:w,event:o}),y.error)return{error:y.error,drawIds:[]};if(S?.withPlayoffs){let e=w.structures?.[0].structureId,t=Uv({idPrefix:S.idPrefix,...S.withPlayoffs,tournamentRecord:i,drawDefinition:w,structureId:e,isMock:a,event:o});if(t?.error)return t}let T=S?.completionGoal;if(!1!==S?.automated&&(t||T)){let n=S?.matchUpFormat,a=iE({completeAllMatchUps:!T&&t,matchUpStatusProfile:e,randomWinningSide:r,tournamentRecord:i,completionGoal:T,drawDefinition:w,matchUpFormat:n,event:o});if(a.error)return{error:a.error,drawIds:[]};let s=a.completedCount;if(S?.drawType===Ls){let a=w.structures?.find(e=>e.stage===Ho);if(!a)return{error:et};let c=FU({structureId:a.structureId,tournamentRecord:i,drawDefinition:w,event:o});if(c.error)return{error:c.error,drawIds:[]};if(c=iE({completeAllMatchUps:!T&&t,completionGoal:T?T?T-(s??0):void 0:void 0,matchUpStatusProfile:e,randomWinningSide:r,tournamentRecord:i,drawDefinition:w,matchUpFormat:n,event:o}),c.error)return{error:c.error,drawIds:[]}}}}}return{...ce,drawIds:p}}function sE(e){let{participantsProfile:t={},uniqueParticipantsCount:r,ratingsParameters:i,tournamentRecord:n,eventProfile:a,eventIndex:o,event:s,uuids:c}=e,{category:u,gender:d,eventType:l}=s,p=Wm(Bo)(l)&&Vl||Wm(Go)(l)&&jl||l,m=r[Ho]||0,f=r[Yo]||0,h=a.drawProfiles?.length?m+f:a.participantsProfile?.participantsCount??0,g=kn(d)?d:void 0,I=t?.idPrefix?`E-${o}-${t?.idPrefix}`:void 0,{participants:U}=WA({uuids:a.uuids||c,...t,scaledParticipantsCount:a.scaledParticipantsCount,consideredDate:n?.startDate,rankingRange:a.rankingRange,participantType:p,participantsCount:h,ratingsParameters:i,category:u,idPrefix:I,sex:g}),S=AM({tournamentRecord:n,participants:U});if(S.error)return S;let v=U?.filter(({participantType:e})=>e===p),y=U?.map(dd);return{uniqueDrawParticipants:v,uniqueParticipantIds:y}}function cE({autoEntryPositions:e,tournamentRecord:t,drawParticipants:r,drawProfile:i,event:n}){let{drawType:a=ys,qualifyingPositions:o=0,stage:s=Ho,drawSize:c=0,drawName:u,drawId:d}=i,l=c-o,p=r.slice(0,l).map(dd);if(p.length){let r=Kg({participantIds:p,autoEntryPositions:e,entryStage:s,tournamentRecord:t,event:n});if(r.error)return r}let m=UR({drawName:u||a,qualifyingPositions:o,drawEntries:p.map(e=>({entryStatus:Dp,entryStage:s,participantId:e})),drawId:d,event:n,stage:s});return m.error?m:{...ce}}function uE({uniqueDrawParticipants:e,autoEntryPositions:t,stageParticipants:r,tournamentRecord:i,drawProfiles:n,category:a,gender:o,event:s}){let c=0;for(let u of n){let{qualifyingPositions:n=0,uniqueParticipants:d,stage:l=Ho,drawSize:p=0}=u,m=p-n,f=d||o||a||l===Yo,h=f?e.slice(c,c+m):r[l||Ho]||[];f&&(c+=m);let g=cE({autoEntryPositions:t,drawParticipants:h,tournamentRecord:i,drawProfile:u,event:s});if(g.error)return g}return{...ce}}function dE(e){let{allUniqueParticipantIds:t,matchUpStatusProfile:r,participantsProfile:i,completeAllMatchUps:n,autoEntryPositions:a,hydrateCollections:o,randomWinningSide:s,ratingsParameters:c,tournamentRecord:u,eventProfile:d,eventIndex:l,publish:p,isMock:m,uuids:f}=e,h=d.gender,g=d.eventName,{eventType:I=Bo,policyDefinitions:U,drawProfiles:S=[],eventExtensions:v,surfaceCategory:y,tieFormatName:w,processCodes:P,discipline:T,eventLevel:D,timeItems:b,ballType:M,category:R}=d,N=d.eventId||za(),A=d.tieFormat||(I===$o?Lo({namedFormat:w,event:{eventId:N,category:R,gender:h},hydrateCollections:o,isMock:m}):void 0),E=u.participants;for(let W of S)!h&&W.gender&&(h=W?.gender);let{stageParticipantsCount:C,uniqueParticipantsCount:O,uniqueParticipantStages:k}=JA({drawProfiles:S,category:R,gender:h}),F=Wm(Bo)(I)&&Vl||Wm(Go)(I)&&jl||I,{uniqueDrawParticipants:x=[],uniqueParticipantIds:_=[]}=k?sE({event:{eventType:I,category:R,gender:h},uniqueParticipantsCount:O,participantsProfile:i,ratingsParameters:c,tournamentRecord:u,eventProfile:d,eventIndex:l,uuids:f}):{},{eventAttributes:L}=d;"object"!=typeof L&&(L={});let B=R?.categoryName||R?.ageCategoryCode||R?.ratingType;g=g||B||"Generated Event";let V={...L,surfaceCategory:y,processCodes:P,discipline:T,eventLevel:D,eventName:g,eventType:I,tieFormat:A,ballType:M,category:R,eventId:N,gender:h};if(v?.length&&Array.isArray(v)){let e=v.filter(Iu);e?.length&&Object.assign(V,{extensions:e})}if(Array.isArray(b)&&b.forEach(e=>fv({event:$,timeItem:e})),"object"==typeof U)for(let W of Object.keys(U))Sv({policyDefinitions:{[W]:U[W]},event:V});V.category&&(V.category.categoryName=B);let G,j=xM({suppressNotifications:!1,internalUse:!0,tournamentRecord:u,event:V});if(j.error)return j;let $=j?.event,{stageParticipants:q}=QA({allUniqueParticipantIds:t,stageParticipantsCount:C,eventParticipantType:F,targetParticipants:E});if(S?.length){let e=uE({uniqueDrawParticipants:x,autoEntryPositions:a,stageParticipants:q,tournamentRecord:u,drawProfiles:S,category:R,gender:h,event:$});if(e.error)return e;let t=oE({matchUpStatusProfile:r,completeAllMatchUps:n,randomWinningSide:s,tournamentRecord:u,drawProfiles:S,isMock:m,event:$});if(t.error)return t;G=t.drawIds}else if(d?.participantsProfile?.participantsCount){let e=x.map(dd);if(e.length){let t=Kg({participantIds:e,autoEntryPositions:a,tournamentRecord:u,entryStage:Ho,event:$});if(t.error)return t}}return p&&VM({tournamentRecord:u,event:$}),{drawIds:G,eventId:N,uniqueParticipantIds:_}}function lE({tournamentRecords:e,scheduleDate:t,venueId:r,round:i}){if(!ua(t))return{error:Jt};let{extension:n}=Ru({name:zu,tournamentRecords:e,discover:!0}),a=n?.value||[],o=a.find(e=>Ca(t,e.scheduleDate));if(!o){let{startDate:r,endDate:i}=BD({tournamentRecords:e}),n=new Date(t);if(r&&n<new Date(r)||i&&n>new Date(i))return{error:Jt};o={scheduleDate:t,venues:[]},a.push(o)}let s=o.venues.find(e=>e.venueId===r);s||(s={venueId:r,rounds:[]},o.venues.push(s));let c=["notBeforeTime"],u=e=>Object.keys(e).filter(e=>!c.includes(e)).sort().map(t=>v(e[t])?u(e[t]):e[t]).flat().join("|");if(s.rounds.find(e=>u(e)===u(i)))return Pn({result:{error:Xe},stack:"addSchedulingProfileRound"});s.rounds.push(i);let d=pb({tournamentRecords:e,schedulingProfile:a});return d.error?d:{...ce}}function pE(e){let t=$c(e,[{drawProfile:!0,_ofType:Cc}]);if(t.error)return t;let{allUniqueParticipantIds:r=[],participantsProfile:i={},matchUpStatusProfile:n,completeAllMatchUps:a,autoEntryPositions:o,hydrateCollections:s,randomWinningSide:c,ratingsParameters:u,tournamentRecord:d,isMock:l=!0,drawProfile:p,startDate:m,drawIndex:f,uuids:h}=e,g=Wa(p,!1,!0),{excessParticipantAlternates:I=!0,matchUpFormat:U=ao,drawType:S=ys,tournamentAlternates:y=0,alternatesCount:w=0,qualifyingPositions:P,qualifyingProfiles:T,generate:D=!0,eventExtensions:b,drawExtensions:M,completionGoal:R,tieFormatName:A,buildTeams:E,seedsCount:C,timeItems:O,drawName:k,category:F,idPrefix:x,publish:_,gender:L,stage:B}=g,V=g.drawSize||(g.ignoreDefaults?void 0:32),G=g.eventId||za(),j=p.eventType||p.matchUpType||Bo,$=j===Go?jl:Vl,q=v(p.tieFormat)&&p.tieFormat||j===$l&&Lo({event:{eventId:G,category:F,gender:L},namedFormat:A,hydrateCollections:s,isMock:l})||void 0,W=F?.categoryName||F?.ageCategoryCode||F?.ratingType,H=p.eventName||W||`Generated ${j}`,Y=d?.participants||[],z=(T?.flatMap(e=>e.structureProfiles||[]).reduce((e,t)=>e+(!t.participantsCount||t.participantsCount>t.drawSize?t.drawSize:t.participantsCount||0),0)||0)*($===jl?2:1),J=(!p.participantsCount||p.participantsCount>V?V:p.participantsCount)||0,X={eventName:H,eventType:j,tieFormat:q,category:F,eventId:G,gender:L};Array.isArray(O)&&O.forEach(e=>fv({event:X,timeItem:e}));let{eventAttributes:Z}=p;if("object"!=typeof Z&&(Z={}),Object.assign(X,Z),b?.length&&Array.isArray(b)){let e=b.filter(Iu);e?.length&&Object.assign(X,{extensions:e})}let ee=[];if(0===i?.participantsCount||p.uniqueParticipants||z||!d||L||F){let e,t,r=(J||0)+w+z,n=r,a={[Mn]:0,[Tn]:0};j===$l&&(({teamSize:e,genders:t}=zA({alternatesCount:w,tieFormatName:A,tieFormat:q,drawSize:V})),Object.keys(t).forEach(e=>{let r=On(e);r&&kn(e)&&t[r]&&(a[r]=V*t[r])}),n=e*((V||0)+z));let o=i?.idPrefix?`D-${f}-${i?.idPrefix}`:void 0,s=WA({...i,scaledParticipantsCount:p.scaledParticipantsCount||i.scaledParticipantsCount,participantsCount:n,consideredDate:d?.startDate,sex:L||i?.sex,rankingRange:p.rankingRange,uuids:p.uuids||h,ratingsParameters:u,participantType:$,gendersCount:a,idPrefix:o,category:F}).participants;if(X.category&&(X.category.categoryName=W),d){let e=AM({participants:s,tournamentRecord:d});if(e.error)return e}if(s.forEach(({participantId:e})=>ee.push(e)),Y=s,j===$l){let i=t[Mn]?s.filter(({participantType:e,person:t})=>e===Vl&&t?.sex===Mn).map(dd):[],n=t[Tn]?s.filter(({participantType:e,person:t})=>e===Vl&&Nn(t?.sex)).map(dd):[],a=s.filter(({participantType:e})=>e===Vl).map(dd).filter(e=>!i.includes(e)&&!n.includes(e)),o=[...g.teamNames??[],...qA({count:r}).names],c=e-(t[Mn]+t[Tn]),u=0,l=0,p=0,m=K(0,r).map(e=>{let r=n.slice(u,u+t[Tn]),s=i.slice(l,l+t[Mn]),d=a.slice(p,p+c);u+=t[Tn],l+=t[Mn],p+=c;let m=!1!==E?[...r,...s,...d]:[];return{participantName:o[e]||`Team ${e+1}`,participantOtherName:`TM${e+1}`,participantRole:Qg,individualParticipantIds:m,participantType:$l,participantId:za()}}),f=AM({participants:m,tournamentRecord:d});if(!f.success)return f;Y=m}}let te=e=>{let{participantType:t}=e;return!!(Wm(Bo)(j)&&t===Vl||Wm(Go)(j)&&t===jl)||j===$l&&t===$l},re=e=>!p.gender||e.person?.sex===p.gender||e.individualParticipantIds?.some(e=>{let t=Y.find(t=>t.participantId===e);return t&&re(t)}),ie=Y.filter(te).filter(re).filter(({participantId:e})=>!r.includes(e)),ne=ie.slice(0,J).map(e=>e.participantId);if(l&&ne?.length){let e=Kg({autoEntryPositions:o,entryStage:B,tournamentRecord:d,participantIds:ne,event:X});if(e.error)return e}let ae=z?ie.slice(J,J+z).map(e=>e.participantId):0;if(l&&ae?.length){let e=0,t=1,r=(e,t)=>e.stageSequence-t.stageSequence,i=(e,t)=>e.roundTarget-t.roundTarget;for(let n of T.sort(i)){t=n.roundTarget||t;let i,a=1;for(let s of n.structureProfiles.sort(r)){let r=(s.drawSize||N(s.participantsCount))-(i||0),n=ae.slice(e,e+r),c=Kg({entryStage:Yo,entryStageSequence:a,autoEntryPositions:o,tournamentRecord:d,participantIds:n,roundTarget:t,event:X});if(c.error)return c;i=s.qualifyingPositions,e+=r,a+=1}t+=1}}let oe=I&&d?.participants?.filter(({participantId:e})=>!ne.includes(e)).filter(te).filter(re).slice(0,w||V-J||y).map(e=>e.participantId);if(l&&oe?.length){let e=Kg({participantIds:oe,autoEntryPositions:!1,entryStatus:Pp,tournamentRecord:d,event:X});if(e.error)return e.error}let se=W||H;d&&C&&C<=ne.length&&K(1,C+1).forEach((e,t)=>{let r={scaleName:se,scaleDate:m,scaleType:Bm,scaleValue:e,eventType:j},i=ne[t];Xy({tournamentRecord:d,participantId:i,scaleItem:r})});let ue=hM({...Wa(p,!1,!0),tournamentRecord:d,seedingScaleName:se,matchUpFormat:U,eventId:G,isMock:l,event:X});if(ue.error)return ue;if(!ue.drawDefinition)return{error:Pe};let{drawDefinition:de}=ue,le=de.drawId;if(Array.isArray(M)&&M.filter(Iu).forEach(e=>Uu({element:de,extension:e})),D){if(uR({drawDefinition:de,event:X,suppressNotifications:!0}),p.withPlayoffs){let e=de.structures?.[0].structureId,t=Uv({...p.withPlayoffs,tournamentRecord:d,drawDefinition:de,structureId:e,idPrefix:x,isMock:l,event:X});if(t?.error)return t}let e=!1===p.automated;if(l&&!e){let e=e=>{let t=iE({completeAllMatchUps:e.completeAllMatchUps,completionGoal:e.completionGoal,matchUpStatusProfile:n,randomWinningSide:c,tournamentRecord:d,drawDefinition:de,matchUpFormat:U,event:X});if(t.error)return t;let r=t.completedCount;if(S===Ls){let e=de.structures?.find(e=>e.stage===Ho);if(!e)return{error:et};FU({structureId:e.structureId,tournamentRecord:d,drawDefinition:de,event:X});let t=iE({completionGoal:R?R?R-(r??0):void 0:void 0,matchUpStatusProfile:n,completeAllMatchUps:a,randomWinningSide:c,tournamentRecord:d,drawDefinition:de,matchUpFormat:U,event:X});if(t.error)return t}};if(R&&e({completionGoal:R}),p.outcomes){let{matchUps:e}=th({inContext:!0,drawDefinition:de,event:X});for(let t of p.outcomes){let{matchUpStatus:r=Id,matchUpStatusCodes:i,stageSequence:n=1,matchUpIndex:a=0,structureOrder:o,matchUpFormat:s,drawPositions:c,roundPosition:u,stage:l=Ho,roundNumber:p,winningSide:m,scoreString:f}=t,h=e?.reduce((e,t)=>{let{structureId:r,matchUpId:i}=t;return e[r]?e[r].push(i):e[r]=[i],e},{})??[],g=Object.assign({},...Object.keys(h).map((e,t)=>({[e]:t+1}))),I=e?.filter(e=>!(l&&e.stage!==l||n&&e.stageSequence!==n||p&&e.roundNumber!==p||u&&e.roundPosition!==u||o&&g[e.structureId]!==o||c&&2!==Q(c,e.drawPositions).length))?.[a],U=nE({matchUpStatusCodes:i,tournamentRecord:d,drawDefinition:de,targetMatchUp:I,matchUpFormat:s,matchUpStatus:r,scoreString:f,winningSide:m});if(U?.error)return U}}a&&e({completeAllMatchUps:a})}_&&VM({tournamentRecord:d,event:X})}else{let e=UR({drawEntries:de.entries,drawName:k||S,qualifyingPositions:P,drawId:le,event:X,stage:B});if(e.error)return e}return{...ce,event:wn(X),uniqueParticipantIds:ee,targetParticipants:Y,drawDefinition:de,eventId:G,drawId:le}}var mE=()=>({altitude:void 0,courtId:void 0,courtName:"",courtDimensions:void 0,latitude:void 0,longitude:void 0,surfaceCategory:void 0,surfaceType:void 0,surfacedDate:void 0,indoorOutdoor:void 0,floodlit:void 0,dateAvailability:[],onlineResources:[],pace:void 0,notes:void 0}),fE=mE;function hE({tournamentRecord:e,disableNotice:t,venueId:r,courtId:i,court:n}){let{venue:a}=Pf({tournamentRecord:e,venueId:r});if(!a)return{error:Yr};a.courts||(a.courts=[]);let o={altitude:void 0,courtId:void 0,courtName:"",courtDimensions:void 0,latitude:void 0,longitude:void 0,surfaceCategory:void 0,surfaceType:void 0,surfacedDate:void 0,indoorOutdoor:void 0,floodlit:void 0,dateAvailability:[],onlineResources:[],pace:void 0,notes:void 0,venueId:r,courtId:i};if(o.courtId||(o.courtId=za()),a.courts.some(e=>e.courtId===o.courtId))return{error:$r};{let i=(n?.dateAvailability||[]).map(e=>({...e,date:ya(e.date),startTime:va(e.startTime),endTime:va(e.endTime),bookings:e.bookings?.map(({startTime:e,endTime:t,bookingType:r})=>({startTime:va(e),endTime:va(t),bookingType:r}))})),s=Object.keys(o);for(let e of s)if(n?.[e])if("dateAvailability"===e){let e=vf({dateAvailability:i});if(!e.valid&&e.error)return e;o.dateAvailability=i}else o[e]=n[e];let c=o;return a.courts.push(c),t||rn({payload:{venue:a,tournamentId:e.tournamentId},topic:ll,key:a.venueId}),{...ce,court:Wa(o),venueId:r}}}function gE(e){let{tournamentRecord:t,venueId:r}=e;if("string"!=typeof r||!r)return{error:zr};let i,n=e.tournamentRecords??(t&&{[t.tournamentId]:t})??{},a=[];for(let o of Object.values(n)){let{venue:t}=Pf({tournamentRecord:o,venueId:r});if(t){let t=IE({...e,tournamentRecord:o});for(let e of t?.courts??[])a.push(e?.courtId);if(t.error)return t;i=!0}}return i?{...ce,courtIds:a}:{error:Yr}}function IE({courtNameRoot:e="Court",dateAvailability:t=[],venueAbbreviationRoot:r,tournamentRecord:i,courtNames:n=[],courtTimings:a,courtsCount:o,startTime:s,courtIds:c,endTime:u,idPrefix:d,venueId:l,dates:p}){if(!l)return{error:zr};let m=Pf({tournamentRecord:i,venueId:l});if(m.error)return m;let{venue:f}=m;if(!E(o)||!n)return{error:Gr};let h=K(0,o=o??n.length).map(i=>{let o=a?.[i],c=o?p.map(e=>({date:la(e),startTime:s,endTime:u,...o})):t;return o&&s&&u&&c.push({startTime:s,endTime:u}),{courtName:n[i]||r&&f?.venueAbbreviation&&`${f?.venueAbbreviation} ${i+1}`||`${e} ${i+1}`,dateAvailability:c}}).map((e,t)=>{let r=c?.pop()||d&&`${d}-${t+1}`;return hE({disableNotice:!0,tournamentRecord:i,courtId:r,venueId:l,court:e})}).map(e=>e.court).filter(Boolean);return h.length!==o?Pn({info:"not all courts could be generated",result:{error:gi}}):(f&&rn({payload:{venue:f,tournamentId:i.tournamentId},topic:ll,key:f.venueId}),{...ce,courts:Wa(h)})}function UE({tournamentRecord:e,ignoreExistingVenues:t,venueProfiles:r,uuids:i}){let{startDate:n,endDate:a}=e,o=[];for(let[s,c]of r.entries()){let{venueAbbreviation:r,venueId:u=i?.pop()??za(),dateAvailability:d,venueDateAvailability:l,defaultStartTime:p,defaultEndTime:m,startTime:f="07:00",endTime:h="19:00",courtTimings:g,courtsCount:I,courtNames:U,venueName:S,idPrefix:v,courtIds:y}=c,w={venueName:S||`Venue ${s+1}`,venueAbbreviation:r,venueId:u};p&&(w.defaultStartTime=p),m&&(w.defaultEndTime=m),l&&(w.dateAvailability=l);let P=yf({tournamentRecord:e,venue:w});if(P.error){if(t)continue;return P}o.push(u);let T=fa(n,a),D=!Array.isArray(d)&&[{startTime:f,endTime:h}].concat(T.map(e=>({date:la(e),startTime:f,endTime:h})));if(I||U){let t=gE({dateAvailability:d||D,tournamentRecord:e,courtTimings:g,courtsCount:I,courtNames:U,startTime:f,idPrefix:v,courtIds:y,endTime:h,venueId:u,dates:T});if(t.error)return t}}return o}var SE=["Generated Tournament","CourtHive Challenge","Replication Crisis","Open Competition","Factory Follies","Mock Tournament","Atomic Culture","Racket Rally","Stats Fail"];function vE(e){let{startDate:t,endDate:r}=e??{},{tournamentName:i=Y(SE),ratingsParameters:n=qh,tournamentExtensions:a,policyDefinitions:o,schedulingProfile:s,venueProfiles:c,uuids:u}=e??{},d=!1!==e?.isMock||void 0;if(t&&!ua(t)||r&&!ua(r))return{error:Jt};if(e.leagueProfiles&&!Array.isArray(e.leagueProfiles)||e.eventProfiles&&!Array.isArray(e.eventProfiles)||e.drawProfiles&&!Array.isArray(e.drawProfiles))return{error:gi};if(!t){let e=new Date;t=la(r??e),r=la(e.setDate(e.getDate()+7))}if(!r){let e=new Date(t);r=la(e.setDate(e.getDate()+7))}let l=EA({...e.tournamentAttributes??{},tournamentName:i,startDate:t,endDate:r,isMock:d}),p=c?.length?UE({tournamentRecord:l,venueProfiles:c,uuids:u}):[];if(a?.length&&Array.isArray(a)){let e=a.filter(e=>Iu({extension:e}));e?.length&&Object.assign(l,{extensions:e,isMock:d})}if("object"==typeof o)for(let U of Object.keys(o))Sv({policyDefinitions:{[U]:o[U]},tournamentRecord:l});if(!e?.leagueProfiles?.length||e.eventProfiles?.length||e.drawProfiles?.length||e.participantsProfile){let t=KA({tournamentRecord:l,...e});if(!t.success)return t}let m=[],f=[],h=[];if(e.leagueProfiles){let t=function(e){let{tournamentRecord:t,leagueProfiles:r,eventIds:i,venueIds:n,drawIds:a,allUniqueParticipantIds:o,uuids:s}=e,c=0;for(let u of r){let r=[],{tieFormatName:d=ho,teamProfiles:l=[],teamsCount:p=0,category:m,idPrefix:f,gender:h}=u,g=u.leagueName??u.eventName??`League ${c+1}`,I=u.leagueId??u.eventId??s?.pop()??za();i.push(I);let U=v(u.tieFormat)&&u.tieFormat||Lo({event:{eventId:I,category:m,gender:h},namedFormat:d,isMock:e.isMock})||void 0;if(!U)return{error:bt};let S=Math.max(p,l.length),y=K(0,S),{genders:w,teamSize:P}=zA({tieFormat:U,drawSize:S}),T={[Tn]:0,[bn]:0,[Dn]:0,[Mn]:0,ANY:0};Object.keys(w).forEach(e=>T[e]+=w[e]);for(let i of y){let a=l?.[i]?.teamName??`Team ${i+1}`,c=l?.[i]?.teamId||s?.pop()||za(),d=u.startDate??e.startDate,p=WA({...u?.participantsProfile,participantsCount:P,consideredDate:d,gendersCount:T,category:m,gender:h,uuids:s}).participants,g=p.map(e=>e.participantId),I=$l,U=c??LA({participantType:I,idPrefix:f,index:i,uuids:s});r.push({participantId:U,entryStatus:Dp,entryStage:Ho});let S=l?.[i]?.venueIds??[],v={participantId:U,participantRole:Qg,participantName:a,individualParticipantIds:g,participantType:I,homeVenueIds:S};S.forEach(e=>!n.includes(e)&&n.push(e)),o.push(...g,U);let y=AM({participants:[v,...p],tournamentRecord:t});if(y.error)return y}let D={eventName:g,entries:r,eventType:$l,tieFormat:U,category:m,eventId:I,gender:h};if(t.events||(t.events=[]),t.events.push(D),r.length){let e=(E(u.roundsCount)&&u.roundsCount)??"DOUBLE_ROUND_ROBIN"===u.roundsCount?2*(S-1):S-1,r=hM({automated:u.automated,tournamentRecord:t,drawType:Is,roundsCount:e,drawSize:S,event:D});if(r.error)return r;let{drawDefinition:i}=r;if(i){let e=i?.drawId;uR({drawDefinition:i,event:D,suppressNotifications:!0}),a.push(e)}}c++}UE({tournamentRecord:t,ignoreExistingVenues:!0,venueProfiles:n.map(e=>({venueId:e})),uuids:s})}({allUniqueParticipantIds:m,tournamentRecord:l,...e,eventIds:f,venueIds:p,drawIds:h});if(t?.error)return t}if(e.drawProfiles){let t=function(e){let{tournamentRecord:t,drawProfiles:r,allUniqueParticipantIds:i,eventIds:n,drawIds:a}=e,o=0;for(let s of r){let r=pE({allUniqueParticipantIds:i,tournamentRecord:t,drawProfile:s,drawIndex:o,...e});if(r.error)return r;let{drawId:c,eventId:u,event:d,uniqueParticipantIds:l}=r;if(!1!==s?.addEvent){if(r=xM({suppressNotifications:!1,internalUse:!0,tournamentRecord:t,event:d}),r.error)return r;c&&a.push(c),n.push(u)}l?.length&&i.push(...l),o+=1}}({allUniqueParticipantIds:m,ratingsParameters:n,tournamentRecord:l,...e,eventIds:f,drawIds:h});if(t?.error)return t}if(e.eventProfiles){let t=function(e){let{eventProfiles:t,allUniqueParticipantIds:r,eventIds:i,drawIds:n}=e,a=0;for(let o of t){let t=dE({...e,eventIndex:a,eventProfile:o});if(t.error)return t;let{eventId:s,drawIds:c,uniqueParticipantIds:u}=t;c&&n.push(...c),i.push(s),u?.length&&r.push(...u),a+=1}}({allUniqueParticipantIds:m,ratingsParameters:n,tournamentRecord:l,...e,eventIds:f,drawIds:h});if(t?.error)return t}let{scheduledRounds:g,schedulerResult:I={}}=s?function(e){let{schedulingProfile:t,tournamentRecord:r,autoSchedule:i,periodLength:n,scheduleCompletedMatchUps:a}=e,o=function({schedulingProfile:e,tournamentRecord:t}){if("object"!=typeof e)return{error:gi};let r=Ol({tournamentRecord:t}).containedStructures,i=Xf({tournamentRecord:t}).matchUps??[],{tournamentId:n}=t,a=[];for(let o of e){let{scheduleDate:e,venues:s=[]}=o;for(let o of s){let{rounds:s,venueId:c}=o;for(let o of s){let{drawId:s,winnerFinishingPositionRange:u,roundSegment:d}=o,l=i.filter(e=>{let t=u?.indexOf("-")>0&&u.split("-").map(e=>+e),r=e.finishingPositionRange?.winner;return!(e.drawId!==s||o.roundNumber&&e.roundNumber!==o.roundNumber||r&&t&&2!==Q(r,t).length&&(L(r).length!==L(t).length||Q(r,t).length!==L(r).length))})[0];if(l){let{eventId:i,roundNumber:o,drawName:p,structureName:m,roundName:f}=l,h=l.structureId;o&&!u&&(h=Object.keys(r).find(e=>r[e].includes(h))??h);let g={tournamentId:n,structureId:h,roundNumber:o,roundSegment:d,eventId:i,drawId:s},I=lE({tournamentRecords:{[n]:t},round:g,scheduleDate:e,venueId:c});if(I.error)return I;a.push({structureName:m,roundName:f,drawName:p,...g})}}}}return{scheduledRounds:a}}({schedulingProfile:t,tournamentRecord:r});if(o.error)return o;let s=o.scheduledRounds;if(i){let{tournamentId:e}=r;return{schedulerResult:AA({scheduleCompletedMatchUps:a,tournamentRecords:{[e]:r},periodLength:n}),scheduledRounds:s}}return{scheduledRounds:s}}({...e,tournamentRecord:l}):{};return tn(),wn({...ce,tournamentRecord:l,scheduledRounds:g,schedulerResult:I,eventIds:f,venueIds:p,drawIds:h})}var yE={};function wE({keepExtensions:e=[],anonymizeParticipantNames:t=!0,tournamentRecord:r,tournamentName:i,personIds:n=[],tournamentId:a}){if(!r)return{error:Ie};let o=Array.isArray(e)?Zu.concat(...e):Zu,s=t=>Array.isArray(e)?t?.extensions?.filter(e=>o.includes(e.name)):t?.extensions,c={};r.extensions=s(r);let u=a||za();c[r.tournamentId]=u,r.tournamentId=u,r.createdAt=(new Date).toISOString(),r.tournamentName=i||`Anonymized: ${la(new Date)}`,r.isMock=!0,delete r.parentOrganisation;for(let C of r.participants||[]){C.extensions=s(C),C.onlineResources=[];let e=za();c[C.participantId]=e,C.participantId=e}for(let C of r.participants||[])Array.isArray(C.individualParticipantIds)&&(C.individualParticipantIds=C.individualParticipantIds.map(e=>c[e]));let d=0;for(let C of r.venues||[]){C.venueAbbreviation=`V${d}`,C.extensions=s(C),C.venueName=`Venue #${d}`,C.onlineResources=[],C.addresses=[];let e=za();c[C.venueId]=e,C.isMock=!0,d+=1;let t=0;for(let r of C.courts||[])r.courtName=`V${d}C${t}`,r.extensions=s(r),r.onlineResources=[],r.isMock=!0,t+=1}let l=1;for(let C of r.events||[]){C.extensions=s(C),C.onlineResources=[],C.isMock=!0;let e=za();c[C.eventId]=e,C.eventId=e;let t=C.category?.categoryName||C.category?.ageCategoryCode||C.category?.ratingType||C.gender;if(C.eventName=`Event ${l} ${t}`,Array.isArray(C.entries))for(let i of C.entries)i.participantId=c[i.participantId];for(let i of C.drawDefinitions||[]){i.extensions=s(i);let e=za();if(c[i.drawId]=e,i.drawId=e,i.isMock=!0,Array.isArray(i.entries))for(let r of i.entries)r.participantId=c[r.participantId];let t=e=>{e.extensions=s(e);let t=za();c[e.structureId]=t,e.structureId=t;for(let r of e.positionAssignments||[])r.participantId&&(r.participantId=c[r.participantId]);for(let r of e.seedAssignments||[])r.participantId&&(r.participantId=c[r.participantId]);for(let r of e.matchUps||[]){r.isMock=!0;for(let e of r.sides||[])e.lineUp&&(e.lineUp=e.lineUp.map(({participantId:e,collectionAssignments:t})=>({participantId:c[e],collectionAssignments:t})))}};for(let r of i.structures||[])if(t(r),Array.isArray(r.structures))for(let e of r.structures)t(e);for(let r of i.links||[])r.source.structureId=c[r.source.structureId],r.target.structureId=c[r.target.structureId]}let{extension:r}=Ru({name:Lu,element:C});Array.isArray(r?.value?.flights)&&r?.value.flights?.forEach(e=>{if(e.drawId=c[e.drawId],Array.isArray(e.drawEntries))for(let t of e.drawEntries)t.participantId=c[t.participantId]}),l+=1}let p=r.startDate||la(new Date),m=(r.participants||[]).filter(({participantType:e})=>e===Vl),f=m.reduce((e,t)=>{let r=t.person?.sex,i=On(r);return i&&kn(r)?e[i]+=1:e[Dn]+=1,e},{[Mn]:0,[Tn]:0,[Dn]:0}),h=Object.assign({},...Object.keys(f).map(e=>({[e]:jA({category:{ageCategoryCode:"O18"},count:f[e],addressProps:{citiesCount:10},personExtensions:[],consideredDate:p,sex:e})?.persons||[]}))),g={[Mn]:0,[Tn]:0,[Dn]:0},I=m.length,U=m.reduce((e,t)=>{let r=t.person?.addresses?.[0]||{},{city:i,state:n,postalCode:a}=r;return e.cities.includes(i)||e.cities.push(i),e.states.includes(n)||e.states.push(n),e.postalCodes.includes(a)||e.postalCodes.push(a),e},{cities:[],postalCodes:[],states:[]}),S=U.postalCodes.length,v=U.cities.length,y=U.states.length,{cities:w}=FA({count:v||I,participantsCount:I}),{states:P}=xA({count:y||I,participantsCount:I}),{postalCodes:T}=_A({count:S||I,participantsCount:I}),D={cities:w,states:P,postalCodes:T};m.forEach((e,r)=>{let i=e?.person,a=i?.sex||Dn,o=ya(i?.birthDate)?.split("-")[0],u=g[a],d=h[a][u];if(g[a]+=1,o){let[,e,t]=d?.birthDate?.split("-")||[],r=[o,e,t].join("-");d.birthDate=r}if(i?.addresses){let e=BA({...D,participantIndex:r,nationalityCode:d.nationalityCode});d.addresses=[e]}d.personId=n?.[r]||za(),t?(d.standardFamilyName=d.lastName,d.standardGivenName=d.firstName,e.participantName=`${d.standardGivenName} ${d.standardFamilyName}`):(d.standardFamilyName=i?.standardFamilyName,d.standardGivenName=i?.standardGivenName),delete d.firstName,delete d.lastName,d.extensions=s(i),e.person=d,c[i?.personId]=d.personId}),(r.participants||[]).filter(({participantType:e})=>e===jl).forEach(e=>{let{individualParticipantIds:t}=e;e.participantName=function({individualParticipantIds:e,individualParticipants:t}){let r=t.filter(({participantId:t})=>e.includes(t)).map(({person:e})=>e?.standardFamilyName).filter(Boolean).sort().join("/");return 1===e.length&&(r+="/Unknown"),r}({individualParticipantIds:t,individualParticipants:m})});let b=(r.participants||[]).filter(({participantType:e})=>e===$l),M=qA({count:b.length}).names;b.forEach((e,t)=>{e.participantName=M[t]});let R=(r.participants||[]).filter(({participantType:e})=>e===Gl),N=qA({count:R.length,nameRoot:"Group"}).names;R.forEach((e,t)=>{e.participantName=N[t]});let{extension:A}=Ru({element:r,name:zu});Array.isArray(A?.value)&&A?.value.forEach(e=>{e.tournamentId=c[e.tournamentId],e.structureId=c[e.structureId],e.eventId=c[e.eventId],e.drawId=c[e.drawId]});let{extension:E}=Ru({element:r,name:$u});return Array.isArray(E?.value)&&E?.value.forEach(e=>{e.personId=c[e.personId]}),{...ce}}function PE(e,t){return e?.find((e,r)=>void 0!==t.eventIndex&&r===t.eventIndex||t.eventName&&e.eventName===t.eventName||t.eventId&&e.eventId===t.eventId)}function TE({event:e,eventProfile:t,tournamentRecord:r,allUniqueParticipantIds:i,drawIds:n,params:a}){return function({event:e,eventProfile:t,tournamentRecord:r,allUniqueParticipantIds:i,drawIds:n}){let{gender:a,category:o,eventType:s}=e,{drawProfiles:c,publish:u}=t,d=Wm(Bo)(s)&&Vl||Wm(Go)(s)&&jl||s;if(c){let{stageParticipantsCount:u,uniqueParticipantsCount:l,uniqueParticipantStages:p}=JA({drawProfiles:c,category:o,gender:a}),{uniqueDrawParticipants:m=[],uniqueParticipantIds:f=[]}=p?sE({event:{eventType:s,category:o,gender:a},uniqueParticipantsCount:l,participantsProfile:t.participantsProfile,ratingsParameters:t.ratingsParameters,tournamentRecord:r,eventProfile:t,uuids:t.uuids}):{};i.push(...f);let{stageParticipants:h}=QA({targetParticipants:r.participants||[],allUniqueParticipantIds:i,stageParticipantsCount:u,eventParticipantType:d}),g=uE({uniqueDrawParticipants:m,autoEntryPositions:t.autoEntryPositions,stageParticipants:h,tournamentRecord:r,drawProfiles:c,category:o,gender:a,event:e});if(g.error||(g=oE({matchUpStatusProfile:t.matchUpStatusProfile,completeAllMatchUps:t.completeAllMatchUps,randomWinningSide:t.randomWinningSide,tournamentRecord:r,drawProfiles:c,isMock:t.isMock,event:e}),g.error))return g;n.push(...g.drawIds)}return u&&VM({tournamentRecord:r,event:e}),ce}({event:e,eventProfile:{...t,...a},tournamentRecord:r,allUniqueParticipantIds:i,drawIds:n})}function DE({eventProfile:e,tournamentRecord:t,allUniqueParticipantIds:r,eventIds:i,drawIds:n,params:a,eventIndex:o}){let s=dE({startDate:t.startDate,allUniqueParticipantIds:r,matchUpStatusProfile:a.matchUpStatusProfile,participantsProfile:a.participantsProfile,completeAllMatchUps:a.completeAllMatchUps,autoEntryPositions:a.autoEntryPositions,randomWinningSide:a.randomWinningSide,ratingsParameters:e.ratingsParameters,tournamentRecord:t,eventProfile:e,eventIndex:o,uuids:a.uuids});if(s.error)return s;let{eventId:c,drawIds:u,uniqueParticipantIds:d}=s;return u&&n.push(...u),i.push(c),d?.length&&r.push(...d),{eventIndexIncrement:1}}function bE(e){let{participantsProfile:t={},schedulingProfile:r,tournamentRecord:i,autoSchedule:n,eventProfiles:a,periodLength:o,venueProfiles:s,drawProfiles:c,uuids:u}=e;if(!i)return{error:Ie};let d=[],l=[],p=[];a?.forEach(e=>{let t=PE(i.events,e);t?.gender&&(e.gender=t.gender)});let m=i.participants?.length||void 0;m&&t?.idPrefix&&(t.idPrefix=`${t.idPrefix}-${m}`);let f=KA({startDate:i.startDate,participantsProfile:t,tournamentRecord:i,eventProfiles:a,drawProfiles:c,uuids:u});if(!f.success)return f;if(a){let t=function({eventProfiles:e,tournamentRecord:t,allUniqueParticipantIds:r,eventIds:i,drawIds:n,params:a}){let o=t.events?.length||0;for(let s of e){let e=PE(t.events,s);if(e){let i=TE({event:e,eventProfile:s,tournamentRecord:t,allUniqueParticipantIds:r,drawIds:n,params:a});if(i?.error)return i}else{let e=DE({eventProfile:s,tournamentRecord:t,allUniqueParticipantIds:r,eventIds:i,drawIds:n,params:a,eventIndex:o});if(e?.error)return e;o+=e?.eventIndexIncrement||1}}return ce}({eventProfiles:a,tournamentRecord:i,allUniqueParticipantIds:d,eventIds:l,drawIds:p,params:e});if(t.error)return t}if(c){let t=function({drawProfiles:e,tournamentRecord:t,allUniqueParticipantIds:r,eventIds:i,drawIds:n,params:a}){let o=(t.events||[]).flatMap(e=>e.drawDefinitions?.map(()=>1)||[]).reduce((e,t)=>e+t,0);for(let s of e){let e=pE({startDate:t.startDate,allUniqueParticipantIds:r,matchUpStatusProfile:a.matchUpStatusProfile,participantsProfile:a.participantsProfile,completeAllMatchUps:a.completeAllMatchUps,autoEntryPositions:a.autoEntryPositions,hydrateCollections:a.hydrateCollections,randomWinningSide:a.randomWinningSide,ratingsParameters:a.ratingsParameters,tournamentRecord:t,drawProfile:s,drawIndex:o,uuids:a.uuids});if(e.error)return e;let{drawId:c,eventId:u,event:d,uniqueParticipantIds:l}=e;if(e=xM({tournamentRecord:t,event:d,internalUse:!0}),e.error)return e;c&&n.push(c),i.push(u),l?.length&&r.push(...l),o+=1}return ce}({drawProfiles:c,tournamentRecord:i,allUniqueParticipantIds:d,eventIds:l,drawIds:p,params:e});if(t.error)return t}let h=s?.length?UE({tournamentRecord:i,venueProfiles:s}):[],g=function({schedulingProfile:e,autoSchedule:t,periodLength:r,tournamentRecord:i}){let n={};if(e?.length){let a=pb({tournamentRecords:{[i.tournamentId]:i},schedulingProfile:e});if(a.error)return a;if(t){let{tournamentId:e}=i;n=AA({tournamentRecords:{[e]:i},periodLength:r})}}return{scheduledRounds:[],schedulerResult:n}}({tournamentRecord:i,schedulingProfile:r,autoSchedule:n,periodLength:o});if(g.error)return g;let{scheduledRounds:I,schedulerResult:U}=g;return{totalParticipantsCount:i.participants.length,scheduledRounds:I,schedulerResult:U,...ce,eventIds:l,venueIds:h,drawIds:p}}n(yE,{anonymizeTournamentRecord:()=>wE,modifyTournamentRecord:()=>bE});var ME={};n(ME,{addDynamicRatings:()=>rw,addIndividualParticipantIds:()=>rN,addParticipant:()=>NM,addParticipants:()=>AM,addPenalty:()=>ZE,addPersonRequests:()=>kE,addPersons:()=>tC,createGroupParticipant:()=>jE,createTeamsFromParticipantAttributes:()=>CA,deleteParticipants:()=>sI,filterParticipants:()=>Rg,findParticipant:()=>GE,getCompetitionParticipants:()=>ND,getPairedParticipant:()=>Of,getParticipantEventDetails:()=>AD,getParticipantMembership:()=>ED,getParticipantScaleItem:()=>Eg,getParticipantSchedules:()=>CD,getParticipantSignInStatus:()=>OD,getParticipantTimeItem:()=>tp,getParticipants:()=>Ag,getScaleValues:()=>Qc,mergeParticipants:()=>XE,modifyIndividualParticipantIds:()=>FE,modifyParticipant:()=>iN,modifyParticipantName:()=>$E,modifyParticipantOtherName:()=>_E,modifyParticipantsSignInStatus:()=>xE,modifyPenalty:()=>KE,modifyPersonRequests:()=>CE,mutate:()=>RE,participantScaleItem:()=>hg,query:()=>RD,regenerateParticipantNames:()=>VE,removeIndividualParticipantIds:()=>nI,removeParticipantIdsFromAllTeams:()=>oI,removePenalty:()=>HE,removePersonRequests:()=>OE,removeRatings:()=>WE,scaledTeamAssignment:()=>qE,setParticipantScaleItem:()=>Xy,setParticipantScaleItems:()=>Zy,validateLineUp:()=>HI});var RE={};function NE(e=0){("number"!=typeof e||isNaN(e))&&(e=0);let t=new Date;return t.setHours(t.getHours()+e),t.getTime().toString(36).slice(-6).toUpperCase()}function AE({personRequests:e,personId:t,requests:r}){e[t]||(e[t]=[]);let i=r.filter(({requestType:e})=>e).map(e=>{let{date:t,startTime:r,endTime:i}=e;return e.requestType===mA&&(t=ya(t),r=va(r),i=va(i),t&&r&&i)?{date:t,startTime:r,endTime:i,requestType:e.requestType}:e}).filter(Boolean);for(let n of i)n.requestId=NE(),e[t].push(n);return{mergeCount:i.length}}function EE(e){let{tournamentRecords:t,personRequests:r}=e,i=$c(e,[{[zs]:!0}]);if(i.error)return i;if(!r)return{...ce};let n=Object.values(t);for(let a of n){let e=a.participants??[],t=[];for(let i of Object.keys(r))if(hu({tournamentParticipants:e,personId:i})){let e=r[i];e.length&&t.push({personId:i,requests:e})}Object.keys(t).length&&Uu({element:a,extension:{value:t,name:$u}})}return{...ce}}function CE(e){let{tournamentRecords:t,requests:r,personId:i}=e,n=$c(e,[{[zs]:!0},{requests:!0,[_c]:Oc,[xc]:gi}]);if(n.error)return n;let a=r.map(({requestId:e})=>e).filter(Boolean),{personRequests:o}=hb({tournamentRecords:t}),s=e=>{o&&(o[e]=o[e].map(e=>{if(!a.includes(e.requestId))return e;let t=r.find(t=>t.requestId===e.requestId);return t.requestType?Object.assign(e,t):void 0}).filter(Boolean))};if(i&&o?.[i])s(i);else if(o)for(let u of Object.keys(o))s(u);let c=r.filter(e=>!e.requestId);return c.length&&AE({personRequests:o,personId:i,requests:c}),EE({tournamentRecords:t,personRequests:o})}function OE(e){let{tournamentRecords:t,requestType:r,requestId:i,personId:n,date:a}=e,o=$c(e,[{[zs]:!0}]);if(o.error)return o;let{personRequests:s}=hb({tournamentRecords:t}),c=e=>{s&&(s[e]=s[e].filter(e=>!(r&&e.requestType===r||i&&e.requestId===i||a&&e.date===a)),s?.[e]?.length||delete s[e])},u=!(r||i||n||a);if(!u)if(n&&s?.[n])c(n);else if(s)for(let d of Object.keys(s))c(d);return!u&&s&&Object.keys(s).length?EE({tournamentRecords:t,personRequests:s}):gu({name:$u,tournamentRecords:t,discover:!0})}function kE(e){let{tournamentRecords:t,personId:r,requests:i}=e,n=$c(e,[{[zs]:!0,[Uc]:!0},{requests:!0,[_c]:Oc,[xc]:gi}]);if(n.error)return n;let{personRequests:a}=hb({tournamentRecords:t}),{mergeCount:o}=AE({personRequests:a,personId:r,requests:i});return o&&a?EE({tournamentRecords:t,personRequests:a}):{error:gi}}function FE({individualParticipantIds:e,groupingParticipantId:t,tournamentRecord:r}){let i="modifyIndividualParticipantIds";if(!r)return Pn({result:{error:Ie},stack:i});if(!t||!e)return Pn({result:{error:$t},stack:i});let n=r.participants||[],a=n.find(e=>e.participantId===t);if(!a)return Pn({result:{error:Sr},stack:i});if(![$l,Gl].includes(a.participantType))return Pn({result:{error:mr},context:{participantType:a.participantType},stack:i});let o=e.filter(e=>n.find(t=>t.participantId===e)?.participantType!==Vl);if(o.length)return Pn({result:{error:lr,invalidParticipantIds:o},stack:i});let s=a.individualParticipantIds||[],c=e.filter(e=>!s.includes(e)),u=s.filter(t=>!e.includes(t)),d=rN({individualParticipantIds:c,groupingParticipantId:t,tournamentRecord:r});if(d.error)return Pn({result:d,stack:i});let l=nI({individualParticipantIds:u,groupingParticipantId:t,tournamentRecord:r});if(l.error)return Pn({result:l,stack:i});let{topics:p}=cn();if(p.includes(sl)){let e=n.find(({participantId:e})=>e===t);rn({topic:sl,payload:{tournamentId:r.tournamentId,participants:[e]}})}return{...d,...l}}function xE({tournamentRecord:e,participantIds:t,signInState:r}){if(!e)return{error:Ie};if(!Array.isArray(t))return{error:$t};if(![Ll,_l].includes(r))return{error:gi,signInState:r};let i=e.participants||[];if(!i.length)return{error:gr};let n=i.map(dd),a=t.filter(e=>!n.includes(e));if(a.length)return{error:gi,context:{invalidParticipantIds:a}};let o=[],s=(new Date).toISOString();for(let u of i){let{participantId:i}=u;if(t.includes(i)){let t=pv({duplicateValues:!1,tournamentRecord:e,participantId:i,timeItem:{itemType:xl,itemValue:r,createdAt:s}});if(t.error)return t;o.push(u)}}let{topics:c}=cn();return o.length&&c.includes(sl)&&rn({topic:sl,payload:{tournamentId:e.tournamentId,participants:o}}),{...ce}}function _E({tournamentRecord:e,participantId:t,participantOtherName:r}){if(!e)return{error:Ie};if(!t)return{error:Ir};let{participant:i}=Kl({tournamentRecord:e,participantId:t});if(!i)return{error:Sr};i.participantOtherName=r;let{topics:n}=cn();return n.includes(sl)&&rn({topic:sl,payload:{tournamentId:e.tournamentId,participants:[i]}}),{...ce}}function LE({personFormat:e,person:t}){let r=e=>e.replace(/\W/g,""),i=e=>e.toLowerCase().indexOf("l")<e.toLowerCase().indexOf("f"),n=e=>e.indexOf(",")>=0;if(!t)return;let a=e.indexOf(" ")>0?" ":"",o=gI(t?.standardGivenName??""),s=gI(t?.standardFamilyName??"");if(!e)return`${o}${a}${s}`;(e=>e.toLowerCase().indexOf("f.")>=0)(e)&&!n(e)&&!i(e)&&(o=`${o[0]}.`),(e=>/^[a-z]*$/.test(r(e)))(e)?(o=o.toLowerCase(),s=s.toLowerCase()):(e=>/^[A-Z]*$/.test(r(e)))(e)?(o=o.toUpperCase(),s=s.toUpperCase()):(e=>/^[LAST]{4}/.test(r(e)))(e)&&(s=s.toUpperCase());let c=`${o}${a}${s}`;return(e=>e.toLowerCase().indexOf("f")<0)(e)?c=s:i(e)&&(c=n(e)?`${s},${a}${o}`:`${s}${a}${o}`),c}function BE({participantMap:e,participant:t,formats:r}){let{participantType:i,individualParticipantIds:n,person:a}=t,o=i&&r[i];if(i!==Bl&&o){let{personFormat:r,doublesJoiner:s}=o;i===Vl&&(t.participantName=LE({person:a,personFormat:r})),i===jl&&(t.participantName=n?.map(t=>{let i=e[t]?.person;return LE({person:i,personFormat:r})}).filter(Boolean).join(s??"/"))}}function VE({tournamentRecord:e,formats:t}){if(!e)return{error:Ie};if(!v(t))return{error:$t};let r=e.participants??[],i=w(r,"participantId");for(let n of r)BE({participant:n,participantMap:i,formats:t});return{...ce}}function GE(e){let t,r,{tournamentRecord:i,policyDefinitions:n,contextProfile:a,participantId:o,personId:s}=e,c=e.tournamentRecords||i&&{[i.tournamentId]:i}||{};if("string"!=typeof o&&"string"!=typeof s)return{error:$t,stack:"publicFindParticipant"};for(let u of Object.values(c)){if(r=u.tournamentId,t=hu({tournamentParticipants:u.participants||[],internalUse:!0,policyDefinitions:n,contextProfile:a,participantId:o,personId:s}),t)break}return{participant:t,tournamentId:r,...ce}}function jE({individualParticipantIds:e=[],participantRoleResponsibilities:t,participantRole:r=tI,tournamentRecord:i,participantId:n,groupName:a}){if(!i)return{error:Ie};if(!a)return{error:$t,info:"Missing groupName"};if(!Array.isArray(e))return{info:"Invalid individualParticipantIds",error:gi};let o=(Ag({participantFilters:{participantTypes:[Vl]},tournamentRecord:i}).participants??[]).map(e=>e.participantId);for(let d of e)if(!o.includes(d))return{error:mr,participantId:d};let s=wn({participantId:n||za(),participantRoleResponsibilities:t,participantName:a,individualParticipantIds:e,participantType:Gl,participantRole:r}),c=NM({participant:s,tournamentRecord:i});if(c.error)return c;let{topics:u}=cn();return u.includes(Yd)&&rn({topic:Yd,payload:{tournamentId:i.tournamentId,participants:[s]}}),{...ce,participant:Wa(s)}}function $E({tournamentRecord:e,participantName:t,participantId:r}){if(!e)return{error:Ie};if(!r)return{error:Ir};if(!t)return{error:$t,info:"Missing participantName"};let{participant:i}=Kl({tournamentRecord:e,participantId:r});if(!i)return{error:Sr};i.participantName=t;let{topics:n}=cn();return n.includes(sl)&&rn({topic:sl,payload:{tournamentId:e.tournamentId,participants:[i]}}),{...ce}}function qE({clearExistingAssignments:e=!0,individualParticipantIds:t,reverseAssignmentOrder:r,initialTeamIndex:i=0,scaledParticipants:n=[],teamParticipantIds:a,tournamentRecord:o,scaleAttributes:s,teamNameBase:c,teamsCount:u,eventId:d,event:l}){if(!o)return{error:Ie};if(!Array.isArray(a)&&!F(u)&&!d||!F(i)||n&&!Array.isArray(n)||s&&("object"!=typeof s||!Object.keys(s).length))return{error:gi};if(!s&&!n.length||!n&&(!t||!s))return{error:$t,info:"Missing scaling details"};if(d&&!a){if(l?.eventType!==qo)return{error:at};a=l?.entries?.filter(({entryStatus:e})=>e===Dp).map(dd)}if(!a?.length&&!u)return{info:"Missing teamParticipantIds or teamsCount",error:$t};let p=t??n.map(({participantId:e})=>e);r&&(a?.reverse(),i+=1),i>(a?.length||0)-1&&(i=0);let m=a?.slice(i).concat(...a.slice(0,i))??[],f=[];for(let I of o.participants??[]){let{participantId:e,participantType:t}=I;if(m.includes(e)){if(t!==Bl)return{error:mr,participant:I};f.push(I)}}if(u&&f.length<u){let e=c??"Team",t=K(0,u-(f?.length||0)).map(t=>({participantName:`${e} ${t+1}`,participantType:Bl,participantRole:Qg})),{participants:r=[]}=AM({participants:t,returnParticipants:!0,tournamentRecord:o}),i=r.map(dd),n=o.participants?.filter(({participantId:e})=>i.includes(e))??[];f.push(...n)}if(!f.length)return{error:Ui};if(e)for(let I of f)I.individualParticipantIds=[];else{let e=f.map(e=>e).flat();t?.length?p=p.filter(t=>!e.includes(t)):n=n?.filter(({participantId:t})=>!e.includes(t))}if(!t?.length&&!n?.length)return{error:di,info:"Nothing to be done"};if(!n.length){for(let e of o.participants??[]){let{participantId:t,participantType:r}=e;if(!p.includes(t))continue;if(r!==Vl)return{error:mr,participant:e};let i=hg({scaleAttributes:s,participant:e})?.scaleItem,a={participantId:t,scaleValue:s?.accessor?i?.scaleValue?.[s?.accessor]:i?.scaleValue};n.push(a)}if(!n.length)return{error:Sr}}n.sort((e,t)=>s?.sortOrder?(t?.scaleValue||0)-(e?.scaleValue||0):(e?.scaleValue||1/0)-(t?.scaleValue||1/0));for(let I of n)if(!I.participantId)return{error:gi,scaledParticipant:I};let h=0;for(;h<n.length;){for(let e of f){if(h+1>n.length)break;let t=n[h];e.individualParticipantIds.push(t.participantId),h++}f.reverse()}let g=f.map(dd);for(let I of o.events??[]){if(I.eventType!==qo)continue;let e=(I.entries??[]).filter(e=>g.includes(e.participantId));for(let t of e){let e=t.participantId,r=f.find(t=>t.participantId===e)?.individualParticipantIds;I.entries=(I.entries??[]).filter(e=>!r.includes(e.participantId)),(I.drawDefinitions??[]).forEach(e=>{e.entries=(e.entries??[]).filter(e=>!r.includes(e.participantId))});let{flightProfile:i}=Nf({event:I});(i?.flights||[]).forEach(e=>{e.drawEntries=(e.drawEntries||[]).filter(e=>!r.includes(e.participantId))})}}return{...ce,scaledParticipants:n}}function WE(e){let t=$c(e,[{[Js]:!0,[pc]:!0},{ratingType:!1,[kc]:e=>qh[e]}]);if(t.error)return t;let r=`${e.ratingType}.${Wc}`,i=e.asDynamic?r:e.ratingType,n=[zc,Yc,e.eventType,i].join("."),a=e.tournamentRecord.participants??[];for(let o of a)o.timeItems&&(o.timeItems=o.timeItems.filter(e=>e.itemType!==n));return{...ce}}function HE(e){let{tournamentRecords:t}=e;if("object"!=typeof t||!Object.keys(t).length)return{error:ge};for(let r of Object.values(t)){let t=YE({...e,tournamentRecord:r});if(t.error&&t.error!==Vr)return t}return{...ce}}function YE({tournamentRecord:e,penaltyId:t}){if(!e)return{error:Ie};if(!t)return{error:Br};let r,i=[],n=!1;return(e?.participants??[]).forEach(e=>{let a=!1;e.penalties=(e.penalties??[]).filter(o=>(o.penaltyId===t&&(a=!0,n||(r=o,n=!0)),a&&i.push(e),o.penaltyId!==t))}),r&&rn({topic:sl,payload:{tournamentId:e.tournamentId,participants:i}}),r?{...ce,penalty:r}:{error:Vr}}n(RE,{addDynamicRatings:()=>rw,addIndividualParticipantIds:()=>rN,addParticipant:()=>NM,addParticipants:()=>AM,addPenalty:()=>ZE,addPersonRequests:()=>kE,addPersons:()=>tC,createGroupParticipant:()=>jE,createTeamsFromParticipantAttributes:()=>CA,deleteParticipants:()=>sI,findParticipant:()=>GE,mergeParticipants:()=>XE,modifyIndividualParticipantIds:()=>FE,modifyParticipant:()=>iN,modifyParticipantName:()=>$E,modifyParticipantOtherName:()=>_E,modifyParticipantsSignInStatus:()=>xE,modifyPenalty:()=>KE,modifyPersonRequests:()=>CE,regenerateParticipantNames:()=>VE,removeIndividualParticipantIds:()=>nI,removeParticipantIdsFromAllTeams:()=>oI,removePenalty:()=>HE,removePersonRequests:()=>OE,removeRatings:()=>WE,scaledTeamAssignment:()=>qE,setParticipantScaleItem:()=>Xy,setParticipantScaleItems:()=>Zy});var zE=({penaltyId:e=za()}={})=>({refereeParticipantId:void 0,penaltyCode:void 0,penaltyType:void 0,extensions:void 0,matchUpId:void 0,createdAt:void 0,issuedAt:void 0,notes:void 0,penaltyId:e});function KE(e){let{tournamentRecords:t}=e;if("object"!=typeof t||!Object.keys(t).length)return{error:ge};for(let r of Object.values(t)){let t=JE({...e,tournamentRecord:r});if(t.error&&t.error!==Vr||t.success)return t}return{error:Vr}}function JE({tournamentRecord:e,modifications:t,penaltyId:r}){if(!e)return{error:Ie};if(!t)return{error:gi,modifications:t};if(!r)return{error:Br};let i=e?.participants??[],n=Object.keys(zE()).filter(e=>"penaltyId"!==e),a=Object.keys(t).filter(e=>n.includes(e));if(!a.length)return{error:vi};let o,s=[];return i.forEach(e=>{let i=!1;e.penalties=(e.penalties??[]).map(e=>(e.penaltyId===r&&(i=!0,a.forEach(r=>Object.assign(e,{[r]:t[r]})),o||(o=e)),e)),i&&s.push(e)}),o&&rn({topic:sl,payload:{tournamentId:e.tournamentId,participants:s}}),o?{...ce,penalty:o}:{error:Vr}}function QE(e,t,r){return!e&&t?t:e&&!t||"object"!=typeof e||"object"!=typeof t?e:L(Object.keys(e).concat(Object.keys(t))).reduce((i,n)=>{if(t[n])if(e[n])if(typeof e[n]!=typeof t[n])i[n]=t[n];else if(Array.isArray(e[n]))if(!0===r||Array.isArray(r)&&r.includes(n)){let r=L(e[n].map(e=>JSON.stringify(e)).concat(t[n].map(e=>JSON.stringify(e)))).map(e=>JSON.parse(e));i[n]=r}else i[n]=t[n];else"object"==typeof e[n]?i[n]=QE(e[n],t[n],r):i[n]=t[n];else i[n]=t[n];else i[n]=e[n];return i},{})}function XE({participants:e=[],tournamentRecord:t,arraysToMerge:r}){if(!t)return{error:Ie};t.participants||(t.participants=[]);let i=e.filter(nh(tc)).map(e=>({[e.participantId]:e})),n=Object.assign({},...i),a=[];t.participants=t.participants.map(e=>{if(n[e.participantId]){let t=QE(e,n[e.participantId],r);return a.push(t),t}return e});let o=t.participants.map(nh(tc))||[],s=e.filter(({participantId:e})=>!o.includes(e)),{topics:c}=cn();return s.length&&(t.participants=t.participants.concat(...s),c.includes(Yd)&&rn({topic:Yd,payload:{participants:s}})),a.length&&c.includes(sl)&&rn({topic:sl,payload:{tournamentId:t.tournamentId,participants:a}}),{modifiedParticipantsCount:a.length,newParticipantsCount:s.length,...ce}}function ZE(e){let t,{tournamentRecord:r,participantIds:i}=e,n=e.tournamentRecords??(r&&{[r.tournamentId]:r})??{};for(let a of Object.values(n)){let r=(Ag({tournamentRecord:a}).participants??[])?.map(dd).filter(e=>i.includes(e));r.length&&(t=eC({...e,penaltyId:e.penaltyId??t,tournamentRecord:a,participantIds:r}).penaltyId)}return t?{...ce,penaltyId:t}:{error:Sr}}function eC({refereeParticipantId:e,tournamentRecord:t,participantIds:r,penaltyCode:i,penaltyType:n,extensions:a,penaltyId:o,matchUpId:s,issuedAt:c,notes:u}){if(!t)return{error:Ie};if(!r)return{error:Ir};if(!n)return{error:Lr};let d=(t?.participants??[]).filter(e=>r.includes(e.participantId));if(!d.length)return{error:Sr};let l=(new Date).toISOString(),p=Object.assign(zE({penaltyId:o}),{refereeParticipantId:e,penaltyCode:i,penaltyType:n,matchUpId:s,createdAt:l,issuedAt:c,notes:u});return Array.isArray(a)&&a.forEach(e=>Uu({element:p,extension:e})),d.forEach(e=>{e.penalties??=[],e.penalties.push(p)}),rn({topic:sl,payload:{tournamentId:t.tournamentId,participants:d}}),{...ce,penaltyId:p.penaltyId}}function tC({participantRole:e=Qg,tournamentRecord:t,persons:r}){if(!t)return{error:Ie};if(!Array.isArray(r))return{error:gi};if(!Object.keys(iI).includes(e))return{error:pr};let i,n=new Set((t.participants||[]).map(({person:e})=>e?.personId).filter(Boolean)),a=[],o=r.filter(e=>e&&(!e.personId||!n.has(e.personId))).map(e=>(e.personId||(e.personId=za()),a.push(e.personId),e)),s=(e,t)=>Object.assign({},...Object.keys(e).filter(e=>!t.includes(e)).map(t=>({[t]:e[t]}))),c=0,u=AM({participants:o.map(t=>wn({extensions:t.participantExtensions,timeItems:t.participantTimeItems,participantType:Vl,participantRole:e,person:s(t,["participantExtensions","participantTimeItems","pairedPersons"])})),tournamentRecord:t});if(u.error)return u;i=u.addedCount||0;let d=[],l=Ag({participantFilters:{participantTypes:[Vl]},tournamentRecord:t})?.participants??[];if(e===Qg&&r.filter(({pairedPersons:e})=>e).forEach(({personId:e,pairedPersons:t})=>{Array.isArray(t)&&t.forEach(t=>{let r=[e,t.personId].map(e=>hu({tournamentParticipants:l,personId:e})).filter(Boolean);if(2===r.length){let e=r.map(dd);d.push(wn({extensions:t.participantExtensions,timeItems:t.timeItems,participantRole:Qg,individualParticipantIds:e,participantType:jl}))}})}),d.length){if(u=AM({participants:d,tournamentRecord:t}),u.error)return u;c=u.addedCount||0}let p=i+c;return{...ce,addedCount:p,newPersonIds:a}}var rC={};n(rC,{bulkUpdatePublishedEventIds:()=>rb,getAllEventData:()=>ib,getCourtInfo:()=>Mf,getDrawData:()=>Xv,getEventData:()=>Zv,getEventPublishStatus:()=>vg,getPublishState:()=>wg,getTournamentPublishStatus:()=>Sg,getVenueData:()=>Rf,mutate:()=>iC,publishEvent:()=>VM,publishEventSeeding:()=>nC,publishOrderOfPlay:()=>pC,publishParticipants:()=>dC,query:()=>tb,setEventDisplay:()=>mR,unPublishEvent:()=>fC,unPublishEventSeeding:()=>aC,unPublishOrderOfPlay:()=>cC,unPublishParticipants:()=>oC});var iC={};function nC({removePriorValues:e=!0,stageSeedingScaleNames:t,seedingScaleNames:r,tournamentRecord:i,status:n=Gm,drawIds:a=[],event:o}){if(!i)return{error:Ie};if(!o)return{error:ot};let s=vg({event:o,status:n}),c=(s?.seeding?.seedingScaleNames||r)&&{...s?.seeding?.seedingScaleNames,...r};return BM({statusObject:{seeding:wn({stageSeedingScaleNames:(s?.seeding?.stageSeedingScaleNames||t)&&{...s?.seeding?.stageSeedingScaleNames,...t},seedingScaleNames:c,published:!0,drawIds:a})},removePriorValues:e,status:n,event:o}),rn({topic:fl,payload:{tournamentId:i.tournamentId,eventId:o.eventId,drawIds:a}}),{...ce}}function aC({removePriorValues:e=!0,seedingScaleNames:t,tournamentRecord:r,status:i=Gm,drawIds:n,stages:a,event:o}){if(!r)return{error:Ie};if(!o)return{error:ot};let s=vg({event:o});if(s){let r=s.seeding;if(Array.isArray(a)&&r.stageSeedingScaleNames)for(let e of a)r.stageSeedingScaleNames[e]&&delete r.stageSeedingScaleNames[e];Array.isArray(t)&&r?.seedingScaleNames&&(r.seedingScaleNames=r.seedingScaleNames.filter(e=>!t.includes(e))),Array.isArray(n)&&r?.drawIds&&(r.drawIds=r.drawIds.filter(e=>!n.includes(e))),(!Object.values(r.stageSeedingScaleNames??{}).length&&!r.seedingScaleNames?.length&&!r.drawIds?.length||!a&&!t&&!n?.length)&&(delete r.stageSeedingScaleNames,delete r.seedingScaleNames,delete r.drawIds,r.published=!1),BM({statusObject:{seeding:r},removePriorValues:e,status:i,event:o})}return rn({topic:Ul,payload:{tournamentId:r.tournamentId,eventId:o.eventId}}),{...ce}}function oC(e){let t=Fl(e);if(!Object.keys(t).length)return{error:ge};for(let r of Object.values(t)){let t=sC({tournamentRecord:r,...e});if(t.error)return t}return{...ce}}function sC({removePriorValues:e=!0,tournamentRecord:t,status:r=Gm}){if(!t)return{error:Ie};let i=`${Vm}.${jm}`,{timeItem:n}=Ql({element:t,itemType:i}),a=n?.itemValue||{[r]:{}};return a[r]&&delete a[r].participants,lv({timeItem:{itemValue:a,itemType:i},element:t,removePriorValues:e}),rn({payload:{tournamentId:t.tournamentId},topic:"unPublishParticipants"}),{...ce}}function cC(e){let t=Fl(e);if(!Object.keys(t).length)return{error:ge};for(let r of Object.values(t)){let t=uC({tournamentRecord:r,...e});if(t.error)return t}return{...ce}}function uC({removePriorValues:e=!0,tournamentRecord:t,status:r=Gm}){if(!t)return{error:Ie};let i=`${Vm}.${jm}`,{timeItem:n}=Ql({element:t,itemType:i}),a=n?.itemValue||{[r]:{}};return a[r]&&delete a[r].orderOfPlay,lv({timeItem:{itemValue:a,itemType:i},element:t,removePriorValues:e}),rn({topic:Sl,payload:{tournamentId:t.tournamentId}}),{...ce}}function dC(e){let t=Fl(e);if(!Object.keys(t).length)return{error:ge};for(let r of Object.values(t)){let t=lC({tournamentRecord:r,...e});if(t.error)return t}return{...ce}}function lC({removePriorValues:e,tournamentRecord:t,status:r=Gm}){if(!t)return{error:Ie};let i=`${Vm}.${jm}`,{timeItem:n}=Ql({element:t,itemType:i}),a=n?.itemValue||{[r]:{}};return a[r].participants={published:!0},lv({timeItem:{itemValue:a,itemType:i},element:t,removePriorValues:e}),rn({payload:{tournamentId:t.tournamentId},topic:gl}),{...ce}}function pC(e){let t=Fl(e);if(!Object.keys(t).length)return{error:ge};for(let r of Object.values(t)){let t=mC({tournamentRecord:r,...e});if(t.error)return t}return{...ce}}function mC({scheduledDates:e=[],removePriorValues:t,tournamentRecord:r,status:i=Gm,eventIds:n=[]}){if(!r)return{error:Ie};let a=`${Vm}.${jm}`,{timeItem:o}=Ql({element:r,itemType:a}),s=o?.itemValue||{[i]:{}};return s[i].orderOfPlay={published:!0,scheduledDates:e,eventIds:n},lv({timeItem:{itemValue:s,itemType:a},element:r,removePriorValues:t}),rn({topic:hl,payload:{tournamentId:r.tournamentId,scheduledDates:e,eventIds:n}}),{...ce}}function fC({removePriorValues:e=!0,tournamentRecord:t,status:r=Gm,event:i}){if(!t)return{error:Ie};if(!i)return{error:ot};let n=`${Vm}.${jm}`,{timeItem:a}=Zl({itemType:n,event:i}),o=a?.itemValue||{[r]:{}};return delete o[r].structureIds,delete o[r].drawDetails,delete o[r].drawIds,fv({event:i,timeItem:{itemValue:o,itemType:n},removePriorValues:e}),BM({statusObject:{structureIds:void 0,drawIds:void 0,seeding:void 0},removePriorValues:e,status:r,event:i}),rn({topic:Il,payload:{tournamentId:t.tournamentId,eventId:i.eventId}}),{eventId:i.eventId,...ce}}n(iC,{publishEvent:()=>VM,publishEventSeeding:()=>nC,publishOrderOfPlay:()=>pC,publishParticipants:()=>dC,setEventDisplay:()=>mR,unPublishEvent:()=>fC,unPublishEventSeeding:()=>aC,unPublishOrderOfPlay:()=>cC,unPublishParticipants:()=>oC});var hC={};function gC({withCompetitiveProfiles:e,opponentParticipantId:t,withIndividualStats:r,teamParticipantId:i,tournamentRecord:n,withScaleValues:a,tallyPolicy:o,matchUps:s}){if(!n)return{error:Ie};if(s&&!Array.isArray(s))return{error:Ct};if(s=s??Xf({tournamentRecord:n,participantsProfile:a?{withScaleValues:a}:void 0}).matchUps,!s?.length)return{error:At};let c=[];t&&c.push(t),i&&c.push(i);let u=Ag({participantFilters:c.length?{participantIds:c}:{participantTypes:[Bl]},tournamentRecord:n}).participants??[];if(!u.every(({participantType:e})=>e===Bl))return{error:lr};c.length||c.push(...u.map(dd));let d=new Map,l=new Map,m=new Map,f=new Map,h=(e,t="")=>l.get(e)||l.set(e,{participantName:t,participantId:e,competitorIds:[],competitiveness:{},matchUpStatuses:{},tiebreaks:[0,0],matchUps:[0,0],points:[0,0],games:[0,0],sets:[0,0]})&&l.get(e);for(let p of u){let{participantId:e,individualParticipantIds:t}=p;f.set(e,t??[]),h(e,p.participantName)}if(i&&!f.get(i))return Pn({result:{error:Sr},context:{teamParticipantId:i}});if(t&&!f.get(t))return Pn({result:{error:Sr},context:{opponentParticipantId:t}});let g=[],I=e=>{let n=[[],[]];for(let t of e){let e=t.participant;if(e?.participantName){d.set(e.participantId,{participantName:e.participantName,ratings:e.ratings});let t=l.get(e.participantId);t&&(t.participantName=e.participantName)}}let a=({side:e,individualParticipantIds:t})=>e.participantId&&(!t?.length||t.includes(e.participantId))&&[e.participantId]||e.participant?.individualParticipantIds?.length&&(!t?.length||Q(t,e.participant?.individualParticipantIds).length===e.participant?.individualParticipantIds?.length)&&e.participant.individualParticipantIds;if(f.size){let o=(t,i)=>{for(let o of e){if(!o.participant)continue;let e=a({individualParticipantIds:i,side:o});if(e?.length){let i=o.sideNumber;if(!i)continue;let a=[t];r&&a.push(...e),n[i-1]=a;let s=l.get(t);for(let t of e.filter(Boolean))s&&!s.competitorIds.includes(t)&&s.competitorIds.push(t)}}};if(i)(!t||e.every(e=>e.participant&&(a({individualParticipantIds:f.get(i),side:e})||a({individualParticipantIds:f.get(t),side:e}))))&&o(i,f.get(i));else for(let[e,t]of f)o(e,t)}else if(r)for(let t of e){if(!t.participant)continue;let e=a({individualParticipantIds:[],side:t}),r=t.sideNumber;r&&(n[r-1]=e)}return n};for(let T of s){if(!v(T))return{error:Ct};let{matchUpStatus:t,matchUpFormat:r,matchUpType:i,winningSide:n,score:a,sides:s}=T;if(!s||!a||i===p||"BYE"===t)continue;let c=I(s);if(!c.filter(Boolean).length)continue;let u=e&&n&&mm({matchUp:T})?.competitiveness;g.push(T);let l=Yh({matchUpStatus:t,matchUpFormat:r,tallyPolicy:o,winningSide:n,score:a}),m=zh({matchUpStatus:t,matchUpFormat:r,tallyPolicy:o,winningSide:n,score:a}),{pointsTally:f,tiebreaksTally:U}=Kh({matchUpFormat:r,score:a});c.forEach((e,r)=>{for(let i of e){let e=d.get(i)?.participantName,a=h(i,e);if(a){let e=(e,t)=>t.forEach((t,r)=>a[e][r]+=t),i=r?[...U].reverse():U,o=r?[...f].reverse():f,s=r?[...m].reverse():m,c=r?[...l].reverse():l;if(e("tiebreaks",i),e("points",o),e("games",s),e("sets",c),n){let e=n-1===r?0:1;a.matchUps[e]+=1}if(u){let e=u.toLowerCase();a.competitiveness[e]||(a.competitiveness[e]=[0,0]),a.competitiveness[e][r]+=1}if(t){let e=t.toLowerCase();a.matchUpStatuses[e]||(a.matchUpStatuses[e]=0),a.matchUpStatuses[e]+=1}}}})}let U=["tiebreaks","matchUps","points","games","sets"],S=["competitive","routine","decisive"],y=new Map,w=(e,t)=>(e??0)+(t??0);for(let[p,v]of l.entries()){for(let e of U){let t=v[e].reduce(w);if(t){let r=v[e][0]/t,i=`${e}Ratio`,n=parseFloat(r.toFixed(2));v[i]=n,m.set(p,!0),y.has(i)||y.set(i,[]),y.get(i)?.push(n)}}for(let e of S){let t=v.competitiveness?.[e]?.reduce(w);if(t){let r=v.competitiveness[e][0]/t,i=`${e}Ratio`,n=parseFloat(r.toFixed(2));v[i]=n}}}if(!i){let e=(e,t)=>t-e;for(let t of l.values())for(let r of U){let i=`${r}Ratio`;if("number"==typeof t[i]){let n=y.get(i)?.sort(e).indexOf(t[i]);if("number"==typeof n&&n>=0){t[`${r}Rank`]=n+1}}}}let P={relevantMatchUps:g,...ce};return i?(P.teamStats=l.get(i),t&&(P.opponentStats=l.get(t))):P.participatingTeamsCount=m.size,P.allParticipantStats=[...l.values()],P}function IC({participant:e,eventType:t}){let r=e?.person?.personId,i=e?.person?.personOtherIds?.[0],n=e?.person?.tennisId,a=e?.ratings?.[t]?.find(({scaleName:e})=>"WTN"===e),o=a?.scaleValue,{wtnRating:s,confidence:c}=o||{};return{timeStamp:a?.scaleDate,personOtherId:i,confidence:c,wtnRating:s,personId:r,tennisId:n}}function UC({tournamentRecord:e}){if(!e)return{error:Ie};let t=e.tournamentId,{participantMap:r}=Ag({withScaleValues:!0,withEvents:!0,withSeeding:!0,tournamentRecord:e,withDraws:!0}),i=(Xf({matchUpFilters:{matchUpTypes:[c,d]},tournamentRecord:e}).matchUps??[]).flatMap(({sides:e,matchUpType:t})=>e?.flatMap(e=>t===d?e?.participant?.individualParticipantIds:e?.participant?.participantId||e.participantId).filter(Boolean)).filter(Boolean),n=[],a={},o={},s={},u=0,l=({id:e,entry:i,eventId:o,eventType:s})=>{let{qualifyingSeeding:c,mainSeeding:u,entryStatus:d,entryStage:l,drawId:p}=i;a[e]||(a[e]=[]);let{participant:m,events:f}=r?.[e]??{},h=IC({participant:m,eventType:s}),g=f?.[o]?.ranking;d===sS&&n.push(e),a[e].push({participantType:m?.participantType,participantId:e,tournamentId:t,eventType:s,eventId:o,drawId:p,entryStatus:d,entryStage:l,...h,ranking:g,mainSeeding:u,qualifyingSeeding:c})};for(let c of e.events??[]){let e={},n=t=>{e[t]||(e[t]={count:0}),e[t].count+=1},{drawDefinitions:a=[],eventType:d,eventId:p}=c,m=a.flatMap(e=>{let{drawId:t,entries:i}=e;u+=1;let a=(e.structures??[]).filter(({stage:e,stageSequence:t})=>e===Ho&&1===t||e===Yo).flatMap(({positionAssignments:e})=>e).filter(Boolean).map(({participantId:e})=>e);return i?.filter(({participantId:e})=>a.includes(e)).map(e=>{let{participantId:i,entryStatus:a,entryStage:o}=e;n(a);let s=r?.[i]?.draws?.[t]?.seedAssignments?.[Ho];return{qualifyingSeeding:r?.[i]?.draws?.[t]?.seedAssignments?.[Yo],participantId:i,mainSeeding:s,entryStatus:a,entryStage:o,drawId:t}})}),f=e=>{let t=e.participantId,n=r?.[t].participant.individualParticipantIds?.filter(e=>i.includes(e));return t&&{[t]:{individualParticipantIds:n}}};d===jo?(()=>{let e=Object.assign({},...m.map(f).filter(Boolean));m.forEach(t=>{e[t.participantId].individualParticipantIds.forEach(e=>{l({id:e,eventType:d,eventId:p,entry:t})})})})():m.forEach(e=>{l({id:e?.participantId,eventType:d,eventId:p,entry:e})});let h=Object.values(e).reduce((e,t)=>e+t.count,0);Object.keys(e).forEach(t=>{e[t].pct=e[t].count/h*100}),s[p]={tournamentId:t,eventId:p,entries:m,entryStatuses:e};let g=Object.assign({},...Bp.flatMap(t=>[{[t+"_count"]:e[t]?.count},{[t+"_pct"]:e[t]?.pct}]));o[p]={tournamentId:t,eventId:p,...g}}let p=Object.values(r??{}).filter(({participant:{participantType:e,participantRole:t}})=>e===Vl&&t===Qg),m=p.filter(({participant:e})=>!i.includes(e.participantId)).map(({participant:e})=>e.participantId),f={nonParticipatingEntriesCount:m.length,individualParticipantsCount:p.length,eventsCount:Object.values(s).length,nonParticipatingParticipantIds:m,drawDefinitionsCount:u,tournamentId:t};return{entryStatusReports:Object.values(o).flat(),participantEntryReports:Object.values(a).flat(),eventReports:Object.values(s).flat(),withDrawnParticipantIds:n,tournamentEntryReport:f}}function SC({eventType:e,matchUps:t,eventId:r,drawId:i}){let n={},a=t.filter(e=>r?e.eventId===r:e.drawId===i).reduce((e,t)=>((e=>{let t=e?.matchUpFormat;t&&(n[t]||(n[t]=0),n[t]+=1)})(t),(t.sides??[]).flatMap(e=>(e?.participant?.individualParticipants||[e?.participant]).filter(Boolean)).forEach(t=>e[t.participantId]=t),e),{}),o=Object.values(a),s=o.map(t=>IC({participant:t,eventType:e})).filter(({wtnRating:e})=>e),c=(o.length-s.length)/o.length*100,u=s.reduce((e,t)=>{let{wtnRating:r,confidence:i}=t;return e.totalWTN+=r,e.totalConfidence+=i,e},{totalWTN:0,totalConfidence:0}),d=s?.length?u.totalWTN/s.length:0,l=s?.length?u.totalConfidence/s.length:0,p=Object.values(n).reduce((e,t)=>e+(t||0),0);return{matchUpFormatCounts:n,matchUpsCount:p,avgConfidence:l,pctNoRating:c,avgWTN:d}}function vC(e){let{tournamentRecord:t,extensionProfiles:r,firstFlightOnly:i,firstStageSequenceOnly:n=!0}=e;if(!t)return{error:Se};let a=[],o={},s={},c=[],u=Object.assign({},...(r??[]).map(({name:e,label:r,accessor:i})=>{let n=Ru({element:t,name:e})?.extension?.value,a=i?rh({element:n,accessor:i})?.value:n;return{[r??e]:a}})),d=t?.tournamentId,l=Xf({participantsProfile:{withScaleValues:!0},tournamentRecord:t}).matchUps??[],p=e=>Ql({itemType:zd,itemSubTypes:[Kc],element:{timeItems:e}})?.timeItem?.itemValue?.scaleBasis,m=t?.events?.flatMap(({timeItems:e,drawDefinitions:t=[],extensions:r,eventType:c,eventName:m,eventId:f,category:h})=>{let g=r?.find(e=>e.name===Lu)?.value?.flights?.map(e=>({[e.drawId]:e.flightNumber})),I=g&&Object.assign({},...g),U=r?.find(e=>e.name===xu),S=e?.find(e=>e.itemType===xu),v=U?.value?.length??S?.itemValue??0,y=Object.values(I??{}),w=I&&Math.min(...y),P=p(e);return s[f]={seedingBasis:P?JSON.stringify(P):void 0,totalPositionManipulations:0,maxPositionManipulations:0,generatedDrawsCount:0,drawDeletionsCount:v,tournamentId:d,eventId:f},t.filter(e=>!i||!g||I[e.drawId]===w).flatMap(e=>{let{matchUpFormat:t,tieFormat:r,timeItems:i,extensions:g,structures:U,drawName:S,drawType:v,drawId:y}=e,{matchUpFormatCounts:w,matchUpsCount:T,avgConfidence:D,pctNoRating:b,avgWTN:M}=SC({eventType:c,matchUps:l,drawId:y}),R=p(i)??P,N=function({extensions:e}){return e?.find(({name:e})=>e===qu)?.value?.slice(1)}({extensions:g}),A=N?.length??0;return(({positionManipulations:e})=>{e?.forEach(e=>{let{structureId:t,name:r}=e,i=e.drawPositions??[e.drawPosition];o[t]??=[],o[t].push(`${r}: ${i.join("/")}`)})})({positionManipulations:N}),s[f].totalPositionManipulations+=A,s[f].generatedDrawsCount+=1,A>s[f].maxPositionManipulations&&(s[f].maxPositionManipulations=A),U?.filter(e=>(1===e.stageSequence||!n)&&[Yo,Ho,zo,Jo].includes(e.stage)).map(e=>{let i=[Ho,Jo].includes(e.stage)?function(e,t){return e.find(e=>e.structureId===t&&1===e.finishingRound&&e.winningSide)}(l,e.structureId):void 0;e.stage===Ho&&a.push({eventName:m,drawName:S,structureId:e.structureId});let n=function(e){if(e?.sides)return e.sides.find(t=>t.sideNumber===e.winningSide)}(i)?.participant,o=function(e){return e?.participantType===Bl?e.participantId:void 0}(n),s=function(e){return e?.participantType===jl?e.individualParticipants??[]:[]}(n),p=IC({participant:s?.[0]??n,eventType:c}),{personId:g,personOtherId:U,tennisId:P,confidence:A,wtnRating:E}=p||{},C=IC({participant:s?.[1],eventType:c}),{personId:O,personOtherId:k,tennisId:F,confidence:x,wtnRating:_}=C||{},{ageCategoryCode:L,categoryName:B,subType:V}=h??{},G=e.matchUpFormat??t,j=(w[G]??0)/T*100,{tieFormatName:$,tieFormatDesc:q}=KD(r),{tieFormatName:W,tieFormatDesc:H}=KD(e.tieFormat),Y=q===H,z=!Y&&W,K=e.tieFormat&&!Y&&H,J=N?.filter((e=>t=>t.structureId===e)(e.structureId))?.length??0;return{...u,tournamentId:d,eventId:f,structureId:e.structureId,drawId:y,eventType:c,category:V,categoryName:B,ageCategoryCode:L,flightNumber:I?.[y],drawType:v,stage:e.stage,seedingBasis:R?JSON.stringify(R):void 0,winningPersonId:g,winningPersonOtherId:U,winningPersonTennisId:P,winningPersonWTNrating:E,winningPersonWTNconfidence:A,winningPerson2Id:O,winningPerson2OtherId:k,winningPerson2TennisId:F,winningPerson2WTNrating:_,winningPerson2WTNconfidence:x,winningTeamId:o,positionManipulations:J,pctNoRating:b,matchUpFormat:G,pctInitialMatchUpFormat:j,matchUpsCount:T,drawTieFormatName:$,drawTieFormatDesc:q,tieFormatName:z,tieFormatDesc:K,avgConfidence:D,avgWTN:M}})})});return a.forEach(({eventName:e,drawName:t,structureId:r})=>{o[r]?.length&&c.push({eventName:e,drawName:t,actions:o[r]})}),{eventStructureReports:Object.values(s),structureReports:m,flightReports:c}}function yC({ignoreDisabled:e=!0,tournamentRecords:t,tournamentId:r,venueIds:i=[],dates:n=[]}){if(!Array.isArray(n))return{error:gi,dates:n};if(!Array.isArray(i))return{error:gi,venueIds:i};if(!(t&&Object.keys(t).filter(e=>!r||e===r)||[]).length)return{error:ge};if(!n.every(ua))return{error:Jt};let a=jv({tournamentRecords:t,ignoreDisabled:e,dates:n});if(a.error)return a;let o=a?.venues?.filter(({venueId:e})=>!i?.length||i.includes(e)),s=a.courts?.reduce((e,t)=>(t.dateAvailability?.forEach(t=>{let r=t.date;e.includes(r)||e.push(r)}),e),[]).filter(e=>!n.length||n.includes(e)),c={venueIds:o?.map(({venueId:e})=>e)},{matchUps:u}=Zf({afterRecoveryTimes:!0,tournamentRecords:t,matchUpFilters:c});return{venuesReport:o?.map(e=>function(e,t,r){let{venueId:i,courts:n,venueName:a}=t,o={};return e.forEach(e=>{let t=0,a=0,s=0;for(let r of n){let i=r.dateAvailability.find(t=>t.date===e),n=(i&&xR({courtDate:i}).timeSlots)?.reduce((e,t)=>{let{startTime:r,endTime:i}=t;return e+(Ua(i)-Ua(r))},0);n&&(s+=1),t+=n}let c=r.filter(({schedule:t})=>t.venueId===i&&Ca(e,t.scheduledDate));c.forEach(({schedule:e})=>{let t=va(e.scheduledTime),r=Ua(Na(t,e.averageMinutes))-Ua(t);a+=r});let u=t?(a/t*100).toFixed(2):"100";o[e]={scheduledMatchUpsCount:c.length,availableCourts:s,availableMinutes:t,scheduledMinutes:a,percentUtilization:u}}),{venueId:i,venueName:a,venueReport:o}}(s,e,u))}}n(hC,{getEntryStatusReports:()=>UC,getParticipantStats:()=>gC,getStructureReports:()=>vC,getVenuesReport:()=>yC});var wC={};n(wC,{addCourtGridBooking:()=>xC,addMatchUpCourtOrder:()=>FN,addMatchUpEndTime:()=>LN,addMatchUpOfficial:()=>xN,addMatchUpResumeTime:()=>VN,addMatchUpScheduleItems:()=>kN,addMatchUpScheduledDate:()=>NN,addMatchUpScheduledTime:()=>MN,addMatchUpStartTime:()=>_N,addMatchUpStopTime:()=>BN,addSchedulingProfileRound:()=>lE,allocateTeamMatchUpCourts:()=>AN,assignMatchUpCourt:()=>CN,assignMatchUpVenue:()=>EN,bulkRescheduleMatchUps:()=>EC,bulkScheduleMatchUps:()=>bA,bulkScheduleTournamentMatchUps:()=>DA,bulkUpdateCourtAssignments:()=>MC,calculateScheduleTimes:()=>TC,clearMatchUpSchedule:()=>kC,clearScheduledMatchUps:()=>RA,courtGridRows:()=>yb,findMatchUpFormatTiming:()=>sb,findVenue:()=>Pf,generateBookings:()=>UA,generateVirtualCourts:()=>LR,getMatchUpsToSchedule:()=>ob,getPersonRequests:()=>hb,getProfileRounds:()=>Sb,getScheduledRoundsDetails:()=>cb,getSchedulingProfile:()=>lb,getSchedulingProfileIssues:()=>fb,matchUpScheduleChange:()=>OC,modifyMatchUpFormatTiming:()=>YM,mutate:()=>PC,proAutoSchedule:()=>bC,proConflicts:()=>NC,publicFindCourt:()=>bf,query:()=>nb,removeCourtGridBooking:()=>_C,removeEventMatchUpFormatTiming:()=>QM,removeMatchUpCourtAssignment:()=>DC,reorderUpcomingMatchUps:()=>AC,scheduleMatchUps:()=>RC,scheduleProfileRounds:()=>AA,setMatchUpDailyLimits:()=>FC,setMatchUpHomeParticipantId:()=>DN,setSchedulingProfile:()=>pb,toggleParticipantCheckInState:()=>XR,validateSchedulingProfile:()=>db});var PC={};function TC({calculateStartTimeFromCourts:e=!0,defaultRecoveryMinutes:t=0,averageMatchUpMinutes:r=90,remainingScheduleTimes:i,clearScheduleDates:n,tournamentRecords:a,periodLength:o,scheduleDate:s,startTime:c,venueIds:u,endTime:d}){if("object"!=typeof a||!Object.keys(a).length)return{error:ge};o=o??BR({recoveryMinutes:t,averageMatchUpMinutes:r});let{courts:l,venues:p}=jv({dates:[s],ignoreDisabled:!0,tournamentRecords:a}),m=l?.filter(e=>!u||u.includes(e.venueId));c||(c=m?.reduce((e,t)=>{let r=t.dateAvailability?.find(e=>!e.date||Ca(s,e.date))?.startTime??t.startTime;return r&&(!e||Ua(r)<Ua(e))?r:e},void 0)),d||(d=m?.reduce((e,t)=>{let r=t.dateAvailability?.find(e=>!e.date||Ca(s,e.date))?.endTime??t.endTime;return r&&(!e||Ua(r)>Ua(e))?r:e},void 0));let f=Object.values(a),h=Object.assign({},...f.map(e=>(e.events??[]).map(t=>{let{scheduleTiming:r}=vp({tournamentRecord:e,event:t});return{[t.eventId]:{event:t,scheduleTiming:r}}})).flat()),g=jb({sortDateMatchUps:!1,tournamentRecords:a,matchUpFilters:{scheduledDate:s,venueIds:u}}),I=g?.dateMatchUps??[],U=g?.completedMatchUps??[],S=[];S.push(...I),S.push(...U);let v={averageTimes:[{minutes:{default:r}}],recoveryTimes:[{minutes:{default:t}}]},y=S?.map(({eventId:e,schedule:t,matchUpFormat:r})=>{let{event:i,scheduleTiming:n}=h[e],a=i?.eventType,s={...n,defaultTiming:v,matchUpFormat:r},{averageMinutes:c,recoveryMinutes:u}=df({eventType:a,timingDetails:s}),{courtId:d,venueId:l}=t,p=va(t.scheduledTime),m=Na(p,c);return{recoveryMinutes:u,averageMinutes:c,periodLength:o,startTime:p,endTime:m,courtId:d,venueId:l}}),w={calculateStartTimeFromCourts:e,remainingScheduleTimes:i,averageMatchUpMinutes:r,date:s,clearScheduleDates:n,periodLength:o,startTime:c,endTime:d,bookings:y,courts:m},{scheduleTimes:P}=jR(w);return{venueId:1===u?.length&&u[0]||1===p?.length&&p[0].venueId||void 0,scheduleTimes:P,dateScheduledMatchUpIds:S.map(ld)}}function DC(e){let t=$c(e,[{[zs]:!0}]);if(t.error)return t;let{removePriorValues:r,tournamentRecords:i,tournamentId:n,courtDayDate:a,matchUpId:o,courtId:s,drawId:c}=e,u=i[n];if(!u)return{error:Ie};let{drawDefinition:d,event:l}=ty({tournamentRecord:u,drawId:c});if(!d)return{error:ye};let m=zS({drawDefinition:d,event:l,matchUpId:o});if(m.error)return m;if(m?.matchUp?.matchUpType===p){let{itemValue:e}=pf({timeItems:m.matchUp.timeItems??[],itemType:Um}),t=s&&e.filter(e=>e.courtId!==s);return KR({duplicateValues:!1,removePriorValues:r,tournamentRecord:u,drawDefinition:d,matchUpId:o,timeItem:{itemType:Um,itemValue:t}})}return CN({tournamentRecord:u,drawDefinition:d,courtDayDate:a,courtId:"",matchUpId:o})}function bC({scheduleCompletedMatchUps:e,minCourtGridRows:t=10,tournamentRecords:r,scheduledDate:i,matchUps:n}){if(!Zp(n))return{error:gi};if(n.some(({hasContext:e})=>!e))return{info:"matchUps must have { inContext: true, nextMatchUps: true }",error:ni};let a=jb({courtCompletedMatchUps:!0,withCourtGridRows:!0,minCourtGridRows:t,tournamentRecords:r,matchUpFilters:{localPerspective:!0,scheduledDate:i}});if(a.error)return a;let{rows:o}=a,s=[],c=e=>[(e.sides||[]).map(e=>[e.participantId,e.participant?.individualParticipantIds]),(e.potentialParticipants||[]).flat().map(e=>[e.participantId,e.individualParticipantIds])].flat(1/0).filter(Boolean),u=o?.reduce((e,t)=>{let r=[],i=[];Object.values(t).forEach(e=>{if(v(e)&&(e.matchUpId&&(r.push(e.matchUpId),s.push(e)),e.sides)){let t=c(e);i.push(...t)}});let n=Object.values(t).filter(e=>v(e)&&!e.matchUpId&&!e.isBlocked);return e.concat({matchUpIds:r,availableCourts:n,rowId:t.rowId,participantIds:i})},[]);n.filter(({matchUpStatus:t})=>t&&"BYE"!==t&&(e||!kd.includes(t))).sort(eh);let d=sh({matchUps:n.concat(s),includeParticipantDependencies:!0,tournamentRecords:r}).matchUpDependencies,l=[],p=[];for(;n.length&&u.length;){let e=u.shift(),t=[];for(;n.length&&e.availableCourts.length;){let r=n.concat(t).map(e=>e.matchUpId),i=n.shift(),a=i?.matchUpId,o=a&&d[a].matchUpIds.concat(d[a].dependentMatchUpIds),s=a&&r.some(e=>d[a].matchUpIds.includes(e)),u=a&&p.some(e=>d[a].dependentMatchUpIds.includes(e)),m=e.matchUpIds.some(e=>o.includes(e)),f=c(i),h=e.participantIds.some(e=>f.includes(e));if(!i||m||s||h||u)i&&t.push(i);else{let t=e.availableCourts.shift();Object.assign(i.schedule,t.schedule),Object.assign(t,i),l.push(i),e.participantIds.push(...f),e.matchUpIds.push(a)}}n.push(...t),p.push(...e.matchUpIds)}return a=bA({tournamentRecords:r,matchUpDetails:l.map(({matchUpId:e,tournamentId:t,schedule:r,drawId:n})=>({tournamentId:t,matchUpId:e,drawId:n,schedule:{...r,scheduledDate:i}}))}),{...a,scheduled:l,notScheduled:n}}function MC(e){let{courtDayDate:t}=e,r=$c(e,[{courtAssignments:!0,[_c]:Oc,[xc]:$t},{[zs]:!0}]);if(r.error)return r;let i,n=e.courtAssignments.reduce((e,t)=>{let{tournamentId:r}=t;return e[r]||(e[r]=[]),e[r].push(t),e},{});return Object.keys(n).every(r=>{let a=e[zs][r];if(!a)return i={error:Ie},!1;let o=n[r].reduce((e,t)=>{let{drawId:r}=t;return e[r]||(e[r]=[]),e[r].push(t),e},{});Object.keys(o).every(e=>{let{drawDefinition:r}=Af({tournamentRecord:a,drawId:e});return r?(o[e].every(e=>{let{matchUpId:n,courtId:o}=e,s=CN({tournamentRecord:a,drawDefinition:r,courtDayDate:t,matchUpId:n,courtId:o});if(s.success)return s?.success;i={error:ui}}),!0):(i={error:ye},!1)})}),i||ce}function RC(e){let{tournamentRecords:t,allDateMatchUpIds:r=[],averageMatchUpMinutes:i=90,recoveryMinutes:n=0,recoveryMinutesMap:a,matchUpPotentialParticipantIds:o={},individualParticipantProfiles:s={},matchUpNotBeforeTimes:c={},matchUpDailyLimits:u={},checkPotentialRequestConflicts:d=!0,remainingScheduleTimes:l,clearScheduleDates:p,periodLength:m=30,scheduleDate:f,matchUpIds:h,venueIds:g,startTime:I,endTime:U,dryRun:S}=e,v=$c(e,[{[zs]:!0,[cc]:!0},{[kc]:ua,[xc]:Jt,[nc]:!0},{[kc]:e=>!e||!isNaN(e),[Nc]:!1,[xc]:gi,[Ac]:!1,[Ec]:!1}]);if(v.error)return v;let y=e.competitionMatchUps??Zf({nextMatchUps:!0,tournamentRecords:t}).matchUps??[],w=e.matchUpDependencies??sh({includeParticipantDependencies:!0,matchUps:y,tournamentRecords:t}).matchUpDependencies;y.forEach(e=>{e.schedule?.scheduledDate&&Ca(f,ya(e.schedule.scheduledDate))&&ab({matchUpPotentialParticipantIds:o,matchUpNotBeforeTimes:c,matchUp:e})});let P=h.map(e=>y.find(t=>t.matchUpId===e)).filter(Boolean),{venueId:T,scheduleTimes:D,dateScheduledMatchUpIds:b}=TC({tournamentRecords:t,remainingScheduleTimes:l,startTime:va(I),endTime:va(U),scheduleDate:ya(f),averageMatchUpMinutes:i,clearScheduleDates:p,periodLength:m,venueIds:g}),M={},R=[],N={},A={},E={};y.filter(({matchUpId:e})=>b?.includes(e)).forEach(e=>{gA({matchUpPotentialParticipantIds:o,individualParticipantProfiles:s,matchUp:e,value:1});let t=e.schedule?.scheduledTime;if(t){N[e.matchUpId]=t;let r=a?.[e.matchUpId];lA({recoveryMinutes:r||n,matchUpPotentialParticipantIds:o,individualParticipantProfiles:s,matchUpNotBeforeTimes:c,averageMatchUpMinutes:i,matchUpDependencies:w,scheduleTime:t,matchUp:e})}});let C=P.filter(e=>{let t=b?.includes(e.matchUpId),r=["BYE",Sd,Id,fd,Dd,Rd].includes(e?.matchUpStatus);return!t&&!e.winningSide&&!r}),{matchUpMap:O,overLimitMatchUpIds:k,participantIdsAtLimit:F}=C.reduce((e,t)=>{let{drawId:r,tournamentId:i,matchUpType:n}=t,{participantIdsAtLimit:a,relevantParticipantIds:d}=TA({individualParticipantProfiles:s,matchUpPotentialParticipantIds:o,matchUpDailyLimits:u,matchUp:t});return a?.length?(e.overLimitMatchUpIds.push(t.matchUpId),e.participantIdsAtLimit.push(...a),e):(d.forEach(e=>{dA({individualParticipantProfiles:s,participantId:e});let t=s[e].counters;t[n]?t[n]+=1:t[n]=1,t[Qm]?t[Qm]+=1:t[Qm]=1}),e.matchUpMap[i]||(e.matchUpMap[i]={}),e.matchUpMap[i][r]?e.matchUpMap[i][r].push(t):e.matchUpMap[i][r]=[t],ab({matchUpPotentialParticipantIds:o,matchUpNotBeforeTimes:c,matchUp:t}),e)},{matchUpMap:{},overLimitMatchUpIds:[],participantIdsAtLimit:[]});C=C.filter(({matchUpId:e})=>!k.includes(e));let x=0,_=D?.length??0,{personRequests:L}=hb({tournamentRecords:t,requestType:mA});for(;D?.length&&C.length&&x<=_;){x++;let{scheduleTime:e}=D.shift(),t=C.find(t=>{let{matchUpId:u}=t,{dependenciesScheduled:l,remainingDependencies:p}=uA({matchUpScheduleTimes:N,matchUpDependencies:w,allDateMatchUpIds:r,matchUp:t});if(!l)return E[u]||(E[u]=[]),E[u].push({scheduleTime:e,remainingDependencies:p}),!1;let{enoughTime:m}=wA({individualParticipantProfiles:s,matchUpNotBeforeTimes:c,matchUpDependencies:w,scheduleTime:e,matchUp:t});if(!m)return A[u]||(A[u]=[]),A[u].push({scheduleTime:e}),!1;let{conflicts:h}=hA({potentials:d,averageMatchUpMinutes:i,requestConflicts:M,personRequests:L,scheduleTime:e,scheduleDate:f,matchUp:t});if(h?.length)return!1;let g=a?.[t.matchUpId];return lA({recoveryMinutes:g||n,matchUpPotentialParticipantIds:o,individualParticipantProfiles:s,matchUpNotBeforeTimes:c,averageMatchUpMinutes:i,matchUpDependencies:w,scheduleTime:e,matchUp:t}),N[t.matchUpId]=e,!0});C=C.filter(({matchUpId:e})=>e!==t?.matchUpId),t||R.push(e)}C.forEach(e=>{gA({individualParticipantProfiles:s,matchUpPotentialParticipantIds:o,value:-1,matchUp:e})});let B=[];Object.keys(O).forEach(e=>{let r=t[e];r&&Object.keys(O[e]).forEach(i=>{let{drawDefinition:n}=ty({tournamentRecord:r,drawId:i});n&&O[e][i].forEach(({matchUpId:e})=>{let i=N[e];if(i){let a=i.split(":").map(Ea).join(":"),o=`${ya(f)}T${a}`;S?B.push(e):(MN({drawDefinition:n,matchUpId:e,scheduledTime:o}).success&&B.push(e),T&&EN({tournamentRecords:t,tournamentRecord:r,drawDefinition:n,matchUpId:e,venueId:T}))}})})});let V=cd(C);return{...ce,requestConflicts:Object.values(M),remainingScheduleTimes:D?.map(({scheduleTime:e})=>e),individualParticipantProfiles:s,matchUpNotBeforeTimes:c,participantIdsAtLimit:F,skippedScheduleTimes:R,overLimitMatchUpIds:k,scheduledMatchUpIds:B,noTimeMatchUpIds:V,recoveryTimeDeferred:A,dependencyDeferred:E}}function NC({tournamentRecords:e,matchUps:t}){if(!Zp(t))return{error:At};if(t.some(({matchUpId:e,hasContext:t})=>e&&!t))return{info:"matchUps must have { inContext: true, nextMatchUps: true }",error:ni};let r=K(1,Math.max(...t.map(({schedule:e})=>e?.courtOrder||1).map(e=>I(e)))+1).map(e=>t.filter(t=>I(t.schedule?.courtOrder)===e)),i={},n={},a={};r.flat().filter(Boolean).sort(eh).forEach(({schedule:e})=>delete e[sf]);let o=sh({includeParticipantDependencies:!0,tournamentRecords:e,drawIds:L(t.map(({drawId:e})=>e))}).matchUpDependencies,s=r.map((e,t)=>e.reduce((e,r)=>{if(!r.matchUpId)return e;let{matchUpId:s,winnerMatchUpId:c,loserMatchUpId:u,schedule:d,sides:l,potentialParticipants:p}=r,m=d?.courtId;i[s]=t,n[m]=[],e.matchUpIds.push(s),a[s]=r;let f=o[s].matchUpIds;f.length&&e.sourceMatchUpIds.push(...f);let h=l?.flatMap(e=>[e.participant?.individualParticipantIds,e.participantId]).flat().filter(Boolean)??[],g=p?.flat().flatMap(({individualParticipantIds:e,participantId:t})=>[e,t]).flat().filter(Boolean)||[];return e.participantIds.push(...g,...h),c&&e.targetMatchUpIds.push(c),u&&e.targetMatchUpIds.push(u),e},{sourceMatchUpIds:[],targetMatchUpIds:[],participantIds:[],matchUpIds:[]})),c=s.map(()=>[]),u=(e,t,r)=>{t.participantIds.filter(t=>e.participantIds.includes(t)).forEach(i=>{let n=t.matchUpIds.concat(e.matchUpIds).filter(e=>o[e].participantIds.includes(i));n.forEach(e=>{((e,t,r)=>{r[e]||(r[e]={}),r[e][nf]||(r[e][nf]=t.filter(t=>t!==e))})(e,n,r)})})},d=e=>{let t={},r=j(e.participantIds),i=new Set(Object.keys(r).filter(e=>r[e]>1)),n=e.matchUpIds.filter(e=>o[e].participantIds.some(e=>i.has(e)));return n.forEach(e=>{((e,t,r)=>{r[e]||(r[e]={}),r[e][rf]||(r[e][rf]=t.filter(t=>t!==e))})(e,n,t)}),t},l=(e,t,r,o)=>{if(!a[e].schedule[sf]){a[e].schedule[sf]=t,a[e].schedule[tf]=o,c[i[e]].push({matchUpId:e,issueType:r,issueIds:o,issue:t});let s=a[e].schedule.courtId;n[s]||(n[s]=[]),n[s].push({matchUpId:e,issue:t,issueType:r,issueIds:o})}};return s.forEach((e,t)=>{let i=t?s[t-1]:void 0,n=s.slice(t+1),c=d(e),p=(e=>{let t={},r={};return e.forEach(e=>{let{matchUpId:t,schedule:i}=e;if(!t||!i?.courtId||!i?.scheduledDate)return;let n=`${i.courtId}|${i.scheduledDate}`;r[n]||(r[n]=[]),r[n].push(t)}),Object.values(r).forEach(e=>{e.length>1&&e.forEach(r=>{t[r]=e.filter(e=>e!==r)})}),t})(r[t].filter(t=>e.matchUpIds.includes(t.matchUpId)));i&&u(i,e,c),e.matchUpIds.forEach(t=>{let r=o[t].matchUpIds;for(let e of n){let i=e.matchUpIds.filter(e=>r.includes(e));i?.length&&(i.forEach(e=>l(e,af,Zm,[t])),l(t,af,Zm,i))}if(p[t]&&l(t,rf,ef,p[t]),c[t]?.[rf]&&l(t,rf,Xm,c[t][rf]),e.sourceMatchUpIds.includes(t)){let r=e.matchUpIds.filter(e=>o[e].matchUpIds.includes(t));l(t,rf,Zm,r),e.matchUpIds.filter(e=>o[e].matchUpIds.includes(t)).forEach(e=>l(e,rf,Zm,[t]))}let s=i?.matchUpIds?.filter(e=>((e,t)=>o[e].sources.reduce((e,r,i)=>r.includes(t)&&i+1||e,0))(t,e)>1);if(s?.length&&(l(t,of,Zm,s),s.forEach(e=>l(e,of,Zm,[t]))),c[t]?.[nf]&&l(t,nf,Xm,c[t][nf]),i?.targetMatchUpIds?.includes(t)){let e=a[t].schedule.courtId,n=r.filter(e=>i.matchUpIds.includes(e));n.some(t=>a[t].schedule.courtId===e)||(n.forEach(e=>l(e,nf,Zm,[t])),l(t,nf,Zm,n))}})}),{courtIssues:n,rowIssues:c}}function AC(e){let t="reorderUpcomingMatchUps",{tournamentRecords:r}=e;if("object"!=typeof r||!Object.keys(r).length)return Pn({result:{error:ge},stack:t});let{matchUpsContextIds:i,firstToLast:n}=e;if(!i)return Pn({result:{error:$t},stack:t});let a=i?.length;if(!a)return{...ce};let o=0;return i.forEach((e,t)=>{let{tournamentId:s,drawId:c,matchUpId:u}=e,d=t+(n?-1:1);d<0&&(d=a-1),d===a&&(d=0);let l=function({tournamentId:e,scheduledTime:t,matchUpId:i,drawId:n}){let a=r[e],{drawDefinition:o}=ty({tournamentRecord:a,drawId:n});return o?MN({drawDefinition:o,scheduledTime:t,matchUpId:i}):{error:Pe}}({tournamentId:s,scheduledTime:i[d].schedule.scheduledTime,matchUpId:u,drawId:c});if(!l.success)return l;o++}),o===a?ce:Pn({result:{error:si},stack:t})}function EC(e){let{scheduleChange:t,matchUpIds:r,dryRun:i}=e;if(!r||!Array.isArray(r))return{error:Rt};if("object"!=typeof t)return{error:gi};let n=Fl(e),a=[],o=[];for(let c of Object.values(n)){let e=CC({tournamentRecord:c,scheduleChange:t,matchUpIds:r,dryRun:i});if(e.error)return e;Array.isArray(e.notRescheduled)&&o.push(...e.notRescheduled);let n=cd(e.notRescheduled),s=[];e.rescheduled?.forEach(e=>{let{matchUpId:t}=e;n.includes(t)&&s.push(t),a.push(e)}),s.length&&(o=e?.notRescheduled?.filter(({matchUpId:e})=>!s.includes(e))||[])}let s=!(!a.length||o.length);return{...ce,rescheduled:a,notRescheduled:o,allRescheduled:s}}function CC({tournamentRecord:e,scheduleChange:t,matchUpIds:r,dryRun:i}){if(!e)return{error:Ie};if(!r||!Array.isArray(r))return{error:Rt};if("object"!=typeof t)return{error:gi};let n=[],a=[],{minutesChange:o,daysChange:s}=t;if(!o&&!s)return{...ce};if(o&&isNaN(o))return{error:gi};if(s&&isNaN(s))return{error:gi};let{matchUps:c}=Xf({matchUpFilters:{matchUpIds:r},tournamentRecord:e}),u=c?.filter(e=>xb({schedule:e.schedule})).filter(e=>(({matchUpStatus:e})=>!kd.includes(e))({matchUpStatus:e.matchUpStatus}));if(!u?.length)return{...ce};let{tournamentInfo:d}=zv({tournamentRecord:e}),{startDate:l,endDate:p}=d,m=u?.reduce((e,t)=>{let{matchUpId:r,drawId:i}=t;return e[i]?e[i].push(r):e[i]=[r],e},{});for(let U of Object.keys(m)){let t=ty({tournamentRecord:e,drawId:U});if(t.error)return t;let c=t.drawDefinition,d=m[U].filter(e=>r.includes(e));for(let e of d)if(e&&c){let t,r,d,m=u.find(t=>t.matchUpId===e)?.schedule,{scheduledTime:f,scheduledDate:h}=m;if(!t&&s&&h){d=wa(ya(h),s),t=new Date(d)<new Date(l)||new Date(d)>new Date(p)}if(o&&f){let e=ya(f),i=Ua(va(f))+o;if(t=i<0||i>1440,!t){let t=Na(f,o),i=e&&d||h===e&&e;r=i?`${i}T${t}`:t}}if(t)a.push(e);else{if(!i){if(r){let t=MN({scheduledTime:r,drawDefinition:c,matchUpId:e});if(t.error)return t}if(d){let t=NN({scheduledDate:d,drawDefinition:c,matchUpId:e});if(t.error)return t}}(r||d)&&n.push(e)}}}let f=Xf({matchUpFilters:{matchUpIds:r},tournamentRecord:e}).matchUps??[],h=f.filter(({matchUpId:e})=>n.includes(e)),g=f.filter(({matchUpId:e})=>a.includes(e)),I=h.length&&!g.length;return{...ce,rescheduled:h,notRescheduled:g,allRescheduled:I}}function OC(e){let t="matchUpScheduleChange",{tournamentRecords:r}=e;if("object"!=typeof r||!Object.keys(r).length)return{error:ge};let{sourceMatchUpContextIds:i,targetMatchUpContextIds:n,sourceCourtId:a,targetCourtId:o,courtDayDate:s}=e||{},{drawId:c,matchUpId:u,tournamentId:d}=i||{},{drawId:l,matchUpId:p,tournamentId:f}=n||{};if(!u&&!p)return Pn({result:{error:$t},stack:t});let{matchUps:h}=Zf({matchUpFilters:{matchUpIds:[u,p].filter(Boolean),drawIds:[c,l].filter(Boolean)},tournamentRecords:e.tournamentRecords}),g=h?.find(({matchUpId:e})=>e===u),I=h?.find(({matchUpId:e})=>e===p),U=0;if(o&&u&&!p){let e=S({tournamentId:d,matchUpId:u,courtId:o,matchUp:g,drawId:c,tournamentRecords:r,sourceCourtId:a,courtDayDate:s});if(e?.success&&U++,e.error)return Pn({result:e,stack:t})}else{if(!(a&&o&&u&&p))return{error:$t};{let e=S({tournamentId:d,matchUpId:u,courtId:o,matchUp:g,drawId:c,tournamentRecords:r,sourceCourtId:a,courtDayDate:s});if(e.success&&U++,e.error)return Pn({result:e,stack:t,info:"source"});let i=S({tournamentId:f,sourceCourtId:o,matchUpId:p,matchUp:I,courtId:a,drawId:l,tournamentRecords:r,courtDayDate:s});if(i.success&&U++,i.error)return Pn({result:i,stack:t,info:"target"})}}return U?ce:Pn({result:{error:ci},stack:t});function S(e){let{tournamentRecords:t,tournamentId:r,matchUp:i,drawId:n}=e,a=t[r],{drawDefinition:o}=ty({tournamentRecord:a,drawId:n});return i.matchUpType===m?function({removePriorValues:e,tournamentRecords:t,tournamentRecord:r,drawDefinition:i,sourceCourtId:n,courtDayDate:a,matchUpId:o,matchUp:s,courtId:c}){let u=[c].concat(s.schedule.allocatedCourts.map(({courtId:e})=>e).filter(e=>e!==n));return AN({removePriorValues:e,tournamentRecords:t,tournamentRecord:r,drawDefinition:i,courtDayDate:a,matchUpId:o,courtIds:u})}({...e,tournamentRecord:a,drawDefinition:o}):CN({...e,tournamentRecord:a,drawDefinition:o})}}function kC({scheduleAttributes:e=[Um,Sm,Im,ym,Tm,Dm,Rm,Mm,bm],tournamentRecord:t,drawDefinition:r,matchUpId:i}){let n=r?th({matchUpFilters:{matchUpIds:[i]},inContext:!1,drawDefinition:r}).matchUps?.[0]:Xf({matchUpFilters:{matchUpIds:[i]},tournamentRecord:t,inContext:!1}).matchUps?.[0];if(!n)return{error:Nt};let a=(n.timeItems??[]).filter(t=>t?.itemType&&!e.includes(t?.itemType));return n.timeItems=a,Dl({tournamentId:t.tournamentId,context:"clearMatchUpSchedule",drawDefinition:r,matchUp:n}),{...ce}}function FC(e){let{tournamentRecord:t,tournamentId:r,dailyLimits:i}=e,n=e.tournamentRecords||t&&{[t.tournamentId]:t}||{};if("object"!=typeof n||!Object.keys(n).length)return{error:ge};if("object"!=typeof i)return{error:mi};let a=Object.keys(n).filter(e=>!r||r===e);if(r&&!a.includes(r))return{error:gi};for(let o of a){let e=n[o],t=Uu({extension:{name:Hu,value:{dailyLimits:i}},element:e});if(t.error)return t}return{...ce}}function xC(e){let{tournamentRecord:t,disableNotice:r,scheduledDate:i,bookingType:n,courtOrder:a,rowCount:o=1,courtId:s,notes:c}=e;if(!t)return Pn({result:{error:gi},info:"tournamentRecord is required"});if(!s)return{error:jr};if(!i)return Pn({result:{error:gi},info:"scheduledDate is required"});if(!n)return Pn({result:{error:gi},info:"bookingType is required"});if(null==a)return Pn({result:{error:gi},info:"courtOrder is required"});if(!Number.isInteger(a)||a<1)return Pn({result:{error:gi},info:"courtOrder must be a positive integer"});if(!Number.isInteger(o)||o<1)return Pn({result:{error:gi},info:"rowCount must be a positive integer"});let{court:u,venue:d}=Df({tournamentRecord:t,courtId:s});if(!u)return{error:jr};if(!vb({court:u,date:i})){u.dateAvailability||(u.dateAvailability=[]);let e={date:i,bookings:[]};u.dateAvailability.push(e)}let l=vb({court:u,date:i});if(l.bookings)for(let m of l.bookings)if("number"==typeof m.courtOrder){let e=m.courtOrder,t=e+(m.rowCount||1)-1;if(a<=t&&a+o-1>=e)return Pn({result:{error:Wr},info:`Booking conflicts with existing booking at rows ${e}-${t}`})}let p={courtOrder:a,rowCount:o,bookingType:n,notes:c,createdAt:(new Date).toISOString()};return l.bookings||(l.bookings=[]),l.bookings.push(p),!r&&d&&rn({payload:{venue:d,tournamentId:t.tournamentId},topic:ll,key:d.venueId}),{...ce,booking:p}}function _C(e){let{tournamentRecord:t,disableNotice:r,scheduledDate:i,courtOrder:n,courtId:a}=e;if(!t)return Pn({result:{error:gi},info:"tournamentRecord is required"});if(!a)return{error:jr};if(!i)return Pn({result:{error:gi},info:"scheduledDate is required"});if(null==n)return Pn({result:{error:gi},info:"courtOrder is required"});let{court:o,venue:s}=Df({tournamentRecord:t,courtId:a});if(!o)return{error:jr};let c=vb({court:o,date:i});if(!c?.bookings)return Pn({result:{error:qr},info:"No bookings found for this date"});let u=c.bookings.findIndex(e=>e.courtOrder===n);if(-1===u)return Pn({result:{error:qr},info:`No booking found at row ${n}`});let d=c.bookings.splice(u,1)[0];return!r&&s&&rn({payload:{venue:s,tournamentId:t.tournamentId},topic:ll,key:s.venueId}),{...ce,booking:d}}n(PC,{addCourtGridBooking:()=>xC,addMatchUpCourtOrder:()=>FN,addMatchUpEndTime:()=>LN,addMatchUpOfficial:()=>xN,addMatchUpResumeTime:()=>VN,addMatchUpScheduleItems:()=>kN,addMatchUpScheduledDate:()=>NN,addMatchUpScheduledTime:()=>MN,addMatchUpStartTime:()=>_N,addMatchUpStopTime:()=>BN,addSchedulingProfileRound:()=>lE,allocateTeamMatchUpCourts:()=>AN,assignMatchUpCourt:()=>CN,assignMatchUpVenue:()=>EN,bulkRescheduleMatchUps:()=>EC,bulkScheduleMatchUps:()=>bA,bulkScheduleTournamentMatchUps:()=>DA,bulkUpdateCourtAssignments:()=>MC,calculateScheduleTimes:()=>TC,clearMatchUpSchedule:()=>kC,clearScheduledMatchUps:()=>RA,findMatchUpFormatTiming:()=>sb,generateBookings:()=>UA,generateVirtualCourts:()=>LR,matchUpScheduleChange:()=>OC,modifyMatchUpFormatTiming:()=>YM,proAutoSchedule:()=>bC,proConflicts:()=>NC,removeCourtGridBooking:()=>_C,removeEventMatchUpFormatTiming:()=>QM,removeMatchUpCourtAssignment:()=>DC,reorderUpcomingMatchUps:()=>AC,scheduleMatchUps:()=>RC,scheduleProfileRounds:()=>AA,setMatchUpDailyLimits:()=>FC,setMatchUpHomeParticipantId:()=>DN,setSchedulingProfile:()=>pb,toggleParticipantCheckInState:()=>XR,validateSchedulingProfile:()=>db});var LC={};n(LC,{addCollectionDefinition:()=>tO,addCollectionGroup:()=>eO,aggregateTieFormats:()=>aO,compareTieFormats:()=>JD,getTieFormat:()=>eb,modifyCollectionDefinition:()=>WC,modifyTieFormat:()=>nO,mutate:()=>BC,orderCollectionDefinitions:()=>KC,query:()=>zD,removeCollectionDefinition:()=>ZC,removeCollectionGroup:()=>YC,tieFormatGenderValidityCheck:()=>Fn,validateCollectionDefinition:()=>La});var BC={};function VC({drawDefinition:e,structureId:t,matchUpId:r,structure:i,matchUp:n,eventId:a,event:o}){let s,c="getTieFormat";if(t=i?.structureId??t,((r=n?.matchUpId??r)||t)&&!e)return{error:ye};if(a&&o)s=Hp(o);else if(r){if(e&&(!n||!i)){let t=zS({drawDefinition:e,matchUpId:r});if(t.error)return t;if(t.matchUp?.matchUpType!==p)return Pn({result:{error:Ct},stack:c});i||(i=t.structure),n||(n=t.matchUp)}s=Yp({item:n,drawDefinition:e,structure:i,event:o})||Yp({item:i,drawDefinition:e,structure:i,event:o})||Hp(e)||Hp(o)}else if(e&&t){if(!i){let r=Vd({drawDefinition:e,structureId:t});if(r.error)return r;i=r?.structure}s=Yp({item:i,drawDefinition:e,structure:i,event:o})||Hp(e)||Hp(o)}else s=Hp(e)||Hp(o);return s?{...ce,structure:i,tieFormat:s,matchUp:n}:Pn({result:{error:bt},stack:c})}function GC({matchUp:e,updateInProgressMatchUps:t}){return!e.winningSide&&![kd].includes(e.matchUpStatus)&&(t||e.matchUpStatus!==wd&&!ch(e))}function jC({from:e,to:t}){let r=Object.keys(e),i=Q(r,Object.keys(t)).length===r.length,n=r.filter(r=>e[r]!==t[r]).map(r=>({countChange:t[r]-e[r],collectionId:r})),a=r.every(r=>e[r]===t[r]);return{equivalent:i&&a,matchUpsCountChanges:n}}function $C({check:e,matchUp:t}){let r="",i=[];return{changesArePossible:e.matchUpsCountChanges.every(({collectionId:e,countChange:n})=>{let a=t.tieMatchUps.filter(t=>t.collectionId===e&&t.matchUpStatus===Md).map(nh("matchUpId")),o=a.length+n>=0||n>0;return!o&&n<0&&(r="Insufficient TO_BE_PLAYED matchUps"),i.push({toBePlayedTieMatchUpIds:a,collectionId:e,countChange:n}),o}),changes:i,cannotChangeReaon:r}}function qC({appliedPolicies:e,drawDefinition:t,auditData:r}){if(!e?.audit?.[Qu])return;let{extension:i}=Ru({name:Qu,element:t});Uu({element:t,extension:{value:Array.isArray(i?.value)?i?.value.concat(r):[r],name:Qu}})}function WC({updateInProgressMatchUps:e=!1,tournamentRecord:t,collectionOrder:r,collectionName:i,tieFormatName:n,drawDefinition:a,matchUpFormat:o,matchUpCount:s,collectionId:c,matchUpType:u,structureId:d,matchUpId:l,category:p,eventId:f,gender:h,event:g,collectionValueProfiles:I,collectionValue:U,matchUpValue:S,scoreValue:v,setValue:y}){let w="modifyCollectionDefinition";if(o&&!ta({matchUpFormat:o}))return Pn({result:{error:gi},context:{matchUpFormat:o},stack:w});if(i&&"string"!=typeof i)return Pn({result:{error:gi},context:{collectionName:i},stack:w});if(h&&!Object.values(Rn).includes(h))return Pn({result:{error:gi},context:{gender:h},stack:w});if(p&&"object"!=typeof p)return Pn({result:{error:gi},context:{category:p},stack:w});let P={collectionValueProfiles:I,collectionValue:U,matchUpValue:S,scoreValue:v,setValue:y};if(!(Object.values(P).filter(Boolean).length||r||i||o||s||u))return Pn({result:{error:$t},stack:w});if(Object.values(P).filter(Boolean).length>1)return Pn({info:"Only one value assignment allowed per collectionDefinition",result:{error:gi},stack:w});let T=VC({drawDefinition:a,structureId:d,matchUpId:l,eventId:f,event:g});if(T.error)return Pn({result:T,stack:w});let{matchUp:D,structure:b,tieFormat:M}=T,R=nv(M),N=M?.collectionDefinitions.find(e=>e.collectionId===c),A=R?.collectionDefinitions.find(e=>e.collectionId===c);if(!N)return Pn({info:"source collectionDefinition",result:{error:wi},context:{collectionId:c},stack:w});let E=U??S??v??y;if(I?.length){let e=le({matchUpCount:s??N?.matchUpCount??0,collectionValueProfiles:I});if(e.errors)return Pn({result:{error:gi},info:e.errors,stack:w})}else if(E&&!F(E))return Pn({result:{error:gi},info:"value is not an integer",context:{value:E},stack:w});let C=I&&(!N.collectionValueProfiles||(k=N.collectionValueProfiles,x=I,!(Q(Object.keys(k),Object.keys(x)).length===Object.keys(k).length&&Q(Object.values(k),Object.values(x)).length===Object.values(k).length))),O=[];var k,x;if((F(U)&&N.collectionValue!==U||F(S)&&N.matchUpValue!==S||F(v)&&N.scoreValue!==v||F(y)&&N.setValue!==y||C)&&(A.collectionValueProfiles=void 0,A.collectionValue=void 0,A.matchUpValue=void 0,A.scoreValue=void 0,A.setValue=void 0,Object.assign(A,P),O.push({collectionId:c,...wn(P)})),(F(v)||F(y))&&A.collectionGroupNumber){let e=A.collectionGroupNumber;R.collectionDefinitions=R.collectionDefinitions.map(t=>{let{collectionGroupNumber:r,...i}=t;return r===e?i:t}),R.collectionGroups=R.collectionGroups.filter(({groupNumber:t})=>t!==e),O.push({collectionId:c,change:"collectionGroupNumber removed"})}let{aggregateValue:_,valueGoal:L}=zb(R),B=wn({aggregateValue:_,valueGoal:L});if((B.aggregateValue!==M?.winCriteria.aggregateValue||B.valueGoal!==M?.winCriteria.valueGoal)&&(R.winCriteria=B,O.push({collectionId:c,winCriteria:B})),F(r)&&N.collectionOrder!==r&&(A.collectionOrder=r,O.push({collectionId:c,collectionOrder:r})),i&&N.collectionName!==i&&(A.collectionName=i,O.push({collectionId:c,collectionName:i})),o&&N.matchUpFormat!==o&&(A.matchUpFormat=o,O.push({collectionId:c,matchUpFormat:o})),F(s)&&N.matchUpCount!==s&&(A.matchUpCount=s,O.push({collectionId:c,matchUpCount:s})),u&&N.matchUpType!==u)return Pn({result:{error:Pi},context:{matchUpType:u},stack:w});p&&N.category!==p&&(A.category=p,O.push({collectionId:c,category:p})),h&&N.gender!==h&&(A.gender=h,O.push({collectionId:c,gender:h}));let V=wn(R);if(T=Ba({tieFormat:V}),T.error)return Pn({result:T,stack:w});if(!O.length)return Pn({result:{...ce,modifications:O}});if(M?.tieFormatName!==n?(V.tieFormatName=n,O.push({tieFormatName:n})):O.length&&(delete V.tieFormatName,O.push("tieFormatName removed: modifications without new tieFormatName")),T=function({updateInProgressMatchUps:e,tournamentRecord:t,drawDefinition:r,structure:i,tieFormat:n,eventId:a,matchUp:o,event:s,uuids:c}){let u="updateTieFormat",d=t?.tournamentId,l=0,p=0,f=0,h=0,g=n?.collectionDefinitions.reduce((e,t)=>(e[t.collectionId]=(e[t.collectionId]||0)+t.matchUpCount,e),{}),I=({tieFormat:e})=>{let t=e?.collectionDefinitions.reduce((e,t)=>(e[t.collectionId]=(e[t.collectionId]||0)+t.matchUpCount,e),{});return jC({from:t,to:g}).equivalent},U=VC({drawDefinition:r})?.tieFormat,S=VC({event:s})?.tieFormat;if(s&&a){for(let e of s.drawDefinitions??[])v({drawDefinition:e});s.tieFormat=nv(n),h+=1}else if(o){if(!o.tieMatchUps)return Pn({result:{error:Ct},stack:u});let t=j(o.tieMatchUps?.map(({collectionId:e})=>e)),i=jC({to:g,from:t}),{changes:a,changesArePossible:l,cannotChangeReaon:m}=$C({matchUp:o,check:i});if(i.equivalent){if(!GC({matchUp:o,updateInProgressMatchUps:e}))return Pn({result:{error:nr},info:"matchUp is IN_PROGRESS or COMPLETE",stack:u});o.tieFormat=nv(n),h+=1}else{if(!l)return Pn({context:{collectionMap:g,matchUpMap:t},result:{error:wt},info:m||"specified changes not possible",stack:u});w({tieFormat:n,matchUp:o,changes:a,uuids:c})}p+=1,Dl({eventId:s?.eventId,context:u,drawDefinition:r,tournamentId:d,matchUp:o})}else if(i){let e=y({inheritedTieFormat:U??S,structure:i})?.modifiedMatchUpsCount;e&&(p+=e,l+=1,h+=1);let t=!i.tieFormat||JD({ancestor:i.tieFormat,descendant:n}).different;t&&(i.tieFormat=nv(n),l+=1,h+=1),(e||t)&&r&&Ml({structureIds:[i.structureId],eventId:s?.eventId,drawDefinition:r})}else{if(!r)return{error:ye};v({drawDefinition:r}),r.tieFormat=nv(n),h+=1}return{modifiedStructuresCount:l,modifiedMatchUpsCount:p,addedMatchUpsCount:f,modifiedCount:h,...ce,tieFormat:n};function v({drawDefinition:e}){let t=e.structures||[],r=[];for(let i of t){if(i.tieFormat)continue;let e=y({inheritedTieFormat:S,structure:i})?.modifiedMatchUpsCount;if(e){l+=1,p+=e;let t=i.structureId;r.push(t)}}return Ml({structureIds:r,eventId:s?.eventId,drawDefinition:e}),r.length}function y({inheritedTieFormat:i,structure:o}){let s=0,d=Bf({matchUpFilters:{matchUpTypes:[m]},structure:o})?.matchUps||[];for(let l of d){let o=GC({matchUp:l,updateInProgressMatchUps:e}),d=!1,p=jC({from:j(l.tieMatchUps?.map(({collectionId:e})=>e)),to:g});if(p.equivalent)l.tieFormat&&I(l)&&o&&(l.tieFormat=nv(n),d=!0);else{let{changes:e,changesArePossible:t}=$C({matchUp:l,check:p});if(t&&!l.tieFormat)w({changes:e,matchUp:l,tieFormat:n,uuids:c});else{if(!i)return Pn({result:{error:bt},stack:u});(!l.tieFormat||JD({ancestor:i,descendant:l.tieFormat}).different)&&(l.tieFormat=i,d=!0)}}d&&(s+=1,Dl({tournamentId:t?.tournamentId,drawDefinition:r,context:u,eventId:a,matchUp:l}))}return{modifiedMatchUpsCount:s}}function w({uuids:e,matchUp:t,tieFormat:i,changes:n}){t.tieFormat=nv(i);let o=[],s=[];return n.forEach(r=>{if(r.countChange>0){let n=Math.max(0,...t.tieMatchUps.filter(e=>e.collectionId===r.collectionId).map(nh("collectionPosition"))),a=i.collectionDefinitions.find(e=>e.collectionId===r.collectionId),o=wS({matchUpsLimit:r.countChange,collectionPositionOffset:n,collectionDefinition:a,matchUp:t,uuids:e});s.push(...Wa(o,!1,!0)),f+=s.length,t.tieMatchUps.push(...o)}else{let e=r.toBePlayedTieMatchUpIds.slice(0,Math.abs(r.countChange));console.log("remove",e.length),o.push(...e),t.tieMatchUps=t.tieMatchUps.filter(({matchUpId:t})=>!e.includes(t))}}),s.length&&Pl({matchUps:s,drawDefinition:r,tournamentId:d,eventId:a}),o.length&&Tl({matchUpIds:o,action:"updateTieFormat",drawDefinition:r,tournamentId:d,eventId:a}),{matchUpIdsRemoved:o,matchUpsAdded:s}}}({tieFormat:V,updateInProgressMatchUps:e,tournamentRecord:t,drawDefinition:a,structure:b,eventId:f,matchUp:D,event:g}),!T.error){let{appliedPolicies:e}=up({tournamentRecord:t});qC({appliedPolicies:e,drawDefinition:a,auditData:wn({collectionDefinition:A,drawId:a?.drawId,action:w,structureId:d,matchUpId:l,eventId:f})})}return Pn({result:{...T,modifications:O},stack:w})}function HC({updateInProgressMatchUps:e,originalValueGoal:t,tournamentRecord:r,wasAggregateValue:i,tieFormatName:n,drawDefinition:a,structureId:o,structure:s,tieFormat:c,matchUpId:u,matchUp:d,eventId:l,event:p}){let{aggregateValue:f,valueGoal:h}=zb(c);c.winCriteria=wn({aggregateValue:f,valueGoal:h}),(t&&t!==h||f&&!i)&&(n?c.tieFormatName=n:delete c.tieFormatName);let{targetMatchUps:g}=function({updateInProgressMatchUps:e,drawDefinition:t,structureId:r,structure:i,matchUpId:n,matchUp:a}){let o=[];return n&&a?o=[a]:r&&i?o=Bf({matchUpFilters:{matchUpTypes:[m]},structure:i})?.matchUps??[]:t&&(o=th({matchUpFilters:{matchUpTypes:[m]},drawDefinition:t})?.matchUps??[]),{targetMatchUps:o.filter(t=>!t.winningSide&&t.matchUpStatus!==Id&&(e||t.matchUpStatus!==wd&&!ch(t)))}}({updateInProgressMatchUps:e,drawDefinition:a,structureId:o,structure:s,matchUpId:u,matchUp:d});!function({updateInProgressMatchUps:e,tournamentRecord:t,drawDefinition:r,targetMatchUps:i,tieFormat:n,event:a}){for(let o of i){let i,s=!!o.tieFormat;if(s&&(o.tieFormat=nv(n)),e){let e=up({tournamentRecord:t,drawDefinition:r,event:a}).appliedPolicies,n=sv({matchUpId:o.matchUpId,exitWhenNoValues:!0,tournamentRecord:t,appliedPolicies:e,drawDefinition:r,event:a});if(n.error)return n;i=n.score}s&&!i&&Dl({tournamentId:t?.tournamentId,context:"updateTargetTeamMatchUps",eventId:a?.eventId,matchUp:o,drawDefinition:r})}}({updateInProgressMatchUps:e,tournamentRecord:r,targetMatchUps:g,drawDefinition:a,tieFormat:c,event:p});let I=wn(c),U=Ba({tieFormat:I});if(U.error)return U;if(l&&p)p.tieFormat=I;else if(u&&d)d.tieFormat=c;else if(s)s.tieFormat=I;else if(a)a.tieFormat=I;else if(!d||!a)return{error:ye};return Ml({drawDefinition:a,eventId:p?.eventId}),{...ce}}function YC({updateInProgressMatchUps:e=!0,collectionGroupNumber:t,tournamentRecord:r,drawDefinition:i,tieFormatName:n,structureId:a,matchUpId:o,matchUp:s,eventId:c,event:u}){if(!t)return{error:$t};if(isNaN(t))return{error:gi};let d="removeCollectionGroup",l=s?void 0:VC({drawDefinition:i,structureId:a,matchUpId:o,eventId:c,event:u});if(l?.error)return Pn({result:l,stack:d});let p=l?.structure;s=s??l?.matchUp;let m=l?.tieFormat,f=m?.winCriteria.valueGoal,h=m?.winCriteria.aggregateValue,g=nv(m);if(l=Ba({tieFormat:g}),l.error)return Pn({result:l,stack:d});let I=[];if(g.collectionDefinitions=g.collectionDefinitions.map(e=>{let{collectionGroupNumber:r,...i}=e;return r!==t?e:(I.push(e.collectionId),i)}),g.collectionGroups=g.collectionGroups.filter(({groupNumber:e})=>e!==t),l=HC({updateInProgressMatchUps:e,originalValueGoal:f,wasAggregateValue:h,tournamentRecord:r,drawDefinition:i,tieFormatName:n,structureId:a,structure:p,tieFormat:g,matchUpId:o,matchUp:s,eventId:c,event:u}),!l.error){let{appliedPolicies:e}=up({tournamentRecord:r});qC({appliedPolicies:e,drawDefinition:i,auditData:wn({drawId:i?.drawId,collectionGroupNumber:t,action:d,structureId:a,matchUpId:o,eventId:c})})}return Pn({result:{...l,modifiedCollectionIds:I},stack:d})}function zC({tieFormat:e,orderMap:t}){let r=nv(e);return r.collectionDefinitions?.forEach(e=>{let r=t[e.collectionId];r&&(e.collectionOrder=r)}),r.collectionDefinitions?.sort((e,t)=>G(e.collectionOrder)-G(t.collectionOrder)),r}function KC({tournamentRecord:e,drawDefinition:t,structureId:r,matchUpId:i,orderMap:n,eventId:a,matchUp:o,event:s}){if("object"!=typeof n||!Object.values(n).every(e=>F(e)))return Pn({result:{error:gi},context:{orderMap:n}});let c=r?Vd({drawDefinition:t,structureId:r}):void 0;if(c?.error)return c;let u=c?.structure;if(a&&s?.tieFormat)JC({tournamentRecord:e,event:s,orderMap:n});else if(i){let r=t&&zS({drawDefinition:t,matchUpId:i});if(r?.error)return r;if(!(o=r.matchUp))return{error:Et};let a=eb({tournamentRecord:e,matchUpId:i,structure:u,drawDefinition:t,event:s})?.tieFormat;o.tieFormat=zC({tieFormat:a,orderMap:n}),Dl({tournamentId:e?.tournamentId,eventId:s?.eventId,drawDefinition:t,matchUp:o})}else if(r)if(u?.tieFormat)u.tieFormat=zC({tieFormat:u.tieFormat,orderMap:n}),XC({eventId:s?.eventId,tournamentRecord:e,drawDefinition:t,structure:u,orderMap:n}),Ml({drawDefinition:t,structureIds:[u.structureId]});else if(t.tieFormat)QC({structureIds:[r],tournamentRecord:e,drawDefinition:t,orderMap:n,event:s});else{if(!s?.tieFormat)return{error:wi};JC({structureIds:[r],tournamentRecord:e,orderMap:n,event:s})}else{if(!t?.tieFormat)return{error:wi};QC({tournamentRecord:e,drawDefinition:t,orderMap:n,event:s})}return{...ce}}function JC({tournamentRecord:e,structureIds:t,orderMap:r,event:i}){let n=zC({tieFormat:i.tieFormat,orderMap:r});t?.length||(i.tieFormat=n);for(let a of i.drawDefinitions??[])QC({tournamentRecord:e,drawDefinition:a,structureIds:t,orderMap:r,event:i})}function QC({tournamentRecord:e,drawDefinition:t,structureIds:r,orderMap:i,event:n}){let a=zC({tieFormat:t.tieFormat??n?.tieFormat,orderMap:i});r?.length||(t.tieFormat=a);let o=[];for(let s of t.structures??[])r?.length&&!r.includes(s.structureId)||((s.tieFormat||r?.includes(s.structureId))&&(s.tieFormat=zC({tieFormat:s.tieFormat??t.tieFormat??n?.tieFormat,orderMap:i})),XC({eventId:n?.eventId,tournamentRecord:e,drawDefinition:t,structure:s,orderMap:i}),o.push(s.structureId));Ml({drawDefinition:t,structureIds:o})}function XC({tournamentRecord:e,drawDefinition:t,structure:r,orderMap:i,eventId:n}){let a=Bf({matchUpFilters:{matchUpTypes:[m]},structure:r})?.matchUps;for(let o of a)o.tieFormat&&(o.tieFormat=zC({tieFormat:o.tieFormat,orderMap:i}),Dl({tournamentId:e?.tournamentId,drawDefinition:t,eventId:n,matchUp:o}))}function ZC({updateInProgressMatchUps:e=!0,tieFormatComparison:t,tournamentRecord:r,drawDefinition:i,tieFormatName:n,collectionId:a,structureId:o,matchUpId:s,eventId:c,matchUp:u,event:d}){let l="removeCollectionDefinition",p=u?void 0:VC({drawDefinition:i,structureId:o,matchUpId:s,eventId:c,event:d});if(p?.error)return Pn({result:p,stack:l});let f=p?.structure;u=u??p?.matchUp;let h=p?.tieFormat,g=nv(h);if(p=Ba({tieFormat:g}),p.error)return Pn({result:p,stack:l});let I=g?.collectionDefinitions?.find(e=>e.collectionId===a);if(!I)return Pn({result:{error:wi,collectionId:a}});g.collectionDefinitions=g.collectionDefinitions.filter(e=>e.collectionId!==a),I.collectionGroupNumber&&(g.collectionDefinitions=g.collectionDefinitions.map(e=>{let{collectionGroupNumber:t,...r}=e;return r}),g.collectionGroups=g.collectionGroups.filter(({groupNumber:e})=>e!==I.collectionGroupNumber));let{aggregateValue:U,valueGoal:S}=zb(g);g.winCriteria=wn({aggregateValue:U,valueGoal:S});let v=h?.winCriteria.valueGoal,y=h?.winCriteria.aggregateValue;(v&&v!==S||U&&!y)&&(n?g.tieFormatName=n:delete g.tieFormatName);let w=[];s&&u?w=[u]:o&&f?w=Bf({matchUpFilters:{matchUpTypes:[m]},structure:f})?.matchUps??[]:i?w=th({matchUpFilters:{matchUpTypes:[m]},drawDefinition:i})?.matchUps??[]:d&&(w=Qf({matchUpFilters:{matchUpTypes:[m]},drawDefinition:i})?.matchUps??[]);let P=(w||[]).filter(r=>{let i=r.tieMatchUps?.filter(e=>e.collectionId===a)?.some(ch),n=!(!t||!r.tieFormat)&&JD({descendant:r.tieFormat,ancestor:g})?.different;return e&&!i||!r.winningSide&&r.matchUpStatus!==Id&&(e||r.matchUpStatus!==wd&&!ch(r)&&!n)});if(!P.length)return{error:ci};let{appliedPolicies:T}=up({tournamentRecord:r});if(s&&u&&e){let e=u.tieMatchUps?.filter(e=>e.collectionId===a);for(let t of e??[]){let e=GN({matchUpId:t.matchUpId,tieMatchUpId:u?.matchUpId,winningSide:void 0,removeScore:!0,tournamentRecord:r,appliedPolicies:T,drawDefinition:i,event:d});if(e.error||(e=zS({drawDefinition:i,matchUpId:s}),e.error))return e;u=e?.matchUp}}let D=[];for(let m of P){for(let e of m?.sides??[])e.lineUp=(e.lineUp??[]).map(e=>({participantId:e.participantId,collectionAssignments:(e?.collectionAssignments??[]).filter(e=>e.collectionId!==a)}));if(m.tieMatchUps=(m.tieMatchUps??[]).filter(e=>{let t=e.collectionId===a;return t&&D.push(e.matchUpId),!t}),m.tieFormat&&(m.tieFormat=nv(g)),e){let e=sv({matchUpId:m.matchUpId,exitWhenNoValues:!0,tournamentRecord:r,appliedPolicies:T,drawDefinition:i,event:d});if(e.error)return e}Dl({tournamentId:r?.tournamentId,eventId:d?.eventId,drawDefinition:i,context:l,matchUp:m})}D.length&&Tl({tournamentId:r?.tournamentId,matchUpIds:D,eventId:d?.eventId,drawDefinition:i});let b=wn(g);if(p=Ba({tieFormat:b}),p.error)return Pn({result:p,stack:l});if(c&&d)d.tieFormat=b;else if(s&&u)u.tieFormat=b;else if(f)f.tieFormat=b;else if(i)i.tieFormat=b;else if(!u||!i)return{error:ye};return Ml({drawDefinition:i,eventId:d?.eventId}),qC({appliedPolicies:T,drawDefinition:i,auditData:wn({drawId:i?.drawId,action:l,collectionId:a,structureId:o,matchUpId:s,eventId:c})}),{tieFormat:b,deletedMatchUpIds:D,targetMatchUps:P,...ce}}function eO({updateInProgressMatchUps:e=!0,tournamentRecord:t,groupDefinition:r,drawDefinition:i,collectionIds:n,tieFormatName:a,structureId:o,matchUpId:s,matchUp:c,eventId:u,event:d}){let l="addCollectionGroup";if(!Array.isArray(n))return Pn({result:{error:$t},stack:l});let p=c?void 0:VC({drawDefinition:i,structureId:o,matchUpId:s,eventId:u,event:d});if(p?.error)return Pn({result:p,stack:l});let m=p?.structure;c=c||p?.matchUp;let f=p?.tieFormat,h=f?.winCriteria.valueGoal,g=nv(f);if(p=Ba({tieFormat:g}),p.error)return Pn({result:p,stack:l});for(let U of g.collectionDefinitions){let{collectionId:e,collectionGroupNumber:t}=U;if(t&&n.includes(e))return Pn({info:"collectionIds cannot be part of other collectionGroups",result:{error:gi},stack:l})}let I=(g.collectionGroups||[]).reduce((e,t)=>t.groupNumber>e?t.groupNumber:e,0)+1;return r.groupNumber=I,g.collectionDefinitions=g.collectionDefinitions.map(e=>n.includes(e.collectionId)?{...e,collectionGroupNumber:I}:e),g.collectionGroups=[...g.collecitonGroups||[],r],HC({updateInProgressMatchUps:e,originalValueGoal:h,tournamentRecord:t,drawDefinition:i,tieFormatName:a,structureId:o,structure:m,tieFormat:g,matchUpId:s,matchUp:c,eventId:u,event:d})}function tO({updateInProgressMatchUps:e=!0,collectionDefinition:t,referenceCategory:r,tournamentRecord:i,policyDefinitions:n,enforceCategory:a,referenceGender:o,drawDefinition:s,tieFormatName:c,enforceGender:u,structureId:d,matchUpId:l,matchUp:p,eventId:m,uuids:f,event:h}){let g="addCollectionDefinition",I=up({tournamentRecord:i,drawDefinition:s,event:h}).appliedPolicies??{},U=n?.[iu]??I?.[iu];a=a??U?.participants?.enforceCategory;let S=!1!==(u??U?.participants?.enforceGender),v=!(!(r??h?.category)||!1===a),y=!(!(o??h?.gender)||!S),w=La({referenceCategory:r??h?.category,collectionDefinition:t,referenceGender:o,checkCategory:v,checkGender:y,event:h});if(w.error)return Pn({result:w,stack:g});let P=p?.tieFormat?void 0:VC({drawDefinition:s,structureId:d,matchUpId:l,eventId:m,event:h});if(P?.error)return Pn({result:{error:P.error},stack:g});let T=P?.structure;p=p??P?.matchUp;let D=p?.tieFormat??P?.tieFormat,b=nv(D);if(P=Ba({tieFormat:b}),P?.error)return Pn({result:{error:P.error},stack:g});if(t.collectionId){if(b.collectionDefinitions.map(({collectionId:e})=>e).includes(t.collectionId))return Pn({context:{collectionId:t.collectionId},result:{error:Ii}})}else t.collectionId=za();b.collectionDefinitions.push(t),b.collectionDefinitions.sort((e,t)=>(e.collectionOrder||0)-(t.collectionOrder||0)).forEach((e,t)=>e.collectionOrder=t+1);let{aggregateValue:M,valueGoal:R}=zb(b);b.winCriteria=wn({aggregateValue:M,valueGoal:R});let N=D?.winCriteria.valueGoal,A=D?.winCriteria.aggregateValue;(N&&N!==R||M&&!A)&&(c?b.tieFormatName=c:delete b.tieFormatName);let E=[],C=[],O=[],k=wn(b);if(P=Ba({tieFormat:k}),P?.error)return Pn({result:{error:P.error},stack:g});if(m&&h){h.tieFormat=k;for(let r of h.drawDefinitions??[])if(!r.tieFormat)for(let i of r.structures??[]){if(i.tieFormat)continue;let r=rO({updateInProgressMatchUps:e,collectionDefinition:t,structure:i,uuids:f});C.push(...r.newMatchUps),O.push(...r.targetMatchUps),E.push(i.structureId)}iO({modifiedMatchUps:O,eventId:h?.eventId,modifiedStructureIds:E,tournamentRecord:i,drawDefinition:s,addedMatchUps:C,stack:g})}else if(d&&T){T.tieFormat=k;let r=rO({updateInProgressMatchUps:e,collectionDefinition:t,structure:T,uuids:f});C.push(...r.newMatchUps),O=r.targetMatchUps,iO({modifiedMatchUps:O,eventId:h?.eventId,modifiedStructureIds:E,tournamentRecord:i,drawDefinition:s,addedMatchUps:C,stack:g})}else if(l&&p){if(!GC({matchUp:p,updateInProgressMatchUps:e}))return Pn({result:{error:nr},stack:g});p.tieFormat=k;let r=wS({collectionDefinition:t,matchUp:p,uuids:f});Array.isArray(p.tieMatchUps)||(p.tieMatchUps=[]),p.tieMatchUps.push(...r),C.push(...r),iO({modifiedMatchUps:[p],eventId:h?.eventId,modifiedStructureIds:E,tournamentRecord:i,drawDefinition:s,addedMatchUps:C,stack:g})}else{if(!s)return{error:ye};s.tieFormat=k;for(let r of s.structures??[]){let i=rO({updateInProgressMatchUps:e,collectionDefinition:t,structure:r,uuids:f});E.push(r.structureId),C.push(...i.newMatchUps),O.push(...i.targetMatchUps)}iO({modifiedMatchUps:O,eventId:h?.eventId,tournamentRecord:i,drawDefinition:s,addedMatchUps:C,stack:g})}return qC({appliedPolicies:I,drawDefinition:s,auditData:wn({drawId:s?.drawId,collectionDefinition:t,action:g,structureId:d,matchUpId:l,eventId:m})}),{tieFormat:k,targetMatchUps:O,addedMatchUps:C,...ce}}function rO({updateInProgressMatchUps:e,collectionDefinition:t,structure:r,uuids:i}){let n=[],a=(Bf({matchUpFilters:{matchUpTypes:[m]},structure:r})?.matchUps).filter(t=>GC({matchUp:t,updateInProgressMatchUps:e})&&!t.tieFormat);for(let o of a){let e=wS({collectionDefinition:t,matchUp:o,uuids:i});Array.isArray(o.tieMatchUps)||(o.tieMatchUps=[]),o.tieMatchUps.push(...e),n.push(...e)}return{newMatchUps:n,targetMatchUps:a}}function iO({modifiedStructureIds:e,tournamentRecord:t,modifiedMatchUps:r,drawDefinition:i,addedMatchUps:n,eventId:a,stack:o}){Pl({tournamentId:t?.tournamentId,matchUps:n,drawDefinition:i,eventId:a}),r?.forEach(e=>{Dl({tournamentId:t?.tournamentId,drawDefinition:i,context:o,matchUp:e,eventId:a})}),Ml({structureIds:e,drawDefinition:i,eventId:a})}function nO({updateInProgressMatchUps:e=!1,tieFormatComparison:t,modifiedTieFormat:r,tournamentRecord:i,considerations:n,drawDefinition:a,structureId:o,matchUpId:s,eventId:c,uuids:u,event:d}){let l="modifyTieFormat";if(!Ba({tieFormat:r}).valid)return Pn({result:{error:wt},info:"falied validation",stack:l});let p=VC({drawDefinition:a,structureId:o,matchUpId:s,eventId:c,event:d});if(p.error)return Pn({result:p,stack:l});let{matchUp:m,tieFormat:f}=p,h=nv(f),g=JD({descendant:r,ancestor:h,considerations:n});if(g.invalid)return Pn({context:{invalid:g.invalid},result:{error:wt},stack:l});if(!g?.different)return Pn({result:{...ce},info:"Nothing to do",stack:l});let I,U=h.collectionDefinitions.map(({collectionId:e})=>e),S=r.collectionDefinitions.map(({collectionId:e})=>e),v=U.filter(e=>!S.includes(e)),y=r.collectionDefinitions.filter(({collectionId:e})=>!U.includes(e)),w=y.map(nh("collectionId")),P=[],T=r.tieFormatName;for(let D of r.collectionDefinitions){if(w.includes(D.collectionId))continue;let t=WC({updateInProgressMatchUps:e,...D,tournamentRecord:i,tieFormatName:T,drawDefinition:a,structureId:o,matchUpId:s,eventId:c,event:d});if(t.modifications&&P.push(...t.modifications),t.error)return Pn({result:t,stack:l});t.tieFormat&&(I=t.tieFormat)}for(let D of y){let t=tO({updateInProgressMatchUps:e,collectionDefinition:D,tournamentRecord:i,drawDefinition:a,tieFormatName:T,structureId:o,matchUpId:s,matchUp:m,eventId:c,uuids:u,event:d});if(t.error)return Pn({result:t,stack:l});t.tieFormat&&(I=t.tieFormat)}for(let D of v){let r=ZC({updateInProgressMatchUps:e,tieFormatComparison:t,tournamentRecord:i,drawDefinition:a,tieFormatName:T,collectionId:D,structureId:o,matchUpId:s,eventId:c,matchUp:m,event:d});if(r.error)return Pn({result:r,stack:l});r.tieFormat&&(I=r.tieFormat)}return f?.tieFormatName!==T?(I.tieFormatName=T,P.push({tieFormatName:T})):(P.length||w.length||v.length)&&(delete I.tieFormatName,P.push("tieFormatName removed: modifications without new tieFormatName")),I.collectionDefinitions=I.collectionDefinitions.sort((e,t)=>G(e.collectionOrder)-G(t.collectionOrder)).map((e,t)=>({...e,collectionOrder:t+1})),{processedTieFormat:nv(I),modifications:P,...ce}}function aO({tournamentRecord:e}){if(!e)return{error:Ie};let t=0;for(let r of e.events??[]){let i=r.tieFormats??[],n=e=>{if(!e.tieFormat)return;let r;for(let t of i)JD({descendant:e.tieFormat,ancestor:t}).different||(r=t.tieFormatId);if(r)e.tieFormatId=r,delete e.tieFormat;else{let r=Wa(e.tieFormat,void 0,!0);r.tieFormatId||(r.tieFormatId=za()),e.tieFormatId=r.tieFormatId,delete e.tieFormat,i.push(r),t+=1}},a=r.eventType;n({tieFormat:r.tieFormat,eventType:a});for(let e of r.drawDefinitions??[]){n({tieFormat:e.tieFormat,eventType:a});for(let t of e.structures??[])n({tieFormat:t.tieFormat,eventType:a})}let o=(t,i)=>{let n=c.matchUps?.find(e=>e.matchUpId===t);n&&(n.tieFormatId=i,delete n.tieFormat,Dl({tournamentId:e?.tournamentId,eventId:r.eventId,matchUp:n}))},s=e=>{let r=Wa(e.tieFormat,void 0,!0);r.tieFormatId||(r.tieFormatId=za()),i.push(r),t+=1,o(e.matchUpId,r.tieFormatId)},c=Qf({matchUpFilters:{matchUpTypes:[p]},event:r}),u=c.matchUps??[];for(let e of u){let t;for(let r of i)e.tieFormat&&JD({descendant:e.tieFormat,ancestor:r}).different||(t=r.tieFormatId);t?o(e.matchUpId,t):s(e)}i.length&&(r.tieFormats=i)}return{...ce,addedCount:t}}n(BC,{addCollectionDefinition:()=>tO,addCollectionGroup:()=>eO,aggregateTieFormats:()=>aO,modifyCollectionDefinition:()=>WC,modifyTieFormat:()=>nO,orderCollectionDefinitions:()=>KC,removeCollectionDefinition:()=>ZC,removeCollectionGroup:()=>YC});var oO={};n(oO,{addDrawDefinitionExtension:()=>vu,addEventExtension:()=>yu,addEventTimeItem:()=>fv,addExtension:()=>Uu,addNotes:()=>KS,addOnlineResource:()=>fO,addParticipantExtension:()=>wu,addParticipantTimeItem:()=>pv,addTimeItem:()=>lv,addTournamentExtension:()=>Su,addTournamentTimeItem:()=>mv,analyzeDraws:()=>Tv,analyzeTournament:()=>$D,copyTournamentRecord:()=>cO,createTournamentRecord:()=>EA,generate:()=>sO,getAggregateTeamResults:()=>GD,getAllowedDrawTypes:()=>xD,getAllowedMatchUpFormats:()=>FD,getAppliedPolicies:()=>up,getCompetitionDateRange:()=>BD,getCompetitionPenalties:()=>LD,getPolicyDefinitions:()=>dp,getTournamentInfo:()=>zv,getTournamentPenalties:()=>_D,getTournamentPersons:()=>VD,getTournamentPoints:()=>YD,getTournamentStructures:()=>oU,getTournamentTimeItem:()=>ep,hydrateTournamentRecord:()=>dO,mutate:()=>uO,query:()=>kD,removeDrawDefinitionExtension:()=>Tu,removeEventExtension:()=>Du,removeExtension:()=>gu,removeNotes:()=>JS,removeOnlineResource:()=>pO,removeParticipantExtension:()=>bu,removeTournamentExtension:()=>Pu,setTournamentCategories:()=>UO,setTournamentDates:()=>SO,setTournamentEndDate:()=>yO,setTournamentName:()=>gO,setTournamentNotes:()=>IO,setTournamentStartDate:()=>vO,setTournamentStatus:()=>lO});var sO={};function cO(e){let t=$c(e,[{tournamentRecord:!0,startDate:!0,endDate:!1,tournamentName:!0}]);if(t.error)return t;let{startDate:r,endDate:i}=e.tournamentRecord,n=(r&&i?new Date(ya(i)).getTime()-new Date(ya(r)).getTime():0)/864e5,a=e.endDate||ba(e.startDate,n),o=t=>t?.filter(({itemType:t})=>e.itemTypeList?.includes(t)),s=t=>t?.filter(({name:t})=>e.extensionList?.includes(t)),c={participants:e.copyParticipants?e.tournamentRecord.participants?.map(e=>{let{timeItems:t,extensions:r,...i}=e;return Wa({...i,timeItems:o(t),extensions:s(r)},!1,!0)})??[]:[],parentOrganisation:Wa({...e.tournamentRecord.parentOrganisation},!1,!0),venues:Wa(e.tournamentRecord.venues??[],!1,!0),extensions:s(e.tournamentRecord.extensions),timeItems:o(e.tournamentRecord.timeItems),events:e.tournamentRecord.events?.map(t=>{let{drawDefinitions:r,timeItems:i,extensions:n,startDate:c,endDate:u,...d}=t;return Wa({extensions:s(n),timeItems:o(i),startDate:e.startDate,endDate:a,...d},!1,!0)})??[],weekdays:[...e.tournamentRecord.weekdays??[]],tournamentName:e.tournamentName,startDate:e.startDate,tournamentId:za(),endDate:a};return{...ce,tournamentRecord:c}}n(sO,{copyTournamentRecord:()=>cO,createTournamentRecord:()=>EA});var uO={};function dO(e){let{tournamentRecord:t,eventProfiles:r=[],directives:i,policyDefinitions:n}=e;return t?((t.events||[]).forEach(e=>{let t=r.find(t=>t.eventId&&t.eventId===e.eventId);(t?.directives?.hydrateRoundNames||i?.hydrateRoundNames)&&e.drawDefinitions?.forEach(e=>{(t?.policyDefinitions?.[au]||n?.[au])&&fM({drawDefinition:e,appliedPolicies:n})})}),{tournamentRecord:t}):{error:Ie}}function lO({tournamentRecord:e,status:t}){return e?t&&!Object.keys(Hv).includes(t)?{error:gi,info:"Unknown status"}:(e.tournamentStatus=t,{...ce}):{error:Ie}}function pO(e){let t=$c(e,[{tournamentRecord:!0,onlineResource:!0}]);if(t.error)return t;let{tournamentRecord:r,onlineResource:i,organisationId:n,participantId:a,personId:o,courtId:s,venueId:c}=e;if(n){if(r.parentOrganisation?.parentOrganisationId!==n)return Pn({result:{error:wi}});mO({element:r.parentOrganisation,onlineResource:i})}else if(a||o){let e=(r.participants??[]).find(e=>o&&e.person?.personId===o||e.participantId===a);if(!e)return Pn(o?{result:{error:wi}}:{result:{error:Sr}});if(o){if(e.person?.personId!==o)return Pn({result:{error:ur}});mO({element:e.person,onlineResource:i})}else mO({element:e,onlineResource:i})}else if(s){let e=(r.venues??[]).filter(e=>!c||e.venueId===c).flatMap(e=>(e.courts??[]).filter(e=>e.courtId===s))?.[0];if(!e)return Pn({result:{error:jr}});mO({element:e,onlineResource:i})}else if(c){let e=(r.venues??[]).find(e=>e.venueId===c);if(!e)return Pn({result:{error:Yr}});mO({element:e,onlineResource:i})}else mO({element:r,onlineResource:i}),rn({payload:{parentOrganisation:r.parentOrganisation,onlineResources:r.onlineResources,tournamentId:r.tournamentId},topic:dl});return{...ce}}function mO({element:e,onlineResource:t}){let r=(e.onlineResources??[]).filter(e=>!(e?.[Va]===t[Va]&&e?.[Ga]===t[Ga]&&e?.[ja]===t[ja]));e.onlineResources=r}function fO(e){let t=$c(e,[{tournamentRecord:!0,onlineResource:!0}]);if(t.error)return t;let{tournamentRecord:r,onlineResource:i,organisationId:n,participantId:a,personId:o,courtId:s,venueId:c}=e;if(n){if(r.parentOrganisation?.parentOrganisationId!==n)return Pn({result:{error:wi}});hO({element:r.parentOrganisation,onlineResource:i})}else{if(a&&o&&a!==o)return Pn({result:{error:ur}});if(a||o){let e=(r.participants??[]).find(e=>o&&e.person?.personId===o||e.participantId===a);if(!e)return Pn(o?{result:{error:wi}}:{result:{error:Sr}});if(o){if(e.person?.personId!==o)return Pn({result:{error:ur}});hO({element:e.person,onlineResource:i})}else hO({element:e,onlineResource:i})}else if(s){let e=(r.venues??[]).filter(e=>!c||e.venueId===c).flatMap(e=>(e.courts??[]).filter(e=>e.courtId===s))?.[0];if(!e)return Pn({result:{error:jr}});hO({element:e,onlineResource:i})}else if(c){let e=(r.venues??[]).find(e=>e.venueId===c);if(!e)return Pn({result:{error:Yr}});hO({element:e,onlineResource:i})}else hO({element:r,onlineResource:i}),rn({payload:{parentOrganisation:r.parentOrganisation,onlineResources:r.onlineResources,tournamentId:r.tournamentId},topic:dl})}return{...ce}}function hO({element:e,onlineResource:t}){let r=(e.onlineResources??[]).filter(e=>e?.[$a]!==t[$a]&&e?.[ja]!==t[ja]);return r.push(t),e.onlineResources=r,{...ce}}function gO({tournamentRecord:e,promotionalName:t,tournamentName:r,formalName:i}){if(!e)return{error:Ie};let n=e.tournamentId,a={tournamentId:n};return r&&r!==e.tournamentName&&(e.tournamentName=r,a.tournamentName=r),t&&t!==e.promotionalName&&(e.promotionalName=t,a.promotionalName=t),i&&i!==e.formalName&&(e.formalName=i,a.formalName=i),e.promotionalName===e.tournamentName&&(delete e.promotionalName,a.promotionalName=""),e.formalName===e.tournamentName&&(delete e.formalName,a.formalName=""),Object.keys(a).length>1&&rn({topic:dl,payload:{parentOrganisation:e.parentOrganisation,tournamentId:n,...a}}),{...ce}}function IO({tournamentRecord:e,notes:t}){if(!e)return{error:Ie};let r=t?KS({element:e,notes:t}):JS({element:e});return r.error?r:(rn({topic:dl,payload:{parentOrganisation:e.parentOrganisation,tournamentId:e.tournamentId,notes:t??""}}),{...ce})}function UO({tournamentRecord:e,categories:t}){return e?(t=(t||[]).filter(e=>e.categoryName&&e.type),e.tournamentCategories=t,rn({topic:dl,payload:{parentOrganisation:e.parentOrganisation,tournamentId:e.tournamentId,categories:t}}),{...ce}):{error:Ie}}function SO(e){let t,{tournamentRecord:r,startDate:i,endDate:n,weekdays:a}=e,o=e.activeDates?.filter(Boolean),s=$c(e,[{tournamentRecord:!0},{[kc]:e=>na.test(e),[xc]:Jt,startDate:!1,endDate:!1},{[kc]:e=>e.filter(Boolean).every(e=>na.test(e)),[xc]:Jt,activeDates:!1},{[kc]:eR,weekdays:!1}]);if(s.error)return s;if(n&&i&&new Date(n)<new Date(i))return{error:gi};if(n&&i&&new Date(i)>new Date(n))return{error:gi};if(o?.length){let e=i||r.startDate,t=n||r.endDate,a=!e||o.every(t=>new Date(t)>=new Date(e)),s=!t||o.every(e=>new Date(e)<=new Date(t));if(!a||!s)return{error:Jt}}(i&&r.startDate&&new Date(i)>new Date(r.startDate)||n&&r.endDate&&new Date(n)<new Date(r.endDate))&&(t=!0);let c=fa(r.startDate,r.endDate);i&&(r.startDate=i),n&&(r.endDate=n);let u=fa(r.startDate,r.endDate),d=c.filter(e=>!u.includes(e)),l=u.filter(e=>!c.includes(e));for(let m of r.events??[])i&&m.startDate&&new Date(m.startDate)<new Date(i)&&(m.startDate=i),n&&m.startDate&&new Date(m.startDate)>new Date(n)&&(m.startDate=i??n),n&&m.endDate&&new Date(m.endDate)>new Date(n)&&(m.endDate=n),i&&m.endDate&&new Date(m.endDate)<new Date(i)&&(m.endDate=n??i);i&&r.endDate&&new Date(i)>new Date(r.endDate)&&(r.endDate=i),n&&r.startDate&&new Date(n)<new Date(r.startDate)&&(r.startDate=n),o&&(r.activeDates=o),a&&(r.weekdays=a);let p=t&&function({tournamentRecord:e}){let t=Xf({tournamentRecord:e}).matchUps??[],r=e.startDate&&new Date(e.startDate),i=e.endDate&&new Date(e.endDate),n=[],a=[];for(let o of t){let{schedule:e,matchUpId:t}=o;if(e&&e.scheduledDate){let o=new Date(e.scheduledDate);(r&&o<r||i&&o>i)&&(a.push(t),n.includes(e.scheduledDate)||n.push(e.scheduledDate))}}return n.length&&!RA({scheduledDates:n,tournamentRecord:e}).clearedScheduleCount?{error:Re}:{unscheduledMatchUpIds:a}}({tournamentRecord:r})?.unscheduledMatchUpIds;return function({tournamentRecord:e}){if(!e)return{error:Ie};let{startDate:t,endDate:r}=e,i=fa(t,r),n=[];for(let a of e.venues||[])a?.courts?.length&&n.push(...a.courts);for(let a of n){let{startTime:e,endTime:t}=(a.dateAvailability??[]).reduce((e,t)=>{let r=Ua(e.startTime),i=Ua(e.endTime);return t.startTime&&Ua(t.startTime)<r&&(e.startTime=t.startTime),t.endTime&&Ua(t.endTime)>i&&(e.endTime=t.endTime),e},{startTime:"08:00",endTime:"18:00"}),r=i.map(r=>a.dateAvailability?.find(e=>e.date===r)??{date:r,startTime:e,endTime:t}),n=a.dateAvailability?.find(e=>!e.date);n&&r.unshift(n),a.dateAvailability=r}}({tournamentRecord:r}),rn({payload:wn({parentOrganisation:r.parentOrganisation,tournamentId:r.tournamentId,activeDates:o,startDate:i,weekdays:a,endDate:n}),topic:dl}),{...ce,unscheduledMatchUpIds:p,datesAdded:l,datesRemoved:d}}function vO({tournamentRecord:e,startDate:t}){return t?SO({tournamentRecord:e,startDate:t}):{error:Jt}}function yO({tournamentRecord:e,endDate:t}){return t?SO({tournamentRecord:e,endDate:t}):{error:Jt}}n(uO,{addDrawDefinitionExtension:()=>vu,addEventExtension:()=>yu,addEventTimeItem:()=>fv,addExtension:()=>Uu,addNotes:()=>KS,addOnlineResource:()=>fO,addParticipantExtension:()=>wu,addParticipantTimeItem:()=>pv,addTimeItem:()=>lv,addTournamentExtension:()=>Su,addTournamentTimeItem:()=>mv,hydrateTournamentRecord:()=>dO,removeDrawDefinitionExtension:()=>Tu,removeEventExtension:()=>Du,removeExtension:()=>gu,removeNotes:()=>JS,removeOnlineResource:()=>pO,removeParticipantExtension:()=>bu,removeTournamentExtension:()=>Pu,setTournamentCategories:()=>UO,setTournamentDates:()=>SO,setTournamentEndDate:()=>yO,setTournamentName:()=>gO,setTournamentNotes:()=>IO,setTournamentStartDate:()=>vO,setTournamentStatus:()=>lO});var wO={};n(wO,{addCourt:()=>hE,addCourts:()=>gE,addVenue:()=>yf,deleteCourt:()=>LO,deleteVenue:()=>NO,deleteVenues:()=>AO,disableCourts:()=>EO,disableVenues:()=>OO,enableCourts:()=>FO,enableVenues:()=>_O,generate:()=>PO,generateCourts:()=>kR,getCompetitionVenues:()=>$v,getCourts:()=>sM,getVenuesAndCourts:()=>jv,modifyCourt:()=>VO,modifyCourtAvailability:()=>bO,modifyVenue:()=>$O,mutate:()=>TO,publicFindVenue:()=>Tf,query:()=>oM});var PO={};n(PO,{generateCourts:()=>kR});var TO={};function DO(e){if(!e?.tournamentRecord&&!Array.isArray(e?.venueMatchUps))return{error:Ie};if(!e?.courtId)return{error:jt};let{scheduleVisibilityFilters:t,tournamentRecord:r,matchUpFilters:i,venueMatchUps:n,courtId:a}=e,{schedulingProfile:o}=lb({tournamentRecord:r});if(Array.isArray(n))return{matchUps:c({matchUps:n,courtId:a})};let{matchUps:s}=Xf({scheduleVisibilityFilters:t,tournamentRecord:r,matchUpFilters:i});return{matchUps:c({matchUps:s,courtId:a})};function c({matchUps:e,courtId:t}){return Lb({matchUps:e.filter(e=>{let r=e.schedule?.allocatedCourts?.map(({courtId:e})=>e);return e.schedule?.courtId===t||r?.includes(t)}),schedulingProfile:o})}}function bO({tournamentRecord:e,dateAvailability:t,disableNotice:r,venueMatchUps:i,courtId:n,force:a}){if(!e)return{error:Ie};if(!n)return{error:jt};let o=vf({dateAvailability:t});if(o.error)return o;let{updatedDateAvailability:s,totalMergeCount:c}=function(e){let t=0,r=e.reduce((e,t)=>{let{date:r,startTime:i,endTime:n,bookings:a}=t;return e[r]||(e[r]=[]),e[r].push({startTime:i,endTime:n,bookings:a}),e},{}),i=[];return Object.keys(r).forEach(e=>{r[e].sort(Sf);let{mergedAvailability:n,mergeCount:a}=function(e){let t,r,i,n=e.length,a=0,o=[];for(;e.length&&n;){let s=e.shift(),{startTime:c,endTime:u,bookings:d}=s;if(n-=1,t)if(Ra(Ma(r),Ma(c),!1)>0){let e={startTime:t,endTime:r};i?.length&&(e.bookings=i),o.push(e),t=c,i=d,r=u}else d&&(i?i.push(d):i=d),r=u,a+=1;else t=c,i=d,r=u}let s={startTime:t,endTime:r};return i?.length&&(s.bookings=i),o.push(s),{mergedAvailability:o,mergeCount:a}}(r[e]);i.push(...n.map(t=>({date:e,...t}))),t+=a}),{updatedDateAvailability:i,totalMergeCount:t}}(t);t=s;let u=Df({tournamentRecord:e,courtId:n});if(u.error)return u;let{court:d,venue:l}=u,{matchUps:p}=DO({tournamentRecord:e,venueMatchUps:i,courtId:n});if(p?.length){let t=up({tournamentRecord:e})?.appliedPolicies,r=a??t?.[cu]?.allowDeletionWithScoresPresent?.courts,i=[];i.length&&(r||console.log("throw error: scheduled court matchUps",i.length))}return d&&(d.dateAvailability=t,!r&&l&&rn({payload:{venue:l,tournamentId:e.tournamentId},topic:ll,key:l.venueId})),{...ce,totalMergeCount:c}}function MO({matchUpsCount:e=0}){return{error:Ei,info:`Schedule would be deleted from ${e} ${1===e?"matchUp":"matchUps"}; use { force: true }`}}function RO({tournamentRecord:e,drawDefinition:t,matchUpId:r,drawId:i}){let n;if(!r)return{error:Mt};if(!t&&!i)return{error:Ge};if(!t){if(!e)return{error:Ie};({drawDefinition:t}=Af({tournamentRecord:e,drawId:i}))}if(t)({matchUp:n}=zS({drawDefinition:t,matchUpId:r}));else{if(!e)return{error:Ie};let t=Xf({tournamentRecord:e,inContext:!1}).matchUps??[];({matchUp:n}=YS({matchUps:t,matchUpId:r}))}return n?(n.timeItems&&n.timeItems.find(e=>[Sm,Um].includes(e.itemType))&&(n.timeItems=n.timeItems.filter(({itemType:e})=>![Sm,Um].includes(e)),Dl({tournamentId:e?.tournamentId,context:"removeCourtAssignment",drawDefinition:t,matchUp:n})),{...ce}):{error:Nt}}function NO(e){if("string"!=typeof e?.venueId)return{error:zr};let{tournamentRecord:t,venueId:r,force:i}=e,n=e.tournamentRecords||t&&{[t.tournamentId]:t}||{};if(!Object.keys(n).length)return{error:Ie};let a=Zf({tournamentRecords:n,contextFilters:{venueIds:[r]}}).matchUps??[],o=up({tournamentRecord:t})?.appliedPolicies,s=i??o?.[cu]?.allowDeletionWithScoresPresent?.venues;if(a.length&&!s)return MO({matchUpsCount:a.length});for(let c of Object.values(n)){for(let t of a){let e=RO({matchUpId:t.matchUpId,drawId:t.drawId,tournamentRecord:c});if(e.error)return e}let e;c.venues=(c.venues??[]).filter(t=>t?.venueId!==r||(e=!0,!1)),e&&rn({payload:{venueId:r,tournamentId:c.tournamentId},topic:el,key:r})}return mb({tournamentRecords:n}),{...ce}}function AO({tournamentRecord:e,venueIds:t,force:r}){if(!e)return{error:Ie};if(!Array.isArray(t))return{error:gi};for(let i of e.venues||[]){let{venueId:n}=i;if(t.includes(n)){let{venueId:t}=i,n=NO({tournamentRecord:e,venueId:t,force:r});if(n.error)return n}}return{...ce}}function EO(e){let{courtIds:t,dates:r}=e,i=Fl(e),n=$c(e,[{[zs]:!0,[Ic]:!0}]);if(n.error)return n;for(let a of Object.values(i))CO({tournamentRecord:a,courtIds:t,dates:r});return{...ce}}function CO({tournamentRecord:e,courtIds:t,dates:r}){let i=!Array.isArray(r)||!r.length||{dates:r},n=e=>Uu({extension:{value:i,name:Cu},creationTime:!1,element:e});for(let a of e.venues||[])for(let e of a.courts||[])if(t?.includes(e.courtId)){let t=n(e);if(t.error)return t}return{...ce}}function OO(e){let{tournamentRecords:t,tournamentId:r,venueIds:i}=e,n=$c(e,[{[zs]:!0,[Sc]:!0}]);if(n.error)return n;let a=Object.keys(t).filter(e=>!r||e===r);for(let o of a){kO({tournamentRecord:t[o],venueIds:i})}return{...ce}}function kO({tournamentRecord:e,venueIds:t}){for(let r of e.venues||[])if(t?.includes(r.venueId)){let e=Uu({creationTime:!1,element:r,extension:{name:Cu,value:!0}});if(e.error)return e}return{...ce}}function FO(e){let t=Fl(e),r=[{[zs]:!0}];!e.enableAll&&r.push({[Ic]:!0});let i=$c(e,r);if(i.error)return i;let{enableAll:n,courtIds:a,dates:o}=e;for(let s of Object.values(t))xO({tournamentRecord:s,courtIds:a,enableAll:n,dates:o});return{...ce}}function xO({tournamentRecord:e,courtIds:t,enableAll:r,dates:i}){for(let n of e.venues||[])for(let e of n.courts||[])if(r||t?.includes(e.courtId))if(Array.isArray(i)){let{extension:t}=Ru({element:e,name:Cu});if(t){let r=t.value;Array.isArray(r.dates)&&(r.dates=r.dates.filter(e=>!i.includes(e))),Uu({extension:{name:Cu,value:r},creationTime:!1,element:e})}}else gu({element:e,name:Cu});return{...ce}}function _O(e){let t=Fl(e),r=[{[zs]:!0}];!e.enableAll&&r.push({[Sc]:!0});let i=$c(e,r);if(i.error)return i;let{venueIds:n,enableAll:a}=e;for(let o of Object.values(t))for(let e of o.venues||[])(a||n?.includes(e.venueId))&&gu({element:e,name:Cu});return{...ce}}function LO(e){let t,r,{courtId:i,disableNotice:n,force:a}=e,o=Fl(e),s=$c(e,[{[zs]:!0,[yc]:!0}]);if(s.error)return s;for(let c of Object.values(o)){if(r=BO({tournamentRecord:c,disableNotice:n,courtId:i,force:a}),r.error&&r.error!==jr)return r;r.success&&(t=!0)}return t?{...ce}:r}function BO({tournamentRecord:e,disableNotice:t,courtId:r,force:i}){let n=Df({tournamentRecord:e,courtId:r});if(n.error)return n;let a=n.venue,{matchUps:o}=DO({tournamentRecord:e,courtId:r}),s=up({tournamentRecord:e})?.appliedPolicies,c=i??s?.[cu]?.allowDeletionWithScoresPresent?.courts;if(o?.length&&!c)return MO({matchUpsCount:o.length});for(let u of o??[]){let t=RO({matchUpId:u.matchUpId,drawId:u.drawId,tournamentRecord:e});if(t.error)return t}return a&&(a.courts=(a.courts??[]).filter(e=>e.courtId!==r),t||rn({payload:{venue:a,tournamentId:e.tournamentId},topic:ll,key:a.venueId})),{...ce}}function VO(e){let t,{disableNotice:r,modifications:i,courtId:n,force:a,venueMatchUps:o}=e,s=Fl(e);if(!Object.keys(s).length)return{error:ge};for(let c of Object.values(s)){let e=GO({tournamentRecord:c,disableNotice:r,venueMatchUps:o,modifications:i,courtId:n,force:a});if(e?.error)return e;t=!0}return t?{...ce}:void 0}function GO({tournamentRecord:e,disableNotice:t,venueMatchUps:r,modifications:i,courtId:n,force:a}){if(!e)return{error:Ie};if(!n)return{error:jt};if(!i||"object"!=typeof i)return{error:mi};let o=Df({tournamentRecord:e,courtId:n});if(o.error)return o;let{venue:s,court:c}=o,u=Object.keys(fE()).filter(e=>"courtId"!==e);if(!Object.keys(i).filter(e=>u.includes(e)).length)return{error:vi};let d=new Set(u.filter(e=>!["dateAvailability"].includes(e))),l=Object.keys(i).filter(e=>d.has(e));if(c&&l.forEach(e=>Object.assign(c,{[e]:i[e]})),i.dateAvailability){let o=bO({dateAvailability:i.dateAvailability,tournamentRecord:e,venueMatchUps:r,disableNotice:t,courtId:n,force:a});if(o.error)return o}return t||rn({payload:{venue:s,tournamentId:e.tournamentId},topic:ll,key:s?.venueId}),{...ce,court:Wa(c)}}n(TO,{addCourt:()=>hE,addCourts:()=>gE,addVenue:()=>yf,deleteCourt:()=>LO,deleteVenue:()=>NO,deleteVenues:()=>AO,disableCourts:()=>EO,disableVenues:()=>OO,enableCourts:()=>FO,enableVenues:()=>_O,modifyCourt:()=>VO,modifyCourtAvailability:()=>bO,modifyVenue:()=>$O});var jO=()=>({venueId:void 0,venueName:"",venueAbbreviation:"",onlineResources:[],venueType:void 0,defaultStartTime:void 0,defaultEndTime:void 0,dateAvailability:[],addresses:[],contacts:[],courts:[],roles:[]});function $O(e){let t,r,{modifications:i,venueId:n,force:a}=e,o=Fl(e);if(!Object.keys(o).length)return{error:ge};if("string"!=typeof n)return{error:zr};for(let s of Object.values(o)){let e=qO({tournamentRecord:s,modifications:i,venueId:n,force:a});if(e.success&&(r=!0),e.error&&(t=e.error),e.error&&e.error!==Yr)return e}return mb({tournamentRecords:o}),r?{...ce}:{error:t}}function qO({tournamentRecord:e,modifications:t,venueId:r,force:i}){if(!e)return{error:Ie};if(!t||"object"!=typeof t)return{error:mi};if(!r)return{error:zr};let n=up({tournamentRecord:e})?.appliedPolicies,a=i??n?.[cu]?.allowDeletionWithScoresPresent?.venues,{matchUps:o}=function({scheduleVisibilityFilters:e,tournamentRecord:t,matchUpFilters:r,venueId:i}){if(!t)return{error:Ie};if(!i)return{error:zr};let{schedulingProfile:n}=lb({tournamentRecord:t}),{matchUps:a}=Xf({scheduleVisibilityFilters:e,tournamentRecord:t,matchUpFilters:r});return{matchUps:function({matchUps:e,venueId:t}){return Lb({matchUps:e.filter(e=>{let r=e.schedule?.allocatedCourts?.map(({venueId:e})=>e);return e.schedule?.venueId===t||r?.includes(t)}),schedulingProfile:n})}({matchUps:a,venueId:i})}}({tournamentRecord:e,venueId:r}),s=Pf({tournamentRecord:e,venueId:r});if(s.error)return s;let c=s.venue,u=Object.keys(jO()).filter(e=>"venueId"!==e);if(!Object.keys(t).filter(e=>u.includes(e)).length)return{error:vi};let d=new Set(u.filter(e=>!["courts","onlineResources","dateAvailability"].includes(e))),l=Object.keys(t).filter(e=>d.has(e));if(!c)return{error:Yr};let p=t.defaultStartTime??c.defaultStartTime,m=t.defaultEndTime??c.defaultEndTime;if(p||m){if(!p||!m)return{error:gi,info:"both defaultStartTime and defaultEndTime are required"};if(!Uf({startTime:p,endTime:m}))return{error:gi,info:"defaultEndTime must be after defaultStartTime"}}if(l.forEach(e=>Object.assign(c,{[e]:t[e]})),void 0!==t.dateAvailability){if(Array.isArray(t.dateAvailability)&&t.dateAvailability.length){let e=vf({dateAvailability:t.dateAvailability});if(e.error)return e}c.dateAvailability=t.dateAvailability}let f=function({venue:e,modifications:t,tournamentRecord:r,venueMatchUps:i,allowModificationWhenMatchUpsScheduled:n}){let a=e?.courts?.map(e=>e.courtId)??[],o=t.courts?.map(e=>e.courtId)||[],s=o.length?a.filter(e=>!o.includes(e)):t?.courts&&a,c=[];if(s?.length){let t=e?.courts?.filter(e=>s.includes(e.courtId))?.map(e=>{let t=DO({courtId:e.courtId,tournamentRecord:r,venueMatchUps:i});for(let r of t.matchUps??[])c.push({matchUpId:r.matchUpId,drawId:r.drawId});return t.matchUps?.length??0}).reduce((e,t)=>e+t);return!e||t&&!n?MO({matchUpsCount:t}):(e.courts=e.courts?.filter(e=>o.includes(e.courtId)),DA({schedule:{courtId:"",scheduledDate:""},matchUpDetails:c,removePriorValues:!0,tournamentRecord:r}),{success:!0})}return{success:!0}}({venue:c,modifications:t,tournamentRecord:e,venueMatchUps:o,allowModificationWhenMatchUpsScheduled:a});if("error"in f&&f.error)return f;let h=function({modifications:e,tournamentRecord:t,venueMatchUps:r,venueId:i,force:n}){if(e.courts)for(let a of e.courts){let{courtId:e}=a||{},o=VO({modifications:a,disableNotice:!0,tournamentRecord:t,venueMatchUps:r,courtId:e,force:n});if(o?.error===jr&&(o=hE({disableNotice:!0,tournamentRecord:t,venueId:i,court:a})),o?.error)return o}return{success:!0}}({modifications:t,tournamentRecord:e,venueMatchUps:o,venueId:r,force:i});return h?.error?h:(mb({tournamentRecord:e}),c&&rn({payload:{venue:c,tournamentId:e.tournamentId},topic:ll,key:c?.venueId}),{...ce,venue:Wa(c)})}var WO={};function HO({scheduledMatchUps:e,showGlobalLog:t}){hh.length=0;let r=e?.reduce((e,{structureId:t})=>e.includes(t)?e:e.concat(t),[]),i=Array.isArray(r)&&{...r.map(t=>{let{structureName:r,matchUpType:i}=e.find(e=>e.structureId===t);return{[t]:`${r} ${i}`}})};r?.forEach(t=>{gh({color:"blue",method:"draw",structure:i[t],keyColors:{structure:"magenta"}},!0);let r=e.filter(e=>e.structureId===t),n=em({matchUps:r})?.roundMatchUps||[];Object.keys(n).forEach(e=>{gh({roundNumber:e,keyColors:{roundNumber:"brightcyan"}},!0),n[e].forEach(({matchUpId:e,schedule:t})=>{gh({matchUpId:e,time:va(t.scheduledTime),date:t.scheduledDate,venue:t.venueId,keyColors:{time:"brightcyan",date:"brightcyan",matchUpId:"yellow",venue:"magenta"}},!0)})})}),t&&Ih()}n(WO,{JSON2CSV:()=>XO,UUID:()=>za,UUIDS:()=>Ya,allNumeric:()=>ne,attributeFilter:()=>Xc,chunkArray:()=>re,chunkByNth:()=>oe,chunkSizeProfile:()=>ie,constantToString:()=>II,countValues:()=>$,createMap:()=>w,dateTime:()=>Oa,definedAttributes:()=>wn,dehydrateMatchUps:()=>JO,extractAttributes:()=>ih,flattenJSON:()=>ZO,generateDateRange:()=>fa,generateHashCode:()=>b,generateRange:()=>K,generateTimeCode:()=>NE,groupValues:()=>q,hasAttributeValues:()=>P,instanceCount:()=>j,intersection:()=>Q,isConvertableInteger:()=>F,isNumeric:()=>E,isOdd:()=>C,isPowerOf2:()=>M,makeDeepCopy:()=>Wa,matchUpScheduleSort:()=>KO,matchUpSort:()=>eh,nearestPowerOf2:()=>A,nextPowerOf2:()=>O,noNulls:()=>B,noNumeric:()=>ae,numericSort:()=>g,occurrences:()=>ee,overlap:()=>Z,randomMember:()=>z,randomPop:()=>Y,shuffleArray:()=>V,structureSort:()=>Ld,subSort:()=>te,undefinedToNull:()=>T,unique:()=>L,visualizeScheduledMatchUps:()=>HO});var{extractTime:YO,timeStringMinutes:zO}=Oa;function KO(e,t){let r=e.schedule??{},i=t.schedule??{};if(r.scheduledDate&&!i.scheduledDate)return 1;if(i.scheduledDate&&!r.scheduledDate)return-1;if(r.scheduledDate&&i.scheduledDate){if(r.scheduledDate===i.scheduledDate){if(r.scheduledTime&&!i.scheduledTime)return 1;if(i.scheduledTime&&!r.scheduledTime)return-1;if(r.scheduledTime&&i.scheduledTime){return zO(YO(r.scheduledTime))-zO(YO(i.scheduledTime))}}return new Date(r.scheduledDate).getTime()-new Date(i.scheduledDate).getTime()}return 0}function JO({tournamentRecord:e}){if(!e)return{error:Ie};if("object"!=typeof e||!e.tournamentId)return{error:gi};let{matchUps:t}=Xf({tournamentRecord:e,inContext:!1});if(t?.length){let r=function({tournamentRecord:e}){let t={};for(let r of e.events||[]){r.matchUpFormat&&(t[r.eventId]=r.matchUpFormat);for(let e of r.drawDefinitions||[]){e.matchUpFormat&&(t[e.drawId]=e.matchUpFormat);for(let r of e.structures||[]){r.matchUpFormat&&(t[r.structureId]=r.matchUpFormat);for(let e of r.structures||[])e.matchUpFormat&&(t[e.structureId]=e.matchUpFormat)}}}return t}({tournamentRecord:e});!function(e,t={}){for(let r of e){let{structureId:e,drawId:i,eventId:n}=r,a=t[e]||t[i]||t[n],o=r.matchUpFormat===a?void 0:r.matchUpFormat;for(let t of Object.keys(r))QO.includes(t)||delete r[t];r.sides&&r.drawPositions&&!r.tieMatchUps&&delete r.sides,o&&(r.matchUpFormat=o)}}(t,r)}return{...ce}}var QO=["collectionId","collectionPosition","drawPositions","extensions","finishingPositionRange","finishingRound","isMock","matchUpId","matchUpStatus","matchUpStatusCodes","orderOfFinish","processCodes","roundNumber","tieFormat","tieMatchUps","roundPosition","score","sides","winnerMatchUpId","loserMatchUpId","matchUpDuration","winningSide"];function XO(e,t){if(t&&"object"!=typeof t)return{error:gi};let{columnTransform:r={}}=t||{},{includeTransformAccessors:i,includeHeaderRow:n=!0,returnTransformedJSON:a,removeEmptyColumns:o,onlyHeaderRow:s,columnAccessors:c=[],functionMap:u={},columnMap:d={},valuesMap:l={},context:p={},delimiter:m='"',columnJoiner:f=",",rowJoiner:h="\r\n",keyJoiner:g="."}=t||{};if(!Array.isArray(e)||!Array.isArray(c)||"object"!=typeof p||"object"!=typeof d||"object"!=typeof r||"object"!=typeof u||"object"!=typeof l||"string"!=typeof f||"string"!=typeof h||"string"!=typeof g||"string"!=typeof m)return{error:gi};r=Object.assign({},...Object.keys(r).reverse().map(e=>({[e]:Array.isArray(r[e])?r[e]:["string"==typeof r[e]&&r[e]].filter(Boolean)})));let I=e.filter(Boolean).map(e=>ZO(e,g)),S=Object.values(r).flat();i&&c.push(...S);let v=I.reduce((e,t)=>Object.keys(t).every(t=>!e.includes(t)&&e.push(t)||!0)&&e,[]).filter(e=>!c?.length||c.includes(e)),y=Object.assign({},...Object.keys(r).reverse().map(e=>r[e].map(t=>({[t]:e})).flat()).flat()),w=v.reduce((e,t)=>{let r=y[t];return r?e.includes(r)||e.push(r):e.push(t),e},[]).sort((e,r)=>t?.sortOrder?t.sortOrder.includes(e)&&t.sortOrder.includes(r)&&t.sortOrder.indexOf(e)-t.sortOrder.indexOf(r)||!t.sortOrder.includes(r)&&-1:0);Object.keys(d).forEach(e=>!w.includes(e)&&w.unshift(e)),Object.keys(r).forEach(e=>!w.includes(e)&&w.unshift(e)),"object"==typeof p&&Object.keys(p).forEach(e=>!w.includes(e)&&w.unshift(e));let P=w.map(e=>d[e]||e);if(s)return[P];let T=e=>`${m}${e}${m}`,D=[],b=I.map(e=>Object.values(w.reduce((t,i,n)=>{let a=r[i],o=(a?.length?e[a.find(t=>e[t])]:e[i])||p?.[i]||"",s=l[i]?.[o]||o,c=U(u[i])?u[i](s):s;return t[i]=T(c),c&&(D[n]=(D[n]||0)+1),t},{}))),M=o&&[...D].map((e,t)=>!e&&t).filter(E).reverse();if(M){let e=e=>e.filter((e,t)=>!M.includes(t));b=b.map(e),P=e(P)}let R=b.map(e=>e.join(f));return a?R.map(e=>{let t=e.split(f);return Object.assign({},...t.map((e,t)=>({[P[t]]:e})))}):n?[P.map(T).join(f),...R].join(h):R.join(h)}function ZO(e,t=".",r=[]){return"object"==typeof e&&Object.keys(e).reduce((i,n)=>"object"!=typeof e[n]?(i[r.concat(n).join(t)]=e[n],i):Object.assign(i,ZO(e[n],t,r.concat(n))),{})}var{FACTORY:ek}=Xu;function tk({timeStamp:e}){let t=mn(),r=tn();return r&&Object.values(t).forEach(t=>{!function({tournamentRecord:e,value:t}){let{extension:r}=Ru({element:e,name:ek});Uu({element:e,extension:{name:ek,value:{...r?.value,...t}}})}({tournamentRecord:t,value:{version:"2.4.4",timeStamp:e}})}),r}function rk({engineType:e,methodName:t,elapsed:r,params:i,result:n}){let a=$i();if("object"!=typeof a)return;let o={method:t},s=n?.error&&(!0===a.errors||Array.isArray(a.errors)&&a.errors.includes(t)),c=Array.isArray(a.params)&&a.params?.includes(t),u=a.params&&!Array.isArray(a.params)||c,d=Array.isArray(a.exclude)&&a.exclude.includes(t);!d&&![void 0,!1].includes(a.perf)&&!isNaN(a.perf)&&r>=a.perf&&(o.elapsed=r),!d&&(s||u)&&(o.params=i),!d&&(s||a.result&&!Array.isArray(a.result)&&(!Array.isArray(a.params)||c)||Array.isArray(a.result)&&a.result?.includes(t))&&(o.result=n),Object.keys(o).length>1&&vn(o,e)}function ik({methodName:e,params:t,start:r}){let i={error:Ai,methodName:e};return rk({result:i,methodName:e,elapsed:r?Date.now()-r:0,params:t,engineType:"sync"}),i}function nk(e,t,r,i,n){delete e.success,delete e.error;let a=Date.now(),o=ln();r&&(r.activeTournamentId=o);let s=r?.tournamentRecord||pn(o),c="object"==typeof r?.tournamentRecord&&{[r?.tournamentRecord.tournamentId]:r.tournamentRecord}||mn(),u=r?Wa(r,void 0,!0):void 0,d=r?function(e,t){if(!1===t._middleware)return t;if(t.tournamentId&&!e[t.tournamentId])return{error:Ie};let r=t.drawId||t.matchUp?.drawId;if(r){let{event:i,drawDefinition:n,tournamentId:a}=Af({tournamentRecords:e,drawId:r});n&&(t.drawDefinition=n),a&&(t.tournamentId=a),i&&(t.event=i)}if(t.eventId&&!t.event){let{event:r,tournamentId:i}=Af({eventId:t.eventId,tournamentRecords:e});if(!r)return{error:st};t.tournamentId=i,t.event=r}let i=t.tournamentId??ln();if(!i&&t)return t;let n=e[i];return i&&!n?{error:Ie}:(n&&(t.tournamentRecord=n),t)}(c,r):void 0;if(d?.error)return d;let l=function({tournamentRecords:e,tournamentRecord:t,params:r,methodName:i,method:n}){if($i())return n({tournamentRecords:e,tournamentRecord:t,...r});try{return n({tournamentRecords:e,tournamentRecord:t,...r})}catch(a){return Sn({engineName:"engine",methodName:i,params:r,err:a})}}({params:d,tournamentRecords:c,tournamentRecord:s,methodName:i,method:t});return rk({result:l,methodName:i,elapsed:Date.now()-a,params:u,engineType:n}),l}function ak(e){let{mutationStatus:t,tournamentId:r,directives:i,timeStamp:n}=e||{},{topics:a}=cn();for(let o of[...a].sort(sk)){let e=an({topic:o});e?.length&&dn({topic:o,notices:e})}t&&n&&a.includes(pl)&&dn({notices:[{tournamentId:r,directives:i,timeStamp:n}],topic:pl})}var ok={[Ul]:5,[Il]:5,[Sl]:5,[ul]:5,[cl]:5,[il]:5,[nl]:5,[al]:5,[ol]:1,[vl]:1,[sl]:5,[ll]:5,[rl]:4,[Zd]:4,[el]:4,[tl]:4,[Hd]:3,[Wd]:2};function sk(e,t){return(ok[t]||0)-(ok[e]||0)}function ck(e,t=!0){return"object"!=typeof e||Array.isArray(e)?{error:mi}:e?.tournamentId?fn(t?Wa(e):e):{error:gi}}function uk(e,t=!0){if("object"!=typeof e)return{error:mi};if(gn(),Array.isArray(e)){if(e.filter(e=>e?.tournamentId).length!==e.length)return{error:he};e=Object.assign({},...e.map(e=>({[e.tournamentId]:e})))}else if(e?.tournamentId)gn((e={[e.tournamentId]:e}).tournamentId);else if(!Object.keys(e).every(t=>e[t].tournamentId===t))return{error:he};return hn(t?Wa(e):e)}function dk(e,t){return t?.error?(e.error=t.error,e.success=!1):(e.error=void 0,e.success=!0),e}function lk(e,t){e.importMethods=(r,i,n,a)=>function(e,t,r,i,n,a){let o=yn(r,i,n,a);if(o.error)return o;let s=o.methods??[];return Object.keys(s).filter(e=>U(s[e])).forEach(r=>{e[r]=i=>{let n=()=>t(e,{[r]:s[r],...i});if($i())return n();try{return n()}catch(a){Sn({engineName:"engine",methodName:r,params:i,err:a})}}}),{...ce,...e}}(e,t,r,i,n,a),e.getTournament=e=>function(e){let{convertExtensions:t=!1,removeExtensions:r=!1}=e??{},i=e?.tournamentId??ln();return"string"!=typeof i?{}:{tournamentRecord:Wa(pn(i),t,!1,r)}}(e),e.getState=e=>function({convertExtensions:e,removeExtensions:t}){let r=mn();return{tournamentId:ln(),tournamentRecords:Wa(r,e,!1,t)}}({convertExtensions:e?.convertExtensions,removeExtensions:e?.removeExtensions}),e.version=()=>"2.4.4",e.reset=()=>(hn({}),dk(e)),e.devContext=t=>(Hi(t),dk(e)),e.getDevContext=e=>$i(e),e.newTournamentRecord=(e={})=>{let t=EA(e),r=t.tournamentId;return t.error?t:(ck(t),gn(r),{...ce,tournamentId:r})},e.setState=(t,r,i)=>{Ki(r,i);let n=uk(t,r);return dk(e,n)},e.setTournamentId=e=>gn(e),e.getTournamentId=()=>ln(),e.setTournamentRecord=(t,r,i)=>{Ki(r,i);let n=ck(t,r);return dk(e,n)},e.removeTournamentRecord=t=>{let r=In(t);return dk(e,r)},e.removeUnlinkedTournamentRecords=()=>{let t=function(){let e=mn(),{extension:t}=Ru({name:Gu,tournamentRecords:e,discover:!0}),r=t?.value?.tournamentIds||[];return Object.keys(e).forEach(t=>{r.includes(t)||delete e[t]}),hn(e)}();return dk(e,t)}}function pk(e,t){if(!v(t))return{error:gi,message:"args must be an object"};let r=Object.values(t).filter(U).length;if(r>1)return{message:"there must be only one arg with typeof function",error:gi};let i=r?Object.keys(t).find(e=>U(t[e])):S(t.method)&&t.method;if(!i)return{error:Ai};let{[i]:n,...a}=t,o=t?.params?{...t.params}:{...a},s=o.rollbackOnError&&Wa(mn(),!1,!0),c=n||e[i]||_i()[i];if(!c)return ik({methodName:i,params:o});let u=nk(e,c,o,i,"sync")??{};u?.error&&s&&uk(s);let d=Date.now(),l=tk({timeStamp:d}),p=u?.success&&!0!==o?.delayNotify&&!0!==o?.doNotNotify;return p&&ak({directives:[{method:c,params:o}],mutationStatus:l,timeStamp:d}),(p||!u?.success||o?.doNotNotify)&&sn(),u}var mk=(()=>{let e={executionQueue:(t,r)=>function(e,t,r){if(!Array.isArray(t))return{error:gi,message:"directives must be an array"};let i=nn(),n=Date.now(),a=r&&Wa(mn(),!1,!0),o=[];for(let c of t){if("object"!=typeof c)return{error:gi,message:"directive must be an object"};if(c.params&&"object"!=typeof c.params)return{error:gi,message:"params must be an object"};let{method:t,pipe:r}=c,s=c.params?{...c.params}:{};if(!i[t])return ik({methodName:t,start:n,params:s});if(r){let e=o.at(-1),t=Object.keys(r);for(let r of t)e[r]&&(s[r]=e[r])}let u=nk(e,i[t],s,t,"sync");if(u?.error)return a&&uk(a),{...u,rolledBack:!!a};o.push({...u,methodName:t})}let s=Date.now();return ak({directives:t,mutationStatus:tk({timeStamp:s}),timeStamp:s}),sn(),{success:o.every(e=>e.success),results:o}}(e,t,r),execute:t=>pk(e,t)};return lk(e,pk),e})();function fk(e,t){if(!v(t))return{error:gi,message:"args must be an object"};let r=Object.values(t).filter(U).length;if(r>1)return{message:"there must be only one arg with typeof function",error:gi};let i=r?Object.keys(t).find(e=>U(t[e])):S(t.method)&&t.method;if(!i)return{error:Ai};let{[i]:n,...a}=t,o=t?.params?{...t.params}:{...a},s=n||e[i]||_i()[i];return s?nk(e,s,o,i,"ask"):ik({methodName:i,params:o})}(()=>{let e={execute:t=>fk(e,t)};lk(e,fk)})();var hk,gk={};function Ik(e,t=!0){if(!e)return{error:$t};if("object"!=typeof e)return{error:mi};if(e.matchUpId)hk=e.matchUpId,gk[hk]=t?Wa(e):e;else if(Array.isArray(e))for(let r of e.reverse())r.matchUpId&&(gk[r.matchUpId]=t?Wa(r):r,hk||(hk=r.matchUpId));else for(let r of Object.values(e))r.matchUpId&&(gk[r.matchUpId]=t?Wa(r):r,hk||(hk=r.matchUpId));return t?Wa(e):e}(()=>{let e={getState:e=>function(e){return Wa(gk[hk],e?.convertExtensions,!1,e?.removeExtensions)}(e),version:()=>"2.4.4",reset:()=>(hk=void 0,gk={},{...ce}),drawId:void 0,error:void 0,success:!1,devContext:t=>(Hi(t),e),setState:(t,r,i)=>(Ki(r,i),function(t){return t?.error?(e.error=t.error,e.success=!1):(e.error=void 0,e.success=!0,e.drawId=t.drawId),e}(Ik(t)))};(function(e,t){t.forEach(t=>{Object.keys(t).forEach(r=>{e[r]=i=>{if($i())return Uk(e,{params:i,governor:t,methodName:r});try{return Uk(e,{params:i,governor:t,methodName:r})}catch(n){Sn({engineName:"matchUpEngine",methodName:r,params:i,err:n})}}})})})(e,[Uw])})();function Uk(e,{params:t,governor:r,methodName:i}){e.error=void 0,e.success=!1;let n=t?.matchUp||gk[hk],a=t?.matchUps||Object.values(gk),o=t?.rollbackOnError&&Wa(n,!1,!0);t={...t,matchUpId:n?.matchUpId,matchUps:a,matchUp:n};let s=r[i](t);if(s?.error)return o&&Ik(o),{...s,rolledBack:!!o};let c=s?.success&&!0!==t?.delayNotify&&!0!==t?.doNotNotify;return c&&ak(),(c||!s?.success||t?.doNotNotify)&&sn(),s}var Sk=!1,vk=(()=>{let e={version:()=>"2.4.4",setDeepCopy:(t,r)=>(Ki(t,r),e),devContext:t=>(Hi(t),Sk=!0,e)};return[oA].forEach(r=>{Object.keys(r).forEach(i=>{e[i]=function(e,r){return i=>{if($i()){let n=t(e[r],i);return!n?.error&&i?.setState&&n?.tournamentRecord&&uk(n.tournamentRecord),n}try{let n=t(e[r],i);return!n?.error&&i?.setState&&n?.tournamentRecord&&uk(n.tournamentRecord),n}catch(n){let e;"string"==typeof n?e=n.toUpperCase():n instanceof Error&&(e=n.message),console.log("ERROR",{params:JSON.stringify(i),method:r,error:e})}}}(r,i)})}),e;function t(e,t){let r=e({...t});return r?.error||ak(),sn(),Sk&&(Hi(!1),Sk=!1),r}})();mk.importMethods(a,!0,1);var yk=mk,wk={...{getTournamentPoints:YD},...{calculateNewRatings:nw,generateDynamicRatings:ow}};mk.importMethods(wk);n({},{activeMatchUpStatuses:()=>Fd,auditConstants:()=>qM,competitionFormatConstants:()=>Pk,completedMatchUpStatuses:()=>kd,directingMatchUpStatuses:()=>Cd,displayConstants:()=>Qv,drawDefinitionConstants:()=>Hs,entryStatusConstants:()=>Gp,errorConditionConstants:()=>Oi,eventConstants:()=>Wo,extensionConstants:()=>Xu,flightConstants:()=>wR,genderConstants:()=>Rn,keyValueConstants:()=>kP,matchUpActionConstants:()=>My,matchUpStatusConstants:()=>_d,matchUpTypes:()=>f,nonDirectingMatchUpStatuses:()=>Od,particicipantsRequiredMatchUpStatuses:()=>Ad,participantConstants:()=>Wl,participantRoles:()=>iI,participantTypes:()=>ql,penaltyConstants:()=>Tk,policyConstants:()=>fu,positionActionConstants:()=>gS,ratingConstants:()=>$h,recoveryTimeRequiredMatchUpStatuses:()=>Nd,requestConstants:()=>fA,resourceContants:()=>qa,resultConstants:()=>de,scaleConstants:()=>Jc,scheduleConstants:()=>cf,sortingConstants:()=>CR,surfaceConstants:()=>Dk,tieFormatConstants:()=>Fo,timeItemConstants:()=>$m,topicConstants:()=>yl,tournamentConstants:()=>Hv,upcomingMatchUpStatuses:()=>xd,validMatchUpStatuses:()=>Ed,venueConstants:()=>bk,weekdayConstants:()=>ZM});var Pk={INTENNSE_STANDARD:"INTENNSE_STANDARD",TENNIS_STANDARD:"TENNIS_STANDARD",MATCHUP:"MATCHUP",SET:"SET",HALF:"HALF",SEGMENT:"SEGMENT",BETWEEN_GAMES:"BETWEEN_GAMES",BETWEEN_POINTS:"BETWEEN_POINTS",ANY:"ANY"},Tk={COACHING:"Coaching",BALL_ABUSE:"Ball Abuse",RACKET_ABUSE:"Racket Abuse",VERBAL_ABUSE:"Verbal Abuse",PHYSICAL_ABUSE:"Physical Abuse",INELIGIBILITY:"INELIGIBILITY",UNSPORTSMANLIKE_CONDUCT:"Unsportmanlike Conduct",PROHIBITED_SUBSTANCE:"PROHIBITED_SUBSTANCE",DRESS_CODE_VIOLATION:"Dress Code Violation",EQUIMENT_VIOLATION:"Equipment Violation",LEAVING_THE_COURT:"Leaving the court",REFUSAL_TO_PLAY:"REFUSAL_TO_PLAY",FAILURE_TO_COMPLETE:"Failure to complete",NO_SHOW:"No Show",OTHER:"Other",PUNCTUALITY:"Puncuality",FAILUIRE_TO_SIGN_IN:"Failure to sign in"},Dk={CLAY:"CLAY",HARD:"HARD",GRASS:"GRASS",CARPET:"CARPET",ARTIFICIAL:"ARTIFICIAL"},bk={INDOOR:"INDOOR",OUTDOOR:"OUTDOOR"}}}]);