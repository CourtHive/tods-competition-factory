"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[314],{3805:(e,n,t)=>{t.d(n,{xA:()=>g,yg:()=>d});var a=t(758);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var s=a.createContext({}),c=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},g=function(e){var n=c(e.components);return a.createElement(s.Provider,{value:n},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,g=l(e,["components","mdxType","originalType","parentName"]),u=c(t),m=o,d=u["".concat(s,".").concat(m)]||u[m]||p[m]||r;return t?a.createElement(d,i(i({ref:n},g),{},{components:t})):a.createElement(d,i({ref:n},g))}));function d(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var r=t.length,i=new Array(r);i[0]=m;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l[u]="string"==typeof e?e:o,i[1]=l;for(var c=2;c<r;c++)i[c]=t[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},9286:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var a=t(2232),o=(t(758),t(3805));const r={title:"Mutation Engines"},i=void 0,l={unversionedId:"engines/mutation-engines",id:"engines/mutation-engines",title:"Mutation Engines",description:"Mutation engines provide state-modifying operations with built-in change tracking, notifications, and error handling. They can operate synchronously or asynchronously depending on the execution context.",source:"@site/docs/engines/mutation-engines.md",sourceDirName:"engines",slug:"/engines/mutation-engines",permalink:"/tods-competition-factory/docs/engines/mutation-engines",draft:!1,tags:[],version:"current",frontMatter:{title:"Mutation Engines"},sidebar:"docs",previous:{title:"Engine Middleware",permalink:"/tods-competition-factory/docs/engines/engine-middleware"},next:{title:"Subscriptions",permalink:"/tods-competition-factory/docs/engines/subscriptions"}},s={},c=[{value:"Synchronous vs Asynchronous Engines",id:"synchronous-vs-asynchronous-engines",level:2},{value:"Synchronous Engines",id:"synchronous-engines",level:3},{value:"Asynchronous Engines",id:"asynchronous-engines",level:3},{value:"Notifications",id:"notifications",level:2},{value:"Subscribing to Notifications",id:"subscribing-to-notifications",level:3},{value:"Common Notification Topics",id:"common-notification-topics",level:3},{value:"Real-World Example: Live Scoring Updates",id:"real-world-example-live-scoring-updates",level:3},{value:"Rollback on Error",id:"rollback-on-error",level:2},{value:"Basic Rollback",id:"basic-rollback",level:3},{value:"Transaction Pattern",id:"transaction-pattern",level:3},{value:"When to Use Rollback",id:"when-to-use-rollback",level:3},{value:"Global State Provider",id:"global-state-provider",level:2},{value:"Synchronous State (Default)",id:"synchronous-state-default",level:3},{value:"Asynchronous State Provider",id:"asynchronous-state-provider",level:3},{value:"Debugging and Logging",id:"debugging-and-logging",level:2}],g={toc:c},u="wrapper";function p(e){let{components:n,...t}=e;return(0,o.yg)(u,(0,a.A)({},g,t,{components:n,mdxType:"MDXLayout"}),(0,o.yg)("p",null,"Mutation engines provide state-modifying operations with built-in change tracking, notifications, and error handling. They can operate ",(0,o.yg)("strong",{parentName:"p"},"synchronously")," or ",(0,o.yg)("strong",{parentName:"p"},"asynchronously")," depending on the execution context."),(0,o.yg)("p",null,(0,o.yg)("strong",{parentName:"p"},"Key Features:")),(0,o.yg)("ul",null,(0,o.yg)("li",{parentName:"ul"},"Automatic mutation logging and audit trails"),(0,o.yg)("li",{parentName:"ul"},"Subscription-based notification system"),(0,o.yg)("li",{parentName:"ul"},"Rollback on error capabilities"),(0,o.yg)("li",{parentName:"ul"},"Asynchronous state management for multi-client scenarios"),(0,o.yg)("li",{parentName:"ul"},"Integration with middleware for automatic resolution")),(0,o.yg)("hr",null),(0,o.yg)("h2",{id:"synchronous-vs-asynchronous-engines"},"Synchronous vs Asynchronous Engines"),(0,o.yg)("h3",{id:"synchronous-engines"},"Synchronous Engines"),(0,o.yg)("p",null,"Use ",(0,o.yg)("inlineCode",{parentName:"p"},"syncEngine")," for single-threaded, single-client applications:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},"import { tournamentEngine } from 'tods-competition-factory';\n\ntournamentEngine.setState(tournamentRecord);\ntournamentEngine.addEvent({ event: { eventName: 'Singles', eventType: 'SINGLES' } });\n")),(0,o.yg)("p",null,(0,o.yg)("strong",{parentName:"p"},"When to Use:")),(0,o.yg)("ul",null,(0,o.yg)("li",{parentName:"ul"},"Single-user desktop applications"),(0,o.yg)("li",{parentName:"ul"},"Command-line tools"),(0,o.yg)("li",{parentName:"ul"},"Test suites"),(0,o.yg)("li",{parentName:"ul"},"Simple server endpoints with isolated state per request")),(0,o.yg)("h3",{id:"asynchronous-engines"},"Asynchronous Engines"),(0,o.yg)("p",null,"Use ",(0,o.yg)("inlineCode",{parentName:"p"},"asyncEngine")," for multi-client server applications:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},"import { asyncEngine, globalState } from 'tods-competition-factory';\nimport { asyncGlobalState } from './asyncGlobalState';\n\n// Configure async state provider once at startup\nglobalState.setStateProvider(asyncGlobalState);\n\n// Each client request gets isolated state\napp.post('/api/tournament/:id/event', async (req, res) => {\n  const tournamentRecord = await loadTournament(req.params.id);\n  await asyncEngine.setState(tournamentRecord);\n  \n  const result = await asyncEngine.addEvent({ event: req.body.event });\n  await saveTournament(asyncEngine.getState());\n  \n  res.json(result);\n});\n")),(0,o.yg)("p",null,(0,o.yg)("strong",{parentName:"p"},"When to Use:")),(0,o.yg)("ul",null,(0,o.yg)("li",{parentName:"ul"},"Multi-user web servers"),(0,o.yg)("li",{parentName:"ul"},"REST APIs serving multiple clients"),(0,o.yg)("li",{parentName:"ul"},"WebSocket servers with concurrent connections"),(0,o.yg)("li",{parentName:"ul"},"Any scenario with concurrent state modifications")),(0,o.yg)("p",null,(0,o.yg)("strong",{parentName:"p"},"State Isolation:"),"\nAsync engines use Node's ",(0,o.yg)("inlineCode",{parentName:"p"},"executionAsyncId()")," to maintain separate state for each async execution context, preventing state collision between concurrent requests."),(0,o.yg)("hr",null),(0,o.yg)("h2",{id:"notifications"},"Notifications"),(0,o.yg)("p",null,"Mutation engines emit notifications for state changes, enabling reactive updates across your application."),(0,o.yg)("h3",{id:"subscribing-to-notifications"},"Subscribing to Notifications"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},"import { tournamentEngine, addNotification } from 'tods-competition-factory';\n\n// Subscribe to specific notification topics\naddNotification({\n  topic: 'addMatchUps',\n  payload: (payload) => {\n    console.log('MatchUps added:', payload.matchUps);\n    // Update UI, trigger webhooks, etc.\n  }\n});\n\naddNotification({\n  topic: 'modifyMatchUp',\n  payload: (payload) => {\n    console.log('MatchUp modified:', payload.matchUp);\n  }\n});\n\n// Now mutations trigger notifications\ntournamentEngine.generateDrawDefinition({ /* ... */ });\n// Triggers 'addMatchUps' notification\n")),(0,o.yg)("h3",{id:"common-notification-topics"},"Common Notification Topics"),(0,o.yg)("ul",null,(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("inlineCode",{parentName:"li"},"addMatchUps")," - New matchUps created"),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("inlineCode",{parentName:"li"},"modifyMatchUp")," - MatchUp properties changed"),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("inlineCode",{parentName:"li"},"publishEvent")," - Event published/unpublished"),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("inlineCode",{parentName:"li"},"deletedMatchUpIds")," - MatchUps removed"),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("inlineCode",{parentName:"li"},"modifyDrawDefinition")," - Draw structure changed"),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("inlineCode",{parentName:"li"},"audit")," - Any mutation for audit trail")),(0,o.yg)("h3",{id:"real-world-example-live-scoring-updates"},"Real-World Example: Live Scoring Updates"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},"import { tournamentEngine, addNotification } from 'tods-competition-factory';\nimport { broadcastToWebSocketClients } from './websocket';\n\n// Broadcast score changes to connected clients\naddNotification({\n  topic: 'modifyMatchUp',\n  payload: (payload) => {\n    if (payload.matchUp.score) {\n      broadcastToWebSocketClients({\n        type: 'SCORE_UPDATE',\n        matchUpId: payload.matchUp.matchUpId,\n        score: payload.matchUp.score,\n        matchUpStatus: payload.matchUp.matchUpStatus\n      });\n    }\n  }\n});\n\n// Recording a score triggers notification\ntournamentEngine.setMatchUpStatus({\n  matchUpId: 'match-1',\n  outcome: {\n    score: {\n      sets: [\n        { side1Score: 6, side2Score: 4 },\n        { side1Score: 6, side2Score: 3 }\n      ]\n    }\n  }\n});\n// WebSocket clients receive live update\n")),(0,o.yg)("p",null,"See ",(0,o.yg)("a",{parentName:"p",href:"/docs/engines/subscriptions"},"Subscriptions")," for complete notification documentation."),(0,o.yg)("hr",null),(0,o.yg)("h2",{id:"rollback-on-error"},"Rollback on Error"),(0,o.yg)("p",null,"Protect tournament integrity by automatically reverting changes when operations fail."),(0,o.yg)("h3",{id:"basic-rollback"},"Basic Rollback"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},"import { tournamentEngine } from 'tods-competition-factory';\n\ntournamentEngine.setState(tournamentRecord);\n\ntry {\n  const result = await tournamentEngine.automatedPositioning({\n    drawId: 'draw-1',\n    rollbackOnError: true  // Enable automatic rollback\n  });\n} catch (error) {\n  // State automatically reverted to pre-operation state\n  console.error('Operation failed, state rolled back:', error);\n}\n")),(0,o.yg)("h3",{id:"transaction-pattern"},"Transaction Pattern"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},"// Complex operation with multiple mutations\ntournamentEngine.setState(tournamentRecord);\nconst originalState = tournamentEngine.getState();\n\ntry {\n  // Multiple operations that must all succeed\n  await tournamentEngine.addEvent({ event, rollbackOnError: true });\n  await tournamentEngine.generateDrawDefinition({ drawSize: 32, rollbackOnError: true });\n  await tournamentEngine.attachPolicy({ policyDefinitions, rollbackOnError: true });\n  \n  // All succeeded, persist state\n  await saveToDatabase(tournamentEngine.getState());\n} catch (error) {\n  // Any failure rolls back entire transaction\n  console.error('Transaction failed:', error);\n  tournamentEngine.setState(originalState);\n}\n")),(0,o.yg)("h3",{id:"when-to-use-rollback"},"When to Use Rollback"),(0,o.yg)("p",null,(0,o.yg)("strong",{parentName:"p"},"Use ",(0,o.yg)("inlineCode",{parentName:"strong"},"rollbackOnError: true")," when:")),(0,o.yg)("ul",null,(0,o.yg)("li",{parentName:"ul"},"Operating on production data"),(0,o.yg)("li",{parentName:"ul"},"Complex multi-step operations"),(0,o.yg)("li",{parentName:"ul"},"User-initiated actions that must be atomic"),(0,o.yg)("li",{parentName:"ul"},"Data integrity is critical")),(0,o.yg)("p",null,(0,o.yg)("strong",{parentName:"p"},"Skip rollback when:")),(0,o.yg)("ul",null,(0,o.yg)("li",{parentName:"ul"},"In test suites (let failures be visible)"),(0,o.yg)("li",{parentName:"ul"},"Debugging (you want to see the failed state)"),(0,o.yg)("li",{parentName:"ul"},"Bulk operations where partial success is acceptable"),(0,o.yg)("li",{parentName:"ul"},"Performance is critical and errors are rare")),(0,o.yg)("hr",null),(0,o.yg)("h2",{id:"global-state-provider"},"Global State Provider"),(0,o.yg)("h3",{id:"synchronous-state-default"},"Synchronous State (Default)"),(0,o.yg)("p",null,"Synchronous engines maintain state in memory without special configuration:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},"import { tournamentEngine } from 'tods-competition-factory';\n\n// No setup required for sync engines\ntournamentEngine.setState(tournamentRecord);\ntournamentEngine.addEvent({ event });\n")),(0,o.yg)("h3",{id:"asynchronous-state-provider"},"Asynchronous State Provider"),(0,o.yg)("p",null,"For multi-client scenarios, implement a custom state provider:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},"// asyncGlobalState.js\nimport { AsyncLocalStorage } from 'async_hooks';\n\nconst asyncLocalStorage = new AsyncLocalStorage();\n\nexport const asyncGlobalState = {\n  // Get state for current async context\n  getState: () => asyncLocalStorage.getStore() || {},\n  \n  // Set state for current async context\n  setState: (state) => {\n    const store = asyncLocalStorage.getStore();\n    if (store) {\n      Object.assign(store, state);\n    }\n  },\n  \n  // Run callback in new async context\n  run: (callback) => {\n    asyncLocalStorage.run({}, callback);\n  }\n};\n")),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},"// server.js\nimport { globalState, asyncEngine } from 'tods-competition-factory';\nimport { asyncGlobalState } from './asyncGlobalState';\n\n// Configure once at app startup\nglobalState.setStateProvider(asyncGlobalState);\n\n// Each request gets isolated state\napp.use((req, res, next) => {\n  asyncGlobalState.run(() => next());\n});\n\napp.post('/api/event', async (req, res) => {\n  // State isolated to this request\n  await asyncEngine.setState(req.tournament);\n  const result = await asyncEngine.addEvent({ event: req.body });\n  res.json(result);\n});\n")),(0,o.yg)("p",null,(0,o.yg)("strong",{parentName:"p"},"Reference Implementation:"),"\nSee ",(0,o.yg)("inlineCode",{parentName:"p"},"src/examples/asyncEngine")," in the source code for a complete async state provider example."),(0,o.yg)("hr",null),(0,o.yg)("h2",{id:"debugging-and-logging"},"Debugging and Logging"),(0,o.yg)("p",null,"Enable detailed logging for debugging and monitoring:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-js"},"import { tournamentEngine, globalState } from 'tods-competition-factory';\n\n// Enable detailed logging\nglobalState.setDevContext({\n  errors: true,    // Log errors\n  params: true,    // Log method parameters  \n  result: true,    // Log method results\n  perf: 100        // Log methods taking >100ms\n});\n\ntournamentEngine.setState(tournamentRecord);\ntournamentEngine.addEvent({ event: { eventName: 'Singles' } });\n// Console: [addEvent] params: {...} result: {...} time: 5ms\n\ntournamentEngine.generateDrawDefinition({ drawSize: 32 });\n// Console: [generateDrawDefinition] params: {...} result: {...} time: 25ms\n")),(0,o.yg)("p",null,(0,o.yg)("strong",{parentName:"p"},"Dev Context Options:")),(0,o.yg)("ul",null,(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("inlineCode",{parentName:"li"},"errors: true")," - Log all errors"),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("inlineCode",{parentName:"li"},"params: true | ['methodName']")," - Log parameters for all or specific methods"),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("inlineCode",{parentName:"li"},"result: true | ['methodName']")," - Log results for all or specific methods  "),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("inlineCode",{parentName:"li"},"perf: number")," - Log methods exceeding threshold (ms)"),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("inlineCode",{parentName:"li"},"exclude: ['methodName']")," - Exclude specific methods from logging")),(0,o.yg)("hr",null))}p.isMDXComponent=!0}}]);